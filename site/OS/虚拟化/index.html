
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../%E5%B9%B6%E5%8F%91/">
      
      
        <link rel="next" href="../%E6%8C%81%E4%B9%85%E5%8C%96/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.33">
    
    
      
        <title>虚拟化 - lingyu's notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeline.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
      <link rel="stylesheet" href="../../mkdocs/css/no-footer.css">
    
      <link rel="stylesheet" href="../../mkdocs/css/unordered-list-symbols.css">
    
      <link rel="stylesheet" href="../../css/table.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="lingyu&#39;s notes" class="md-header__button md-logo" aria-label="lingyu's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lingyu's notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              虚拟化
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/lingyu11/notes/tree/master" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lingyu11/notes
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../%E8%AF%AD%E8%A8%80/Python/PythonCookBook/" class="md-tabs__link">
          
  
    
  
  语言

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ICS/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%AE%9E%E9%AA%8C/" class="md-tabs__link">
          
  
    
  
  ICS

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../%E7%BB%AA%E8%AE%BA/" class="md-tabs__link">
          
  
    
  
  OS

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../data_structure.md" class="md-tabs__link">
        
  
    
  
  数据结构

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../algo.md" class="md-tabs__link">
        
  
    
  
  算法

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Linux/Linux/" class="md-tabs__link">
          
  
    
  
  Linux

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../network.md" class="md-tabs__link">
        
  
    
  
  计算机网络

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../database.md" class="md-tabs__link">
        
  
    
  
  数据库

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../Tool/tool/" class="md-tabs__link">
        
  
    
  
  Tool

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Misc/Memo/" class="md-tabs__link">
          
  
    
  
  Misc

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="lingyu&#39;s notes" class="md-nav__button md-logo" aria-label="lingyu's notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2Z"/></svg>

    </a>
    lingyu's notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lingyu11/notes/tree/master" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lingyu11/notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    语言
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            语言
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AF%AD%E8%A8%80/Python/PythonCookBook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PythonCookBook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AF%AD%E8%A8%80/C/C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            C++
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AF%AD%E8%A8%80/Cpp/Cpp_primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ primer 5th edition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AF%AD%E8%A8%80/Cpp/Essential_Cpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Essential C++
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ICS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ICS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ICS/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E5%AE%9E%E9%AA%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算机系统基础实验
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    OS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            OS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BB%AA%E8%AE%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    绪论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%B9%B6%E5%8F%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    并发
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    虚拟化
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    虚拟化
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lecture-14" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 14 操作系统上的进程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-15" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 15 进程的地址空间
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-16-unix-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 16 系统调用和UNIX Shell
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-17-c" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 17 C 标准库和实现
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-18-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 18 Linux 操作系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-19" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 19 可执行文件和加载
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-20" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 20 动态链接和加载
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-21" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 21 系统调用、中断和上下文切换
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-22" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 22 进程的实现
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-23" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 23 处理器调度
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-24" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 24 状态机模型的应用
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%8C%81%E4%B9%85%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    持久化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    总结
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data_structure.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据结构
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../algo.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    算法
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/Linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础知识
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux/useful_cmd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Useful cmd
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../network.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算机网络
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据库
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Tool/tool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tool
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/Memo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Memo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/Todo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Todo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Misc/LearningMaterial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning Material
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lecture-14" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 14 操作系统上的进程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-15" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 15 进程的地址空间
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-16-unix-shell" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 16 系统调用和UNIX Shell
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-17-c" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 17 C 标准库和实现
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-18-linux" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 18 Linux 操作系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-19" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 19 可执行文件和加载
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-20" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 20 动态链接和加载
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-21" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 21 系统调用、中断和上下文切换
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-22" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 22 进程的实现
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-23" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 23 处理器调度
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lecture-24" class="md-nav__link">
    <span class="md-ellipsis">
      Lecture 24 状态机模型的应用
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1">虚拟化<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8V2m6.78 1a.69.69 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38-2.5-2.5Z"/></svg></span> 约 5674 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3l89.3 89.4-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span> 953 行代码 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3L12.5 13Z"/></svg></span> 预计阅读时间 31 分钟</p>
</div>
<h2 id="lecture-14">Lecture 14 操作系统上的进程<a class="headerlink" href="#lecture-14" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>因为 “程序 = 状态机”，操作系统上进程 (运行的程序) 管理的 API 很自然地就是状态机的管理。在 UNIX/Linux 世界中，以下三个系统调用创建了整个 “进程世界”，不论是我们常用的 IDE 和浏览器，还是编译时在后台调用的 gcc。其中：</p>
<ul>
<li>fork: 对当前状态机状态进行完整复制</li>
<li>execve: 将当前状态机状态重置为某个可执行文件描述的状态机</li>
<li>exit: 销毁当前状态机</li>
</ul>
<p>在对这个概念有了绝对正确且绝对严谨的理解后，操作系统也就显得不那么神秘了。</p>
</div>
<ol>
<li>
<p>fork: 创建状态机。做一份状态机完整的复制 (内存、寄存器现场)。
    <div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">pid_t</span><span class="w"> </span><span class="nf">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div></p>
<p>fork() 的行为</p>
<ul>
<li>
<p>立即复制状态机</p>
<ul>
<li>包括所有信息的完整拷贝<ul>
<li>每一个字节的内存</li>
<li>打开的文件 (共享)</li>
<li>……</li>
<li>复制失败返回 -1<ul>
<li>errno 会返回错误原因 (man fork)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>如何区分两个状态机？</p>
<ul>
<li>新创建进程：得到的返回值是 0</li>
<li>执行 fork 的父进程：得到的返回值是子进程的进程号</li>
</ul>
</li>
</ul>
</li>
<li>
<p>阅读以下程序，写出运行结果
    <div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kt">pid_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kt">pid_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div></p>
<p>输出：
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="m">19489</span><span class="w"> </span><span class="m">19490</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="m">19489</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="m">0</span><span class="w"> </span><span class="m">19491</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="m">0</span><span class="w"> </span><span class="m">0</span>
</span></code></pre></div></td></tr></table></div>
<img alt="alt text" src="../../img/image-11.png" /></p>
<p><div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
输出：6个Hello
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">Hello</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">Hello</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">Hello</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="n">Hello</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">Hello</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="n">Hello</span>
</span></code></pre></div></td></tr></table></div></p>
<p>程序等价于：
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<img alt="alt text" src="../../img/image-12.png" /></p>
<p>然而，<code>./demo-2 | wc -l</code>输出的是<code>8</code>。原因：在终端里换行打印时使用的是line buffer，此时打印6个；重定向到文件或使用管道时使用的是full buffer，此时会打印8个，没有刷新buffer，导致所有带有值的buffer也被fork了。<code>man setbuf</code>可以看到有三种模式<code>_IONBF unbuffered</code>/<code>_IOLBF line buffered</code>/<code>_IOFBF fully buffered</code>。
此时程序等价于：
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">buf</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">;</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="n">buf</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">flush</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<img alt="alt text" src="../../img/image-13.png" /></p>
</li>
<li>
<p>execve：重置状态机。将当前进程重置成一个可执行文件描述状态机的初始状态。</p>
<p><div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">,</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">           </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">argv</span><span class="p">[],</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">envp</span><span class="p">[]);</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="c1">// 三个参数：可执行文件的路径、传递给 main 函数的参数和环境变量。</span>
</span></code></pre></div></td></tr></table></div>
execve 行为</p>
<ul>
<li>执行名为 <code>filename</code> 的程序</li>
<li>允许对新状态机设置参数 <code>argv</code> (v) 和环境变量 <code>envp</code> (e)<ul>
<li>刚好对应了 <code>main()</code> 的参数！</li>
</ul>
</li>
<li>execve 是唯一能够 “执行程序” 的系统调用<ul>
<li>因此也是一切进程 strace 的第一个系统调用</li>
</ul>
</li>
</ul>
</li>
<li>
<p>UNIX 中实现 “创建新状态机” 的方式：fork + execve （相当于spawn）
    <div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="c1">// fork失败</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork&quot;</span><span class="p">);</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="c1">// Child</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="n">execve</span><span class="p">(...);</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="c1">// 如果 execve 成功执行，它将替换当前进程的内存空间并开始执行新的程序，</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="c1">// 因此 perror(&quot;execve&quot;) 不会被执行。perror(&quot;execve&quot;) 只会在 execve</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="c1">// 调用失败时执行</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;execve&quot;</span><span class="p">);</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">fail</span><span class="p">;</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="c1">// Parent</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
<p>demo:
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">argv</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">        </span><span class="s">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">        </span><span class="s">&quot;-c&quot;</span><span class="p">,</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">        </span><span class="s">&quot;env&quot;</span><span class="p">,</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">envp</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">        </span><span class="s">&quot;HELLO=WORLD&quot;</span><span class="p">,</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">        </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="c1">// Reset the state machine to &quot;/bin/bash&quot;</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="n">execve</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">envp</span><span class="p">);</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="c1">// We are here only on error.</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
输出：
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nv">PWD</span><span class="o">=</span>/home/user/jyy_os_2024/lecture/lect14/execve-demo
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nv">HELLO</span><span class="o">=</span>WORLD
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="nv">SHLVL</span><span class="o">=</span><span class="m">0</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="nv">_</span><span class="o">=</span>/usr/bin/env
</span></code></pre></div></td></tr></table></div>
这比直接在bash里执行<code>/bin/bash -c env</code>得到的一大堆输出更加简单，是因为我们在代码里的环境变量evnp只保留了<code>HELLO=WORLD</code>（当然实际上执行execve还是有PWD/SHLVL等被加上的环境变量）。</p>
</li>
<li>
<p>_exit()：销毁状态机。立即摧毁状态机，允许有一个返回值。子进程终止会通知父进程。
    <div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_exit</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div></p>
<p>结束程序执行的三种方法</p>
<ul>
<li>exit(0)<ul>
<li>provided by libc</li>
<li>会调用 atexit</li>
</ul>
</li>
<li>_exit(0)<ul>
<li>执行 “exit_group” 系统调用终止整个进程 (所有线程)</li>
<li>不会调用 atexit </li>
</ul>
</li>
<li>syscall(SYS_exit, 0)<ul>
<li>执行 “exit” 系统调用终止当前线程</li>
<li>不会调用 atexit（libc当然不了解系统调用，也就无法在退出时调用libc的atexit函数）</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="lecture-15">Lecture 15 进程的地址空间<a class="headerlink" href="#lecture-15" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>状态机的视角自然地将我们引入 “内存到底是什么” 的问题——它的答案同样也很自然：带有访问权限控制的连续内存段。我们可以通过 <span style="color:lightblue;">mmap、munmap、mprotect</span> 三个系统调用调整状态机的地址空间，包括分配匿名的内存、映射文件内容到内存、修改访问权限等（增/删/改）。更有趣的是操作系统有 “能够实现一切应用程序” 的需求，调试器也不在话下——这也给了我们入侵其他进程地址空间的机制。</p>
</div>
<ol>
<li>
<p>以下程序的 (可能) 输出是什么？
    <div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="p">{</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">main</span><span class="p">;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w">    </span><span class="c1">// fa1e0ff3（小端）</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">);</span><span class="w"> </span><span class="c1">//0x556b3315c149，每次不一样</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
<p><div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span>
<span class="normal"><a href="#__codelineno-13-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a>objdump<span class="w"> </span>-d<span class="w"> </span>a.out
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="m">0000000000001149</span><span class="w"> </span>&lt;main&gt;:
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="m">1149</span>:<span class="w">       </span>f3<span class="w"> </span>0f<span class="w"> </span>1e<span class="w"> </span>fa<span class="w">             </span>endbr64<span class="w"> </span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>114d:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>114e:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w">                </span>mov<span class="w">    </span>%rsp,%rbp
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="m">1151</span>:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">83</span><span class="w"> </span>ec<span class="w"> </span><span class="m">10</span><span class="w">             </span>sub<span class="w">    </span><span class="nv">$0</span>x10,%rsp
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>...
</span></code></pre></div></td></tr></table></div>
2. 查看进程的地址空间：</p>
<ul>
<li>
<p>/proc/[pid]/maps</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a>linux$<span class="w"> </span>ps
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a>PID<span class="w"> </span>TTY<span class="w">          </span>TIME<span class="w"> </span>CMD
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="m">18222</span><span class="w"> </span>pts/3<span class="w">    </span><span class="m">00</span>:00:00<span class="w"> </span>dbus-launch
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="m">22713</span><span class="w"> </span>pts/3<span class="w">    </span><span class="m">00</span>:00:01<span class="w"> </span>bash
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="m">29368</span><span class="w"> </span>pts/3<span class="w">    </span><span class="m">00</span>:00:00<span class="w"> </span>ps
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>linux$<span class="w"> </span>vi<span class="w"> </span>/proc/22713/maps
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>55e7a0632000-55e7a0711000<span class="w"> </span>r-xp<span class="w"> </span>0002f000<span class="w"> </span><span class="m">08</span>:20<span class="w"> </span><span class="m">1241</span><span class="w">                       </span>/usr/bin/bash
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a>55e7a0711000-55e7a074b000<span class="w"> </span>r--p<span class="w"> </span>0010e000<span class="w"> </span><span class="m">08</span>:20<span class="w"> </span><span class="m">1241</span><span class="w">                       </span>/usr/bin/bash
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>55e7a074c000-55e7a0750000<span class="w"> </span>r--p<span class="w"> </span><span class="m">00148000</span><span class="w"> </span><span class="m">08</span>:20<span class="w"> </span><span class="m">1241</span><span class="w">                       </span>/usr/bin/bash
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>55e7a0750000-55e7a0759000<span class="w"> </span>rw-p<span class="w"> </span>0014c000<span class="w"> </span><span class="m">08</span>:20<span class="w"> </span><span class="m">1241</span><span class="w">                       </span>/usr/bin/bash
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>...
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a>7ffdf9eb0000-7ffdf9ed2000<span class="w"> </span>rw-p<span class="w"> </span><span class="m">00000000</span><span class="w"> </span><span class="m">00</span>:00<span class="w"> </span><span class="m">0</span><span class="w">                          </span><span class="o">[</span>stack<span class="o">]</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a>7ffdf9f79000-7ffdf9f7d000<span class="w"> </span>r--p<span class="w"> </span><span class="m">00000000</span><span class="w"> </span><span class="m">00</span>:00<span class="w"> </span><span class="m">0</span><span class="w">                          </span><span class="o">[</span>vvar<span class="o">]</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a>7ffdf9f7d000-7ffdf9f7f000<span class="w"> </span>r-xp<span class="w"> </span><span class="m">00000000</span><span class="w"> </span><span class="m">00</span>:00<span class="w"> </span><span class="m">0</span><span class="w">                          </span><span class="o">[</span>vdso<span class="o">]</span>
</span></code></pre></div></td></tr></table></div>
<p>无需陷入内核的系统调用: vvar (data)/vdso (code)。例如时间这样的数据，只有操作系统有，而应用程序只是读时间戳，不会改它，对于这样只读的数据，无需进入操作系统内核。因此，<strong>操作系统里只读的数据可以通过内存的方式共享给进程</strong>。</p>
</li>
<li>
<p>pmap [pid]</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a>linux$<span class="w"> </span>pmap<span class="w"> </span><span class="m">22713</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="m">22713</span>:<span class="w">   </span>/bin/bash
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a>000055e7a0603000<span class="w">    </span>188K<span class="w"> </span>r----<span class="w"> </span>bash
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a>000055e7a0632000<span class="w">    </span>892K<span class="w"> </span>r-x--<span class="w"> </span>bash
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a>000055e7a0711000<span class="w">    </span>232K<span class="w"> </span>r----<span class="w"> </span>bash
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>000055e7a074c000<span class="w">     </span>16K<span class="w"> </span>r----<span class="w"> </span>bash
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>000055e7a0750000<span class="w">     </span>36K<span class="w"> </span>rw---<span class="w"> </span>bash
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a>000055e7a0759000<span class="w">     </span>44K<span class="w"> </span>rw---<span class="w">   </span><span class="o">[</span><span class="w"> </span>anon<span class="w"> </span><span class="o">]</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a>000055e7a1dbc000<span class="w">   </span>1832K<span class="w"> </span>rw---<span class="w">   </span><span class="o">[</span><span class="w"> </span>anon<span class="w"> </span><span class="o">]</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>...
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>gdb cmd: <code>info proc mappings</code></p>
</li>
</ul>
</li>
<li>
<p>管理进程地址空间：在状态机状态上增加/删除/修改一段可访问的内存</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1">// 映射</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">           </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">munmap</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="c1">// 修改映射权限</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">mprotect</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>例子：</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="cp">#define GiB * (1024LL * 1024 * 1024)</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">        </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">        </span><span class="mi">8</span><span class="w"> </span><span class="n">GiB</span><span class="p">,</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">        </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">        </span><span class="n">MAP_ANONYMOUS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_PRIVATE</span><span class="p">,</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">        </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;mmap: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;cannot map&quot;</span><span class="p">);</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">GiB</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">GiB</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">GiB</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Read get: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">GiB</span><span class="p">));</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Read get: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">GiB</span><span class="p">));</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Read get: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">GiB</span><span class="p">));</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kn">import</span> <span class="nn">hexdump</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kn">import</span> <span class="nn">mmap</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/sda&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a>    <span class="n">mm</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a>                <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a>    <span class="n">hexdump</span><span class="o">.</span><span class="n">hexdump</span><span class="p">(</span><span class="n">mm</span><span class="p">[:</span><span class="mi">512</span><span class="p">])</span> <span class="c1"># 将磁盘sda的128GiB映射到内存，并查看前512字节</span>
</span></code></pre></div></td></tr></table></div>
4. 入侵进程地址空间</p>
<ul>
<li>调试器 (gdb)<ul>
<li>gdb 可以任意观测和修改程序的状态</li>
</ul>
</li>
<li>Profiler (perf)<ul>
<li>M3 中借助它理解程序的性能瓶颈</li>
</ul>
</li>
</ul>
<p>例子：金山游侠</p>
<ul>
<li>
<p>地址空间那么大，哪个才是 “金钱”？</p>
<ul>
<li>包含动态分配的内存，每次地址都不一样</li>
<li>思路：Everything is a state machine<ul>
<li>观察状态机的 trace，就知道哪个是金钱了</li>
</ul>
</li>
</ul>
</li>
<li>
<p>查找 + Filter</p>
<ul>
<li>进入游戏时 exp = 4950</li>
<li>打了个怪 exp = 5100</li>
<li>符合 4950 → 5100 变化的内存地址是很少的<ul>
<li>好了，出门就是满级了</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>knight.c: <code>sudo ./knight VirtualBoxVM</code> -&gt; <code>s 5000</code> -&gt; spend 800 -&gt; <code>s 4200</code> -&gt; <code>w 1000000</code>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">  1</a></span>
<span class="normal"><a href="#__codelineno-19-2">  2</a></span>
<span class="normal"><a href="#__codelineno-19-3">  3</a></span>
<span class="normal"><a href="#__codelineno-19-4">  4</a></span>
<span class="normal"><a href="#__codelineno-19-5">  5</a></span>
<span class="normal"><a href="#__codelineno-19-6">  6</a></span>
<span class="normal"><a href="#__codelineno-19-7">  7</a></span>
<span class="normal"><a href="#__codelineno-19-8">  8</a></span>
<span class="normal"><a href="#__codelineno-19-9">  9</a></span>
<span class="normal"><a href="#__codelineno-19-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-19-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-19-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-19-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-19-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-19-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-19-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-19-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-19-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-19-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-19-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-19-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-19-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-19-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-19-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-19-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-19-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-19-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-19-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-19-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-19-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-19-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-19-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-19-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-19-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-19-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-19-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-19-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-19-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-19-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-19-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-19-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-19-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-19-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-19-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-19-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-19-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-19-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-19-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-19-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-19-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-19-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-19-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-19-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-19-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-19-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-19-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-19-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-19-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-19-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-19-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-19-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-19-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-19-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-19-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-19-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-19-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-19-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-19-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-19-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-19-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-19-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-19-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-19-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-19-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-19-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-19-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-19-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-19-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-19-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-19-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-19-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-19-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-19-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-19-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-19-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-19-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-19-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-19-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-19-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-19-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-19-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-19-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-19-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-19-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-19-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-19-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-19-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-19-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-19-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-19-100">100</a></span>
<span class="normal"><a href="#__codelineno-19-101">101</a></span>
<span class="normal"><a href="#__codelineno-19-102">102</a></span>
<span class="normal"><a href="#__codelineno-19-103">103</a></span>
<span class="normal"><a href="#__codelineno-19-104">104</a></span>
<span class="normal"><a href="#__codelineno-19-105">105</a></span>
<span class="normal"><a href="#__codelineno-19-106">106</a></span>
<span class="normal"><a href="#__codelineno-19-107">107</a></span>
<span class="normal"><a href="#__codelineno-19-108">108</a></span>
<span class="normal"><a href="#__codelineno-19-109">109</a></span>
<span class="normal"><a href="#__codelineno-19-110">110</a></span>
<span class="normal"><a href="#__codelineno-19-111">111</a></span>
<span class="normal"><a href="#__codelineno-19-112">112</a></span>
<span class="normal"><a href="#__codelineno-19-113">113</a></span>
<span class="normal"><a href="#__codelineno-19-114">114</a></span>
<span class="normal"><a href="#__codelineno-19-115">115</a></span>
<span class="normal"><a href="#__codelineno-19-116">116</a></span>
<span class="normal"><a href="#__codelineno-19-117">117</a></span>
<span class="normal"><a href="#__codelineno-19-118">118</a></span>
<span class="normal"><a href="#__codelineno-19-119">119</a></span>
<span class="normal"><a href="#__codelineno-19-120">120</a></span>
<span class="normal"><a href="#__codelineno-19-121">121</a></span>
<span class="normal"><a href="#__codelineno-19-122">122</a></span>
<span class="normal"><a href="#__codelineno-19-123">123</a></span>
<span class="normal"><a href="#__codelineno-19-124">124</a></span>
<span class="normal"><a href="#__codelineno-19-125">125</a></span>
<span class="normal"><a href="#__codelineno-19-126">126</a></span>
<span class="normal"><a href="#__codelineno-19-127">127</a></span>
<span class="normal"><a href="#__codelineno-19-128">128</a></span>
<span class="normal"><a href="#__codelineno-19-129">129</a></span>
<span class="normal"><a href="#__codelineno-19-130">130</a></span>
<span class="normal"><a href="#__codelineno-19-131">131</a></span>
<span class="normal"><a href="#__codelineno-19-132">132</a></span>
<span class="normal"><a href="#__codelineno-19-133">133</a></span>
<span class="normal"><a href="#__codelineno-19-134">134</a></span>
<span class="normal"><a href="#__codelineno-19-135">135</a></span>
<span class="normal"><a href="#__codelineno-19-136">136</a></span>
<span class="normal"><a href="#__codelineno-19-137">137</a></span>
<span class="normal"><a href="#__codelineno-19-138">138</a></span>
<span class="normal"><a href="#__codelineno-19-139">139</a></span>
<span class="normal"><a href="#__codelineno-19-140">140</a></span>
<span class="normal"><a href="#__codelineno-19-141">141</a></span>
<span class="normal"><a href="#__codelineno-19-142">142</a></span>
<span class="normal"><a href="#__codelineno-19-143">143</a></span>
<span class="normal"><a href="#__codelineno-19-144">144</a></span>
<span class="normal"><a href="#__codelineno-19-145">145</a></span>
<span class="normal"><a href="#__codelineno-19-146">146</a></span>
<span class="normal"><a href="#__codelineno-19-147">147</a></span>
<span class="normal"><a href="#__codelineno-19-148">148</a></span>
<span class="normal"><a href="#__codelineno-19-149">149</a></span>
<span class="normal"><a href="#__codelineno-19-150">150</a></span>
<span class="normal"><a href="#__codelineno-19-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;regex&gt;</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="n">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">;</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Game</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w"> </span><span class="c1">// Name of the traced process</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">     </span><span class="c1">// Pid of the traced process</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span><span class="w">      </span><span class="c1">// Memory file of the traced process</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15"></a>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">remain</span><span class="p">;</span><span class="w"> </span><span class="c1">// Watched addresses</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="n">public</span><span class="o">:</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">    </span><span class="n">Game</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">proc_name</span><span class="p">)</span><span class="o">:</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">        </span><span class="n">name</span><span class="p">(</span><span class="n">proc_name</span><span class="p">),</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">        </span><span class="n">pid</span><span class="p">(</span><span class="n">stoi</span><span class="p">(</span><span class="n">run</span><span class="p">(</span><span class="s">&quot;pidof &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proc_name</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22"></a>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">        </span><span class="c1">// See: proc(5)</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">memfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/proc/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">to_string</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/mem&quot;</span><span class="p">;</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25"></a>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">        </span><span class="c1">// We need root permission to open this file;</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">        </span><span class="c1">// otherwise it would be too dangerous.</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">        </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">memfile</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="n">memfile</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35"></a><span class="w">    </span><span class="o">~</span><span class="n">Game</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36"></a><span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38"></a>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">search_for</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remain</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41"></a><span class="w">            </span><span class="c1">// No match. Start a new round of search.</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42"></a>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43"></a><span class="w">            </span><span class="n">string</span><span class="w"> </span><span class="n">maps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="s">&quot;pmap -x &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">to_string</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44"></a>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45"></a><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">regex</span><span class="w"> </span><span class="n">r</span><span class="p">(</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46"></a><span class="w">                </span><span class="n">R</span><span class="s">&quot;(^([0-9a-f]+)\s+(\d+)\s+(\d+)\s+(\d+)\s+rw.*)&quot;</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47"></a><span class="w">            </span><span class="p">);</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48"></a>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49"></a><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">istringstream</span><span class="w"> </span><span class="nf">iss</span><span class="p">(</span><span class="n">maps</span><span class="p">);</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">line</span><span class="p">;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">iss</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">);</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51"></a><span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">smatch</span><span class="w"> </span><span class="n">match</span><span class="p">;</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">regex_search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="n">match</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53"></a><span class="w">                    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoll</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">(),</span><span class="w"> </span><span class="n">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54"></a><span class="w">                    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stoll</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55"></a><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Scanning %lx--%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56"></a>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57"></a><span class="w">                    </span><span class="c1">// Copy process memory to local</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58"></a><span class="w">                    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mem</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">[</span><span class="n">size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">]);</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59"></a><span class="w">                    </span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60"></a><span class="w">                    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61"></a>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62"></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">off</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64"></a><span class="w">                            </span><span class="c1">// Found a match!</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65"></a><span class="w">                            </span><span class="n">remain</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">);</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66"></a><span class="w">                        </span><span class="p">}</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71"></a><span class="w">            </span><span class="c1">// Search in the watched values.</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72"></a>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73"></a><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">erase_if</span><span class="p">(</span><span class="n">remain</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">](</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75"></a><span class="w">            </span><span class="p">});</span>
</span><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;There are %ld match(es).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">remain</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79"></a>
</span><span id="__span-19-80"><a id="__codelineno-19-80" name="__codelineno-19-80"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-81"><a id="__codelineno-19-81" name="__codelineno-19-81"></a><span class="w">        </span><span class="n">remain</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span id="__span-19-82"><a id="__codelineno-19-82" name="__codelineno-19-82"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-83"><a id="__codelineno-19-83" name="__codelineno-19-83"></a>
</span><span id="__span-19-84"><a id="__codelineno-19-84" name="__codelineno-19-84"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">overwrite</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-85"><a id="__codelineno-19-85" name="__codelineno-19-85"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-19-86"><a id="__codelineno-19-86" name="__codelineno-19-86"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">remain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-87"><a id="__codelineno-19-87" name="__codelineno-19-87"></a><span class="w">            </span><span class="n">store</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-19-88"><a id="__codelineno-19-88" name="__codelineno-19-88"></a><span class="w">            </span><span class="n">nwrite</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-19-89"><a id="__codelineno-19-89" name="__codelineno-19-89"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-90"><a id="__codelineno-19-90" name="__codelineno-19-90"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d value(s) written.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nwrite</span><span class="p">);</span>
</span><span id="__span-19-91"><a id="__codelineno-19-91" name="__codelineno-19-91"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-92"><a id="__codelineno-19-92" name="__codelineno-19-92"></a>
</span><span id="__span-19-93"><a id="__codelineno-19-93" name="__codelineno-19-93"></a><span class="n">private</span><span class="o">:</span>
</span><span id="__span-19-94"><a id="__codelineno-19-94" name="__codelineno-19-94"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-95"><a id="__codelineno-19-95" name="__codelineno-19-95"></a><span class="w">        </span><span class="c1">// Load 32-bit value from another address space</span>
</span><span id="__span-19-96"><a id="__codelineno-19-96" name="__codelineno-19-96"></a><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
</span><span id="__span-19-97"><a id="__codelineno-19-97" name="__codelineno-19-97"></a><span class="w">        </span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
</span><span id="__span-19-98"><a id="__codelineno-19-98" name="__codelineno-19-98"></a><span class="w">        </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span id="__span-19-99"><a id="__codelineno-19-99" name="__codelineno-19-99"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
</span><span id="__span-19-100"><a id="__codelineno-19-100" name="__codelineno-19-100"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-101"><a id="__codelineno-19-101" name="__codelineno-19-101"></a>
</span><span id="__span-19-102"><a id="__codelineno-19-102" name="__codelineno-19-102"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">store</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-103"><a id="__codelineno-19-103" name="__codelineno-19-103"></a><span class="w">        </span><span class="c1">// Store 32-bit value to another address space</span>
</span><span id="__span-19-104"><a id="__codelineno-19-104" name="__codelineno-19-104"></a><span class="w">        </span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
</span><span id="__span-19-105"><a id="__codelineno-19-105" name="__codelineno-19-105"></a><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
</span><span id="__span-19-106"><a id="__codelineno-19-106" name="__codelineno-19-106"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-107"><a id="__codelineno-19-107" name="__codelineno-19-107"></a>
</span><span id="__span-19-108"><a id="__codelineno-19-108" name="__codelineno-19-108"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-109"><a id="__codelineno-19-109" name="__codelineno-19-109"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="mi">128</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span>
</span><span id="__span-19-110"><a id="__codelineno-19-110" name="__codelineno-19-110"></a><span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-19-111"><a id="__codelineno-19-111" name="__codelineno-19-111"></a>
</span><span id="__span-19-112"><a id="__codelineno-19-112" name="__codelineno-19-112"></a><span class="w">        </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span id="__span-19-113"><a id="__codelineno-19-113" name="__codelineno-19-113"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pipe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-114"><a id="__codelineno-19-114" name="__codelineno-19-114"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span id="__span-19-115"><a id="__codelineno-19-115" name="__codelineno-19-115"></a><span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-19-116"><a id="__codelineno-19-116" name="__codelineno-19-116"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-117"><a id="__codelineno-19-117" name="__codelineno-19-117"></a>
</span><span id="__span-19-118"><a id="__codelineno-19-118" name="__codelineno-19-118"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">pipe</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-119"><a id="__codelineno-19-119" name="__codelineno-19-119"></a><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
</span><span id="__span-19-120"><a id="__codelineno-19-120" name="__codelineno-19-120"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-121"><a id="__codelineno-19-121" name="__codelineno-19-121"></a>
</span><span id="__span-19-122"><a id="__codelineno-19-122" name="__codelineno-19-122"></a><span class="w">        </span><span class="n">pclose</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
</span><span id="__span-19-123"><a id="__codelineno-19-123" name="__codelineno-19-123"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-19-124"><a id="__codelineno-19-124" name="__codelineno-19-124"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-125"><a id="__codelineno-19-125" name="__codelineno-19-125"></a><span class="p">};</span>
</span><span id="__span-19-126"><a id="__codelineno-19-126" name="__codelineno-19-126"></a>
</span><span id="__span-19-127"><a id="__codelineno-19-127" name="__codelineno-19-127"></a>
</span><span id="__span-19-128"><a id="__codelineno-19-128" name="__codelineno-19-128"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-129"><a id="__codelineno-19-129" name="__codelineno-19-129"></a><span class="w">    </span><span class="n">Game</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span id="__span-19-130"><a id="__codelineno-19-130" name="__codelineno-19-130"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
</span><span id="__span-19-131"><a id="__codelineno-19-131" name="__codelineno-19-131"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span id="__span-19-132"><a id="__codelineno-19-132" name="__codelineno-19-132"></a>
</span><span id="__span-19-133"><a id="__codelineno-19-133" name="__codelineno-19-133"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span>
</span><span id="__span-19-134"><a id="__codelineno-19-134" name="__codelineno-19-134"></a><span class="w">        </span><span class="s">&quot;Usage:</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-19-135"><a id="__codelineno-19-135" name="__codelineno-19-135"></a><span class="w">        </span><span class="s">&quot;  - s 100: search for value</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-19-136"><a id="__codelineno-19-136" name="__codelineno-19-136"></a><span class="w">        </span><span class="s">&quot;  - w 99999: overwrite value (for search matches)</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-19-137"><a id="__codelineno-19-137" name="__codelineno-19-137"></a><span class="w">        </span><span class="s">&quot;  - r: reset search</span><span class="se">\n\n</span><span class="s">&quot;</span>
</span><span id="__span-19-138"><a id="__codelineno-19-138" name="__codelineno-19-138"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-19-139"><a id="__codelineno-19-139" name="__codelineno-19-139"></a>
</span><span id="__span-19-140"><a id="__codelineno-19-140" name="__codelineno-19-140"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">stdin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-141"><a id="__codelineno-19-141" name="__codelineno-19-141"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(%s %d) &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-19-142"><a id="__codelineno-19-142" name="__codelineno-19-142"></a><span class="w">        </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
</span><span id="__span-19-143"><a id="__codelineno-19-143" name="__codelineno-19-143"></a>
</span><span id="__span-19-144"><a id="__codelineno-19-144" name="__codelineno-19-144"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-145"><a id="__codelineno-19-145" name="__codelineno-19-145"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-19-146"><a id="__codelineno-19-146" name="__codelineno-19-146"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">search_for</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-19-147"><a id="__codelineno-19-147" name="__codelineno-19-147"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;w&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">overwrite</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-19-148"><a id="__codelineno-19-148" name="__codelineno-19-148"></a><span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">g</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-19-149"><a id="__codelineno-19-149" name="__codelineno-19-149"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-19-150"><a id="__codelineno-19-150" name="__codelineno-19-150"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-151"><a id="__codelineno-19-151" name="__codelineno-19-151"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>给进程发送 GUI (键盘/鼠标)事件</p>
<ul>
<li>做个驱动 (可编程键盘/鼠标)</li>
<li>利用操作系统/窗口管理器提供的 API<ul>
<li>xdotool</li>
<li>ydotool</li>
<li>evdev (按键显示脚本；主播常用)</li>
</ul>
</li>
</ul>
<p>例子：实现按键精灵，实现按键精灵不必入侵进程的地址空间。操作系统管理了 I/O 设备，我们相应模拟出按键的事件即可。当然，我们也可以为进程像游戏修改器那样注入按键事件。</p>
<p><code>sudo ./anjian</code>，then open <a href="https://js13kgames.com/games/spacebar-clicker/index.html">https://js13kgames.com/games/spacebar-clicker/index.html</a>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="ch">#!/bin/bash</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="c1"># Needs sudo. Try:</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="c1"># https://js13kgames.com/games/spacebar-clicker/index.html</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;Start in 5 seconds...&#39;</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a>ydotoold<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="p">&amp;</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a>sleep<span class="w"> </span><span class="m">5</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="k">for</span><span class="w"> </span>_<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">200</span><span class="k">)</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="k">do</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">    </span>ydotool<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s1">&#39; &#39;</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">0</span>.01
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="k">done</span>
</span></code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>改变进程对时间的感知</p>
<p>程序 = 状态机</p>
<ul>
<li>
<p>“计算指令” 是不能感知时间的</p>
<ul>
<li>spin count 计时会出现 “机器变快，游戏没法玩” 的情况</li>
<li>syscall 是感知时间的唯一方法</li>
</ul>
</li>
<li>
<p>“劫持” 和时间相关的 syscall/库函数</p>
<ul>
<li>改变程序对时间的认知</li>
<li>就像手表调快/慢了一样</li>
</ul>
</li>
</ul>
<p>例子：变速齿轮 <code>./gear 10 tetris</code></p>
<p>gear：实际上就是个python脚本，调用 gdb 调试 tetris 游戏，劫持 gettimeofday 系统调用，实现变速齿轮。
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a>    <span class="n">ratio</span><span class="p">,</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="k">except</span><span class="p">:</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Example: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> 10 tetris  # 10X speedup&#39;</span><span class="p">)</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a>    <span class="p">[</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a>        <span class="s1">&#39;gdb&#39;</span><span class="p">,</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a>        <span class="s1">&#39;-ex&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;set $gear_ratio = </span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16"></a>        <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;gear-gdb.py&#39;</span><span class="p">,</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="n">exe</span><span class="p">,</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18"></a>    <span class="p">]</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div></p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span>
<span class="normal"><a href="#__codelineno-22-35">35</a></span>
<span class="normal"><a href="#__codelineno-22-36">36</a></span>
<span class="normal"><a href="#__codelineno-22-37">37</a></span>
<span class="normal"><a href="#__codelineno-22-38">38</a></span>
<span class="normal"><a href="#__codelineno-22-39">39</a></span>
<span class="normal"><a href="#__codelineno-22-40">40</a></span>
<span class="normal"><a href="#__codelineno-22-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kn">import</span> <span class="nn">gdb</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="kn">import</span> <span class="nn">datetime</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gdb</span><span class="o">.</span><span class="n">parse_and_eval</span><span class="p">(</span><span class="s1">&#39;$gear_ratio&#39;</span><span class="p">))</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="c1"># Get the current time</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="k">def</span> <span class="nf">hacked_time</span><span class="p">():</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a>    <span class="c1"># The speed of the clock is adjusted</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a>    <span class="n">tv_sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a>    <span class="n">tv_usec</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">microsecond</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tv_usec</span><span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18"></a>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="k">class</span> <span class="nc">SetTimevalBreakpoint</span><span class="p">(</span><span class="n">gdb</span><span class="o">.</span><span class="n">Breakpoint</span><span class="p">):</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SetTimevalBreakpoint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22"></a>            <span class="s1">&#39;gettimeofday&#39;</span><span class="p">,</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23"></a>            <span class="n">gdb</span><span class="o">.</span><span class="n">BP_BREAKPOINT</span><span class="p">,</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24"></a>            <span class="n">internal</span><span class="o">=</span><span class="kc">False</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25"></a>        <span class="p">)</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26"></a>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27"></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28"></a>        <span class="n">tv_sec</span><span class="p">,</span> <span class="n">tv_usec</span> <span class="o">=</span> <span class="n">hacked_time</span><span class="p">()</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30"></a>        <span class="c1"># Replace the function body</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31"></a>        <span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32"></a>            <span class="s1">&#39;set *(struct timeval *)($rdi) = {{ </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> }}&#39;</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33"></a>                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tv_usec</span><span class="p">)</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34"></a>        <span class="p">)</span>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35"></a>        <span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;set $rax = 0&#39;</span><span class="p">)</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36"></a>        <span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">)</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37"></a>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38"></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Continue execution</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39"></a>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="n">SetTimevalBreakpoint</span><span class="p">()</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="n">gdb</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>软件动态更新：我们可以通过 patch 函数的头部为一个跳转实现对一个函数的 “运行时热更新”。</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span>
<span class="normal"><a href="#__codelineno-23-28">28</a></span>
<span class="normal"><a href="#__codelineno-23-29">29</a></span>
<span class="normal"><a href="#__codelineno-23-30">30</a></span>
<span class="normal"><a href="#__codelineno-23-31">31</a></span>
<span class="normal"><a href="#__codelineno-23-32">32</a></span>
<span class="normal"><a href="#__codelineno-23-33">33</a></span>
<span class="normal"><a href="#__codelineno-23-34">34</a></span>
<span class="normal"><a href="#__codelineno-23-35">35</a></span>
<span class="normal"><a href="#__codelineno-23-36">36</a></span>
<span class="normal"><a href="#__codelineno-23-37">37</a></span>
<span class="normal"><a href="#__codelineno-23-38">38</a></span>
<span class="normal"><a href="#__codelineno-23-39">39</a></span>
<span class="normal"><a href="#__codelineno-23-40">40</a></span>
<span class="normal"><a href="#__codelineno-23-41">41</a></span>
<span class="normal"><a href="#__codelineno-23-42">42</a></span>
<span class="normal"><a href="#__codelineno-23-43">43</a></span>
<span class="normal"><a href="#__codelineno-23-44">44</a></span>
<span class="normal"><a href="#__codelineno-23-45">45</a></span>
<span class="normal"><a href="#__codelineno-23-46">46</a></span>
<span class="normal"><a href="#__codelineno-23-47">47</a></span>
<span class="normal"><a href="#__codelineno-23-48">48</a></span>
<span class="normal"><a href="#__codelineno-23-49">49</a></span>
<span class="normal"><a href="#__codelineno-23-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;In old function %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="p">}</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">foo_new</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;In new function %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">);</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="p">}</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="c1">// 48 b8 (64-bit imm)   movabs $imm,%rax</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="c1">// ff e0                jmpq   *%rax</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">PATCH</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\x48\xb8</span><span class="s">--------</span><span class="se">\xff\xe0</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18"></a>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">DSU</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">func_new</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">    </span><span class="c1">// Grant write permission to the memory</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">    </span><span class="c1">// We must handle boundary cases</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">func</span><span class="p">;</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">PATCH</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="w">        </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">  </span><span class="c1">// Cross page boundary</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="w">        </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;np = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">);</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32"></a>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// Not expecting a failure</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35"></a>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="w">    </span><span class="c1">// Patch the first instruction (this is UB in C spec)</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">PATCH</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">PATCH</span><span class="p">));</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">func</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_new</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">func_new</span><span class="p">));</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39"></a>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40"></a><span class="w">    </span><span class="c1">// Revoke the write permission</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">);</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">rc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">// Not expecting a failure</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="p">}</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44"></a>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46"></a><span class="w">    </span><span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47"></a><span class="w">    </span><span class="n">foo</span><span class="p">();</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48"></a><span class="w">    </span><span class="n">DSU</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">foo_new</span><span class="p">);</span><span class="w">  </span><span class="c1">// Dynamic software update</span>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49"></a><span class="w">    </span><span class="n">foo</span><span class="p">();</span>
</span><span id="__span-23-50"><a id="__codelineno-23-50" name="__codelineno-23-50"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
<h2 id="lecture-16-unix-shell">Lecture 16 系统调用和UNIX Shell<a class="headerlink" href="#lecture-16-unix-shell" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>通过 freestanding 的 shell，我们阐释了 “可以在系统调用上创建整个操作系统应用世界” 的真正含义：操作系统的 API 和应用程序是互相成就、螺旋生长的：有了新的应用需求，就有了新的操作系统功能。而 UNIX 为我们提供了一个非常精简、稳定的接口 (fork, execve, exit, pipe ,...)，纵然有沉重的历史负担，它在今天依然工作得很好。</p>
</div>
<ol>
<li>
<p>操作系统对象：</p>
<ul>
<li>进程和地址空间<ul>
<li>进程管理：fork, execve, exit</li>
<li>内存管理：mmap, munmap, mprotect</li>
</ul>
</li>
<li>文件和设备<ul>
<li>文件：有 “名字” 的对象，例如字节流 (终端) 或字节序列 (普通文件；包括 /proc/*)</li>
<li>文件描述符 (file descriptor，Windows中叫handle句柄)：<span style="color:lightblue;">指向操作系统对象的 “指针”</span></li>
<li>Everything is a file，通过指针可以访问 “一切”</li>
<li>对象的访问都需要指针：open, close, read/write (解引用), lseek (指针内赋值/运算), dup (指针间赋值)</li>
</ul>
</li>
<li>IPC Endpoints (Inter-Process Communication，进程间通信)<ul>
<li>管道：一个特殊的 “文件” (流)<ul>
<li>由读者/写者共享</li>
<li>读口：支持 read <code>fd[0]</code></li>
<li>写口：支持 write <code>fd[1]</code></li>
</ul>
</li>
<li>匿名管道<ul>
<li>返回两个文件描述符</li>
<li>进程同时拥有读口和写口
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">pipe</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>文件描述符是一个用于访问文件或其他输入/输出资源的 “指针”。在 Unix 和类 Unix 操作系统中，文件描述符是一个非负整数，用于表示一个打开的文件、管道、网络连接或其他类似的资源。当一个程序打开一个文件或创建一个数据流时，操作系统会返回一个文件描述符，程序可以通过这个描述符来读取、写入或操作对应的文件或资源。</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">try_open</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">fname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">    </span><span class="c1">// fd is a &quot;pointer&quot; to a kernel object.</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;open(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fname</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="n">fname</span><span class="p">);</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">release</span><span class="p">;</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17"></a>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="nl">release</span><span class="p">:</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20"></a><span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="p">}</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23"></a>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25"></a><span class="w">    </span><span class="n">try_open</span><span class="p">(</span><span class="s">&quot;/something/not/exist&quot;</span><span class="p">);</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">    </span><span class="n">try_open</span><span class="p">(</span><span class="s">&quot;/dev/sda&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// hard drive</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>UNIX 管道 (pipe) 是一种典型的进程间通信机制，允许数据在不同的进程之间单向流动。管道可以被视为一种特殊的文件，其中一个进程将数据写入管道的一端，而另一个进程从另一端读取数据。</p>
<ul>
<li>pipe read 在没有数据时会等待</li>
<li>pipe write 在有读者打开时，会写入操作系统的缓冲区并返回</li>
<li>write 如果 “不太多”，一对 write-read 是原子的</li>
<li>write 如果超过 PIPE_BUF，可能会被拆成多份</li>
<li>如果读者关闭，会收到 SIGPIPE 信号<ul>
<li>经常看到的 “Broken Pipe”</li>
</ul>
</li>
<li>“看不到” 的 SIGPIPE<ul>
<li><code>yes | head -n 1</code></li>
<li><code>(yes; echo $? &gt; /dev/stderr) | head -n 1</code> (返回141而非0，所以实际上还是有SIGPIPE发生)</li>
</ul>
</li>
<li>“看得到” 的 SIGPIPE<ul>
<li><code>python3 -c 'while True: print(1)' | head -n 1</code></li>
</ul>
</li>
</ul>
<p><img alt="alt text" src="../../img/image-14.png" /></p>
<p>named_pipe.c:
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span>
<span class="normal"><a href="#__codelineno-26-33">33</a></span>
<span class="normal"><a href="#__codelineno-26-34">34</a></span>
<span class="normal"><a href="#__codelineno-26-35">35</a></span>
<span class="normal"><a href="#__codelineno-26-36">36</a></span>
<span class="normal"><a href="#__codelineno-26-37">37</a></span>
<span class="normal"><a href="#__codelineno-26-38">38</a></span>
<span class="normal"><a href="#__codelineno-26-39">39</a></span>
<span class="normal"><a href="#__codelineno-26-40">40</a></span>
<span class="normal"><a href="#__codelineno-26-41">41</a></span>
<span class="normal"><a href="#__codelineno-26-42">42</a></span>
<span class="normal"><a href="#__codelineno-26-43">43</a></span>
<span class="normal"><a href="#__codelineno-26-44">44</a></span>
<span class="normal"><a href="#__codelineno-26-45">45</a></span>
<span class="normal"><a href="#__codelineno-26-46">46</a></span>
<span class="normal"><a href="#__codelineno-26-47">47</a></span>
<span class="normal"><a href="#__codelineno-26-48">48</a></span>
<span class="normal"><a href="#__codelineno-26-49">49</a></span>
<span class="normal"><a href="#__codelineno-26-50">50</a></span>
<span class="normal"><a href="#__codelineno-26-51">51</a></span>
<span class="normal"><a href="#__codelineno-26-52">52</a></span>
<span class="normal"><a href="#__codelineno-26-53">53</a></span>
<span class="normal"><a href="#__codelineno-26-54">54</a></span>
<span class="normal"><a href="#__codelineno-26-55">55</a></span>
<span class="normal"><a href="#__codelineno-26-56">56</a></span>
<span class="normal"><a href="#__codelineno-26-57">57</a></span>
<span class="normal"><a href="#__codelineno-26-58">58</a></span>
<span class="normal"><a href="#__codelineno-26-59">59</a></span>
<span class="normal"><a href="#__codelineno-26-60">60</a></span>
<span class="normal"><a href="#__codelineno-26-61">61</a></span>
<span class="normal"><a href="#__codelineno-26-62">62</a></span>
<span class="normal"><a href="#__codelineno-26-63">63</a></span>
<span class="normal"><a href="#__codelineno-26-64">64</a></span>
<span class="normal"><a href="#__codelineno-26-65">65</a></span>
<span class="normal"><a href="#__codelineno-26-66">66</a></span>
<span class="normal"><a href="#__codelineno-26-67">67</a></span>
<span class="normal"><a href="#__codelineno-26-68">68</a></span>
<span class="normal"><a href="#__codelineno-26-69">69</a></span>
<span class="normal"><a href="#__codelineno-26-70">70</a></span>
<span class="normal"><a href="#__codelineno-26-71">71</a></span>
<span class="normal"><a href="#__codelineno-26-72">72</a></span>
<span class="normal"><a href="#__codelineno-26-73">73</a></span>
<span class="normal"><a href="#__codelineno-26-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="c1">// We also have UNIX domain sockets for local inter-process</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="c1">// communication--they also have a name in the file system</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="c1">// like &quot;/var/run/docker.sock&quot;. This is similar to a named</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="c1">// pipe.</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="cp">#define PIPE_NAME &quot;/tmp/my_pipe&quot;</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pipe_read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">PIPE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">);</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18"></a>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">);</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23"></a>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">    </span><span class="c1">// Read from the pipe</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_read</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;No data received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="p">}</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33"></a>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pipe_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35"></a><span class="w">    </span><span class="c1">// Open the pipe for writing</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">PIPE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">);</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37"></a>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">);</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42"></a>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43"></a><span class="w">    </span><span class="c1">// Write the message to the pipe</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44"></a><span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45"></a><span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46"></a><span class="p">}</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47"></a>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Usage: %s read|write [message]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53"></a>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54"></a><span class="w">    </span><span class="c1">// Create the named pipe if it does not exist</span>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">PIPE_NAME</span><span class="p">,</span><span class="w"> </span><span class="mo">0666</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">EEXIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57"></a><span class="w">            </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;mkfifo&quot;</span><span class="p">);</span>
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Created &quot;</span><span class="w"> </span><span class="n">PIPE_NAME</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63"></a>
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="w">        </span><span class="n">pipe_read</span><span class="p">();</span>
</span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;write&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67"></a><span class="w">        </span><span class="n">pipe_write</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69"></a><span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid command. Use &#39;read&#39; or &#39;write&#39;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-72"><a id="__codelineno-26-72" name="__codelineno-26-72"></a>
</span><span id="__span-26-73"><a id="__codelineno-26-73" name="__codelineno-26-73"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-26-74"><a id="__codelineno-26-74" name="__codelineno-26-74"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
<p>anonymous-pipe.c：父进程持有写口，子进程持有读口。
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span>
<span class="normal"><a href="#__codelineno-27-35">35</a></span>
<span class="normal"><a href="#__codelineno-27-36">36</a></span>
<span class="normal"><a href="#__codelineno-27-37">37</a></span>
<span class="normal"><a href="#__codelineno-27-38">38</a></span>
<span class="normal"><a href="#__codelineno-27-39">39</a></span>
<span class="normal"><a href="#__codelineno-27-40">40</a></span>
<span class="normal"><a href="#__codelineno-27-41">41</a></span>
<span class="normal"><a href="#__codelineno-27-42">42</a></span>
<span class="normal"><a href="#__codelineno-27-43">43</a></span>
<span class="normal"><a href="#__codelineno-27-44">44</a></span>
<span class="normal"><a href="#__codelineno-27-45">45</a></span>
<span class="normal"><a href="#__codelineno-27-46">46</a></span>
<span class="normal"><a href="#__codelineno-27-47">47</a></span>
<span class="normal"><a href="#__codelineno-27-48">48</a></span>
<span class="normal"><a href="#__codelineno-27-49">49</a></span>
<span class="normal"><a href="#__codelineno-27-50">50</a></span>
<span class="normal"><a href="#__codelineno-27-51">51</a></span>
<span class="normal"><a href="#__codelineno-27-52">52</a></span>
<span class="normal"><a href="#__codelineno-27-53">53</a></span>
<span class="normal"><a href="#__codelineno-27-54">54</a></span>
<span class="normal"><a href="#__codelineno-27-55">55</a></span>
<span class="normal"><a href="#__codelineno-27-56">56</a></span>
<span class="normal"><a href="#__codelineno-27-57">57</a></span>
<span class="normal"><a href="#__codelineno-27-58">58</a></span>
<span class="normal"><a href="#__codelineno-27-59">59</a></span>
<span class="normal"><a href="#__codelineno-27-60">60</a></span>
<span class="normal"><a href="#__codelineno-27-61">61</a></span>
<span class="normal"><a href="#__codelineno-27-62">62</a></span>
<span class="normal"><a href="#__codelineno-27-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/wait.h&gt;</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">do_parent</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello, world!&quot;</span><span class="p">;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9"></a>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%d] Write: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12"></a>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14"></a>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">    </span><span class="c1">// Wait for the child to finish</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">    </span><span class="n">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17"></a>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%d] Done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">());</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="p">}</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20"></a>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="kt">void</span><span class="w"> </span><span class="nf">do_child</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23"></a>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">num_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_read</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;read&quot;</span><span class="p">);</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29"></a>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%d] Got: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31"></a>
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32"></a><span class="w">    </span><span class="c1">// Close the read end of the pipe</span>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33"></a><span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34"></a><span class="p">}</span>
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35"></a>
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pipefd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38"></a>
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39"></a><span class="w">    </span><span class="c1">// Create a pipe</span>
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">pipefd</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;pipe&quot;</span><span class="p">);</span>
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44"></a>
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45"></a><span class="w">    </span><span class="c1">// Fork the current process</span>
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46"></a><span class="w">    </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48"></a><span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork&quot;</span><span class="p">);</span>
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49"></a><span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51"></a>
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53"></a><span class="w">        </span><span class="c1">// Child</span>
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54"></a><span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// Close unused write end</span>
</span><span id="__span-27-55"><a id="__codelineno-27-55" name="__codelineno-27-55"></a><span class="w">        </span><span class="n">do_child</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-27-56"><a id="__codelineno-27-56" name="__codelineno-27-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-57"><a id="__codelineno-27-57" name="__codelineno-27-57"></a><span class="w">        </span><span class="c1">// Parent</span>
</span><span id="__span-27-58"><a id="__codelineno-27-58" name="__codelineno-27-58"></a><span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// Close unused read end</span>
</span><span id="__span-27-59"><a id="__codelineno-27-59" name="__codelineno-27-59"></a><span class="w">        </span><span class="n">do_parent</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span id="__span-27-60"><a id="__codelineno-27-60" name="__codelineno-27-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-61"><a id="__codelineno-27-61" name="__codelineno-27-61"></a>
</span><span id="__span-27-62"><a id="__codelineno-27-62" name="__codelineno-27-62"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-27-63"><a id="__codelineno-27-63" name="__codelineno-27-63"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>sh.c debug：可以清楚地看到，进程3的标准输出<code>1</code>向管道里写数据，然后执行<code>runcmd(pcmd-&gt;left);</code>进程4的标准输入<code>0</code>从管道里读数据，然后执行<code>runcmd(pcmd-&gt;right);</code></p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a>Process<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span><span class="m">11026</span><span class="o">)</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="m">0</span><span class="w"> </span>&lt;-&gt;<span class="w"> </span>/dev/pts/7
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="m">1</span><span class="w"> </span>--&gt;<span class="w"> </span><span class="o">[===</span><span class="w"> </span><span class="nv">2123156</span><span class="w"> </span><span class="o">===]</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="m">2</span><span class="w"> </span>&lt;-&gt;<span class="w"> </span>/dev/pts/7
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a>Process<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">(</span><span class="m">11699</span><span class="o">)</span>*
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="m">0</span><span class="w"> </span>&lt;--<span class="w"> </span><span class="o">[===</span><span class="w"> </span><span class="nv">2123156</span><span class="w"> </span><span class="o">===]</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="m">1</span><span class="w"> </span>&lt;-&gt;<span class="w"> </span>/dev/pts/7
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">    </span><span class="m">2</span><span class="w"> </span>&lt;-&gt;<span class="w"> </span>/dev/pts/7
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="m">112</span><span class="w">                 </span>runcmd<span class="o">(</span>pcmd-&gt;right<span class="o">)</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>以下报错的原因：<code>&gt;</code>和<code>|</code>一样，都是先把两边的文件描述符准备好，也就是说<code>sudo echo hello</code>和打开<code>/etc/a.txt</code>是分开执行的，因此无权限打开<code>/etc/a.txt</code></p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>hello<span class="w"> </span>&gt;<span class="w"> </span>/etc/a.txt
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a>bash:<span class="w"> </span>/etc/a.txt:<span class="w"> </span>Permission<span class="w"> </span>denied
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a>$<span class="w"> </span>sudo<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>hello<span class="w"> </span>&gt;<span class="w"> </span>/etc/a.txt
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a>bash:<span class="w"> </span>/etc/a.txt:<span class="w"> </span>Permission<span class="w"> </span>denied
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
<h2 id="lecture-17-c">Lecture 17 C 标准库和实现<a class="headerlink" href="#lecture-17-c" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>在系统调用和语言机制的基础上，libc 为我们提供了开发跨平台应用程序的 “第一级抽象”。在此基础上构建起了万千世界：C++ (扩充了 C 标准库)、Java、浏览器世界……今天，C 语言在应用开发方面有很多缺陷，但仍然为 “第一级抽象” 提供了一个有趣的范本。</p>
</div>
<ol>
<li>
<p>C里的 <code>_start</code> 函数是程序执行的起点。当一个C程序被编译和链接成可执行文件后，操作系统会将程序加载到内存中，并跳转到 <code>_start</code> 函数开始执行。<code>_start</code> 函数通常是由编译器和链接器自动生成的，它负责初始化程序运行所需的环境，然后调用 <code>main</code> 函数。也就是说，<code>_start</code>函数是操作系统和二进制文件之间的约定（在libc里的Scrt1.o会帮忙定义好）。以下可以看到Entry point address是0x4019f5，正是<code>_start</code>的地址。</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a>linux$<span class="w"> </span>readelf<span class="w"> </span>-h<span class="w"> </span>sh
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a>ELF<span class="w"> </span>Header:
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a>Magic:<span class="w">   </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a>Class:<span class="w">                             </span>ELF64
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a>Data:<span class="w">                              </span><span class="m">2</span><span class="err">&#39;</span>s<span class="w"> </span>complement,<span class="w"> </span>little<span class="w"> </span>endian
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a>Version:<span class="w">                           </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>current<span class="o">)</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a>OS/ABI:<span class="w">                            </span>UNIX<span class="w"> </span>-<span class="w"> </span>System<span class="w"> </span>V
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a>ABI<span class="w"> </span>Version:<span class="w">                       </span><span class="m">0</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a>Type:<span class="w">                              </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a>Machine:<span class="w">                           </span>Advanced<span class="w"> </span>Micro<span class="w"> </span>Devices<span class="w"> </span>X86-64
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a>Version:<span class="w">                           </span>0x1
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a>Entry<span class="w"> </span>point<span class="w"> </span>address:<span class="w">               </span>0x4019f5
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a>Start<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">          </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="w"> </span>into<span class="w"> </span>file<span class="o">)</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a>Start<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">          </span><span class="m">23696</span><span class="w"> </span><span class="o">(</span>bytes<span class="w"> </span>into<span class="w"> </span>file<span class="o">)</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a>Flags:<span class="w">                             </span>0x0
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a>Size<span class="w"> </span>of<span class="w"> </span>this<span class="w"> </span>header:<span class="w">               </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a>Size<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">           </span><span class="m">56</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18"></a>Number<span class="w"> </span>of<span class="w"> </span>program<span class="w"> </span>headers:<span class="w">         </span><span class="m">8</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19"></a>Size<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">           </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20"></a>Number<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>headers:<span class="w">         </span><span class="m">19</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21"></a>Section<span class="w"> </span>header<span class="w"> </span>string<span class="w"> </span>table<span class="w"> </span>index:<span class="w"> </span><span class="m">18</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22"></a>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23"></a>linux$<span class="w"> </span>objdump<span class="w"> </span>-d<span class="w"> </span>sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>less
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24"></a>00000000004019f5<span class="w"> </span>&lt;_start&gt;:
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25"></a>4019f5:<span class="w">       </span>f3<span class="w"> </span>0f<span class="w"> </span>1e<span class="w"> </span>fa<span class="w">             </span>endbr64<span class="w"> </span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26"></a>4019f9:<span class="w">       </span><span class="m">55</span><span class="w">                      </span>push<span class="w">   </span>%rbp
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27"></a>4019fa:<span class="w">       </span><span class="m">48</span><span class="w"> </span><span class="m">89</span><span class="w"> </span>e5<span class="w">                </span>mov<span class="w">    </span>%rsp,%rbp
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28"></a>4019fd:<span class="w">       </span>b8<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x0,%eax
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29"></a>401a02:<span class="w">       </span>e8<span class="w"> </span>e9<span class="w"> </span>fe<span class="w"> </span>ff<span class="w"> </span>ff<span class="w">          </span>call<span class="w">   </span>4018f0<span class="w"> </span>&lt;main&gt;
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30"></a>401a07:<span class="w">       </span>be<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x0,%esi
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31"></a>401a0c:<span class="w">       </span>bf<span class="w"> </span>3c<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x3c,%edi
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32"></a>401a11:<span class="w">       </span>b8<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">          </span>mov<span class="w">    </span><span class="nv">$0</span>x0,%eax
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33"></a>401a16:<span class="w">       </span>e8<span class="w"> </span>e5<span class="w"> </span>f5<span class="w"> </span>ff<span class="w"> </span>ff<span class="w">          </span>call<span class="w">   </span><span class="m">401000</span><span class="w"> </span>&lt;syscall&gt;
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34"></a>401a1b:<span class="w">       </span><span class="m">90</span><span class="w">                      </span>nop
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35"></a>401a1c:<span class="w">       </span>5d<span class="w">                      </span>pop<span class="w">    </span>%rbp
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36"></a>401a1d:<span class="w">       </span>c3<span class="w">                      </span>ret
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><span style="color:lightblue;">系统调用是地基，C 语言是框架。</span>glibc 的代码有非常沉重的历史包袱，更适合学习的 libc 实现：<a href="https://musl.libc.org/">musl libc</a></p>
<p>使用musl-gcc来编译，而不是gcc，看下musl-gcc的真面目：musl-gcc通过.specs脚本来控制编译器不要链接glibc而是链接自己的libc。</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span>
<span class="normal"><a href="#__codelineno-31-2">2</a></span>
<span class="normal"><a href="#__codelineno-31-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a>linux$<span class="w"> </span>cat<span class="w"> </span><span class="o">(</span>which<span class="w"> </span>musl-gcc<span class="o">)</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="c1">#!/bin/sh</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="nb">exec</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">REALGCC</span><span class="k">:-</span><span class="nv">x86_64</span><span class="p">-linux-gnu-gcc</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="w"> </span>-specs<span class="w"> </span><span class="s2">&quot;/usr/lib/x86_64-linux-musl/musl-gcc.specs&quot;</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>debug dummy.c</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><figure markdown> 
    <img alt="Image title" src="../../img/image-15.png" width="300" />
    <figcaption>操作系统将这些内容放入栈中</figcaption>
</figure></p>
<p>env.c：</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="c1">// A mysteriously defined symbol.</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="c1">// Someone must defined it elsewhere.</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">environ</span><span class="p">;</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="c1">// Like this even more mysterious one.</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="c1">// &quot;end&quot; can be of any type.</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">******************************</span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[],</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">envp</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;environ: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">environ</span><span class="p">);</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;envp:    %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">envp</span><span class="p">);</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">environ</span><span class="p">;</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">;</span><span class="w"> </span><span class="n">env</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="w">        </span><span class="c1">// key=value</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">env</span><span class="p">);</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-19"><a id="__codelineno-33-19" name="__codelineno-33-19"></a>
</span><span id="__span-33-20"><a id="__codelineno-33-20" name="__codelineno-33-20"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="c1">// ???</span>
</span><span id="__span-33-21"><a id="__codelineno-33-21" name="__codelineno-33-21"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>输出:</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span>
<span class="normal"><a href="#__codelineno-34-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a>environ:<span class="w"> </span>0x7ffdb556d2d8
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a>envp:<span class="w">    </span>0x7ffdb556d2d8
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="nv">SHELL</span><span class="o">=</span>/bin/bash
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="nv">COLORTERM</span><span class="o">=</span>truecolor
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a>...
</span></code></pre></div></td></tr></table></div>
<p><a id="system-v-abi"></a>
<a href="https://jyywiki.cn/OS/manuals/sysv-abi.pdf">System V ABI</a>里定义了规范：</p>
<p><img alt="alt text" src="../../img/image-16.png" width="500" /></p>
<p>其他状态 (主要是内存) 则是由可执行文件指定，详情看<a href="#minimal-loader">Lecture 19</a>。</p>
</li>
<li>
<p>libc对系统调用与环境的抽象</p>
<p>什么是stdout？</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="o">+</span><span class="n">UNGET</span><span class="p">];</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="n">hidden</span><span class="w"> </span><span class="kt">FILE</span><span class="w"> </span><span class="n">__stdout_FILE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">    </span><span class="p">.</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="o">+</span><span class="n">UNGET</span><span class="p">,</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="p">.</span><span class="n">buf_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buf</span><span class="o">-</span><span class="n">UNGET</span><span class="p">,</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">    </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F_PERM</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">F_NORD</span><span class="p">,</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="p">.</span><span class="n">lbf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">,</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">    </span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__stdout_write</span><span class="p">,</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">    </span><span class="p">.</span><span class="n">seek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__stdio_seek</span><span class="p">,</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">    </span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__stdio_close</span><span class="p">,</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">    </span><span class="p">.</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="p">};</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">__stdout_FILE</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>所有 API 都可能失败，errno 是进程共享还是线程独享？➡️ 线程独享，gdb调试可以看到errno是tls (Thread Local Storage)的。</p>
</li>
<li>
<p>malloc() 的观察：我们需要管理的对象</p>
<ul>
<li>小对象：字符串、临时对象等；生存周期可长可短</li>
<li>中对象：容器、复杂的对象；更长的生存周期</li>
<li>大对象：巨大的容器、分配器；很长的生存周期</li>
</ul>
<p>设置两套系统：</p>
<ul>
<li>Fast path (System I)<ul>
<li>性能极好、并行度极高、覆盖大部分情况</li>
<li>但有小概率会失败 (fall back to slow path)</li>
</ul>
</li>
<li>Slow path (System II)<ul>
<li>不在乎那么快</li>
<li>但把困难的事情做好</li>
</ul>
</li>
<li>计算机系统里有很多这样的例子 (比如 cache)</li>
</ul>
<p>malloc: Fast Path 设计 ➡️ 立即在线程本地分配完成。浪费一点空间，但使所有 CPU 都能并行地申请内存</p>
<ul>
<li>线程都事先瓜分一些 “领地” (thread-local allocation buffer)</li>
<li>默认从自己的领地里分配<ul>
<li>除了在另一个 CPU 释放，acquire lock 几乎总是成功</li>
</ul>
</li>
<li>如果自己的领地不足，就从全局的池子里借一点</li>
</ul>
<p>malloc: Slow Path 设计 ➡️ pgalloc()</p>
</li>
<li>
<p>如何调试进入 musl libc</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span>
<span class="normal"><a href="#__codelineno-36-3">3</a></span>
<span class="normal"><a href="#__codelineno-36-4">4</a></span>
<span class="normal"><a href="#__codelineno-36-5">5</a></span>
<span class="normal"><a href="#__codelineno-36-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a>tar<span class="w"> </span>-xzf<span class="w"> </span>musl-1.2.5.tar.gz<span class="w">  </span><span class="c1"># 解压后进入</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="nb">cd</span><span class="w"> </span>musl-1.2.5
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a>./configure<span class="w"> </span>--enable-debug<span class="w">  </span><span class="c1"># 这步是关键!</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install<span class="w">        </span><span class="c1"># 编译并安装到 /usr/local/musl</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;/usr/local/musl/bin:$PATH&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w">  </span>~/.bashrc
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="nb">source</span><span class="w"> </span>~/.bashrc<span class="w">            </span><span class="c1"># 修改环境变量 path 并生效</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
<h2 id="lecture-18-linux">Lecture 18 Linux 操作系统<a class="headerlink" href="#lecture-18-linux" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>我们从 CPU Reset 后的 “硬件初始状态” 到操作系统加载完 init 进程后的 “软件初始状态”，从此以后，计算机系统中的一切都是由应用程序主导的，操作系统只是提供系统调用这一服务接口。正是系统调用 (包括操作系统中的对象) 这个稳定的、向后兼容的接口随着历史演化和积累，形成了难以逾越的技术屏障，在颠覆性的技术革新到来之前，另起炉灶都是非常困难的。</p>
</div>
<ol>
<li>
<p>启动 Linux - Initial RAM FS</p>
<p>硬件 (ISA) → 操作系统对象/系统调用 → libc → 系统工具 (coretuils, busybox, ...) → 应用程序 (xfce, vscode)</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a>make<span class="w"> </span>initramfs<span class="w"> </span><span class="c1"># 需要/boot/vmlinuz，wsl里没有，就没有做下去了</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a>make
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a>make<span class="w"> </span>run
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a>/bin/busybox<span class="w"> </span>ls
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span>
<span class="normal"><a href="#__codelineno-38-4">4</a></span>
<span class="normal"><a href="#__codelineno-38-5">5</a></span>
<span class="normal"><a href="#__codelineno-38-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="nb">exec</span><span class="w"> </span>switch_root<span class="w"> </span>/newroot/<span class="w"> </span>/init
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="c1"># switch_root 程序首先将当前的根文件系统（initramfs）卸载。</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="c1"># 然后，它将新根文件系统（/newroot/）挂载到 / 目录。</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="c1"># 接下来，它执行新根文件系统中的初始化程序 /init，以启动系统的初始化进程。</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="c1"># 最后，当前的 shell 进程被替换为新的初始化进程，系统继续启动。</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="c1"># (exec：这是一个 shell 内置命令，用于执行指定的命令并替换当前的 shell 进程。)</span>
</span></code></pre></div></td></tr></table></div>
<p>最小 Linux: 我们可以在 initramfs 中放置任意的数据——包括应用程序、内核模块 (驱动)、数据、脚本……操作系统世界已经开始运转；但直到执行 switch_root (pivot_root) (注意调用switch_root的pid必须是1)，才真正开始 今天 Linux 应用世界 (systemd) 的启动。</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a>linux$<span class="w"> </span>ls<span class="w"> </span>/sbin/init<span class="w"> </span><span class="c1"># 现代的Linux启动用的是/sbin/init</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a>lrwxrwxrwx<span class="w"> </span>/sbin/init<span class="w"> </span>-&gt;<span class="w"> </span>/lib/systemd/systemd
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>Initramfs: 并不是我们实际看到的 Linux</p>
<p>启动的初级阶段</p>
<ul>
<li>加载剩余必要的驱动程序，例如磁盘/网卡</li>
<li>挂载必要的文件系统</li>
<li>将根文件系统和控制权移交给另一个程序，例如 systemd (system and service manager)</li>
</ul>
<p>启动的第二级阶段</p>
<ul>
<li>看一看系统里的 /sbin/init 是什么？</li>
<li>计算机系统没有魔法 (一切都有合适的解释)<ul>
<li>pstree 埋下的伏笔得到解答：pstree输出的根是systemd</li>
</ul>
</li>
</ul>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a>linux$<span class="w"> </span>pstree
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a>systemd─┬─.vasd───.vasd───4*<span class="o">[</span>.vasd<span class="o">]</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="w">        </span>├─ModemManager───2*<span class="o">[{</span>ModemManager<span class="o">}]</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">        </span>├─NetworkManager───2*<span class="o">[{</span>NetworkManager<span class="o">}]</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">        </span>├─accounts-daemon───2*<span class="o">[{</span>accounts-daemon<span class="o">}]</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w">        </span>├─acpid
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">        </span>├─at-spi-bus-laun─┬─dbus-daemon
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">        </span>│<span class="w">                 </span>└─3*<span class="o">[{</span>at-spi-bus-laun<span class="o">}]</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">        </span>├─at-spi2-registr───2*<span class="o">[{</span>at-spi2-registr<span class="o">}]</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="w">        </span>├─avahi-daemon───avahi-daemon
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="w">        </span>├─colord───2*<span class="o">[{</span>colord<span class="o">}]</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="w">        </span>├─containerd───11*<span class="o">[{</span>containerd<span class="o">}]</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w">        </span>├─containerd-shim─┬─dumb-init─┬─bash───Xvfb
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">        </span>│<span class="w">                 </span>│<span class="w">           </span>├─2*<span class="o">[</span>conhost.exe<span class="o">]</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w">        </span>│<span class="w">                 </span>│<span class="w">           </span>├─...
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">        </span>│<span class="w">                 </span>│<span class="w">           </span>└─wineserver
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="w">        </span>│<span class="w">                 </span>└─12*<span class="o">[{</span>containerd-shim<span class="o">}]</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="w">        </span>├─containerd-shim─┬─dumb-init─┬─bash───Xvfb
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19"></a><span class="w">        </span>│<span class="w">                 </span>│<span class="w">           </span>└─mount.ntfs
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w">        </span>│<span class="w">                 </span>└─12*<span class="o">[{</span>containerd-shim<span class="o">}]</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="w">        </span>├─3*<span class="o">[</span>containerd-shim─┬─dumb-init─┬─bash───Xvfb<span class="o">]</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">        </span>│<span class="w">                    </span>│<span class="w">           </span>└─mount.ntfs<span class="o">]</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="w">        </span>│<span class="w">                    </span>└─11*<span class="o">[{</span>containerd-shim<span class="o">}]]</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w">        </span>├─cron
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w">        </span>├...
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26"></a><span class="w">        </span>└─xrdp-sesman
</span></code></pre></div></td></tr></table></div>
</li>
</ol>
<h2 id="lecture-19">Lecture 19 可执行文件和加载<a class="headerlink" href="#lecture-19" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>可执行文件是一个描述状态机初始状态的数据结构 (字节序列)；加载器就是把这个 “初始状态” 搬运到操作系统中的程序。用数据结构的眼光看可执行文件，就不难发现它不好阅读的原因：它的设计者并没有打算让你阅读它。这样的难题在《操作系统》课程中经常出现；而我们的应对方法是先理解一个粗糙但重要的模型，然后在此基础上理解工业级实现面临的挑战和问题。</p>
</div>
<ol>
<li>
<p>什么是可执行文件？➡️ 进程初始状态的描述</p>
<ul>
<li>一个操作系统中的对象 (文件)</li>
<li>一个字节序列 (我们可以把它当字符串编辑)</li>
<li>一个描述了状态机初始状态的数据结构</li>
</ul>
<p>ELF: Executable and Linkable Format，<a href="https://www.gnu.org/software/binutils/">binutils</a> 中的工具可以让我们查看其中的重要信息</p>
</li>
<li>
<p>UNIX a.out ➡️ “assembler output”</p>
<p>以前的版本：一个相对平坦的数据结构</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">exec</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_midmag</span><span class="p">;</span><span class="w">  </span><span class="c1">// Machine ID &amp; Magic</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_text</span><span class="p">;</span><span class="w">    </span><span class="c1">// Text segment size</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_data</span><span class="p">;</span><span class="w">    </span><span class="c1">// Data segment size</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_bss</span><span class="p">;</span><span class="w">     </span><span class="c1">// BSS segment size (存储未初始化的全局变量和静态变量)</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_syms</span><span class="p">;</span><span class="w">    </span><span class="c1">// Symbol table size</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_entry</span><span class="p">;</span><span class="w">   </span><span class="c1">// Entry point</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_trsize</span><span class="p">;</span><span class="w">  </span><span class="c1">// Text reloc table size</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w">  </span><span class="n">a_drsize</span><span class="p">;</span><span class="w">  </span><span class="c1">// Data reloc table size</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="p">};</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>Funny Linkable Executable</p>
<p>核心设计思路</p>
<ul>
<li>一切都对人类直接可读 (所有信息都在局部)</li>
<li>回归链接和加载中的核心概念：<span style="color:lightblue;">代码、符号、重定位</span> (多个文件链接起来必需符号、重定位。符号：main函数里一个global的变量x，别人可以用它；重定位：我用了一个变量x，是别人定义的)</li>
</ul>
<p>代码 (🔢)、符号 (📤)、重定位 (❓)：凑齐这三要素，我们就可以做可执行文件了！</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="err">📤</span><span class="o">:</span><span class="w"> </span><span class="n">_start</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="n">c7</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">3</span><span class="n">c</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="n">c7</span><span class="w"> </span><span class="n">c7</span><span class="w"> </span><span class="mi">2</span><span class="n">a</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span><span class="w"> </span><span class="mo">00</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">              </span><span class="o">^</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">              </span><span class="o">|</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w">        </span><span class="n">This</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="p">(</span><span class="mi">42</span><span class="p">).</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="mf">0f</span><span class="w"> </span><span class="mo">05</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="err">🔢</span><span class="o">:</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span><span class="w"> </span><span class="n">ff</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="err">❓</span><span class="o">:</span><span class="w"> </span><span class="n">i32</span><span class="p">(</span><span class="n">unresolved_symbol</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">📍</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a>linux$<span class="w"> </span>./minimal.fle<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$?</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="m">42</span><span class="w">    </span><span class="c1"># 对应于minimal.fle里的 2a (return code)</span>
</span></code></pre></div></td></tr></table></div>
<p>开头的<code>48 c7</code>是move指令，结尾的<code>0f 05</code>是syscall指令。</p>
</li>
<li>
<p>foo.c</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span>
<span class="normal"><a href="#__codelineno-44-6">6</a></span>
<span class="normal"><a href="#__codelineno-44-7">7</a></span>
<span class="normal"><a href="#__codelineno-44-8">8</a></span>
<span class="normal"><a href="#__codelineno-44-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;minilib.h&quot;</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="c1">// Global data</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="kt">char</span><span class="w"> </span><span class="n">msg</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span>
<span class="normal"><a href="#__codelineno-45-4">4</a></span>
<span class="normal"><a href="#__codelineno-45-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a>linux$<span class="w"> </span>make
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a>./cc<span class="w"> </span>-Wall<span class="w"> </span>-g<span class="w"> </span>-Os<span class="w"> </span>foo.c<span class="w"> </span>-o<span class="w"> </span>foo.o
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a>./cc<span class="w"> </span>-Wall<span class="w"> </span>-g<span class="w"> </span>-Os<span class="w"> </span>libc.c<span class="w"> </span>-o<span class="w"> </span>libc.o
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a>./cc<span class="w"> </span>-Wall<span class="w"> </span>-g<span class="w"> </span>-Os<span class="w"> </span>main.c<span class="w"> </span>-o<span class="w"> </span>main.o
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a>./ld<span class="w"> </span>foo.fle<span class="w"> </span>libc.fle<span class="w"> </span>main.fle<span class="w"> </span>-o<span class="w"> </span>hello
</span></code></pre></div></td></tr></table></div>
<p>foo.fle</p>
<p><div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="p">{</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">    </span><span class="s">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;.obj&quot;</span><span class="p">,</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="s">&quot;.text&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">        </span><span class="s">&quot;🏷️: _text&quot;</span><span class="p">,</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">        </span><span class="s">&quot;📤: foo&quot;</span><span class="p">,</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">        </span><span class="s">&quot;🔢: f3 0f 1e fa 8b 05&quot;</span><span class="p">,</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">        </span><span class="s">&quot;❓: i32(n - 0x4 - 📍)&quot;</span><span class="p">,</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">        </span><span class="s">&quot;🔢: c3&quot;</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">    </span><span class="s">&quot;.data&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">        </span><span class="s">&quot;📤: msg&quot;</span><span class="p">,</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">        </span><span class="s">&quot;🔢: 48 65 6c 6c 6f 20 57 6f 72 6c 64 21 0a 00&quot;</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="w">    </span><span class="p">],</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="w">    </span><span class="s">&quot;.bss&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
5. 生成可执行文件</p>
<p>(1) 预处理</p>
<ul>
<li>源代码 (.c) → 源代码 (.i)          ➡️ <code>gcc -E foo.c -o foo.i</code></li>
<li>Ctrl-C &amp; Ctrl-V (#include)</li>
<li>字符串替换</li>
<li>今天：我们有<a href="https://doc.rust-lang.org/reference/procedural-macros.html">过程宏</a></li>
</ul>
<p>(2) 编译 (cc)</p>
<ul>
<li>源代码 (.i) → 汇编代码 (.s)         ➡️ <code>gcc -S foo.i -o foo.s</code></li>
<li>“高级状态机” 到 “低级状态机” 的翻译</li>
<li>最终生成带标注的指令序列</li>
</ul>
<p>(3) 汇编 (as)</p>
<ul>
<li>汇编代码 (.s) → 目标文件 (.o)       ➡️ <code>gcc -c foo.s -o foo.o</code></li>
<li>文件 = sections (.text, .data, .rodata.str.1, ...)<ul>
<li>对于 ELF，每个 section 有它的权限、内存对齐等信息</li>
</ul>
</li>
<li>section 中的三要素<ul>
<li>代码 (字节序列)</li>
<li>符号：标记 “当前” 的位置</li>
<li>重定位：暂时不能确定的数值 (链接时确定)</li>
</ul>
</li>
</ul>
<p>(4) 链接 (ld)                         ➡️ <code>gcc foo.o -o foo</code></p>
<ul>
<li>多个目标文件 (.o) → 可执行文件 (a.out)</li>
<li>合并所有的 sections<ul>
<li>分别合并 .text, .data, .bss 中的代码</li>
<li>把 sections “平铺” 成字节序列</li>
<li>确定所有符号的位置</li>
<li>解析全部重定位</li>
</ul>
</li>
<li>得到一个可执行文件<ul>
<li>(程序初始内存状态的描述)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>程序的加载：把 “字节序列” 搬到内存</p>
<ul>
<li>没错，就只做这一件事</li>
<li>然后设置正确的 PC，开始运行</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Python</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span>
<span class="normal"><a href="#__codelineno-47-6">6</a></span>
<span class="normal"><a href="#__codelineno-47-7">7</a></span>
<span class="normal"><a href="#__codelineno-47-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a>    <span class="n">fileno</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">),</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a>    <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">mmap</span><span class="o">.</span><span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">mmap</span><span class="o">.</span><span class="n">PROT_EXEC</span><span class="p">,</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a>    <span class="n">flags</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">mmap</span><span class="o">.</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="p">)</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="n">mem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="n">mem</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="n">call_pointer</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">fle</span><span class="p">[</span><span class="s1">&#39;symbols&#39;</span><span class="p">][</span><span class="s1">&#39;_start&#39;</span><span class="p">])</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><code>#!</code> - Shebang</p>
<p>UNIX 对 # 注释的 “妙用”：在 UNIX 的早期，为了能更方便地将脚本作为可执行文件，实现了 #! 开头的 “可执行文件”，并沿用至今。Shebang 会调用第一行中执行的命令和参数，并把这个脚本文件作为命令行参数传入。</p>
<p>file.bin:
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="cp">#!A B C</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="c1">// 操作系统会执行 execve(A, [&quot;A&quot;, &quot;B C&quot;, &quot;file.bin&quot;], envp)</span>
</span></code></pre></div></td></tr></table></div></p>
<p>example1:</p>
<p>A.c如下，编译后得到可执行文件A</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span>
<span class="normal"><a href="#__codelineno-49-2">2</a></span>
<span class="normal"><a href="#__codelineno-49-3">3</a></span>
<span class="normal"><a href="#__codelineno-49-4">4</a></span>
<span class="normal"><a href="#__codelineno-49-5">5</a></span>
<span class="normal"><a href="#__codelineno-49-6">6</a></span>
<span class="normal"><a href="#__codelineno-49-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;argv[%d] = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>good脚本内容如下：</p>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="ch">#!A B C</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a>This<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>any<span class="w"> </span>script.
</span></code></pre></div></td></tr></table></div>
<p>执行结果：
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span>
<span class="normal"><a href="#__codelineno-51-4">4</a></span>
<span class="normal"><a href="#__codelineno-51-5">5</a></span>
<span class="normal"><a href="#__codelineno-51-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a>linux$<span class="w"> </span>./good<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">2</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a>argv<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>A
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a>argv<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>B<span class="w"> </span>C
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a>argv<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>./good
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a>argv<span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6"></a>argv<span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
</span></code></pre></div></td></tr></table></div></p>
<p>example2:</p>
<p>b文件内容如下：
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span>
<span class="normal"><a href="#__codelineno-52-2">2</a></span>
<span class="normal"><a href="#__codelineno-52-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="ch">#! /usr/bin/env python3</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a>print<span class="o">(</span><span class="s2">&quot;Hello World&quot;</span><span class="o">)</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div></p>
<p>执行结果：
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a>linux$<span class="w"> </span>./b
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a>Hello<span class="w"> </span>World
</span></code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>ELF例子：a.c</p>
<div class="language-C highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="n">__thread</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">         </span><span class="c1">// in tbss, t means thread local</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="n">__thread</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w">  </span><span class="c1">// in tdata, 已初始化的数据在data节</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="k">static</span><span class="w"> </span><span class="n">__thread</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="k">extern</span><span class="w"> </span><span class="n">__thread</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="p">{</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="c1">// 可以看到R_X86_64_GOTTPOFF z - 4</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">  1</a></span>
<span class="normal"><a href="#__codelineno-55-2">  2</a></span>
<span class="normal"><a href="#__codelineno-55-3">  3</a></span>
<span class="normal"><a href="#__codelineno-55-4">  4</a></span>
<span class="normal"><a href="#__codelineno-55-5">  5</a></span>
<span class="normal"><a href="#__codelineno-55-6">  6</a></span>
<span class="normal"><a href="#__codelineno-55-7">  7</a></span>
<span class="normal"><a href="#__codelineno-55-8">  8</a></span>
<span class="normal"><a href="#__codelineno-55-9">  9</a></span>
<span class="normal"><a href="#__codelineno-55-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-55-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-55-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-55-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-55-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-55-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-55-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-55-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-55-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-55-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-55-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-55-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-55-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-55-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-55-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-55-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-55-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-55-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-55-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-55-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-55-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-55-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-55-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-55-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-55-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-55-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-55-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-55-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-55-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-55-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-55-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-55-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-55-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-55-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-55-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-55-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-55-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-55-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-55-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-55-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-55-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-55-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-55-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-55-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-55-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-55-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-55-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-55-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-55-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-55-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-55-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-55-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-55-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-55-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-55-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-55-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-55-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-55-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-55-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-55-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-55-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-55-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-55-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-55-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-55-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-55-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-55-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-55-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-55-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-55-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-55-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-55-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-55-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-55-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-55-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-55-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-55-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-55-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-55-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-55-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-55-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-55-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-55-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-55-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-55-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-55-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-55-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-55-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-55-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-55-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-55-100">100</a></span>
<span class="normal"><a href="#__codelineno-55-101">101</a></span>
<span class="normal"><a href="#__codelineno-55-102">102</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a>linux$<span class="w"> </span>gcc<span class="w"> </span>-c<span class="w"> </span>fPIE<span class="w"> </span>a.c
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a>gcc:<span class="w"> </span>warning:<span class="w"> </span>fPIE:<span class="w"> </span>linker<span class="w"> </span>input<span class="w"> </span>file<span class="w"> </span>unused<span class="w"> </span>because<span class="w"> </span>linking<span class="w"> </span>not<span class="w"> </span><span class="k">done</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a>gcc:<span class="w"> </span>error:<span class="w"> </span>fPIE:<span class="w"> </span>linker<span class="w"> </span>input<span class="w"> </span>file<span class="w"> </span>not<span class="w"> </span>found:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a>linux$<span class="w"> </span>ls
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a>total<span class="w"> </span><span class="m">8</span>.0K
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>chaofu<span class="w"> </span>chaofu<span class="w"> </span><span class="m">1</span>.7K<span class="w"> </span>Nov<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">19</span>:26<span class="w"> </span>a.o
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>chaofu<span class="w"> </span>chaofu<span class="w">  </span><span class="m">122</span><span class="w"> </span>Nov<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">19</span>:26<span class="w"> </span>a.c
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a>linux$<span class="w"> </span>readelf<span class="w"> </span>-a<span class="w"> </span>a.o
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a>ELF<span class="w"> </span>Header:
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a>Magic:<span class="w">   </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a>Class:<span class="w">                             </span>ELF64
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a>Data:<span class="w">                              </span><span class="m">2</span><span class="s1">&#39;s complement, little endian</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="s1">Version:                           1 (current)</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="s1">OS/ABI:                            UNIX - System V</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15"></a><span class="s1">ABI Version:                       0</span>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16"></a><span class="s1">Type:                              REL (Relocatable file)</span>
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17"></a><span class="s1">Machine:                           Advanced Micro Devices X86-64</span>
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18"></a><span class="s1">Version:                           0x1</span>
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19"></a><span class="s1">Entry point address:               0x0</span>
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20"></a><span class="s1">Start of program headers:          0 (bytes into file)</span>
</span><span id="__span-55-21"><a id="__codelineno-55-21" name="__codelineno-55-21"></a><span class="s1">Start of section headers:          688 (bytes into file)</span>
</span><span id="__span-55-22"><a id="__codelineno-55-22" name="__codelineno-55-22"></a><span class="s1">Flags:                             0x0</span>
</span><span id="__span-55-23"><a id="__codelineno-55-23" name="__codelineno-55-23"></a><span class="s1">Size of this header:               64 (bytes)</span>
</span><span id="__span-55-24"><a id="__codelineno-55-24" name="__codelineno-55-24"></a><span class="s1">Size of program headers:           0 (bytes)</span>
</span><span id="__span-55-25"><a id="__codelineno-55-25" name="__codelineno-55-25"></a><span class="s1">Number of program headers:         0</span>
</span><span id="__span-55-26"><a id="__codelineno-55-26" name="__codelineno-55-26"></a><span class="s1">Size of section headers:           64 (bytes)</span>
</span><span id="__span-55-27"><a id="__codelineno-55-27" name="__codelineno-55-27"></a><span class="s1">Number of section headers:         15</span>
</span><span id="__span-55-28"><a id="__codelineno-55-28" name="__codelineno-55-28"></a><span class="s1">Section header string table index: 14</span>
</span><span id="__span-55-29"><a id="__codelineno-55-29" name="__codelineno-55-29"></a>
</span><span id="__span-55-30"><a id="__codelineno-55-30" name="__codelineno-55-30"></a><span class="s1">Section Headers:</span>
</span><span id="__span-55-31"><a id="__codelineno-55-31" name="__codelineno-55-31"></a><span class="s1">[Nr] Name              Type             Address           Offset</span>
</span><span id="__span-55-32"><a id="__codelineno-55-32" name="__codelineno-55-32"></a><span class="s1">    Size              EntSize          Flags  Link  Info  Align</span>
</span><span id="__span-55-33"><a id="__codelineno-55-33" name="__codelineno-55-33"></a><span class="s1">[ 0]                   NULL             0000000000000000  00000000</span>
</span><span id="__span-55-34"><a id="__codelineno-55-34" name="__codelineno-55-34"></a><span class="s1">    0000000000000000  0000000000000000           0     0     0</span>
</span><span id="__span-55-35"><a id="__codelineno-55-35" name="__codelineno-55-35"></a><span class="s1">[ 1] .text             PROGBITS         0000000000000000  00000040</span>
</span><span id="__span-55-36"><a id="__codelineno-55-36" name="__codelineno-55-36"></a><span class="s1">    0000000000000014  0000000000000000  AX       0     0     1</span>
</span><span id="__span-55-37"><a id="__codelineno-55-37" name="__codelineno-55-37"></a><span class="s1">[ 2] .rela.text        RELA             0000000000000000  00000200</span>
</span><span id="__span-55-38"><a id="__codelineno-55-38" name="__codelineno-55-38"></a><span class="s1">    0000000000000018  0000000000000018   I      12     1     8</span>
</span><span id="__span-55-39"><a id="__codelineno-55-39" name="__codelineno-55-39"></a><span class="s1">[ 3] .data             PROGBITS         0000000000000000  00000054</span>
</span><span id="__span-55-40"><a id="__codelineno-55-40" name="__codelineno-55-40"></a><span class="s1">    0000000000000000  0000000000000000  WA       0     0     1</span>
</span><span id="__span-55-41"><a id="__codelineno-55-41" name="__codelineno-55-41"></a><span class="s1">[ 4] .bss              NOBITS           0000000000000000  00000054</span>
</span><span id="__span-55-42"><a id="__codelineno-55-42" name="__codelineno-55-42"></a><span class="s1">    0000000000000004  0000000000000000  WA       0     0     4</span>
</span><span id="__span-55-43"><a id="__codelineno-55-43" name="__codelineno-55-43"></a><span class="s1">[ 5] .tbss             NOBITS           0000000000000000  00000054</span>
</span><span id="__span-55-44"><a id="__codelineno-55-44" name="__codelineno-55-44"></a><span class="s1">    0000000000000008  0000000000000000 WAT       0     0     4</span>
</span><span id="__span-55-45"><a id="__codelineno-55-45" name="__codelineno-55-45"></a><span class="s1">[ 6] .tdata            PROGBITS         0000000000000000  00000054</span>
</span><span id="__span-55-46"><a id="__codelineno-55-46" name="__codelineno-55-46"></a><span class="s1">    0000000000000004  0000000000000000 WAT       0     0     4</span>
</span><span id="__span-55-47"><a id="__codelineno-55-47" name="__codelineno-55-47"></a><span class="s1">[ 7] .comment          PROGBITS         0000000000000000  00000058</span>
</span><span id="__span-55-48"><a id="__codelineno-55-48" name="__codelineno-55-48"></a><span class="s1">    000000000000002c  0000000000000001  MS       0     0     1</span>
</span><span id="__span-55-49"><a id="__codelineno-55-49" name="__codelineno-55-49"></a><span class="s1">[ 8] .note.GNU-stack   PROGBITS         0000000000000000  00000084</span>
</span><span id="__span-55-50"><a id="__codelineno-55-50" name="__codelineno-55-50"></a><span class="s1">    0000000000000000  0000000000000000           0     0     1</span>
</span><span id="__span-55-51"><a id="__codelineno-55-51" name="__codelineno-55-51"></a><span class="s1">[ 9] .note.gnu.pr[...] NOTE             0000000000000000  00000088</span>
</span><span id="__span-55-52"><a id="__codelineno-55-52" name="__codelineno-55-52"></a><span class="s1">    0000000000000020  0000000000000000   A       0     0     8</span>
</span><span id="__span-55-53"><a id="__codelineno-55-53" name="__codelineno-55-53"></a><span class="s1">[10] .eh_frame         PROGBITS         0000000000000000  000000a8</span>
</span><span id="__span-55-54"><a id="__codelineno-55-54" name="__codelineno-55-54"></a><span class="s1">    0000000000000038  0000000000000000   A       0     0     8</span>
</span><span id="__span-55-55"><a id="__codelineno-55-55" name="__codelineno-55-55"></a><span class="s1">[11] .rela.eh_frame    RELA             0000000000000000  00000218</span>
</span><span id="__span-55-56"><a id="__codelineno-55-56" name="__codelineno-55-56"></a><span class="s1">    0000000000000018  0000000000000018   I      12    10     8</span>
</span><span id="__span-55-57"><a id="__codelineno-55-57" name="__codelineno-55-57"></a><span class="s1">[12] .symtab           SYMTAB           0000000000000000  000000e0</span>
</span><span id="__span-55-58"><a id="__codelineno-55-58" name="__codelineno-55-58"></a><span class="s1">    00000000000000f0  0000000000000018          13     4     8</span>
</span><span id="__span-55-59"><a id="__codelineno-55-59" name="__codelineno-55-59"></a><span class="s1">[13] .strtab           STRTAB           0000000000000000  000001d0</span>
</span><span id="__span-55-60"><a id="__codelineno-55-60" name="__codelineno-55-60"></a><span class="s1">    000000000000002a  0000000000000000           0     0     1</span>
</span><span id="__span-55-61"><a id="__codelineno-55-61" name="__codelineno-55-61"></a><span class="s1">[14] .shstrtab         STRTAB           0000000000000000  00000230</span>
</span><span id="__span-55-62"><a id="__codelineno-55-62" name="__codelineno-55-62"></a><span class="s1">    0000000000000079  0000000000000000           0     0     1</span>
</span><span id="__span-55-63"><a id="__codelineno-55-63" name="__codelineno-55-63"></a><span class="s1">Key to Flags:</span>
</span><span id="__span-55-64"><a id="__codelineno-55-64" name="__codelineno-55-64"></a><span class="s1">W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span>
</span><span id="__span-55-65"><a id="__codelineno-55-65" name="__codelineno-55-65"></a><span class="s1">L (link order), O (extra OS processing required), G (group), T (TLS),</span>
</span><span id="__span-55-66"><a id="__codelineno-55-66" name="__codelineno-55-66"></a><span class="s1">C (compressed), x (unknown), o (OS specific), E (exclude),</span>
</span><span id="__span-55-67"><a id="__codelineno-55-67" name="__codelineno-55-67"></a><span class="s1">D (mbind), l (large), p (processor specific)</span>
</span><span id="__span-55-68"><a id="__codelineno-55-68" name="__codelineno-55-68"></a>
</span><span id="__span-55-69"><a id="__codelineno-55-69" name="__codelineno-55-69"></a><span class="s1">There are no section groups in this file.</span>
</span><span id="__span-55-70"><a id="__codelineno-55-70" name="__codelineno-55-70"></a>
</span><span id="__span-55-71"><a id="__codelineno-55-71" name="__codelineno-55-71"></a><span class="s1">There are no program headers in this file.</span>
</span><span id="__span-55-72"><a id="__codelineno-55-72" name="__codelineno-55-72"></a>
</span><span id="__span-55-73"><a id="__codelineno-55-73" name="__codelineno-55-73"></a><span class="s1">There is no dynamic section in this file.</span>
</span><span id="__span-55-74"><a id="__codelineno-55-74" name="__codelineno-55-74"></a>
</span><span id="__span-55-75"><a id="__codelineno-55-75" name="__codelineno-55-75"></a><span class="s1">Relocation section &#39;</span>.rela.text<span class="s1">&#39; at offset 0x200 contains 1 entry:</span>
</span><span id="__span-55-76"><a id="__codelineno-55-76" name="__codelineno-55-76"></a><span class="s1">Offset          Info           Type           Sym. Value    Sym. Name + Addend</span>
</span><span id="__span-55-77"><a id="__codelineno-55-77" name="__codelineno-55-77"></a><span class="s1">00000000000b  000900000016 R_X86_64_GOTTPOFF 0000000000000000 z - 4</span>
</span><span id="__span-55-78"><a id="__codelineno-55-78" name="__codelineno-55-78"></a>
</span><span id="__span-55-79"><a id="__codelineno-55-79" name="__codelineno-55-79"></a><span class="s1">Relocation section &#39;</span>.rela.eh_frame<span class="s1">&#39; at offset 0x218 contains 1 entry:</span>
</span><span id="__span-55-80"><a id="__codelineno-55-80" name="__codelineno-55-80"></a><span class="s1">Offset          Info           Type           Sym. Value    Sym. Name + Addend</span>
</span><span id="__span-55-81"><a id="__codelineno-55-81" name="__codelineno-55-81"></a><span class="s1">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span>
</span><span id="__span-55-82"><a id="__codelineno-55-82" name="__codelineno-55-82"></a><span class="s1">No processor specific unwind information to decode</span>
</span><span id="__span-55-83"><a id="__codelineno-55-83" name="__codelineno-55-83"></a>
</span><span id="__span-55-84"><a id="__codelineno-55-84" name="__codelineno-55-84"></a><span class="s1">Symbol table &#39;</span>.symtab<span class="err">&#39;</span><span class="w"> </span>contains<span class="w"> </span><span class="m">10</span><span class="w"> </span>entries:
</span><span id="__span-55-85"><a id="__codelineno-55-85" name="__codelineno-55-85"></a>Num:<span class="w">    </span>Value<span class="w">          </span>Size<span class="w"> </span>Type<span class="w">    </span>Bind<span class="w">   </span>Vis<span class="w">      </span>Ndx<span class="w"> </span>Name
</span><span id="__span-55-86"><a id="__codelineno-55-86" name="__codelineno-55-86"></a><span class="w">    </span><span class="m">0</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">0</span><span class="w"> </span>NOTYPE<span class="w">  </span>LOCAL<span class="w">  </span>DEFAULT<span class="w">  </span>UND<span class="w"> </span>
</span><span id="__span-55-87"><a id="__codelineno-55-87" name="__codelineno-55-87"></a><span class="w">    </span><span class="m">1</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">0</span><span class="w"> </span>FILE<span class="w">    </span>LOCAL<span class="w">  </span>DEFAULT<span class="w">  </span>ABS<span class="w"> </span>a.c
</span><span id="__span-55-88"><a id="__codelineno-55-88" name="__codelineno-55-88"></a><span class="w">    </span><span class="m">2</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">0</span><span class="w"> </span>SECTION<span class="w"> </span>LOCAL<span class="w">  </span>DEFAULT<span class="w">    </span><span class="m">1</span><span class="w"> </span>.text
</span><span id="__span-55-89"><a id="__codelineno-55-89" name="__codelineno-55-89"></a><span class="w">    </span><span class="m">3</span>:<span class="w"> </span><span class="m">0000000000000004</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>TLS<span class="w">     </span>LOCAL<span class="w">  </span>DEFAULT<span class="w">    </span><span class="m">5</span><span class="w"> </span>y
</span><span id="__span-55-90"><a id="__codelineno-55-90" name="__codelineno-55-90"></a><span class="w">    </span><span class="m">4</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>OBJECT<span class="w">  </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">    </span><span class="m">4</span><span class="w"> </span>n
</span><span id="__span-55-91"><a id="__codelineno-55-91" name="__codelineno-55-91"></a><span class="w">    </span><span class="m">5</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>TLS<span class="w">     </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">    </span><span class="m">5</span><span class="w"> </span>x
</span><span id="__span-55-92"><a id="__codelineno-55-92" name="__codelineno-55-92"></a><span class="w">    </span><span class="m">6</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">4</span><span class="w"> </span>TLS<span class="w">     </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">    </span><span class="m">6</span><span class="w"> </span>x1
</span><span id="__span-55-93"><a id="__codelineno-55-93" name="__codelineno-55-93"></a><span class="w">    </span><span class="m">7</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">    </span><span class="m">20</span><span class="w"> </span>FUNC<span class="w">    </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">    </span><span class="m">1</span><span class="w"> </span>foo
</span><span id="__span-55-94"><a id="__codelineno-55-94" name="__codelineno-55-94"></a><span class="w">    </span><span class="m">8</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">0</span><span class="w"> </span>NOTYPE<span class="w">  </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">  </span>UND<span class="w"> </span>_GLOBAL_OFFSET_TABLE_
</span><span id="__span-55-95"><a id="__codelineno-55-95" name="__codelineno-55-95"></a><span class="w">    </span><span class="m">9</span>:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">     </span><span class="m">0</span><span class="w"> </span>TLS<span class="w">     </span>GLOBAL<span class="w"> </span>DEFAULT<span class="w">  </span>UND<span class="w"> </span>z
</span><span id="__span-55-96"><a id="__codelineno-55-96" name="__codelineno-55-96"></a>
</span><span id="__span-55-97"><a id="__codelineno-55-97" name="__codelineno-55-97"></a>No<span class="w"> </span>version<span class="w"> </span>information<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span>file.
</span><span id="__span-55-98"><a id="__codelineno-55-98" name="__codelineno-55-98"></a>
</span><span id="__span-55-99"><a id="__codelineno-55-99" name="__codelineno-55-99"></a>Displaying<span class="w"> </span>notes<span class="w"> </span>found<span class="w"> </span><span class="k">in</span>:<span class="w"> </span>.note.gnu.property
</span><span id="__span-55-100"><a id="__codelineno-55-100" name="__codelineno-55-100"></a>Owner<span class="w">                </span>Data<span class="w"> </span>size<span class="w">        </span>Description
</span><span id="__span-55-101"><a id="__codelineno-55-101" name="__codelineno-55-101"></a>GNU<span class="w">                  </span>0x00000010<span class="w">       </span>NT_GNU_PROPERTY_TYPE_0
</span><span id="__span-55-102"><a id="__codelineno-55-102" name="__codelineno-55-102"></a><span class="w">    </span>Properties:<span class="w"> </span>x86<span class="w"> </span>feature:<span class="w"> </span>IBT,<span class="w"> </span>SHSTK
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p>加载 ELF 文件</p>
<ul>
<li>将多段字节序列复制到地址空间中<ul>
<li>分别赋予可读/可写/可执行权限</li>
</ul>
</li>
<li>然后跳转到指定的 entry (默认为 _start) 执行</li>
<li>ELF 是 “二进制数据结构”，<code>readelf -l</code> 描述了如何加载它<ul>
<li>Offset: segment 在文件中的偏移量</li>
<li>VirtAddr: 段在内存中应当被加载到的起始地址</li>
<li>PhysAddr (一般不用)</li>
<li>FileSiz: 段在文件中的字节数</li>
<li>MemSiz: 段在内存中的字节数 (可能大于文件大小)</li>
<li>Flags: 权限，例如 RWE</li>
<li>Align: 虚拟地址的对齐</li>
</ul>
</li>
</ul>
<div class="language-bash highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span>
<span class="normal"><a href="#__codelineno-56-17">17</a></span>
<span class="normal"><a href="#__codelineno-56-18">18</a></span>
<span class="normal"><a href="#__codelineno-56-19">19</a></span>
<span class="normal"><a href="#__codelineno-56-20">20</a></span>
<span class="normal"><a href="#__codelineno-56-21">21</a></span>
<span class="normal"><a href="#__codelineno-56-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a>linux$<span class="w"> </span>./loader<span class="w"> </span>minimal<span class="w"> </span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a>Hello,<span class="w"> </span>OS<span class="w"> </span>World
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a>linux$<span class="w"> </span>./minimal<span class="w"> </span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a>Hello,<span class="w"> </span>OS<span class="w"> </span>World
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a>linux$<span class="w"> </span>readelf<span class="w"> </span>-l<span class="w"> </span>minimal<span class="w"> </span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a>Elf<span class="w"> </span>file<span class="w"> </span><span class="nb">type</span><span class="w"> </span>is<span class="w"> </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a>Entry<span class="w"> </span>point<span class="w"> </span>0x401000
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a>There<span class="w"> </span>are<span class="w"> </span><span class="m">2</span><span class="w"> </span>program<span class="w"> </span>headers,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span><span class="m">64</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a>Program<span class="w"> </span>Headers:
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a>Type<span class="w">           </span>Offset<span class="w">             </span>VirtAddr<span class="w">           </span>PhysAddr
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="w">                </span>FileSiz<span class="w">            </span>MemSiz<span class="w">              </span>Flags<span class="w">  </span>Align
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14"></a>LOAD<span class="w">           </span>0x0000000000000000<span class="w"> </span>0x0000000000400000<span class="w"> </span>0x0000000000400000
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15"></a><span class="w">                </span>0x00000000000000b0<span class="w"> </span>0x00000000000000b0<span class="w">  </span>R<span class="w">      </span>0x1000
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16"></a>LOAD<span class="w">           </span>0x0000000000001000<span class="w"> </span>0x0000000000401000<span class="w"> </span>0x0000000000401000
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17"></a><span class="w">                </span>0x0000000000000058<span class="w"> </span>0x0000000000000058<span class="w">  </span>R<span class="w"> </span>E<span class="w">    </span>0x1000
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18"></a>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19"></a>Section<span class="w"> </span>to<span class="w"> </span>Segment<span class="w"> </span>mapping:
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20"></a>Segment<span class="w"> </span>Sections...
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21"></a><span class="m">00</span><span class="w">     </span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22"></a><span class="m">01</span><span class="w">     </span>.text<span class="w"> </span>
</span></code></pre></div></td></tr></table></div>
<p><a id="minimal-loader"></a>
意思是，loader应当将minimal这个文件的offset为0的地方，大小为0xb0的一段区域搬到操作系统中虚拟内存的0x400000位置处；将offset为0x1000，大小为0x58的一段区域搬到操作系统中虚拟内存的0x401000位置处。然后准备好<a href="#system-v-abi">initial process stack</a>里的argc/argv/envp等，再跳转到Entry point 0x401000，即可开始执行minimal。</p>
<p>(静态 ELF 加载器: Linux 操作系统可以直接使用 execve 系统调用加载一个程序，实现状态机的 “重置”；同时，我们也可以自己动手模拟 execve 系统调用的行为：将 ELF 文件中需要加载的部分映射到内存，并根据 <a href="https://jyywiki.cn/OS/manuals/sysv-abi.pdf">ABI</a> 构建正确的进程初始栈和寄存器，我们就能实现二进制文件的 “加载”。)</p>
</li>
</ol>
<h2 id="lecture-20">Lecture 20 动态链接和加载<a class="headerlink" href="#lecture-20" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>Bugs (包括并发 bugs) 一直以来困扰着所有软件工程的实践者。我们不仅要应对 specification crisis (定义到底什么是对的)，甚至即便知道 specification，也难以应对现代软件的复杂性。为了部分应对这一点从而实现 “更正确” 的软件，我们把对程序的预期表达在程序中 (race-free, lock ordering, ...)，而不是让程序在自然状态下悄悄进入有问题的状态，就是我们目前解决程序调试问题的折中办法。“山寨” sanitizer 给我们带来的启发则是：如果我们能清楚地追溯到问题产生的本源，我们就总是能找到好的应对方法——山寨的 sanitizers 在暗中帮助你实现 fail-fast 的程序，从而减轻你调试问题的负担。</p>
</div>
<h2 id="lecture-21">Lecture 21 系统调用、中断和上下文切换<a class="headerlink" href="#lecture-21" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>Bugs (包括并发 bugs) 一直以来困扰着所有软件工程的实践者。我们不仅要应对 specification crisis (定义到底什么是对的)，甚至即便知道 specification，也难以应对现代软件的复杂性。为了部分应对这一点从而实现 “更正确” 的软件，我们把对程序的预期表达在程序中 (race-free, lock ordering, ...)，而不是让程序在自然状态下悄悄进入有问题的状态，就是我们目前解决程序调试问题的折中办法。“山寨” sanitizer 给我们带来的启发则是：如果我们能清楚地追溯到问题产生的本源，我们就总是能找到好的应对方法——山寨的 sanitizers 在暗中帮助你实现 fail-fast 的程序，从而减轻你调试问题的负担。</p>
</div>
<h2 id="lecture-22">Lecture 22 进程的实现<a class="headerlink" href="#lecture-22" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>Bugs (包括并发 bugs) 一直以来困扰着所有软件工程的实践者。我们不仅要应对 specification crisis (定义到底什么是对的)，甚至即便知道 specification，也难以应对现代软件的复杂性。为了部分应对这一点从而实现 “更正确” 的软件，我们把对程序的预期表达在程序中 (race-free, lock ordering, ...)，而不是让程序在自然状态下悄悄进入有问题的状态，就是我们目前解决程序调试问题的折中办法。“山寨” sanitizer 给我们带来的启发则是：如果我们能清楚地追溯到问题产生的本源，我们就总是能找到好的应对方法——山寨的 sanitizers 在暗中帮助你实现 fail-fast 的程序，从而减轻你调试问题的负担。</p>
</div>
<h2 id="lecture-23">Lecture 23 处理器调度<a class="headerlink" href="#lecture-23" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>Bugs (包括并发 bugs) 一直以来困扰着所有软件工程的实践者。我们不仅要应对 specification crisis (定义到底什么是对的)，甚至即便知道 specification，也难以应对现代软件的复杂性。为了部分应对这一点从而实现 “更正确” 的软件，我们把对程序的预期表达在程序中 (race-free, lock ordering, ...)，而不是让程序在自然状态下悄悄进入有问题的状态，就是我们目前解决程序调试问题的折中办法。“山寨” sanitizer 给我们带来的启发则是：如果我们能清楚地追溯到问题产生的本源，我们就总是能找到好的应对方法——山寨的 sanitizers 在暗中帮助你实现 fail-fast 的程序，从而减轻你调试问题的负担。</p>
</div>
<h2 id="lecture-24">Lecture 24 状态机模型的应用<a class="headerlink" href="#lecture-24" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Take-away Messages</p>
<p>Bugs (包括并发 bugs) 一直以来困扰着所有软件工程的实践者。我们不仅要应对 specification crisis (定义到底什么是对的)，甚至即便知道 specification，也难以应对现代软件的复杂性。为了部分应对这一点从而实现 “更正确” 的软件，我们把对程序的预期表达在程序中 (race-free, lock ordering, ...)，而不是让程序在自然状态下悄悄进入有问题的状态，就是我们目前解决程序调试问题的折中办法。“山寨” sanitizer 给我们带来的启发则是：如果我们能清楚地追溯到问题产生的本源，我们就总是能找到好的应对方法——山寨的 sanitizers 在暗中帮助你实现 fail-fast 的程序，从而减轻你调试问题的负担。</p>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2024年11月8日 20:40:57</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2024年11月8日 20:40:57</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; lingyu CC-BY-4.0
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.af256bd8.min.js"></script>
      
        <script src="../../mkdocs/javascripts/katex.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>