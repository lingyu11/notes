<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../SJTU_OS/ rel=prev><link href=../../DS_Algo/CS61B/CS61B/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>MIT6.S081 - lingyu's notes</title><link rel=stylesheet href=../../assets/stylesheets/main.6f8fc17f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css><link rel=stylesheet href=../../mkdocs/css/no-footer.css><link rel=stylesheet href=../../mkdocs/css/unordered-list-symbols.css><link rel=stylesheet href=../../css/table.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#mit6s081 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../.. title="lingyu's notes" class="md-header__button md-logo" aria-label="lingyu's notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> lingyu's notes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> MIT6.S081 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lingyu11/notes/tree/master title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lingyu11/notes </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/01.%E5%88%9D%E8%AF%86Python/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/C/C/ class=md-tabs__link> C </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Cpp_primer/ class=md-tabs__link> C++ </a> </li> <li class=md-tabs__item> <a href=../../ICS/ICS_Lectures/ class=md-tabs__link> ICS </a> </li> <li class=md-tabs__item> <a href=../../%E8%AE%A1%E7%BB%84/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%28%E4%B8%8A%29/ class=md-tabs__link> 计组 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../%E7%BB%AA%E8%AE%BA/ class=md-tabs__link> OS </a> </li> <li class=md-tabs__item> <a href=../../DS_Algo/CS61B/CS61B/ class=md-tabs__link> 数据结构 </a> </li> <li class=md-tabs__item> <a href=../../DS_Algo/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%8F%8C%E6%8C%87%E9%92%88/ class=md-tabs__link> 算法 </a> </li> <li class=md-tabs__item> <a href=../../CSAPP/CH1/ class=md-tabs__link> CSAPP </a> </li> <li class=md-tabs__item> <a href=../../Linux/Linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../network.md class=md-tabs__link> 计算机网络 </a> </li> <li class=md-tabs__item> <a href=../../database.md class=md-tabs__link> 数据库 </a> </li> <li class=md-tabs__item> <a href=../../Tool/tool/ class=md-tabs__link> Tool </a> </li> <li class=md-tabs__item> <a href=../../Misc/Memo/ class=md-tabs__link> Misc </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="lingyu's notes" class="md-nav__button md-logo" aria-label="lingyu's notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg> </a> lingyu's notes </label> <div class=md-nav__source> <a href=https://github.com/lingyu11/notes/tree/master title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lingyu11/notes </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> PythonBasic </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> PythonBasic </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/01.%E5%88%9D%E8%AF%86Python/ class=md-nav__link> <span class=md-ellipsis> 01.初识Python </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/02.%E8%AF%AD%E8%A8%80%E5%85%83%E7%B4%A0/ class=md-nav__link> <span class=md-ellipsis> 02.语言元素 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/03.%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 03.分支结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/04.%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 04.循环结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/05.%E6%9E%84%E9%80%A0%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91/ class=md-nav__link> <span class=md-ellipsis> 05.构造程序逻辑 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/06.%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 06.函数和模块的使用 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/07.%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 07.字符串和常用数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/08.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> 08.面向对象编程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/09.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 09.面向对象进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/10.%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E5%92%8C%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 10.图形用户界面和游戏开发 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/11.%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/ class=md-nav__link> <span class=md-ellipsis> 11.文件和异常 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/12.%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 12.字符串和正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/13.%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 13.进程和线程 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/14.%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 14.网络编程入门和网络应用开发 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/15.%E5%9B%BE%E5%83%8F%E5%92%8C%E5%8A%9E%E5%85%AC%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 15.图像和办公文档处理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Python进阶 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Python进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/Python%E8%BF%9B%E9%98%B6/16.Python%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 16.Python语言进阶 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> DataAnalysis </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> DataAnalysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/66.%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A6%82%E8%BF%B0/ class=md-nav__link> <span class=md-ellipsis> 66.数据分析概述 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/67.%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/ class=md-nav__link> <span class=md-ellipsis> 67.环境准备 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/68.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-1/ class=md-nav__link> <span class=md-ellipsis> 68.NumPy的应用 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/69.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-2/ class=md-nav__link> <span class=md-ellipsis> 69.NumPy的应用 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/70.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-3/ class=md-nav__link> <span class=md-ellipsis> 70.NumPy的应用 3 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/71.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-4/ class=md-nav__link> <span class=md-ellipsis> 71.NumPy的应用 4 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/72.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-1/ class=md-nav__link> <span class=md-ellipsis> 72.深入浅出pandas 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/73.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-2/ class=md-nav__link> <span class=md-ellipsis> 73.深入浅出pandas 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/74.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-3/ class=md-nav__link> <span class=md-ellipsis> 74.深入浅出pandas 3 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/75.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-4/ class=md-nav__link> <span class=md-ellipsis> 75.深入浅出pandas 4 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/76.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-5/ class=md-nav__link> <span class=md-ellipsis> 76.深入浅出pandas 5 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/77.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-6/ class=md-nav__link> <span class=md-ellipsis> 77.深入浅出pandas 6 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/78.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-1/ class=md-nav__link> <span class=md-ellipsis> 78.数据可视化 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/79.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-2/ class=md-nav__link> <span class=md-ellipsis> 79.数据可视化 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/80.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-3/ class=md-nav__link> <span class=md-ellipsis> 80.数据可视化 3 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonCookBook/ class=md-nav__link> <span class=md-ellipsis> Python Cook Book </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonforDataAnalysis3E/ class=md-nav__link> <span class=md-ellipsis> Python for Data Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonMisc/ class=md-nav__link> <span class=md-ellipsis> Python Misc </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/C/C/ class=md-nav__link> <span class=md-ellipsis> C </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> C++ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> C++ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Cpp_primer/ class=md-nav__link> <span class=md-ellipsis> C++ primer 5th edition </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Essential_Cpp/ class=md-nav__link> <span class=md-ellipsis> Essential C++ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> ICS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> ICS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ICS/ICS_Lectures/ class=md-nav__link> <span class=md-ellipsis> Lectures </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/ICS_Lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%A1%A8%E7%A4%BA%E8%BD%AC%E6%8D%A2%E4%B8%8E%E9%93%BE%E6%8E%A5/ class=md-nav__link> <span class=md-ellipsis> 程序的表示、转换与链接 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%A7%E8%A1%8C%E5%92%8C%E5%AD%98%E5%82%A8%E8%AE%BF%E9%97%AE/ class=md-nav__link> <span class=md-ellipsis> 程序的执行和存储访问 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E5%BC%82%E5%B8%B8%E3%80%81%E4%B8%AD%E6%96%AD%E5%92%8C%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/ class=md-nav__link> <span class=md-ellipsis> 异常、中断和输入/输出 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%BC%96%E7%A8%8B%E4%B8%8E%E8%B0%83%E8%AF%95%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> 编程与调试实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> 计组 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 计组 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AE%A1%E7%BB%84/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%28%E4%B8%8A%29/ class=md-nav__link> <span class=md-ellipsis> 计算机组成原理(上) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> OS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> OS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../%E7%BB%AA%E8%AE%BA/ class=md-nav__link> <span class=md-ellipsis> 绪论 </span> </a> </li> <li class=md-nav__item> <a href=../%E5%B9%B6%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 并发 </span> </a> </li> <li class=md-nav__item> <a href=../%E8%99%9A%E6%8B%9F%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 虚拟化 </span> </a> </li> <li class=md-nav__item> <a href=../%E6%8C%81%E4%B9%85%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 持久化 </span> </a> </li> <li class=md-nav__item> <a href=../%E6%80%BB%E7%BB%93/ class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> <li class=md-nav__item> <a href=../Lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../OSTEP/ class=md-nav__link> <span class=md-ellipsis> OSTEP </span> </a> </li> <li class=md-nav__item> <a href=../CodingForSSD/ class=md-nav__link> <span class=md-ellipsis> Coding for SSD </span> </a> </li> <li class=md-nav__item> <a href=../SJTU_OS/ class=md-nav__link> <span class=md-ellipsis> SJTU OS </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> MIT6.S081 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> MIT6.S081 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 资料 </span> </a> </li> <li class=md-nav__item> <a href=#lect0 class=md-nav__link> <span class=md-ellipsis> Lect0 操作系统接口 </span> </a> </li> <li class=md-nav__item> <a href=#lab1-xv6-and-unix-utilities class=md-nav__link> <span class=md-ellipsis> Lab1: Xv6 and Unix utilities </span> </a> </li> <li class=md-nav__item> <a href=#lab2-system-calls class=md-nav__link> <span class=md-ellipsis> Lab2: System calls </span> </a> </li> <li class=md-nav__item> <a href=#lab3-page-tables class=md-nav__link> <span class=md-ellipsis> Lab3: Page tables </span> </a> </li> <li class=md-nav__item> <a href=#lect6-isolation-system-call-entryexit class=md-nav__link> <span class=md-ellipsis> Lect6 Isolation &amp; system call entry/exit </span> </a> </li> <li class=md-nav__item> <a href=#lab4-traps class=md-nav__link> <span class=md-ellipsis> Lab4: Traps </span> </a> </li> <li class=md-nav__item> <a href=#lab5-xv6-lazy-page-allocation class=md-nav__link> <span class=md-ellipsis> Lab5: xv6 lazy page allocation </span> </a> </li> <li class=md-nav__item> <a href=#lab6-copy-on-write-fork-for-xv6 class=md-nav__link> <span class=md-ellipsis> Lab6: Copy-on-Write Fork for xv6 </span> </a> </li> <li class=md-nav__item> <a href=#lab7-multithreading class=md-nav__link> <span class=md-ellipsis> Lab7: Multithreading </span> </a> </li> <li class=md-nav__item> <a href=#lab8-locks class=md-nav__link> <span class=md-ellipsis> Lab8: Locks </span> </a> </li> <li class=md-nav__item> <a href=#lab9-file-system class=md-nav__link> <span class=md-ellipsis> Lab9: file system </span> </a> </li> <li class=md-nav__item> <a href=#lab10-mmap class=md-nav__link> <span class=md-ellipsis> Lab10: mmap </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> 数据结构 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> 数据结构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DS_Algo/CS61B/CS61B/ class=md-nav__link> <span class=md-ellipsis> CS61B 绪论 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> 算法 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> 算法 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DS_Algo/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%8F%8C%E6%8C%87%E9%92%88/ class=md-nav__link> <span class=md-ellipsis> 滑动窗口与双指针 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E4%BA%8C%E5%88%86%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 二分算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%8D%95%E8%B0%83%E6%A0%88/ class=md-nav__link> <span class=md-ellipsis> 单调栈 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E7%BD%91%E6%A0%BC%E5%9B%BE/ class=md-nav__link> <span class=md-ellipsis> 网格图 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E4%BD%8D%E8%BF%90%E7%AE%97/ class=md-nav__link> <span class=md-ellipsis> 位运算 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%9B%BE%E8%AE%BA%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 图论算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/ class=md-nav__link> <span class=md-ellipsis> 动态规划 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 常用数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E6%95%B0%E5%AD%A6%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 数学算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E8%B4%AA%E5%BF%83%E4%B8%8E%E6%80%9D%E7%BB%B4/ class=md-nav__link> <span class=md-ellipsis> 贪心与思维 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E9%93%BE%E8%A1%A8_%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%8E%E5%9B%9E%E6%BA%AF/ class=md-nav__link> <span class=md-ellipsis> 链表 二叉树与回溯 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> <span class=md-ellipsis> 字符串 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/HOT100/ class=md-nav__link> <span class=md-ellipsis> HOT 100 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/HOT150/ class=md-nav__link> <span class=md-ellipsis> HOT 150 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> CSAPP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> CSAPP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CSAPP/CH1/ class=md-nav__link> <span class=md-ellipsis> 绪论 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/%E5%86%85%E5%AD%98/ class=md-nav__link> <span class=md-ellipsis> 内存 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_11> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=false> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Linux/Linux/ class=md-nav__link> <span class=md-ellipsis> 基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../Linux/useful_cmd/ class=md-nav__link> <span class=md-ellipsis> Useful cmd </span> </a> </li> <li class=md-nav__item> <a href=../../Linux/%E7%8E%A9%E8%BD%ACLinux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 玩转Linux操作系统 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../network.md class=md-nav__link> <span class=md-ellipsis> 计算机网络 </span> </a> </li> <li class=md-nav__item> <a href=../../database.md class=md-nav__link> <span class=md-ellipsis> 数据库 </span> </a> </li> <li class=md-nav__item> <a href=../../Tool/tool/ class=md-nav__link> <span class=md-ellipsis> Tool </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_15> <label class=md-nav__link for=__nav_15 id=__nav_15_label tabindex=0> <span class=md-ellipsis> Misc </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_15_label aria-expanded=false> <label class=md-nav__title for=__nav_15> <span class="md-nav__icon md-icon"></span> Misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Misc/Memo/ class=md-nav__link> <span class=md-ellipsis> Memo </span> </a> </li> <li class=md-nav__item> <a href=../../Misc/Todo/ class=md-nav__link> <span class=md-ellipsis> Todo </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 资料 </span> </a> </li> <li class=md-nav__item> <a href=#lect0 class=md-nav__link> <span class=md-ellipsis> Lect0 操作系统接口 </span> </a> </li> <li class=md-nav__item> <a href=#lab1-xv6-and-unix-utilities class=md-nav__link> <span class=md-ellipsis> Lab1: Xv6 and Unix utilities </span> </a> </li> <li class=md-nav__item> <a href=#lab2-system-calls class=md-nav__link> <span class=md-ellipsis> Lab2: System calls </span> </a> </li> <li class=md-nav__item> <a href=#lab3-page-tables class=md-nav__link> <span class=md-ellipsis> Lab3: Page tables </span> </a> </li> <li class=md-nav__item> <a href=#lect6-isolation-system-call-entryexit class=md-nav__link> <span class=md-ellipsis> Lect6 Isolation &amp; system call entry/exit </span> </a> </li> <li class=md-nav__item> <a href=#lab4-traps class=md-nav__link> <span class=md-ellipsis> Lab4: Traps </span> </a> </li> <li class=md-nav__item> <a href=#lab5-xv6-lazy-page-allocation class=md-nav__link> <span class=md-ellipsis> Lab5: xv6 lazy page allocation </span> </a> </li> <li class=md-nav__item> <a href=#lab6-copy-on-write-fork-for-xv6 class=md-nav__link> <span class=md-ellipsis> Lab6: Copy-on-Write Fork for xv6 </span> </a> </li> <li class=md-nav__item> <a href=#lab7-multithreading class=md-nav__link> <span class=md-ellipsis> Lab7: Multithreading </span> </a> </li> <li class=md-nav__item> <a href=#lab8-locks class=md-nav__link> <span class=md-ellipsis> Lab8: Locks </span> </a> </li> <li class=md-nav__item> <a href=#lab9-file-system class=md-nav__link> <span class=md-ellipsis> Lab9: file system </span> </a> </li> <li class=md-nav__item> <a href=#lab10-mmap class=md-nav__link> <span class=md-ellipsis> Lab10: mmap </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <div><h1 id=mit6s081>MIT6.S081<a class=headerlink href=#mit6s081 title="Permanent link">¶</a></h1> <h2 id=_1>资料<a class=headerlink href=#_1 title="Permanent link">¶</a></h2> <ul> <li><a href=https://pdos.csail.mit.edu/6.828/2020/schedule.html>课程网站</a></li> <li><a href="https://www.bilibili.com/video/BV19k4y1C7kA/?spm_id_from=333.337.search-card.all.click&vd_source=2a33d03ec3e67e46971208a7faa0dcda">课程视频</a>，<a href=https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081>视频中文文字版(推荐👍)</a></li> <li><a href=https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf>英文教材</a>, <a href=https://th0ar.gitbooks.io/xv6-chinese/content/index.html>中文翻译教材(网页)</a>, <a href=https://blog.betteryuan.top/archives/xv6-riscv-book-zh-cn>中文翻译教材(pdf，翻译较差)</a></li> <li><a href=https://pdos.csail.mit.edu/6.828/2020/schedule.html>课程作业</a></li> <li><a href=https://th0ar.gitbooks.io/xv6-chinese/content/index.html>xv6中文文档</a></li> <li>Lab 参考：<ul> <li><a href=https://www.notion.so/XV6-labs-2021-0894f931b3324edea30dca7826c01a97>XV6-labs-2021操作系统</a>，<a href="https://www.bilibili.com/video/BV1ou41127p9?vd_source=2a33d03ec3e67e46971208a7faa0dcda&spm_id_from=333.788.videopod.sections">b站视频</a></li> <li><a href=https://xv6.dgs.zone/ >MIT6.S081-All-in-one</a>: 值得推荐的课本翻译及lab翻译👍</li> <li><a href=https://github.com/PKUFlyingPig/MIT6.S081-2020fall/blob/master/reports/Utils.md>代码实现参考</a></li> </ul> </li> </ul> <h2 id=lect0>Lect0 操作系统接口<a class=headerlink href=#lect0 title="Permanent link">¶</a></h2> <ol> <li> <p>使用 wsl 来完成：</p> <ul> <li>安装这些 <a href=https://pdos.csail.mit.edu/6.828/2020/tools.html>Tools Used in 6.S081</a></li> <li>在直接clone下来的代码下编译 <code>make qemu</code> 报错 <code>user/sh.c: In function 'runcmd': user/sh.c:58:1: error: infinite recursion detected [-Werror=infinite-recursion]</code>，解决：加上<code>__attribute__((noreturn))</code>: <code>__attribute__((noreturn)) void runcmd(struct cmd *cmd)</code></li> <li> <p>安装 riscv64-unknown-elf-gdb:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span>
<span class=normal><a href=#__codelineno-0-2>2</a></span>
<span class=normal><a href=#__codelineno-0-3>3</a></span>
<span class=normal><a href=#__codelineno-0-4>4</a></span>
<span class=normal><a href=#__codelineno-0-5>5</a></span>
<span class=normal><a href=#__codelineno-0-6>6</a></span>
<span class=normal><a href=#__codelineno-0-7>7</a></span>
<span class=normal><a href=#__codelineno-0-8>8</a></span>
<span class=normal><a href=#__codelineno-0-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><span class=c1># 下载预编译包（以v2020.12版本为例）</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a>wget<span class=w> </span>https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><span class=c1># 解压并安装</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4></a>tar<span class=w> </span>-xzvf<span class=w> </span>riscv64-unknown-elf-toolchain-*.tar.gz
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5></a>mv<span class=w> </span>riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14<span class=w> </span>riscv64-unknown-elf-toolchain
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6></a>sudo<span class=w> </span>mv<span class=w> </span>riscv64-unknown-elf-toolchain<span class=w> </span>/opt/
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7></a><span class=c1># 添加环境变量（以.bashrc为例）</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8></a><span class=nb>echo</span><span class=w> </span><span class=s1>'export PATH="/opt/riscv64-unknown-elf-toolchain/bin:$PATH"'</span><span class=w> </span>&gt;&gt;<span class=w> </span>~/.bashrc
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9></a><span class=nb>source</span><span class=w> </span>~/.bashrc
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Follow <a href=https://www.notion.so/Lab0-Environment-Setup-5a1084d3b695416c8740977b9f1ba77e>GDB调试最佳实践步骤</a> 或 <a href="https://www.bilibili.com/video/BV1ou41127p9/?vd_source=2a33d03ec3e67e46971208a7faa0dcda">video</a></p> </li> </ul> </li> <li> <p>一个新分配的文件描述符永远都是当前进程的最小的未被使用的文件描述符。</p> </li> <li> <p>管道 p[0]是读端，p[1]是写端。read 系统调用在从管道读取数据时，若管道为空，会有不同的行为表现，这取决于管道的状态：</p> <ul> <li>管道有写端打开：若管道至少有一个写端是打开状态，并且当前管道为空，read 调用会阻塞，也就是暂停当前进程的执行，直到有数据被写入管道或者写端都关闭。</li> <li>管道所有写端关闭：若管道的所有写端都已关闭，并且管道为空，read 调用会返回 0，表示已经到达文件末尾（EOF）。</li> </ul> </li> <li> <p>为何 fork 和 exec 是单独的两种系统调用 ➡️ 这种区分使得 shell 可以在子进程执行指定程序之前对子进程进行修改，例如重定向，在 fork 之后 exec 之前打开或关闭一些文件描述符。</p> </li> <li> <p>xv6 syscall: If not otherwise stated, these calls return 0 for no error, and -1 if there’s an error.</p> <table> <thead> <tr> <th>System call</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>int fork()</code></td> <td>Create a process, return child’s PID.</td> </tr> <tr> <td><code>int exit(int status)</code></td> <td>Terminate the current process; status reported to wait(). No return.</td> </tr> <tr> <td><code>int wait(int *status)</code></td> <td>Wait for a child to exit; exit status in *status; returns child PID.</td> </tr> <tr> <td><code>int kill(int pid)</code></td> <td>Terminate process PID. Returns 0, or -1 for error.</td> </tr> <tr> <td><code>int getpid()</code></td> <td>Return the current process’s PID.</td> </tr> <tr> <td><code>int sleep(int n)</code></td> <td>Pause for n clock ticks.</td> </tr> <tr> <td><code>int exec(char *file, char *argv[])</code></td> <td>Load a file and execute it with arguments; only returns if error.</td> </tr> <tr> <td><code>char *sbrk(int n)</code></td> <td>Grow process’s memory by n bytes. Returns start of new memory.</td> </tr> <tr> <td><code>int open(char *file, int flags)</code></td> <td>Open a file; flags indicate read/write; returns an fd (file descriptor).</td> </tr> <tr> <td><code>int write(int fd, char *buf, int n)</code></td> <td>Write n bytes from buf to file descriptor fd; returns n.</td> </tr> <tr> <td><code>int read(int fd, char *buf, int n)</code></td> <td>Read n bytes into buf; returns number read; or 0 if end of file.</td> </tr> <tr> <td><code>int close(int fd)</code></td> <td>Release open file fd.</td> </tr> <tr> <td><code>int dup(int fd)</code></td> <td>Return a new file descriptor referring to the same file as fd.</td> </tr> <tr> <td><code>int pipe(int p[])</code></td> <td>Create a pipe, put read/write file descriptors in p[0] and p[1].</td> </tr> <tr> <td><code>int chdir(char *dir)</code></td> <td>Change the current directory.</td> </tr> <tr> <td><code>int mkdir(char *dir)</code></td> <td>Create a new directory.</td> </tr> <tr> <td><code>int mknod(char *file, int, int)</code></td> <td>Create a device file, param: major and minor device numbers.</td> </tr> <tr> <td><code>int fstat(int fd, struct stat *st)</code></td> <td>Place info about an open file into *st.</td> </tr> <tr> <td><code>int stat(char *file, struct stat *st)</code></td> <td>Place info about a named file into *st.</td> </tr> <tr> <td><code>int link(char *file1, char *file2)</code></td> <td>Create another name (file2) for the file file1.</td> </tr> <tr> <td><code>int unlink(char *file)</code></td> <td>Remove a file.</td> </tr> </tbody> </table> </li> <li> <p>创建一个临时 inode 的最佳方式，这个 inode 会在进程关闭 fd 或者退出的时候被清空:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span>
<span class=normal><a href=#__codelineno-1-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=s>"/tmp/xyz"</span><span class=p>,</span><span class=w> </span><span class=n>O_CREATE</span><span class=o>|</span><span class=n>O_RDWR</span><span class=p>);</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><span class=n>unlink</span><span class=p>(</span><span class=s>"/tmp/xyz"</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>这两行代码会创建并打开一个文件，接着删除该文件在文件系统中的目录项。不过，由于文件已经被打开，文件所占用的磁盘空间不会立刻释放，只要程序仍然持有有效的文件描述符 fd，就可以继续对该文件进行读写操作。当程序关闭这个文件描述符（通过 close(fd)），或者程序终止时，系统才会真正释放文件占用的磁盘空间。这种技术常用于创建临时文件，程序结束后文件会自动消失，不会在文件系统中留下痕迹。</p> </li> </ol> <h2 id=lab1-xv6-and-unix-utilities>Lab1: Xv6 and Unix utilities<a class=headerlink href=#lab1-xv6-and-unix-utilities title="Permanent link">¶</a></h2> <ol> <li> <p>sleep:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1> 1</a></span>
<span class=normal><a href=#__codelineno-2-2> 2</a></span>
<span class=normal><a href=#__codelineno-2-3> 3</a></span>
<span class=normal><a href=#__codelineno-2-4> 4</a></span>
<span class=normal><a href=#__codelineno-2-5> 5</a></span>
<span class=normal><a href=#__codelineno-2-6> 6</a></span>
<span class=normal><a href=#__codelineno-2-7> 7</a></span>
<span class=normal><a href=#__codelineno-2-8> 8</a></span>
<span class=normal><a href=#__codelineno-2-9> 9</a></span>
<span class=normal><a href=#__codelineno-2-10>10</a></span>
<span class=normal><a href=#__codelineno-2-11>11</a></span>
<span class=normal><a href=#__codelineno-2-12>12</a></span>
<span class=normal><a href=#__codelineno-2-13>13</a></span>
<span class=normal><a href=#__codelineno-2-14>14</a></span>
<span class=normal><a href=#__codelineno-2-15>15</a></span>
<span class=normal><a href=#__codelineno-2-16>16</a></span>
<span class=normal><a href=#__codelineno-2-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a><span class=kt>int</span><span class=w> </span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7></a><span class=p>{</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"Usage: sleep seconds</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14></a><span class=w>    </span><span class=n>sleep</span><span class=p>(</span><span class=n>time</span><span class=p>);</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15></a>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>pingpong:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1> 1</a></span>
<span class=normal><a href=#__codelineno-3-2> 2</a></span>
<span class=normal><a href=#__codelineno-3-3> 3</a></span>
<span class=normal><a href=#__codelineno-3-4> 4</a></span>
<span class=normal><a href=#__codelineno-3-5> 5</a></span>
<span class=normal><a href=#__codelineno-3-6> 6</a></span>
<span class=normal><a href=#__codelineno-3-7> 7</a></span>
<span class=normal><a href=#__codelineno-3-8> 8</a></span>
<span class=normal><a href=#__codelineno-3-9> 9</a></span>
<span class=normal><a href=#__codelineno-3-10>10</a></span>
<span class=normal><a href=#__codelineno-3-11>11</a></span>
<span class=normal><a href=#__codelineno-3-12>12</a></span>
<span class=normal><a href=#__codelineno-3-13>13</a></span>
<span class=normal><a href=#__codelineno-3-14>14</a></span>
<span class=normal><a href=#__codelineno-3-15>15</a></span>
<span class=normal><a href=#__codelineno-3-16>16</a></span>
<span class=normal><a href=#__codelineno-3-17>17</a></span>
<span class=normal><a href=#__codelineno-3-18>18</a></span>
<span class=normal><a href=#__codelineno-3-19>19</a></span>
<span class=normal><a href=#__codelineno-3-20>20</a></span>
<span class=normal><a href=#__codelineno-3-21>21</a></span>
<span class=normal><a href=#__codelineno-3-22>22</a></span>
<span class=normal><a href=#__codelineno-3-23>23</a></span>
<span class=normal><a href=#__codelineno-3-24>24</a></span>
<span class=normal><a href=#__codelineno-3-25>25</a></span>
<span class=normal><a href=#__codelineno-3-26>26</a></span>
<span class=normal><a href=#__codelineno-3-27>27</a></span>
<span class=normal><a href=#__codelineno-3-28>28</a></span>
<span class=normal><a href=#__codelineno-3-29>29</a></span>
<span class=normal><a href=#__codelineno-3-30>30</a></span>
<span class=normal><a href=#__codelineno-3-31>31</a></span>
<span class=normal><a href=#__codelineno-3-32>32</a></span>
<span class=normal><a href=#__codelineno-3-33>33</a></span>
<span class=normal><a href=#__codelineno-3-34>34</a></span>
<span class=normal><a href=#__codelineno-3-35>35</a></span>
<span class=normal><a href=#__codelineno-3-36>36</a></span>
<span class=normal><a href=#__codelineno-3-37>37</a></span>
<span class=normal><a href=#__codelineno-3-38>38</a></span>
<span class=normal><a href=#__codelineno-3-39>39</a></span>
<span class=normal><a href=#__codelineno-3-40>40</a></span>
<span class=normal><a href=#__codelineno-3-41>41</a></span>
<span class=normal><a href=#__codelineno-3-42>42</a></span>
<span class=normal><a href=#__codelineno-3-43>43</a></span>
<span class=normal><a href=#__codelineno-3-44>44</a></span>
<span class=normal><a href=#__codelineno-3-45>45</a></span>
<span class=normal><a href=#__codelineno-3-46>46</a></span>
<span class=normal><a href=#__codelineno-3-47>47</a></span>
<span class=normal><a href=#__codelineno-3-48>48</a></span>
<span class=normal><a href=#__codelineno-3-49>49</a></span>
<span class=normal><a href=#__codelineno-3-50>50</a></span>
<span class=normal><a href=#__codelineno-3-51>51</a></span>
<span class=normal><a href=#__codelineno-3-52>52</a></span>
<span class=normal><a href=#__codelineno-3-53>53</a></span>
<span class=normal><a href=#__codelineno-3-54>54</a></span>
<span class=normal><a href=#__codelineno-3-55>55</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6></a><span class=p>{</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9></a><span class=w>    </span><span class=n>pipe</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10></a>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fork</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>// child (receive -&gt; send)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13></a><span class=w>        </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getpid</span><span class=p>();</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15></a><span class=w>        </span><span class=c1>// 若管道为空，read 调用会阻塞，也就是暂停当前进程的执行，</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16></a><span class=w>        </span><span class=c1>// 直到有数据被写入管道或者写端都关闭。</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"failed to read in child</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d: received ping</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"failed to write in child</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33></a><span class=w>    </span><span class=p>{</span><span class=w>   </span><span class=c1>// parent (send -&gt; receive)</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34></a><span class=w>        </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getpid</span><span class=p>();</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>info</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"a"</span><span class=p>;</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37></a><span class=w>        </span><span class=n>buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"failed to write in parent</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43></a><span class=w>        </span><span class=c1>// wait for child to receive ping</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45></a><span class=w>        </span><span class=n>wait</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"failed to read in parent</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d: received pong</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>primes:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span>
<span class=normal><a href=#__codelineno-4-2>2</a></span>
<span class=normal><a href=#__codelineno-4-3>3</a></span>
<span class=normal><a href=#__codelineno-4-4>4</a></span>
<span class=normal><a href=#__codelineno-4-5>5</a></span>
<span class=normal><a href=#__codelineno-4-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=n>from</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=n>neighbor</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><span class=n>print</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><span class=nl>loop</span><span class=p>:</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><span class=w>    </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=n>from</span><span class=w> </span><span class=n>left</span><span class=w> </span><span class=n>neighbor</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=n>does</span><span class=w> </span><span class=n>not</span><span class=w> </span><span class=n>divide</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=c1>// n不能被p整除</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><span class=w>        </span><span class=n>send</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=n>neighbor</span>
</span></code></pre></div></td></tr></table></div> <p><img alt="alt text" src=../../img/image-64.png></p> <blockquote> <p>生成进程可以将数字2、3、4、…、35输入管道的左端：行中的第一个进程消除2的倍数，第二个进程消除3的倍数，第三个进程消除5的倍数，依此类推。</p> </blockquote> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1> 1</a></span>
<span class=normal><a href=#__codelineno-5-2> 2</a></span>
<span class=normal><a href=#__codelineno-5-3> 3</a></span>
<span class=normal><a href=#__codelineno-5-4> 4</a></span>
<span class=normal><a href=#__codelineno-5-5> 5</a></span>
<span class=normal><a href=#__codelineno-5-6> 6</a></span>
<span class=normal><a href=#__codelineno-5-7> 7</a></span>
<span class=normal><a href=#__codelineno-5-8> 8</a></span>
<span class=normal><a href=#__codelineno-5-9> 9</a></span>
<span class=normal><a href=#__codelineno-5-10>10</a></span>
<span class=normal><a href=#__codelineno-5-11>11</a></span>
<span class=normal><a href=#__codelineno-5-12>12</a></span>
<span class=normal><a href=#__codelineno-5-13>13</a></span>
<span class=normal><a href=#__codelineno-5-14>14</a></span>
<span class=normal><a href=#__codelineno-5-15>15</a></span>
<span class=normal><a href=#__codelineno-5-16>16</a></span>
<span class=normal><a href=#__codelineno-5-17>17</a></span>
<span class=normal><a href=#__codelineno-5-18>18</a></span>
<span class=normal><a href=#__codelineno-5-19>19</a></span>
<span class=normal><a href=#__codelineno-5-20>20</a></span>
<span class=normal><a href=#__codelineno-5-21>21</a></span>
<span class=normal><a href=#__codelineno-5-22>22</a></span>
<span class=normal><a href=#__codelineno-5-23>23</a></span>
<span class=normal><a href=#__codelineno-5-24>24</a></span>
<span class=normal><a href=#__codelineno-5-25>25</a></span>
<span class=normal><a href=#__codelineno-5-26>26</a></span>
<span class=normal><a href=#__codelineno-5-27>27</a></span>
<span class=normal><a href=#__codelineno-5-28>28</a></span>
<span class=normal><a href=#__codelineno-5-29>29</a></span>
<span class=normal><a href=#__codelineno-5-30>30</a></span>
<span class=normal><a href=#__codelineno-5-31>31</a></span>
<span class=normal><a href=#__codelineno-5-32>32</a></span>
<span class=normal><a href=#__codelineno-5-33>33</a></span>
<span class=normal><a href=#__codelineno-5-34>34</a></span>
<span class=normal><a href=#__codelineno-5-35>35</a></span>
<span class=normal><a href=#__codelineno-5-36>36</a></span>
<span class=normal><a href=#__codelineno-5-37>37</a></span>
<span class=normal><a href=#__codelineno-5-38>38</a></span>
<span class=normal><a href=#__codelineno-5-39>39</a></span>
<span class=normal><a href=#__codelineno-5-40>40</a></span>
<span class=normal><a href=#__codelineno-5-41>41</a></span>
<span class=normal><a href=#__codelineno-5-42>42</a></span>
<span class=normal><a href=#__codelineno-5-43>43</a></span>
<span class=normal><a href=#__codelineno-5-44>44</a></span>
<span class=normal><a href=#__codelineno-5-45>45</a></span>
<span class=normal><a href=#__codelineno-5-46>46</a></span>
<span class=normal><a href=#__codelineno-5-47>47</a></span>
<span class=normal><a href=#__codelineno-5-48>48</a></span>
<span class=normal><a href=#__codelineno-5-49>49</a></span>
<span class=normal><a href=#__codelineno-5-50>50</a></span>
<span class=normal><a href=#__codelineno-5-51>51</a></span>
<span class=normal><a href=#__codelineno-5-52>52</a></span>
<span class=normal><a href=#__codelineno-5-53>53</a></span>
<span class=normal><a href=#__codelineno-5-54>54</a></span>
<span class=normal><a href=#__codelineno-5-55>55</a></span>
<span class=normal><a href=#__codelineno-5-56>56</a></span>
<span class=normal><a href=#__codelineno-5-57>57</a></span>
<span class=normal><a href=#__codelineno-5-58>58</a></span>
<span class=normal><a href=#__codelineno-5-59>59</a></span>
<span class=normal><a href=#__codelineno-5-60>60</a></span>
<span class=normal><a href=#__codelineno-5-61>61</a></span>
<span class=normal><a href=#__codelineno-5-62>62</a></span>
<span class=normal><a href=#__codelineno-5-63>63</a></span>
<span class=normal><a href=#__codelineno-5-64>64</a></span>
<span class=normal><a href=#__codelineno-5-65>65</a></span>
<span class=normal><a href=#__codelineno-5-66>66</a></span>
<span class=normal><a href=#__codelineno-5-67>67</a></span>
<span class=normal><a href=#__codelineno-5-68>68</a></span>
<span class=normal><a href=#__codelineno-5-69>69</a></span>
<span class=normal><a href=#__codelineno-5-70>70</a></span>
<span class=normal><a href=#__codelineno-5-71>71</a></span>
<span class=normal><a href=#__codelineno-5-72>72</a></span>
<span class=normal><a href=#__codelineno-5-73>73</a></span>
<span class=normal><a href=#__codelineno-5-74>74</a></span>
<span class=normal><a href=#__codelineno-5-75>75</a></span>
<span class=normal><a href=#__codelineno-5-76>76</a></span>
<span class=normal><a href=#__codelineno-5-77>77</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5></a><span class=kt>void</span><span class=w> </span><span class=nf>new_proc</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6></a><span class=p>{</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>prime</span><span class=p>;</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=p>;</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10></a><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>prime</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"child process failed to read</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16></a><span class=w>    </span><span class=c1>// 每次传送的第一个数据都一定是一个素数</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"prime %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>prime</span><span class=p>);</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18></a>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19></a><span class=w>    </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>);</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>newp</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23></a><span class=w>        </span><span class=n>pipe</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fork</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26></a><span class=w>            </span><span class=n>new_proc</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28></a><span class=w>        </span><span class=k>else</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30></a><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>newp</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31></a><span class=w>            </span><span class=c1>// 若 n 不能被当前素数 prime 整除，将 n 写入新管道。</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>prime</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34></a><span class=w>                </span><span class=n>write</span><span class=p>(</span><span class=n>newp</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>);</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36></a>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37></a><span class=w>            </span><span class=c1>// 循环读取原管道中的数据，将不能被 prime 整除的数写入新管道。</span>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>))</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>prime</span><span class=p>)</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42></a><span class=w>                    </span><span class=n>write</span><span class=p>(</span><span class=n>newp</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>);</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45></a><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46></a><span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>newp</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47></a><span class=w>            </span><span class=n>wait</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51></a><span class=p>}</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52></a>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54></a><span class=p>{</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56></a><span class=w>    </span><span class=n>pipe</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fork</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59></a><span class=w>        </span><span class=n>new_proc</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>35</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-5-65><a id=__codelineno-5-65 name=__codelineno-5-65></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-5-66><a id=__codelineno-5-66 name=__codelineno-5-66></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>write</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-5-67><a id=__codelineno-5-67 name=__codelineno-5-67></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-5-68><a id=__codelineno-5-68 name=__codelineno-5-68></a><span class=w>                </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"first process failed to write %d into the pipe</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-5-69><a id=__codelineno-5-69 name=__codelineno-5-69></a><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-70><a id=__codelineno-5-70 name=__codelineno-5-70></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-71><a id=__codelineno-5-71 name=__codelineno-5-71></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-72><a id=__codelineno-5-72 name=__codelineno-5-72></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-5-73><a id=__codelineno-5-73 name=__codelineno-5-73></a><span class=w>        </span><span class=n>wait</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-5-74><a id=__codelineno-5-74 name=__codelineno-5-74></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-5-75><a id=__codelineno-5-75 name=__codelineno-5-75></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-76><a id=__codelineno-5-76 name=__codelineno-5-76></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-5-77><a id=__codelineno-5-77 name=__codelineno-5-77></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>find:</p> <blockquote> <p>目录的本质：在文件系统中，目录实际上是一种特殊的文件，它存储了一系列目录项（dirent）。每个目录项代表目录下的一个文件或子目录，包含文件名、inode 编号等信息。</p> </blockquote> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1> 1</a></span>
<span class=normal><a href=#__codelineno-6-2> 2</a></span>
<span class=normal><a href=#__codelineno-6-3> 3</a></span>
<span class=normal><a href=#__codelineno-6-4> 4</a></span>
<span class=normal><a href=#__codelineno-6-5> 5</a></span>
<span class=normal><a href=#__codelineno-6-6> 6</a></span>
<span class=normal><a href=#__codelineno-6-7> 7</a></span>
<span class=normal><a href=#__codelineno-6-8> 8</a></span>
<span class=normal><a href=#__codelineno-6-9> 9</a></span>
<span class=normal><a href=#__codelineno-6-10>10</a></span>
<span class=normal><a href=#__codelineno-6-11>11</a></span>
<span class=normal><a href=#__codelineno-6-12>12</a></span>
<span class=normal><a href=#__codelineno-6-13>13</a></span>
<span class=normal><a href=#__codelineno-6-14>14</a></span>
<span class=normal><a href=#__codelineno-6-15>15</a></span>
<span class=normal><a href=#__codelineno-6-16>16</a></span>
<span class=normal><a href=#__codelineno-6-17>17</a></span>
<span class=normal><a href=#__codelineno-6-18>18</a></span>
<span class=normal><a href=#__codelineno-6-19>19</a></span>
<span class=normal><a href=#__codelineno-6-20>20</a></span>
<span class=normal><a href=#__codelineno-6-21>21</a></span>
<span class=normal><a href=#__codelineno-6-22>22</a></span>
<span class=normal><a href=#__codelineno-6-23>23</a></span>
<span class=normal><a href=#__codelineno-6-24>24</a></span>
<span class=normal><a href=#__codelineno-6-25>25</a></span>
<span class=normal><a href=#__codelineno-6-26>26</a></span>
<span class=normal><a href=#__codelineno-6-27>27</a></span>
<span class=normal><a href=#__codelineno-6-28>28</a></span>
<span class=normal><a href=#__codelineno-6-29>29</a></span>
<span class=normal><a href=#__codelineno-6-30>30</a></span>
<span class=normal><a href=#__codelineno-6-31>31</a></span>
<span class=normal><a href=#__codelineno-6-32>32</a></span>
<span class=normal><a href=#__codelineno-6-33>33</a></span>
<span class=normal><a href=#__codelineno-6-34>34</a></span>
<span class=normal><a href=#__codelineno-6-35>35</a></span>
<span class=normal><a href=#__codelineno-6-36>36</a></span>
<span class=normal><a href=#__codelineno-6-37>37</a></span>
<span class=normal><a href=#__codelineno-6-38>38</a></span>
<span class=normal><a href=#__codelineno-6-39>39</a></span>
<span class=normal><a href=#__codelineno-6-40>40</a></span>
<span class=normal><a href=#__codelineno-6-41>41</a></span>
<span class=normal><a href=#__codelineno-6-42>42</a></span>
<span class=normal><a href=#__codelineno-6-43>43</a></span>
<span class=normal><a href=#__codelineno-6-44>44</a></span>
<span class=normal><a href=#__codelineno-6-45>45</a></span>
<span class=normal><a href=#__codelineno-6-46>46</a></span>
<span class=normal><a href=#__codelineno-6-47>47</a></span>
<span class=normal><a href=#__codelineno-6-48>48</a></span>
<span class=normal><a href=#__codelineno-6-49>49</a></span>
<span class=normal><a href=#__codelineno-6-50>50</a></span>
<span class=normal><a href=#__codelineno-6-51>51</a></span>
<span class=normal><a href=#__codelineno-6-52>52</a></span>
<span class=normal><a href=#__codelineno-6-53>53</a></span>
<span class=normal><a href=#__codelineno-6-54>54</a></span>
<span class=normal><a href=#__codelineno-6-55>55</a></span>
<span class=normal><a href=#__codelineno-6-56>56</a></span>
<span class=normal><a href=#__codelineno-6-57>57</a></span>
<span class=normal><a href=#__codelineno-6-58>58</a></span>
<span class=normal><a href=#__codelineno-6-59>59</a></span>
<span class=normal><a href=#__codelineno-6-60>60</a></span>
<span class=normal><a href=#__codelineno-6-61>61</a></span>
<span class=normal><a href=#__codelineno-6-62>62</a></span>
<span class=normal><a href=#__codelineno-6-63>63</a></span>
<span class=normal><a href=#__codelineno-6-64>64</a></span>
<span class=normal><a href=#__codelineno-6-65>65</a></span>
<span class=normal><a href=#__codelineno-6-66>66</a></span>
<span class=normal><a href=#__codelineno-6-67>67</a></span>
<span class=normal><a href=#__codelineno-6-68>68</a></span>
<span class=normal><a href=#__codelineno-6-69>69</a></span>
<span class=normal><a href=#__codelineno-6-70>70</a></span>
<span class=normal><a href=#__codelineno-6-71>71</a></span>
<span class=normal><a href=#__codelineno-6-72>72</a></span>
<span class=normal><a href=#__codelineno-6-73>73</a></span>
<span class=normal><a href=#__codelineno-6-74>74</a></span>
<span class=normal><a href=#__codelineno-6-75>75</a></span>
<span class=normal><a href=#__codelineno-6-76>76</a></span>
<span class=normal><a href=#__codelineno-6-77>77</a></span>
<span class=normal><a href=#__codelineno-6-78>78</a></span>
<span class=normal><a href=#__codelineno-6-79>79</a></span>
<span class=normal><a href=#__codelineno-6-80>80</a></span>
<span class=normal><a href=#__codelineno-6-81>81</a></span>
<span class=normal><a href=#__codelineno-6-82>82</a></span>
<span class=normal><a href=#__codelineno-6-83>83</a></span>
<span class=normal><a href=#__codelineno-6-84>84</a></span>
<span class=normal><a href=#__codelineno-6-85>85</a></span>
<span class=normal><a href=#__codelineno-6-86>86</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/fs.h"</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6></a><span class=kt>void</span><span class=w> </span><span class=nf>find_helper</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>target</span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7></a><span class=p>{</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>512</span><span class=p>],</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>dirent</span><span class=w> </span><span class=n>de</span><span class=p>;</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>stat</span><span class=w> </span><span class=n>st</span><span class=p>;</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=cm>/*O_RDONLY*/</span><span class=p>))</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"find: cannot open %s</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17></a>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fstat</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>st</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"find: cannot stat %s</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23></a>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>type</span><span class=p>)</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>T_FILE</span><span class=p>:</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>T_DEVICE</span><span class=p>:</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"Usage: find dir file</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30></a><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>T_DIR</span><span class=p>:</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DIRSIZ</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>))</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32></a><span class=w>            </span><span class=p>{</span><span class=w>   </span><span class=c1>// strlen 函数并不会把字符串末尾的空字符 '\0' 计算在内, 但是 sizeof 会算入 '\0'</span>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33></a><span class=w>                </span><span class=c1>// 加 1 是为了预留路径分隔符 / 的位置，再加 1 则是为了新拼接的字符串末尾的结束符 '\0' 预留空间</span>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34></a><span class=w>                </span><span class=c1>// DIRSIZ 定义了文件名允许的最大字节数</span>
</span><span id=__span-6-35><a id=__codelineno-6-35 name=__codelineno-6-35></a><span class=w>                </span><span class=n>printf</span><span class=p>(</span><span class=s>"find: path too long</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-6-36><a id=__codelineno-6-36 name=__codelineno-6-36></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-6-37><a id=__codelineno-6-37 name=__codelineno-6-37></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-6-38><a id=__codelineno-6-38 name=__codelineno-6-38></a><span class=w>            </span><span class=n>strcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-6-39><a id=__codelineno-6-39 name=__codelineno-6-39></a><span class=w>            </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-6-40><a id=__codelineno-6-40 name=__codelineno-6-40></a><span class=w>            </span><span class=o>*</span><span class=n>p</span><span class=o>++</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>'/'</span><span class=p>;</span><span class=w>               </span><span class=c1>// *p = '/'; p++;</span>
</span><span id=__span-6-41><a id=__codelineno-6-41 name=__codelineno-6-41></a><span class=w>            </span><span class=c1>// 遍历目录中的所有条目</span>
</span><span id=__span-6-42><a id=__codelineno-6-42 name=__codelineno-6-42></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>de</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>de</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>de</span><span class=p>))</span>
</span><span id=__span-6-43><a id=__codelineno-6-43 name=__codelineno-6-43></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-6-44><a id=__codelineno-6-44 name=__codelineno-6-44></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>de</span><span class=p>.</span><span class=n>inum</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>strcmp</span><span class=p>(</span><span class=n>de</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s>"."</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>strcmp</span><span class=p>(</span><span class=n>de</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s>".."</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-45><a id=__codelineno-6-45 name=__codelineno-6-45></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-6-46><a id=__codelineno-6-46 name=__codelineno-6-46></a><span class=w>                    </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-6-47><a id=__codelineno-6-47 name=__codelineno-6-47></a><span class=w>                    </span><span class=c1>// inum 为 0 表示该目录项无效，跳过</span>
</span><span id=__span-6-48><a id=__codelineno-6-48 name=__codelineno-6-48></a><span class=w>                    </span><span class=c1>// . 表示当前目录，无需递归查找，跳过</span>
</span><span id=__span-6-49><a id=__codelineno-6-49 name=__codelineno-6-49></a><span class=w>                    </span><span class=c1>// .. 表示父目录，为避免无限递归，跳过</span>
</span><span id=__span-6-50><a id=__codelineno-6-50 name=__codelineno-6-50></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-6-51><a id=__codelineno-6-51 name=__codelineno-6-51></a><span class=w>                </span><span class=n>memmove</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>de</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>DIRSIZ</span><span class=p>);</span>
</span><span id=__span-6-52><a id=__codelineno-6-52 name=__codelineno-6-52></a><span class=w>                </span><span class=n>p</span><span class=p>[</span><span class=n>DIRSIZ</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-6-53><a id=__codelineno-6-53 name=__codelineno-6-53></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stat</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>st</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-54><a id=__codelineno-6-54 name=__codelineno-6-54></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-6-55><a id=__codelineno-6-55 name=__codelineno-6-55></a><span class=w>                    </span><span class=n>printf</span><span class=p>(</span><span class=s>"find: cannot stat %s</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-6-56><a id=__codelineno-6-56 name=__codelineno-6-56></a><span class=w>                    </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-6-57><a id=__codelineno-6-57 name=__codelineno-6-57></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-6-58><a id=__codelineno-6-58 name=__codelineno-6-58></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>T_DIR</span><span class=p>)</span>
</span><span id=__span-6-59><a id=__codelineno-6-59 name=__codelineno-6-59></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-6-60><a id=__codelineno-6-60 name=__codelineno-6-60></a><span class=w>                    </span><span class=n>find_helper</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-6-61><a id=__codelineno-6-61 name=__codelineno-6-61></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-6-62><a id=__codelineno-6-62 name=__codelineno-6-62></a><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>T_FILE</span><span class=p>)</span>
</span><span id=__span-6-63><a id=__codelineno-6-63 name=__codelineno-6-63></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-6-64><a id=__codelineno-6-64 name=__codelineno-6-64></a><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>de</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-6-65><a id=__codelineno-6-65 name=__codelineno-6-65></a><span class=w>                    </span><span class=p>{</span>
</span><span id=__span-6-66><a id=__codelineno-6-66 name=__codelineno-6-66></a><span class=w>                        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-6-67><a id=__codelineno-6-67 name=__codelineno-6-67></a><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-6-68><a id=__codelineno-6-68 name=__codelineno-6-68></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-6-69><a id=__codelineno-6-69 name=__codelineno-6-69></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-6-70><a id=__codelineno-6-70 name=__codelineno-6-70></a><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-6-71><a id=__codelineno-6-71 name=__codelineno-6-71></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-72><a id=__codelineno-6-72 name=__codelineno-6-72></a><span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-6-73><a id=__codelineno-6-73 name=__codelineno-6-73></a><span class=p>}</span>
</span><span id=__span-6-74><a id=__codelineno-6-74 name=__codelineno-6-74></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-6-75><a id=__codelineno-6-75 name=__codelineno-6-75></a><span class=p>{</span>
</span><span id=__span-6-76><a id=__codelineno-6-76 name=__codelineno-6-76></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-6-77><a id=__codelineno-6-77 name=__codelineno-6-77></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-6-78><a id=__codelineno-6-78 name=__codelineno-6-78></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"Usage: find dir file</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-6-79><a id=__codelineno-6-79 name=__codelineno-6-79></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-6-80><a id=__codelineno-6-80 name=__codelineno-6-80></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-81><a id=__codelineno-6-81 name=__codelineno-6-81></a>
</span><span id=__span-6-82><a id=__codelineno-6-82 name=__codelineno-6-82></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-6-83><a id=__codelineno-6-83 name=__codelineno-6-83></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-6-84><a id=__codelineno-6-84 name=__codelineno-6-84></a><span class=w>    </span><span class=n>find_helper</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-6-85><a id=__codelineno-6-85 name=__codelineno-6-85></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-6-86><a id=__codelineno-6-86 name=__codelineno-6-86></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>xargs:</p> <blockquote> <p>实现一个简单的 xargs 工具，它可以将多个命令行参数组合成一个字符串，并将其传递给另一个命令。</p> <p>管道（|）是 Unix/Linux 系统中用于进程间通信的一种机制，它的作用是把一个命令（发送进程）的标准输出连接到另一个命令（接收进程）的标准输入。这样，发送进程产生的输出数据就会直接作为接收进程的输入数据。</p> </blockquote> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1>1</a></span>
<span class=normal><a href=#__codelineno-7-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span>hello<span class=w> </span>too<span class=w> </span><span class=p>|</span><span class=w> </span>xargs<span class=w> </span><span class=nb>echo</span><span class=w> </span>bye
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a>bye<span class=w> </span>hello<span class=w> </span>too
</span></code></pre></div></td></tr></table></div> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span>
<span class=normal><a href=#__codelineno-8-19>19</a></span>
<span class=normal><a href=#__codelineno-8-20>20</a></span>
<span class=normal><a href=#__codelineno-8-21>21</a></span>
<span class=normal><a href=#__codelineno-8-22>22</a></span>
<span class=normal><a href=#__codelineno-8-23>23</a></span>
<span class=normal><a href=#__codelineno-8-24>24</a></span>
<span class=normal><a href=#__codelineno-8-25>25</a></span>
<span class=normal><a href=#__codelineno-8-26>26</a></span>
<span class=normal><a href=#__codelineno-8-27>27</a></span>
<span class=normal><a href=#__codelineno-8-28>28</a></span>
<span class=normal><a href=#__codelineno-8-29>29</a></span>
<span class=normal><a href=#__codelineno-8-30>30</a></span>
<span class=normal><a href=#__codelineno-8-31>31</a></span>
<span class=normal><a href=#__codelineno-8-32>32</a></span>
<span class=normal><a href=#__codelineno-8-33>33</a></span>
<span class=normal><a href=#__codelineno-8-34>34</a></span>
<span class=normal><a href=#__codelineno-8-35>35</a></span>
<span class=normal><a href=#__codelineno-8-36>36</a></span>
<span class=normal><a href=#__codelineno-8-37>37</a></span>
<span class=normal><a href=#__codelineno-8-38>38</a></span>
<span class=normal><a href=#__codelineno-8-39>39</a></span>
<span class=normal><a href=#__codelineno-8-40>40</a></span>
<span class=normal><a href=#__codelineno-8-41>41</a></span>
<span class=normal><a href=#__codelineno-8-42>42</a></span>
<span class=normal><a href=#__codelineno-8-43>43</a></span>
<span class=normal><a href=#__codelineno-8-44>44</a></span>
<span class=normal><a href=#__codelineno-8-45>45</a></span>
<span class=normal><a href=#__codelineno-8-46>46</a></span>
<span class=normal><a href=#__codelineno-8-47>47</a></span>
<span class=normal><a href=#__codelineno-8-48>48</a></span>
<span class=normal><a href=#__codelineno-8-49>49</a></span>
<span class=normal><a href=#__codelineno-8-50>50</a></span>
<span class=normal><a href=#__codelineno-8-51>51</a></span>
<span class=normal><a href=#__codelineno-8-52>52</a></span>
<span class=normal><a href=#__codelineno-8-53>53</a></span>
<span class=normal><a href=#__codelineno-8-54>54</a></span>
<span class=normal><a href=#__codelineno-8-55>55</a></span>
<span class=normal><a href=#__codelineno-8-56>56</a></span>
<span class=normal><a href=#__codelineno-8-57>57</a></span>
<span class=normal><a href=#__codelineno-8-58>58</a></span>
<span class=normal><a href=#__codelineno-8-59>59</a></span>
<span class=normal><a href=#__codelineno-8-60>60</a></span>
<span class=normal><a href=#__codelineno-8-61>61</a></span>
<span class=normal><a href=#__codelineno-8-62>62</a></span>
<span class=normal><a href=#__codelineno-8-63>63</a></span>
<span class=normal><a href=#__codelineno-8-64>64</a></span>
<span class=normal><a href=#__codelineno-8-65>65</a></span>
<span class=normal><a href=#__codelineno-8-66>66</a></span>
<span class=normal><a href=#__codelineno-8-67>67</a></span>
<span class=normal><a href=#__codelineno-8-68>68</a></span>
<span class=normal><a href=#__codelineno-8-69>69</a></span>
<span class=normal><a href=#__codelineno-8-70>70</a></span>
<span class=normal><a href=#__codelineno-8-71>71</a></span>
<span class=normal><a href=#__codelineno-8-72>72</a></span>
<span class=normal><a href=#__codelineno-8-73>73</a></span>
<span class=normal><a href=#__codelineno-8-74>74</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/param.h"</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=kt>int</span><span class=w> </span><span class=nf>readline</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>new_argv</span><span class=p>[</span><span class=mi>32</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>curr_argc</span><span class=p>)</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><span class=p>{</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>1024</span><span class=p>];</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a><span class=w>    </span><span class=c1>// 从标准输入（文件描述符 0）逐字符读取数据，存储到 buf 数组中</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1023</span><span class=p>)</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"argument is too long</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>n</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>'\n'</span><span class=p>)</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20></a><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22></a><span class=w>        </span><span class=n>n</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24></a><span class=w>    </span><span class=n>buf</span><span class=p>[</span><span class=n>n</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=c1>// 字符串结束符 '\0'</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26></a><span class=w>    </span><span class=c1>// 此时 buf 为 "hello too"</span>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>offset</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30></a><span class=w>        </span><span class=n>new_argv</span><span class=p>[</span><span class=n>curr_argc</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>offset</span><span class=p>;</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>offset</span><span class=p>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=sc>' '</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33></a><span class=w>            </span><span class=n>offset</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>offset</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>' '</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37></a><span class=w>            </span><span class=c1>// 遇到空格时，将其替换为字符串结束符 '\0'，以分割参数</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38></a><span class=w>            </span><span class=n>buf</span><span class=p>[</span><span class=n>offset</span><span class=o>++</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>curr_argc</span><span class=p>;</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42></a><span class=p>}</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43></a>
</span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45></a><span class=p>{</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"Usage: xargs command (arg ...)</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-50><a id=__codelineno-8-50 name=__codelineno-8-50></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-51><a id=__codelineno-8-51 name=__codelineno-8-51></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-52><a id=__codelineno-8-52 name=__codelineno-8-52></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>new_argv</span><span class=p>[</span><span class=n>MAXARG</span><span class=p>];</span>
</span><span id=__span-8-53><a id=__codelineno-8-53 name=__codelineno-8-53></a><span class=w>    </span><span class=n>strcpy</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span><span class=w> </span><span class=c1>// 考虑xargs echo bye, command 为 echo</span>
</span><span id=__span-8-54><a id=__codelineno-8-54 name=__codelineno-8-54></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>argc</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span><span id=__span-8-55><a id=__codelineno-8-55 name=__codelineno-8-55></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-56><a id=__codelineno-8-56 name=__codelineno-8-56></a><span class=w>        </span><span class=n>new_argv</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-57><a id=__codelineno-8-57 name=__codelineno-8-57></a><span class=w>        </span><span class=n>strcpy</span><span class=p>(</span><span class=n>new_argv</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span><span id=__span-8-58><a id=__codelineno-8-58 name=__codelineno-8-58></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-59><a id=__codelineno-8-59 name=__codelineno-8-59></a><span class=w>    </span><span class=c1>// 此时 new_argv 为 {echo, bye}</span>
</span><span id=__span-8-60><a id=__codelineno-8-60 name=__codelineno-8-60></a>
</span><span id=__span-8-61><a id=__codelineno-8-61 name=__codelineno-8-61></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>curr_argc</span><span class=p>;</span>
</span><span id=__span-8-62><a id=__codelineno-8-62 name=__codelineno-8-62></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>curr_argc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readline</span><span class=p>(</span><span class=n>new_argv</span><span class=p>,</span><span class=w> </span><span class=n>argc</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-63><a id=__codelineno-8-63 name=__codelineno-8-63></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-8-64><a id=__codelineno-8-64 name=__codelineno-8-64></a><span class=w>        </span><span class=n>new_argv</span><span class=p>[</span><span class=n>curr_argc</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-8-65><a id=__codelineno-8-65 name=__codelineno-8-65></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fork</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-8-66><a id=__codelineno-8-66 name=__codelineno-8-66></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-8-67><a id=__codelineno-8-67 name=__codelineno-8-67></a><span class=w>            </span><span class=n>exec</span><span class=p>(</span><span class=n>command</span><span class=p>,</span><span class=w> </span><span class=n>new_argv</span><span class=p>);</span>
</span><span id=__span-8-68><a id=__codelineno-8-68 name=__codelineno-8-68></a><span class=w>            </span><span class=n>fprintf</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"exec failed</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-8-69><a id=__codelineno-8-69 name=__codelineno-8-69></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-70><a id=__codelineno-8-70 name=__codelineno-8-70></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-71><a id=__codelineno-8-71 name=__codelineno-8-71></a><span class=w>        </span><span class=n>wait</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-8-72><a id=__codelineno-8-72 name=__codelineno-8-72></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-73><a id=__codelineno-8-73 name=__codelineno-8-73></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-8-74><a id=__codelineno-8-74 name=__codelineno-8-74></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1> 1</a></span>
<span class=normal><a href=#__codelineno-9-2> 2</a></span>
<span class=normal><a href=#__codelineno-9-3> 3</a></span>
<span class=normal><a href=#__codelineno-9-4> 4</a></span>
<span class=normal><a href=#__codelineno-9-5> 5</a></span>
<span class=normal><a href=#__codelineno-9-6> 6</a></span>
<span class=normal><a href=#__codelineno-9-7> 7</a></span>
<span class=normal><a href=#__codelineno-9-8> 8</a></span>
<span class=normal><a href=#__codelineno-9-9> 9</a></span>
<span class=normal><a href=#__codelineno-9-10>10</a></span>
<span class=normal><a href=#__codelineno-9-11>11</a></span>
<span class=normal><a href=#__codelineno-9-12>12</a></span>
<span class=normal><a href=#__codelineno-9-13>13</a></span>
<span class=normal><a href=#__codelineno-9-14>14</a></span>
<span class=normal><a href=#__codelineno-9-15>15</a></span>
<span class=normal><a href=#__codelineno-9-16>16</a></span>
<span class=normal><a href=#__codelineno-9-17>17</a></span>
<span class=normal><a href=#__codelineno-9-18>18</a></span>
<span class=normal><a href=#__codelineno-9-19>19</a></span>
<span class=normal><a href=#__codelineno-9-20>20</a></span>
<span class=normal><a href=#__codelineno-9-21>21</a></span>
<span class=normal><a href=#__codelineno-9-22>22</a></span>
<span class=normal><a href=#__codelineno-9-23>23</a></span>
<span class=normal><a href=#__codelineno-9-24>24</a></span>
<span class=normal><a href=#__codelineno-9-25>25</a></span>
<span class=normal><a href=#__codelineno-9-26>26</a></span>
<span class=normal><a href=#__codelineno-9-27>27</a></span>
<span class=normal><a href=#__codelineno-9-28>28</a></span>
<span class=normal><a href=#__codelineno-9-29>29</a></span>
<span class=normal><a href=#__codelineno-9-30>30</a></span>
<span class=normal><a href=#__codelineno-9-31>31</a></span>
<span class=normal><a href=#__codelineno-9-32>32</a></span>
<span class=normal><a href=#__codelineno-9-33>33</a></span>
<span class=normal><a href=#__codelineno-9-34>34</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=c1># sleep</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2></a>$<span class=w> </span>sleep<span class=w> </span><span class=m>10</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3></a>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4></a><span class=c1># pingpong</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5></a>$<span class=w> </span>pingpong
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6></a><span class=m>5</span>:<span class=w> </span>received<span class=w> </span>ping
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7></a><span class=m>4</span>:<span class=w> </span>received<span class=w> </span>pong
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8></a>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9></a><span class=c1># primes</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10></a>$<span class=w> </span>primes
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11></a>prime<span class=w> </span><span class=m>2</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12></a>prime<span class=w> </span><span class=m>3</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13></a>prime<span class=w> </span><span class=m>5</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14></a>prime<span class=w> </span><span class=m>7</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15></a>prime<span class=w> </span><span class=m>11</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16></a>prime<span class=w> </span><span class=m>13</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17></a>prime<span class=w> </span><span class=m>17</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18></a>prime<span class=w> </span><span class=m>19</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19></a>prime<span class=w> </span><span class=m>23</span>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20></a>prime<span class=w> </span><span class=m>29</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21></a>prime<span class=w> </span><span class=m>31</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22></a>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23></a><span class=c1># find</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span>&gt;<span class=w> </span>b
</span><span id=__span-9-25><a id=__codelineno-9-25 name=__codelineno-9-25></a>$<span class=w> </span>mkdir<span class=w> </span>a
</span><span id=__span-9-26><a id=__codelineno-9-26 name=__codelineno-9-26></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span>&gt;<span class=w> </span>a/b
</span><span id=__span-9-27><a id=__codelineno-9-27 name=__codelineno-9-27></a>$<span class=w> </span>find<span class=w> </span>.<span class=w> </span>b
</span><span id=__span-9-28><a id=__codelineno-9-28 name=__codelineno-9-28></a>./b
</span><span id=__span-9-29><a id=__codelineno-9-29 name=__codelineno-9-29></a>./a/b
</span><span id=__span-9-30><a id=__codelineno-9-30 name=__codelineno-9-30></a>
</span><span id=__span-9-31><a id=__codelineno-9-31 name=__codelineno-9-31></a><span class=c1># xargs</span>
</span><span id=__span-9-32><a id=__codelineno-9-32 name=__codelineno-9-32></a>$<span class=w> </span><span class=nb>echo</span><span class=w> </span>hello<span class=w> </span>too<span class=w> </span><span class=p>|</span><span class=w> </span>xargs<span class=w> </span><span class=nb>echo</span><span class=w> </span>bye
</span><span id=__span-9-33><a id=__codelineno-9-33 name=__codelineno-9-33></a>bye<span class=w> </span>hello<span class=w> </span>too
</span><span id=__span-9-34><a id=__codelineno-9-34 name=__codelineno-9-34></a>$<span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab2-system-calls>Lab2: System calls<a class=headerlink href=#lab2-system-calls title="Permanent link">¶</a></h2> <ol> <li> <p>System call tracing</p> <p>首先在<code>proc</code>结构体中添加一个数据字段，用于保存<code>trace</code>的参数，并在<code>sys_trace()</code>的实现中实现参数的保存:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=c1>// kernel/proc.h</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>trace_mask</span><span class=p>;</span><span class=w>    </span><span class=c1>// trace系统调用参数</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><span class=p>};</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a><span class=c1>// kernel/sysproc.c</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a><span class=n>uint64</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9></a><span class=nf>sys_trace</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10></a><span class=p>{</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>trace_mask</span><span class=p>;</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12></a><span class=w>    </span><span class=c1>// argint: 从用户空间读取一个整数参数(第0个参数)到内核空间的变量 trace_mask</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>trace_mask</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15></a><span class=w>    </span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>trace_mask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>trace_mask</span><span class=p>;</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>由于<code>struct proc</code>中增加了一个新的变量, 当<code>fork</code>的时候我们也需要将这个变量传递到子进程中:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1> 1</a></span>
<span class=normal><a href=#__codelineno-11-2> 2</a></span>
<span class=normal><a href=#__codelineno-11-3> 3</a></span>
<span class=normal><a href=#__codelineno-11-4> 4</a></span>
<span class=normal><a href=#__codelineno-11-5> 5</a></span>
<span class=normal><a href=#__codelineno-11-6> 6</a></span>
<span class=normal><a href=#__codelineno-11-7> 7</a></span>
<span class=normal><a href=#__codelineno-11-8> 8</a></span>
<span class=normal><a href=#__codelineno-11-9> 9</a></span>
<span class=normal><a href=#__codelineno-11-10>10</a></span>
<span class=normal><a href=#__codelineno-11-11>11</a></span>
<span class=normal><a href=#__codelineno-11-12>12</a></span>
<span class=normal><a href=#__codelineno-11-13>13</a></span>
<span class=normal><a href=#__codelineno-11-14>14</a></span>
<span class=normal><a href=#__codelineno-11-15>15</a></span>
<span class=normal><a href=#__codelineno-11-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=c1>//kernel/proc.c</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><span class=kt>int</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><span class=p>{</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><span class=w>    </span><span class=n>safestrcpy</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><span class=w>    </span><span class=c1>// 将trace_mask拷贝到子进程</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a><span class=w>    </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>trace_mask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trace_mask</span><span class=p>;</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12></a><span class=w>    </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14></a>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>系统调用追踪在<code>syscall()</code>函数中实现:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span>
<span class=normal><a href=#__codelineno-12-14>14</a></span>
<span class=normal><a href=#__codelineno-12-15>15</a></span>
<span class=normal><a href=#__codelineno-12-16>16</a></span>
<span class=normal><a href=#__codelineno-12-17>17</a></span>
<span class=normal><a href=#__codelineno-12-18>18</a></span>
<span class=normal><a href=#__codelineno-12-19>19</a></span>
<span class=normal><a href=#__codelineno-12-20>20</a></span>
<span class=normal><a href=#__codelineno-12-21>21</a></span>
<span class=normal><a href=#__codelineno-12-22>22</a></span>
<span class=normal><a href=#__codelineno-12-23>23</a></span>
<span class=normal><a href=#__codelineno-12-24>24</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=kt>void</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=nf>syscall</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><span class=p>{</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=p>;</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><span class=w>    </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a7</span><span class=p>;</span><span class=w>  </span><span class=c1>// 系统调用编号，参见书中4.3节</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NELEM</span><span class=p>(</span><span class=n>syscalls</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>])</span><span class=w> </span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>]();</span><span class=w>  </span><span class=c1>// 执行系统调用，然后将返回值存入a0</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><span class=w>        </span><span class=c1>// 系统调用是否匹配</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>num</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trace_mask</span><span class=p>)</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d: syscall %s -&gt; %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>syscalls_name</span><span class=p>[</span><span class=n>num</span><span class=p>],</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span><span class=p>);</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><span class=w>        </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d %s: unknown sys call %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>num</span><span class=p>);</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在上面的代码中，我们还有一些引用的变量尚未定义，在syscall.c中定义他们:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1> 1</a></span>
<span class=normal><a href=#__codelineno-13-2> 2</a></span>
<span class=normal><a href=#__codelineno-13-3> 3</a></span>
<span class=normal><a href=#__codelineno-13-4> 4</a></span>
<span class=normal><a href=#__codelineno-13-5> 5</a></span>
<span class=normal><a href=#__codelineno-13-6> 6</a></span>
<span class=normal><a href=#__codelineno-13-7> 7</a></span>
<span class=normal><a href=#__codelineno-13-8> 8</a></span>
<span class=normal><a href=#__codelineno-13-9> 9</a></span>
<span class=normal><a href=#__codelineno-13-10>10</a></span>
<span class=normal><a href=#__codelineno-13-11>11</a></span>
<span class=normal><a href=#__codelineno-13-12>12</a></span>
<span class=normal><a href=#__codelineno-13-13>13</a></span>
<span class=normal><a href=#__codelineno-13-14>14</a></span>
<span class=normal><a href=#__codelineno-13-15>15</a></span>
<span class=normal><a href=#__codelineno-13-16>16</a></span>
<span class=normal><a href=#__codelineno-13-17>17</a></span>
<span class=normal><a href=#__codelineno-13-18>18</a></span>
<span class=normal><a href=#__codelineno-13-19>19</a></span>
<span class=normal><a href=#__codelineno-13-20>20</a></span>
<span class=normal><a href=#__codelineno-13-21>21</a></span>
<span class=normal><a href=#__codelineno-13-22>22</a></span>
<span class=normal><a href=#__codelineno-13-23>23</a></span>
<span class=normal><a href=#__codelineno-13-24>24</a></span>
<span class=normal><a href=#__codelineno-13-25>25</a></span>
<span class=normal><a href=#__codelineno-13-26>26</a></span>
<span class=normal><a href=#__codelineno-13-27>27</a></span>
<span class=normal><a href=#__codelineno-13-28>28</a></span>
<span class=normal><a href=#__codelineno-13-29>29</a></span>
<span class=normal><a href=#__codelineno-13-30>30</a></span>
<span class=normal><a href=#__codelineno-13-31>31</a></span>
<span class=normal><a href=#__codelineno-13-32>32</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=c1>// ...</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><span class=k>extern</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=nf>sys_trace</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><span class=k>static</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>syscalls</span><span class=p>[])(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><span class=c1>// ...</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><span class=p>[</span><span class=n>SYS_trace</span><span class=p>]</span><span class=w>   </span><span class=n>sys_trace</span><span class=p>,</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><span class=p>};</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><span class=k>static</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>syscalls_name</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a><span class=p>[</span><span class=n>SYS_fork</span><span class=p>]</span><span class=w>    </span><span class=s>"fork"</span><span class=p>,</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><span class=p>[</span><span class=n>SYS_exit</span><span class=p>]</span><span class=w>    </span><span class=s>"exit"</span><span class=p>,</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12></a><span class=p>[</span><span class=n>SYS_wait</span><span class=p>]</span><span class=w>    </span><span class=s>"wait"</span><span class=p>,</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13></a><span class=p>[</span><span class=n>SYS_pipe</span><span class=p>]</span><span class=w>    </span><span class=s>"pipe"</span><span class=p>,</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14></a><span class=p>[</span><span class=n>SYS_read</span><span class=p>]</span><span class=w>    </span><span class=s>"read"</span><span class=p>,</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15></a><span class=p>[</span><span class=n>SYS_kill</span><span class=p>]</span><span class=w>    </span><span class=s>"kill"</span><span class=p>,</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16></a><span class=p>[</span><span class=n>SYS_exec</span><span class=p>]</span><span class=w>    </span><span class=s>"exec"</span><span class=p>,</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17></a><span class=p>[</span><span class=n>SYS_fstat</span><span class=p>]</span><span class=w>   </span><span class=s>"fstat"</span><span class=p>,</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18></a><span class=p>[</span><span class=n>SYS_chdir</span><span class=p>]</span><span class=w>   </span><span class=s>"chdir"</span><span class=p>,</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19></a><span class=p>[</span><span class=n>SYS_dup</span><span class=p>]</span><span class=w>     </span><span class=s>"dup"</span><span class=p>,</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20></a><span class=p>[</span><span class=n>SYS_getpid</span><span class=p>]</span><span class=w>  </span><span class=s>"getpid"</span><span class=p>,</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21></a><span class=p>[</span><span class=n>SYS_sbrk</span><span class=p>]</span><span class=w>    </span><span class=s>"sbrk"</span><span class=p>,</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22></a><span class=p>[</span><span class=n>SYS_sleep</span><span class=p>]</span><span class=w>   </span><span class=s>"sleep"</span><span class=p>,</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23></a><span class=p>[</span><span class=n>SYS_uptime</span><span class=p>]</span><span class=w>  </span><span class=s>"uptime"</span><span class=p>,</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24></a><span class=p>[</span><span class=n>SYS_open</span><span class=p>]</span><span class=w>    </span><span class=s>"open"</span><span class=p>,</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25></a><span class=p>[</span><span class=n>SYS_write</span><span class=p>]</span><span class=w>   </span><span class=s>"write"</span><span class=p>,</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26></a><span class=p>[</span><span class=n>SYS_mknod</span><span class=p>]</span><span class=w>   </span><span class=s>"mknod"</span><span class=p>,</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27></a><span class=p>[</span><span class=n>SYS_unlink</span><span class=p>]</span><span class=w>  </span><span class=s>"unlink"</span><span class=p>,</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28></a><span class=p>[</span><span class=n>SYS_link</span><span class=p>]</span><span class=w>    </span><span class=s>"link"</span><span class=p>,</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29></a><span class=p>[</span><span class=n>SYS_mkdir</span><span class=p>]</span><span class=w>   </span><span class=s>"mkdir"</span><span class=p>,</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30></a><span class=p>[</span><span class=n>SYS_close</span><span class=p>]</span><span class=w>   </span><span class=s>"close"</span><span class=p>,</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31></a><span class=p>[</span><span class=n>SYS_trace</span><span class=p>]</span><span class=w>   </span><span class=s>"trace"</span><span class=p>,</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>sysinfo:</p> <p>内存是使用链表进行管理的，因此遍历kmem中的空闲链表就能够获取所有的空闲内存:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span>
<span class=normal><a href=#__codelineno-14-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><span class=c1>// kernel/kalloc.c</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><span class=n>uint64</span><span class=w> </span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><span class=nf>freemem</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><span class=p>{</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>freepage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><span class=w>    </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><span class=w>        </span><span class=n>freepage</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>freepage</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>12</span><span class=p>);</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>遍历proc数组，统计处于活动状态的进程即可，循环的写法参考scheduler函数:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1> 1</a></span>
<span class=normal><a href=#__codelineno-15-2> 2</a></span>
<span class=normal><a href=#__codelineno-15-3> 3</a></span>
<span class=normal><a href=#__codelineno-15-4> 4</a></span>
<span class=normal><a href=#__codelineno-15-5> 5</a></span>
<span class=normal><a href=#__codelineno-15-6> 6</a></span>
<span class=normal><a href=#__codelineno-15-7> 7</a></span>
<span class=normal><a href=#__codelineno-15-8> 8</a></span>
<span class=normal><a href=#__codelineno-15-9> 9</a></span>
<span class=normal><a href=#__codelineno-15-10>10</a></span>
<span class=normal><a href=#__codelineno-15-11>11</a></span>
<span class=normal><a href=#__codelineno-15-12>12</a></span>
<span class=normal><a href=#__codelineno-15-13>13</a></span>
<span class=normal><a href=#__codelineno-15-14>14</a></span>
<span class=normal><a href=#__codelineno-15-15>15</a></span>
<span class=normal><a href=#__codelineno-15-16>16</a></span>
<span class=normal><a href=#__codelineno-15-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=c1>// kernel/proc.c</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><span class=n>uint64</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><span class=nf>procnum</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=p>{</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>procnum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7></a>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proc</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=o>&amp;</span><span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span><span class=w> </span><span class=n>p</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>UNUSED</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12></a><span class=w>            </span><span class=n>procnum</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15></a>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>procnum</span><span class=p>;</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>实现<code>sys_sysinfo</code>，将数据写入结构体并传递到用户空间:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1> 1</a></span>
<span class=normal><a href=#__codelineno-16-2> 2</a></span>
<span class=normal><a href=#__codelineno-16-3> 3</a></span>
<span class=normal><a href=#__codelineno-16-4> 4</a></span>
<span class=normal><a href=#__codelineno-16-5> 5</a></span>
<span class=normal><a href=#__codelineno-16-6> 6</a></span>
<span class=normal><a href=#__codelineno-16-7> 7</a></span>
<span class=normal><a href=#__codelineno-16-8> 8</a></span>
<span class=normal><a href=#__codelineno-16-9> 9</a></span>
<span class=normal><a href=#__codelineno-16-10>10</a></span>
<span class=normal><a href=#__codelineno-16-11>11</a></span>
<span class=normal><a href=#__codelineno-16-12>12</a></span>
<span class=normal><a href=#__codelineno-16-13>13</a></span>
<span class=normal><a href=#__codelineno-16-14>14</a></span>
<span class=normal><a href=#__codelineno-16-15>15</a></span>
<span class=normal><a href=#__codelineno-16-16>16</a></span>
<span class=normal><a href=#__codelineno-16-17>17</a></span>
<span class=normal><a href=#__codelineno-16-18>18</a></span>
<span class=normal><a href=#__codelineno-16-19>19</a></span>
<span class=normal><a href=#__codelineno-16-20>20</a></span>
<span class=normal><a href=#__codelineno-16-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><span class=c1>// kernel/sysproc.c</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><span class=n>uint64</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a><span class=nf>sys_sysinfo</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><span class=p>{</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><span class=w>    </span><span class=c1>// argaddr 是 XV6 操作系统中用于从系统调用参数中获取用户空间地址的函数。</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><span class=w>    </span><span class=c1>// 它的主要作用是从系统调用的参数列表中读取一个用户空间的地址（64位指针），</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><span class=w>    </span><span class=c1>// 并将其存储在提供的指针变量中。</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argaddr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sysinfo</span><span class=w> </span><span class=n>info</span><span class=p>;</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a><span class=w>    </span><span class=n>info</span><span class=p>.</span><span class=n>freemem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>freemem</span><span class=p>();</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><span class=w>    </span><span class=n>info</span><span class=p>.</span><span class=n>nproc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>procnum</span><span class=p>();</span><span class=w> </span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15></a><span class=w>    </span><span class=c1>// Copy from kernel to user.</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16></a><span class=w>    </span><span class=c1>// Copy len bytes from src to virtual address dstva in a given page table.   </span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17></a><span class=w>    </span><span class=c1>// copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>copyout</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>info</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>info</span><span class=p>))</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span>
<span class=normal><a href=#__codelineno-17-2>2</a></span>
<span class=normal><a href=#__codelineno-17-3>3</a></span>
<span class=normal><a href=#__codelineno-17-4>4</a></span>
<span class=normal><a href=#__codelineno-17-5>5</a></span>
<span class=normal><a href=#__codelineno-17-6>6</a></span>
<span class=normal><a href=#__codelineno-17-7>7</a></span>
<span class=normal><a href=#__codelineno-17-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a>$<span class=w> </span>trace<span class=w> </span><span class=m>32</span><span class=w> </span>grep<span class=w> </span>hello<span class=w> </span>README<span class=w> </span><span class=c1># 32是1&lt;&lt;SYS_read，仅跟踪read系统调用</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><span class=m>3</span>:<span class=w> </span>syscall<span class=w> </span><span class=nb>read</span><span class=w> </span>-&gt;<span class=w> </span><span class=m>1023</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><span class=m>3</span>:<span class=w> </span>syscall<span class=w> </span><span class=nb>read</span><span class=w> </span>-&gt;<span class=w> </span><span class=m>968</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><span class=m>3</span>:<span class=w> </span>syscall<span class=w> </span><span class=nb>read</span><span class=w> </span>-&gt;<span class=w> </span><span class=m>235</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><span class=m>3</span>:<span class=w> </span>syscall<span class=w> </span><span class=nb>read</span><span class=w> </span>-&gt;<span class=w> </span><span class=m>0</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a>$<span class=w> </span>sysinfotest
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a>sysinfotest:<span class=w> </span>start
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a>sysinfotest:<span class=w> </span>OK
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab3-page-tables>Lab3: Page tables<a class=headerlink href=#lab3-page-tables title="Permanent link">¶</a></h2> <ol> <li> <p>Print a page table:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1> 1</a></span>
<span class=normal><a href=#__codelineno-18-2> 2</a></span>
<span class=normal><a href=#__codelineno-18-3> 3</a></span>
<span class=normal><a href=#__codelineno-18-4> 4</a></span>
<span class=normal><a href=#__codelineno-18-5> 5</a></span>
<span class=normal><a href=#__codelineno-18-6> 6</a></span>
<span class=normal><a href=#__codelineno-18-7> 7</a></span>
<span class=normal><a href=#__codelineno-18-8> 8</a></span>
<span class=normal><a href=#__codelineno-18-9> 9</a></span>
<span class=normal><a href=#__codelineno-18-10>10</a></span>
<span class=normal><a href=#__codelineno-18-11>11</a></span>
<span class=normal><a href=#__codelineno-18-12>12</a></span>
<span class=normal><a href=#__codelineno-18-13>13</a></span>
<span class=normal><a href=#__codelineno-18-14>14</a></span>
<span class=normal><a href=#__codelineno-18-15>15</a></span>
<span class=normal><a href=#__codelineno-18-16>16</a></span>
<span class=normal><a href=#__codelineno-18-17>17</a></span>
<span class=normal><a href=#__codelineno-18-18>18</a></span>
<span class=normal><a href=#__codelineno-18-19>19</a></span>
<span class=normal><a href=#__codelineno-18-20>20</a></span>
<span class=normal><a href=#__codelineno-18-21>21</a></span>
<span class=normal><a href=#__codelineno-18-22>22</a></span>
<span class=normal><a href=#__codelineno-18-23>23</a></span>
<span class=normal><a href=#__codelineno-18-24>24</a></span>
<span class=normal><a href=#__codelineno-18-25>25</a></span>
<span class=normal><a href=#__codelineno-18-26>26</a></span>
<span class=normal><a href=#__codelineno-18-27>27</a></span>
<span class=normal><a href=#__codelineno-18-28>28</a></span>
<span class=normal><a href=#__codelineno-18-29>29</a></span>
<span class=normal><a href=#__codelineno-18-30>30</a></span>
<span class=normal><a href=#__codelineno-18-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><span class=c1>// kernel/vm.c</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=kt>void</span><span class=w> </span><span class=nf>vmprinthelper</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>level</span><span class=p>)</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><span class=p>{</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><span class=w>    </span><span class=c1>// there are 2^9 = 512 PTEs in a page table.</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>512</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a><span class=w>        </span><span class=n>pte_t</span><span class=w> </span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pagetable</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>level</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=n>printf</span><span class=p>(</span><span class=s>".. "</span><span class=p>);</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a><span class=w>            </span><span class=n>uint64</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d: pte %p pa %p</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>pte</span><span class=p>,</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=n>pte</span><span class=p>));</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>PTE_R</span><span class=o>|</span><span class=n>PTE_W</span><span class=o>|</span><span class=n>PTE_X</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14></a><span class=w>            </span><span class=c1>// 最后一层页表中页表项中W位，R位，X位起码有一位会被设置为1</span>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15></a><span class=w>            </span><span class=c1>// 读/写/执行位都为0：该页表项被视为无效或保留状态</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17></a><span class=w>                </span><span class=c1>// this PTE points to a lower-level page table.</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18></a><span class=w>                </span><span class=n>vmprinthelper</span><span class=p>((</span><span class=n>pagetable_t</span><span class=p>)</span><span class=n>child</span><span class=p>,</span><span class=w> </span><span class=n>level</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20></a><span class=w>        </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22></a><span class=p>}</span>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23></a>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24></a><span class=kt>void</span><span class=w> </span><span class=nf>vmprint</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>)</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25></a><span class=p>{</span>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"page table %p</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>pagetable</span><span class=p>);</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27></a><span class=w>    </span><span class=n>vmprinthelper</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28></a><span class=p>}</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29></a>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30></a><span class=c1>// exec function: 打印第一个进程的页表</span>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31></a><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>vmprint</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1> 1</a></span>
<span class=normal><a href=#__codelineno-19-2> 2</a></span>
<span class=normal><a href=#__codelineno-19-3> 3</a></span>
<span class=normal><a href=#__codelineno-19-4> 4</a></span>
<span class=normal><a href=#__codelineno-19-5> 5</a></span>
<span class=normal><a href=#__codelineno-19-6> 6</a></span>
<span class=normal><a href=#__codelineno-19-7> 7</a></span>
<span class=normal><a href=#__codelineno-19-8> 8</a></span>
<span class=normal><a href=#__codelineno-19-9> 9</a></span>
<span class=normal><a href=#__codelineno-19-10>10</a></span>
<span class=normal><a href=#__codelineno-19-11>11</a></span>
<span class=normal><a href=#__codelineno-19-12>12</a></span>
<span class=normal><a href=#__codelineno-19-13>13</a></span>
<span class=normal><a href=#__codelineno-19-14>14</a></span>
<span class=normal><a href=#__codelineno-19-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a>xv6<span class=w> </span>kernel<span class=w> </span>is<span class=w> </span>booting
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a>hart<span class=w> </span><span class=m>1</span><span class=w> </span>starting
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a>hart<span class=w> </span><span class=m>2</span><span class=w> </span>starting
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a>page<span class=w> </span>table<span class=w> </span>0x0000000087f6f000
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a>..<span class=w> </span><span class=m>0</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fdac01<span class=w> </span>pa<span class=w> </span>0x0000000087f6b000
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a>..<span class=w> </span>..<span class=w> </span><span class=m>0</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fda801<span class=w> </span>pa<span class=w> </span>0x0000000087f6a000
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a>..<span class=w> </span>..<span class=w> </span>..<span class=w> </span><span class=m>0</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fdb01f<span class=w> </span>pa<span class=w> </span>0x0000000087f6c000
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a>..<span class=w> </span>..<span class=w> </span>..<span class=w> </span><span class=m>1</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fda40f<span class=w> </span>pa<span class=w> </span>0x0000000087f69000
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10></a>..<span class=w> </span>..<span class=w> </span>..<span class=w> </span><span class=m>2</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fda01f<span class=w> </span>pa<span class=w> </span>0x0000000087f68000
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11></a>..<span class=w> </span><span class=m>255</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fdb801<span class=w> </span>pa<span class=w> </span>0x0000000087f6e000
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12></a>..<span class=w> </span>..<span class=w> </span><span class=m>511</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fdb401<span class=w> </span>pa<span class=w> </span>0x0000000087f6d000
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13></a>..<span class=w> </span>..<span class=w> </span>..<span class=w> </span><span class=m>510</span>:<span class=w> </span>pte<span class=w> </span>0x0000000021fddc07<span class=w> </span>pa<span class=w> </span>0x0000000087f77000
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14></a>..<span class=w> </span>..<span class=w> </span>..<span class=w> </span><span class=m>511</span>:<span class=w> </span>pte<span class=w> </span>0x0000000020001c0b<span class=w> </span>pa<span class=w> </span>0x0000000080007000
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15></a>init:<span class=w> </span>starting<span class=w> </span>sh
</span></code></pre></div></td></tr></table></div> </li> <li> <p>A kernel page table per process:</p> <blockquote> <p>本实验主要是让每个进程都有自己的内核页表，这样在内核中执行时使用进程自己的内核页表。</p> </blockquote> <p>(1) 首先给kernel/proc.h里面的 <code>struct proc</code> 加上内核页表的字段 <code>kernelpt</code>:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1>1</a></span>
<span class=normal><a href=#__codelineno-20-2>2</a></span>
<span class=normal><a href=#__codelineno-20-3>3</a></span>
<span class=normal><a href=#__codelineno-20-4>4</a></span>
<span class=normal><a href=#__codelineno-20-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><span class=n>uint64</span><span class=w> </span><span class=n>kstack</span><span class=p>;</span><span class=w>               </span><span class=c1>// Virtual address of kernel stack</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><span class=n>uint64</span><span class=w> </span><span class=n>sz</span><span class=p>;</span><span class=w>                   </span><span class=c1>// Size of process memory (bytes)</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>;</span><span class=w>       </span><span class=c1>// User page table</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><span class=n>pagetable_t</span><span class=w> </span><span class=n>kernelpt</span><span class=p>;</span><span class=w>        </span><span class=c1>// 进程的内核页表，加这一句 🏠</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><span class=k>struct</span><span class=w> </span><span class=nc>trapframe</span><span class=w> </span><span class=o>*</span><span class=n>trapframe</span><span class=p>;</span><span class=w> </span><span class=c1>// data page for trampoline.S</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在vm.c中添加新的方法 <code>proc_kpt_init</code>，该方法用于在 <code>allocproc</code> 中初始化进程的内核页表。这个函数还需要一个辅助函数 <code>uvmmap</code>，该函数和 <code>kvmmap</code> 方法几乎一致，不同的是 <code>kvmmap</code> 是对XV6的内核页表进行映射，而 <code>uvmmap</code>用于对进程的内核页表进行映射。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1> 1</a></span>
<span class=normal><a href=#__codelineno-21-2> 2</a></span>
<span class=normal><a href=#__codelineno-21-3> 3</a></span>
<span class=normal><a href=#__codelineno-21-4> 4</a></span>
<span class=normal><a href=#__codelineno-21-5> 5</a></span>
<span class=normal><a href=#__codelineno-21-6> 6</a></span>
<span class=normal><a href=#__codelineno-21-7> 7</a></span>
<span class=normal><a href=#__codelineno-21-8> 8</a></span>
<span class=normal><a href=#__codelineno-21-9> 9</a></span>
<span class=normal><a href=#__codelineno-21-10>10</a></span>
<span class=normal><a href=#__codelineno-21-11>11</a></span>
<span class=normal><a href=#__codelineno-21-12>12</a></span>
<span class=normal><a href=#__codelineno-21-13>13</a></span>
<span class=normal><a href=#__codelineno-21-14>14</a></span>
<span class=normal><a href=#__codelineno-21-15>15</a></span>
<span class=normal><a href=#__codelineno-21-16>16</a></span>
<span class=normal><a href=#__codelineno-21-17>17</a></span>
<span class=normal><a href=#__codelineno-21-18>18</a></span>
<span class=normal><a href=#__codelineno-21-19>19</a></span>
<span class=normal><a href=#__codelineno-21-20>20</a></span>
<span class=normal><a href=#__codelineno-21-21>21</a></span>
<span class=normal><a href=#__codelineno-21-22>22</a></span>
<span class=normal><a href=#__codelineno-21-23>23</a></span>
<span class=normal><a href=#__codelineno-21-24>24</a></span>
<span class=normal><a href=#__codelineno-21-25>25</a></span>
<span class=normal><a href=#__codelineno-21-26>26</a></span>
<span class=normal><a href=#__codelineno-21-27>27</a></span>
<span class=normal><a href=#__codelineno-21-28>28</a></span>
<span class=normal><a href=#__codelineno-21-29>29</a></span>
<span class=normal><a href=#__codelineno-21-30>30</a></span>
<span class=normal><a href=#__codelineno-21-31>31</a></span>
<span class=normal><a href=#__codelineno-21-32>32</a></span>
<span class=normal><a href=#__codelineno-21-33>33</a></span>
<span class=normal><a href=#__codelineno-21-34>34</a></span>
<span class=normal><a href=#__codelineno-21-35>35</a></span>
<span class=normal><a href=#__codelineno-21-36>36</a></span>
<span class=normal><a href=#__codelineno-21-37>37</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a><span class=c1>// 用于用户进程的内核页表进行映射</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2></a><span class=kt>void</span><span class=w> </span><span class=nf>uvmmap</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>sz</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>perm</span><span class=p>)</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3></a><span class=p>{</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>,</span><span class=w> </span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>perm</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmmap"</span><span class=p>);</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6></a><span class=p>}</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7></a>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8></a><span class=c1>// proc's version of kvminit</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9></a><span class=c1>// Create a kernel page table for the process</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10></a><span class=n>pagetable_t</span><span class=w> </span><span class=nf>proc_kpt_init</span><span class=p>()</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11></a><span class=p>{</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12></a><span class=w>    </span><span class=n>pagetable_t</span><span class=w> </span><span class=n>kernelpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uvmcreate</span><span class=p>();</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>kernelpt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14></a>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15></a><span class=w>    </span><span class=c1>// uart registers</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>UART0</span><span class=p>,</span><span class=w> </span><span class=n>UART0</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17></a>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18></a><span class=w>    </span><span class=c1>// virtio mmio disk interface</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>VIRTIO0</span><span class=p>,</span><span class=w> </span><span class=n>VIRTIO0</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20></a>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>CLINT</span><span class=p>,</span><span class=w> </span><span class=n>CLINT</span><span class=p>,</span><span class=w> </span><span class=mh>0x10000</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22></a>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23></a><span class=w>    </span><span class=c1>// PLIC</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>PLIC</span><span class=p>,</span><span class=w> </span><span class=n>PLIC</span><span class=p>,</span><span class=w> </span><span class=mh>0x400000</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25></a>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26></a><span class=w>    </span><span class=c1>// map kernel text executable and read-only.</span>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>KERNBASE</span><span class=p>,</span><span class=w> </span><span class=n>KERNBASE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=o>-</span><span class=n>KERNBASE</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_X</span><span class=p>);</span>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28></a>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29></a><span class=w>    </span><span class=c1>// map kernel data and the physical RAM we'll make use of.</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span><span class=w> </span><span class=n>PHYSTOP</span><span class=o>-</span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31></a>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32></a><span class=w>    </span><span class=c1>// map the trampoline for trap entry/exit to</span>
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33></a><span class=w>    </span><span class=c1>// the highest virtual address in the kernel.</span>
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34></a><span class=w>    </span><span class=n>uvmmap</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>TRAMPOLINE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>trampoline</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_X</span><span class=p>);</span>
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35></a>
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>kernelpt</span><span class=p>;</span>
</span><span id=__span-21-37><a id=__codelineno-21-37 name=__codelineno-21-37></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 在 kernel/proc.c 里面的 <code>allocproc</code> 调用 <code>proc_kpt_init</code> 初始化进程的内核页表, 并参考 <code>proc_mapstacks</code> 将内核栈映射到进程的内核页表中。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1> 1</a></span>
<span class=normal><a href=#__codelineno-22-2> 2</a></span>
<span class=normal><a href=#__codelineno-22-3> 3</a></span>
<span class=normal><a href=#__codelineno-22-4> 4</a></span>
<span class=normal><a href=#__codelineno-22-5> 5</a></span>
<span class=normal><a href=#__codelineno-22-6> 6</a></span>
<span class=normal><a href=#__codelineno-22-7> 7</a></span>
<span class=normal><a href=#__codelineno-22-8> 8</a></span>
<span class=normal><a href=#__codelineno-22-9> 9</a></span>
<span class=normal><a href=#__codelineno-22-10>10</a></span>
<span class=normal><a href=#__codelineno-22-11>11</a></span>
<span class=normal><a href=#__codelineno-22-12>12</a></span>
<span class=normal><a href=#__codelineno-22-13>13</a></span>
<span class=normal><a href=#__codelineno-22-14>14</a></span>
<span class=normal><a href=#__codelineno-22-15>15</a></span>
<span class=normal><a href=#__codelineno-22-16>16</a></span>
<span class=normal><a href=#__codelineno-22-17>17</a></span>
<span class=normal><a href=#__codelineno-22-18>18</a></span>
<span class=normal><a href=#__codelineno-22-19>19</a></span>
<span class=normal><a href=#__codelineno-22-20>20</a></span>
<span class=normal><a href=#__codelineno-22-21>21</a></span>
<span class=normal><a href=#__codelineno-22-22>22</a></span>
<span class=normal><a href=#__codelineno-22-23>23</a></span>
<span class=normal><a href=#__codelineno-22-24>24</a></span>
<span class=normal><a href=#__codelineno-22-25>25</a></span>
<span class=normal><a href=#__codelineno-22-26>26</a></span>
<span class=normal><a href=#__codelineno-22-27>27</a></span>
<span class=normal><a href=#__codelineno-22-28>28</a></span>
<span class=normal><a href=#__codelineno-22-29>29</a></span>
<span class=normal><a href=#__codelineno-22-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a><span class=p>...</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2></a>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3></a><span class=c1>// An empty user page table.</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4></a><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proc_pagetable</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5></a><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>){</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6></a><span class=w>    </span><span class=n>freeproc</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9></a><span class=p>}</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10></a>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11></a><span class=c1>// Init the kernal page table</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12></a><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proc_kpt_init</span><span class=p>();</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13></a><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>){</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14></a><span class=w>    </span><span class=n>freeproc</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17></a><span class=p>}</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18></a>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19></a><span class=c1>// 参考 proc_mapstacks</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20></a><span class=c1>// Allocate a page for the process's kernel stack.</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21></a><span class=c1>// Map it high in memory, followed by an invalid</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22></a><span class=c1>// guard page.</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23></a><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>();</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24></a><span class=k>if</span><span class=p>(</span><span class=n>pa</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25></a><span class=w>    </span><span class=n>panic</span><span class=p>(</span><span class=s>"kalloc"</span><span class=p>);</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26></a><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KSTACK</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>proc</span><span class=p>));</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27></a><span class=n>uvmmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>);</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28></a><span class=n>p</span><span class=o>-&gt;</span><span class=n>kstack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va</span><span class=p>;</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29></a>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30></a><span class=p>...</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 需要修改 <code>scheduler()</code> 来加载进程的内核页表到SATP寄存器。参考 <code>kvminithart()</code>。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1>1</a></span>
<span class=normal><a href=#__codelineno-23-2>2</a></span>
<span class=normal><a href=#__codelineno-23-3>3</a></span>
<span class=normal><a href=#__codelineno-23-4>4</a></span>
<span class=normal><a href=#__codelineno-23-5>5</a></span>
<span class=normal><a href=#__codelineno-23-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a><span class=c1>// Store kernel page table to SATP register</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><span class=kt>void</span><span class=w> </span><span class=nf>proc_inithart</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>kpt</span><span class=p>)</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3></a><span class=p>{</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4></a><span class=w>    </span><span class=n>w_satp</span><span class=p>(</span><span class=n>MAKE_SATP</span><span class=p>(</span><span class=n>kpt</span><span class=p>));</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5></a><span class=w>    </span><span class=n>sfence_vma</span><span class=p>();</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>然后在 <code>scheduler()</code>内调用即可，但在结束的时候，需要切换回原先的kernel_pagetable:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1> 1</a></span>
<span class=normal><a href=#__codelineno-24-2> 2</a></span>
<span class=normal><a href=#__codelineno-24-3> 3</a></span>
<span class=normal><a href=#__codelineno-24-4> 4</a></span>
<span class=normal><a href=#__codelineno-24-5> 5</a></span>
<span class=normal><a href=#__codelineno-24-6> 6</a></span>
<span class=normal><a href=#__codelineno-24-7> 7</a></span>
<span class=normal><a href=#__codelineno-24-8> 8</a></span>
<span class=normal><a href=#__codelineno-24-9> 9</a></span>
<span class=normal><a href=#__codelineno-24-10>10</a></span>
<span class=normal><a href=#__codelineno-24-11>11</a></span>
<span class=normal><a href=#__codelineno-24-12>12</a></span>
<span class=normal><a href=#__codelineno-24-13>13</a></span>
<span class=normal><a href=#__codelineno-24-14>14</a></span>
<span class=normal><a href=#__codelineno-24-15>15</a></span>
<span class=normal><a href=#__codelineno-24-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><span class=p>...</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RUNNING</span><span class=p>;</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a><span class=n>c</span><span class=o>-&gt;</span><span class=n>proc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a><span class=c1>// Store the kernal page table into the SATP</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><span class=n>proc_inithart</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>);</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8></a><span class=c1>// 进行上下文切换，把 CPU 控制权交给该进程。</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9></a><span class=n>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10></a>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11></a><span class=c1>// 当进程主动让出 CPU 或被抢占后，控制权回到 scheduler，</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12></a><span class=c1>// 此时再调用 kvminithart()，切回全局内核页表，恢复内核的虚拟内存环境。</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13></a>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14></a><span class=c1>// Switch to the global kernel page table</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15></a><span class=n>kvminithart</span><span class=p>();</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16></a><span class=p>...</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 在 <code>freeproc</code>中释放一个进程的内核页表。首先释放页表内的内核栈，调用<code>uvmunmap</code>可以解除映射，最后的一个参数 <code>do_free</code> 为1的时候，会释放实际内存。再通过<code>proc_freekernelpt</code>释放内核页表。</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1>1</a></span>
<span class=normal><a href=#__codelineno-25-2>2</a></span>
<span class=normal><a href=#__codelineno-25-3>3</a></span>
<span class=normal><a href=#__codelineno-25-4>4</a></span>
<span class=normal><a href=#__codelineno-25-5>5</a></span>
<span class=normal><a href=#__codelineno-25-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><span class=c1>// free the kernel stack in the RAM</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><span class=c1>// uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><span class=n>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kstack</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><span class=n>p</span><span class=o>-&gt;</span><span class=n>kstack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5></a><span class=c1>// 释放进程的内核页表</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6></a><span class=n>proc_freekernelpt</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1> 1</a></span>
<span class=normal><a href=#__codelineno-26-2> 2</a></span>
<span class=normal><a href=#__codelineno-26-3> 3</a></span>
<span class=normal><a href=#__codelineno-26-4> 4</a></span>
<span class=normal><a href=#__codelineno-26-5> 5</a></span>
<span class=normal><a href=#__codelineno-26-6> 6</a></span>
<span class=normal><a href=#__codelineno-26-7> 7</a></span>
<span class=normal><a href=#__codelineno-26-8> 8</a></span>
<span class=normal><a href=#__codelineno-26-9> 9</a></span>
<span class=normal><a href=#__codelineno-26-10>10</a></span>
<span class=normal><a href=#__codelineno-26-11>11</a></span>
<span class=normal><a href=#__codelineno-26-12>12</a></span>
<span class=normal><a href=#__codelineno-26-13>13</a></span>
<span class=normal><a href=#__codelineno-26-14>14</a></span>
<span class=normal><a href=#__codelineno-26-15>15</a></span>
<span class=normal><a href=#__codelineno-26-16>16</a></span>
<span class=normal><a href=#__codelineno-26-17>17</a></span>
<span class=normal><a href=#__codelineno-26-18>18</a></span>
<span class=normal><a href=#__codelineno-26-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><span class=kt>void</span><span class=w> </span><span class=nf>proc_freekernelpt</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>kernelpt</span><span class=p>)</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a><span class=p>{</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a><span class=w>    </span><span class=c1>// similar to the freewalk method</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><span class=w>    </span><span class=c1>// there are 2^9 = 512 PTEs in a page table.</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>512</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7></a><span class=w>        </span><span class=n>pte_t</span><span class=w> </span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kernelpt</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10></a><span class=w>            </span><span class=n>kernelpt</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=n>PTE_R</span><span class=o>|</span><span class=n>PTE_W</span><span class=o>|</span><span class=n>PTE_X</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13></a><span class=w>                </span><span class=n>uint64</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14></a><span class=w>                </span><span class=n>proc_freekernelpt</span><span class=p>((</span><span class=n>pagetable_t</span><span class=p>)</span><span class=n>child</span><span class=p>);</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18></a><span class=w>    </span><span class=n>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>kernelpt</span><span class=p>);</span>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(6) 修改vm.c中的kvmpa，将原先的 <code>kernel_pagetable</code>改成 <code>myproc()-&gt;kernelpt</code>，使用进程的内核页表。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1> 1</a></span>
<span class=normal><a href=#__codelineno-27-2> 2</a></span>
<span class=normal><a href=#__codelineno-27-3> 3</a></span>
<span class=normal><a href=#__codelineno-27-4> 4</a></span>
<span class=normal><a href=#__codelineno-27-5> 5</a></span>
<span class=normal><a href=#__codelineno-27-6> 6</a></span>
<span class=normal><a href=#__codelineno-27-7> 7</a></span>
<span class=normal><a href=#__codelineno-27-8> 8</a></span>
<span class=normal><a href=#__codelineno-27-9> 9</a></span>
<span class=normal><a href=#__codelineno-27-10>10</a></span>
<span class=normal><a href=#__codelineno-27-11>11</a></span>
<span class=normal><a href=#__codelineno-27-12>12</a></span>
<span class=normal><a href=#__codelineno-27-13>13</a></span>
<span class=normal><a href=#__codelineno-27-14>14</a></span>
<span class=normal><a href=#__codelineno-27-15>15</a></span>
<span class=normal><a href=#__codelineno-27-16>16</a></span>
<span class=normal><a href=#__codelineno-27-17>17</a></span>
<span class=normal><a href=#__codelineno-27-18>18</a></span>
<span class=normal><a href=#__codelineno-27-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><span class=c1>// translate a kernel virtual address to</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a><span class=c1>// a physical address. only needed for</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a><span class=c1>// addresses on the stack.</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a><span class=c1>// assumes va is page aligned</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5></a><span class=n>uint64</span><span class=w> </span><span class=nf>kvmpa</span><span class=p>(</span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>)</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6></a><span class=p>{</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>;</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=p>;</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10></a>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11></a><span class=w>    </span><span class=c1>// kernel_pagetable ➡️ myproc()-&gt;kernelpt</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12></a><span class=w>    </span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 改这一句 🏠</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pte</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"kvmpa"</span><span class=p>);</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"kvmpa"</span><span class=p>);</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17></a><span class=w>    </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>pa</span><span class=o>+</span><span class=n>off</span><span class=p>;</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1> 1</a></span>
<span class=normal><a href=#__codelineno-28-2> 2</a></span>
<span class=normal><a href=#__codelineno-28-3> 3</a></span>
<span class=normal><a href=#__codelineno-28-4> 4</a></span>
<span class=normal><a href=#__codelineno-28-5> 5</a></span>
<span class=normal><a href=#__codelineno-28-6> 6</a></span>
<span class=normal><a href=#__codelineno-28-7> 7</a></span>
<span class=normal><a href=#__codelineno-28-8> 8</a></span>
<span class=normal><a href=#__codelineno-28-9> 9</a></span>
<span class=normal><a href=#__codelineno-28-10>10</a></span>
<span class=normal><a href=#__codelineno-28-11>11</a></span>
<span class=normal><a href=#__codelineno-28-12>12</a></span>
<span class=normal><a href=#__codelineno-28-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a>$<span class=w> </span>usertests
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2></a>usertests<span class=w> </span>starting
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3></a><span class=nb>test</span><span class=w> </span>execout:<span class=w> </span><span class=m>2</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4></a>OK
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5></a><span class=nb>test</span><span class=w> </span>copyin:<span class=w> </span>OK
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6></a><span class=nb>test</span><span class=w> </span>copyout:<span class=w> </span>OK
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7></a><span class=nb>test</span><span class=w> </span>bigfile:<span class=w> </span>OK
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8></a>...
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9></a><span class=nb>test</span><span class=w> </span>dirfile:<span class=w> </span>OK
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10></a><span class=nb>test</span><span class=w> </span>iref:<span class=w> </span>OK
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11></a><span class=nb>test</span><span class=w> </span>forktest:<span class=w> </span>OK
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12></a><span class=nb>test</span><span class=w> </span>bigdir:<span class=w> </span>OK
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13></a>ALL<span class=w> </span>TESTS<span class=w> </span>PASSED
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Simplify copyin/copyinstr</p> <blockquote> <p>本实验是实现将用户空间的映射添加到每个进程的内核页表，将进程的页表复制一份到进程的内核页表即可。</p> </blockquote> <p>(1) 添加复制函数 <code>u2kvmcopy</code>。需要注意的是，在内核模式下，无法访问设置了PTE_U的页面，所以我们要将其移除。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1> 1</a></span>
<span class=normal><a href=#__codelineno-29-2> 2</a></span>
<span class=normal><a href=#__codelineno-29-3> 3</a></span>
<span class=normal><a href=#__codelineno-29-4> 4</a></span>
<span class=normal><a href=#__codelineno-29-5> 5</a></span>
<span class=normal><a href=#__codelineno-29-6> 6</a></span>
<span class=normal><a href=#__codelineno-29-7> 7</a></span>
<span class=normal><a href=#__codelineno-29-8> 8</a></span>
<span class=normal><a href=#__codelineno-29-9> 9</a></span>
<span class=normal><a href=#__codelineno-29-10>10</a></span>
<span class=normal><a href=#__codelineno-29-11>11</a></span>
<span class=normal><a href=#__codelineno-29-12>12</a></span>
<span class=normal><a href=#__codelineno-29-13>13</a></span>
<span class=normal><a href=#__codelineno-29-14>14</a></span>
<span class=normal><a href=#__codelineno-29-15>15</a></span>
<span class=normal><a href=#__codelineno-29-16>16</a></span>
<span class=normal><a href=#__codelineno-29-17>17</a></span>
<span class=normal><a href=#__codelineno-29-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><span class=kt>void</span><span class=w> </span><span class=nf>u2kvmcopy</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>pagetable_t</span><span class=w> </span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>oldsz</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>newsz</span><span class=p>)</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2></a><span class=p>{</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte_from</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>pte_to</span><span class=p>;</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4></a><span class=w>    </span><span class=n>oldsz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>);</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldsz</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>newsz</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte_from</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"u2kvmcopy: src pte does not exist"</span><span class=p>);</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte_to</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"u2kvmcopy: pte walk failed"</span><span class=p>);</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11></a><span class=w>        </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte_from</span><span class=p>);</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12></a><span class=w>        </span><span class=n>uint</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte_from</span><span class=p>))</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>PTE_U</span><span class=p>);</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13></a><span class=w>        </span><span class=c1>// PTE_FLAGS(*pte_from)：获取用户页表页表项的标志位</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14></a><span class=w>        </span><span class=c1>// &amp; (~PTE_U)：清除 PTE_U 标志位</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15></a><span class=w>        </span><span class=c1>// 因为在内核模式下，无法访问设置了PTE_U的页面</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16></a><span class=w>        </span><span class=o>*</span><span class=n>pte_to</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PA2PTE</span><span class=p>(</span><span class=n>pa</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在内核更改进程的用户映射的每一处 （<code>fork()</code>, <code>exec()</code>, <code>sbrk()</code>和<code>userinit()</code>），都复制一份到进程的内核页表。</p> <p>exec():</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1> 1</a></span>
<span class=normal><a href=#__codelineno-30-2> 2</a></span>
<span class=normal><a href=#__codelineno-30-3> 3</a></span>
<span class=normal><a href=#__codelineno-30-4> 4</a></span>
<span class=normal><a href=#__codelineno-30-5> 5</a></span>
<span class=normal><a href=#__codelineno-30-6> 6</a></span>
<span class=normal><a href=#__codelineno-30-7> 7</a></span>
<span class=normal><a href=#__codelineno-30-8> 8</a></span>
<span class=normal><a href=#__codelineno-30-9> 9</a></span>
<span class=normal><a href=#__codelineno-30-10>10</a></span>
<span class=normal><a href=#__codelineno-30-11>11</a></span>
<span class=normal><a href=#__codelineno-30-12>12</a></span>
<span class=normal><a href=#__codelineno-30-13>13</a></span>
<span class=normal><a href=#__codelineno-30-14>14</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1></a><span class=kt>int</span><span class=w> </span><span class=nf>exec</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2></a><span class=p>{</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4></a><span class=w>    </span><span class=n>sp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5></a><span class=w>    </span><span class=n>stackbase</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>;</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6></a>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7></a><span class=w>    </span><span class=c1>// =========== solution for pgtbl ---- part 3 =============</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8></a><span class=w>    </span><span class=n>u2kvmcopy</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>);</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9></a><span class=w>    </span><span class=c1>// =================添加复制逻辑============================</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10></a>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11></a><span class=w>    </span><span class=c1>// Push argument strings, prepare rest of stack in ustack.</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=p>];</span><span class=w> </span><span class=n>argc</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>fork():</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-1> 1</a></span>
<span class=normal><a href=#__codelineno-31-2> 2</a></span>
<span class=normal><a href=#__codelineno-31-3> 3</a></span>
<span class=normal><a href=#__codelineno-31-4> 4</a></span>
<span class=normal><a href=#__codelineno-31-5> 5</a></span>
<span class=normal><a href=#__codelineno-31-6> 6</a></span>
<span class=normal><a href=#__codelineno-31-7> 7</a></span>
<span class=normal><a href=#__codelineno-31-8> 8</a></span>
<span class=normal><a href=#__codelineno-31-9> 9</a></span>
<span class=normal><a href=#__codelineno-31-10>10</a></span>
<span class=normal><a href=#__codelineno-31-11>11</a></span>
<span class=normal><a href=#__codelineno-31-12>12</a></span>
<span class=normal><a href=#__codelineno-31-13>13</a></span>
<span class=normal><a href=#__codelineno-31-14>14</a></span>
<span class=normal><a href=#__codelineno-31-15>15</a></span>
<span class=normal><a href=#__codelineno-31-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1></a><span class=kt>int</span><span class=w> </span><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2></a><span class=p>{</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4></a><span class=w>    </span><span class=c1>// Copy user memory from parent to child.</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>uvmcopy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>){</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6></a><span class=w>        </span><span class=n>freeproc</span><span class=p>(</span><span class=n>np</span><span class=p>);</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10></a><span class=w>    </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12></a><span class=w>    </span><span class=c1>// =========== solution for pgtbl ---- part 3 =============</span>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13></a><span class=w>    </span><span class=n>u2kvmcopy</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>np</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>);</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14></a><span class=w>    </span><span class=c1>// ================复制到新进程的内核页表====================</span>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>sbrk():</p> <p>在<code>kernel/sysproc.c</code>里面找到<code>sys_sbrk(void)</code>，可以知道只有<code>growproc</code>是负责将用户内存增加或缩小 n 个字节。以防止用户进程增长到超过PLIC的地址，我们需要给它加个限制。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1> 1</a></span>
<span class=normal><a href=#__codelineno-32-2> 2</a></span>
<span class=normal><a href=#__codelineno-32-3> 3</a></span>
<span class=normal><a href=#__codelineno-32-4> 4</a></span>
<span class=normal><a href=#__codelineno-32-5> 5</a></span>
<span class=normal><a href=#__codelineno-32-6> 6</a></span>
<span class=normal><a href=#__codelineno-32-7> 7</a></span>
<span class=normal><a href=#__codelineno-32-8> 8</a></span>
<span class=normal><a href=#__codelineno-32-9> 9</a></span>
<span class=normal><a href=#__codelineno-32-10>10</a></span>
<span class=normal><a href=#__codelineno-32-11>11</a></span>
<span class=normal><a href=#__codelineno-32-12>12</a></span>
<span class=normal><a href=#__codelineno-32-13>13</a></span>
<span class=normal><a href=#__codelineno-32-14>14</a></span>
<span class=normal><a href=#__codelineno-32-15>15</a></span>
<span class=normal><a href=#__codelineno-32-16>16</a></span>
<span class=normal><a href=#__codelineno-32-17>17</a></span>
<span class=normal><a href=#__codelineno-32-18>18</a></span>
<span class=normal><a href=#__codelineno-32-19>19</a></span>
<span class=normal><a href=#__codelineno-32-20>20</a></span>
<span class=normal><a href=#__codelineno-32-21>21</a></span>
<span class=normal><a href=#__codelineno-32-22>22</a></span>
<span class=normal><a href=#__codelineno-32-23>23</a></span>
<span class=normal><a href=#__codelineno-32-24>24</a></span>
<span class=normal><a href=#__codelineno-32-25>25</a></span>
<span class=normal><a href=#__codelineno-32-26>26</a></span>
<span class=normal><a href=#__codelineno-32-27>27</a></span>
<span class=normal><a href=#__codelineno-32-28>28</a></span>
<span class=normal><a href=#__codelineno-32-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1></a><span class=kt>int</span><span class=w> </span><span class=nf>growproc</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>)</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2></a><span class=p>{</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5></a>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6></a><span class=w>    </span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9></a><span class=w>        </span><span class=c1>// =========== solution for pgtbl ---- part 3 ==========</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>PLIC</span><span class=p>)</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14></a><span class=w>        </span><span class=c1>// ===================加上PLIC限制=======================</span>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uvmalloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19></a><span class=w>        </span><span class=c1>// =========== solution for pgtbl ---- part 3 =============</span>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20></a><span class=w>        </span><span class=n>u2kvmcopy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>);</span>
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21></a><span class=w>        </span><span class=c1>// ===================复制一份到内核页表=====================</span>
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-32-23><a id=__codelineno-32-23 name=__codelineno-32-23></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-32-24><a id=__codelineno-32-24 name=__codelineno-32-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-32-25><a id=__codelineno-32-25 name=__codelineno-32-25></a><span class=w>        </span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uvmdealloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-32-26><a id=__codelineno-32-26 name=__codelineno-32-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-32-27><a id=__codelineno-32-27 name=__codelineno-32-27></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-32-28><a id=__codelineno-32-28 name=__codelineno-32-28></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-32-29><a id=__codelineno-32-29 name=__codelineno-32-29></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>userinit():</p> <blockquote> <p>不要忘记在userinit的内核页表中包含第一个进程的用户页表</p> </blockquote> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-33-1> 1</a></span>
<span class=normal><a href=#__codelineno-33-2> 2</a></span>
<span class=normal><a href=#__codelineno-33-3> 3</a></span>
<span class=normal><a href=#__codelineno-33-4> 4</a></span>
<span class=normal><a href=#__codelineno-33-5> 5</a></span>
<span class=normal><a href=#__codelineno-33-6> 6</a></span>
<span class=normal><a href=#__codelineno-33-7> 7</a></span>
<span class=normal><a href=#__codelineno-33-8> 8</a></span>
<span class=normal><a href=#__codelineno-33-9> 9</a></span>
<span class=normal><a href=#__codelineno-33-10>10</a></span>
<span class=normal><a href=#__codelineno-33-11>11</a></span>
<span class=normal><a href=#__codelineno-33-12>12</a></span>
<span class=normal><a href=#__codelineno-33-13>13</a></span>
<span class=normal><a href=#__codelineno-33-14>14</a></span>
<span class=normal><a href=#__codelineno-33-15>15</a></span>
<span class=normal><a href=#__codelineno-33-16>16</a></span>
<span class=normal><a href=#__codelineno-33-17>17</a></span>
<span class=normal><a href=#__codelineno-33-18>18</a></span>
<span class=normal><a href=#__codelineno-33-19>19</a></span>
<span class=normal><a href=#__codelineno-33-20>20</a></span>
<span class=normal><a href=#__codelineno-33-21>21</a></span>
<span class=normal><a href=#__codelineno-33-22>22</a></span>
<span class=normal><a href=#__codelineno-33-23>23</a></span>
<span class=normal><a href=#__codelineno-33-24>24</a></span>
<span class=normal><a href=#__codelineno-33-25>25</a></span>
<span class=normal><a href=#__codelineno-33-26>26</a></span>
<span class=normal><a href=#__codelineno-33-27>27</a></span>
<span class=normal><a href=#__codelineno-33-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1></a><span class=c1>// Set up first user process.</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2></a><span class=kt>void</span><span class=w> </span><span class=nf>userinit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3></a><span class=p>{</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5></a>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6></a><span class=w>    </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>allocproc</span><span class=p>();</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7></a><span class=w>    </span><span class=n>initproc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8></a>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9></a><span class=w>    </span><span class=c1>// allocate one user page and copy init's instructions</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10></a><span class=w>    </span><span class=c1>// and data into it.</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11></a><span class=w>    </span><span class=n>uvminit</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>initcode</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>initcode</span><span class=p>));</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>;</span>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13></a>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14></a><span class=w>    </span><span class=c1>// prepare for the very first "return" from kernel to user.</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>      </span><span class=c1>// user program counter</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>;</span><span class=w>  </span><span class=c1>// user stack pointer</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17></a>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18></a><span class=w>    </span><span class=n>safestrcpy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s>"initcode"</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>namei</span><span class=p>(</span><span class=s>"/"</span><span class=p>);</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20></a>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RUNNABLE</span><span class=p>;</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22></a>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23></a><span class=w>    </span><span class=c1>// =========== solution for pgtbl ---- part 3 =============</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24></a><span class=w>    </span><span class=n>u2kvmcopy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>);</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25></a><span class=w>    </span><span class=c1>// ========================================================</span>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26></a>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-33-28><a id=__codelineno-33-28 name=__codelineno-33-28></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 替换掉原有的copyin()和copyinstr()</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-1>1</a></span>
<span class=normal><a href=#__codelineno-34-2>2</a></span>
<span class=normal><a href=#__codelineno-34-3>3</a></span>
<span class=normal><a href=#__codelineno-34-4>4</a></span>
<span class=normal><a href=#__codelineno-34-5>5</a></span>
<span class=normal><a href=#__codelineno-34-6>6</a></span>
<span class=normal><a href=#__codelineno-34-7>7</a></span>
<span class=normal><a href=#__codelineno-34-8>8</a></span>
<span class=normal><a href=#__codelineno-34-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1></a><span class=kt>int</span><span class=w> </span><span class=nf>copyin</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>dst</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>srcva</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2></a><span class=p>{</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>copyin_new</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>dst</span><span class=p>,</span><span class=w> </span><span class=n>srcva</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>);</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4></a><span class=p>}</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5></a>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6></a><span class=kt>int</span><span class=w> </span><span class=nf>copyinstr</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>dst</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>srcva</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>max</span><span class=p>)</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7></a><span class=p>{</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>copyinstr_new</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>dst</span><span class=p>,</span><span class=w> </span><span class=n>srcva</span><span class=p>,</span><span class=w> </span><span class=n>max</span><span class=p>);</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 添加函数声明到 kernel/defs.h 中</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-1>1</a></span>
<span class=normal><a href=#__codelineno-35-2>2</a></span>
<span class=normal><a href=#__codelineno-35-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1></a><span class=kt>int</span><span class=w>             </span><span class=nf>copyin_new</span><span class=p>(</span><span class=n>pagetable_t</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=p>);</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2></a><span class=kt>int</span><span class=w>             </span><span class=nf>copyinstr_new</span><span class=p>(</span><span class=n>pagetable_t</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=p>);</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3></a><span class=kt>void</span><span class=w>            </span><span class=nf>u2kvmcopy</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>pagetable_t</span><span class=w> </span><span class=n>kernelpt</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>oldsz</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>newsz</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-36-1> 1</a></span>
<span class=normal><a href=#__codelineno-36-2> 2</a></span>
<span class=normal><a href=#__codelineno-36-3> 3</a></span>
<span class=normal><a href=#__codelineno-36-4> 4</a></span>
<span class=normal><a href=#__codelineno-36-5> 5</a></span>
<span class=normal><a href=#__codelineno-36-6> 6</a></span>
<span class=normal><a href=#__codelineno-36-7> 7</a></span>
<span class=normal><a href=#__codelineno-36-8> 8</a></span>
<span class=normal><a href=#__codelineno-36-9> 9</a></span>
<span class=normal><a href=#__codelineno-36-10>10</a></span>
<span class=normal><a href=#__codelineno-36-11>11</a></span>
<span class=normal><a href=#__codelineno-36-12>12</a></span>
<span class=normal><a href=#__codelineno-36-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1></a>$<span class=w> </span>make<span class=w> </span><span class=nv>grade</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span><span class=nv>copyin</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3></a>usertests:<span class=w> </span>copyin:<span class=w> </span><span class=nv>OK</span><span class=w> </span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span><span class=nv>copyinstr1</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5></a>usertests:<span class=w> </span>copyinstr1:<span class=w> </span><span class=nv>OK</span><span class=w> </span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span><span class=nv>copyinstr2</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7></a>usertests:<span class=w> </span>copyinstr2:<span class=w> </span><span class=nv>OK</span><span class=w> </span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span><span class=nv>copyinstr3</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9></a>usertests:<span class=w> </span>copyinstr3:<span class=w> </span><span class=nv>OK</span><span class=w> </span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span><span class=nv>sbrkmuch</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11></a>usertests:<span class=w> </span>sbrkmuch:<span class=w> </span><span class=nv>OK</span><span class=w> </span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12></a><span class=o>==</span><span class=w> </span>Test<span class=w>   </span>usertests:<span class=w> </span>all<span class=w> </span><span class=nv>tests</span><span class=w> </span><span class=o>==</span><span class=w> </span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13></a>usertests:<span class=w> </span>all<span class=w> </span>tests:<span class=w> </span>OK<span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lect6-isolation-system-call-entryexit>Lect6 Isolation &amp; system call entry/exit<a class=headerlink href=#lect6-isolation-system-call-entryexit title="Permanent link">¶</a></h2> <ol> <li> <p>一些寄存器：</p> <ul> <li>SATP（Supervisor Address Translation and Protection）寄存器：它包含了指向page table的物理内存地址。</li> <li>STVEC（Supervisor Trap Vector Base Address Register）寄存器：它指向了内核中处理trap的指令的起始地址。它会保存当trap，page fault或者中断发生时，CPU运行的用户程序的程序计数器，这样才能在稍后恢复程序的运行。</li> <li>SEPC（Supervisor Exception Program Counter）寄存器：在trap的过程中保存用户代码的程序计数器的值。</li> <li>SSRATCH（Supervisor Scratch Register）寄存器：在进入到user space之前，内核会将trapframe page的地址保存在这个寄存器中，也就是0x3fffffe000这个地址。</li> <li>STVAL寄存器: 触发page fault的的虚拟内存地址。</li> <li>SIE（Supervisor Interrupt Enable）寄存器：这个寄存器中有一个bit（E）专门针对例如UART的外部设备的中断；有一个bit（S）专门针对软件中断，软件中断可能由一个CPU核触发给另一个CPU核；还有一个bit（T）专门针对定时器中断。我们这节课只关注外部设备的中断。</li> <li>SSTATUS（Supervisor Status）寄存器：这个寄存器中有一个bit来打开或者关闭中断。每一个CPU核都有独立的SIE和SSTATUS寄存器，除了通过SIE寄存器来单独控制特定的中断，还可以通过SSTATUS寄存器中的一个bit来控制所有的中断。</li> <li>SIP（Supervisor Interrupt Pending）寄存器：当发生中断时，处理器可以通过查看这个寄存器知道当前是什么类型的中断。</li> <li>SCAUSE寄存器：它会表明当前状态的原因是中断。</li> <li><code>csrrw a0,sscratch,a0</code>：这条指令将a0的数据保存在了sscratch中，同时又将sscratch内的数据保存在a0中，之后内核就可以任意的使用a0寄存器了。</li> <li><code>sret</code> 指令是由RISC-V定义的用来从supervisor mode转换到user mode。</li> <li><code>sfence.vma</code>：清空页表缓存。</li> </ul> </li> <li> <p>ecall实际上只会改变三件事情：</p> <ul> <li>ecall将代码从user mode改到supervisor mode。</li> <li>ecall将用户代码的程序计数器的值保存在了SEPC寄存器。</li> <li>ecall会跳转到STVEC寄存器指向的指令，即内核中处理trap的指令的起始地址。</li> </ul> </li> <li> <p>sret是我们在kernel中的最后一条指令，当我执行完这条指令：</p> <ul> <li>程序会切换回user mode</li> <li>SEPC寄存器的数值会被拷贝到PC寄存器（程序计数器）</li> <li>重新打开中断</li> </ul> </li> </ol> <h2 id=lab4-traps>Lab4: Traps<a class=headerlink href=#lab4-traps title="Permanent link">¶</a></h2> <ol> <li> <p>RISC-V assembly</p> <p>xv6仓库中有一个文件user/call.c。执行make fs.img编译它，并在user/call.asm中生成可读的汇编版本。</p> <p>call.c:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-37-1> 1</a></span>
<span class=normal><a href=#__codelineno-37-2> 2</a></span>
<span class=normal><a href=#__codelineno-37-3> 3</a></span>
<span class=normal><a href=#__codelineno-37-4> 4</a></span>
<span class=normal><a href=#__codelineno-37-5> 5</a></span>
<span class=normal><a href=#__codelineno-37-6> 6</a></span>
<span class=normal><a href=#__codelineno-37-7> 7</a></span>
<span class=normal><a href=#__codelineno-37-8> 8</a></span>
<span class=normal><a href=#__codelineno-37-9> 9</a></span>
<span class=normal><a href=#__codelineno-37-10>10</a></span>
<span class=normal><a href=#__codelineno-37-11>11</a></span>
<span class=normal><a href=#__codelineno-37-12>12</a></span>
<span class=normal><a href=#__codelineno-37-13>13</a></span>
<span class=normal><a href=#__codelineno-37-14>14</a></span>
<span class=normal><a href=#__codelineno-37-15>15</a></span>
<span class=normal><a href=#__codelineno-37-16>16</a></span>
<span class=normal><a href=#__codelineno-37-17>17</a></span>
<span class=normal><a href=#__codelineno-37-18>18</a></span>
<span class=normal><a href=#__codelineno-37-19>19</a></span>
<span class=normal><a href=#__codelineno-37-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/param.h"</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/types.h"</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"kernel/stat.h"</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4></a><span class=cp>#include</span><span class=w> </span><span class=cpf>"user/user.h"</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5></a>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6></a><span class=kt>int</span><span class=w> </span><span class=nf>g</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7></a><span class=p>{</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=o>+</span><span class=mi>3</span><span class=p>;</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9></a><span class=p>}</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10></a>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11></a><span class=kt>int</span><span class=w> </span><span class=nf>f</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12></a><span class=p>{</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>g</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14></a><span class=p>}</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15></a>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16></a><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17></a><span class=p>{</span>
</span><span id=__span-37-18><a id=__codelineno-37-18 name=__codelineno-37-18></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"%d %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>13</span><span class=p>);</span>
</span><span id=__span-37-19><a id=__codelineno-37-19 name=__codelineno-37-19></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-37-20><a id=__codelineno-37-20 name=__codelineno-37-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(1) 哪些寄存器保存函数的参数？例如，在main对printf的调用中，哪个寄存器保存13？</p> <p>➡️ 在a0-a7中存放参数，13存放在a2中: <code>li a2,13</code>, li是 load immediate 的缩写，即立即数加载指令，它的作用是将一个立即数加载到指定的寄存器中。</p> <p>(2) main的汇编代码中对函数f的调用在哪里？对g的调用在哪里(提示：编译器可能会将函数内联)</p> <p>➡️ 在生成的汇编中，main函数进行了内联优化处理，从代码<code>li a1,12</code>可以看出，main直接计算出了结果并储存。</p> <p>(3) printf函数位于哪个地址？</p> <p>➡️ 在0x628: <code>34: 5f8080e7 jalr 1528(ra) # 628 &lt;printf&gt;</code></p> <p>(4) 在main中printf的jalr之后的寄存器ra中有什么值？</p> <p>➡️ 执行此行代码后，将跳转到printf函数执行，并将PC+4=0x34+0x4=0x38保存到ra中，供之后返回使用。</p> <p>(5) 运行以下代码，程序的输出是什么？</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-38-1>1</a></span>
<span class=normal><a href=#__codelineno-38-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1></a><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x00646c72</span><span class=p>;</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2></a><span class=n>printf</span><span class=p>(</span><span class=s>"H%x Wo%s"</span><span class=p>,</span><span class=w> </span><span class=mi>57616</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>i</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>➡️ 57616=0xE110，0x00646c72小端存储为72-6c-64-00，对照ASCII码表，72:r 6c:l 64:d 00:充当字符串结尾标识，因此输出为HE110 World</p> <p>(6) 在下面的代码中，“y=”之后将打印什么(注：答案不是一个特定的值)？为什么会发生这种情况？</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-39-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1></a><span class=n>printf</span><span class=p>(</span><span class=s>"x=%d y=%d"</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>➡️ 原本需要两个参数，却只传入了一个，因此y=后面打印的结果取决于之前a2中保存的数据</p> </li> <li> <p>Backtrace</p> <p>(1) 在<code>kernel/defs.h</code>添加函数原型：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-40-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1></a><span class=kt>void</span><span class=w>            </span><span class=nf>backtrace</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在<code>kernel/riscv.h</code>添加<code>r_fp</code>来读取当前正在执行的函数的帧指针(保存在s0寄存器)：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-41-1>1</a></span>
<span class=normal><a href=#__codelineno-41-2>2</a></span>
<span class=normal><a href=#__codelineno-41-3>3</a></span>
<span class=normal><a href=#__codelineno-41-4>4</a></span>
<span class=normal><a href=#__codelineno-41-5>5</a></span>
<span class=normal><a href=#__codelineno-41-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1></a><span class=k>static</span><span class=w> </span><span class=kr>inline</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=nf>r_fp</span><span class=p>()</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2></a><span class=p>{</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4></a><span class=w>    </span><span class=k>asm</span><span class=w> </span><span class=k>volatile</span><span class=p>(</span><span class=s>"mv %0, s0"</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s>"=r"</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>);</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 在<code>kernel/printf.c</code>中添加<code>backtrace</code>函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-42-1> 1</a></span>
<span class=normal><a href=#__codelineno-42-2> 2</a></span>
<span class=normal><a href=#__codelineno-42-3> 3</a></span>
<span class=normal><a href=#__codelineno-42-4> 4</a></span>
<span class=normal><a href=#__codelineno-42-5> 5</a></span>
<span class=normal><a href=#__codelineno-42-6> 6</a></span>
<span class=normal><a href=#__codelineno-42-7> 7</a></span>
<span class=normal><a href=#__codelineno-42-8> 8</a></span>
<span class=normal><a href=#__codelineno-42-9> 9</a></span>
<span class=normal><a href=#__codelineno-42-10>10</a></span>
<span class=normal><a href=#__codelineno-42-11>11</a></span>
<span class=normal><a href=#__codelineno-42-12>12</a></span>
<span class=normal><a href=#__codelineno-42-13>13</a></span>
<span class=normal><a href=#__codelineno-42-14>14</a></span>
<span class=normal><a href=#__codelineno-42-15>15</a></span>
<span class=normal><a href=#__codelineno-42-16>16</a></span>
<span class=normal><a href=#__codelineno-42-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1></a><span class=cm>/**</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2></a><span class=cm>* @brief backtrace 回溯函数调用的返回地址</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3></a><span class=cm>*/</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4></a><span class=kt>void</span><span class=w> </span><span class=nf>backtrace</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5></a><span class=p>{</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"backtrace:</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7></a><span class=w>    </span><span class=c1>// 读取当前帧指针</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>fp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_fp</span><span class=p>();</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11></a><span class=w>        </span><span class=c1>// 返回地址保存在-8偏移的位置</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12></a><span class=w>        </span><span class=n>uint64</span><span class=w> </span><span class=n>ret_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=n>uint64</span><span class=o>*</span><span class=p>)(</span><span class=n>fp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>8</span><span class=p>);</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%p</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>ret_addr</span><span class=p>);</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14></a><span class=w>        </span><span class=c1>// 前一个帧指针保存在-16偏移的位置</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15></a><span class=w>        </span><span class=n>fp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=n>uint64</span><span class=o>*</span><span class=p>)(</span><span class=n>fp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>16</span><span class=p>);</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>注意返回地址位于栈帧帧指针的固定偏移(-8)位置，并且保存的上一个栈帧的帧指针位于当前帧指针的固定偏移(-16)位置。XV6在内核中以页面对齐的地址为每个栈分配一个页面，通过PGROUNDDOWN(fp)和PGROUNDUP(fp)来计算栈页面的顶部和底部地址。</p> <p><img alt="alt text" src=../../img/image-65.png></p> <p>(4) 在<code>sys_sleep(void)</code>中调用<code>backtrace</code>，输出：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-43-1>1</a></span>
<span class=normal><a href=#__codelineno-43-2>2</a></span>
<span class=normal><a href=#__codelineno-43-3>3</a></span>
<span class=normal><a href=#__codelineno-43-4>4</a></span>
<span class=normal><a href=#__codelineno-43-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1></a>$<span class=w> </span>bttest
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2></a>backtrace:
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3></a>0x0000000080002cd6
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4></a>0x0000000080002bb2
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5></a>0x000000008000289c
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Alarm</p> <p>程序计数器的过程是这样的：</p> <ul> <li><code>ecall</code>指令中将<code>PC</code>保存到<code>SEPC</code></li> <li>在<code>usertrap</code>中将<code>SEPC</code>保存到<code>p-&gt;trapframe-&gt;epc</code></li> <li><code>p-&gt;trapframe-&gt;epc</code>加4指向下一条指令</li> <li>执行系统调用</li> <li>在<code>usertrapret</code>中将<code>SEPC</code>改写为<code>p-&gt;trapframe-&gt;epc</code>中的值</li> <li>在<code>sret</code>中将<code>PC</code>设置为<code>SEPC</code>的值</li> </ul> <p>可见执行系统调用后返回到用户空间继续执行的指令地址是由<code>p-&gt;trapframe-&gt;epc</code>决定的，因此在<code>usertrap</code>中主要就是完成它的设置工作。</p> <p>另外要解决的主要问题是寄存器保存恢复和防止重复执行的问题，考虑一下没有<code>alarm</code>时运行的大致过程：</p> <ul> <li>进入内核空间，保存用户寄存器到进程陷阱帧</li> <li>陷阱处理过程</li> <li>恢复用户寄存器，返回用户空间</li> </ul> <p>而当添加了<code>alarm</code>后，变成了以下过程：</p> <ul> <li>进入内核空间，保存用户寄存器到进程陷阱帧</li> <li>陷阱处理过程</li> <li>恢复用户寄存器，返回用户空间，但此时返回的并不是进入陷阱时的程序地址，而是处理函数<code>handler</code>的地址，而<code>handler</code>可能会改变用户寄存器</li> </ul> <p>因此我们要在<code>usertrap</code>中再次保存用户寄存器，当<code>handler</code>调用<code>sigreturn</code>时将其恢复，并且要防止在<code>handler</code>执行过程中重复调用:</p> <p>(1) Makefile 里添加 <code>$U/_alarmtest\</code>, usys.pl里添加:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-44-1>1</a></span>
<span class=normal><a href=#__codelineno-44-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1></a><span class=n>entry</span><span class=p>(</span><span class=s>"sigalarm"</span><span class=p>);</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2></a><span class=n>entry</span><span class=p>(</span><span class=s>"sigreturn"</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>user.h里添加函数原型：</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-45-1>1</a></span>
<span class=normal><a href=#__codelineno-45-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1></a><span class=kt>int</span><span class=w> </span><span class=nf>sigalarm</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>ticks</span><span class=p>,</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>handler</span><span class=p>)());</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2></a><span class=kt>int</span><span class=w> </span><span class=nf>sigreturn</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在struct proc中增加字段:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-46-1>1</a></span>
<span class=normal><a href=#__codelineno-46-2>2</a></span>
<span class=normal><a href=#__codelineno-46-3>3</a></span>
<span class=normal><a href=#__codelineno-46-4>4</a></span>
<span class=normal><a href=#__codelineno-46-5>5</a></span>
<span class=normal><a href=#__codelineno-46-6>6</a></span>
<span class=normal><a href=#__codelineno-46-7>7</a></span>
<span class=normal><a href=#__codelineno-46-8>8</a></span>
<span class=normal><a href=#__codelineno-46-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1></a><span class=c1>// Per-process state</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2></a><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>alarm_interval</span><span class=p>;</span><span class=w>                 </span><span class=c1>// 报警间隔</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>alarm_handler</span><span class=p>)();</span><span class=w>            </span><span class=c1>// 报警处理函数</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ticks_count</span><span class=p>;</span><span class=w>                    </span><span class=c1>// 两次报警间的滴答计数</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>is_alarming</span><span class=p>;</span><span class=w>                    </span><span class=c1>// 是否正在执行告警处理函数</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>trapframe</span><span class=o>*</span><span class=w> </span><span class=n>alarm_trapframe</span><span class=p>;</span><span class=w>  </span><span class=c1>// 告警陷阱帧</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 添加<code>sys_sigalarm</code>读取参数，添加<code>sys_sigreturn</code>恢复陷阱帧:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-47-1> 1</a></span>
<span class=normal><a href=#__codelineno-47-2> 2</a></span>
<span class=normal><a href=#__codelineno-47-3> 3</a></span>
<span class=normal><a href=#__codelineno-47-4> 4</a></span>
<span class=normal><a href=#__codelineno-47-5> 5</a></span>
<span class=normal><a href=#__codelineno-47-6> 6</a></span>
<span class=normal><a href=#__codelineno-47-7> 7</a></span>
<span class=normal><a href=#__codelineno-47-8> 8</a></span>
<span class=normal><a href=#__codelineno-47-9> 9</a></span>
<span class=normal><a href=#__codelineno-47-10>10</a></span>
<span class=normal><a href=#__codelineno-47-11>11</a></span>
<span class=normal><a href=#__codelineno-47-12>12</a></span>
<span class=normal><a href=#__codelineno-47-13>13</a></span>
<span class=normal><a href=#__codelineno-47-14>14</a></span>
<span class=normal><a href=#__codelineno-47-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_sigalarm</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2></a><span class=p>{</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>alarm_interval</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4></a><span class=w>        </span><span class=n>argaddr</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>alarm_handler</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6></a>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8></a><span class=p>}</span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9></a>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_sigreturn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11></a><span class=p>{</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12></a><span class=w>    </span><span class=n>memmove</span><span class=p>(</span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>,</span><span class=w> </span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>trapframe</span><span class=p>));</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13></a><span class=w>    </span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>is_alarming</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改usertrap()</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-48-1> 1</a></span>
<span class=normal><a href=#__codelineno-48-2> 2</a></span>
<span class=normal><a href=#__codelineno-48-3> 3</a></span>
<span class=normal><a href=#__codelineno-48-4> 4</a></span>
<span class=normal><a href=#__codelineno-48-5> 5</a></span>
<span class=normal><a href=#__codelineno-48-6> 6</a></span>
<span class=normal><a href=#__codelineno-48-7> 7</a></span>
<span class=normal><a href=#__codelineno-48-8> 8</a></span>
<span class=normal><a href=#__codelineno-48-9> 9</a></span>
<span class=normal><a href=#__codelineno-48-10>10</a></span>
<span class=normal><a href=#__codelineno-48-11>11</a></span>
<span class=normal><a href=#__codelineno-48-12>12</a></span>
<span class=normal><a href=#__codelineno-48-13>13</a></span>
<span class=normal><a href=#__codelineno-48-14>14</a></span>
<span class=normal><a href=#__codelineno-48-15>15</a></span>
<span class=normal><a href=#__codelineno-48-16>16</a></span>
<span class=normal><a href=#__codelineno-48-17>17</a></span>
<span class=normal><a href=#__codelineno-48-18>18</a></span>
<span class=normal><a href=#__codelineno-48-19>19</a></span>
<span class=normal><a href=#__codelineno-48-20>20</a></span>
<span class=normal><a href=#__codelineno-48-21>21</a></span>
<span class=normal><a href=#__codelineno-48-22>22</a></span>
<span class=normal><a href=#__codelineno-48-23>23</a></span>
<span class=normal><a href=#__codelineno-48-24>24</a></span>
<span class=normal><a href=#__codelineno-48-25>25</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1></a><span class=c1>//</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2></a><span class=c1>// handle an interrupt, exception, or system call from user space.</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3></a><span class=c1>// called from trampoline.S</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4></a><span class=c1>//</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5></a><span class=kt>void</span><span class=w> </span><span class=nf>usertrap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6></a><span class=p>{</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8></a>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9></a><span class=w>    </span><span class=c1>// give up the CPU if this is a timer interrupt.</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>which_dev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_interval</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>++</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ticks_count</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_interval</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>is_alarming</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14></a><span class=w>            </span><span class=c1>// 保存寄存器内容</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15></a><span class=w>            </span><span class=n>memmove</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>trapframe</span><span class=p>));</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16></a><span class=w>            </span><span class=c1>// 更改陷阱帧中保留的程序计数器，注意一定要在保存寄存器内容后再设置epc</span>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_handler</span><span class=p>;</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ticks_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>is_alarming</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21></a><span class=w>        </span><span class=n>yield</span><span class=p>();</span>
</span><span id=__span-48-22><a id=__codelineno-48-22 name=__codelineno-48-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-48-23><a id=__codelineno-48-23 name=__codelineno-48-23></a>
</span><span id=__span-48-24><a id=__codelineno-48-24 name=__codelineno-48-24></a><span class=w>    </span><span class=n>usertrapret</span><span class=p>();</span>
</span><span id=__span-48-25><a id=__codelineno-48-25 name=__codelineno-48-25></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 在<code>allocproc</code>和<code>freeproc</code>中设定好相关分配，回收内存的代码:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-49-1> 1</a></span>
<span class=normal><a href=#__codelineno-49-2> 2</a></span>
<span class=normal><a href=#__codelineno-49-3> 3</a></span>
<span class=normal><a href=#__codelineno-49-4> 4</a></span>
<span class=normal><a href=#__codelineno-49-5> 5</a></span>
<span class=normal><a href=#__codelineno-49-6> 6</a></span>
<span class=normal><a href=#__codelineno-49-7> 7</a></span>
<span class=normal><a href=#__codelineno-49-8> 8</a></span>
<span class=normal><a href=#__codelineno-49-9> 9</a></span>
<span class=normal><a href=#__codelineno-49-10>10</a></span>
<span class=normal><a href=#__codelineno-49-11>11</a></span>
<span class=normal><a href=#__codelineno-49-12>12</a></span>
<span class=normal><a href=#__codelineno-49-13>13</a></span>
<span class=normal><a href=#__codelineno-49-14>14</a></span>
<span class=normal><a href=#__codelineno-49-15>15</a></span>
<span class=normal><a href=#__codelineno-49-16>16</a></span>
<span class=normal><a href=#__codelineno-49-17>17</a></span>
<span class=normal><a href=#__codelineno-49-18>18</a></span>
<span class=normal><a href=#__codelineno-49-19>19</a></span>
<span class=normal><a href=#__codelineno-49-20>20</a></span>
<span class=normal><a href=#__codelineno-49-21>21</a></span>
<span class=normal><a href=#__codelineno-49-22>22</a></span>
<span class=normal><a href=#__codelineno-49-23>23</a></span>
<span class=normal><a href=#__codelineno-49-24>24</a></span>
<span class=normal><a href=#__codelineno-49-25>25</a></span>
<span class=normal><a href=#__codelineno-49-26>26</a></span>
<span class=normal><a href=#__codelineno-49-27>27</a></span>
<span class=normal><a href=#__codelineno-49-28>28</a></span>
<span class=normal><a href=#__codelineno-49-29>29</a></span>
<span class=normal><a href=#__codelineno-49-30>30</a></span>
<span class=normal><a href=#__codelineno-49-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>allocproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2></a><span class=p>{</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4></a>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5></a><span class=w>    </span><span class=c1>// 初始化告警字段</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>trapframe</span><span class=o>*</span><span class=p>)</span><span class=n>kalloc</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8></a><span class=w>        </span><span class=n>freeproc</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-49-10><a id=__codelineno-49-10 name=__codelineno-49-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-11><a id=__codelineno-49-11 name=__codelineno-49-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-49-12><a id=__codelineno-49-12 name=__codelineno-49-12></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>is_alarming</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-13><a id=__codelineno-49-13 name=__codelineno-49-13></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-14><a id=__codelineno-49-14 name=__codelineno-49-14></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-15><a id=__codelineno-49-15 name=__codelineno-49-15></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ticks_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-16><a id=__codelineno-49-16 name=__codelineno-49-16></a>
</span><span id=__span-49-17><a id=__codelineno-49-17 name=__codelineno-49-17></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-49-18><a id=__codelineno-49-18 name=__codelineno-49-18></a><span class=p>}</span>
</span><span id=__span-49-19><a id=__codelineno-49-19 name=__codelineno-49-19></a>
</span><span id=__span-49-20><a id=__codelineno-49-20 name=__codelineno-49-20></a><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>freeproc</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span><span id=__span-49-21><a id=__codelineno-49-21 name=__codelineno-49-21></a><span class=p>{</span>
</span><span id=__span-49-22><a id=__codelineno-49-22 name=__codelineno-49-22></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-49-23><a id=__codelineno-49-23 name=__codelineno-49-23></a>
</span><span id=__span-49-24><a id=__codelineno-49-24 name=__codelineno-49-24></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=p>)</span>
</span><span id=__span-49-25><a id=__codelineno-49-25 name=__codelineno-49-25></a><span class=w>        </span><span class=n>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=p>);</span>
</span><span id=__span-49-26><a id=__codelineno-49-26 name=__codelineno-49-26></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_trapframe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-27><a id=__codelineno-49-27 name=__codelineno-49-27></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>is_alarming</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-28><a id=__codelineno-49-28 name=__codelineno-49-28></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-29><a id=__codelineno-49-29 name=__codelineno-49-29></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>alarm_handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-30><a id=__codelineno-49-30 name=__codelineno-49-30></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ticks_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-49-31><a id=__codelineno-49-31 name=__codelineno-49-31></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>output:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-50-1> 1</a></span>
<span class=normal><a href=#__codelineno-50-2> 2</a></span>
<span class=normal><a href=#__codelineno-50-3> 3</a></span>
<span class=normal><a href=#__codelineno-50-4> 4</a></span>
<span class=normal><a href=#__codelineno-50-5> 5</a></span>
<span class=normal><a href=#__codelineno-50-6> 6</a></span>
<span class=normal><a href=#__codelineno-50-7> 7</a></span>
<span class=normal><a href=#__codelineno-50-8> 8</a></span>
<span class=normal><a href=#__codelineno-50-9> 9</a></span>
<span class=normal><a href=#__codelineno-50-10>10</a></span>
<span class=normal><a href=#__codelineno-50-11>11</a></span>
<span class=normal><a href=#__codelineno-50-12>12</a></span>
<span class=normal><a href=#__codelineno-50-13>13</a></span>
<span class=normal><a href=#__codelineno-50-14>14</a></span>
<span class=normal><a href=#__codelineno-50-15>15</a></span>
<span class=normal><a href=#__codelineno-50-16>16</a></span>
<span class=normal><a href=#__codelineno-50-17>17</a></span>
<span class=normal><a href=#__codelineno-50-18>18</a></span>
<span class=normal><a href=#__codelineno-50-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1></a>$<span class=w> </span>alarmtest
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2></a>test0<span class=w> </span>start
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3></a>....................alarm!
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4></a>test0<span class=w> </span>passed
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5></a>test1<span class=w> </span>start
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6></a>....alarm!
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7></a>.....alarm!
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8></a>.....alarm!
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9></a>....alarm!
</span><span id=__span-50-10><a id=__codelineno-50-10 name=__codelineno-50-10></a>....alarm!
</span><span id=__span-50-11><a id=__codelineno-50-11 name=__codelineno-50-11></a>....alarm!
</span><span id=__span-50-12><a id=__codelineno-50-12 name=__codelineno-50-12></a>....alarm!
</span><span id=__span-50-13><a id=__codelineno-50-13 name=__codelineno-50-13></a>....alarm!
</span><span id=__span-50-14><a id=__codelineno-50-14 name=__codelineno-50-14></a>.....alarm!
</span><span id=__span-50-15><a id=__codelineno-50-15 name=__codelineno-50-15></a>.....alarm!
</span><span id=__span-50-16><a id=__codelineno-50-16 name=__codelineno-50-16></a>.test1<span class=w> </span>passed
</span><span id=__span-50-17><a id=__codelineno-50-17 name=__codelineno-50-17></a>test2<span class=w> </span>start
</span><span id=__span-50-18><a id=__codelineno-50-18 name=__codelineno-50-18></a>...............................................alarm!
</span><span id=__span-50-19><a id=__codelineno-50-19 name=__codelineno-50-19></a>test2<span class=w> </span>passed
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab5-xv6-lazy-page-allocation>Lab5: xv6 lazy page allocation<a class=headerlink href=#lab5-xv6-lazy-page-allocation title="Permanent link">¶</a></h2> <ol> <li> <p>Eliminate allocation from sbrk()</p> <blockquote> <p>仅仅改动<code>sys_sbrk()</code>函数即可，将实际分配内存的函数删除，而仅仅改变进程的sz属性</p> </blockquote> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-51-1> 1</a></span>
<span class=normal><a href=#__codelineno-51-2> 2</a></span>
<span class=normal><a href=#__codelineno-51-3> 3</a></span>
<span class=normal><a href=#__codelineno-51-4> 4</a></span>
<span class=normal><a href=#__codelineno-51-5> 5</a></span>
<span class=normal><a href=#__codelineno-51-6> 6</a></span>
<span class=normal><a href=#__codelineno-51-7> 7</a></span>
<span class=normal><a href=#__codelineno-51-8> 8</a></span>
<span class=normal><a href=#__codelineno-51-9> 9</a></span>
<span class=normal><a href=#__codelineno-51-10>10</a></span>
<span class=normal><a href=#__codelineno-51-11>11</a></span>
<span class=normal><a href=#__codelineno-51-12>12</a></span>
<span class=normal><a href=#__codelineno-51-13>13</a></span>
<span class=normal><a href=#__codelineno-51-14>14</a></span>
<span class=normal><a href=#__codelineno-51-15>15</a></span>
<span class=normal><a href=#__codelineno-51-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1></a><span class=n>uint64</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2></a><span class=nf>sys_sbrk</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3></a><span class=p>{</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6></a>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9></a><span class=w>    </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10></a><span class=w>    </span><span class=c1>// =========== solution for lazy =============</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11></a><span class=w>    </span><span class=c1>// lazy allocation</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12></a><span class=w>    </span><span class=n>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13></a><span class=w>    </span><span class=c1>// ===========================================</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14></a>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Lazy allocation</p> <p>(1) 修改<code>usertrap()</code>函数，使用<code>r_scause()</code>判断是否为页面错误，在页面错误处理的过程中，先判断发生错误的虚拟地址（<code>r_stval()</code>读取）是否位于栈空间之上，进程大小（虚拟地址从0开始，进程大小表征了进程的最高虚拟地址）之下，然后分配物理内存并添加映射</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-52-1> 1</a></span>
<span class=normal><a href=#__codelineno-52-2> 2</a></span>
<span class=normal><a href=#__codelineno-52-3> 3</a></span>
<span class=normal><a href=#__codelineno-52-4> 4</a></span>
<span class=normal><a href=#__codelineno-52-5> 5</a></span>
<span class=normal><a href=#__codelineno-52-6> 6</a></span>
<span class=normal><a href=#__codelineno-52-7> 7</a></span>
<span class=normal><a href=#__codelineno-52-8> 8</a></span>
<span class=normal><a href=#__codelineno-52-9> 9</a></span>
<span class=normal><a href=#__codelineno-52-10>10</a></span>
<span class=normal><a href=#__codelineno-52-11>11</a></span>
<span class=normal><a href=#__codelineno-52-12>12</a></span>
<span class=normal><a href=#__codelineno-52-13>13</a></span>
<span class=normal><a href=#__codelineno-52-14>14</a></span>
<span class=normal><a href=#__codelineno-52-15>15</a></span>
<span class=normal><a href=#__codelineno-52-16>16</a></span>
<span class=normal><a href=#__codelineno-52-17>17</a></span>
<span class=normal><a href=#__codelineno-52-18>18</a></span>
<span class=normal><a href=#__codelineno-52-19>19</a></span>
<span class=normal><a href=#__codelineno-52-20>20</a></span>
<span class=normal><a href=#__codelineno-52-21>21</a></span>
<span class=normal><a href=#__codelineno-52-22>22</a></span>
<span class=normal><a href=#__codelineno-52-23>23</a></span>
<span class=normal><a href=#__codelineno-52-24>24</a></span>
<span class=normal><a href=#__codelineno-52-25>25</a></span>
<span class=normal><a href=#__codelineno-52-26>26</a></span>
<span class=normal><a href=#__codelineno-52-27>27</a></span>
<span class=normal><a href=#__codelineno-52-28>28</a></span>
<span class=normal><a href=#__codelineno-52-29>29</a></span>
<span class=normal><a href=#__codelineno-52-30>30</a></span>
<span class=normal><a href=#__codelineno-52-31>31</a></span>
<span class=normal><a href=#__codelineno-52-32>32</a></span>
<span class=normal><a href=#__codelineno-52-33>33</a></span>
<span class=normal><a href=#__codelineno-52-34>34</a></span>
<span class=normal><a href=#__codelineno-52-35>35</a></span>
<span class=normal><a href=#__codelineno-52-36>36</a></span>
<span class=normal><a href=#__codelineno-52-37>37</a></span>
<span class=normal><a href=#__codelineno-52-38>38</a></span>
<span class=normal><a href=#__codelineno-52-39>39</a></span>
<span class=normal><a href=#__codelineno-52-40>40</a></span>
<span class=normal><a href=#__codelineno-52-41>41</a></span>
<span class=normal><a href=#__codelineno-52-42>42</a></span>
<span class=normal><a href=#__codelineno-52-43>43</a></span>
<span class=normal><a href=#__codelineno-52-44>44</a></span>
<span class=normal><a href=#__codelineno-52-45>45</a></span>
<span class=normal><a href=#__codelineno-52-46>46</a></span>
<span class=normal><a href=#__codelineno-52-47>47</a></span>
<span class=normal><a href=#__codelineno-52-48>48</a></span>
<span class=normal><a href=#__codelineno-52-49>49</a></span>
<span class=normal><a href=#__codelineno-52-50>50</a></span>
<span class=normal><a href=#__codelineno-52-51>51</a></span>
<span class=normal><a href=#__codelineno-52-52>52</a></span>
<span class=normal><a href=#__codelineno-52-53>53</a></span>
<span class=normal><a href=#__codelineno-52-54>54</a></span>
<span class=normal><a href=#__codelineno-52-55>55</a></span>
<span class=normal><a href=#__codelineno-52-56>56</a></span>
<span class=normal><a href=#__codelineno-52-57>57</a></span>
<span class=normal><a href=#__codelineno-52-58>58</a></span>
<span class=normal><a href=#__codelineno-52-59>59</a></span>
<span class=normal><a href=#__codelineno-52-60>60</a></span>
<span class=normal><a href=#__codelineno-52-61>61</a></span>
<span class=normal><a href=#__codelineno-52-62>62</a></span>
<span class=normal><a href=#__codelineno-52-63>63</a></span>
<span class=normal><a href=#__codelineno-52-64>64</a></span>
<span class=normal><a href=#__codelineno-52-65>65</a></span>
<span class=normal><a href=#__codelineno-52-66>66</a></span>
<span class=normal><a href=#__codelineno-52-67>67</a></span>
<span class=normal><a href=#__codelineno-52-68>68</a></span>
<span class=normal><a href=#__codelineno-52-69>69</a></span>
<span class=normal><a href=#__codelineno-52-70>70</a></span>
<span class=normal><a href=#__codelineno-52-71>71</a></span>
<span class=normal><a href=#__codelineno-52-72>72</a></span>
<span class=normal><a href=#__codelineno-52-73>73</a></span>
<span class=normal><a href=#__codelineno-52-74>74</a></span>
<span class=normal><a href=#__codelineno-52-75>75</a></span>
<span class=normal><a href=#__codelineno-52-76>76</a></span>
<span class=normal><a href=#__codelineno-52-77>77</a></span>
<span class=normal><a href=#__codelineno-52-78>78</a></span>
<span class=normal><a href=#__codelineno-52-79>79</a></span>
<span class=normal><a href=#__codelineno-52-80>80</a></span>
<span class=normal><a href=#__codelineno-52-81>81</a></span>
<span class=normal><a href=#__codelineno-52-82>82</a></span>
<span class=normal><a href=#__codelineno-52-83>83</a></span>
<span class=normal><a href=#__codelineno-52-84>84</a></span>
<span class=normal><a href=#__codelineno-52-85>85</a></span>
<span class=normal><a href=#__codelineno-52-86>86</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1></a><span class=c1>//</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2></a><span class=c1>// handle an interrupt, exception, or system call from user space.</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3></a><span class=c1>// called from trampoline.S</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4></a><span class=c1>//</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5></a><span class=kt>void</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6></a><span class=nf>usertrap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7></a><span class=p>{</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>which_dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9></a>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>r_sstatus</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>SSTATUS_SPP</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"usertrap: not from user mode"</span><span class=p>);</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12></a>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13></a><span class=w>    </span><span class=c1>// send interrupts and exceptions to kerneltrap(),</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14></a><span class=w>    </span><span class=c1>// since we're now in the kernel.</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15></a><span class=w>    </span><span class=n>w_stvec</span><span class=p>((</span><span class=n>uint64</span><span class=p>)</span><span class=n>kernelvec</span><span class=p>);</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16></a>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18></a>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19></a><span class=w>    </span><span class=c1>// save user program counter.</span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_sepc</span><span class=p>();</span>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21></a>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_scause</span><span class=p>();</span>
</span><span id=__span-52-23><a id=__codelineno-52-23 name=__codelineno-52-23></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-52-24><a id=__codelineno-52-24 name=__codelineno-52-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-25><a id=__codelineno-52-25 name=__codelineno-52-25></a><span class=w>        </span><span class=c1>// system call</span>
</span><span id=__span-52-26><a id=__codelineno-52-26 name=__codelineno-52-26></a>
</span><span id=__span-52-27><a id=__codelineno-52-27 name=__codelineno-52-27></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=p>)</span>
</span><span id=__span-52-28><a id=__codelineno-52-28 name=__codelineno-52-28></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-52-29><a id=__codelineno-52-29 name=__codelineno-52-29></a>
</span><span id=__span-52-30><a id=__codelineno-52-30 name=__codelineno-52-30></a><span class=w>        </span><span class=c1>// sepc points to the ecall instruction,</span>
</span><span id=__span-52-31><a id=__codelineno-52-31 name=__codelineno-52-31></a><span class=w>        </span><span class=c1>// but we want to return to the next instruction.</span>
</span><span id=__span-52-32><a id=__codelineno-52-32 name=__codelineno-52-32></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-52-33><a id=__codelineno-52-33 name=__codelineno-52-33></a>
</span><span id=__span-52-34><a id=__codelineno-52-34 name=__codelineno-52-34></a><span class=w>        </span><span class=c1>// an interrupt will change sstatus &amp;c registers,</span>
</span><span id=__span-52-35><a id=__codelineno-52-35 name=__codelineno-52-35></a><span class=w>        </span><span class=c1>// so don't enable until done with those registers.</span>
</span><span id=__span-52-36><a id=__codelineno-52-36 name=__codelineno-52-36></a><span class=w>        </span><span class=n>intr_on</span><span class=p>();</span>
</span><span id=__span-52-37><a id=__codelineno-52-37 name=__codelineno-52-37></a>
</span><span id=__span-52-38><a id=__codelineno-52-38 name=__codelineno-52-38></a><span class=w>        </span><span class=n>syscall</span><span class=p>();</span>
</span><span id=__span-52-39><a id=__codelineno-52-39 name=__codelineno-52-39></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-52-40><a id=__codelineno-52-40 name=__codelineno-52-40></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>((</span><span class=n>which_dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>devintr</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-52-41><a id=__codelineno-52-41 name=__codelineno-52-41></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-42><a id=__codelineno-52-42 name=__codelineno-52-42></a><span class=w>        </span><span class=c1>// ok</span>
</span><span id=__span-52-43><a id=__codelineno-52-43 name=__codelineno-52-43></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-52-44><a id=__codelineno-52-44 name=__codelineno-52-44></a><span class=w>    </span><span class=c1>// ===================== solution for lazy =======================</span>
</span><span id=__span-52-45><a id=__codelineno-52-45 name=__codelineno-52-45></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>13</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>15</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-52-46><a id=__codelineno-52-46 name=__codelineno-52-46></a><span class=w>    </span><span class=c1>// cause == 13 加载指令触发的页面错误，cause == 15 存储指令触发的页面错误</span>
</span><span id=__span-52-47><a id=__codelineno-52-47 name=__codelineno-52-47></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-48><a id=__codelineno-52-48 name=__codelineno-52-48></a><span class=w>        </span><span class=c1>// 处理页面错误</span>
</span><span id=__span-52-49><a id=__codelineno-52-49 name=__codelineno-52-49></a><span class=w>        </span><span class=n>uint64</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_stval</span><span class=p>();</span><span class=w>  </span><span class=c1>// 产生页面错误的虚拟地址</span>
</span><span id=__span-52-50><a id=__codelineno-52-50 name=__codelineno-52-50></a><span class=w>        </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>pa</span><span class=p>;</span><span class=w>                     </span><span class=c1>// 分配的物理地址</span>
</span><span id=__span-52-51><a id=__codelineno-52-51 name=__codelineno-52-51></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span>
</span><span id=__span-52-52><a id=__codelineno-52-52 name=__codelineno-52-52></a><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span>
</span><span id=__span-52-53><a id=__codelineno-52-53 name=__codelineno-52-53></a><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-52-54><a id=__codelineno-52-54 name=__codelineno-52-54></a><span class=w>        </span><span class=c1>// PGROUNDUP(p-&gt;trapframe-&gt;sp) - 1 &lt; fault_va: 检查页面错误的虚拟地</span>
</span><span id=__span-52-55><a id=__codelineno-52-55 name=__codelineno-52-55></a><span class=w>        </span><span class=c1>// 址是否位于栈空间之上。PGROUNDUP(p-&gt;trapframe-&gt;sp) 的作用是把当前用</span>
</span><span id=__span-52-56><a id=__codelineno-52-56 name=__codelineno-52-56></a><span class=w>        </span><span class=c1>// 户栈指针 sp 向上对齐到最近的页边界（即得到“下一页”的起始地址）。减去 </span>
</span><span id=__span-52-57><a id=__codelineno-52-57 name=__codelineno-52-57></a><span class=w>        </span><span class=c1>// 1 后，得到的是"当前栈顶所在页的最后一个字节地址"。意思是：只有当 </span>
</span><span id=__span-52-58><a id=__codelineno-52-58 name=__codelineno-52-58></a><span class=w>        </span><span class=c1>// fault_va 落在栈顶所在页的下一页（即栈向下增长时新扩展的那一页）时，才</span>
</span><span id=__span-52-59><a id=__codelineno-52-59 name=__codelineno-52-59></a><span class=w>        </span><span class=c1>// 允许分配新页。即只允许“逐页”扩展用户栈。</span>
</span><span id=__span-52-60><a id=__codelineno-52-60 name=__codelineno-52-60></a><span class=w>        </span><span class=c1>// fault_va &lt; p-&gt;sz: 地址在进程内存范围内</span>
</span><span id=__span-52-61><a id=__codelineno-52-61 name=__codelineno-52-61></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-52-62><a id=__codelineno-52-62 name=__codelineno-52-62></a><span class=w>            </span><span class=n>memset</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-52-63><a id=__codelineno-52-63 name=__codelineno-52-63></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>fault_va</span><span class=p>),</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_X</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_U</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-52-64><a id=__codelineno-52-64 name=__codelineno-52-64></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-52-65><a id=__codelineno-52-65 name=__codelineno-52-65></a><span class=w>                </span><span class=n>kfree</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-52-66><a id=__codelineno-52-66 name=__codelineno-52-66></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-52-67><a id=__codelineno-52-67 name=__codelineno-52-67></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-52-68><a id=__codelineno-52-68 name=__codelineno-52-68></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-52-69><a id=__codelineno-52-69 name=__codelineno-52-69></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-52-70><a id=__codelineno-52-70 name=__codelineno-52-70></a><span class=w>    </span><span class=c1>// ===============================================================</span>
</span><span id=__span-52-71><a id=__codelineno-52-71 name=__codelineno-52-71></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-52-72><a id=__codelineno-52-72 name=__codelineno-52-72></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-52-73><a id=__codelineno-52-73 name=__codelineno-52-73></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"usertrap(): unexpected scause %p pid=%d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>r_scause</span><span class=p>(),</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-52-74><a id=__codelineno-52-74 name=__codelineno-52-74></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"            sepc=%p stval=%p</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>r_sepc</span><span class=p>(),</span><span class=w> </span><span class=n>r_stval</span><span class=p>());</span>
</span><span id=__span-52-75><a id=__codelineno-52-75 name=__codelineno-52-75></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-52-76><a id=__codelineno-52-76 name=__codelineno-52-76></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-52-77><a id=__codelineno-52-77 name=__codelineno-52-77></a>
</span><span id=__span-52-78><a id=__codelineno-52-78 name=__codelineno-52-78></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=p>)</span>
</span><span id=__span-52-79><a id=__codelineno-52-79 name=__codelineno-52-79></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-52-80><a id=__codelineno-52-80 name=__codelineno-52-80></a>
</span><span id=__span-52-81><a id=__codelineno-52-81 name=__codelineno-52-81></a><span class=w>    </span><span class=c1>// give up the CPU if this is a timer interrupt.</span>
</span><span id=__span-52-82><a id=__codelineno-52-82 name=__codelineno-52-82></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>which_dev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-52-83><a id=__codelineno-52-83 name=__codelineno-52-83></a><span class=w>        </span><span class=n>yield</span><span class=p>();</span>
</span><span id=__span-52-84><a id=__codelineno-52-84 name=__codelineno-52-84></a>
</span><span id=__span-52-85><a id=__codelineno-52-85 name=__codelineno-52-85></a><span class=w>    </span><span class=n>usertrapret</span><span class=p>();</span>
</span><span id=__span-52-86><a id=__codelineno-52-86 name=__codelineno-52-86></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 修改<code>uvmunmap()</code>，之所以修改这部分代码是因为lazy allocation中首先并未实际分配内存，所以当解除映射关系的时候对于这部分内存要略过，而不是使系统崩溃。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-53-1> 1</a></span>
<span class=normal><a href=#__codelineno-53-2> 2</a></span>
<span class=normal><a href=#__codelineno-53-3> 3</a></span>
<span class=normal><a href=#__codelineno-53-4> 4</a></span>
<span class=normal><a href=#__codelineno-53-5> 5</a></span>
<span class=normal><a href=#__codelineno-53-6> 6</a></span>
<span class=normal><a href=#__codelineno-53-7> 7</a></span>
<span class=normal><a href=#__codelineno-53-8> 8</a></span>
<span class=normal><a href=#__codelineno-53-9> 9</a></span>
<span class=normal><a href=#__codelineno-53-10>10</a></span>
<span class=normal><a href=#__codelineno-53-11>11</a></span>
<span class=normal><a href=#__codelineno-53-12>12</a></span>
<span class=normal><a href=#__codelineno-53-13>13</a></span>
<span class=normal><a href=#__codelineno-53-14>14</a></span>
<span class=normal><a href=#__codelineno-53-15>15</a></span>
<span class=normal><a href=#__codelineno-53-16>16</a></span>
<span class=normal><a href=#__codelineno-53-17>17</a></span>
<span class=normal><a href=#__codelineno-53-18>18</a></span>
<span class=normal><a href=#__codelineno-53-19>19</a></span>
<span class=normal><a href=#__codelineno-53-20>20</a></span>
<span class=normal><a href=#__codelineno-53-21>21</a></span>
<span class=normal><a href=#__codelineno-53-22>22</a></span>
<span class=normal><a href=#__codelineno-53-23>23</a></span>
<span class=normal><a href=#__codelineno-53-24>24</a></span>
<span class=normal><a href=#__codelineno-53-25>25</a></span>
<span class=normal><a href=#__codelineno-53-26>26</a></span>
<span class=normal><a href=#__codelineno-53-27>27</a></span>
<span class=normal><a href=#__codelineno-53-28>28</a></span>
<span class=normal><a href=#__codelineno-53-29>29</a></span>
<span class=normal><a href=#__codelineno-53-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1></a><span class=c1>// Remove npages of mappings starting from va. va must be</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2></a><span class=c1>// page-aligned. The mappings must exist.</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3></a><span class=c1>// Optionally free the physical memory.</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4></a><span class=kt>void</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5></a><span class=nf>uvmunmap</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>npages</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>do_free</span><span class=p>)</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6></a><span class=p>{</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>a</span><span class=p>;</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9></a>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>va</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmunmap: not aligned"</span><span class=p>);</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12></a>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va</span><span class=p>;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>npages</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmunmap: walk"</span><span class=p>);</span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17></a><span class=w>        </span><span class=c1>// ===================== solution for lazy ==================</span>
</span><span id=__span-53-18><a id=__codelineno-53-18 name=__codelineno-53-18></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-53-19><a id=__codelineno-53-19 name=__codelineno-53-19></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-53-20><a id=__codelineno-53-20 name=__codelineno-53-20></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-53-21><a id=__codelineno-53-21 name=__codelineno-53-21></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span>
</span><span id=__span-53-22><a id=__codelineno-53-22 name=__codelineno-53-22></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmunmap: not a leaf"</span><span class=p>);</span>
</span><span id=__span-53-23><a id=__codelineno-53-23 name=__codelineno-53-23></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>do_free</span><span class=p>)</span>
</span><span id=__span-53-24><a id=__codelineno-53-24 name=__codelineno-53-24></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-53-25><a id=__codelineno-53-25 name=__codelineno-53-25></a><span class=w>            </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-53-26><a id=__codelineno-53-26 name=__codelineno-53-26></a><span class=w>            </span><span class=n>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-53-27><a id=__codelineno-53-27 name=__codelineno-53-27></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-53-28><a id=__codelineno-53-28 name=__codelineno-53-28></a><span class=w>        </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-53-29><a id=__codelineno-53-29 name=__codelineno-53-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-53-30><a id=__codelineno-53-30 name=__codelineno-53-30></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Lazytests and Usertests (📌未通过测试)</p> <p>(1) 处理<code>sbrk()</code>参数为负数的情况，参考之前<code>sbrk()</code>调用的<code>growproc()</code>程序，如果为负数，就调用<code>uvmdealloc()</code>函数，但需要限制缩减后的内存空间不能小于0。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-54-1> 1</a></span>
<span class=normal><a href=#__codelineno-54-2> 2</a></span>
<span class=normal><a href=#__codelineno-54-3> 3</a></span>
<span class=normal><a href=#__codelineno-54-4> 4</a></span>
<span class=normal><a href=#__codelineno-54-5> 5</a></span>
<span class=normal><a href=#__codelineno-54-6> 6</a></span>
<span class=normal><a href=#__codelineno-54-7> 7</a></span>
<span class=normal><a href=#__codelineno-54-8> 8</a></span>
<span class=normal><a href=#__codelineno-54-9> 9</a></span>
<span class=normal><a href=#__codelineno-54-10>10</a></span>
<span class=normal><a href=#__codelineno-54-11>11</a></span>
<span class=normal><a href=#__codelineno-54-12>12</a></span>
<span class=normal><a href=#__codelineno-54-13>13</a></span>
<span class=normal><a href=#__codelineno-54-14>14</a></span>
<span class=normal><a href=#__codelineno-54-15>15</a></span>
<span class=normal><a href=#__codelineno-54-16>16</a></span>
<span class=normal><a href=#__codelineno-54-17>17</a></span>
<span class=normal><a href=#__codelineno-54-18>18</a></span>
<span class=normal><a href=#__codelineno-54-19>19</a></span>
<span class=normal><a href=#__codelineno-54-20>20</a></span>
<span class=normal><a href=#__codelineno-54-21>21</a></span>
<span class=normal><a href=#__codelineno-54-22>22</a></span>
<span class=normal><a href=#__codelineno-54-23>23</a></span>
<span class=normal><a href=#__codelineno-54-24>24</a></span>
<span class=normal><a href=#__codelineno-54-25>25</a></span>
<span class=normal><a href=#__codelineno-54-26>26</a></span>
<span class=normal><a href=#__codelineno-54-27>27</a></span>
<span class=normal><a href=#__codelineno-54-28>28</a></span>
<span class=normal><a href=#__codelineno-54-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_sbrk</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2></a><span class=p>{</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5></a>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>n</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8></a>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9></a><span class=w>    </span><span class=c1>// ===================== solution for lazy ==================</span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11></a><span class=w>    </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13></a>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20></a><span class=w>        </span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uvmdealloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=p>,</span><span class=w> </span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-54-21><a id=__codelineno-54-21 name=__codelineno-54-21></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-54-22><a id=__codelineno-54-22 name=__codelineno-54-22></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-54-23><a id=__codelineno-54-23 name=__codelineno-54-23></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-54-24><a id=__codelineno-54-24 name=__codelineno-54-24></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-54-25><a id=__codelineno-54-25 name=__codelineno-54-25></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-26><a id=__codelineno-54-26 name=__codelineno-54-26></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-54-27><a id=__codelineno-54-27 name=__codelineno-54-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-28><a id=__codelineno-54-28 name=__codelineno-54-28></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-54-29><a id=__codelineno-54-29 name=__codelineno-54-29></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 正确处理<code>fork</code>的内存拷贝：<code>fork</code>调用了<code>uvmcopy</code>进行内存拷贝，所以修改<code>uvmcopy</code>如下:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-55-1> 1</a></span>
<span class=normal><a href=#__codelineno-55-2> 2</a></span>
<span class=normal><a href=#__codelineno-55-3> 3</a></span>
<span class=normal><a href=#__codelineno-55-4> 4</a></span>
<span class=normal><a href=#__codelineno-55-5> 5</a></span>
<span class=normal><a href=#__codelineno-55-6> 6</a></span>
<span class=normal><a href=#__codelineno-55-7> 7</a></span>
<span class=normal><a href=#__codelineno-55-8> 8</a></span>
<span class=normal><a href=#__codelineno-55-9> 9</a></span>
<span class=normal><a href=#__codelineno-55-10>10</a></span>
<span class=normal><a href=#__codelineno-55-11>11</a></span>
<span class=normal><a href=#__codelineno-55-12>12</a></span>
<span class=normal><a href=#__codelineno-55-13>13</a></span>
<span class=normal><a href=#__codelineno-55-14>14</a></span>
<span class=normal><a href=#__codelineno-55-15>15</a></span>
<span class=normal><a href=#__codelineno-55-16>16</a></span>
<span class=normal><a href=#__codelineno-55-17>17</a></span>
<span class=normal><a href=#__codelineno-55-18>18</a></span>
<span class=normal><a href=#__codelineno-55-19>19</a></span>
<span class=normal><a href=#__codelineno-55-20>20</a></span>
<span class=normal><a href=#__codelineno-55-21>21</a></span>
<span class=normal><a href=#__codelineno-55-22>22</a></span>
<span class=normal><a href=#__codelineno-55-23>23</a></span>
<span class=normal><a href=#__codelineno-55-24>24</a></span>
<span class=normal><a href=#__codelineno-55-25>25</a></span>
<span class=normal><a href=#__codelineno-55-26>26</a></span>
<span class=normal><a href=#__codelineno-55-27>27</a></span>
<span class=normal><a href=#__codelineno-55-28>28</a></span>
<span class=normal><a href=#__codelineno-55-29>29</a></span>
<span class=normal><a href=#__codelineno-55-30>30</a></span>
<span class=normal><a href=#__codelineno-55-31>31</a></span>
<span class=normal><a href=#__codelineno-55-32>32</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1></a><span class=kt>int</span><span class=w> </span><span class=nf>uvmcopy</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>old</span><span class=p>,</span><span class=w> </span><span class=n>pagetable_t</span><span class=w> </span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>sz</span><span class=p>)</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2></a><span class=p>{</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>mem</span><span class=p>;</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7></a>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>sz</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10></a><span class=w>        </span><span class=c1>// ===================== solution for lazy ==================</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>old</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16></a><span class=w>        </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17></a><span class=w>        </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>mem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19></a><span class=w>            </span><span class=k>goto</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20></a><span class=w>        </span><span class=n>memmove</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>mem</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23></a><span class=w>            </span><span class=n>kfree</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span>
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24></a><span class=w>            </span><span class=k>goto</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28></a>
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29></a><span class=w>    </span><span class=nl>err</span><span class=p>:</span>
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30></a><span class=w>        </span><span class=n>uvmunmap</span><span class=p>(</span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 还需要继续修改<code>uvmunmap</code>，否则会运行出错:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-56-1> 1</a></span>
<span class=normal><a href=#__codelineno-56-2> 2</a></span>
<span class=normal><a href=#__codelineno-56-3> 3</a></span>
<span class=normal><a href=#__codelineno-56-4> 4</a></span>
<span class=normal><a href=#__codelineno-56-5> 5</a></span>
<span class=normal><a href=#__codelineno-56-6> 6</a></span>
<span class=normal><a href=#__codelineno-56-7> 7</a></span>
<span class=normal><a href=#__codelineno-56-8> 8</a></span>
<span class=normal><a href=#__codelineno-56-9> 9</a></span>
<span class=normal><a href=#__codelineno-56-10>10</a></span>
<span class=normal><a href=#__codelineno-56-11>11</a></span>
<span class=normal><a href=#__codelineno-56-12>12</a></span>
<span class=normal><a href=#__codelineno-56-13>13</a></span>
<span class=normal><a href=#__codelineno-56-14>14</a></span>
<span class=normal><a href=#__codelineno-56-15>15</a></span>
<span class=normal><a href=#__codelineno-56-16>16</a></span>
<span class=normal><a href=#__codelineno-56-17>17</a></span>
<span class=normal><a href=#__codelineno-56-18>18</a></span>
<span class=normal><a href=#__codelineno-56-19>19</a></span>
<span class=normal><a href=#__codelineno-56-20>20</a></span>
<span class=normal><a href=#__codelineno-56-21>21</a></span>
<span class=normal><a href=#__codelineno-56-22>22</a></span>
<span class=normal><a href=#__codelineno-56-23>23</a></span>
<span class=normal><a href=#__codelineno-56-24>24</a></span>
<span class=normal><a href=#__codelineno-56-25>25</a></span>
<span class=normal><a href=#__codelineno-56-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1></a><span class=kt>void</span><span class=w> </span><span class=nf>uvmunmap</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>npages</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>do_free</span><span class=p>)</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2></a><span class=p>{</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>a</span><span class=p>;</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5></a>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>va</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmunmap: not aligned"</span><span class=p>);</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8></a>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va</span><span class=p>;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>npages</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>;</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11></a><span class=w>        </span><span class=c1>// ===================== solution for lazy ==================</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmunmap: not a leaf"</span><span class=p>);</span>
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>do_free</span><span class=p>)</span>
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21></a><span class=w>            </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22></a><span class=w>            </span><span class=n>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-56-24><a id=__codelineno-56-24 name=__codelineno-56-24></a><span class=w>        </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-56-25><a id=__codelineno-56-25 name=__codelineno-56-25></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-56-26><a id=__codelineno-56-26 name=__codelineno-56-26></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 处理通过<code>sbrk</code>申请内存后但还未实际分配时就进行系统调用的情况，系统调用的处理会陷入内核，<code>scause</code>寄存器存储的值是8，如果此时传入的地址还未实际分配，就不能走到上文<code>usertrap</code>中判断<code>scause</code>是13或15后进行内存分配的代码，<code>syscall</code>执行就会失败:</p> <ul> <li>系统调用流程：陷入内核 ==&gt; usertrap中<code>r_scause() == 8</code> 的分支 ==&gt; syscall() ==&gt; 回到用户空间</li> <li>页面错误流程：陷入内核 ==&gt; usertrap中<code>r_scause() == 13 || r_scause() == 15</code>的分支 ==&gt; 分配内存 ==&gt; 回到用户空间</li> </ul> <p>因此就需要找到在何时系统调用会使用这些地址，将地址传入系统调用后，会通过<code>argaddr</code>函数从寄存器中读取，因此在这里添加物理内存分配的代码:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-57-1> 1</a></span>
<span class=normal><a href=#__codelineno-57-2> 2</a></span>
<span class=normal><a href=#__codelineno-57-3> 3</a></span>
<span class=normal><a href=#__codelineno-57-4> 4</a></span>
<span class=normal><a href=#__codelineno-57-5> 5</a></span>
<span class=normal><a href=#__codelineno-57-6> 6</a></span>
<span class=normal><a href=#__codelineno-57-7> 7</a></span>
<span class=normal><a href=#__codelineno-57-8> 8</a></span>
<span class=normal><a href=#__codelineno-57-9> 9</a></span>
<span class=normal><a href=#__codelineno-57-10>10</a></span>
<span class=normal><a href=#__codelineno-57-11>11</a></span>
<span class=normal><a href=#__codelineno-57-12>12</a></span>
<span class=normal><a href=#__codelineno-57-13>13</a></span>
<span class=normal><a href=#__codelineno-57-14>14</a></span>
<span class=normal><a href=#__codelineno-57-15>15</a></span>
<span class=normal><a href=#__codelineno-57-16>16</a></span>
<span class=normal><a href=#__codelineno-57-17>17</a></span>
<span class=normal><a href=#__codelineno-57-18>18</a></span>
<span class=normal><a href=#__codelineno-57-19>19</a></span>
<span class=normal><a href=#__codelineno-57-20>20</a></span>
<span class=normal><a href=#__codelineno-57-21>21</a></span>
<span class=normal><a href=#__codelineno-57-22>22</a></span>
<span class=normal><a href=#__codelineno-57-23>23</a></span>
<span class=normal><a href=#__codelineno-57-24>24</a></span>
<span class=normal><a href=#__codelineno-57-25>25</a></span>
<span class=normal><a href=#__codelineno-57-26>26</a></span>
<span class=normal><a href=#__codelineno-57-27>27</a></span>
<span class=normal><a href=#__codelineno-57-28>28</a></span>
<span class=normal><a href=#__codelineno-57-29>29</a></span>
<span class=normal><a href=#__codelineno-57-30>30</a></span>
<span class=normal><a href=#__codelineno-57-31>31</a></span>
<span class=normal><a href=#__codelineno-57-32>32</a></span>
<span class=normal><a href=#__codelineno-57-33>33</a></span>
<span class=normal><a href=#__codelineno-57-34>34</a></span>
<span class=normal><a href=#__codelineno-57-35>35</a></span>
<span class=normal><a href=#__codelineno-57-36>36</a></span>
<span class=normal><a href=#__codelineno-57-37>37</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1></a><span class=c1>// Retrieve an argument as a pointer.</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2></a><span class=c1>// Doesn't check for legality, since</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3></a><span class=c1>// copyin/copyout will do that.</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4></a><span class=kt>int</span><span class=w> </span><span class=nf>argaddr</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=p>)</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5></a><span class=p>{</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6></a><span class=w>    </span><span class=o>*</span><span class=n>ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argraw</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7></a><span class=w>    </span><span class=c1>// ===================== solution for lazy ==================</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9></a>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10></a><span class=w>    </span><span class=c1>// 处理向系统调用传入lazy allocation地址的情况</span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>walkaddr</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15></a><span class=w>            </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>();</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>pa</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-57-17><a id=__codelineno-57-17 name=__codelineno-57-17></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-57-18><a id=__codelineno-57-18 name=__codelineno-57-18></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-57-19><a id=__codelineno-57-19 name=__codelineno-57-19></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-57-20><a id=__codelineno-57-20 name=__codelineno-57-20></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-57-21><a id=__codelineno-57-21 name=__codelineno-57-21></a><span class=w>            </span><span class=n>memset</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-57-22><a id=__codelineno-57-22 name=__codelineno-57-22></a>
</span><span id=__span-57-23><a id=__codelineno-57-23 name=__codelineno-57-23></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=o>*</span><span class=n>ip</span><span class=p>),</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>PTE_R</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_X</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_U</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-57-24><a id=__codelineno-57-24 name=__codelineno-57-24></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-57-25><a id=__codelineno-57-25 name=__codelineno-57-25></a><span class=w>                </span><span class=n>kfree</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-57-26><a id=__codelineno-57-26 name=__codelineno-57-26></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-57-27><a id=__codelineno-57-27 name=__codelineno-57-27></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-57-28><a id=__codelineno-57-28 name=__codelineno-57-28></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-57-29><a id=__codelineno-57-29 name=__codelineno-57-29></a><span class=w>        </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-57-30><a id=__codelineno-57-30 name=__codelineno-57-30></a><span class=w>        </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-57-31><a id=__codelineno-57-31 name=__codelineno-57-31></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-57-32><a id=__codelineno-57-32 name=__codelineno-57-32></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-57-33><a id=__codelineno-57-33 name=__codelineno-57-33></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-57-34><a id=__codelineno-57-34 name=__codelineno-57-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-57-35><a id=__codelineno-57-35 name=__codelineno-57-35></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-57-36><a id=__codelineno-57-36 name=__codelineno-57-36></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-57-37><a id=__codelineno-57-37 name=__codelineno-57-37></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab6-copy-on-write-fork-for-xv6>Lab6: Copy-on-Write Fork for xv6<a class=headerlink href=#lab6-copy-on-write-fork-for-xv6 title="Permanent link">¶</a></h2> <ol> <li> <p>Implement copy-on write</p> <p>(1) 在<code>kernel/riscv.h</code>中选取PTE中的保留位定义标记一个页面是否为COW Fork页面的标志位<code>PTE_F</code>:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-58-1>1</a></span>
<span class=normal><a href=#__codelineno-58-2>2</a></span>
<span class=normal><a href=#__codelineno-58-3>3</a></span>
<span class=normal><a href=#__codelineno-58-4>4</a></span>
<span class=normal><a href=#__codelineno-58-5>5</a></span>
<span class=normal><a href=#__codelineno-58-6>6</a></span>
<span class=normal><a href=#__codelineno-58-7>7</a></span>
<span class=normal><a href=#__codelineno-58-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1></a><span class=cp>#define PTE_V (1L &lt;&lt; 0) </span><span class=c1>// valid</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2></a><span class=cp>#define PTE_R (1L &lt;&lt; 1)</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3></a><span class=cp>#define PTE_W (1L &lt;&lt; 2)</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4></a><span class=cp>#define PTE_X (1L &lt;&lt; 3)</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5></a><span class=cp>#define PTE_U (1L &lt;&lt; 4) </span><span class=c1>// 1 -&gt; user can access</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6></a><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7></a><span class=cp>#define PTE_F (1L &lt;&lt; 8) </span><span class=c1>// 记录应用了COW策略后fork的页面</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8></a><span class=c1>// ==========================================================</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在<code>kalloc.c</code>中定义引用计数的全局变量<code>ref</code>并在<code>kinit</code>中初始化<code>ref</code>的自旋锁:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-59-1> 1</a></span>
<span class=normal><a href=#__codelineno-59-2> 2</a></span>
<span class=normal><a href=#__codelineno-59-3> 3</a></span>
<span class=normal><a href=#__codelineno-59-4> 4</a></span>
<span class=normal><a href=#__codelineno-59-5> 5</a></span>
<span class=normal><a href=#__codelineno-59-6> 6</a></span>
<span class=normal><a href=#__codelineno-59-7> 7</a></span>
<span class=normal><a href=#__codelineno-59-8> 8</a></span>
<span class=normal><a href=#__codelineno-59-9> 9</a></span>
<span class=normal><a href=#__codelineno-59-10>10</a></span>
<span class=normal><a href=#__codelineno-59-11>11</a></span>
<span class=normal><a href=#__codelineno-59-12>12</a></span>
<span class=normal><a href=#__codelineno-59-13>13</a></span>
<span class=normal><a href=#__codelineno-59-14>14</a></span>
<span class=normal><a href=#__codelineno-59-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1></a><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2></a><span class=k>struct</span><span class=w> </span><span class=nc>ref_stru</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>spinlock</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>cnt</span><span class=p>[</span><span class=n>PHYSTOP</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>];</span><span class=w>  </span><span class=c1>// 引用计数</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5></a><span class=p>}</span><span class=w> </span><span class=n>ref</span><span class=p>;</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6></a><span class=c1>// ==========================================================</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7></a>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8></a><span class=kt>void</span><span class=w> </span><span class=nf>kinit</span><span class=p>()</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9></a><span class=p>{</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10></a><span class=w>    </span><span class=n>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=s>"kmem"</span><span class=p>);</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11></a><span class=w>    </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12></a><span class=w>    </span><span class=n>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=s>"ref"</span><span class=p>);</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14></a><span class=w>    </span><span class=n>freerange</span><span class=p>(</span><span class=n>end</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>PHYSTOP</span><span class=p>);</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>修改<code>kalloc</code>和<code>kfree</code>函数，在<code>kalloc</code>中初始化内存引用计数为1，在<code>kfree</code>函数中对内存引用计数减1，如果引用计数为0时才真正删除，并修改<code>freerange</code>函数:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-60-1> 1</a></span>
<span class=normal><a href=#__codelineno-60-2> 2</a></span>
<span class=normal><a href=#__codelineno-60-3> 3</a></span>
<span class=normal><a href=#__codelineno-60-4> 4</a></span>
<span class=normal><a href=#__codelineno-60-5> 5</a></span>
<span class=normal><a href=#__codelineno-60-6> 6</a></span>
<span class=normal><a href=#__codelineno-60-7> 7</a></span>
<span class=normal><a href=#__codelineno-60-8> 8</a></span>
<span class=normal><a href=#__codelineno-60-9> 9</a></span>
<span class=normal><a href=#__codelineno-60-10>10</a></span>
<span class=normal><a href=#__codelineno-60-11>11</a></span>
<span class=normal><a href=#__codelineno-60-12>12</a></span>
<span class=normal><a href=#__codelineno-60-13>13</a></span>
<span class=normal><a href=#__codelineno-60-14>14</a></span>
<span class=normal><a href=#__codelineno-60-15>15</a></span>
<span class=normal><a href=#__codelineno-60-16>16</a></span>
<span class=normal><a href=#__codelineno-60-17>17</a></span>
<span class=normal><a href=#__codelineno-60-18>18</a></span>
<span class=normal><a href=#__codelineno-60-19>19</a></span>
<span class=normal><a href=#__codelineno-60-20>20</a></span>
<span class=normal><a href=#__codelineno-60-21>21</a></span>
<span class=normal><a href=#__codelineno-60-22>22</a></span>
<span class=normal><a href=#__codelineno-60-23>23</a></span>
<span class=normal><a href=#__codelineno-60-24>24</a></span>
<span class=normal><a href=#__codelineno-60-25>25</a></span>
<span class=normal><a href=#__codelineno-60-26>26</a></span>
<span class=normal><a href=#__codelineno-60-27>27</a></span>
<span class=normal><a href=#__codelineno-60-28>28</a></span>
<span class=normal><a href=#__codelineno-60-29>29</a></span>
<span class=normal><a href=#__codelineno-60-30>30</a></span>
<span class=normal><a href=#__codelineno-60-31>31</a></span>
<span class=normal><a href=#__codelineno-60-32>32</a></span>
<span class=normal><a href=#__codelineno-60-33>33</a></span>
<span class=normal><a href=#__codelineno-60-34>34</a></span>
<span class=normal><a href=#__codelineno-60-35>35</a></span>
<span class=normal><a href=#__codelineno-60-36>36</a></span>
<span class=normal><a href=#__codelineno-60-37>37</a></span>
<span class=normal><a href=#__codelineno-60-38>38</a></span>
<span class=normal><a href=#__codelineno-60-39>39</a></span>
<span class=normal><a href=#__codelineno-60-40>40</a></span>
<span class=normal><a href=#__codelineno-60-41>41</a></span>
<span class=normal><a href=#__codelineno-60-42>42</a></span>
<span class=normal><a href=#__codelineno-60-43>43</a></span>
<span class=normal><a href=#__codelineno-60-44>44</a></span>
<span class=normal><a href=#__codelineno-60-45>45</a></span>
<span class=normal><a href=#__codelineno-60-46>46</a></span>
<span class=normal><a href=#__codelineno-60-47>47</a></span>
<span class=normal><a href=#__codelineno-60-48>48</a></span>
<span class=normal><a href=#__codelineno-60-49>49</a></span>
<span class=normal><a href=#__codelineno-60-50>50</a></span>
<span class=normal><a href=#__codelineno-60-51>51</a></span>
<span class=normal><a href=#__codelineno-60-52>52</a></span>
<span class=normal><a href=#__codelineno-60-53>53</a></span>
<span class=normal><a href=#__codelineno-60-54>54</a></span>
<span class=normal><a href=#__codelineno-60-55>55</a></span>
<span class=normal><a href=#__codelineno-60-56>56</a></span>
<span class=normal><a href=#__codelineno-60-57>57</a></span>
<span class=normal><a href=#__codelineno-60-58>58</a></span>
<span class=normal><a href=#__codelineno-60-59>59</a></span>
<span class=normal><a href=#__codelineno-60-60>60</a></span>
<span class=normal><a href=#__codelineno-60-61>61</a></span>
<span class=normal><a href=#__codelineno-60-62>62</a></span>
<span class=normal><a href=#__codelineno-60-63>63</a></span>
<span class=normal><a href=#__codelineno-60-64>64</a></span>
<span class=normal><a href=#__codelineno-60-65>65</a></span>
<span class=normal><a href=#__codelineno-60-66>66</a></span>
<span class=normal><a href=#__codelineno-60-67>67</a></span>
<span class=normal><a href=#__codelineno-60-68>68</a></span>
<span class=normal><a href=#__codelineno-60-69>69</a></span>
<span class=normal><a href=#__codelineno-60-70>70</a></span>
<span class=normal><a href=#__codelineno-60-71>71</a></span>
<span class=normal><a href=#__codelineno-60-72>72</a></span>
<span class=normal><a href=#__codelineno-60-73>73</a></span>
<span class=normal><a href=#__codelineno-60-74>74</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1></a><span class=kt>void</span><span class=w> </span><span class=nf>freerange</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>pa_start</span><span class=p>,</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>pa_end</span><span class=p>)</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2></a><span class=p>{</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4></a><span class=w>    </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDUP</span><span class=p>((</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa_start</span><span class=p>);</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5></a><span class=w>    </span><span class=k>for</span><span class=p>(;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PGSIZE</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa_end</span><span class=p>;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7></a><span class=w>        </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8></a><span class=w>        </span><span class=c1>// 在kfree中将会对cnt[]减1，这里要先设为1，否则就会减成负数</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9></a><span class=w>        </span><span class=n>ref</span><span class=p>.</span><span class=n>cnt</span><span class=p>[(</span><span class=n>uint64</span><span class=p>)</span><span class=n>p</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11></a><span class=w>        </span><span class=n>kfree</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13></a><span class=p>}</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14></a>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15></a><span class=c1>// Free the page of physical memory pointed at by v,</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16></a><span class=c1>// which normally should have been returned by a</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17></a><span class=c1>// call to kalloc().  (The exception is when</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18></a><span class=c1>// initializing the allocator; see kinit above.)</span>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19></a><span class=kt>void</span><span class=w> </span><span class=nf>kfree</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>pa</span><span class=p>)</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20></a><span class=p>{</span>
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22></a>
</span><span id=__span-60-23><a id=__codelineno-60-23 name=__codelineno-60-23></a><span class=w>    </span><span class=k>if</span><span class=p>(((</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>PHYSTOP</span><span class=p>)</span>
</span><span id=__span-60-24><a id=__codelineno-60-24 name=__codelineno-60-24></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"kfree"</span><span class=p>);</span>
</span><span id=__span-60-25><a id=__codelineno-60-25 name=__codelineno-60-25></a>
</span><span id=__span-60-26><a id=__codelineno-60-26 name=__codelineno-60-26></a><span class=w>    </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-60-27><a id=__codelineno-60-27 name=__codelineno-60-27></a><span class=w>    </span><span class=c1>// 只有当引用计数为0了才回收空间</span>
</span><span id=__span-60-28><a id=__codelineno-60-28 name=__codelineno-60-28></a><span class=w>    </span><span class=c1>// 否则只是将引用计数减1</span>
</span><span id=__span-60-29><a id=__codelineno-60-29 name=__codelineno-60-29></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-30><a id=__codelineno-60-30 name=__codelineno-60-30></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=o>--</span><span class=n>ref</span><span class=p>.</span><span class=n>cnt</span><span class=p>[(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-60-31><a id=__codelineno-60-31 name=__codelineno-60-31></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-60-32><a id=__codelineno-60-32 name=__codelineno-60-32></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-33><a id=__codelineno-60-33 name=__codelineno-60-33></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-60-34><a id=__codelineno-60-34 name=__codelineno-60-34></a>
</span><span id=__span-60-35><a id=__codelineno-60-35 name=__codelineno-60-35></a><span class=w>        </span><span class=c1>// Fill with junk to catch dangling refs.</span>
</span><span id=__span-60-36><a id=__codelineno-60-36 name=__codelineno-60-36></a><span class=w>        </span><span class=n>memset</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-60-37><a id=__codelineno-60-37 name=__codelineno-60-37></a>
</span><span id=__span-60-38><a id=__codelineno-60-38 name=__codelineno-60-38></a><span class=w>        </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>;</span>
</span><span id=__span-60-39><a id=__codelineno-60-39 name=__codelineno-60-39></a>
</span><span id=__span-60-40><a id=__codelineno-60-40 name=__codelineno-60-40></a><span class=w>        </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-41><a id=__codelineno-60-41 name=__codelineno-60-41></a><span class=w>        </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-60-42><a id=__codelineno-60-42 name=__codelineno-60-42></a><span class=w>        </span><span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-60-43><a id=__codelineno-60-43 name=__codelineno-60-43></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-44><a id=__codelineno-60-44 name=__codelineno-60-44></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-60-45><a id=__codelineno-60-45 name=__codelineno-60-45></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-60-46><a id=__codelineno-60-46 name=__codelineno-60-46></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-60-47><a id=__codelineno-60-47 name=__codelineno-60-47></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-48><a id=__codelineno-60-48 name=__codelineno-60-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-60-49><a id=__codelineno-60-49 name=__codelineno-60-49></a><span class=p>}</span>
</span><span id=__span-60-50><a id=__codelineno-60-50 name=__codelineno-60-50></a>
</span><span id=__span-60-51><a id=__codelineno-60-51 name=__codelineno-60-51></a><span class=c1>// Allocate one 4096-byte page of physical memory.</span>
</span><span id=__span-60-52><a id=__codelineno-60-52 name=__codelineno-60-52></a><span class=c1>// Returns a pointer that the kernel can use.</span>
</span><span id=__span-60-53><a id=__codelineno-60-53 name=__codelineno-60-53></a><span class=c1>// Returns 0 if the memory cannot be allocated.</span>
</span><span id=__span-60-54><a id=__codelineno-60-54 name=__codelineno-60-54></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nf>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-60-55><a id=__codelineno-60-55 name=__codelineno-60-55></a><span class=p>{</span>
</span><span id=__span-60-56><a id=__codelineno-60-56 name=__codelineno-60-56></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-60-57><a id=__codelineno-60-57 name=__codelineno-60-57></a>
</span><span id=__span-60-58><a id=__codelineno-60-58 name=__codelineno-60-58></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-59><a id=__codelineno-60-59 name=__codelineno-60-59></a><span class=w>    </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-60-60><a id=__codelineno-60-60 name=__codelineno-60-60></a><span class=w>    </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-60-61><a id=__codelineno-60-61 name=__codelineno-60-61></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-60-62><a id=__codelineno-60-62 name=__codelineno-60-62></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-60-63><a id=__codelineno-60-63 name=__codelineno-60-63></a><span class=w>        </span><span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-60-64><a id=__codelineno-60-64 name=__codelineno-60-64></a><span class=w>        </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-65><a id=__codelineno-60-65 name=__codelineno-60-65></a><span class=w>        </span><span class=n>ref</span><span class=p>.</span><span class=n>cnt</span><span class=p>[(</span><span class=n>uint64</span><span class=p>)</span><span class=n>r</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>  </span><span class=c1>// 将引用计数初始化为1</span>
</span><span id=__span-60-66><a id=__codelineno-60-66 name=__codelineno-60-66></a><span class=w>        </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-67><a id=__codelineno-60-67 name=__codelineno-60-67></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-60-68><a id=__codelineno-60-68 name=__codelineno-60-68></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-60-69><a id=__codelineno-60-69 name=__codelineno-60-69></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-60-70><a id=__codelineno-60-70 name=__codelineno-60-70></a>
</span><span id=__span-60-71><a id=__codelineno-60-71 name=__codelineno-60-71></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span><span id=__span-60-72><a id=__codelineno-60-72 name=__codelineno-60-72></a><span class=w>        </span><span class=n>memset</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span><span class=w> </span><span class=c1>// fill with junk</span>
</span><span id=__span-60-73><a id=__codelineno-60-73 name=__codelineno-60-73></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-60-74><a id=__codelineno-60-74 name=__codelineno-60-74></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>在<code>kalloc.c</code>中新增如下四个函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-61-1> 1</a></span>
<span class=normal><a href=#__codelineno-61-2> 2</a></span>
<span class=normal><a href=#__codelineno-61-3> 3</a></span>
<span class=normal><a href=#__codelineno-61-4> 4</a></span>
<span class=normal><a href=#__codelineno-61-5> 5</a></span>
<span class=normal><a href=#__codelineno-61-6> 6</a></span>
<span class=normal><a href=#__codelineno-61-7> 7</a></span>
<span class=normal><a href=#__codelineno-61-8> 8</a></span>
<span class=normal><a href=#__codelineno-61-9> 9</a></span>
<span class=normal><a href=#__codelineno-61-10>10</a></span>
<span class=normal><a href=#__codelineno-61-11>11</a></span>
<span class=normal><a href=#__codelineno-61-12>12</a></span>
<span class=normal><a href=#__codelineno-61-13>13</a></span>
<span class=normal><a href=#__codelineno-61-14>14</a></span>
<span class=normal><a href=#__codelineno-61-15>15</a></span>
<span class=normal><a href=#__codelineno-61-16>16</a></span>
<span class=normal><a href=#__codelineno-61-17>17</a></span>
<span class=normal><a href=#__codelineno-61-18>18</a></span>
<span class=normal><a href=#__codelineno-61-19>19</a></span>
<span class=normal><a href=#__codelineno-61-20>20</a></span>
<span class=normal><a href=#__codelineno-61-21>21</a></span>
<span class=normal><a href=#__codelineno-61-22>22</a></span>
<span class=normal><a href=#__codelineno-61-23>23</a></span>
<span class=normal><a href=#__codelineno-61-24>24</a></span>
<span class=normal><a href=#__codelineno-61-25>25</a></span>
<span class=normal><a href=#__codelineno-61-26>26</a></span>
<span class=normal><a href=#__codelineno-61-27>27</a></span>
<span class=normal><a href=#__codelineno-61-28>28</a></span>
<span class=normal><a href=#__codelineno-61-29>29</a></span>
<span class=normal><a href=#__codelineno-61-30>30</a></span>
<span class=normal><a href=#__codelineno-61-31>31</a></span>
<span class=normal><a href=#__codelineno-61-32>32</a></span>
<span class=normal><a href=#__codelineno-61-33>33</a></span>
<span class=normal><a href=#__codelineno-61-34>34</a></span>
<span class=normal><a href=#__codelineno-61-35>35</a></span>
<span class=normal><a href=#__codelineno-61-36>36</a></span>
<span class=normal><a href=#__codelineno-61-37>37</a></span>
<span class=normal><a href=#__codelineno-61-38>38</a></span>
<span class=normal><a href=#__codelineno-61-39>39</a></span>
<span class=normal><a href=#__codelineno-61-40>40</a></span>
<span class=normal><a href=#__codelineno-61-41>41</a></span>
<span class=normal><a href=#__codelineno-61-42>42</a></span>
<span class=normal><a href=#__codelineno-61-43>43</a></span>
<span class=normal><a href=#__codelineno-61-44>44</a></span>
<span class=normal><a href=#__codelineno-61-45>45</a></span>
<span class=normal><a href=#__codelineno-61-46>46</a></span>
<span class=normal><a href=#__codelineno-61-47>47</a></span>
<span class=normal><a href=#__codelineno-61-48>48</a></span>
<span class=normal><a href=#__codelineno-61-49>49</a></span>
<span class=normal><a href=#__codelineno-61-50>50</a></span>
<span class=normal><a href=#__codelineno-61-51>51</a></span>
<span class=normal><a href=#__codelineno-61-52>52</a></span>
<span class=normal><a href=#__codelineno-61-53>53</a></span>
<span class=normal><a href=#__codelineno-61-54>54</a></span>
<span class=normal><a href=#__codelineno-61-55>55</a></span>
<span class=normal><a href=#__codelineno-61-56>56</a></span>
<span class=normal><a href=#__codelineno-61-57>57</a></span>
<span class=normal><a href=#__codelineno-61-58>58</a></span>
<span class=normal><a href=#__codelineno-61-59>59</a></span>
<span class=normal><a href=#__codelineno-61-60>60</a></span>
<span class=normal><a href=#__codelineno-61-61>61</a></span>
<span class=normal><a href=#__codelineno-61-62>62</a></span>
<span class=normal><a href=#__codelineno-61-63>63</a></span>
<span class=normal><a href=#__codelineno-61-64>64</a></span>
<span class=normal><a href=#__codelineno-61-65>65</a></span>
<span class=normal><a href=#__codelineno-61-66>66</a></span>
<span class=normal><a href=#__codelineno-61-67>67</a></span>
<span class=normal><a href=#__codelineno-61-68>68</a></span>
<span class=normal><a href=#__codelineno-61-69>69</a></span>
<span class=normal><a href=#__codelineno-61-70>70</a></span>
<span class=normal><a href=#__codelineno-61-71>71</a></span>
<span class=normal><a href=#__codelineno-61-72>72</a></span>
<span class=normal><a href=#__codelineno-61-73>73</a></span>
<span class=normal><a href=#__codelineno-61-74>74</a></span>
<span class=normal><a href=#__codelineno-61-75>75</a></span>
<span class=normal><a href=#__codelineno-61-76>76</a></span>
<span class=normal><a href=#__codelineno-61-77>77</a></span>
<span class=normal><a href=#__codelineno-61-78>78</a></span>
<span class=normal><a href=#__codelineno-61-79>79</a></span>
<span class=normal><a href=#__codelineno-61-80>80</a></span>
<span class=normal><a href=#__codelineno-61-81>81</a></span>
<span class=normal><a href=#__codelineno-61-82>82</a></span>
<span class=normal><a href=#__codelineno-61-83>83</a></span>
<span class=normal><a href=#__codelineno-61-84>84</a></span>
<span class=normal><a href=#__codelineno-61-85>85</a></span>
<span class=normal><a href=#__codelineno-61-86>86</a></span>
<span class=normal><a href=#__codelineno-61-87>87</a></span>
<span class=normal><a href=#__codelineno-61-88>88</a></span>
<span class=normal><a href=#__codelineno-61-89>89</a></span>
<span class=normal><a href=#__codelineno-61-90>90</a></span>
<span class=normal><a href=#__codelineno-61-91>91</a></span>
<span class=normal><a href=#__codelineno-61-92>92</a></span>
<span class=normal><a href=#__codelineno-61-93>93</a></span>
<span class=normal><a href=#__codelineno-61-94>94</a></span>
<span class=normal><a href=#__codelineno-61-95>95</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1></a><span class=cm>/**</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2></a><span class=cm>* @brief cowpage 判断一个页面是否为COW页面</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3></a><span class=cm>* @param pagetable 指定查询的页表</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4></a><span class=cm>* @param va 虚拟地址</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5></a><span class=cm>* @return 0 是, -1 不是</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6></a><span class=cm>*/</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7></a><span class=kt>int</span><span class=w> </span><span class=nf>cowpage</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8></a><span class=p>{</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>va</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>MAXVA</span><span class=p>)</span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11></a><span class=w>    </span><span class=n>pte_t</span><span class=o>*</span><span class=w> </span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pte</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-61-16><a id=__codelineno-61-16 name=__codelineno-61-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_F</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-61-17><a id=__codelineno-61-17 name=__codelineno-61-17></a><span class=p>}</span>
</span><span id=__span-61-18><a id=__codelineno-61-18 name=__codelineno-61-18></a>
</span><span id=__span-61-19><a id=__codelineno-61-19 name=__codelineno-61-19></a><span class=cm>/**</span>
</span><span id=__span-61-20><a id=__codelineno-61-20 name=__codelineno-61-20></a><span class=cm>* @brief cowalloc copy-on-write分配器</span>
</span><span id=__span-61-21><a id=__codelineno-61-21 name=__codelineno-61-21></a><span class=cm>* @param pagetable 指定页表</span>
</span><span id=__span-61-22><a id=__codelineno-61-22 name=__codelineno-61-22></a><span class=cm>* @param va 指定的虚拟地址,必须页面对齐</span>
</span><span id=__span-61-23><a id=__codelineno-61-23 name=__codelineno-61-23></a><span class=cm>* @return 分配后va对应的物理地址，如果返回0则分配失败</span>
</span><span id=__span-61-24><a id=__codelineno-61-24 name=__codelineno-61-24></a><span class=cm>*/</span>
</span><span id=__span-61-25><a id=__codelineno-61-25 name=__codelineno-61-25></a><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=nf>cowalloc</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>va</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-26><a id=__codelineno-61-26 name=__codelineno-61-26></a><span class=p>{</span>
</span><span id=__span-61-27><a id=__codelineno-61-27 name=__codelineno-61-27></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>va</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-28><a id=__codelineno-61-28 name=__codelineno-61-28></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-29><a id=__codelineno-61-29 name=__codelineno-61-29></a>
</span><span id=__span-61-30><a id=__codelineno-61-30 name=__codelineno-61-30></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walkaddr</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>);</span><span class=w>  </span><span class=c1>// 获取对应的物理地址</span>
</span><span id=__span-61-31><a id=__codelineno-61-31 name=__codelineno-61-31></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pa</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-32><a id=__codelineno-61-32 name=__codelineno-61-32></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-33><a id=__codelineno-61-33 name=__codelineno-61-33></a>
</span><span id=__span-61-34><a id=__codelineno-61-34 name=__codelineno-61-34></a><span class=w>    </span><span class=n>pte_t</span><span class=o>*</span><span class=w> </span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>  </span><span class=c1>// 获取对应的PTE</span>
</span><span id=__span-61-35><a id=__codelineno-61-35 name=__codelineno-61-35></a>
</span><span id=__span-61-36><a id=__codelineno-61-36 name=__codelineno-61-36></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>krefcnt</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-37><a id=__codelineno-61-37 name=__codelineno-61-37></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-61-38><a id=__codelineno-61-38 name=__codelineno-61-38></a><span class=w>        </span><span class=c1>// 只剩一个进程对此物理地址存在引用</span>
</span><span id=__span-61-39><a id=__codelineno-61-39 name=__codelineno-61-39></a><span class=w>        </span><span class=c1>// 则直接修改对应的PTE即可</span>
</span><span id=__span-61-40><a id=__codelineno-61-40 name=__codelineno-61-40></a><span class=w>        </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PTE_W</span><span class=p>;</span>
</span><span id=__span-61-41><a id=__codelineno-61-41 name=__codelineno-61-41></a><span class=w>        </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PTE_F</span><span class=p>;</span>
</span><span id=__span-61-42><a id=__codelineno-61-42 name=__codelineno-61-42></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>;</span>
</span><span id=__span-61-43><a id=__codelineno-61-43 name=__codelineno-61-43></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-61-44><a id=__codelineno-61-44 name=__codelineno-61-44></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-61-45><a id=__codelineno-61-45 name=__codelineno-61-45></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-61-46><a id=__codelineno-61-46 name=__codelineno-61-46></a><span class=w>        </span><span class=c1>// 多个进程对物理内存存在引用</span>
</span><span id=__span-61-47><a id=__codelineno-61-47 name=__codelineno-61-47></a><span class=w>        </span><span class=c1>// 需要分配新的页面，并拷贝旧页面的内容</span>
</span><span id=__span-61-48><a id=__codelineno-61-48 name=__codelineno-61-48></a><span class=w>        </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>mem</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>();</span>
</span><span id=__span-61-49><a id=__codelineno-61-49 name=__codelineno-61-49></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>mem</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-61-50><a id=__codelineno-61-50 name=__codelineno-61-50></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-51><a id=__codelineno-61-51 name=__codelineno-61-51></a>
</span><span id=__span-61-52><a id=__codelineno-61-52 name=__codelineno-61-52></a><span class=w>        </span><span class=c1>// 复制旧页面内容到新页</span>
</span><span id=__span-61-53><a id=__codelineno-61-53 name=__codelineno-61-53></a><span class=w>        </span><span class=n>memmove</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-61-54><a id=__codelineno-61-54 name=__codelineno-61-54></a>
</span><span id=__span-61-55><a id=__codelineno-61-55 name=__codelineno-61-55></a><span class=w>        </span><span class=c1>// 清除PTE_V，否则在mappagges中会判定为remap</span>
</span><span id=__span-61-56><a id=__codelineno-61-56 name=__codelineno-61-56></a><span class=w>        </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>PTE_V</span><span class=p>;</span>
</span><span id=__span-61-57><a id=__codelineno-61-57 name=__codelineno-61-57></a>
</span><span id=__span-61-58><a id=__codelineno-61-58 name=__codelineno-61-58></a><span class=w>        </span><span class=c1>// 为新页面添加映射</span>
</span><span id=__span-61-59><a id=__codelineno-61-59 name=__codelineno-61-59></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>mem</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_W</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>PTE_F</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-60><a id=__codelineno-61-60 name=__codelineno-61-60></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-61-61><a id=__codelineno-61-61 name=__codelineno-61-61></a><span class=w>            </span><span class=n>kfree</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span>
</span><span id=__span-61-62><a id=__codelineno-61-62 name=__codelineno-61-62></a><span class=w>            </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PTE_V</span><span class=p>;</span>
</span><span id=__span-61-63><a id=__codelineno-61-63 name=__codelineno-61-63></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-64><a id=__codelineno-61-64 name=__codelineno-61-64></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-61-65><a id=__codelineno-61-65 name=__codelineno-61-65></a>
</span><span id=__span-61-66><a id=__codelineno-61-66 name=__codelineno-61-66></a><span class=w>        </span><span class=c1>// 将原来的物理内存引用计数减1</span>
</span><span id=__span-61-67><a id=__codelineno-61-67 name=__codelineno-61-67></a><span class=w>        </span><span class=n>kfree</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>pa</span><span class=p>));</span>
</span><span id=__span-61-68><a id=__codelineno-61-68 name=__codelineno-61-68></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mem</span><span class=p>;</span>
</span><span id=__span-61-69><a id=__codelineno-61-69 name=__codelineno-61-69></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-61-70><a id=__codelineno-61-70 name=__codelineno-61-70></a><span class=p>}</span>
</span><span id=__span-61-71><a id=__codelineno-61-71 name=__codelineno-61-71></a>
</span><span id=__span-61-72><a id=__codelineno-61-72 name=__codelineno-61-72></a><span class=cm>/**</span>
</span><span id=__span-61-73><a id=__codelineno-61-73 name=__codelineno-61-73></a><span class=cm>* @brief krefcnt 获取内存的引用计数</span>
</span><span id=__span-61-74><a id=__codelineno-61-74 name=__codelineno-61-74></a><span class=cm>* @param pa 指定的内存地址</span>
</span><span id=__span-61-75><a id=__codelineno-61-75 name=__codelineno-61-75></a><span class=cm>* @return 引用计数</span>
</span><span id=__span-61-76><a id=__codelineno-61-76 name=__codelineno-61-76></a><span class=cm>*/</span>
</span><span id=__span-61-77><a id=__codelineno-61-77 name=__codelineno-61-77></a><span class=kt>int</span><span class=w> </span><span class=nf>krefcnt</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>pa</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-78><a id=__codelineno-61-78 name=__codelineno-61-78></a><span class=p>{</span>
</span><span id=__span-61-79><a id=__codelineno-61-79 name=__codelineno-61-79></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=n>cnt</span><span class=p>[(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>];</span>
</span><span id=__span-61-80><a id=__codelineno-61-80 name=__codelineno-61-80></a><span class=p>}</span>
</span><span id=__span-61-81><a id=__codelineno-61-81 name=__codelineno-61-81></a>
</span><span id=__span-61-82><a id=__codelineno-61-82 name=__codelineno-61-82></a><span class=cm>/**</span>
</span><span id=__span-61-83><a id=__codelineno-61-83 name=__codelineno-61-83></a><span class=cm>* @brief kaddrefcnt 增加内存的引用计数</span>
</span><span id=__span-61-84><a id=__codelineno-61-84 name=__codelineno-61-84></a><span class=cm>* @param pa 指定的内存地址</span>
</span><span id=__span-61-85><a id=__codelineno-61-85 name=__codelineno-61-85></a><span class=cm>* @return 0:成功 -1:失败</span>
</span><span id=__span-61-86><a id=__codelineno-61-86 name=__codelineno-61-86></a><span class=cm>*/</span>
</span><span id=__span-61-87><a id=__codelineno-61-87 name=__codelineno-61-87></a><span class=kt>int</span><span class=w> </span><span class=nf>kaddrefcnt</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>pa</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-61-88><a id=__codelineno-61-88 name=__codelineno-61-88></a><span class=p>{</span>
</span><span id=__span-61-89><a id=__codelineno-61-89 name=__codelineno-61-89></a><span class=w>    </span><span class=k>if</span><span class=p>(((</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>PHYSTOP</span><span class=p>)</span>
</span><span id=__span-61-90><a id=__codelineno-61-90 name=__codelineno-61-90></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-61-91><a id=__codelineno-61-91 name=__codelineno-61-91></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-61-92><a id=__codelineno-61-92 name=__codelineno-61-92></a><span class=w>    </span><span class=o>++</span><span class=n>ref</span><span class=p>.</span><span class=n>cnt</span><span class=p>[(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>];</span>
</span><span id=__span-61-93><a id=__codelineno-61-93 name=__codelineno-61-93></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ref</span><span class=p>.</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-61-94><a id=__codelineno-61-94 name=__codelineno-61-94></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-61-95><a id=__codelineno-61-95 name=__codelineno-61-95></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 修改<code>uvmcopy</code>，不为子进程分配内存，而是使父子进程共享内存，但禁用<code>PTE_W</code>，同时标记<code>PTE_F</code>，记得调用<code>kaddrefcnt</code>增加引用计数:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-62-1> 1</a></span>
<span class=normal><a href=#__codelineno-62-2> 2</a></span>
<span class=normal><a href=#__codelineno-62-3> 3</a></span>
<span class=normal><a href=#__codelineno-62-4> 4</a></span>
<span class=normal><a href=#__codelineno-62-5> 5</a></span>
<span class=normal><a href=#__codelineno-62-6> 6</a></span>
<span class=normal><a href=#__codelineno-62-7> 7</a></span>
<span class=normal><a href=#__codelineno-62-8> 8</a></span>
<span class=normal><a href=#__codelineno-62-9> 9</a></span>
<span class=normal><a href=#__codelineno-62-10>10</a></span>
<span class=normal><a href=#__codelineno-62-11>11</a></span>
<span class=normal><a href=#__codelineno-62-12>12</a></span>
<span class=normal><a href=#__codelineno-62-13>13</a></span>
<span class=normal><a href=#__codelineno-62-14>14</a></span>
<span class=normal><a href=#__codelineno-62-15>15</a></span>
<span class=normal><a href=#__codelineno-62-16>16</a></span>
<span class=normal><a href=#__codelineno-62-17>17</a></span>
<span class=normal><a href=#__codelineno-62-18>18</a></span>
<span class=normal><a href=#__codelineno-62-19>19</a></span>
<span class=normal><a href=#__codelineno-62-20>20</a></span>
<span class=normal><a href=#__codelineno-62-21>21</a></span>
<span class=normal><a href=#__codelineno-62-22>22</a></span>
<span class=normal><a href=#__codelineno-62-23>23</a></span>
<span class=normal><a href=#__codelineno-62-24>24</a></span>
<span class=normal><a href=#__codelineno-62-25>25</a></span>
<span class=normal><a href=#__codelineno-62-26>26</a></span>
<span class=normal><a href=#__codelineno-62-27>27</a></span>
<span class=normal><a href=#__codelineno-62-28>28</a></span>
<span class=normal><a href=#__codelineno-62-29>29</a></span>
<span class=normal><a href=#__codelineno-62-30>30</a></span>
<span class=normal><a href=#__codelineno-62-31>31</a></span>
<span class=normal><a href=#__codelineno-62-32>32</a></span>
<span class=normal><a href=#__codelineno-62-33>33</a></span>
<span class=normal><a href=#__codelineno-62-34>34</a></span>
<span class=normal><a href=#__codelineno-62-35>35</a></span>
<span class=normal><a href=#__codelineno-62-36>36</a></span>
<span class=normal><a href=#__codelineno-62-37>37</a></span>
<span class=normal><a href=#__codelineno-62-38>38</a></span>
<span class=normal><a href=#__codelineno-62-39>39</a></span>
<span class=normal><a href=#__codelineno-62-40>40</a></span>
<span class=normal><a href=#__codelineno-62-41>41</a></span>
<span class=normal><a href=#__codelineno-62-42>42</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1></a><span class=c1>// Given a parent process's page table, copy</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2></a><span class=c1>// its memory into a child's page table.</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3></a><span class=c1>// Copies both the page table and the</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4></a><span class=c1>// physical memory.</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5></a><span class=c1>// returns 0 on success, -1 on failure.</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6></a><span class=c1>// frees any allocated pages on failure.</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7></a><span class=kt>int</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8></a><span class=nf>uvmcopy</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>old</span><span class=p>,</span><span class=w> </span><span class=n>pagetable_t</span><span class=w> </span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>sz</span><span class=p>)</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9></a><span class=p>{</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10></a><span class=w>    </span><span class=n>pte_t</span><span class=w> </span><span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13></a>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>sz</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walk</span><span class=p>(</span><span class=n>old</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmcopy: pte should exist"</span><span class=p>);</span>
</span><span id=__span-62-18><a id=__codelineno-62-18 name=__codelineno-62-18></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-62-19><a id=__codelineno-62-19 name=__codelineno-62-19></a><span class=w>            </span><span class=n>panic</span><span class=p>(</span><span class=s>"uvmcopy: page not present"</span><span class=p>);</span>
</span><span id=__span-62-20><a id=__codelineno-62-20 name=__codelineno-62-20></a><span class=w>        </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-62-21><a id=__codelineno-62-21 name=__codelineno-62-21></a><span class=w>        </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span><span id=__span-62-22><a id=__codelineno-62-22 name=__codelineno-62-22></a>
</span><span id=__span-62-23><a id=__codelineno-62-23 name=__codelineno-62-23></a><span class=w>        </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-62-24><a id=__codelineno-62-24 name=__codelineno-62-24></a><span class=w>        </span><span class=c1>// 仅对可写页面设置COW标记</span>
</span><span id=__span-62-25><a id=__codelineno-62-25 name=__codelineno-62-25></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_W</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-62-26><a id=__codelineno-62-26 name=__codelineno-62-26></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-62-27><a id=__codelineno-62-27 name=__codelineno-62-27></a><span class=w>            </span><span class=c1>// 禁用写并设置COW Fork标记</span>
</span><span id=__span-62-28><a id=__codelineno-62-28 name=__codelineno-62-28></a><span class=w>            </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>flags</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>PTE_F</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>PTE_W</span><span class=p>;</span>
</span><span id=__span-62-29><a id=__codelineno-62-29 name=__codelineno-62-29></a><span class=w>            </span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PA2PTE</span><span class=p>(</span><span class=n>pa</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-62-30><a id=__codelineno-62-30 name=__codelineno-62-30></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-62-31><a id=__codelineno-62-31 name=__codelineno-62-31></a>
</span><span id=__span-62-32><a id=__codelineno-62-32 name=__codelineno-62-32></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-62-33><a id=__codelineno-62-33 name=__codelineno-62-33></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-62-34><a id=__codelineno-62-34 name=__codelineno-62-34></a><span class=w>            </span><span class=n>uvmunmap</span><span class=p>(</span><span class=n>new</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-62-35><a id=__codelineno-62-35 name=__codelineno-62-35></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-62-36><a id=__codelineno-62-36 name=__codelineno-62-36></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-62-37><a id=__codelineno-62-37 name=__codelineno-62-37></a><span class=w>        </span><span class=c1>// 增加内存的引用计数</span>
</span><span id=__span-62-38><a id=__codelineno-62-38 name=__codelineno-62-38></a><span class=w>        </span><span class=n>kaddrefcnt</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-62-39><a id=__codelineno-62-39 name=__codelineno-62-39></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-62-40><a id=__codelineno-62-40 name=__codelineno-62-40></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-62-41><a id=__codelineno-62-41 name=__codelineno-62-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-62-42><a id=__codelineno-62-42 name=__codelineno-62-42></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改<code>usertrap</code>，处理页面错误:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-63-1> 1</a></span>
<span class=normal><a href=#__codelineno-63-2> 2</a></span>
<span class=normal><a href=#__codelineno-63-3> 3</a></span>
<span class=normal><a href=#__codelineno-63-4> 4</a></span>
<span class=normal><a href=#__codelineno-63-5> 5</a></span>
<span class=normal><a href=#__codelineno-63-6> 6</a></span>
<span class=normal><a href=#__codelineno-63-7> 7</a></span>
<span class=normal><a href=#__codelineno-63-8> 8</a></span>
<span class=normal><a href=#__codelineno-63-9> 9</a></span>
<span class=normal><a href=#__codelineno-63-10>10</a></span>
<span class=normal><a href=#__codelineno-63-11>11</a></span>
<span class=normal><a href=#__codelineno-63-12>12</a></span>
<span class=normal><a href=#__codelineno-63-13>13</a></span>
<span class=normal><a href=#__codelineno-63-14>14</a></span>
<span class=normal><a href=#__codelineno-63-15>15</a></span>
<span class=normal><a href=#__codelineno-63-16>16</a></span>
<span class=normal><a href=#__codelineno-63-17>17</a></span>
<span class=normal><a href=#__codelineno-63-18>18</a></span>
<span class=normal><a href=#__codelineno-63-19>19</a></span>
<span class=normal><a href=#__codelineno-63-20>20</a></span>
<span class=normal><a href=#__codelineno-63-21>21</a></span>
<span class=normal><a href=#__codelineno-63-22>22</a></span>
<span class=normal><a href=#__codelineno-63-23>23</a></span>
<span class=normal><a href=#__codelineno-63-24>24</a></span>
<span class=normal><a href=#__codelineno-63-25>25</a></span>
<span class=normal><a href=#__codelineno-63-26>26</a></span>
<span class=normal><a href=#__codelineno-63-27>27</a></span>
<span class=normal><a href=#__codelineno-63-28>28</a></span>
<span class=normal><a href=#__codelineno-63-29>29</a></span>
<span class=normal><a href=#__codelineno-63-30>30</a></span>
<span class=normal><a href=#__codelineno-63-31>31</a></span>
<span class=normal><a href=#__codelineno-63-32>32</a></span>
<span class=normal><a href=#__codelineno-63-33>33</a></span>
<span class=normal><a href=#__codelineno-63-34>34</a></span>
<span class=normal><a href=#__codelineno-63-35>35</a></span>
<span class=normal><a href=#__codelineno-63-36>36</a></span>
<span class=normal><a href=#__codelineno-63-37>37</a></span>
<span class=normal><a href=#__codelineno-63-38>38</a></span>
<span class=normal><a href=#__codelineno-63-39>39</a></span>
<span class=normal><a href=#__codelineno-63-40>40</a></span>
<span class=normal><a href=#__codelineno-63-41>41</a></span>
<span class=normal><a href=#__codelineno-63-42>42</a></span>
<span class=normal><a href=#__codelineno-63-43>43</a></span>
<span class=normal><a href=#__codelineno-63-44>44</a></span>
<span class=normal><a href=#__codelineno-63-45>45</a></span>
<span class=normal><a href=#__codelineno-63-46>46</a></span>
<span class=normal><a href=#__codelineno-63-47>47</a></span>
<span class=normal><a href=#__codelineno-63-48>48</a></span>
<span class=normal><a href=#__codelineno-63-49>49</a></span>
<span class=normal><a href=#__codelineno-63-50>50</a></span>
<span class=normal><a href=#__codelineno-63-51>51</a></span>
<span class=normal><a href=#__codelineno-63-52>52</a></span>
<span class=normal><a href=#__codelineno-63-53>53</a></span>
<span class=normal><a href=#__codelineno-63-54>54</a></span>
<span class=normal><a href=#__codelineno-63-55>55</a></span>
<span class=normal><a href=#__codelineno-63-56>56</a></span>
<span class=normal><a href=#__codelineno-63-57>57</a></span>
<span class=normal><a href=#__codelineno-63-58>58</a></span>
<span class=normal><a href=#__codelineno-63-59>59</a></span>
<span class=normal><a href=#__codelineno-63-60>60</a></span>
<span class=normal><a href=#__codelineno-63-61>61</a></span>
<span class=normal><a href=#__codelineno-63-62>62</a></span>
<span class=normal><a href=#__codelineno-63-63>63</a></span>
<span class=normal><a href=#__codelineno-63-64>64</a></span>
<span class=normal><a href=#__codelineno-63-65>65</a></span>
<span class=normal><a href=#__codelineno-63-66>66</a></span>
<span class=normal><a href=#__codelineno-63-67>67</a></span>
<span class=normal><a href=#__codelineno-63-68>68</a></span>
<span class=normal><a href=#__codelineno-63-69>69</a></span>
<span class=normal><a href=#__codelineno-63-70>70</a></span>
<span class=normal><a href=#__codelineno-63-71>71</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1></a><span class=c1>//</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2></a><span class=c1>// handle an interrupt, exception, or system call from user space.</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3></a><span class=c1>// called from trampoline.S</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4></a><span class=c1>//</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5></a><span class=kt>void</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6></a><span class=nf>usertrap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7></a><span class=p>{</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>which_dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9></a>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>r_sstatus</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>SSTATUS_SPP</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"usertrap: not from user mode"</span><span class=p>);</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12></a>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13></a><span class=w>    </span><span class=c1>// send interrupts and exceptions to kerneltrap(),</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14></a><span class=w>    </span><span class=c1>// since we're now in the kernel.</span>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15></a><span class=w>    </span><span class=n>w_stvec</span><span class=p>((</span><span class=n>uint64</span><span class=p>)</span><span class=n>kernelvec</span><span class=p>);</span>
</span><span id=__span-63-16><a id=__codelineno-63-16 name=__codelineno-63-16></a>
</span><span id=__span-63-17><a id=__codelineno-63-17 name=__codelineno-63-17></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-63-18><a id=__codelineno-63-18 name=__codelineno-63-18></a>
</span><span id=__span-63-19><a id=__codelineno-63-19 name=__codelineno-63-19></a><span class=w>    </span><span class=c1>// save user program counter.</span>
</span><span id=__span-63-20><a id=__codelineno-63-20 name=__codelineno-63-20></a><span class=w>    </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_sepc</span><span class=p>();</span>
</span><span id=__span-63-21><a id=__codelineno-63-21 name=__codelineno-63-21></a>
</span><span id=__span-63-22><a id=__codelineno-63-22 name=__codelineno-63-22></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_scause</span><span class=p>();</span>
</span><span id=__span-63-23><a id=__codelineno-63-23 name=__codelineno-63-23></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-63-24><a id=__codelineno-63-24 name=__codelineno-63-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-63-25><a id=__codelineno-63-25 name=__codelineno-63-25></a><span class=w>        </span><span class=c1>// system call</span>
</span><span id=__span-63-26><a id=__codelineno-63-26 name=__codelineno-63-26></a>
</span><span id=__span-63-27><a id=__codelineno-63-27 name=__codelineno-63-27></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=p>)</span>
</span><span id=__span-63-28><a id=__codelineno-63-28 name=__codelineno-63-28></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-63-29><a id=__codelineno-63-29 name=__codelineno-63-29></a>
</span><span id=__span-63-30><a id=__codelineno-63-30 name=__codelineno-63-30></a><span class=w>        </span><span class=c1>// sepc points to the ecall instruction,</span>
</span><span id=__span-63-31><a id=__codelineno-63-31 name=__codelineno-63-31></a><span class=w>        </span><span class=c1>// but we want to return to the next instruction.</span>
</span><span id=__span-63-32><a id=__codelineno-63-32 name=__codelineno-63-32></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-63-33><a id=__codelineno-63-33 name=__codelineno-63-33></a>
</span><span id=__span-63-34><a id=__codelineno-63-34 name=__codelineno-63-34></a><span class=w>        </span><span class=c1>// an interrupt will change sstatus &amp;c registers,</span>
</span><span id=__span-63-35><a id=__codelineno-63-35 name=__codelineno-63-35></a><span class=w>        </span><span class=c1>// so don't enable until done with those registers.</span>
</span><span id=__span-63-36><a id=__codelineno-63-36 name=__codelineno-63-36></a><span class=w>        </span><span class=n>intr_on</span><span class=p>();</span>
</span><span id=__span-63-37><a id=__codelineno-63-37 name=__codelineno-63-37></a>
</span><span id=__span-63-38><a id=__codelineno-63-38 name=__codelineno-63-38></a><span class=w>        </span><span class=n>syscall</span><span class=p>();</span>
</span><span id=__span-63-39><a id=__codelineno-63-39 name=__codelineno-63-39></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-63-40><a id=__codelineno-63-40 name=__codelineno-63-40></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>((</span><span class=n>which_dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>devintr</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-63-41><a id=__codelineno-63-41 name=__codelineno-63-41></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-63-42><a id=__codelineno-63-42 name=__codelineno-63-42></a><span class=w>        </span><span class=c1>// ok</span>
</span><span id=__span-63-43><a id=__codelineno-63-43 name=__codelineno-63-43></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-63-44><a id=__codelineno-63-44 name=__codelineno-63-44></a><span class=w>    </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-63-45><a id=__codelineno-63-45 name=__codelineno-63-45></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>13</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>15</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-63-46><a id=__codelineno-63-46 name=__codelineno-63-46></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-63-47><a id=__codelineno-63-47 name=__codelineno-63-47></a><span class=w>        </span><span class=n>uint64</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_stval</span><span class=p>();</span><span class=w>  </span><span class=c1>// 获取出错的虚拟地址</span>
</span><span id=__span-63-48><a id=__codelineno-63-48 name=__codelineno-63-48></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>fault_va</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span>
</span><span id=__span-63-49><a id=__codelineno-63-49 name=__codelineno-63-49></a><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=n>cowpage</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>fault_va</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-63-50><a id=__codelineno-63-50 name=__codelineno-63-50></a><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=n>cowalloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>fault_va</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-63-51><a id=__codelineno-63-51 name=__codelineno-63-51></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-63-52><a id=__codelineno-63-52 name=__codelineno-63-52></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-63-53><a id=__codelineno-63-53 name=__codelineno-63-53></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-63-54><a id=__codelineno-63-54 name=__codelineno-63-54></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-63-55><a id=__codelineno-63-55 name=__codelineno-63-55></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-63-56><a id=__codelineno-63-56 name=__codelineno-63-56></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-63-57><a id=__codelineno-63-57 name=__codelineno-63-57></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-63-58><a id=__codelineno-63-58 name=__codelineno-63-58></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"usertrap(): unexpected scause %p pid=%d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>r_scause</span><span class=p>(),</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-63-59><a id=__codelineno-63-59 name=__codelineno-63-59></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"            sepc=%p stval=%p</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>r_sepc</span><span class=p>(),</span><span class=w> </span><span class=n>r_stval</span><span class=p>());</span>
</span><span id=__span-63-60><a id=__codelineno-63-60 name=__codelineno-63-60></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-63-61><a id=__codelineno-63-61 name=__codelineno-63-61></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-63-62><a id=__codelineno-63-62 name=__codelineno-63-62></a>
</span><span id=__span-63-63><a id=__codelineno-63-63 name=__codelineno-63-63></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=p>)</span>
</span><span id=__span-63-64><a id=__codelineno-63-64 name=__codelineno-63-64></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-63-65><a id=__codelineno-63-65 name=__codelineno-63-65></a>
</span><span id=__span-63-66><a id=__codelineno-63-66 name=__codelineno-63-66></a><span class=w>    </span><span class=c1>// give up the CPU if this is a timer interrupt.</span>
</span><span id=__span-63-67><a id=__codelineno-63-67 name=__codelineno-63-67></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>which_dev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-63-68><a id=__codelineno-63-68 name=__codelineno-63-68></a><span class=w>        </span><span class=n>yield</span><span class=p>();</span>
</span><span id=__span-63-69><a id=__codelineno-63-69 name=__codelineno-63-69></a>
</span><span id=__span-63-70><a id=__codelineno-63-70 name=__codelineno-63-70></a><span class=w>    </span><span class=n>usertrapret</span><span class=p>();</span>
</span><span id=__span-63-71><a id=__codelineno-63-71 name=__codelineno-63-71></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 在<code>copyout</code>中处理相同的情况，如果是COW页面，需要更换pa0指向的物理地址:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-64-1> 1</a></span>
<span class=normal><a href=#__codelineno-64-2> 2</a></span>
<span class=normal><a href=#__codelineno-64-3> 3</a></span>
<span class=normal><a href=#__codelineno-64-4> 4</a></span>
<span class=normal><a href=#__codelineno-64-5> 5</a></span>
<span class=normal><a href=#__codelineno-64-6> 6</a></span>
<span class=normal><a href=#__codelineno-64-7> 7</a></span>
<span class=normal><a href=#__codelineno-64-8> 8</a></span>
<span class=normal><a href=#__codelineno-64-9> 9</a></span>
<span class=normal><a href=#__codelineno-64-10>10</a></span>
<span class=normal><a href=#__codelineno-64-11>11</a></span>
<span class=normal><a href=#__codelineno-64-12>12</a></span>
<span class=normal><a href=#__codelineno-64-13>13</a></span>
<span class=normal><a href=#__codelineno-64-14>14</a></span>
<span class=normal><a href=#__codelineno-64-15>15</a></span>
<span class=normal><a href=#__codelineno-64-16>16</a></span>
<span class=normal><a href=#__codelineno-64-17>17</a></span>
<span class=normal><a href=#__codelineno-64-18>18</a></span>
<span class=normal><a href=#__codelineno-64-19>19</a></span>
<span class=normal><a href=#__codelineno-64-20>20</a></span>
<span class=normal><a href=#__codelineno-64-21>21</a></span>
<span class=normal><a href=#__codelineno-64-22>22</a></span>
<span class=normal><a href=#__codelineno-64-23>23</a></span>
<span class=normal><a href=#__codelineno-64-24>24</a></span>
<span class=normal><a href=#__codelineno-64-25>25</a></span>
<span class=normal><a href=#__codelineno-64-26>26</a></span>
<span class=normal><a href=#__codelineno-64-27>27</a></span>
<span class=normal><a href=#__codelineno-64-28>28</a></span>
<span class=normal><a href=#__codelineno-64-29>29</a></span>
<span class=normal><a href=#__codelineno-64-30>30</a></span>
<span class=normal><a href=#__codelineno-64-31>31</a></span>
<span class=normal><a href=#__codelineno-64-32>32</a></span>
<span class=normal><a href=#__codelineno-64-33>33</a></span>
<span class=normal><a href=#__codelineno-64-34>34</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1></a><span class=c1>// Copy from kernel to user.</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2></a><span class=c1>// Copy len bytes from src to virtual address dstva in a given page table.</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3></a><span class=c1>// Return 0 on success, -1 on error.</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4></a><span class=kt>int</span><span class=w> </span><span class=nf>copyout</span><span class=p>(</span><span class=n>pagetable_t</span><span class=w> </span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>dstva</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>src</span><span class=p>,</span><span class=w> </span><span class=n>uint64</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5></a><span class=p>{</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>va0</span><span class=p>,</span><span class=w> </span><span class=n>pa0</span><span class=p>;</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7></a>
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10></a><span class=w>        </span><span class=n>va0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>dstva</span><span class=p>);</span>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11></a><span class=w>        </span><span class=n>pa0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>walkaddr</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va0</span><span class=p>);</span>
</span><span id=__span-64-12><a id=__codelineno-64-12 name=__codelineno-64-12></a>
</span><span id=__span-64-13><a id=__codelineno-64-13 name=__codelineno-64-13></a><span class=w>        </span><span class=c1>// ===================== solution for COW ==================</span>
</span><span id=__span-64-14><a id=__codelineno-64-14 name=__codelineno-64-14></a><span class=w>        </span><span class=c1>// 处理COW页面的情况</span>
</span><span id=__span-64-15><a id=__codelineno-64-15 name=__codelineno-64-15></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>cowpage</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va0</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-64-16><a id=__codelineno-64-16 name=__codelineno-64-16></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-64-17><a id=__codelineno-64-17 name=__codelineno-64-17></a><span class=w>            </span><span class=c1>// 更换目标物理地址</span>
</span><span id=__span-64-18><a id=__codelineno-64-18 name=__codelineno-64-18></a><span class=w>            </span><span class=n>pa0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>cowalloc</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>va0</span><span class=p>);</span>
</span><span id=__span-64-19><a id=__codelineno-64-19 name=__codelineno-64-19></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-64-20><a id=__codelineno-64-20 name=__codelineno-64-20></a><span class=w>        </span><span class=c1>// ==========================================================</span>
</span><span id=__span-64-21><a id=__codelineno-64-21 name=__codelineno-64-21></a>
</span><span id=__span-64-22><a id=__codelineno-64-22 name=__codelineno-64-22></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>pa0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-64-23><a id=__codelineno-64-23 name=__codelineno-64-23></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-64-24><a id=__codelineno-64-24 name=__codelineno-64-24></a><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PGSIZE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=p>(</span><span class=n>dstva</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>va0</span><span class=p>);</span>
</span><span id=__span-64-25><a id=__codelineno-64-25 name=__codelineno-64-25></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>n</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
</span><span id=__span-64-26><a id=__codelineno-64-26 name=__codelineno-64-26></a><span class=w>        </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>len</span><span class=p>;</span>
</span><span id=__span-64-27><a id=__codelineno-64-27 name=__codelineno-64-27></a><span class=w>        </span><span class=n>memmove</span><span class=p>((</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)(</span><span class=n>pa0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>dstva</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>va0</span><span class=p>)),</span><span class=w> </span><span class=n>src</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-64-28><a id=__codelineno-64-28 name=__codelineno-64-28></a>
</span><span id=__span-64-29><a id=__codelineno-64-29 name=__codelineno-64-29></a><span class=w>        </span><span class=n>len</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-64-30><a id=__codelineno-64-30 name=__codelineno-64-30></a><span class=w>        </span><span class=n>src</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-64-31><a id=__codelineno-64-31 name=__codelineno-64-31></a><span class=w>        </span><span class=n>dstva</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>va0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>;</span>
</span><span id=__span-64-32><a id=__codelineno-64-32 name=__codelineno-64-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-64-33><a id=__codelineno-64-33 name=__codelineno-64-33></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-64-34><a id=__codelineno-64-34 name=__codelineno-64-34></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab7-multithreading>Lab7: Multithreading<a class=headerlink href=#lab7-multithreading title="Permanent link">¶</a></h2> <ol> <li> <p>Uthread: switching between threads</p> <p>(1) 定义存储上下文的结构体<code>tcontext</code>:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-65-1> 1</a></span>
<span class=normal><a href=#__codelineno-65-2> 2</a></span>
<span class=normal><a href=#__codelineno-65-3> 3</a></span>
<span class=normal><a href=#__codelineno-65-4> 4</a></span>
<span class=normal><a href=#__codelineno-65-5> 5</a></span>
<span class=normal><a href=#__codelineno-65-6> 6</a></span>
<span class=normal><a href=#__codelineno-65-7> 7</a></span>
<span class=normal><a href=#__codelineno-65-8> 8</a></span>
<span class=normal><a href=#__codelineno-65-9> 9</a></span>
<span class=normal><a href=#__codelineno-65-10>10</a></span>
<span class=normal><a href=#__codelineno-65-11>11</a></span>
<span class=normal><a href=#__codelineno-65-12>12</a></span>
<span class=normal><a href=#__codelineno-65-13>13</a></span>
<span class=normal><a href=#__codelineno-65-14>14</a></span>
<span class=normal><a href=#__codelineno-65-15>15</a></span>
<span class=normal><a href=#__codelineno-65-16>16</a></span>
<span class=normal><a href=#__codelineno-65-17>17</a></span>
<span class=normal><a href=#__codelineno-65-18>18</a></span>
<span class=normal><a href=#__codelineno-65-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1></a><span class=c1>// 用户线程的上下文结构体</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2></a><span class=k>struct</span><span class=w> </span><span class=nc>tcontext</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>ra</span><span class=p>;</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>sp</span><span class=p>;</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5></a>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6></a><span class=w>    </span><span class=c1>// callee-saved</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s0</span><span class=p>;</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s1</span><span class=p>;</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s2</span><span class=p>;</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s3</span><span class=p>;</span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s4</span><span class=p>;</span>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s5</span><span class=p>;</span>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s6</span><span class=p>;</span>
</span><span id=__span-65-14><a id=__codelineno-65-14 name=__codelineno-65-14></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s7</span><span class=p>;</span>
</span><span id=__span-65-15><a id=__codelineno-65-15 name=__codelineno-65-15></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s8</span><span class=p>;</span>
</span><span id=__span-65-16><a id=__codelineno-65-16 name=__codelineno-65-16></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s9</span><span class=p>;</span>
</span><span id=__span-65-17><a id=__codelineno-65-17 name=__codelineno-65-17></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s10</span><span class=p>;</span>
</span><span id=__span-65-18><a id=__codelineno-65-18 name=__codelineno-65-18></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>s11</span><span class=p>;</span>
</span><span id=__span-65-19><a id=__codelineno-65-19 name=__codelineno-65-19></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 修改<code>thread</code>结构体，添加<code>context</code>字段:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-66-1>1</a></span>
<span class=normal><a href=#__codelineno-66-2>2</a></span>
<span class=normal><a href=#__codelineno-66-3>3</a></span>
<span class=normal><a href=#__codelineno-66-4>4</a></span>
<span class=normal><a href=#__codelineno-66-5>5</a></span>
<span class=normal><a href=#__codelineno-66-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1></a><span class=k>struct</span><span class=w> </span><span class=nc>thread</span><span class=w> </span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2></a><span class=p>{</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3></a><span class=w>    </span><span class=kt>char</span><span class=w>            </span><span class=n>stack</span><span class=p>[</span><span class=n>STACK_SIZE</span><span class=p>];</span><span class=w>  </span><span class=cm>/* the thread's stack */</span>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4></a><span class=w>    </span><span class=kt>int</span><span class=w>             </span><span class=n>state</span><span class=p>;</span><span class=w>              </span><span class=cm>/* FREE, RUNNING, RUNNABLE */</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>tcontext</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>            </span><span class=cm>/* 用户进程上下文 */</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 模仿<code>kernel/swtch.S</code>，在<code>kernel/uthread_switch.S</code>中写入如下代码:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-67-1> 1</a></span>
<span class=normal><a href=#__codelineno-67-2> 2</a></span>
<span class=normal><a href=#__codelineno-67-3> 3</a></span>
<span class=normal><a href=#__codelineno-67-4> 4</a></span>
<span class=normal><a href=#__codelineno-67-5> 5</a></span>
<span class=normal><a href=#__codelineno-67-6> 6</a></span>
<span class=normal><a href=#__codelineno-67-7> 7</a></span>
<span class=normal><a href=#__codelineno-67-8> 8</a></span>
<span class=normal><a href=#__codelineno-67-9> 9</a></span>
<span class=normal><a href=#__codelineno-67-10>10</a></span>
<span class=normal><a href=#__codelineno-67-11>11</a></span>
<span class=normal><a href=#__codelineno-67-12>12</a></span>
<span class=normal><a href=#__codelineno-67-13>13</a></span>
<span class=normal><a href=#__codelineno-67-14>14</a></span>
<span class=normal><a href=#__codelineno-67-15>15</a></span>
<span class=normal><a href=#__codelineno-67-16>16</a></span>
<span class=normal><a href=#__codelineno-67-17>17</a></span>
<span class=normal><a href=#__codelineno-67-18>18</a></span>
<span class=normal><a href=#__codelineno-67-19>19</a></span>
<span class=normal><a href=#__codelineno-67-20>20</a></span>
<span class=normal><a href=#__codelineno-67-21>21</a></span>
<span class=normal><a href=#__codelineno-67-22>22</a></span>
<span class=normal><a href=#__codelineno-67-23>23</a></span>
<span class=normal><a href=#__codelineno-67-24>24</a></span>
<span class=normal><a href=#__codelineno-67-25>25</a></span>
<span class=normal><a href=#__codelineno-67-26>26</a></span>
<span class=normal><a href=#__codelineno-67-27>27</a></span>
<span class=normal><a href=#__codelineno-67-28>28</a></span>
<span class=normal><a href=#__codelineno-67-29>29</a></span>
<span class=normal><a href=#__codelineno-67-30>30</a></span>
<span class=normal><a href=#__codelineno-67-31>31</a></span>
<span class=normal><a href=#__codelineno-67-32>32</a></span>
<span class=normal><a href=#__codelineno-67-33>33</a></span>
<span class=normal><a href=#__codelineno-67-34>34</a></span>
<span class=normal><a href=#__codelineno-67-35>35</a></span>
<span class=normal><a href=#__codelineno-67-36>36</a></span>
<span class=normal><a href=#__codelineno-67-37>37</a></span>
<span class=normal><a href=#__codelineno-67-38>38</a></span>
<span class=normal><a href=#__codelineno-67-39>39</a></span>
<span class=normal><a href=#__codelineno-67-40>40</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1></a><span class=p>.</span><span class=n>text</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2></a>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3></a><span class=cm>/*</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4></a><span class=cm>* save the old thread's registers,</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5></a><span class=cm>* restore the new thread's registers.</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6></a><span class=cm>*/</span>
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7></a>
</span><span id=__span-67-8><a id=__codelineno-67-8 name=__codelineno-67-8></a><span class=p>.</span><span class=n>globl</span><span class=w> </span><span class=n>thread_switch</span>
</span><span id=__span-67-9><a id=__codelineno-67-9 name=__codelineno-67-9></a><span class=nl>thread_switch</span><span class=p>:</span>
</span><span id=__span-67-10><a id=__codelineno-67-10 name=__codelineno-67-10></a><span class=w>    </span><span class=cm>/* YOUR CODE HERE */</span>
</span><span id=__span-67-11><a id=__codelineno-67-11 name=__codelineno-67-11></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>ra</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-12><a id=__codelineno-67-12 name=__codelineno-67-12></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>sp</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-13><a id=__codelineno-67-13 name=__codelineno-67-13></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s0</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-14><a id=__codelineno-67-14 name=__codelineno-67-14></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s1</span><span class=p>,</span><span class=w> </span><span class=mi>24</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-15><a id=__codelineno-67-15 name=__codelineno-67-15></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s2</span><span class=p>,</span><span class=w> </span><span class=mi>32</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-16><a id=__codelineno-67-16 name=__codelineno-67-16></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s3</span><span class=p>,</span><span class=w> </span><span class=mi>40</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-17><a id=__codelineno-67-17 name=__codelineno-67-17></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s4</span><span class=p>,</span><span class=w> </span><span class=mi>48</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-18><a id=__codelineno-67-18 name=__codelineno-67-18></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s5</span><span class=p>,</span><span class=w> </span><span class=mi>56</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-19><a id=__codelineno-67-19 name=__codelineno-67-19></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s6</span><span class=p>,</span><span class=w> </span><span class=mi>64</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-20><a id=__codelineno-67-20 name=__codelineno-67-20></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s7</span><span class=p>,</span><span class=w> </span><span class=mi>72</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-21><a id=__codelineno-67-21 name=__codelineno-67-21></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s8</span><span class=p>,</span><span class=w> </span><span class=mi>80</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-22><a id=__codelineno-67-22 name=__codelineno-67-22></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s9</span><span class=p>,</span><span class=w> </span><span class=mi>88</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-23><a id=__codelineno-67-23 name=__codelineno-67-23></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s10</span><span class=p>,</span><span class=w> </span><span class=mi>96</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-24><a id=__codelineno-67-24 name=__codelineno-67-24></a><span class=w>    </span><span class=n>sd</span><span class=w> </span><span class=n>s11</span><span class=p>,</span><span class=w> </span><span class=mi>104</span><span class=p>(</span><span class=n>a0</span><span class=p>)</span>
</span><span id=__span-67-25><a id=__codelineno-67-25 name=__codelineno-67-25></a>
</span><span id=__span-67-26><a id=__codelineno-67-26 name=__codelineno-67-26></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>ra</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-27><a id=__codelineno-67-27 name=__codelineno-67-27></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>sp</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-28><a id=__codelineno-67-28 name=__codelineno-67-28></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s0</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-29><a id=__codelineno-67-29 name=__codelineno-67-29></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s1</span><span class=p>,</span><span class=w> </span><span class=mi>24</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-30><a id=__codelineno-67-30 name=__codelineno-67-30></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s2</span><span class=p>,</span><span class=w> </span><span class=mi>32</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-31><a id=__codelineno-67-31 name=__codelineno-67-31></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s3</span><span class=p>,</span><span class=w> </span><span class=mi>40</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-32><a id=__codelineno-67-32 name=__codelineno-67-32></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s4</span><span class=p>,</span><span class=w> </span><span class=mi>48</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-33><a id=__codelineno-67-33 name=__codelineno-67-33></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s5</span><span class=p>,</span><span class=w> </span><span class=mi>56</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-34><a id=__codelineno-67-34 name=__codelineno-67-34></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s6</span><span class=p>,</span><span class=w> </span><span class=mi>64</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-35><a id=__codelineno-67-35 name=__codelineno-67-35></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s7</span><span class=p>,</span><span class=w> </span><span class=mi>72</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-36><a id=__codelineno-67-36 name=__codelineno-67-36></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s8</span><span class=p>,</span><span class=w> </span><span class=mi>80</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-37><a id=__codelineno-67-37 name=__codelineno-67-37></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s9</span><span class=p>,</span><span class=w> </span><span class=mi>88</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-38><a id=__codelineno-67-38 name=__codelineno-67-38></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s10</span><span class=p>,</span><span class=w> </span><span class=mi>96</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-39><a id=__codelineno-67-39 name=__codelineno-67-39></a><span class=w>    </span><span class=n>ld</span><span class=w> </span><span class=n>s11</span><span class=p>,</span><span class=w> </span><span class=mi>104</span><span class=p>(</span><span class=n>a1</span><span class=p>)</span>
</span><span id=__span-67-40><a id=__codelineno-67-40 name=__codelineno-67-40></a><span class=w>    </span><span class=n>ret</span><span class=w>    </span><span class=cm>/* return to ra */</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改thread_schedule，添加线程切换语句</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-68-1> 1</a></span>
<span class=normal><a href=#__codelineno-68-2> 2</a></span>
<span class=normal><a href=#__codelineno-68-3> 3</a></span>
<span class=normal><a href=#__codelineno-68-4> 4</a></span>
<span class=normal><a href=#__codelineno-68-5> 5</a></span>
<span class=normal><a href=#__codelineno-68-6> 6</a></span>
<span class=normal><a href=#__codelineno-68-7> 7</a></span>
<span class=normal><a href=#__codelineno-68-8> 8</a></span>
<span class=normal><a href=#__codelineno-68-9> 9</a></span>
<span class=normal><a href=#__codelineno-68-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current_thread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>next_thread</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2></a><span class=p>{</span><span class=w>   </span><span class=cm>/* switch threads  */</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3></a><span class=w>    </span><span class=n>next_thread</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RUNNING</span><span class=p>;</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4></a><span class=w>    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current_thread</span><span class=p>;</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5></a><span class=w>    </span><span class=n>current_thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next_thread</span><span class=p>;</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6></a><span class=w>    </span><span class=cm>/* YOUR CODE HERE</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7></a><span class=cm>    * Invoke thread_switch to switch from t to next_thread:</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8></a><span class=cm>    */</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9></a><span class=w>    </span><span class=n>thread_switch</span><span class=p>((</span><span class=n>uint64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>t</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=o>&amp;</span><span class=n>current_thread</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 在<code>thread_create</code>中对<code>thread</code>结构体做一些初始化设定，主要是<code>ra</code>返回地址和<code>sp</code>栈指针:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-69-1>1</a></span>
<span class=normal><a href=#__codelineno-69-2>2</a></span>
<span class=normal><a href=#__codelineno-69-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1></a><span class=c1>// YOUR CODE HERE</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2></a><span class=n>t</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>.</span><span class=n>ra</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>func</span><span class=p>;</span><span class=w>                   </span><span class=c1>// 设定函数返回地址</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3></a><span class=n>t</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>.</span><span class=n>sp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>t</span><span class=o>-&gt;</span><span class=n>stack</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>STACK_SIZE</span><span class=p>;</span><span class=w>  </span><span class=c1>// 设定栈指针，高地址向低地址增长</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Using threads</p> <p>(1) 为每个散列桶定义一个锁，将五个锁放在一个数组中，并进行初始化，<code>ph.c</code>:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-70-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1></a><span class=n>pthread_mutex_t</span><span class=w> </span><span class=n>lock</span><span class=p>[</span><span class=n>NBUCKET</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=w> </span><span class=p>};</span><span class=w> </span><span class=c1>// 每个散列桶一把锁</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 在<code>put</code>函数中对insert上锁:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-71-1>1</a></span>
<span class=normal><a href=#__codelineno-71-2>2</a></span>
<span class=normal><a href=#__codelineno-71-3>3</a></span>
<span class=normal><a href=#__codelineno-71-4>4</a></span>
<span class=normal><a href=#__codelineno-71-5>5</a></span>
<span class=normal><a href=#__codelineno-71-6>6</a></span>
<span class=normal><a href=#__codelineno-71-7>7</a></span>
<span class=normal><a href=#__codelineno-71-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1></a><span class=k>if</span><span class=p>(</span><span class=n>e</span><span class=p>){</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2></a><span class=w>    </span><span class=c1>// update the existing key.</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3></a><span class=w>    </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4></a><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5></a><span class=w>    </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=w>   </span><span class=c1>// 🔒</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6></a><span class=w>    </span><span class=n>insert</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>table</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=w> </span><span class=n>table</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7></a><span class=w>    </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>lock</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span><span class=w> </span><span class=c1>// 🔓</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Barrier: 只要保证下一个round的操作不会影响到上一个还未结束的round中的数据就可以。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-72-1> 1</a></span>
<span class=normal><a href=#__codelineno-72-2> 2</a></span>
<span class=normal><a href=#__codelineno-72-3> 3</a></span>
<span class=normal><a href=#__codelineno-72-4> 4</a></span>
<span class=normal><a href=#__codelineno-72-5> 5</a></span>
<span class=normal><a href=#__codelineno-72-6> 6</a></span>
<span class=normal><a href=#__codelineno-72-7> 7</a></span>
<span class=normal><a href=#__codelineno-72-8> 8</a></span>
<span class=normal><a href=#__codelineno-72-9> 9</a></span>
<span class=normal><a href=#__codelineno-72-10>10</a></span>
<span class=normal><a href=#__codelineno-72-11>11</a></span>
<span class=normal><a href=#__codelineno-72-12>12</a></span>
<span class=normal><a href=#__codelineno-72-13>13</a></span>
<span class=normal><a href=#__codelineno-72-14>14</a></span>
<span class=normal><a href=#__codelineno-72-15>15</a></span>
<span class=normal><a href=#__codelineno-72-16>16</a></span>
<span class=normal><a href=#__codelineno-72-17>17</a></span>
<span class=normal><a href=#__codelineno-72-18>18</a></span>
<span class=normal><a href=#__codelineno-72-19>19</a></span>
<span class=normal><a href=#__codelineno-72-20>20</a></span>
<span class=normal><a href=#__codelineno-72-21>21</a></span>
<span class=normal><a href=#__codelineno-72-22>22</a></span>
<span class=normal><a href=#__codelineno-72-23>23</a></span>
<span class=normal><a href=#__codelineno-72-24>24</a></span>
<span class=normal><a href=#__codelineno-72-25>25</a></span>
<span class=normal><a href=#__codelineno-72-26>26</a></span>
<span class=normal><a href=#__codelineno-72-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1></a><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>barrier</span><span class=p>()</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2></a><span class=p>{</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3></a><span class=w>    </span><span class=c1>// YOUR CODE HERE</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4></a><span class=w>    </span><span class=c1>//</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5></a><span class=w>    </span><span class=c1>// Block until all threads have called barrier() and</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6></a><span class=w>    </span><span class=c1>// then increment bstate.round.</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7></a><span class=w>    </span><span class=c1>// 申请持有锁</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8></a><span class=w>    </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bstate</span><span class=p>.</span><span class=n>barrier_mutex</span><span class=p>);</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9></a>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10></a><span class=w>    </span><span class=n>bstate</span><span class=p>.</span><span class=n>nthread</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>bstate</span><span class=p>.</span><span class=n>nthread</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>nthread</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13></a><span class=w>        </span><span class=c1>// 所有线程已到达</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14></a><span class=w>        </span><span class=n>bstate</span><span class=p>.</span><span class=n>round</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15></a><span class=w>        </span><span class=n>bstate</span><span class=p>.</span><span class=n>nthread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16></a><span class=w>        </span><span class=cm>/* Wake up all threads waiting for condition variables COND.  */</span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17></a><span class=w>        </span><span class=n>pthread_cond_broadcast</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bstate</span><span class=p>.</span><span class=n>barrier_cond</span><span class=p>);</span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-72-19><a id=__codelineno-72-19 name=__codelineno-72-19></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-72-20><a id=__codelineno-72-20 name=__codelineno-72-20></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-72-21><a id=__codelineno-72-21 name=__codelineno-72-21></a><span class=w>        </span><span class=c1>// 等待其他线程</span>
</span><span id=__span-72-22><a id=__codelineno-72-22 name=__codelineno-72-22></a><span class=w>        </span><span class=c1>// 调用pthread_cond_wait时，mutex必须已经持有</span>
</span><span id=__span-72-23><a id=__codelineno-72-23 name=__codelineno-72-23></a><span class=w>        </span><span class=n>pthread_cond_wait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bstate</span><span class=p>.</span><span class=n>barrier_cond</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>bstate</span><span class=p>.</span><span class=n>barrier_mutex</span><span class=p>);</span>
</span><span id=__span-72-24><a id=__codelineno-72-24 name=__codelineno-72-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-72-25><a id=__codelineno-72-25 name=__codelineno-72-25></a><span class=w>    </span><span class=c1>// 释放锁</span>
</span><span id=__span-72-26><a id=__codelineno-72-26 name=__codelineno-72-26></a><span class=w>    </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bstate</span><span class=p>.</span><span class=n>barrier_mutex</span><span class=p>);</span>
</span><span id=__span-72-27><a id=__codelineno-72-27 name=__codelineno-72-27></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab8-locks>Lab8: Locks<a class=headerlink href=#lab8-locks title="Permanent link">¶</a></h2> <ol> <li> <p>Memory allocator</p> <blockquote> <p>本实验完成的任务是为每个CPU都维护一个空闲列表，初始时将所有的空闲内存分配到某个CPU，此后各个CPU需要内存时，如果当前CPU的空闲列表上没有，则窃取其他CPU的。例如，所有的空闲内存初始分配到CPU0，当CPU1需要内存时就会窃取CPU0的，而使用完成后就挂在CPU1的空闲列表，此后CPU1再次需要内存时就可以从自己的空闲列表中取。</p> </blockquote> <p>(1) 将<code>kmem</code>定义为一个数组，包含<code>NCPU</code>个元素，即每个CPU对应一个:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-73-1>1</a></span>
<span class=normal><a href=#__codelineno-73-2>2</a></span>
<span class=normal><a href=#__codelineno-73-3>3</a></span>
<span class=normal><a href=#__codelineno-73-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1></a><span class=k>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>spinlock</span><span class=w> </span><span class=n>lock</span><span class=p>;</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4></a><span class=p>}</span><span class=w> </span><span class=n>kmem</span><span class=p>[</span><span class=n>NCPU</span><span class=p>];</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 修改<code>kinit</code>，为所有锁初始化以“kmem”开头的名称，该函数只会被一个CPU调用，<code>freerange</code>调用<code>kfree</code>将所有空闲内存挂在该CPU的空闲列表上:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-74-1> 1</a></span>
<span class=normal><a href=#__codelineno-74-2> 2</a></span>
<span class=normal><a href=#__codelineno-74-3> 3</a></span>
<span class=normal><a href=#__codelineno-74-4> 4</a></span>
<span class=normal><a href=#__codelineno-74-5> 5</a></span>
<span class=normal><a href=#__codelineno-74-6> 6</a></span>
<span class=normal><a href=#__codelineno-74-7> 7</a></span>
<span class=normal><a href=#__codelineno-74-8> 8</a></span>
<span class=normal><a href=#__codelineno-74-9> 9</a></span>
<span class=normal><a href=#__codelineno-74-10>10</a></span>
<span class=normal><a href=#__codelineno-74-11>11</a></span>
<span class=normal><a href=#__codelineno-74-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1></a><span class=kt>void</span><span class=w> </span><span class=nf>kinit</span><span class=p>()</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2></a><span class=p>{</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>lockname</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4></a><span class=w>    </span><span class=c1>// ============== solution for MEM Alloc ================</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NCPU</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7></a><span class=w>        </span><span class=n>snprintf</span><span class=p>(</span><span class=n>lockname</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>lockname</span><span class=p>),</span><span class=w> </span><span class=s>"kmem_%d"</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8></a><span class=w>        </span><span class=n>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=n>lockname</span><span class=p>);</span>
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10></a><span class=w>    </span><span class=c1>// ======================================================</span>
</span><span id=__span-74-11><a id=__codelineno-74-11 name=__codelineno-74-11></a><span class=w>    </span><span class=n>freerange</span><span class=p>(</span><span class=n>end</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>PHYSTOP</span><span class=p>);</span>
</span><span id=__span-74-12><a id=__codelineno-74-12 name=__codelineno-74-12></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 修改<code>kfree</code>，使用<code>cpuid()</code>和它返回的结果时必须关中断，请参考《XV6使用手册》第7.4节:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-75-1> 1</a></span>
<span class=normal><a href=#__codelineno-75-2> 2</a></span>
<span class=normal><a href=#__codelineno-75-3> 3</a></span>
<span class=normal><a href=#__codelineno-75-4> 4</a></span>
<span class=normal><a href=#__codelineno-75-5> 5</a></span>
<span class=normal><a href=#__codelineno-75-6> 6</a></span>
<span class=normal><a href=#__codelineno-75-7> 7</a></span>
<span class=normal><a href=#__codelineno-75-8> 8</a></span>
<span class=normal><a href=#__codelineno-75-9> 9</a></span>
<span class=normal><a href=#__codelineno-75-10>10</a></span>
<span class=normal><a href=#__codelineno-75-11>11</a></span>
<span class=normal><a href=#__codelineno-75-12>12</a></span>
<span class=normal><a href=#__codelineno-75-13>13</a></span>
<span class=normal><a href=#__codelineno-75-14>14</a></span>
<span class=normal><a href=#__codelineno-75-15>15</a></span>
<span class=normal><a href=#__codelineno-75-16>16</a></span>
<span class=normal><a href=#__codelineno-75-17>17</a></span>
<span class=normal><a href=#__codelineno-75-18>18</a></span>
<span class=normal><a href=#__codelineno-75-19>19</a></span>
<span class=normal><a href=#__codelineno-75-20>20</a></span>
<span class=normal><a href=#__codelineno-75-21>21</a></span>
<span class=normal><a href=#__codelineno-75-22>22</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1></a><span class=kt>void</span><span class=w> </span><span class=nf>kfree</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>pa</span><span class=p>)</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2></a><span class=p>{</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4></a>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5></a><span class=w>    </span><span class=k>if</span><span class=p>(((</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>end</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>PHYSTOP</span><span class=p>)</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"kfree"</span><span class=p>);</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7></a>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8></a><span class=w>    </span><span class=c1>// Fill with junk to catch dangling refs.</span>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9></a><span class=w>    </span><span class=n>memset</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10></a>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11></a><span class=w>    </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>;</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12></a>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13></a><span class=w>    </span><span class=c1>// ============== solution for MEM Alloc ================</span>
</span><span id=__span-75-14><a id=__codelineno-75-14 name=__codelineno-75-14></a><span class=w>    </span><span class=n>push_off</span><span class=p>();</span><span class=w>  </span><span class=c1>// 关中断</span>
</span><span id=__span-75-15><a id=__codelineno-75-15 name=__codelineno-75-15></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cpuid</span><span class=p>();</span>
</span><span id=__span-75-16><a id=__codelineno-75-16 name=__codelineno-75-16></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-75-17><a id=__codelineno-75-17 name=__codelineno-75-17></a><span class=w>    </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-75-18><a id=__codelineno-75-18 name=__codelineno-75-18></a><span class=w>    </span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>freelist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-75-19><a id=__codelineno-75-19 name=__codelineno-75-19></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-75-20><a id=__codelineno-75-20 name=__codelineno-75-20></a><span class=w>    </span><span class=n>pop_off</span><span class=p>();</span><span class=w>  </span><span class=c1>//开中断</span>
</span><span id=__span-75-21><a id=__codelineno-75-21 name=__codelineno-75-21></a><span class=w>    </span><span class=c1>// ======================================================</span>
</span><span id=__span-75-22><a id=__codelineno-75-22 name=__codelineno-75-22></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改<code>kalloc</code>，使得在当前CPU的空闲列表没有可分配内存时窃取其他内存的:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-76-1> 1</a></span>
<span class=normal><a href=#__codelineno-76-2> 2</a></span>
<span class=normal><a href=#__codelineno-76-3> 3</a></span>
<span class=normal><a href=#__codelineno-76-4> 4</a></span>
<span class=normal><a href=#__codelineno-76-5> 5</a></span>
<span class=normal><a href=#__codelineno-76-6> 6</a></span>
<span class=normal><a href=#__codelineno-76-7> 7</a></span>
<span class=normal><a href=#__codelineno-76-8> 8</a></span>
<span class=normal><a href=#__codelineno-76-9> 9</a></span>
<span class=normal><a href=#__codelineno-76-10>10</a></span>
<span class=normal><a href=#__codelineno-76-11>11</a></span>
<span class=normal><a href=#__codelineno-76-12>12</a></span>
<span class=normal><a href=#__codelineno-76-13>13</a></span>
<span class=normal><a href=#__codelineno-76-14>14</a></span>
<span class=normal><a href=#__codelineno-76-15>15</a></span>
<span class=normal><a href=#__codelineno-76-16>16</a></span>
<span class=normal><a href=#__codelineno-76-17>17</a></span>
<span class=normal><a href=#__codelineno-76-18>18</a></span>
<span class=normal><a href=#__codelineno-76-19>19</a></span>
<span class=normal><a href=#__codelineno-76-20>20</a></span>
<span class=normal><a href=#__codelineno-76-21>21</a></span>
<span class=normal><a href=#__codelineno-76-22>22</a></span>
<span class=normal><a href=#__codelineno-76-23>23</a></span>
<span class=normal><a href=#__codelineno-76-24>24</a></span>
<span class=normal><a href=#__codelineno-76-25>25</a></span>
<span class=normal><a href=#__codelineno-76-26>26</a></span>
<span class=normal><a href=#__codelineno-76-27>27</a></span>
<span class=normal><a href=#__codelineno-76-28>28</a></span>
<span class=normal><a href=#__codelineno-76-29>29</a></span>
<span class=normal><a href=#__codelineno-76-30>30</a></span>
<span class=normal><a href=#__codelineno-76-31>31</a></span>
<span class=normal><a href=#__codelineno-76-32>32</a></span>
<span class=normal><a href=#__codelineno-76-33>33</a></span>
<span class=normal><a href=#__codelineno-76-34>34</a></span>
<span class=normal><a href=#__codelineno-76-35>35</a></span>
<span class=normal><a href=#__codelineno-76-36>36</a></span>
<span class=normal><a href=#__codelineno-76-37>37</a></span>
<span class=normal><a href=#__codelineno-76-38>38</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nf>kalloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2></a><span class=p>{</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>run</span><span class=w> </span><span class=o>*</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4></a>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5></a><span class=w>    </span><span class=c1>// ============== solution for MEM Alloc ================</span>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6></a><span class=w>    </span><span class=n>push_off</span><span class=p>();</span><span class=c1>// 关中断</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cpuid</span><span class=p>();</span>
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-76-9><a id=__codelineno-76-9 name=__codelineno-76-9></a><span class=w>    </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-76-10><a id=__codelineno-76-10 name=__codelineno-76-10></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span><span id=__span-76-11><a id=__codelineno-76-11 name=__codelineno-76-11></a><span class=w>        </span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>freelist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-76-12><a id=__codelineno-76-12 name=__codelineno-76-12></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-76-13><a id=__codelineno-76-13 name=__codelineno-76-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-76-14><a id=__codelineno-76-14 name=__codelineno-76-14></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>antid</span><span class=p>;</span><span class=w>  </span><span class=c1>// another id</span>
</span><span id=__span-76-15><a id=__codelineno-76-15 name=__codelineno-76-15></a><span class=w>        </span><span class=c1>// 遍历所有CPU的空闲列表</span>
</span><span id=__span-76-16><a id=__codelineno-76-16 name=__codelineno-76-16></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>antid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>antid</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NCPU</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>antid</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-76-17><a id=__codelineno-76-17 name=__codelineno-76-17></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-76-18><a id=__codelineno-76-18 name=__codelineno-76-18></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>antid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
</span><span id=__span-76-19><a id=__codelineno-76-19 name=__codelineno-76-19></a><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-76-20><a id=__codelineno-76-20 name=__codelineno-76-20></a><span class=w>            </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>antid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-76-21><a id=__codelineno-76-21 name=__codelineno-76-21></a><span class=w>            </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem</span><span class=p>[</span><span class=n>antid</span><span class=p>].</span><span class=n>freelist</span><span class=p>;</span>
</span><span id=__span-76-22><a id=__codelineno-76-22 name=__codelineno-76-22></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-76-23><a id=__codelineno-76-23 name=__codelineno-76-23></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-76-24><a id=__codelineno-76-24 name=__codelineno-76-24></a><span class=w>                </span><span class=n>kmem</span><span class=p>[</span><span class=n>antid</span><span class=p>].</span><span class=n>freelist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-76-25><a id=__codelineno-76-25 name=__codelineno-76-25></a><span class=w>                </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>antid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-76-26><a id=__codelineno-76-26 name=__codelineno-76-26></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-76-27><a id=__codelineno-76-27 name=__codelineno-76-27></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-76-28><a id=__codelineno-76-28 name=__codelineno-76-28></a><span class=w>            </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>antid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-76-29><a id=__codelineno-76-29 name=__codelineno-76-29></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-76-30><a id=__codelineno-76-30 name=__codelineno-76-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-76-31><a id=__codelineno-76-31 name=__codelineno-76-31></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kmem</span><span class=p>[</span><span class=n>id</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-76-32><a id=__codelineno-76-32 name=__codelineno-76-32></a><span class=w>    </span><span class=n>pop_off</span><span class=p>();</span><span class=w>  </span><span class=c1>//开中断</span>
</span><span id=__span-76-33><a id=__codelineno-76-33 name=__codelineno-76-33></a><span class=w>    </span><span class=c1>// ======================================================</span>
</span><span id=__span-76-34><a id=__codelineno-76-34 name=__codelineno-76-34></a>
</span><span id=__span-76-35><a id=__codelineno-76-35 name=__codelineno-76-35></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>)</span>
</span><span id=__span-76-36><a id=__codelineno-76-36 name=__codelineno-76-36></a><span class=w>        </span><span class=n>memset</span><span class=p>((</span><span class=kt>char</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span><span class=w> </span><span class=c1>// fill with junk</span>
</span><span id=__span-76-37><a id=__codelineno-76-37 name=__codelineno-76-37></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>r</span><span class=p>;</span>
</span><span id=__span-76-38><a id=__codelineno-76-38 name=__codelineno-76-38></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Buffer cache</p> <blockquote> <p>这个实验的目的是将缓冲区的分配与回收并行化以提高效率。</p> </blockquote> <p>(1) 定义哈希桶结构，并在<code>bcache</code>中删除全局缓冲区链表，改为使用素数个散列桶:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-77-1> 1</a></span>
<span class=normal><a href=#__codelineno-77-2> 2</a></span>
<span class=normal><a href=#__codelineno-77-3> 3</a></span>
<span class=normal><a href=#__codelineno-77-4> 4</a></span>
<span class=normal><a href=#__codelineno-77-5> 5</a></span>
<span class=normal><a href=#__codelineno-77-6> 6</a></span>
<span class=normal><a href=#__codelineno-77-7> 7</a></span>
<span class=normal><a href=#__codelineno-77-8> 8</a></span>
<span class=normal><a href=#__codelineno-77-9> 9</a></span>
<span class=normal><a href=#__codelineno-77-10>10</a></span>
<span class=normal><a href=#__codelineno-77-11>11</a></span>
<span class=normal><a href=#__codelineno-77-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1></a><span class=cp>#define NBUCKET 13</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2></a><span class=cp>#define HASH(id) (id % NBUCKET)</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3></a>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4></a><span class=k>struct</span><span class=w> </span><span class=nc>hashbuf</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=w> </span><span class=n>head</span><span class=p>;</span><span class=w>       </span><span class=c1>// 头节点</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>spinlock</span><span class=w> </span><span class=n>lock</span><span class=p>;</span><span class=w>  </span><span class=c1>// 锁</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7></a><span class=p>};</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8></a>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9></a><span class=k>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>NBUF</span><span class=p>];</span>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>hashbuf</span><span class=w> </span><span class=n>buckets</span><span class=p>[</span><span class=n>NBUCKET</span><span class=p>];</span><span class=w>  </span><span class=c1>// 散列桶</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12></a><span class=p>}</span><span class=w> </span><span class=n>bcache</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-78-1> 1</a></span>
<span class=normal><a href=#__codelineno-78-2> 2</a></span>
<span class=normal><a href=#__codelineno-78-3> 3</a></span>
<span class=normal><a href=#__codelineno-78-4> 4</a></span>
<span class=normal><a href=#__codelineno-78-5> 5</a></span>
<span class=normal><a href=#__codelineno-78-6> 6</a></span>
<span class=normal><a href=#__codelineno-78-7> 7</a></span>
<span class=normal><a href=#__codelineno-78-8> 8</a></span>
<span class=normal><a href=#__codelineno-78-9> 9</a></span>
<span class=normal><a href=#__codelineno-78-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1></a>bcache
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2></a>├─ buckets[NBUCKET]
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3></a>│  ├─ lock        // 桶锁
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4></a>│  └─ head        // 链表头
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5></a>│     ├─ prev
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6></a>│     └─ next
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7></a>└─ buf[NBUF]      // 缓冲区数组
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8></a>   ├─ dev         // 设备号
</span><span id=__span-78-9><a id=__codelineno-78-9 name=__codelineno-78-9></a>   ├─ blockno     // 块号
</span><span id=__span-78-10><a id=__codelineno-78-10 name=__codelineno-78-10></a>   └─ ...         // 其他元数据
</span></code></pre></div></td></tr></table></div> <p>(2) 在<code>binit</code>中:</p> <ul> <li> <p>初始化散列桶的锁</p> </li> <li> <p>将所有散列桶的<code>head-&gt;prev</code>、<code>head-&gt;next</code>都指向自身表示为空</p> </li> <li> <p>将所有的缓冲区挂载到<code>bucket[0]</code>桶上</p> </li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-79-1> 1</a></span>
<span class=normal><a href=#__codelineno-79-2> 2</a></span>
<span class=normal><a href=#__codelineno-79-3> 3</a></span>
<span class=normal><a href=#__codelineno-79-4> 4</a></span>
<span class=normal><a href=#__codelineno-79-5> 5</a></span>
<span class=normal><a href=#__codelineno-79-6> 6</a></span>
<span class=normal><a href=#__codelineno-79-7> 7</a></span>
<span class=normal><a href=#__codelineno-79-8> 8</a></span>
<span class=normal><a href=#__codelineno-79-9> 9</a></span>
<span class=normal><a href=#__codelineno-79-10>10</a></span>
<span class=normal><a href=#__codelineno-79-11>11</a></span>
<span class=normal><a href=#__codelineno-79-12>12</a></span>
<span class=normal><a href=#__codelineno-79-13>13</a></span>
<span class=normal><a href=#__codelineno-79-14>14</a></span>
<span class=normal><a href=#__codelineno-79-15>15</a></span>
<span class=normal><a href=#__codelineno-79-16>16</a></span>
<span class=normal><a href=#__codelineno-79-17>17</a></span>
<span class=normal><a href=#__codelineno-79-18>18</a></span>
<span class=normal><a href=#__codelineno-79-19>19</a></span>
<span class=normal><a href=#__codelineno-79-20>20</a></span>
<span class=normal><a href=#__codelineno-79-21>21</a></span>
<span class=normal><a href=#__codelineno-79-22>22</a></span>
<span class=normal><a href=#__codelineno-79-23>23</a></span>
<span class=normal><a href=#__codelineno-79-24>24</a></span>
<span class=normal><a href=#__codelineno-79-25>25</a></span>
<span class=normal><a href=#__codelineno-79-26>26</a></span>
<span class=normal><a href=#__codelineno-79-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1></a><span class=kt>void</span><span class=w> </span><span class=nf>binit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2></a><span class=p>{</span>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>lockname</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5></a>
</span><span id=__span-79-6><a id=__codelineno-79-6 name=__codelineno-79-6></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NBUCKET</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-79-7><a id=__codelineno-79-7 name=__codelineno-79-7></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-79-8><a id=__codelineno-79-8 name=__codelineno-79-8></a><span class=w>        </span><span class=c1>// 初始化散列桶的自旋锁</span>
</span><span id=__span-79-9><a id=__codelineno-79-9 name=__codelineno-79-9></a><span class=w>        </span><span class=n>snprintf</span><span class=p>(</span><span class=n>lockname</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>lockname</span><span class=p>),</span><span class=w> </span><span class=s>"bcache_%d"</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-79-10><a id=__codelineno-79-10 name=__codelineno-79-10></a><span class=w>        </span><span class=n>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=n>lockname</span><span class=p>);</span>
</span><span id=__span-79-11><a id=__codelineno-79-11 name=__codelineno-79-11></a>
</span><span id=__span-79-12><a id=__codelineno-79-12 name=__codelineno-79-12></a><span class=w>        </span><span class=c1>// 初始化散列桶的头节点</span>
</span><span id=__span-79-13><a id=__codelineno-79-13 name=__codelineno-79-13></a><span class=w>        </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>;</span>
</span><span id=__span-79-14><a id=__codelineno-79-14 name=__codelineno-79-14></a><span class=w>        </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>;</span>
</span><span id=__span-79-15><a id=__codelineno-79-15 name=__codelineno-79-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-79-16><a id=__codelineno-79-16 name=__codelineno-79-16></a>
</span><span id=__span-79-17><a id=__codelineno-79-17 name=__codelineno-79-17></a><span class=w>    </span><span class=c1>// Create linked list of buffers</span>
</span><span id=__span-79-18><a id=__codelineno-79-18 name=__codelineno-79-18></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buf</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>NBUF</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-79-19><a id=__codelineno-79-19 name=__codelineno-79-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-79-20><a id=__codelineno-79-20 name=__codelineno-79-20></a><span class=w>        </span><span class=c1>// 利用头插法初始化缓冲区列表,全部放到散列桶0上</span>
</span><span id=__span-79-21><a id=__codelineno-79-21 name=__codelineno-79-21></a><span class=w>        </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-79-22><a id=__codelineno-79-22 name=__codelineno-79-22></a><span class=w>        </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>head</span><span class=p>;</span>
</span><span id=__span-79-23><a id=__codelineno-79-23 name=__codelineno-79-23></a><span class=w>        </span><span class=n>initsleeplock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>,</span><span class=w> </span><span class=s>"buffer"</span><span class=p>);</span>
</span><span id=__span-79-24><a id=__codelineno-79-24 name=__codelineno-79-24></a><span class=w>        </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=o>-&gt;</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-79-25><a id=__codelineno-79-25 name=__codelineno-79-25></a><span class=w>        </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-79-26><a id=__codelineno-79-26 name=__codelineno-79-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-79-27><a id=__codelineno-79-27 name=__codelineno-79-27></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 在<code>buf.h</code>中增加新字段<code>timestamp</code>，这里来理解一下这个字段的用途：在原始方案中，每次<code>brelse</code>都将被释放的缓冲区挂载到链表头，表明这个缓冲区最近刚刚被使用过，在<code>bget</code>中分配时从链表尾向前查找，这样符合条件的第一个就是最久未使用的。而在提示中建议使用时间戳作为LRU判定的法则，这样我们就无需在<code>brelse</code>中进行头插法更改结点位置:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-80-1>1</a></span>
<span class=normal><a href=#__codelineno-80-2>2</a></span>
<span class=normal><a href=#__codelineno-80-3>3</a></span>
<span class=normal><a href=#__codelineno-80-4>4</a></span>
<span class=normal><a href=#__codelineno-80-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1></a><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>timestamp</span><span class=p>;</span><span class=w>  </span><span class=c1>// 时间戳</span>
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 更改<code>brelse</code>，不再获取全局锁:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-81-1> 1</a></span>
<span class=normal><a href=#__codelineno-81-2> 2</a></span>
<span class=normal><a href=#__codelineno-81-3> 3</a></span>
<span class=normal><a href=#__codelineno-81-4> 4</a></span>
<span class=normal><a href=#__codelineno-81-5> 5</a></span>
<span class=normal><a href=#__codelineno-81-6> 6</a></span>
<span class=normal><a href=#__codelineno-81-7> 7</a></span>
<span class=normal><a href=#__codelineno-81-8> 8</a></span>
<span class=normal><a href=#__codelineno-81-9> 9</a></span>
<span class=normal><a href=#__codelineno-81-10>10</a></span>
<span class=normal><a href=#__codelineno-81-11>11</a></span>
<span class=normal><a href=#__codelineno-81-12>12</a></span>
<span class=normal><a href=#__codelineno-81-13>13</a></span>
<span class=normal><a href=#__codelineno-81-14>14</a></span>
<span class=normal><a href=#__codelineno-81-15>15</a></span>
<span class=normal><a href=#__codelineno-81-16>16</a></span>
<span class=normal><a href=#__codelineno-81-17>17</a></span>
<span class=normal><a href=#__codelineno-81-18>18</a></span>
<span class=normal><a href=#__codelineno-81-19>19</a></span>
<span class=normal><a href=#__codelineno-81-20>20</a></span>
<span class=normal><a href=#__codelineno-81-21>21</a></span>
<span class=normal><a href=#__codelineno-81-22>22</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1></a><span class=c1>// Release a locked buffer.</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2></a><span class=c1>// Move to the head of the most-recently-used list.</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3></a><span class=kt>void</span><span class=w> </span><span class=nf>brelse</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4></a><span class=p>{</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>holdingsleep</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>))</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6></a><span class=w>        </span><span class=n>panic</span><span class=p>(</span><span class=s>"brelse"</span><span class=p>);</span>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7></a>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>bid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HASH</span><span class=p>(</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>blockno</span><span class=p>);</span>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9></a>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10></a><span class=w>    </span><span class=n>releasesleep</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11></a>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13></a><span class=w>    </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14></a>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15></a><span class=w>    </span><span class=c1>// 更新时间戳</span>
</span><span id=__span-81-16><a id=__codelineno-81-16 name=__codelineno-81-16></a><span class=w>    </span><span class=c1>// 由于LRU改为使用时间戳判定，不再需要头插法</span>
</span><span id=__span-81-17><a id=__codelineno-81-17 name=__codelineno-81-17></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-81-18><a id=__codelineno-81-18 name=__codelineno-81-18></a><span class=w>    </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ticks</span><span class=p>;</span>
</span><span id=__span-81-19><a id=__codelineno-81-19 name=__codelineno-81-19></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-81-20><a id=__codelineno-81-20 name=__codelineno-81-20></a>
</span><span id=__span-81-21><a id=__codelineno-81-21 name=__codelineno-81-21></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-81-22><a id=__codelineno-81-22 name=__codelineno-81-22></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 更改<code>bget</code>，当没有找到指定的缓冲区时进行分配，分配方式是优先从当前列表遍历，找到一个没有引用且<code>timestamp</code>最小的缓冲区，如果没有就申请下一个桶的锁，并遍历该桶，找到后将该缓冲区从原来的桶移动到当前桶中，最多将所有桶都遍历完，在代码中要注意锁的释放:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-82-1> 1</a></span>
<span class=normal><a href=#__codelineno-82-2> 2</a></span>
<span class=normal><a href=#__codelineno-82-3> 3</a></span>
<span class=normal><a href=#__codelineno-82-4> 4</a></span>
<span class=normal><a href=#__codelineno-82-5> 5</a></span>
<span class=normal><a href=#__codelineno-82-6> 6</a></span>
<span class=normal><a href=#__codelineno-82-7> 7</a></span>
<span class=normal><a href=#__codelineno-82-8> 8</a></span>
<span class=normal><a href=#__codelineno-82-9> 9</a></span>
<span class=normal><a href=#__codelineno-82-10>10</a></span>
<span class=normal><a href=#__codelineno-82-11>11</a></span>
<span class=normal><a href=#__codelineno-82-12>12</a></span>
<span class=normal><a href=#__codelineno-82-13>13</a></span>
<span class=normal><a href=#__codelineno-82-14>14</a></span>
<span class=normal><a href=#__codelineno-82-15>15</a></span>
<span class=normal><a href=#__codelineno-82-16>16</a></span>
<span class=normal><a href=#__codelineno-82-17>17</a></span>
<span class=normal><a href=#__codelineno-82-18>18</a></span>
<span class=normal><a href=#__codelineno-82-19>19</a></span>
<span class=normal><a href=#__codelineno-82-20>20</a></span>
<span class=normal><a href=#__codelineno-82-21>21</a></span>
<span class=normal><a href=#__codelineno-82-22>22</a></span>
<span class=normal><a href=#__codelineno-82-23>23</a></span>
<span class=normal><a href=#__codelineno-82-24>24</a></span>
<span class=normal><a href=#__codelineno-82-25>25</a></span>
<span class=normal><a href=#__codelineno-82-26>26</a></span>
<span class=normal><a href=#__codelineno-82-27>27</a></span>
<span class=normal><a href=#__codelineno-82-28>28</a></span>
<span class=normal><a href=#__codelineno-82-29>29</a></span>
<span class=normal><a href=#__codelineno-82-30>30</a></span>
<span class=normal><a href=#__codelineno-82-31>31</a></span>
<span class=normal><a href=#__codelineno-82-32>32</a></span>
<span class=normal><a href=#__codelineno-82-33>33</a></span>
<span class=normal><a href=#__codelineno-82-34>34</a></span>
<span class=normal><a href=#__codelineno-82-35>35</a></span>
<span class=normal><a href=#__codelineno-82-36>36</a></span>
<span class=normal><a href=#__codelineno-82-37>37</a></span>
<span class=normal><a href=#__codelineno-82-38>38</a></span>
<span class=normal><a href=#__codelineno-82-39>39</a></span>
<span class=normal><a href=#__codelineno-82-40>40</a></span>
<span class=normal><a href=#__codelineno-82-41>41</a></span>
<span class=normal><a href=#__codelineno-82-42>42</a></span>
<span class=normal><a href=#__codelineno-82-43>43</a></span>
<span class=normal><a href=#__codelineno-82-44>44</a></span>
<span class=normal><a href=#__codelineno-82-45>45</a></span>
<span class=normal><a href=#__codelineno-82-46>46</a></span>
<span class=normal><a href=#__codelineno-82-47>47</a></span>
<span class=normal><a href=#__codelineno-82-48>48</a></span>
<span class=normal><a href=#__codelineno-82-49>49</a></span>
<span class=normal><a href=#__codelineno-82-50>50</a></span>
<span class=normal><a href=#__codelineno-82-51>51</a></span>
<span class=normal><a href=#__codelineno-82-52>52</a></span>
<span class=normal><a href=#__codelineno-82-53>53</a></span>
<span class=normal><a href=#__codelineno-82-54>54</a></span>
<span class=normal><a href=#__codelineno-82-55>55</a></span>
<span class=normal><a href=#__codelineno-82-56>56</a></span>
<span class=normal><a href=#__codelineno-82-57>57</a></span>
<span class=normal><a href=#__codelineno-82-58>58</a></span>
<span class=normal><a href=#__codelineno-82-59>59</a></span>
<span class=normal><a href=#__codelineno-82-60>60</a></span>
<span class=normal><a href=#__codelineno-82-61>61</a></span>
<span class=normal><a href=#__codelineno-82-62>62</a></span>
<span class=normal><a href=#__codelineno-82-63>63</a></span>
<span class=normal><a href=#__codelineno-82-64>64</a></span>
<span class=normal><a href=#__codelineno-82-65>65</a></span>
<span class=normal><a href=#__codelineno-82-66>66</a></span>
<span class=normal><a href=#__codelineno-82-67>67</a></span>
<span class=normal><a href=#__codelineno-82-68>68</a></span>
<span class=normal><a href=#__codelineno-82-69>69</a></span>
<span class=normal><a href=#__codelineno-82-70>70</a></span>
<span class=normal><a href=#__codelineno-82-71>71</a></span>
<span class=normal><a href=#__codelineno-82-72>72</a></span>
<span class=normal><a href=#__codelineno-82-73>73</a></span>
<span class=normal><a href=#__codelineno-82-74>74</a></span>
<span class=normal><a href=#__codelineno-82-75>75</a></span>
<span class=normal><a href=#__codelineno-82-76>76</a></span>
<span class=normal><a href=#__codelineno-82-77>77</a></span>
<span class=normal><a href=#__codelineno-82-78>78</a></span>
<span class=normal><a href=#__codelineno-82-79>79</a></span>
<span class=normal><a href=#__codelineno-82-80>80</a></span>
<span class=normal><a href=#__codelineno-82-81>81</a></span>
<span class=normal><a href=#__codelineno-82-82>82</a></span>
<span class=normal><a href=#__codelineno-82-83>83</a></span>
<span class=normal><a href=#__codelineno-82-84>84</a></span>
<span class=normal><a href=#__codelineno-82-85>85</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>bget</span><span class=p>(</span><span class=n>uint</span><span class=w> </span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>uint</span><span class=w> </span><span class=n>blockno</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2></a><span class=p>{</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4></a>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>bid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HASH</span><span class=p>(</span><span class=n>blockno</span><span class=p>);</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7></a>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8></a><span class=w>    </span><span class=c1>// Is the block already cached?</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>dev</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>dev</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>blockno</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>blockno</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14></a>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15></a><span class=w>            </span><span class=c1>// 记录使用时间戳</span>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16></a><span class=w>            </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-82-17><a id=__codelineno-82-17 name=__codelineno-82-17></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ticks</span><span class=p>;</span>
</span><span id=__span-82-18><a id=__codelineno-82-18 name=__codelineno-82-18></a><span class=w>            </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-82-19><a id=__codelineno-82-19 name=__codelineno-82-19></a>
</span><span id=__span-82-20><a id=__codelineno-82-20 name=__codelineno-82-20></a><span class=w>            </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-21><a id=__codelineno-82-21 name=__codelineno-82-21></a><span class=w>            </span><span class=n>acquiresleep</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-22><a id=__codelineno-82-22 name=__codelineno-82-22></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-82-23><a id=__codelineno-82-23 name=__codelineno-82-23></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-82-24><a id=__codelineno-82-24 name=__codelineno-82-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-25><a id=__codelineno-82-25 name=__codelineno-82-25></a>
</span><span id=__span-82-26><a id=__codelineno-82-26 name=__codelineno-82-26></a><span class=w>    </span><span class=c1>// Not cached.</span>
</span><span id=__span-82-27><a id=__codelineno-82-27 name=__codelineno-82-27></a><span class=w>    </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-82-28><a id=__codelineno-82-28 name=__codelineno-82-28></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
</span><span id=__span-82-29><a id=__codelineno-82-29 name=__codelineno-82-29></a>
</span><span id=__span-82-30><a id=__codelineno-82-30 name=__codelineno-82-30></a><span class=w>    </span><span class=c1>// Recycle the least recently used (LRU) unused buffer.</span>
</span><span id=__span-82-31><a id=__codelineno-82-31 name=__codelineno-82-31></a><span class=w>    </span><span class=c1>// 从当前散列桶开始查找</span>
</span><span id=__span-82-32><a id=__codelineno-82-32 name=__codelineno-82-32></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bid</span><span class=p>,</span><span class=w> </span><span class=n>cycle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>cycle</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NBUCKET</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>NBUCKET</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-33><a id=__codelineno-82-33 name=__codelineno-82-33></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-82-34><a id=__codelineno-82-34 name=__codelineno-82-34></a><span class=w>        </span><span class=o>++</span><span class=n>cycle</span><span class=p>;</span>
</span><span id=__span-82-35><a id=__codelineno-82-35 name=__codelineno-82-35></a><span class=w>        </span><span class=c1>// 如果遍历到当前散列桶，则不重新获取锁</span>
</span><span id=__span-82-36><a id=__codelineno-82-36 name=__codelineno-82-36></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>bid</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-37><a id=__codelineno-82-37 name=__codelineno-82-37></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-82-38><a id=__codelineno-82-38 name=__codelineno-82-38></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>holding</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>))</span>
</span><span id=__span-82-39><a id=__codelineno-82-39 name=__codelineno-82-39></a><span class=w>                </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-40><a id=__codelineno-82-40 name=__codelineno-82-40></a><span class=w>            </span><span class=k>else</span>
</span><span id=__span-82-41><a id=__codelineno-82-41 name=__codelineno-82-41></a><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-82-42><a id=__codelineno-82-42 name=__codelineno-82-42></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-82-43><a id=__codelineno-82-43 name=__codelineno-82-43></a>
</span><span id=__span-82-44><a id=__codelineno-82-44 name=__codelineno-82-44></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=p>;</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>head</span><span class=p>;</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span>
</span><span id=__span-82-45><a id=__codelineno-82-45 name=__codelineno-82-45></a><span class=w>            </span><span class=c1>// 使用时间戳进行LRU算法，而不是根据结点在链表中的位置</span>
</span><span id=__span-82-46><a id=__codelineno-82-46 name=__codelineno-82-46></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>tmp</span><span class=o>-&gt;</span><span class=n>timestamp</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>timestamp</span><span class=p>))</span>
</span><span id=__span-82-47><a id=__codelineno-82-47 name=__codelineno-82-47></a><span class=w>                </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
</span><span id=__span-82-48><a id=__codelineno-82-48 name=__codelineno-82-48></a>
</span><span id=__span-82-49><a id=__codelineno-82-49 name=__codelineno-82-49></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-82-50><a id=__codelineno-82-50 name=__codelineno-82-50></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-82-51><a id=__codelineno-82-51 name=__codelineno-82-51></a><span class=w>            </span><span class=c1>// 如果是从其他散列桶窃取的，则将其以头插法插入到当前桶</span>
</span><span id=__span-82-52><a id=__codelineno-82-52 name=__codelineno-82-52></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>bid</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-53><a id=__codelineno-82-53 name=__codelineno-82-53></a><span class=w>                </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>next</span><span class=o>-&gt;</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>prev</span><span class=p>;</span>
</span><span id=__span-82-54><a id=__codelineno-82-54 name=__codelineno-82-54></a><span class=w>                </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>prev</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-82-55><a id=__codelineno-82-55 name=__codelineno-82-55></a><span class=w>                </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-56><a id=__codelineno-82-56 name=__codelineno-82-56></a>
</span><span id=__span-82-57><a id=__codelineno-82-57 name=__codelineno-82-57></a><span class=w>                </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-82-58><a id=__codelineno-82-58 name=__codelineno-82-58></a><span class=w>                </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>;</span>
</span><span id=__span-82-59><a id=__codelineno-82-59 name=__codelineno-82-59></a><span class=w>                </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=o>-&gt;</span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-82-60><a id=__codelineno-82-60 name=__codelineno-82-60></a><span class=w>                </span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>head</span><span class=p>.</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-82-61><a id=__codelineno-82-61 name=__codelineno-82-61></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-82-62><a id=__codelineno-82-62 name=__codelineno-82-62></a>
</span><span id=__span-82-63><a id=__codelineno-82-63 name=__codelineno-82-63></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dev</span><span class=p>;</span>
</span><span id=__span-82-64><a id=__codelineno-82-64 name=__codelineno-82-64></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>blockno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blockno</span><span class=p>;</span>
</span><span id=__span-82-65><a id=__codelineno-82-65 name=__codelineno-82-65></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-82-66><a id=__codelineno-82-66 name=__codelineno-82-66></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-82-67><a id=__codelineno-82-67 name=__codelineno-82-67></a>
</span><span id=__span-82-68><a id=__codelineno-82-68 name=__codelineno-82-68></a><span class=w>            </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-82-69><a id=__codelineno-82-69 name=__codelineno-82-69></a><span class=w>            </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>timestamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ticks</span><span class=p>;</span>
</span><span id=__span-82-70><a id=__codelineno-82-70 name=__codelineno-82-70></a><span class=w>            </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tickslock</span><span class=p>);</span>
</span><span id=__span-82-71><a id=__codelineno-82-71 name=__codelineno-82-71></a>
</span><span id=__span-82-72><a id=__codelineno-82-72 name=__codelineno-82-72></a><span class=w>            </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-73><a id=__codelineno-82-73 name=__codelineno-82-73></a><span class=w>            </span><span class=n>acquiresleep</span><span class=p>(</span><span class=o>&amp;</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-74><a id=__codelineno-82-74 name=__codelineno-82-74></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-82-75><a id=__codelineno-82-75 name=__codelineno-82-75></a><span class=w>        </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-82-76><a id=__codelineno-82-76 name=__codelineno-82-76></a><span class=w>        </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-82-77><a id=__codelineno-82-77 name=__codelineno-82-77></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-82-78><a id=__codelineno-82-78 name=__codelineno-82-78></a><span class=w>            </span><span class=c1>// 在当前散列桶中未找到，则直接释放锁</span>
</span><span id=__span-82-79><a id=__codelineno-82-79 name=__codelineno-82-79></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>bid</span><span class=p>)</span>
</span><span id=__span-82-80><a id=__codelineno-82-80 name=__codelineno-82-80></a><span class=w>                </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-82-81><a id=__codelineno-82-81 name=__codelineno-82-81></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-82-82><a id=__codelineno-82-82 name=__codelineno-82-82></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-83><a id=__codelineno-82-83 name=__codelineno-82-83></a>
</span><span id=__span-82-84><a id=__codelineno-82-84 name=__codelineno-82-84></a><span class=w>    </span><span class=n>panic</span><span class=p>(</span><span class=s>"bget: no buffers"</span><span class=p>);</span>
</span><span id=__span-82-85><a id=__codelineno-82-85 name=__codelineno-82-85></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(6) 最后将末尾的两个小函数也改一下:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-83-1> 1</a></span>
<span class=normal><a href=#__codelineno-83-2> 2</a></span>
<span class=normal><a href=#__codelineno-83-3> 3</a></span>
<span class=normal><a href=#__codelineno-83-4> 4</a></span>
<span class=normal><a href=#__codelineno-83-5> 5</a></span>
<span class=normal><a href=#__codelineno-83-6> 6</a></span>
<span class=normal><a href=#__codelineno-83-7> 7</a></span>
<span class=normal><a href=#__codelineno-83-8> 8</a></span>
<span class=normal><a href=#__codelineno-83-9> 9</a></span>
<span class=normal><a href=#__codelineno-83-10>10</a></span>
<span class=normal><a href=#__codelineno-83-11>11</a></span>
<span class=normal><a href=#__codelineno-83-12>12</a></span>
<span class=normal><a href=#__codelineno-83-13>13</a></span>
<span class=normal><a href=#__codelineno-83-14>14</a></span>
<span class=normal><a href=#__codelineno-83-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1></a><span class=kt>void</span><span class=w> </span><span class=nf>bpin</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2></a><span class=p>{</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>bid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HASH</span><span class=p>(</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>blockno</span><span class=p>);</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5></a><span class=w>    </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7></a><span class=p>}</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8></a>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9></a><span class=kt>void</span><span class=w> </span><span class=nf>bunpin</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-83-10><a id=__codelineno-83-10 name=__codelineno-83-10></a><span class=p>{</span>
</span><span id=__span-83-11><a id=__codelineno-83-11 name=__codelineno-83-11></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>bid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HASH</span><span class=p>(</span><span class=n>b</span><span class=o>-&gt;</span><span class=n>blockno</span><span class=p>);</span>
</span><span id=__span-83-12><a id=__codelineno-83-12 name=__codelineno-83-12></a><span class=w>    </span><span class=n>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-83-13><a id=__codelineno-83-13 name=__codelineno-83-13></a><span class=w>    </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>refcnt</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-83-14><a id=__codelineno-83-14 name=__codelineno-83-14></a><span class=w>    </span><span class=n>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bcache</span><span class=p>.</span><span class=n>buckets</span><span class=p>[</span><span class=n>bid</span><span class=p>].</span><span class=n>lock</span><span class=p>);</span>
</span><span id=__span-83-15><a id=__codelineno-83-15 name=__codelineno-83-15></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=lab9-file-system>Lab9: file system<a class=headerlink href=#lab9-file-system title="Permanent link">¶</a></h2> <ol> <li> <p>Large files</p> <p>(1) 在<code>fs.h</code>中添加宏定义:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-84-1>1</a></span>
<span class=normal><a href=#__codelineno-84-2>2</a></span>
<span class=normal><a href=#__codelineno-84-3>3</a></span>
<span class=normal><a href=#__codelineno-84-4>4</a></span>
<span class=normal><a href=#__codelineno-84-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1></a><span class=cp>#define NDIRECT 11                                 </span><span class=c1>// 直接块数量</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2></a><span class=cp>#define NINDIRECT (BSIZE / sizeof(uint))           </span><span class=c1>// 单个间接块可寻址的块数 = 1024/4=256</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3></a><span class=cp>#define NDINDIRECT ((BSIZE / sizeof(uint)) * (BSIZE / sizeof(uint))) </span><span class=c1>// 双重间接块可寻址块数=256*256=65536</span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4></a><span class=cp>#define MAXFILE (NDIRECT + NINDIRECT + NDINDIRECT) </span><span class=c1>// 最大文件块数=11+256+65536=65803</span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5></a><span class=cp>#define NADDR_PER_BLOCK (BSIZE / sizeof(uint))     </span><span class=c1>// 每个块存储的地址数量=256</span>
</span></code></pre></div></td></tr></table></div> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-85-1>1</a></span>
<span class=normal><a href=#__codelineno-85-2>2</a></span>
<span class=normal><a href=#__codelineno-85-3>3</a></span>
<span class=normal><a href=#__codelineno-85-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1></a>inode.addrs[] 
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2></a>├─ [0-10]: (NDIRECT) 直接数据块 (11 blocks)
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3></a>├─ [11]  : (NINDIRECT) 一级间接块指针 → 256数据块 
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4></a>└─ [12]  : (NDINDIRECT) 二级间接块指针 → 256个一级间接块 → 每个指向256数据块 (共256*256)
</span></code></pre></div></td></tr></table></div> <p>(2) 由于<code>NDIRECT</code>定义改变，其中一个直接块变为了二级间接块，需要修改<code>inode</code>结构体中<code>addrs</code>元素数量:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-86-1> 1</a></span>
<span class=normal><a href=#__codelineno-86-2> 2</a></span>
<span class=normal><a href=#__codelineno-86-3> 3</a></span>
<span class=normal><a href=#__codelineno-86-4> 4</a></span>
<span class=normal><a href=#__codelineno-86-5> 5</a></span>
<span class=normal><a href=#__codelineno-86-6> 6</a></span>
<span class=normal><a href=#__codelineno-86-7> 7</a></span>
<span class=normal><a href=#__codelineno-86-8> 8</a></span>
<span class=normal><a href=#__codelineno-86-9> 9</a></span>
<span class=normal><a href=#__codelineno-86-10>10</a></span>
<span class=normal><a href=#__codelineno-86-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1></a><span class=c1>// fs.h</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2></a><span class=k>struct</span><span class=w> </span><span class=nc>dinode</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>];</span><span class=w>   </span><span class=c1>// Data block addresses</span>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5></a><span class=p>};</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6></a>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7></a><span class=c1>// file.h</span>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8></a><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-86-10><a id=__codelineno-86-10 name=__codelineno-86-10></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-86-11><a id=__codelineno-86-11 name=__codelineno-86-11></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 修改<code>bmap</code>支持二级索引:</p> <p><code>bmap</code> 函数的作用是将文件的逻辑块号（bn）映射为磁盘上的物理块号，并在需要时分配新的磁盘块。它是 xv6 文件系统实现中 inode 块寻址的核心函数，支持直接块、一级间接块和二级间接块三种寻址方式。具体流程如下：</p> <ul> <li> <p>直接块(Direct Block):</p> <p>如果 bn 小于 NDIRECT，说明要访问的是直接块。直接块的物理地址直接存储在 inode 的 addrs 数组中。如果该地址为 0，说明还没有分配物理块，则调用 balloc 分配一个新块，并写入 addrs。最后返回物理块号。</p> </li> <li> <p>一级间接块(Singly Indirect Block):</p> <p>如果 bn 超过了直接块范围但小于 NINDIRECT，则说明要访问的是一级间接块。此时，inode 的 addrs[NDIRECT] 存储的是一级间接块的地址。若该地址为 0，则先分配一个间接块。然后读取该间接块，查找对应的条目（即数据块地址），如果为 0，则分配新数据块并写入。最后释放缓冲区并返回物理块号。</p> </li> <li> <p>二级间接块(Doubly Indirect Block):</p> <p>如果 bn 还更大，落在二级间接块范围内，则需要两级查找。首先，addrs[NDIRECT+1] 存储二级间接块的地址。若为 0，则分配一个二级间接块。读取二级间接块，找到第一级间接块的地址（level2_idx），如果为 0，则分配一级间接块。然后读取一级间接块，找到最终的数据块地址（level1_idx），如果为 0，则分配新数据块。每次分配新块后都要用 log_write 标记缓冲区已修改，最后释放缓冲区并返回物理块号。</p> </li> <li> <p>超出支持范围:</p> <p>如果 bn 超过了所有支持的寻址范围，则直接 panic，提示 "bmap: out of range"。</p> </li> </ul> <p>通过这种分级寻址和按需分配机制，xv6 文件系统既能高效支持小文件，也能支持较大的文件存储。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-87-1> 1</a></span>
<span class=normal><a href=#__codelineno-87-2> 2</a></span>
<span class=normal><a href=#__codelineno-87-3> 3</a></span>
<span class=normal><a href=#__codelineno-87-4> 4</a></span>
<span class=normal><a href=#__codelineno-87-5> 5</a></span>
<span class=normal><a href=#__codelineno-87-6> 6</a></span>
<span class=normal><a href=#__codelineno-87-7> 7</a></span>
<span class=normal><a href=#__codelineno-87-8> 8</a></span>
<span class=normal><a href=#__codelineno-87-9> 9</a></span>
<span class=normal><a href=#__codelineno-87-10>10</a></span>
<span class=normal><a href=#__codelineno-87-11>11</a></span>
<span class=normal><a href=#__codelineno-87-12>12</a></span>
<span class=normal><a href=#__codelineno-87-13>13</a></span>
<span class=normal><a href=#__codelineno-87-14>14</a></span>
<span class=normal><a href=#__codelineno-87-15>15</a></span>
<span class=normal><a href=#__codelineno-87-16>16</a></span>
<span class=normal><a href=#__codelineno-87-17>17</a></span>
<span class=normal><a href=#__codelineno-87-18>18</a></span>
<span class=normal><a href=#__codelineno-87-19>19</a></span>
<span class=normal><a href=#__codelineno-87-20>20</a></span>
<span class=normal><a href=#__codelineno-87-21>21</a></span>
<span class=normal><a href=#__codelineno-87-22>22</a></span>
<span class=normal><a href=#__codelineno-87-23>23</a></span>
<span class=normal><a href=#__codelineno-87-24>24</a></span>
<span class=normal><a href=#__codelineno-87-25>25</a></span>
<span class=normal><a href=#__codelineno-87-26>26</a></span>
<span class=normal><a href=#__codelineno-87-27>27</a></span>
<span class=normal><a href=#__codelineno-87-28>28</a></span>
<span class=normal><a href=#__codelineno-87-29>29</a></span>
<span class=normal><a href=#__codelineno-87-30>30</a></span>
<span class=normal><a href=#__codelineno-87-31>31</a></span>
<span class=normal><a href=#__codelineno-87-32>32</a></span>
<span class=normal><a href=#__codelineno-87-33>33</a></span>
<span class=normal><a href=#__codelineno-87-34>34</a></span>
<span class=normal><a href=#__codelineno-87-35>35</a></span>
<span class=normal><a href=#__codelineno-87-36>36</a></span>
<span class=normal><a href=#__codelineno-87-37>37</a></span>
<span class=normal><a href=#__codelineno-87-38>38</a></span>
<span class=normal><a href=#__codelineno-87-39>39</a></span>
<span class=normal><a href=#__codelineno-87-40>40</a></span>
<span class=normal><a href=#__codelineno-87-41>41</a></span>
<span class=normal><a href=#__codelineno-87-42>42</a></span>
<span class=normal><a href=#__codelineno-87-43>43</a></span>
<span class=normal><a href=#__codelineno-87-44>44</a></span>
<span class=normal><a href=#__codelineno-87-45>45</a></span>
<span class=normal><a href=#__codelineno-87-46>46</a></span>
<span class=normal><a href=#__codelineno-87-47>47</a></span>
<span class=normal><a href=#__codelineno-87-48>48</a></span>
<span class=normal><a href=#__codelineno-87-49>49</a></span>
<span class=normal><a href=#__codelineno-87-50>50</a></span>
<span class=normal><a href=#__codelineno-87-51>51</a></span>
<span class=normal><a href=#__codelineno-87-52>52</a></span>
<span class=normal><a href=#__codelineno-87-53>53</a></span>
<span class=normal><a href=#__codelineno-87-54>54</a></span>
<span class=normal><a href=#__codelineno-87-55>55</a></span>
<span class=normal><a href=#__codelineno-87-56>56</a></span>
<span class=normal><a href=#__codelineno-87-57>57</a></span>
<span class=normal><a href=#__codelineno-87-58>58</a></span>
<span class=normal><a href=#__codelineno-87-59>59</a></span>
<span class=normal><a href=#__codelineno-87-60>60</a></span>
<span class=normal><a href=#__codelineno-87-61>61</a></span>
<span class=normal><a href=#__codelineno-87-62>62</a></span>
<span class=normal><a href=#__codelineno-87-63>63</a></span>
<span class=normal><a href=#__codelineno-87-64>64</a></span>
<span class=normal><a href=#__codelineno-87-65>65</a></span>
<span class=normal><a href=#__codelineno-87-66>66</a></span>
<span class=normal><a href=#__codelineno-87-67>67</a></span>
<span class=normal><a href=#__codelineno-87-68>68</a></span>
<span class=normal><a href=#__codelineno-87-69>69</a></span>
<span class=normal><a href=#__codelineno-87-70>70</a></span>
<span class=normal><a href=#__codelineno-87-71>71</a></span>
<span class=normal><a href=#__codelineno-87-72>72</a></span>
<span class=normal><a href=#__codelineno-87-73>73</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1></a><span class=c1>// Inode content</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2></a><span class=c1>//</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3></a><span class=c1>// The content (data) associated with each inode is stored</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4></a><span class=c1>// in blocks on the disk. The first NDIRECT block numbers</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5></a><span class=c1>// are listed in ip-&gt;addrs[].  The next NINDIRECT blocks are</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6></a><span class=c1>// listed in block ip-&gt;addrs[NDIRECT].</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7></a>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8></a><span class=c1>// Return the disk block address of the nth block in inode ip.</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9></a><span class=c1>// If there is no such block, bmap allocates one.</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10></a><span class=k>static</span><span class=w> </span><span class=n>uint</span><span class=w> </span><span class=nf>bmap</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=n>uint</span><span class=w> </span><span class=n>bn</span><span class=p>)</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11></a><span class=p>{</span>
</span><span id=__span-87-12><a id=__codelineno-87-12 name=__codelineno-87-12></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>a</span><span class=p>;</span>
</span><span id=__span-87-13><a id=__codelineno-87-13 name=__codelineno-87-13></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-87-14><a id=__codelineno-87-14 name=__codelineno-87-14></a>
</span><span id=__span-87-15><a id=__codelineno-87-15 name=__codelineno-87-15></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>bn</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NDIRECT</span><span class=p>)</span>
</span><span id=__span-87-16><a id=__codelineno-87-16 name=__codelineno-87-16></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-87-17><a id=__codelineno-87-17 name=__codelineno-87-17></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>bn</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-87-18><a id=__codelineno-87-18 name=__codelineno-87-18></a><span class=w>            </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>bn</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-19><a id=__codelineno-87-19 name=__codelineno-87-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-87-20><a id=__codelineno-87-20 name=__codelineno-87-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-87-21><a id=__codelineno-87-21 name=__codelineno-87-21></a><span class=w>    </span><span class=n>bn</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>NDIRECT</span><span class=p>;</span>
</span><span id=__span-87-22><a id=__codelineno-87-22 name=__codelineno-87-22></a>
</span><span id=__span-87-23><a id=__codelineno-87-23 name=__codelineno-87-23></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>bn</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NINDIRECT</span><span class=p>)</span>
</span><span id=__span-87-24><a id=__codelineno-87-24 name=__codelineno-87-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-87-25><a id=__codelineno-87-25 name=__codelineno-87-25></a><span class=w>        </span><span class=c1>// Load indirect block, allocating if necessary.</span>
</span><span id=__span-87-26><a id=__codelineno-87-26 name=__codelineno-87-26></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-87-27><a id=__codelineno-87-27 name=__codelineno-87-27></a><span class=w>            </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-28><a id=__codelineno-87-28 name=__codelineno-87-28></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-87-29><a id=__codelineno-87-29 name=__codelineno-87-29></a><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-87-30><a id=__codelineno-87-30 name=__codelineno-87-30></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>bn</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-87-31><a id=__codelineno-87-31 name=__codelineno-87-31></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-87-32><a id=__codelineno-87-32 name=__codelineno-87-32></a><span class=w>            </span><span class=n>a</span><span class=p>[</span><span class=n>bn</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-33><a id=__codelineno-87-33 name=__codelineno-87-33></a><span class=w>            </span><span class=n>log_write</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span><span class=w> </span><span class=c1>// 记录块修改</span>
</span><span id=__span-87-34><a id=__codelineno-87-34 name=__codelineno-87-34></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-87-35><a id=__codelineno-87-35 name=__codelineno-87-35></a><span class=w>        </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-87-36><a id=__codelineno-87-36 name=__codelineno-87-36></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-87-37><a id=__codelineno-87-37 name=__codelineno-87-37></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-87-38><a id=__codelineno-87-38 name=__codelineno-87-38></a><span class=w>    </span><span class=n>bn</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>NINDIRECT</span><span class=p>;</span>
</span><span id=__span-87-39><a id=__codelineno-87-39 name=__codelineno-87-39></a>
</span><span id=__span-87-40><a id=__codelineno-87-40 name=__codelineno-87-40></a><span class=w>    </span><span class=c1>// ============== solution for Large files ================</span>
</span><span id=__span-87-41><a id=__codelineno-87-41 name=__codelineno-87-41></a><span class=w>    </span><span class=c1>// 二级间接块的情况</span>
</span><span id=__span-87-42><a id=__codelineno-87-42 name=__codelineno-87-42></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>bn</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NDINDIRECT</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-87-43><a id=__codelineno-87-43 name=__codelineno-87-43></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-87-44><a id=__codelineno-87-44 name=__codelineno-87-44></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>level2_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bn</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>NADDR_PER_BLOCK</span><span class=p>;</span><span class=w>  </span><span class=c1>// 要查找的块号位于二级间接块中的位置</span>
</span><span id=__span-87-45><a id=__codelineno-87-45 name=__codelineno-87-45></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>level1_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bn</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>NADDR_PER_BLOCK</span><span class=p>;</span><span class=w>  </span><span class=c1>// 要查找的块号位于一级间接块中的位置</span>
</span><span id=__span-87-46><a id=__codelineno-87-46 name=__codelineno-87-46></a><span class=w>        </span><span class=c1>// 读出二级间接块</span>
</span><span id=__span-87-47><a id=__codelineno-87-47 name=__codelineno-87-47></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-87-48><a id=__codelineno-87-48 name=__codelineno-87-48></a><span class=w>            </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-49><a id=__codelineno-87-49 name=__codelineno-87-49></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-87-50><a id=__codelineno-87-50 name=__codelineno-87-50></a><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-87-51><a id=__codelineno-87-51 name=__codelineno-87-51></a>
</span><span id=__span-87-52><a id=__codelineno-87-52 name=__codelineno-87-52></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>level2_idx</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-87-53><a id=__codelineno-87-53 name=__codelineno-87-53></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-87-54><a id=__codelineno-87-54 name=__codelineno-87-54></a><span class=w>            </span><span class=n>a</span><span class=p>[</span><span class=n>level2_idx</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-55><a id=__codelineno-87-55 name=__codelineno-87-55></a><span class=w>            </span><span class=c1>// 更改了当前块的内容，标记以供后续写回磁盘</span>
</span><span id=__span-87-56><a id=__codelineno-87-56 name=__codelineno-87-56></a><span class=w>            </span><span class=n>log_write</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-87-57><a id=__codelineno-87-57 name=__codelineno-87-57></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-87-58><a id=__codelineno-87-58 name=__codelineno-87-58></a><span class=w>        </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-87-59><a id=__codelineno-87-59 name=__codelineno-87-59></a>
</span><span id=__span-87-60><a id=__codelineno-87-60 name=__codelineno-87-60></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-87-61><a id=__codelineno-87-61 name=__codelineno-87-61></a><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-87-62><a id=__codelineno-87-62 name=__codelineno-87-62></a><span class=w>        </span><span class=k>if</span><span class=p>((</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>level1_idx</span><span class=p>])</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-87-63><a id=__codelineno-87-63 name=__codelineno-87-63></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-87-64><a id=__codelineno-87-64 name=__codelineno-87-64></a><span class=w>            </span><span class=n>a</span><span class=p>[</span><span class=n>level1_idx</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balloc</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>);</span>
</span><span id=__span-87-65><a id=__codelineno-87-65 name=__codelineno-87-65></a><span class=w>            </span><span class=n>log_write</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-87-66><a id=__codelineno-87-66 name=__codelineno-87-66></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-87-67><a id=__codelineno-87-67 name=__codelineno-87-67></a><span class=w>        </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-87-68><a id=__codelineno-87-68 name=__codelineno-87-68></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-87-69><a id=__codelineno-87-69 name=__codelineno-87-69></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-87-70><a id=__codelineno-87-70 name=__codelineno-87-70></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-87-71><a id=__codelineno-87-71 name=__codelineno-87-71></a>
</span><span id=__span-87-72><a id=__codelineno-87-72 name=__codelineno-87-72></a><span class=w>    </span><span class=n>panic</span><span class=p>(</span><span class=s>"bmap: out of range"</span><span class=p>);</span>
</span><span id=__span-87-73><a id=__codelineno-87-73 name=__codelineno-87-73></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改<code>itrunc</code>释放所有块:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-88-1> 1</a></span>
<span class=normal><a href=#__codelineno-88-2> 2</a></span>
<span class=normal><a href=#__codelineno-88-3> 3</a></span>
<span class=normal><a href=#__codelineno-88-4> 4</a></span>
<span class=normal><a href=#__codelineno-88-5> 5</a></span>
<span class=normal><a href=#__codelineno-88-6> 6</a></span>
<span class=normal><a href=#__codelineno-88-7> 7</a></span>
<span class=normal><a href=#__codelineno-88-8> 8</a></span>
<span class=normal><a href=#__codelineno-88-9> 9</a></span>
<span class=normal><a href=#__codelineno-88-10>10</a></span>
<span class=normal><a href=#__codelineno-88-11>11</a></span>
<span class=normal><a href=#__codelineno-88-12>12</a></span>
<span class=normal><a href=#__codelineno-88-13>13</a></span>
<span class=normal><a href=#__codelineno-88-14>14</a></span>
<span class=normal><a href=#__codelineno-88-15>15</a></span>
<span class=normal><a href=#__codelineno-88-16>16</a></span>
<span class=normal><a href=#__codelineno-88-17>17</a></span>
<span class=normal><a href=#__codelineno-88-18>18</a></span>
<span class=normal><a href=#__codelineno-88-19>19</a></span>
<span class=normal><a href=#__codelineno-88-20>20</a></span>
<span class=normal><a href=#__codelineno-88-21>21</a></span>
<span class=normal><a href=#__codelineno-88-22>22</a></span>
<span class=normal><a href=#__codelineno-88-23>23</a></span>
<span class=normal><a href=#__codelineno-88-24>24</a></span>
<span class=normal><a href=#__codelineno-88-25>25</a></span>
<span class=normal><a href=#__codelineno-88-26>26</a></span>
<span class=normal><a href=#__codelineno-88-27>27</a></span>
<span class=normal><a href=#__codelineno-88-28>28</a></span>
<span class=normal><a href=#__codelineno-88-29>29</a></span>
<span class=normal><a href=#__codelineno-88-30>30</a></span>
<span class=normal><a href=#__codelineno-88-31>31</a></span>
<span class=normal><a href=#__codelineno-88-32>32</a></span>
<span class=normal><a href=#__codelineno-88-33>33</a></span>
<span class=normal><a href=#__codelineno-88-34>34</a></span>
<span class=normal><a href=#__codelineno-88-35>35</a></span>
<span class=normal><a href=#__codelineno-88-36>36</a></span>
<span class=normal><a href=#__codelineno-88-37>37</a></span>
<span class=normal><a href=#__codelineno-88-38>38</a></span>
<span class=normal><a href=#__codelineno-88-39>39</a></span>
<span class=normal><a href=#__codelineno-88-40>40</a></span>
<span class=normal><a href=#__codelineno-88-41>41</a></span>
<span class=normal><a href=#__codelineno-88-42>42</a></span>
<span class=normal><a href=#__codelineno-88-43>43</a></span>
<span class=normal><a href=#__codelineno-88-44>44</a></span>
<span class=normal><a href=#__codelineno-88-45>45</a></span>
<span class=normal><a href=#__codelineno-88-46>46</a></span>
<span class=normal><a href=#__codelineno-88-47>47</a></span>
<span class=normal><a href=#__codelineno-88-48>48</a></span>
<span class=normal><a href=#__codelineno-88-49>49</a></span>
<span class=normal><a href=#__codelineno-88-50>50</a></span>
<span class=normal><a href=#__codelineno-88-51>51</a></span>
<span class=normal><a href=#__codelineno-88-52>52</a></span>
<span class=normal><a href=#__codelineno-88-53>53</a></span>
<span class=normal><a href=#__codelineno-88-54>54</a></span>
<span class=normal><a href=#__codelineno-88-55>55</a></span>
<span class=normal><a href=#__codelineno-88-56>56</a></span>
<span class=normal><a href=#__codelineno-88-57>57</a></span>
<span class=normal><a href=#__codelineno-88-58>58</a></span>
<span class=normal><a href=#__codelineno-88-59>59</a></span>
<span class=normal><a href=#__codelineno-88-60>60</a></span>
<span class=normal><a href=#__codelineno-88-61>61</a></span>
<span class=normal><a href=#__codelineno-88-62>62</a></span>
<span class=normal><a href=#__codelineno-88-63>63</a></span>
<span class=normal><a href=#__codelineno-88-64>64</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1></a><span class=c1>// Truncate inode (discard contents).</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2></a><span class=c1>// Caller must hold ip-&gt;lock.</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3></a><span class=kt>void</span><span class=w> </span><span class=nf>itrunc</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>ip</span><span class=p>)</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4></a><span class=p>{</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>j</span><span class=p>;</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7></a><span class=w>    </span><span class=n>uint</span><span class=w> </span><span class=o>*</span><span class=n>a</span><span class=p>;</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8></a>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NDIRECT</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span><span id=__span-88-12><a id=__codelineno-88-12 name=__codelineno-88-12></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-88-13><a id=__codelineno-88-13 name=__codelineno-88-13></a><span class=w>            </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span><span id=__span-88-14><a id=__codelineno-88-14 name=__codelineno-88-14></a><span class=w>            </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-88-15><a id=__codelineno-88-15 name=__codelineno-88-15></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-88-16><a id=__codelineno-88-16 name=__codelineno-88-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-88-17><a id=__codelineno-88-17 name=__codelineno-88-17></a>
</span><span id=__span-88-18><a id=__codelineno-88-18 name=__codelineno-88-18></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>])</span>
</span><span id=__span-88-19><a id=__codelineno-88-19 name=__codelineno-88-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-88-20><a id=__codelineno-88-20 name=__codelineno-88-20></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>]);</span>
</span><span id=__span-88-21><a id=__codelineno-88-21 name=__codelineno-88-21></a><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-88-22><a id=__codelineno-88-22 name=__codelineno-88-22></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NINDIRECT</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-88-23><a id=__codelineno-88-23 name=__codelineno-88-23></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-88-24><a id=__codelineno-88-24 name=__codelineno-88-24></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span><span id=__span-88-25><a id=__codelineno-88-25 name=__codelineno-88-25></a><span class=w>                </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span><span id=__span-88-26><a id=__codelineno-88-26 name=__codelineno-88-26></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-88-27><a id=__codelineno-88-27 name=__codelineno-88-27></a><span class=w>        </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-88-28><a id=__codelineno-88-28 name=__codelineno-88-28></a><span class=w>        </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>]);</span>
</span><span id=__span-88-29><a id=__codelineno-88-29 name=__codelineno-88-29></a><span class=w>        </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-88-30><a id=__codelineno-88-30 name=__codelineno-88-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-88-31><a id=__codelineno-88-31 name=__codelineno-88-31></a>
</span><span id=__span-88-32><a id=__codelineno-88-32 name=__codelineno-88-32></a><span class=w>    </span><span class=c1>// ============== solution for Large files ================</span>
</span><span id=__span-88-33><a id=__codelineno-88-33 name=__codelineno-88-33></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>buf</span><span class=o>*</span><span class=w> </span><span class=n>bp1</span><span class=p>;</span>
</span><span id=__span-88-34><a id=__codelineno-88-34 name=__codelineno-88-34></a><span class=w>    </span><span class=n>uint</span><span class=o>*</span><span class=w> </span><span class=n>a1</span><span class=p>;</span>
</span><span id=__span-88-35><a id=__codelineno-88-35 name=__codelineno-88-35></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>])</span><span class=w> </span>
</span><span id=__span-88-36><a id=__codelineno-88-36 name=__codelineno-88-36></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-88-37><a id=__codelineno-88-37 name=__codelineno-88-37></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-88-38><a id=__codelineno-88-38 name=__codelineno-88-38></a><span class=w>        </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-88-39><a id=__codelineno-88-39 name=__codelineno-88-39></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NADDR_PER_BLOCK</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-88-40><a id=__codelineno-88-40 name=__codelineno-88-40></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-88-41><a id=__codelineno-88-41 name=__codelineno-88-41></a><span class=w>            </span><span class=c1>// 每个一级间接块的操作都类似于上面的</span>
</span><span id=__span-88-42><a id=__codelineno-88-42 name=__codelineno-88-42></a><span class=w>            </span><span class=c1>// if(ip-&gt;addrs[NDIRECT])中的内容</span>
</span><span id=__span-88-43><a id=__codelineno-88-43 name=__codelineno-88-43></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=w> </span>
</span><span id=__span-88-44><a id=__codelineno-88-44 name=__codelineno-88-44></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-88-45><a id=__codelineno-88-45 name=__codelineno-88-45></a><span class=w>                </span><span class=n>bp1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bread</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span><span id=__span-88-46><a id=__codelineno-88-46 name=__codelineno-88-46></a><span class=w>                </span><span class=n>a1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uint</span><span class=o>*</span><span class=p>)</span><span class=n>bp1</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-88-47><a id=__codelineno-88-47 name=__codelineno-88-47></a><span class=w>                </span><span class=k>for</span><span class=p>(</span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NADDR_PER_BLOCK</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-88-48><a id=__codelineno-88-48 name=__codelineno-88-48></a><span class=w>                </span><span class=p>{</span>
</span><span id=__span-88-49><a id=__codelineno-88-49 name=__codelineno-88-49></a><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>a1</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span><span id=__span-88-50><a id=__codelineno-88-50 name=__codelineno-88-50></a><span class=w>                        </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>a1</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span><span id=__span-88-51><a id=__codelineno-88-51 name=__codelineno-88-51></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-88-52><a id=__codelineno-88-52 name=__codelineno-88-52></a><span class=w>                </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp1</span><span class=p>);</span>
</span><span id=__span-88-53><a id=__codelineno-88-53 name=__codelineno-88-53></a><span class=w>                </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span><span id=__span-88-54><a id=__codelineno-88-54 name=__codelineno-88-54></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-88-55><a id=__codelineno-88-55 name=__codelineno-88-55></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-88-56><a id=__codelineno-88-56 name=__codelineno-88-56></a><span class=w>        </span><span class=n>brelse</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-88-57><a id=__codelineno-88-57 name=__codelineno-88-57></a><span class=w>        </span><span class=n>bfree</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>dev</span><span class=p>,</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-88-58><a id=__codelineno-88-58 name=__codelineno-88-58></a><span class=w>        </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>addrs</span><span class=p>[</span><span class=n>NDIRECT</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-88-59><a id=__codelineno-88-59 name=__codelineno-88-59></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-88-60><a id=__codelineno-88-60 name=__codelineno-88-60></a><span class=w>    </span><span class=c1>// ==========================================================</span>
</span><span id=__span-88-61><a id=__codelineno-88-61 name=__codelineno-88-61></a>
</span><span id=__span-88-62><a id=__codelineno-88-62 name=__codelineno-88-62></a><span class=w>    </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-88-63><a id=__codelineno-88-63 name=__codelineno-88-63></a><span class=w>    </span><span class=n>iupdate</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-88-64><a id=__codelineno-88-64 name=__codelineno-88-64></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <p>Symbolic links</p> <p>(1) 配置系统调用的常规操作，如在<code>user/usys.pl</code>、<code>user/user.h</code>中添加一个条目，在<code>kernel/syscall.c</code>、<code>kernel/syscall.h</code>中添加相关内容</p> <p>(2) 添加提示中的相关定义，<code>T_SYMLINK</code>以及<code>O_NOFOLLOW</code></p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-89-1>1</a></span>
<span class=normal><a href=#__codelineno-89-2>2</a></span>
<span class=normal><a href=#__codelineno-89-3>3</a></span>
<span class=normal><a href=#__codelineno-89-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1></a><span class=c1>// fcntl.h</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2></a><span class=cp>#define O_NOFOLLOW 0x004</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3></a><span class=c1>// stat.h</span>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4></a><span class=cp>#define T_SYMLINK 4</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 在<code>kernel/sysfile.c</code>中实现<code>sys_symlink</code>，这里需要注意的是<code>create</code>返回已加锁的<code>inode</code>，此外<code>iunlockput</code>既对<code>inode</code>解锁，还将其引用计数减1，计数为0时回收此<code>inode</code></p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-90-1> 1</a></span>
<span class=normal><a href=#__codelineno-90-2> 2</a></span>
<span class=normal><a href=#__codelineno-90-3> 3</a></span>
<span class=normal><a href=#__codelineno-90-4> 4</a></span>
<span class=normal><a href=#__codelineno-90-5> 5</a></span>
<span class=normal><a href=#__codelineno-90-6> 6</a></span>
<span class=normal><a href=#__codelineno-90-7> 7</a></span>
<span class=normal><a href=#__codelineno-90-8> 8</a></span>
<span class=normal><a href=#__codelineno-90-9> 9</a></span>
<span class=normal><a href=#__codelineno-90-10>10</a></span>
<span class=normal><a href=#__codelineno-90-11>11</a></span>
<span class=normal><a href=#__codelineno-90-12>12</a></span>
<span class=normal><a href=#__codelineno-90-13>13</a></span>
<span class=normal><a href=#__codelineno-90-14>14</a></span>
<span class=normal><a href=#__codelineno-90-15>15</a></span>
<span class=normal><a href=#__codelineno-90-16>16</a></span>
<span class=normal><a href=#__codelineno-90-17>17</a></span>
<span class=normal><a href=#__codelineno-90-18>18</a></span>
<span class=normal><a href=#__codelineno-90-19>19</a></span>
<span class=normal><a href=#__codelineno-90-20>20</a></span>
<span class=normal><a href=#__codelineno-90-21>21</a></span>
<span class=normal><a href=#__codelineno-90-22>22</a></span>
<span class=normal><a href=#__codelineno-90-23>23</a></span>
<span class=normal><a href=#__codelineno-90-24>24</a></span>
<span class=normal><a href=#__codelineno-90-25>25</a></span>
<span class=normal><a href=#__codelineno-90-26>26</a></span>
<span class=normal><a href=#__codelineno-90-27>27</a></span>
<span class=normal><a href=#__codelineno-90-28>28</a></span>
<span class=normal><a href=#__codelineno-90-29>29</a></span>
<span class=normal><a href=#__codelineno-90-30>30</a></span>
<span class=normal><a href=#__codelineno-90-31>31</a></span>
<span class=normal><a href=#__codelineno-90-32>32</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_symlink</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2></a><span class=p>{</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>target</span><span class=p>[</span><span class=n>MAXPATH</span><span class=p>],</span><span class=w> </span><span class=n>path</span><span class=p>[</span><span class=n>MAXPATH</span><span class=p>];</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4></a><span class=w>    </span><span class=c1>// target: 符号链接指向的目标路径</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5></a><span class=w>    </span><span class=c1>// path: 符号链接本身的路径</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=o>*</span><span class=w> </span><span class=n>ip_path</span><span class=p>;</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7></a>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argstr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argstr</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-12><a id=__codelineno-90-12 name=__codelineno-90-12></a>
</span><span id=__span-90-13><a id=__codelineno-90-13 name=__codelineno-90-13></a><span class=w>    </span><span class=n>begin_op</span><span class=p>();</span>
</span><span id=__span-90-14><a id=__codelineno-90-14 name=__codelineno-90-14></a><span class=w>    </span><span class=c1>// 分配一个inode结点，create返回锁定的inode</span>
</span><span id=__span-90-15><a id=__codelineno-90-15 name=__codelineno-90-15></a><span class=w>    </span><span class=n>ip_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>T_SYMLINK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-90-16><a id=__codelineno-90-16 name=__codelineno-90-16></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ip_path</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-90-17><a id=__codelineno-90-17 name=__codelineno-90-17></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-90-18><a id=__codelineno-90-18 name=__codelineno-90-18></a><span class=w>        </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-90-19><a id=__codelineno-90-19 name=__codelineno-90-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-90-20><a id=__codelineno-90-20 name=__codelineno-90-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-21><a id=__codelineno-90-21 name=__codelineno-90-21></a><span class=w>    </span><span class=c1>// 向inode数据块中写入target路径</span>
</span><span id=__span-90-22><a id=__codelineno-90-22 name=__codelineno-90-22></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>writei</span><span class=p>(</span><span class=n>ip_path</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-90-23><a id=__codelineno-90-23 name=__codelineno-90-23></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-90-24><a id=__codelineno-90-24 name=__codelineno-90-24></a><span class=w>        </span><span class=n>iunlockput</span><span class=p>(</span><span class=n>ip_path</span><span class=p>);</span>
</span><span id=__span-90-25><a id=__codelineno-90-25 name=__codelineno-90-25></a><span class=w>        </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-90-26><a id=__codelineno-90-26 name=__codelineno-90-26></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-90-27><a id=__codelineno-90-27 name=__codelineno-90-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-28><a id=__codelineno-90-28 name=__codelineno-90-28></a>
</span><span id=__span-90-29><a id=__codelineno-90-29 name=__codelineno-90-29></a><span class=w>    </span><span class=n>iunlockput</span><span class=p>(</span><span class=n>ip_path</span><span class=p>);</span>
</span><span id=__span-90-30><a id=__codelineno-90-30 name=__codelineno-90-30></a><span class=w>    </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-90-31><a id=__codelineno-90-31 name=__codelineno-90-31></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-90-32><a id=__codelineno-90-32 name=__codelineno-90-32></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 修改<code>sys_open</code>支持打开符号链接:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-91-1> 1</a></span>
<span class=normal><a href=#__codelineno-91-2> 2</a></span>
<span class=normal><a href=#__codelineno-91-3> 3</a></span>
<span class=normal><a href=#__codelineno-91-4> 4</a></span>
<span class=normal><a href=#__codelineno-91-5> 5</a></span>
<span class=normal><a href=#__codelineno-91-6> 6</a></span>
<span class=normal><a href=#__codelineno-91-7> 7</a></span>
<span class=normal><a href=#__codelineno-91-8> 8</a></span>
<span class=normal><a href=#__codelineno-91-9> 9</a></span>
<span class=normal><a href=#__codelineno-91-10>10</a></span>
<span class=normal><a href=#__codelineno-91-11>11</a></span>
<span class=normal><a href=#__codelineno-91-12>12</a></span>
<span class=normal><a href=#__codelineno-91-13>13</a></span>
<span class=normal><a href=#__codelineno-91-14>14</a></span>
<span class=normal><a href=#__codelineno-91-15>15</a></span>
<span class=normal><a href=#__codelineno-91-16>16</a></span>
<span class=normal><a href=#__codelineno-91-17>17</a></span>
<span class=normal><a href=#__codelineno-91-18>18</a></span>
<span class=normal><a href=#__codelineno-91-19>19</a></span>
<span class=normal><a href=#__codelineno-91-20>20</a></span>
<span class=normal><a href=#__codelineno-91-21>21</a></span>
<span class=normal><a href=#__codelineno-91-22>22</a></span>
<span class=normal><a href=#__codelineno-91-23>23</a></span>
<span class=normal><a href=#__codelineno-91-24>24</a></span>
<span class=normal><a href=#__codelineno-91-25>25</a></span>
<span class=normal><a href=#__codelineno-91-26>26</a></span>
<span class=normal><a href=#__codelineno-91-27>27</a></span>
<span class=normal><a href=#__codelineno-91-28>28</a></span>
<span class=normal><a href=#__codelineno-91-29>29</a></span>
<span class=normal><a href=#__codelineno-91-30>30</a></span>
<span class=normal><a href=#__codelineno-91-31>31</a></span>
<span class=normal><a href=#__codelineno-91-32>32</a></span>
<span class=normal><a href=#__codelineno-91-33>33</a></span>
<span class=normal><a href=#__codelineno-91-34>34</a></span>
<span class=normal><a href=#__codelineno-91-35>35</a></span>
<span class=normal><a href=#__codelineno-91-36>36</a></span>
<span class=normal><a href=#__codelineno-91-37>37</a></span>
<span class=normal><a href=#__codelineno-91-38>38</a></span>
<span class=normal><a href=#__codelineno-91-39>39</a></span>
<span class=normal><a href=#__codelineno-91-40>40</a></span>
<span class=normal><a href=#__codelineno-91-41>41</a></span>
<span class=normal><a href=#__codelineno-91-42>42</a></span>
<span class=normal><a href=#__codelineno-91-43>43</a></span>
<span class=normal><a href=#__codelineno-91-44>44</a></span>
<span class=normal><a href=#__codelineno-91-45>45</a></span>
<span class=normal><a href=#__codelineno-91-46>46</a></span>
<span class=normal><a href=#__codelineno-91-47>47</a></span>
<span class=normal><a href=#__codelineno-91-48>48</a></span>
<span class=normal><a href=#__codelineno-91-49>49</a></span>
<span class=normal><a href=#__codelineno-91-50>50</a></span>
<span class=normal><a href=#__codelineno-91-51>51</a></span>
<span class=normal><a href=#__codelineno-91-52>52</a></span>
<span class=normal><a href=#__codelineno-91-53>53</a></span>
<span class=normal><a href=#__codelineno-91-54>54</a></span>
<span class=normal><a href=#__codelineno-91-55>55</a></span>
<span class=normal><a href=#__codelineno-91-56>56</a></span>
<span class=normal><a href=#__codelineno-91-57>57</a></span>
<span class=normal><a href=#__codelineno-91-58>58</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_open</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2></a><span class=p>{</span>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4></a>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>T_DEVICE</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>major</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>major</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>NDEV</span><span class=p>))</span>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9></a>
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10></a><span class=w>    </span><span class=c1>// O_NOFOLLOW：指示在打开文件时，如果目标路径是符号链接，不要追踪</span>
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11></a><span class=w>    </span><span class=c1>// 该符号链接指向的实际文件，而是直接将符号链接本身作为打开对象。</span>
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12></a>
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13></a><span class=w>    </span><span class=c1>// 只有当要打开的文件是符号链接，并且没有要求不追踪符号链接时，</span>
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14></a><span class=w>    </span><span class=c1>// 代码才会执行追踪符号链接的逻辑，去找到符号链接实际指向的文件</span>
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15></a>
</span><span id=__span-91-16><a id=__codelineno-91-16 name=__codelineno-91-16></a><span class=w>    </span><span class=c1>// 处理符号链接</span>
</span><span id=__span-91-17><a id=__codelineno-91-17 name=__codelineno-91-17></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>T_SYMLINK</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>omode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>O_NOFOLLOW</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-91-18><a id=__codelineno-91-18 name=__codelineno-91-18></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-91-19><a id=__codelineno-91-19 name=__codelineno-91-19></a><span class=w>        </span><span class=c1>// 若符号链接指向的仍然是符号链接，则递归的跟随它</span>
</span><span id=__span-91-20><a id=__codelineno-91-20 name=__codelineno-91-20></a><span class=w>        </span><span class=c1>// 直到找到真正指向的文件</span>
</span><span id=__span-91-21><a id=__codelineno-91-21 name=__codelineno-91-21></a><span class=w>        </span><span class=c1>// 但深度不能超过MAX_SYMLINK_DEPTH</span>
</span><span id=__span-91-22><a id=__codelineno-91-22 name=__codelineno-91-22></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAX_SYMLINK_DEPTH</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-91-23><a id=__codelineno-91-23 name=__codelineno-91-23></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-91-24><a id=__codelineno-91-24 name=__codelineno-91-24></a><span class=w>            </span><span class=c1>// 读出符号链接指向的路径</span>
</span><span id=__span-91-25><a id=__codelineno-91-25 name=__codelineno-91-25></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>readi</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>MAXPATH</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-91-26><a id=__codelineno-91-26 name=__codelineno-91-26></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-91-27><a id=__codelineno-91-27 name=__codelineno-91-27></a><span class=w>                </span><span class=n>iunlockput</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-91-28><a id=__codelineno-91-28 name=__codelineno-91-28></a><span class=w>                </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-91-29><a id=__codelineno-91-29 name=__codelineno-91-29></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-91-30><a id=__codelineno-91-30 name=__codelineno-91-30></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-91-31><a id=__codelineno-91-31 name=__codelineno-91-31></a><span class=w>            </span><span class=n>iunlockput</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-91-32><a id=__codelineno-91-32 name=__codelineno-91-32></a><span class=w>            </span><span class=n>ip</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>namei</span><span class=p>(</span><span class=n>path</span><span class=p>);</span><span class=w> </span><span class=c1>// 根据读取到的路径查找对应的 inode 节点</span>
</span><span id=__span-91-33><a id=__codelineno-91-33 name=__codelineno-91-33></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-91-34><a id=__codelineno-91-34 name=__codelineno-91-34></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-91-35><a id=__codelineno-91-35 name=__codelineno-91-35></a><span class=w>                </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-91-36><a id=__codelineno-91-36 name=__codelineno-91-36></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-91-37><a id=__codelineno-91-37 name=__codelineno-91-37></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-91-38><a id=__codelineno-91-38 name=__codelineno-91-38></a><span class=w>            </span><span class=n>ilock</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-91-39><a id=__codelineno-91-39 name=__codelineno-91-39></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>type</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>T_SYMLINK</span><span class=p>)</span>
</span><span id=__span-91-40><a id=__codelineno-91-40 name=__codelineno-91-40></a><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>       </span><span class=c1>// 新节点不是符号链接，跳出循环</span>
</span><span id=__span-91-41><a id=__codelineno-91-41 name=__codelineno-91-41></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-91-42><a id=__codelineno-91-42 name=__codelineno-91-42></a><span class=w>        </span><span class=c1>// 超过最大允许深度后仍然为符号链接，则返回错误</span>
</span><span id=__span-91-43><a id=__codelineno-91-43 name=__codelineno-91-43></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>type</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>T_SYMLINK</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-91-44><a id=__codelineno-91-44 name=__codelineno-91-44></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-91-45><a id=__codelineno-91-45 name=__codelineno-91-45></a><span class=w>            </span><span class=n>iunlockput</span><span class=p>(</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-91-46><a id=__codelineno-91-46 name=__codelineno-91-46></a><span class=w>            </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-91-47><a id=__codelineno-91-47 name=__codelineno-91-47></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-91-48><a id=__codelineno-91-48 name=__codelineno-91-48></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-91-49><a id=__codelineno-91-49 name=__codelineno-91-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-91-50><a id=__codelineno-91-50 name=__codelineno-91-50></a>
</span><span id=__span-91-51><a id=__codelineno-91-51 name=__codelineno-91-51></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filealloc</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fdalloc</span><span class=p>(</span><span class=n>f</span><span class=p>))</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-91-52><a id=__codelineno-91-52 name=__codelineno-91-52></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-91-53><a id=__codelineno-91-53 name=__codelineno-91-53></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-91-54><a id=__codelineno-91-54 name=__codelineno-91-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-91-55><a id=__codelineno-91-55 name=__codelineno-91-55></a>
</span><span id=__span-91-56><a id=__codelineno-91-56 name=__codelineno-91-56></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-91-57><a id=__codelineno-91-57 name=__codelineno-91-57></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span>
</span><span id=__span-91-58><a id=__codelineno-91-58 name=__codelineno-91-58></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><img alt="alt text" src=../../img/image-66.png></p> </li> </ol> <h2 id=lab10-mmap>Lab10: mmap<a class=headerlink href=#lab10-mmap title="Permanent link">¶</a></h2> <ol> <li> <p>mmap</p> <blockquote> <p>本实验是实现一个内存映射文件的功能，将文件映射到内存中，从而在与文件交互时减少磁盘操作。</p> </blockquote> <p>(1) 首先是配置<code>mmap</code>和<code>munmap</code>系统调用，修改syscall.c/syscall.h/user.h/usys.pl，以及在 Makefile 里添加 mmaptest。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-92-1>1</a></span>
<span class=normal><a href=#__codelineno-92-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1></a><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=nf>mmap</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>prot</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>);</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2></a><span class=kt>int</span><span class=w> </span><span class=nf>munmap</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>(2) 定义VMA结构体，并添加到进程结构体中：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-93-1> 1</a></span>
<span class=normal><a href=#__codelineno-93-2> 2</a></span>
<span class=normal><a href=#__codelineno-93-3> 3</a></span>
<span class=normal><a href=#__codelineno-93-4> 4</a></span>
<span class=normal><a href=#__codelineno-93-5> 5</a></span>
<span class=normal><a href=#__codelineno-93-6> 6</a></span>
<span class=normal><a href=#__codelineno-93-7> 7</a></span>
<span class=normal><a href=#__codelineno-93-8> 8</a></span>
<span class=normal><a href=#__codelineno-93-9> 9</a></span>
<span class=normal><a href=#__codelineno-93-10>10</a></span>
<span class=normal><a href=#__codelineno-93-11>11</a></span>
<span class=normal><a href=#__codelineno-93-12>12</a></span>
<span class=normal><a href=#__codelineno-93-13>13</a></span>
<span class=normal><a href=#__codelineno-93-14>14</a></span>
<span class=normal><a href=#__codelineno-93-15>15</a></span>
<span class=normal><a href=#__codelineno-93-16>16</a></span>
<span class=normal><a href=#__codelineno-93-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1></a><span class=cp>#define NVMA 16</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2></a><span class=c1>// 虚拟内存区域结构体</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3></a><span class=k>struct</span><span class=w> </span><span class=nc>vm_area</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>used</span><span class=p>;</span><span class=w>           </span><span class=c1>// 是否已被使用</span>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>addr</span><span class=p>;</span><span class=w>        </span><span class=c1>// 起始地址</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w>            </span><span class=c1>// 长度</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>prot</span><span class=p>;</span><span class=w>           </span><span class=c1>// 权限</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>;</span><span class=w>          </span><span class=c1>// 标志位</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>vfd</span><span class=p>;</span><span class=w>            </span><span class=c1>// 对应的文件描述符</span>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=o>*</span><span class=w> </span><span class=n>vfile</span><span class=p>;</span><span class=w> </span><span class=c1>// 对应文件</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>;</span><span class=w>         </span><span class=c1>// 文件偏移，本实验中一直为0</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12></a><span class=p>};</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13></a>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14></a><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>vm_area</span><span class=w> </span><span class=n>vma</span><span class=p>[</span><span class=n>NVMA</span><span class=p>];</span><span class=w>    </span><span class=c1>// 虚拟内存区域</span>
</span><span id=__span-93-17><a id=__codelineno-93-17 name=__codelineno-93-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(3) 在<code>allocproc</code>中将<code>vma</code>数组初始化为全0:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-94-1> 1</a></span>
<span class=normal><a href=#__codelineno-94-2> 2</a></span>
<span class=normal><a href=#__codelineno-94-3> 3</a></span>
<span class=normal><a href=#__codelineno-94-4> 4</a></span>
<span class=normal><a href=#__codelineno-94-5> 5</a></span>
<span class=normal><a href=#__codelineno-94-6> 6</a></span>
<span class=normal><a href=#__codelineno-94-7> 7</a></span>
<span class=normal><a href=#__codelineno-94-8> 8</a></span>
<span class=normal><a href=#__codelineno-94-9> 9</a></span>
<span class=normal><a href=#__codelineno-94-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>allocproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2></a><span class=p>{</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4></a>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5></a><span class=w>    </span><span class=nl>found</span><span class=p>:</span>
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-94-7><a id=__codelineno-94-7 name=__codelineno-94-7></a>
</span><span id=__span-94-8><a id=__codelineno-94-8 name=__codelineno-94-8></a><span class=w>    </span><span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>));</span>
</span><span id=__span-94-9><a id=__codelineno-94-9 name=__codelineno-94-9></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=p>;</span>
</span><span id=__span-94-10><a id=__codelineno-94-10 name=__codelineno-94-10></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(4) 根据提示2、3、4，参考lazy实验中的分配方法（将当前p-&gt;sz作为分配的虚拟起始地址，但不实际分配物理页面），此函数写在sysfile.c中就可以使用静态函数argfd同时解析文件描述符和struct file:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-95-1> 1</a></span>
<span class=normal><a href=#__codelineno-95-2> 2</a></span>
<span class=normal><a href=#__codelineno-95-3> 3</a></span>
<span class=normal><a href=#__codelineno-95-4> 4</a></span>
<span class=normal><a href=#__codelineno-95-5> 5</a></span>
<span class=normal><a href=#__codelineno-95-6> 6</a></span>
<span class=normal><a href=#__codelineno-95-7> 7</a></span>
<span class=normal><a href=#__codelineno-95-8> 8</a></span>
<span class=normal><a href=#__codelineno-95-9> 9</a></span>
<span class=normal><a href=#__codelineno-95-10>10</a></span>
<span class=normal><a href=#__codelineno-95-11>11</a></span>
<span class=normal><a href=#__codelineno-95-12>12</a></span>
<span class=normal><a href=#__codelineno-95-13>13</a></span>
<span class=normal><a href=#__codelineno-95-14>14</a></span>
<span class=normal><a href=#__codelineno-95-15>15</a></span>
<span class=normal><a href=#__codelineno-95-16>16</a></span>
<span class=normal><a href=#__codelineno-95-17>17</a></span>
<span class=normal><a href=#__codelineno-95-18>18</a></span>
<span class=normal><a href=#__codelineno-95-19>19</a></span>
<span class=normal><a href=#__codelineno-95-20>20</a></span>
<span class=normal><a href=#__codelineno-95-21>21</a></span>
<span class=normal><a href=#__codelineno-95-22>22</a></span>
<span class=normal><a href=#__codelineno-95-23>23</a></span>
<span class=normal><a href=#__codelineno-95-24>24</a></span>
<span class=normal><a href=#__codelineno-95-25>25</a></span>
<span class=normal><a href=#__codelineno-95-26>26</a></span>
<span class=normal><a href=#__codelineno-95-27>27</a></span>
<span class=normal><a href=#__codelineno-95-28>28</a></span>
<span class=normal><a href=#__codelineno-95-29>29</a></span>
<span class=normal><a href=#__codelineno-95-30>30</a></span>
<span class=normal><a href=#__codelineno-95-31>31</a></span>
<span class=normal><a href=#__codelineno-95-32>32</a></span>
<span class=normal><a href=#__codelineno-95-33>33</a></span>
<span class=normal><a href=#__codelineno-95-34>34</a></span>
<span class=normal><a href=#__codelineno-95-35>35</a></span>
<span class=normal><a href=#__codelineno-95-36>36</a></span>
<span class=normal><a href=#__codelineno-95-37>37</a></span>
<span class=normal><a href=#__codelineno-95-38>38</a></span>
<span class=normal><a href=#__codelineno-95-39>39</a></span>
<span class=normal><a href=#__codelineno-95-40>40</a></span>
<span class=normal><a href=#__codelineno-95-41>41</a></span>
<span class=normal><a href=#__codelineno-95-42>42</a></span>
<span class=normal><a href=#__codelineno-95-43>43</a></span>
<span class=normal><a href=#__codelineno-95-44>44</a></span>
<span class=normal><a href=#__codelineno-95-45>45</a></span>
<span class=normal><a href=#__codelineno-95-46>46</a></span>
<span class=normal><a href=#__codelineno-95-47>47</a></span>
<span class=normal><a href=#__codelineno-95-48>48</a></span>
<span class=normal><a href=#__codelineno-95-49>49</a></span>
<span class=normal><a href=#__codelineno-95-50>50</a></span>
<span class=normal><a href=#__codelineno-95-51>51</a></span>
<span class=normal><a href=#__codelineno-95-52>52</a></span>
<span class=normal><a href=#__codelineno-95-53>53</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_mmap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2></a><span class=p>{</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>prot</span><span class=p>;</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>vfd</span><span class=p>;</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=o>*</span><span class=w> </span><span class=n>vfile</span><span class=p>;</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>;</span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0xffffffffffffffff</span><span class=p>;</span>
</span><span id=__span-95-11><a id=__codelineno-95-11 name=__codelineno-95-11></a>
</span><span id=__span-95-12><a id=__codelineno-95-12 name=__codelineno-95-12></a><span class=w>    </span><span class=c1>// 获取系统调用参数</span>
</span><span id=__span-95-13><a id=__codelineno-95-13 name=__codelineno-95-13></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argaddr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argint</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prot</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span>
</span><span id=__span-95-14><a id=__codelineno-95-14 name=__codelineno-95-14></a><span class=w>        </span><span class=n>argint</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argfd</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>vfd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>vfile</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argint</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>offset</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-95-15><a id=__codelineno-95-15 name=__codelineno-95-15></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-95-16><a id=__codelineno-95-16 name=__codelineno-95-16></a>
</span><span id=__span-95-17><a id=__codelineno-95-17 name=__codelineno-95-17></a><span class=w>    </span><span class=c1>// 实验提示中假定addr和offset为0，简化程序可能发生的情况</span>
</span><span id=__span-95-18><a id=__codelineno-95-18 name=__codelineno-95-18></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>addr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-95-19><a id=__codelineno-95-19 name=__codelineno-95-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-95-20><a id=__codelineno-95-20 name=__codelineno-95-20></a>
</span><span id=__span-95-21><a id=__codelineno-95-21 name=__codelineno-95-21></a><span class=w>    </span><span class=c1>// 文件不可写则不允许拥有PROT_WRITE权限时映射为MAP_SHARED</span>
</span><span id=__span-95-22><a id=__codelineno-95-22 name=__codelineno-95-22></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>vfile</span><span class=o>-&gt;</span><span class=n>writable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_WRITE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_SHARED</span><span class=p>)</span>
</span><span id=__span-95-23><a id=__codelineno-95-23 name=__codelineno-95-23></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-95-24><a id=__codelineno-95-24 name=__codelineno-95-24></a>
</span><span id=__span-95-25><a id=__codelineno-95-25 name=__codelineno-95-25></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-95-26><a id=__codelineno-95-26 name=__codelineno-95-26></a><span class=w>    </span><span class=c1>// 没有足够的虚拟地址空间</span>
</span><span id=__span-95-27><a id=__codelineno-95-27 name=__codelineno-95-27></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAXVA</span><span class=p>)</span>
</span><span id=__span-95-28><a id=__codelineno-95-28 name=__codelineno-95-28></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-95-29><a id=__codelineno-95-29 name=__codelineno-95-29></a>
</span><span id=__span-95-30><a id=__codelineno-95-30 name=__codelineno-95-30></a><span class=w>    </span><span class=c1>// 遍历查找未使用的VMA结构体</span>
</span><span id=__span-95-31><a id=__codelineno-95-31 name=__codelineno-95-31></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NVMA</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-95-32><a id=__codelineno-95-32 name=__codelineno-95-32></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-95-33><a id=__codelineno-95-33 name=__codelineno-95-33></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-95-34><a id=__codelineno-95-34 name=__codelineno-95-34></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-95-35><a id=__codelineno-95-35 name=__codelineno-95-35></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-95-36><a id=__codelineno-95-36 name=__codelineno-95-36></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span><span id=__span-95-37><a id=__codelineno-95-37 name=__codelineno-95-37></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-95-38><a id=__codelineno-95-38 name=__codelineno-95-38></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flags</span><span class=p>;</span>
</span><span id=__span-95-39><a id=__codelineno-95-39 name=__codelineno-95-39></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>prot</span><span class=p>;</span>
</span><span id=__span-95-40><a id=__codelineno-95-40 name=__codelineno-95-40></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vfile</span><span class=p>;</span>
</span><span id=__span-95-41><a id=__codelineno-95-41 name=__codelineno-95-41></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vfd</span><span class=p>;</span>
</span><span id=__span-95-42><a id=__codelineno-95-42 name=__codelineno-95-42></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>offset</span><span class=p>;</span>
</span><span id=__span-95-43><a id=__codelineno-95-43 name=__codelineno-95-43></a>
</span><span id=__span-95-44><a id=__codelineno-95-44 name=__codelineno-95-44></a><span class=w>            </span><span class=c1>// 增加文件的引用计数</span>
</span><span id=__span-95-45><a id=__codelineno-95-45 name=__codelineno-95-45></a><span class=w>            </span><span class=n>filedup</span><span class=p>(</span><span class=n>vfile</span><span class=p>);</span>
</span><span id=__span-95-46><a id=__codelineno-95-46 name=__codelineno-95-46></a>
</span><span id=__span-95-47><a id=__codelineno-95-47 name=__codelineno-95-47></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-95-48><a id=__codelineno-95-48 name=__codelineno-95-48></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-95-49><a id=__codelineno-95-49 name=__codelineno-95-49></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-95-50><a id=__codelineno-95-50 name=__codelineno-95-50></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-95-51><a id=__codelineno-95-51 name=__codelineno-95-51></a>
</span><span id=__span-95-52><a id=__codelineno-95-52 name=__codelineno-95-52></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span>
</span><span id=__span-95-53><a id=__codelineno-95-53 name=__codelineno-95-53></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(5) 根据提示5，此时访问对应的页面就会产生页面错误，需要在usertrap中进行处理，主要完成三项工作：分配物理页面，读取文件内容，添加映射关系:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-96-1> 1</a></span>
<span class=normal><a href=#__codelineno-96-2> 2</a></span>
<span class=normal><a href=#__codelineno-96-3> 3</a></span>
<span class=normal><a href=#__codelineno-96-4> 4</a></span>
<span class=normal><a href=#__codelineno-96-5> 5</a></span>
<span class=normal><a href=#__codelineno-96-6> 6</a></span>
<span class=normal><a href=#__codelineno-96-7> 7</a></span>
<span class=normal><a href=#__codelineno-96-8> 8</a></span>
<span class=normal><a href=#__codelineno-96-9> 9</a></span>
<span class=normal><a href=#__codelineno-96-10>10</a></span>
<span class=normal><a href=#__codelineno-96-11>11</a></span>
<span class=normal><a href=#__codelineno-96-12>12</a></span>
<span class=normal><a href=#__codelineno-96-13>13</a></span>
<span class=normal><a href=#__codelineno-96-14>14</a></span>
<span class=normal><a href=#__codelineno-96-15>15</a></span>
<span class=normal><a href=#__codelineno-96-16>16</a></span>
<span class=normal><a href=#__codelineno-96-17>17</a></span>
<span class=normal><a href=#__codelineno-96-18>18</a></span>
<span class=normal><a href=#__codelineno-96-19>19</a></span>
<span class=normal><a href=#__codelineno-96-20>20</a></span>
<span class=normal><a href=#__codelineno-96-21>21</a></span>
<span class=normal><a href=#__codelineno-96-22>22</a></span>
<span class=normal><a href=#__codelineno-96-23>23</a></span>
<span class=normal><a href=#__codelineno-96-24>24</a></span>
<span class=normal><a href=#__codelineno-96-25>25</a></span>
<span class=normal><a href=#__codelineno-96-26>26</a></span>
<span class=normal><a href=#__codelineno-96-27>27</a></span>
<span class=normal><a href=#__codelineno-96-28>28</a></span>
<span class=normal><a href=#__codelineno-96-29>29</a></span>
<span class=normal><a href=#__codelineno-96-30>30</a></span>
<span class=normal><a href=#__codelineno-96-31>31</a></span>
<span class=normal><a href=#__codelineno-96-32>32</a></span>
<span class=normal><a href=#__codelineno-96-33>33</a></span>
<span class=normal><a href=#__codelineno-96-34>34</a></span>
<span class=normal><a href=#__codelineno-96-35>35</a></span>
<span class=normal><a href=#__codelineno-96-36>36</a></span>
<span class=normal><a href=#__codelineno-96-37>37</a></span>
<span class=normal><a href=#__codelineno-96-38>38</a></span>
<span class=normal><a href=#__codelineno-96-39>39</a></span>
<span class=normal><a href=#__codelineno-96-40>40</a></span>
<span class=normal><a href=#__codelineno-96-41>41</a></span>
<span class=normal><a href=#__codelineno-96-42>42</a></span>
<span class=normal><a href=#__codelineno-96-43>43</a></span>
<span class=normal><a href=#__codelineno-96-44>44</a></span>
<span class=normal><a href=#__codelineno-96-45>45</a></span>
<span class=normal><a href=#__codelineno-96-46>46</a></span>
<span class=normal><a href=#__codelineno-96-47>47</a></span>
<span class=normal><a href=#__codelineno-96-48>48</a></span>
<span class=normal><a href=#__codelineno-96-49>49</a></span>
<span class=normal><a href=#__codelineno-96-50>50</a></span>
<span class=normal><a href=#__codelineno-96-51>51</a></span>
<span class=normal><a href=#__codelineno-96-52>52</a></span>
<span class=normal><a href=#__codelineno-96-53>53</a></span>
<span class=normal><a href=#__codelineno-96-54>54</a></span>
<span class=normal><a href=#__codelineno-96-55>55</a></span>
<span class=normal><a href=#__codelineno-96-56>56</a></span>
<span class=normal><a href=#__codelineno-96-57>57</a></span>
<span class=normal><a href=#__codelineno-96-58>58</a></span>
<span class=normal><a href=#__codelineno-96-59>59</a></span>
<span class=normal><a href=#__codelineno-96-60>60</a></span>
<span class=normal><a href=#__codelineno-96-61>61</a></span>
<span class=normal><a href=#__codelineno-96-62>62</a></span>
<span class=normal><a href=#__codelineno-96-63>63</a></span>
<span class=normal><a href=#__codelineno-96-64>64</a></span>
<span class=normal><a href=#__codelineno-96-65>65</a></span>
<span class=normal><a href=#__codelineno-96-66>66</a></span>
<span class=normal><a href=#__codelineno-96-67>67</a></span>
<span class=normal><a href=#__codelineno-96-68>68</a></span>
<span class=normal><a href=#__codelineno-96-69>69</a></span>
<span class=normal><a href=#__codelineno-96-70>70</a></span>
<span class=normal><a href=#__codelineno-96-71>71</a></span>
<span class=normal><a href=#__codelineno-96-72>72</a></span>
<span class=normal><a href=#__codelineno-96-73>73</a></span>
<span class=normal><a href=#__codelineno-96-74>74</a></span>
<span class=normal><a href=#__codelineno-96-75>75</a></span>
<span class=normal><a href=#__codelineno-96-76>76</a></span>
<span class=normal><a href=#__codelineno-96-77>77</a></span>
<span class=normal><a href=#__codelineno-96-78>78</a></span>
<span class=normal><a href=#__codelineno-96-79>79</a></span>
<span class=normal><a href=#__codelineno-96-80>80</a></span>
<span class=normal><a href=#__codelineno-96-81>81</a></span>
<span class=normal><a href=#__codelineno-96-82>82</a></span>
<span class=normal><a href=#__codelineno-96-83>83</a></span>
<span class=normal><a href=#__codelineno-96-84>84</a></span>
<span class=normal><a href=#__codelineno-96-85>85</a></span>
<span class=normal><a href=#__codelineno-96-86>86</a></span>
<span class=normal><a href=#__codelineno-96-87>87</a></span>
<span class=normal><a href=#__codelineno-96-88>88</a></span>
<span class=normal><a href=#__codelineno-96-89>89</a></span>
<span class=normal><a href=#__codelineno-96-90>90</a></span>
<span class=normal><a href=#__codelineno-96-91>91</a></span>
<span class=normal><a href=#__codelineno-96-92>92</a></span>
<span class=normal><a href=#__codelineno-96-93>93</a></span>
<span class=normal><a href=#__codelineno-96-94>94</a></span>
<span class=normal><a href=#__codelineno-96-95>95</a></span>
<span class=normal><a href=#__codelineno-96-96>96</a></span>
<span class=normal><a href=#__codelineno-96-97>97</a></span>
<span class=normal><a href=#__codelineno-96-98>98</a></span>
<span class=normal><a href=#__codelineno-96-99>99</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1></a><span class=kt>void</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2></a><span class=nf>usertrap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3></a><span class=p>{</span>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-96-8><a id=__codelineno-96-8 name=__codelineno-96-8></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>((</span><span class=n>which_dev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>devintr</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-96-9><a id=__codelineno-96-9 name=__codelineno-96-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-10><a id=__codelineno-96-10 name=__codelineno-96-10></a><span class=w>        </span><span class=c1>// ok</span>
</span><span id=__span-96-11><a id=__codelineno-96-11 name=__codelineno-96-11></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>13</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>15</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-12><a id=__codelineno-96-12 name=__codelineno-96-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-13><a id=__codelineno-96-13 name=__codelineno-96-13></a><span class=w>    </span><span class=cp>#ifdef LAB_MMAP</span>
</span><span id=__span-96-14><a id=__codelineno-96-14 name=__codelineno-96-14></a><span class=w>        </span><span class=c1>// 读取产生页面故障的虚拟地址，并判断是否位于有效区间</span>
</span><span id=__span-96-15><a id=__codelineno-96-15 name=__codelineno-96-15></a><span class=w>        </span><span class=n>uint64</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r_stval</span><span class=p>();</span>
</span><span id=__span-96-16><a id=__codelineno-96-16 name=__codelineno-96-16></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>PGROUNDUP</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>fault_va</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-17><a id=__codelineno-96-17 name=__codelineno-96-17></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-96-18><a id=__codelineno-96-18 name=__codelineno-96-18></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>mmap_handler</span><span class=p>(</span><span class=n>r_stval</span><span class=p>(),</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-19><a id=__codelineno-96-19 name=__codelineno-96-19></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-96-20><a id=__codelineno-96-20 name=__codelineno-96-20></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-96-21><a id=__codelineno-96-21 name=__codelineno-96-21></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-96-22><a id=__codelineno-96-22 name=__codelineno-96-22></a><span class=w>        </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-96-23><a id=__codelineno-96-23 name=__codelineno-96-23></a><span class=w>        </span><span class=k>else</span>
</span><span id=__span-96-24><a id=__codelineno-96-24 name=__codelineno-96-24></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-96-25><a id=__codelineno-96-25 name=__codelineno-96-25></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-96-26><a id=__codelineno-96-26 name=__codelineno-96-26></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-96-27><a id=__codelineno-96-27 name=__codelineno-96-27></a><span class=w>    </span><span class=cp>#endif</span>
</span><span id=__span-96-28><a id=__codelineno-96-28 name=__codelineno-96-28></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-96-29><a id=__codelineno-96-29 name=__codelineno-96-29></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-96-30><a id=__codelineno-96-30 name=__codelineno-96-30></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-31><a id=__codelineno-96-31 name=__codelineno-96-31></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-96-32><a id=__codelineno-96-32 name=__codelineno-96-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-96-33><a id=__codelineno-96-33 name=__codelineno-96-33></a>
</span><span id=__span-96-34><a id=__codelineno-96-34 name=__codelineno-96-34></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-96-35><a id=__codelineno-96-35 name=__codelineno-96-35></a><span class=p>}</span>
</span><span id=__span-96-36><a id=__codelineno-96-36 name=__codelineno-96-36></a>
</span><span id=__span-96-37><a id=__codelineno-96-37 name=__codelineno-96-37></a><span class=cm>/**</span>
</span><span id=__span-96-38><a id=__codelineno-96-38 name=__codelineno-96-38></a><span class=cm>* @brief mmap_handler 处理mmap惰性分配导致的页面错误</span>
</span><span id=__span-96-39><a id=__codelineno-96-39 name=__codelineno-96-39></a><span class=cm>* @param va 页面故障虚拟地址</span>
</span><span id=__span-96-40><a id=__codelineno-96-40 name=__codelineno-96-40></a><span class=cm>* @param cause 页面故障原因</span>
</span><span id=__span-96-41><a id=__codelineno-96-41 name=__codelineno-96-41></a><span class=cm>* @return 0成功，-1失败</span>
</span><span id=__span-96-42><a id=__codelineno-96-42 name=__codelineno-96-42></a><span class=cm>*/</span>
</span><span id=__span-96-43><a id=__codelineno-96-43 name=__codelineno-96-43></a><span class=kt>int</span><span class=w> </span><span class=nf>mmap_handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>va</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>cause</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-44><a id=__codelineno-96-44 name=__codelineno-96-44></a><span class=p>{</span>
</span><span id=__span-96-45><a id=__codelineno-96-45 name=__codelineno-96-45></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-96-46><a id=__codelineno-96-46 name=__codelineno-96-46></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-96-47><a id=__codelineno-96-47 name=__codelineno-96-47></a><span class=w>    </span><span class=c1>// 根据地址查找属于哪一个VMA</span>
</span><span id=__span-96-48><a id=__codelineno-96-48 name=__codelineno-96-48></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NVMA</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-49><a id=__codelineno-96-49 name=__codelineno-96-49></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-50><a id=__codelineno-96-50 name=__codelineno-96-50></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>va</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-51><a id=__codelineno-96-51 name=__codelineno-96-51></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-96-52><a id=__codelineno-96-52 name=__codelineno-96-52></a><span class=w>            </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-96-53><a id=__codelineno-96-53 name=__codelineno-96-53></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-96-54><a id=__codelineno-96-54 name=__codelineno-96-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-96-55><a id=__codelineno-96-55 name=__codelineno-96-55></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NVMA</span><span class=p>)</span>
</span><span id=__span-96-56><a id=__codelineno-96-56 name=__codelineno-96-56></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-57><a id=__codelineno-96-57 name=__codelineno-96-57></a>
</span><span id=__span-96-58><a id=__codelineno-96-58 name=__codelineno-96-58></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pte_flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTE_U</span><span class=p>;</span>
</span><span id=__span-96-59><a id=__codelineno-96-59 name=__codelineno-96-59></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_READ</span><span class=p>)</span><span class=w> </span><span class=n>pte_flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PTE_R</span><span class=p>;</span>
</span><span id=__span-96-60><a id=__codelineno-96-60 name=__codelineno-96-60></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_WRITE</span><span class=p>)</span><span class=w> </span><span class=n>pte_flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PTE_W</span><span class=p>;</span>
</span><span id=__span-96-61><a id=__codelineno-96-61 name=__codelineno-96-61></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_EXEC</span><span class=p>)</span><span class=w> </span><span class=n>pte_flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>PTE_X</span><span class=p>;</span>
</span><span id=__span-96-62><a id=__codelineno-96-62 name=__codelineno-96-62></a>
</span><span id=__span-96-63><a id=__codelineno-96-63 name=__codelineno-96-63></a>
</span><span id=__span-96-64><a id=__codelineno-96-64 name=__codelineno-96-64></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=o>*</span><span class=w> </span><span class=n>vf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>;</span>
</span><span id=__span-96-65><a id=__codelineno-96-65 name=__codelineno-96-65></a><span class=w>    </span><span class=c1>// 读导致的页面错误</span>
</span><span id=__span-96-66><a id=__codelineno-96-66 name=__codelineno-96-66></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>13</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>readable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-67><a id=__codelineno-96-67 name=__codelineno-96-67></a><span class=w>    </span><span class=c1>// 写导致的页面错误</span>
</span><span id=__span-96-68><a id=__codelineno-96-68 name=__codelineno-96-68></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>15</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>writable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-69><a id=__codelineno-96-69 name=__codelineno-96-69></a>
</span><span id=__span-96-70><a id=__codelineno-96-70 name=__codelineno-96-70></a><span class=w>    </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>pa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kalloc</span><span class=p>();</span>
</span><span id=__span-96-71><a id=__codelineno-96-71 name=__codelineno-96-71></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>pa</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-96-72><a id=__codelineno-96-72 name=__codelineno-96-72></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-73><a id=__codelineno-96-73 name=__codelineno-96-73></a><span class=w>    </span><span class=n>memset</span><span class=p>(</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-96-74><a id=__codelineno-96-74 name=__codelineno-96-74></a>
</span><span id=__span-96-75><a id=__codelineno-96-75 name=__codelineno-96-75></a><span class=w>    </span><span class=c1>// 读取文件内容</span>
</span><span id=__span-96-76><a id=__codelineno-96-76 name=__codelineno-96-76></a><span class=w>    </span><span class=n>ilock</span><span class=p>(</span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-96-77><a id=__codelineno-96-77 name=__codelineno-96-77></a><span class=w>    </span><span class=c1>// 计算当前页面读取文件的偏移量，实验中p-&gt;vma[i].offset总是0</span>
</span><span id=__span-96-78><a id=__codelineno-96-78 name=__codelineno-96-78></a><span class=w>    </span><span class=c1>// 要按顺序读读取，例如内存页面A,B和文件块a,b</span>
</span><span id=__span-96-79><a id=__codelineno-96-79 name=__codelineno-96-79></a><span class=w>    </span><span class=c1>// 则A读取a，B读取b，而不能A读取b，B读取a</span>
</span><span id=__span-96-80><a id=__codelineno-96-80 name=__codelineno-96-80></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>offset</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>va</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-96-81><a id=__codelineno-96-81 name=__codelineno-96-81></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>readbytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readi</span><span class=p>(</span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>);</span>
</span><span id=__span-96-82><a id=__codelineno-96-82 name=__codelineno-96-82></a><span class=w>    </span><span class=c1>// 什么都没有读到</span>
</span><span id=__span-96-83><a id=__codelineno-96-83 name=__codelineno-96-83></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>readbytes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-84><a id=__codelineno-96-84 name=__codelineno-96-84></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-85><a id=__codelineno-96-85 name=__codelineno-96-85></a><span class=w>        </span><span class=n>iunlock</span><span class=p>(</span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-96-86><a id=__codelineno-96-86 name=__codelineno-96-86></a><span class=w>        </span><span class=n>kfree</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-96-87><a id=__codelineno-96-87 name=__codelineno-96-87></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-88><a id=__codelineno-96-88 name=__codelineno-96-88></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-96-89><a id=__codelineno-96-89 name=__codelineno-96-89></a><span class=w>    </span><span class=n>iunlock</span><span class=p>(</span><span class=n>vf</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>);</span>
</span><span id=__span-96-90><a id=__codelineno-96-90 name=__codelineno-96-90></a>
</span><span id=__span-96-91><a id=__codelineno-96-91 name=__codelineno-96-91></a><span class=w>    </span><span class=c1>// 添加页面映射</span>
</span><span id=__span-96-92><a id=__codelineno-96-92 name=__codelineno-96-92></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>mappages</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>PGROUNDDOWN</span><span class=p>(</span><span class=n>va</span><span class=p>),</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span><span class=w> </span><span class=n>pte_flags</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-96-93><a id=__codelineno-96-93 name=__codelineno-96-93></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-96-94><a id=__codelineno-96-94 name=__codelineno-96-94></a><span class=w>        </span><span class=n>kfree</span><span class=p>(</span><span class=n>pa</span><span class=p>);</span>
</span><span id=__span-96-95><a id=__codelineno-96-95 name=__codelineno-96-95></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-96-96><a id=__codelineno-96-96 name=__codelineno-96-96></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-96-97><a id=__codelineno-96-97 name=__codelineno-96-97></a>
</span><span id=__span-96-98><a id=__codelineno-96-98 name=__codelineno-96-98></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-96-99><a id=__codelineno-96-99 name=__codelineno-96-99></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(6) 根据提示6实现munmap，且提示7中说明无需查看脏位就可写回:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-97-1> 1</a></span>
<span class=normal><a href=#__codelineno-97-2> 2</a></span>
<span class=normal><a href=#__codelineno-97-3> 3</a></span>
<span class=normal><a href=#__codelineno-97-4> 4</a></span>
<span class=normal><a href=#__codelineno-97-5> 5</a></span>
<span class=normal><a href=#__codelineno-97-6> 6</a></span>
<span class=normal><a href=#__codelineno-97-7> 7</a></span>
<span class=normal><a href=#__codelineno-97-8> 8</a></span>
<span class=normal><a href=#__codelineno-97-9> 9</a></span>
<span class=normal><a href=#__codelineno-97-10>10</a></span>
<span class=normal><a href=#__codelineno-97-11>11</a></span>
<span class=normal><a href=#__codelineno-97-12>12</a></span>
<span class=normal><a href=#__codelineno-97-13>13</a></span>
<span class=normal><a href=#__codelineno-97-14>14</a></span>
<span class=normal><a href=#__codelineno-97-15>15</a></span>
<span class=normal><a href=#__codelineno-97-16>16</a></span>
<span class=normal><a href=#__codelineno-97-17>17</a></span>
<span class=normal><a href=#__codelineno-97-18>18</a></span>
<span class=normal><a href=#__codelineno-97-19>19</a></span>
<span class=normal><a href=#__codelineno-97-20>20</a></span>
<span class=normal><a href=#__codelineno-97-21>21</a></span>
<span class=normal><a href=#__codelineno-97-22>22</a></span>
<span class=normal><a href=#__codelineno-97-23>23</a></span>
<span class=normal><a href=#__codelineno-97-24>24</a></span>
<span class=normal><a href=#__codelineno-97-25>25</a></span>
<span class=normal><a href=#__codelineno-97-26>26</a></span>
<span class=normal><a href=#__codelineno-97-27>27</a></span>
<span class=normal><a href=#__codelineno-97-28>28</a></span>
<span class=normal><a href=#__codelineno-97-29>29</a></span>
<span class=normal><a href=#__codelineno-97-30>30</a></span>
<span class=normal><a href=#__codelineno-97-31>31</a></span>
<span class=normal><a href=#__codelineno-97-32>32</a></span>
<span class=normal><a href=#__codelineno-97-33>33</a></span>
<span class=normal><a href=#__codelineno-97-34>34</a></span>
<span class=normal><a href=#__codelineno-97-35>35</a></span>
<span class=normal><a href=#__codelineno-97-36>36</a></span>
<span class=normal><a href=#__codelineno-97-37>37</a></span>
<span class=normal><a href=#__codelineno-97-38>38</a></span>
<span class=normal><a href=#__codelineno-97-39>39</a></span>
<span class=normal><a href=#__codelineno-97-40>40</a></span>
<span class=normal><a href=#__codelineno-97-41>41</a></span>
<span class=normal><a href=#__codelineno-97-42>42</a></span>
<span class=normal><a href=#__codelineno-97-43>43</a></span>
<span class=normal><a href=#__codelineno-97-44>44</a></span>
<span class=normal><a href=#__codelineno-97-45>45</a></span>
<span class=normal><a href=#__codelineno-97-46>46</a></span>
<span class=normal><a href=#__codelineno-97-47>47</a></span>
<span class=normal><a href=#__codelineno-97-48>48</a></span>
<span class=normal><a href=#__codelineno-97-49>49</a></span>
<span class=normal><a href=#__codelineno-97-50>50</a></span>
<span class=normal><a href=#__codelineno-97-51>51</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1></a><span class=n>uint64</span><span class=w> </span><span class=nf>sys_munmap</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2></a><span class=p>{</span>
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3></a><span class=w>    </span><span class=n>uint64</span><span class=w> </span><span class=n>addr</span><span class=p>;</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>argaddr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>addr</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>argint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>length</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7></a>
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-97-9><a id=__codelineno-97-9 name=__codelineno-97-9></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>proc</span><span class=o>*</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myproc</span><span class=p>();</span>
</span><span id=__span-97-10><a id=__codelineno-97-10 name=__codelineno-97-10></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NVMA</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-11><a id=__codelineno-97-11 name=__codelineno-97-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-97-12><a id=__codelineno-97-12 name=__codelineno-97-12></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>length</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-13><a id=__codelineno-97-13 name=__codelineno-97-13></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-97-14><a id=__codelineno-97-14 name=__codelineno-97-14></a><span class=w>            </span><span class=c1>// 根据提示，munmap的地址范围只能是</span>
</span><span id=__span-97-15><a id=__codelineno-97-15 name=__codelineno-97-15></a><span class=w>            </span><span class=c1>// 1. 起始位置</span>
</span><span id=__span-97-16><a id=__codelineno-97-16 name=__codelineno-97-16></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>addr</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-17><a id=__codelineno-97-17 name=__codelineno-97-17></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-97-18><a id=__codelineno-97-18 name=__codelineno-97-18></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-97-19><a id=__codelineno-97-19 name=__codelineno-97-19></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-97-20><a id=__codelineno-97-20 name=__codelineno-97-20></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-97-21><a id=__codelineno-97-21 name=__codelineno-97-21></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-97-22><a id=__codelineno-97-22 name=__codelineno-97-22></a><span class=w>            </span><span class=c1>// 2. 结束位置</span>
</span><span id=__span-97-23><a id=__codelineno-97-23 name=__codelineno-97-23></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>addr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-24><a id=__codelineno-97-24 name=__codelineno-97-24></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-97-25><a id=__codelineno-97-25 name=__codelineno-97-25></a><span class=w>                </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>length</span><span class=p>;</span>
</span><span id=__span-97-26><a id=__codelineno-97-26 name=__codelineno-97-26></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-97-27><a id=__codelineno-97-27 name=__codelineno-97-27></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-97-28><a id=__codelineno-97-28 name=__codelineno-97-28></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-97-29><a id=__codelineno-97-29 name=__codelineno-97-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-97-30><a id=__codelineno-97-30 name=__codelineno-97-30></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NVMA</span><span class=p>)</span>
</span><span id=__span-97-31><a id=__codelineno-97-31 name=__codelineno-97-31></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-97-32><a id=__codelineno-97-32 name=__codelineno-97-32></a>
</span><span id=__span-97-33><a id=__codelineno-97-33 name=__codelineno-97-33></a><span class=w>    </span><span class=c1>// 将MAP_SHARED页面写回文件系统</span>
</span><span id=__span-97-34><a id=__codelineno-97-34 name=__codelineno-97-34></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flags</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_SHARED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_WRITE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-35><a id=__codelineno-97-35 name=__codelineno-97-35></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-97-36><a id=__codelineno-97-36 name=__codelineno-97-36></a><span class=w>        </span><span class=n>filewrite</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-97-37><a id=__codelineno-97-37 name=__codelineno-97-37></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-97-38><a id=__codelineno-97-38 name=__codelineno-97-38></a>
</span><span id=__span-97-39><a id=__codelineno-97-39 name=__codelineno-97-39></a><span class=w>    </span><span class=c1>// 判断此页面是否存在映射</span>
</span><span id=__span-97-40><a id=__codelineno-97-40 name=__codelineno-97-40></a><span class=w>    </span><span class=n>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-97-41><a id=__codelineno-97-41 name=__codelineno-97-41></a>
</span><span id=__span-97-42><a id=__codelineno-97-42 name=__codelineno-97-42></a>
</span><span id=__span-97-43><a id=__codelineno-97-43 name=__codelineno-97-43></a><span class=w>    </span><span class=c1>// 当前VMA中全部映射都被取消</span>
</span><span id=__span-97-44><a id=__codelineno-97-44 name=__codelineno-97-44></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-97-45><a id=__codelineno-97-45 name=__codelineno-97-45></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-97-46><a id=__codelineno-97-46 name=__codelineno-97-46></a><span class=w>        </span><span class=n>fileclose</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>);</span>
</span><span id=__span-97-47><a id=__codelineno-97-47 name=__codelineno-97-47></a><span class=w>        </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-97-48><a id=__codelineno-97-48 name=__codelineno-97-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-97-49><a id=__codelineno-97-49 name=__codelineno-97-49></a>
</span><span id=__span-97-50><a id=__codelineno-97-50 name=__codelineno-97-50></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-97-51><a id=__codelineno-97-51 name=__codelineno-97-51></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(7) 回忆lazy实验中，如果对惰性分配的页面调用了uvmunmap，或者子进程在fork中调用uvmcopy复制了父进程惰性分配的页面都会导致panic，因此需要修改uvmunmap和uvmcopy检查PTE_V后不再panic:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-98-1>1</a></span>
<span class=normal><a href=#__codelineno-98-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1></a><span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PTE_V</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2></a><span class=w>    </span><span class=k>continue</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>(8) 根据提示8修改exit，将进程的已映射区域取消映射:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-99-1> 1</a></span>
<span class=normal><a href=#__codelineno-99-2> 2</a></span>
<span class=normal><a href=#__codelineno-99-3> 3</a></span>
<span class=normal><a href=#__codelineno-99-4> 4</a></span>
<span class=normal><a href=#__codelineno-99-5> 5</a></span>
<span class=normal><a href=#__codelineno-99-6> 6</a></span>
<span class=normal><a href=#__codelineno-99-7> 7</a></span>
<span class=normal><a href=#__codelineno-99-8> 8</a></span>
<span class=normal><a href=#__codelineno-99-9> 9</a></span>
<span class=normal><a href=#__codelineno-99-10>10</a></span>
<span class=normal><a href=#__codelineno-99-11>11</a></span>
<span class=normal><a href=#__codelineno-99-12>12</a></span>
<span class=normal><a href=#__codelineno-99-13>13</a></span>
<span class=normal><a href=#__codelineno-99-14>14</a></span>
<span class=normal><a href=#__codelineno-99-15>15</a></span>
<span class=normal><a href=#__codelineno-99-16>16</a></span>
<span class=normal><a href=#__codelineno-99-17>17</a></span>
<span class=normal><a href=#__codelineno-99-18>18</a></span>
<span class=normal><a href=#__codelineno-99-19>19</a></span>
<span class=normal><a href=#__codelineno-99-20>20</a></span>
<span class=normal><a href=#__codelineno-99-21>21</a></span>
<span class=normal><a href=#__codelineno-99-22>22</a></span>
<span class=normal><a href=#__codelineno-99-23>23</a></span>
<span class=normal><a href=#__codelineno-99-24>24</a></span>
<span class=normal><a href=#__codelineno-99-25>25</a></span>
<span class=normal><a href=#__codelineno-99-26>26</a></span>
<span class=normal><a href=#__codelineno-99-27>27</a></span>
<span class=normal><a href=#__codelineno-99-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1></a><span class=kt>void</span><span class=w> </span><span class=nf>exit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>status</span><span class=p>)</span>
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2></a><span class=p>{</span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3></a><span class=w>    </span><span class=c1>// Close all open files.</span>
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NOFILE</span><span class=p>;</span><span class=w> </span><span class=n>fd</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-99-7><a id=__codelineno-99-7 name=__codelineno-99-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-99-8><a id=__codelineno-99-8 name=__codelineno-99-8></a>
</span><span id=__span-99-9><a id=__codelineno-99-9 name=__codelineno-99-9></a><span class=w>    </span><span class=c1>// 将进程的已映射区域取消映射</span>
</span><span id=__span-99-10><a id=__codelineno-99-10 name=__codelineno-99-10></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NVMA</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-99-11><a id=__codelineno-99-11 name=__codelineno-99-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-99-12><a id=__codelineno-99-12 name=__codelineno-99-12></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-99-13><a id=__codelineno-99-13 name=__codelineno-99-13></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-99-14><a id=__codelineno-99-14 name=__codelineno-99-14></a><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flags</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_SHARED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>prot</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>PROT_WRITE</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-99-15><a id=__codelineno-99-15 name=__codelineno-99-15></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-99-16><a id=__codelineno-99-16 name=__codelineno-99-16></a><span class=w>                </span><span class=n>filewrite</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=p>);</span>
</span><span id=__span-99-17><a id=__codelineno-99-17 name=__codelineno-99-17></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-99-18><a id=__codelineno-99-18 name=__codelineno-99-18></a><span class=w>            </span><span class=n>fileclose</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>);</span>
</span><span id=__span-99-19><a id=__codelineno-99-19 name=__codelineno-99-19></a><span class=w>            </span><span class=n>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>len</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>PGSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-99-20><a id=__codelineno-99-20 name=__codelineno-99-20></a><span class=w>            </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-99-21><a id=__codelineno-99-21 name=__codelineno-99-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-99-22><a id=__codelineno-99-22 name=__codelineno-99-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-99-23><a id=__codelineno-99-23 name=__codelineno-99-23></a>
</span><span id=__span-99-24><a id=__codelineno-99-24 name=__codelineno-99-24></a><span class=w>    </span><span class=n>begin_op</span><span class=p>();</span>
</span><span id=__span-99-25><a id=__codelineno-99-25 name=__codelineno-99-25></a><span class=w>    </span><span class=n>iput</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span><span class=p>);</span>
</span><span id=__span-99-26><a id=__codelineno-99-26 name=__codelineno-99-26></a><span class=w>    </span><span class=n>end_op</span><span class=p>();</span>
</span><span id=__span-99-27><a id=__codelineno-99-27 name=__codelineno-99-27></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-99-28><a id=__codelineno-99-28 name=__codelineno-99-28></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>(9) 根据提示9，修改fork，复制父进程的VMA并增加文件引用计数:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-100-1> 1</a></span>
<span class=normal><a href=#__codelineno-100-2> 2</a></span>
<span class=normal><a href=#__codelineno-100-3> 3</a></span>
<span class=normal><a href=#__codelineno-100-4> 4</a></span>
<span class=normal><a href=#__codelineno-100-5> 5</a></span>
<span class=normal><a href=#__codelineno-100-6> 6</a></span>
<span class=normal><a href=#__codelineno-100-7> 7</a></span>
<span class=normal><a href=#__codelineno-100-8> 8</a></span>
<span class=normal><a href=#__codelineno-100-9> 9</a></span>
<span class=normal><a href=#__codelineno-100-10>10</a></span>
<span class=normal><a href=#__codelineno-100-11>11</a></span>
<span class=normal><a href=#__codelineno-100-12>12</a></span>
<span class=normal><a href=#__codelineno-100-13>13</a></span>
<span class=normal><a href=#__codelineno-100-14>14</a></span>
<span class=normal><a href=#__codelineno-100-15>15</a></span>
<span class=normal><a href=#__codelineno-100-16>16</a></span>
<span class=normal><a href=#__codelineno-100-17>17</a></span>
<span class=normal><a href=#__codelineno-100-18>18</a></span>
<span class=normal><a href=#__codelineno-100-19>19</a></span>
<span class=normal><a href=#__codelineno-100-20>20</a></span>
<span class=normal><a href=#__codelineno-100-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1></a><span class=kt>int</span><span class=w> </span><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2></a><span class=p>{</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3></a><span class=w>    </span><span class=c1>// increment reference counts on open file descriptors.</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NOFILE</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7></a>
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8></a><span class=w>    </span><span class=c1>// 复制父进程的VMA</span>
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NVMA</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-100-10><a id=__codelineno-100-10 name=__codelineno-100-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-100-11><a id=__codelineno-100-11 name=__codelineno-100-11></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>used</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-100-12><a id=__codelineno-100-12 name=__codelineno-100-12></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-100-13><a id=__codelineno-100-13 name=__codelineno-100-13></a><span class=w>            </span><span class=n>memmove</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span>
</span><span id=__span-100-14><a id=__codelineno-100-14 name=__codelineno-100-14></a><span class=w>            </span><span class=n>filedup</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>vma</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>vfile</span><span class=p>);</span>
</span><span id=__span-100-15><a id=__codelineno-100-15 name=__codelineno-100-15></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-100-16><a id=__codelineno-100-16 name=__codelineno-100-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-100-17><a id=__codelineno-100-17 name=__codelineno-100-17></a>
</span><span id=__span-100-18><a id=__codelineno-100-18 name=__codelineno-100-18></a><span class=w>    </span><span class=n>safestrcpy</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span><span id=__span-100-19><a id=__codelineno-100-19 name=__codelineno-100-19></a>
</span><span id=__span-100-20><a id=__codelineno-100-20 name=__codelineno-100-20></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-100-21><a id=__codelineno-100-21 name=__codelineno-100-21></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> </ol></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2025年9月21日 21:08:06</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2025年6月19日 20:25:14</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; lingyu CC-BY-4.0 </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../assets/javascripts/bundle.88dd0f4e.min.js></script> <script src=../../mkdocs/javascripts/katex.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js></script> <script src=../../javascripts/config.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>